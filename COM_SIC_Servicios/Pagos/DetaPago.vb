Imports System.Globalization
Imports System.Configuration
Imports COM_SIC_Servicios.Funciones
Imports COM_SIC_Servicios.clsActivaciones
Imports COM_SIC_Servicios.WebComunes
Imports COM_SIC_Activaciones
Imports System.Net
Imports COM_SIC_INActChip
Imports System.IO
Imports System.Text
Imports COM_SIC_FacturaElectronica
Imports NEGOCIO_SIC_SANS
Imports System.Xml
Imports System.Web
Imports COM_SIC_Entidades.DataPowerRest.ProcesarPagosDelivery.RestConsultarDatosPago
Imports COM_SIC_Entidades.DataPowerRest.RestServices.ProcesarPagosDelivery.ActualizarEstadoPago
Imports COM_SIC_Entidades.DataPowerRest.RestServices.ConsultarDatosPago
Imports COM_SIC_Entidades.DataPowerRest.MethodsRest.ProcesarPagosDelivery.RestActualizarEstadoPago
Imports COM_SIC_Entidades
Imports COM_SIC_Cajas
Imports System.Reflection


Public Class DetaPago

#Region "Variables Globales"
    '############# INI VARIABLES GLOBALES ###############

    Dim objFileLog As New SrvPago_Log
    Dim nameFile As String = ConfigurationSettings.AppSettings("constNameLogRentaCac")
    Dim pathFile As String = ConfigurationSettings.AppSettings("constRutaLogRecarga")
    Dim strArchivo As String = objFileLog.Log_CrearNombreArchivo(nameFile)
    Private Shared oTipiConfiguration As New clsTipificationConfiguration

    Dim IdentificadorLog As String = String.Empty
    Dim ipServer As String = String.Empty
    Dim usuario_id As String = String.Empty
    Dim ipcliente As String = String.Empty
    Dim isRentaAdelantada As Boolean = False


    Dim CurrentTerminal As String = String.Empty
    Dim CurrentUser As String = String.Empty

    Dim AppQdocSunat As String = String.Empty 'Request.QueryString("docSunat")
    Dim AppQnumeroTelefono As String = String.Empty 'Request.QueryString("numeroTelefono")
    Dim AppQpDocSap As String = String.Empty 'Request.QueryString("pDocSap")

    Dim AppMontoCuota As String = String.Empty
    Dim strIdentifyLog As String = String.Empty

    Dim cuota As Integer
    Dim HidNroCuotas As String = String.Empty ' HidNroCuotas.Value 0
    Dim hidNumFilas As String = "1" 'hidNumFilas.Value por defecto 1
    Dim hidTotalSinInicial As String = "" 'hidTotalSinInicial.Value
    Dim hidDESLOG As String = String.Empty 'hidDESLOG.Value
    Dim hidCupon As String = String.Empty ' hidCupon.Value
    Dim hidCodigoCupon As String = String.Empty 'hidCodigoCupon.Value
    Dim hidValorCupon As String = String.Empty 'hidValorCupon.Value
    Dim hidNumeroTelefono As String = String.Empty 'hidNumeroTelefono.Value
    Dim hidDocSap As String = String.Empty 'hidDocSap.Value
    Dim hidMensajeNC As String = String.Empty 'hidMensajeNC.Value
    Dim hidFlagCargaDoc As String = 0 'hidFlagCargaDoc.Value
    Dim hidMontoCuota As String = String.Empty 'hidMontoCuota.Value
    Dim hidFlagVentaCuota As String = String.Empty


    Dim AppLOCAL_ADDR As String = String.Empty 'Request.ServerVariables("LOCAL_ADDR")
    Dim AppREMOTE_ADDR As String = String.Empty 'Request.ServerVariables("REMOTE_ADDR")
    Dim AppSERVER_NAME As String = String.Empty 'Request.ServerVariables("SERVER_NAME")
    Dim AppUserHostAddress As String = String.Empty 'HttpContext.Current.Request.UserHostAddress
    Dim AppLogon_User As String = String.Empty 'Request.ServerVariables("Logon_User")
    Dim AppUserHostName As String = String.Empty 'Request.UserHostName
    Dim AppHTTP_X_FORWARDED_FOR As String = String.Empty 'Request.ServerVariables("HTTP_X_FORWARDED_FOR")
    Dim AppREMOTE_HOST As String = String.Empty 'Request.ServerVariables("REMOTE_HOST")


    Dim AppErrorCaja As String = String.Empty
    Dim AppErrorPedido As String = String.Empty
    Dim AppErrorPagoParcial As String = String.Empty
    Dim AppErrorDeshacerCambios As String = String.Empty



    Dim txtNumSunat As String = String.Empty 'txtNumSunat.text
    Dim txtCorrelativo As String = String.Empty 'txtCorrelativo.text
    Dim txtCompleto As String = String.Empty 'txtCompleto.text

    Dim ApptxtMonto1 As String = String.Empty 'txtMonto1.text
    Dim ApptxtMonto2 As String = String.Empty 'txtMonto2.text
    Dim AppCboTipoDocumento As String = String.Empty 'CboTipoDocumento
    Dim ApptxtDoc1 As String = "" 'txtDoc

    Dim txtSaldo As String = String.Empty 'txtSaldo.text

    Dim txtMonto3 As String = String.Empty 'txtMonto3.text
    Dim txtMonto4 As String = String.Empty 'txtMonto4.text
    Dim txtMonto5 As String = String.Empty 'txtMonto5.text
    Dim txtNeto As String = String.Empty 'txtNeto.text
    Dim txtCuotaIni As String = String.Empty 'txtCuotaIni.text
    Dim txtRecibidoPen As String = String.Empty 'txtRecibidoPen.text
    Dim txtRecibidoUsd As String = "0" 'txtRecibidoUsd.text
    Dim txtVuelto As String = String.Empty 'txtVuelto.text
    Dim txtTipoCambio As String = "0" 'txtTipoCambio.text
    Dim txtNomCliente As String = String.Empty 'txtNomCliente.text

    Dim AppNOMBRE_COMPLETO As String = String.Empty 'Session("NOMBRE_COMPLETO")
    Dim AppcodPerfil As String = String.Empty 'Session("codPerfil")
    Dim AppUsuario As String = String.Empty 'Session("USUARIO")
    Dim AppCodUsuario As String = String.Empty 'Session("codUsuario")
    Dim AppAlmacen As String = String.Empty 'Session("ALMACEN")
    Dim AppCanal As String = String.Empty 'Session("CANAL")

    Dim AppFlagPoolPagos As String = String.Empty 'Session("FlagPoolPagos")
    Dim AppPagoDeducible As String = String.Empty 'Session("PagoDeducible")
    Dim AppstrUsuario As String = String.Empty 'Session("strUsuario")
    Dim AppNumeroDocumentoOLO As String = String.Empty 'Session("NumeroDocumentoOLO")
    Dim AppCodImprTicket As String = "1" 'Session("CodImprTicket")
    Dim AppTraceRecarga As String = String.Empty 'Session("traceRecarga")
    Dim AppNC As Boolean = False 'Session("NC") queda False



    Dim AppstrTipo_Prod_Des As String = String.Empty 'Session("strTipo_Prod_Des")
    Dim AppstrTipo_opera_Des As String = String.Empty 'Session("strTipo_opera_Des")
    Dim AppstrTipo_Opera_Cod As String = String.Empty 'Session("strTipo_Opera_Cod")
    Dim AppstrNro_Sec As String = String.Empty 'Session("strNro_Sec")
    Dim AppstrNro_Ped_Det As String = String.Empty 'Session("strNro_Ped_Det")
    Dim AppOFICINA As String = String.Empty 'Session("OFICINA")
    Dim AppIdSolicitudPorta As ArrayList = Nothing 'Session("IdSolicitudPorta")
    Dim AppFLAGCHIPREP As String = String.Empty 'Session("FLAGCHIPREP")
    Dim AppmensajeCHIPRepuesto As String = String.Empty 'Session("mensajeCHIPRepuesto")
    Dim AppMensajeErrorPagoCanjeAW As String = String.Empty 'Session("MensajeErrorPagoCanjeAW")
    Dim AppmensajeErrorLineas As String = String.Empty  'Session.Add("mensajeErrorLineas", mensaje)
    Dim ApppaqueteAdicional As Boolean = False 'Session("paqueteAdicional")
    Dim AppfechaTransaccionOriginal As String = String.Empty 'Session("fechaTransaccionOriginal")
    Dim AppstrMensajeCajaRec As String = String.Empty 'Session("strMensajeCajaRec")
    Dim AppstrMensajeWSCABB As String = String.Empty 'Session.Add("strMensajeWSCABB", strErrorMsj)
    Dim AppmsgErrorMigracionSaldoTFI As String = String.Empty ' Session.Add("msgErrorMigracionSaldoTFI", oDatosInteraccion.Mensaje_Respuesta())
    Dim AppmensajeErrorBonoPrepago As String = String.Empty 'Session.Add("mensajeErrorBonoPrepago", vMensaje)
    Dim AppmsgActivacionCAC As String = String.Empty 'Session.Add("msgActivacionCAC", strDescripcionError)
    Dim AppnumeroTelefonoPel As String = String.Empty 'Session("numeroTelefonoPel")
    Dim AppnumeroOperacionSAP As String = String.Empty 'Session("numeroOperacionSAP")
    Dim AppFechaPago As String = String.Format("{0:dd/MM/yyyy}", DateTime.Now) ' Session("FechaPago")
    Dim AppmensajeErrorDOL As String = String.Empty 'Session.Add("mensajeErrorDOL", Session("mensajeErrorDOL") & "\nError. No se pudo enviar por el archivo via FTP, no se grabo en la BD COBSDB.")
    Dim AppErrorRenovacionRPM6 As String = String.Empty 'Session.Add("ErrorRenovacionRPM6", MensajeFinal)
    Dim AppWS_OpcionesPagina As ArrayList = Nothing 'Session("WS_OpcionesPagina")
    Dim AppP_MSJ_RESULTADO As String = String.Empty 'Session("P_MSJ_RESULTADO")
    Dim AppmsgErrorInsertaMail As String = String.Empty 'Session("msgErrorInsertaMail")
    Dim AppPuntoVentaSinergia As String = String.Empty 'Session("PuntoVentaSinergia") Session("PuntoVentaSinergia")
    Dim AppPagoBSCSRenovacionCorporativa As String = "" 'Session.Add("PagoBSCSRenovacionCorporativa", MensajeFinal)
    Dim ApprecargaVirtual As Boolean = False 'Session("recargaVirtual") queda false
    Dim AppnumeroTelefono As String = String.Empty 'Session("numeroTelefono")
    Dim AppESTADO_RECARGA_V As DataSet = Nothing 'Session("ESTADO_RECARGA_V")
    Dim ApparrNombArchivos() As String = Nothing 'Session("arrNombArchivos") 
    Dim AppDocSel As DataRow = Nothing 'Session("DocSel")
    Dim AppCarga As String = "0" 'Session("Carga")
    Dim AppVias_Pago As DataSet = Nothing 'Session("Vias_Pago")
    Dim AppVentaR As String = String.Empty 'Session("VentaR")
    Dim AppmsgErrorDevolverRV As String = String.Empty 'Session.Add("msgErrorDevolverRV", msjDevolverRV)



    'MENSAJES QUE TRUNCAN EL PAGO
    Dim AppmsgErrorGenerarSot As String = String.Empty 'Session.Add("msgErrorGenerarSot")
    Dim AppstrMensajeCaja As String = String.Empty 'Session("strMensajeCaja")
    Dim AppmsgDevolucion As String = String.Empty 'Session("msgDevolucion")
    Dim AppFormasPAgo As DataTable = Nothing 'Session("FormasPAgo")
    Dim AppValida_Pago_MSG As String = String.Empty 'Session("Valida_Pago_MSG")




    Dim AppSPError As String = String.Empty



    Dim AppFlagBiometria As String = String.Empty
    Dim AppActivosPostpagoConvergente As String = String.Empty
    Dim AppPaperless As String = String.Empty
    Dim AppActualizarMSSAP As String = String.Empty
    Dim AppActualizarContrato As String = String.Empty
    Dim AppEnvioSAP As String = String.Empty
    Dim AppCodMedioPago As String = String.Empty
    Dim AppFlagTiendaVirtual As String = String.Empty
    Dim AppTipoOperacion As String = String.Empty

    Dim AppTipoVentaPago As String = String.Empty
    Dim AppTipoOperacionPago As String = String.Empty
    Dim AppFlagPortabilidadPago As Boolean = False

    Dim AppMensajeErrorGeneral As String = String.Empty
    Dim AppMensajeExitFunction As String = String.Empty
    Dim AppCodigoExitFunction As String = String.Empty
    Dim AppMensajeDeshacerCambios As String = String.Empty
    Dim AppCodigoDeshacerCambios As String = String.Empty

    Dim AppPedidoAlta As Int64 = 0
    Dim AppTipoDocVendedor As String = String.Empty
    Dim AppNumDocVendedor As String = String.Empty
    Dim AppUUID As String = String.Empty
    Dim AppNumeroReferencia As String = String.Empty
    Dim AppMontoPagar As String = String.Empty



    'PROY-31850 INI
    'VARIABLES GLOBALES
    Dim blnIsOLO As Boolean
    Dim strLineaOLO As String = String.Empty
    Dim strIdPedidoVentaPVU As String = String.Empty
    Dim strSerieChip As String = String.Empty
    Dim strSerieEquipo As String = String.Empty
    Dim strCodMaterialChip As String = String.Empty
    Dim strCodProductoOLO As String = String.Empty
    Dim strCodActivacionOLO As String = String.Empty
    Dim strMobileNumberWS_NumIntentos As String = String.Empty
    Dim strGenericWS_NumIntentos As String = String.Empty
    Dim strVentaWS_NumIntentos As String = String.Empty
    Dim strNumDocumento As String = String.Empty
    Dim strTipoDocumento As String = String.Empty
    Dim strLineaActivacion As String = String.Empty
    'PROY-31850 FIN

    'PROY-31850 FASE IV INI
    Dim blnRecargaOlo As Boolean = False
    Dim strLineaRecargaOLO As String = String.Empty
    Dim strCodMaterialOLO As String = String.Empty
    Dim strIdPlanOLO As String = String.Empty
    'PROY-31850 FASE IV FIN
    'INI :: PROY-31850 - MEJORA RECARGAS
    Dim blnLineaOLO As Boolean = False
    Dim strInicioNroOLO As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("constInicioNumeroOLO"))
    Dim intLongNroOLO = strInicioNroOLO.Length()
    'FIN :: PROY-31850 - MEJORA RECARGAS
    Dim dsFormaPago As DataSet
    'MODIFICADO EMANUEL BARBARAN EVERIS PERU
    Dim objConsultaMsSap As New COM_SIC_Activaciones.clsConsultaMsSap
    Dim objTrsMsSap As New COM_SIC_Activaciones.clsTrsMsSap

    '*************************************************************************************************'
    'VARIABLES FLUJO CAJA'
    Dim objCajas As COM_SIC_Cajas.clsCajas            '*** para el registro de datos flujo de caja ***'
    Dim PEDIN_PEDIDOSAP As String = ""

    Dim arrayListaRefSunat(7) As String                 '** Correlativo generado NC         **'
    Dim arrayListaReferencia(7) As String               '** Numero SAP de la NC             **'
    Dim arrayListaRefPedido(7) As String                '** Numero pedido de la NC          **'

    Dim resCajas As Integer = 0
    Dim resCajasCV As Integer = 0 'PROY BUYBACK'
    Dim P_CODERR As String = ""
    Dim P_MSGERR As String = ""
    Dim strNombreCaja As String = ""
    Dim P_ID_TI_VENTAS_FACT As String = ""
    Dim fechaCajas As String = ""
    Dim dsDatosPedido As DataSet
    Dim objOfflineCaja As New COM_SIC_OffLine.clsOffline
    Dim dsCajeroA As DataSet
    Dim dsCajeroB As DataSet
    '*************************************************************************************************'

    Dim drPagos As DataRow
    Dim blnError As Boolean
    Dim numeroTelefono As String = ""
    Dim numeroReferenciaSunat$ = ""
    Dim montoRecarga As String = String.Empty
    Dim numeroOperacion$
    Dim numeroOperacionST$
    Dim dblMontoCuotaInicial As Int64 = 0 'PROY-30166 -IDEA-38863  

    Dim desdeRVFrecuente As Boolean = False

    Dim dblValorIGVActual As Double 'PROY-31766'
    Dim SOPOC_ID_SOLICITUD As String   'PROY 32089
    Dim strLista_SOPOC_ID_SOLICITUD As New ArrayList 'PROY 32089

    'PROY-27440 INI
    Dim nameFilePos As String = ConfigurationSettings.AppSettings("constNameLogPOS")
    Dim pathFilePos As String = ConfigurationSettings.AppSettings("constRutaLogPOS")
    Dim strArchivoPos As String = objFileLog.Log_CrearNombreArchivo(nameFilePos)


    Dim strTVPrepago As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("strTVPrepago"))
    Dim strDescriOpePrePago As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("DESCTIPOOPERACION_PORTA_PRE"))

    Dim strTVPostpago As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("strTVPostpago"))
    Dim strDescriOpePostPago As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("DESCTIPOOPERACION_PORTA_POST"))

    Dim ReadKeySettings As New COM_SIC_Seguridad.ReadKeySettings 'PROY-31836 IDEA-43582_Mejora de Procesos Postventa del servicio Proteccion Movil
    'PROY-27440 FIN

    Dim flagDevolucion As Boolean = False
    Dim hidExtornoExitoso As Boolean = True


    Dim arrParametrosFormaPagoPerfil As ArrayList   'INICIATIVA-318
    Dim strIdentifyLogGeneral As String = String.Empty ' INICIATIVA-318
    Dim strCodPerfilFormaPago As String = String.Empty  ' INICIATIVA-318
    '############# FIN VARIABLES GLOBALES ###############

#End Region

    Public Function Pagar(ByVal strDocumentoSap As String, _
                            ByVal strNumeroDocumento As String, _
                            ByVal strMontoRecarga As String, _
                            ByVal strCodMedioPago As String, _
                            ByVal oEmpleados As BEDatosEmpleado, _
                            ByVal strIpLocal As String, _
                            ByVal TipoDocCliente As String, _
                            ByVal NroDocCliente As String, _
                            ByVal strTipoDocVendedor As String, _
                            ByVal strNumDocVendedor As String, _
                            ByVal strNumReferencia As String, _
                            ByVal strTipoOperacionServ As String, _
                            ByVal strMontoTotal As String, _
                            ByVal strFlagTiendaVirtual As String, _
                            ByVal strFlagBiometria As String, _
                            ByVal UUID As String, _
                            ByVal FechaPedido As String, _
                            ByVal strTipoVentaPago As String, _
                            ByVal strTipoOperacionPago As String, _
                            ByVal blFlagPortabilidad As Boolean, _
                            ByRef objBEResponseWebMethod As BEResponseWebMethod) As Boolean


        Dim rpta As Boolean = False
        Dim estado_pago As String = String.Empty
        objBEResponseWebMethod = New BEResponseWebMethod
        Dim sbTrazabilidad As StringBuilder = New StringBuilder
        Dim strTrazabilidad As String = String.Empty



        Try
            IdentificadorLog = String.Format("{0} || {1}", strDocumentoSap, UUID)

            strIdentifyLog = IdentificadorLog


            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "strDocumentoSap", Funciones.CheckStr(strDocumentoSap)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "strNumeroDocumento", Funciones.CheckStr(strNumeroDocumento)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "strMontoRecarga", Funciones.CheckStr(strMontoRecarga)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "strCodMedioPago", Funciones.CheckStr(strCodMedioPago)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "strIpLocal", Funciones.CheckStr(strIpLocal)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "TipoDocCliente", Funciones.CheckStr(TipoDocCliente)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "NroDocCliente", Funciones.CheckStr(NroDocCliente)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "strTipoDocVendedor", Funciones.CheckStr(strTipoDocVendedor)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "strNumReferencia", Funciones.CheckStr(strNumReferencia)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "strTipoOperacionServ", Funciones.CheckStr(strTipoOperacionServ)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "strMontoTotal", Funciones.CheckStr(strMontoTotal)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "strFlagTiendaVirtual", Funciones.CheckStr(strFlagTiendaVirtual)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "strFlagBiometria", Funciones.CheckStr(strFlagBiometria)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "UUID", Funciones.CheckStr(UUID)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "FechaPedido", Funciones.CheckStr(FechaPedido)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "strTipoVentaPago", Funciones.CheckStr(strTipoVentaPago)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "strTipoOperacionPago", Funciones.CheckStr(strTipoOperacionPago)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "blFlagPortabilidad", Funciones.CheckStr(blFlagPortabilidad)))



            If LoadSesiones(strDocumentoSap, _
                         strNumeroDocumento, _
                         FechaPedido, _
                         strCodMedioPago, _
                         TipoDocCliente, _
                         NroDocCliente, _
                         strTipoDocVendedor, _
                         strNumDocVendedor, _
                         strNumReferencia, _
                         strTipoOperacionServ, _
                         strMontoTotal, _
                         strCodMedioPago, _
                         strFlagTiendaVirtual, _
                         strFlagBiometria, _
                         UUID, _
                         strTipoVentaPago, _
                         strTipoOperacionPago, _
                         blFlagPortabilidad, _
                         oEmpleados) Then


                guardarConectado()

                Dim dsPedido As DataSet
                objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Consulta los datos del pedido=> " & Funciones.CheckStr(strDocumentoSap))
                dsPedido = objConsultaMsSap.ConsultaPedido(strDocumentoSap, "", "")
                objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Fin consulta pedido.")

                If Not dsPedido Is Nothing AndAlso dsPedido.Tables.Count > 0 AndAlso dsPedido.Tables(0).Rows.Count > 0 Then

                    objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Consulta los datos del pedido=> true")

                    estado_pago = dsPedido.Tables(0).Rows(0).Item("PEDIC_ESTADO")

                    If estado_pago = ConfigurationSettings.AppSettings("ESTADO_PAG") Then

                        objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Pedido en estado pagado correcto")

                        rpta = True
                        objBEResponseWebMethod.CodigoRespuesta = "0"
                        objBEResponseWebMethod.MensajeRespuesta = "Pago Realizado con éxito."

                        Try

                            Dim fechaRegistro As DateTime = DateTime.Now
                            Dim strCodRpta As String = String.Empty
                            Dim strMsjRpta As String = String.Empty

                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "objBEResponseWebMethod.CodigoRespuesta", Funciones.CheckStr(objBEResponseWebMethod.CodigoRespuesta)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "objBEResponseWebMethod.MensajeRespuesta", Funciones.CheckStr(objBEResponseWebMethod.MensajeRespuesta)))

                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Numero Pedido", Funciones.CheckStr(AppQpDocSap)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Punto de Venta", Funciones.CheckStr(AppAlmacen)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Identificador", Funciones.CheckStr(AppUUID)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Fecha Registro", Funciones.CheckStr(fechaRegistro)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Es Renta", "N"))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Pedido Alta", Funciones.CheckStr(AppPedidoAlta)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Monto Calculado", Funciones.CheckStr(AppMontoPagar)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Monto Pagado", Funciones.CheckStr(ApptxtMonto1)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "TipoDoc Vendedor", Funciones.CheckStr(AppTipoDocVendedor)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "NumDoc Vendedor", Funciones.CheckStr(AppNumDocVendedor)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Numero Referencia", Funciones.CheckStr(AppNumeroReferencia)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Cod Medio Pago", Funciones.CheckStr(AppCodMedioPago)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Tipo Operacion", Funciones.CheckStr(AppTipoOperacion)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Flag Biometria", Funciones.CheckStr(AppFlagBiometria)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Flag Actualizar MSSAP", Funciones.CheckStr(AppActualizarMSSAP)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Flag ActivosPostpagoConvergente", Funciones.CheckStr(AppActivosPostpagoConvergente)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Flag Actualizar Contrato", Funciones.CheckStr(AppActualizarContrato)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Flag Envio a SAP", Funciones.CheckStr(AppEnvioSAP)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Flag Envio a Paperless", Funciones.CheckStr(AppPaperless)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Flag Tienda Virtual", Funciones.CheckStr(AppFlagTiendaVirtual)))


                            Dim idNumeroPedido As Int64 = Funciones.CheckInt64(AppQpDocSap)
                            Dim dblMontoCalculado As Double = Funciones.CheckDbl(AppMontoPagar)
                            Dim dblMontoPagado As Double = Funciones.CheckDbl(ApptxtMonto1)


                            objTrsMsSap.RegistrarPagoSrvSicar(idNumeroPedido, _
                                                              AppAlmacen, _
                                                              AppUUID, _
                                                              AppstrUsuario, _
                                                              fechaRegistro, _
                                                              "N", _
                                                              AppPedidoAlta, _
                                                              dblMontoCalculado, _
                                                              dblMontoPagado, _
                                                              AppTipoDocVendedor, _
                                                              AppNumDocVendedor, _
                                                              AppNumeroReferencia, _
                                                              AppFlagBiometria, _
                                                              AppActualizarMSSAP, _
                                                              AppActivosPostpagoConvergente, _
                                                              AppActualizarContrato, _
                                                              AppEnvioSAP, _
                                                              AppPaperless, _
                                                              AppCodMedioPago, _
                                                              AppFlagTiendaVirtual, _
                                                              AppTipoOperacion, _
                                                              strCodRpta, _
                                                              strMsjRpta)


                            rpta = True
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Codigo Respuesta", Funciones.CheckStr(strCodRpta)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Mensaje Respuesta", Funciones.CheckStr(strMsjRpta)))

                            objBEResponseWebMethod.CodigoRespuesta = "0"
                            objBEResponseWebMethod.MensajeRespuesta = "Pago Realizado con éxito."

                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "objBEResponseWebMethod.CodigoRespuesta", Funciones.CheckStr(objBEResponseWebMethod.CodigoRespuesta)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "objBEResponseWebMethod.MensajeRespuesta", Funciones.CheckStr(objBEResponseWebMethod.MensajeRespuesta)))
                        Catch ex As Exception

                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "ERROR AL GRABAR EN SSAPT_PAGO_SRVSICAR", Funciones.CheckStr(ex.Message)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "ERROR AL GRABAR EN SSAPT_PAGO_SRVSICAR", Funciones.CheckStr(ex.StackTrace)))

                            sbTrazabilidad.AppendFormat("{0} || ", "Ocurrio un error al registrar en MSSAP(SSAPT_PAGO_SRVSICAR)")

                        End Try


                        If (AppMensajeErrorGeneral.Length > 0) Then

                            sbTrazabilidad.AppendFormat("{0} || ", AppMensajeErrorGeneral)
                            AppMensajeErrorGeneral = String.Empty

                        ElseIf (AppSPError.Length > 0) Then

                            sbTrazabilidad.Append(AppSPError)
                            AppSPError = String.Empty

                        ElseIf Not AppErrorPedido Is Nothing And AppErrorPedido <> "" Then

                            sbTrazabilidad.AppendFormat("{0} || ", AppErrorPedido)
                            AppErrorPedido = String.Empty

                        ElseIf Not hidMensajeNC Is Nothing And hidMensajeNC <> "" Then
                            sbTrazabilidad.AppendFormat("{0} || ", hidMensajeNC)
                            hidMensajeNC = String.Empty

                        ElseIf Not AppErrorCaja Is Nothing And AppErrorCaja <> "" Then
                            sbTrazabilidad.AppendFormat("{0} || ", AppErrorCaja)
                            AppErrorCaja = String.Empty

                        ElseIf Not AppErrorPagoParcial Is Nothing And AppErrorPagoParcial <> "" Then
                            sbTrazabilidad.AppendFormat("{0} || ", AppErrorPagoParcial)
                            AppErrorPagoParcial = String.Empty

                        ElseIf Not AppErrorRenovacionRPM6 Is Nothing And AppErrorRenovacionRPM6 <> "" Then
                            sbTrazabilidad.AppendFormat("{0} || ", AppErrorRenovacionRPM6)
                            AppErrorRenovacionRPM6 = String.Empty

                        ElseIf Not AppmsgActivacionCAC Is Nothing And AppmsgActivacionCAC <> "" Then
                            sbTrazabilidad.AppendFormat("{0} || ", AppmsgActivacionCAC)
                            AppmsgActivacionCAC = String.Empty

                        ElseIf Not AppmensajeErrorBonoPrepago Is Nothing And AppmensajeErrorBonoPrepago <> "" Then
                            sbTrazabilidad.AppendFormat("{0} || ", AppmensajeErrorBonoPrepago)
                            AppmensajeErrorBonoPrepago = String.Empty

                        ElseIf Not AppPagoBSCSRenovacionCorporativa Is Nothing And AppPagoBSCSRenovacionCorporativa <> "" Then
                            sbTrazabilidad.AppendFormat("{0} || ", AppPagoBSCSRenovacionCorporativa)
                            AppPagoBSCSRenovacionCorporativa = String.Empty

                        ElseIf Not AppmensajeErrorLineas Is Nothing And AppmensajeErrorLineas <> "" Then
                            sbTrazabilidad.AppendFormat("{0} || ", AppmensajeErrorLineas)
                            AppmensajeErrorLineas = String.Empty

                        ElseIf Not AppstrMensajeWSCABB Is Nothing And AppstrMensajeWSCABB <> "" Then
                            sbTrazabilidad.AppendFormat("{0} || ", AppstrMensajeWSCABB)
                            AppstrMensajeWSCABB = String.Empty

                        ElseIf Not AppmsgErrorGenerarSot Is Nothing And AppmsgErrorGenerarSot <> "" And (AppmsgErrorDevolverRV Is Nothing Or AppmsgErrorDevolverRV = "") Then
                            sbTrazabilidad.AppendFormat("{0} || ", AppmsgErrorGenerarSot)
                            AppmsgErrorGenerarSot = String.Empty


                        ElseIf Not AppmsgErrorDevolverRV Is Nothing And AppmsgErrorDevolverRV <> "" Then
                            sbTrazabilidad.AppendFormat("{0} || ", AppmsgErrorDevolverRV)
                            AppmsgErrorDevolverRV = String.Empty

                        ElseIf Not AppmsgDevolucion Is Nothing And AppmsgDevolucion <> "" Then
                            sbTrazabilidad.AppendFormat("{0} || ", AppmsgDevolucion)
                            AppmsgDevolucion = String.Empty

                        ElseIf Not AppmensajeErrorDOL Is Nothing And AppmensajeErrorDOL <> "" Then
                            sbTrazabilidad.AppendFormat("{0} || ", AppmensajeErrorDOL)
                            AppmensajeErrorDOL = String.Empty

                        ElseIf Len(Trim(AppmensajeCHIPRepuesto)) > 0 Then
                            sbTrazabilidad.AppendFormat("{0} || ", AppmensajeCHIPRepuesto)
                            AppmensajeCHIPRepuesto = String.Empty

                        ElseIf Len(Trim(AppstrMensajeCaja)) > 0 Then
                            sbTrazabilidad.AppendFormat("{0} || ", AppstrMensajeCaja)
                            AppstrMensajeCaja = String.Empty

                        ElseIf Len(Trim(AppstrMensajeCajaRec)) > 0 Then
                            sbTrazabilidad.AppendFormat("{0} || ", AppstrMensajeCajaRec)
                            AppstrMensajeCajaRec = String.Empty

                        ElseIf Len(Trim(AppP_MSJ_RESULTADO)) > 0 Then
                            sbTrazabilidad.AppendFormat("{0} || ", AppP_MSJ_RESULTADO)
                            AppP_MSJ_RESULTADO = String.Empty

                        ElseIf Not AppmsgErrorInsertaMail Is Nothing And AppmsgErrorInsertaMail <> "" Then
                            sbTrazabilidad.AppendFormat("{0} || ", AppmsgErrorInsertaMail)
                            AppmsgErrorInsertaMail = String.Empty

                        ElseIf Not AppmensajeErrorLineas Is Nothing And AppmensajeErrorLineas <> "" Then
                            sbTrazabilidad.AppendFormat("{0} || ", AppmensajeErrorLineas)
                            AppmensajeErrorLineas = String.Empty

                        ElseIf Not AppMensajeErrorPagoCanjeAW Is Nothing And AppMensajeErrorPagoCanjeAW <> "" Then
                            sbTrazabilidad.Append(AppMensajeErrorPagoCanjeAW)
                            AppMensajeErrorPagoCanjeAW = String.Empty
                        End If

                        strTrazabilidad = Funciones.CheckStr(sbTrazabilidad)

                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "strTrazabilidad", Funciones.CheckStr(strTrazabilidad)))

                        objBEResponseWebMethod.MensajeErrror = strTrazabilidad

                    Else
                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Pedid no se encuentra pagado"))

                        If AppCodigoExitFunction = "-2" Then

                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Hay error que truncaron el pago"))
                            objBEResponseWebMethod.CodigoRespuesta = "-1"
                            objBEResponseWebMethod.MensajeRespuesta = "Ocurrio un error al realizar el pago de la Boleta/Factura"

                            AppCodigoExitFunction = String.Empty
                            AppMensajeExitFunction = String.Empty

                        Else
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "No hay errores que truncaron el pago, ocurrio un error parcial"))
                            objBEResponseWebMethod.CodigoRespuesta = "-1"
                            objBEResponseWebMethod.MensajeRespuesta = "Ocurrio un error al realizar el pago de la Boleta/Factura"
                        End If
                    End If

                Else
                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Consultar los datos del pedido despues del proceso de pago, no retorno datos"))

                    objBEResponseWebMethod.CodigoRespuesta = "-1"
                    objBEResponseWebMethod.MensajeRespuesta = "Ocurrio un error al realizar el pago de la Boleta/Factura"
                End If

            Else

                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Ocurrio un error en el metodo LOAD SESSIONES"))
                objBEResponseWebMethod.CodigoRespuesta = "-1"
                objBEResponseWebMethod.MensajeRespuesta = "Ocurrio un error en el Load del metodo pagar"

            End If

        Catch ex As Exception


            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "ERROR AL REALIZAR PAGO", Funciones.CheckStr(ex.Message)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "ERROR AL REALIZAR PAGO", Funciones.CheckStr(ex.StackTrace)))

            objBEResponseWebMethod.CodigoRespuesta = "-1"
            objBEResponseWebMethod.MensajeRespuesta = "Ocurrio un error al realizar el pago de la Boleta/Factura"
        End Try


        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Respuesta final", Funciones.CheckStr(rpta)))
        Return rpta
    End Function
    Private Function ConsultaPuntoVenta(ByVal P_OVENC_CODIGO As String) As String
        Try
            Dim obj As New COM_SIC_Activaciones.clsConsultaMsSap
            Dim dsReturn As DataSet
            Dim PtodeVenta As String
            dsReturn = obj.ConsultaPuntoVenta(P_OVENC_CODIGO)
            If dsReturn.Tables(0).Rows.Count > 0 Then
                Return dsReturn.Tables(0).Rows(0).Item("OVENV_CODIGO_SINERGIA")
                'PtodeVenta = dsReturn.Tables(0).Rows(0).Item("OVENV_CODIGO_SINERGIA")
            End If
            Return Nothing
        Catch ex As Exception
        End Try
    End Function


#Region "GuardarConectado"

    Private Function LoadSesiones(ByVal strPedido As String, _
                                ByVal strNumeroDocumento As String, _
                                ByVal FechaPedido As String, _
                                ByVal strCodigoPago As String, _
                                ByVal TipoDocCliente As String, _
                                ByVal NroDocCliente As String, _
                                ByVal strTipoDocVendedor As String, _
                                ByVal strNumDocVendedor As String, _
                                ByVal strNumReferencia As String, _
                                ByVal strTipoOperacionServ As String, _
                                ByVal strMontoTotal As String, _
                                ByVal strCodMedioPago As String, _
                                ByVal strFlagTiendaVirtual As String, _
                                ByVal strFlagBiometria As String, _
                                ByVal UUID As String, _
                                ByVal strTipoVentaPago As String, _
                                ByVal strTipoOperacionPago As String, _
                                ByVal blFlagPortabilidad As Boolean, _
                                ByVal oEmpleados As BEDatosEmpleado) As Boolean

        Dim rpta As Boolean = False
        Try

            AppNOMBRE_COMPLETO = oEmpleados.NOMBRE_COMPLETO  'Session("NOMBRE_COMPLETO")
            AppcodPerfil = oEmpleados.PERFIL 'Session("codPerfil")
            AppUsuario = oEmpleados.CODUSUARIO  'Session("USUARIO")
            AppCodUsuario = oEmpleados.CODUSUARIO 'Session("codUsuario")
            CurrentUser = oEmpleados.CURRENT_USER
            AppAlmacen = oEmpleados.ALMACEN 'Session("ALMACEN")
            AppCanal = oEmpleados.CANAL  'Session("CANAL")


            CurrentTerminal = HttpContext.Current.Request.UserHostAddress
            AppUserHostAddress = CurrentTerminal
            AppLOCAL_ADDR = CurrentTerminal
            AppREMOTE_ADDR = CurrentTerminal
            AppUserHostName = CurrentTerminal
            AppREMOTE_HOST = CurrentTerminal
            AppLogon_User = CurrentUser


            AppQpDocSap = strPedido
            AppQnumeroTelefono = strNumeroDocumento
            numeroOperacion = strPedido
            hidDocSap = numeroOperacion

            AppCboTipoDocumento = strCodigoPago
            AppstrUsuario = oEmpleados.CURRENT_USER


            AppUUID = UUID
            AppTipoDocVendedor = strTipoDocVendedor
            AppNumDocVendedor = strNumDocVendedor
            AppNumeroReferencia = strNumReferencia
            AppMontoPagar = strMontoTotal
            AppFlagBiometria = strFlagBiometria
            AppCodMedioPago = strCodMedioPago
            AppTipoOperacion = strTipoOperacionServ
            AppFlagTiendaVirtual = strFlagTiendaVirtual
            AppTipoVentaPago = strTipoVentaPago
            AppTipoOperacionPago = strTipoOperacionPago
            AppFlagPortabilidadPago = blFlagPortabilidad


            AppFlagPoolPagos = "1"
            AppNC = False


            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppNOMBRE_COMPLETO", Funciones.CheckStr(AppNOMBRE_COMPLETO)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppcodPerfil", Funciones.CheckStr(AppcodPerfil)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppUsuario", Funciones.CheckStr(AppUsuario)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppCodUsuario", Funciones.CheckStr(AppCodUsuario)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "CurrentUser", Funciones.CheckStr(CurrentUser)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppAlmacen", Funciones.CheckStr(AppAlmacen)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppCanal", Funciones.CheckStr(AppCanal)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "CurrentTerminal", Funciones.CheckStr(CurrentTerminal)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppUserHostAddress", Funciones.CheckStr(AppUserHostAddress)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppLOCAL_ADDR", Funciones.CheckStr(AppLOCAL_ADDR)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppREMOTE_ADDR", Funciones.CheckStr(AppREMOTE_ADDR)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppUserHostName", Funciones.CheckStr(AppUserHostName)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppREMOTE_HOST", Funciones.CheckStr(AppREMOTE_HOST)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppLogon_User", Funciones.CheckStr(AppLogon_User)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppQpDocSap", Funciones.CheckStr(AppQpDocSap)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppQnumeroTelefono", Funciones.CheckStr(AppQnumeroTelefono)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "numeroOperacion", Funciones.CheckStr(numeroOperacion)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "hidDocSap", Funciones.CheckStr(hidDocSap)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppCboTipoDocumento", Funciones.CheckStr(AppCboTipoDocumento)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppstrUsuario", Funciones.CheckStr(AppstrUsuario)))

            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppUUID", Funciones.CheckStr(AppUUID)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppTipoDocVendedor", Funciones.CheckStr(AppTipoDocVendedor)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppNumDocVendedor", Funciones.CheckStr(AppNumDocVendedor)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppNumeroReferencia", Funciones.CheckStr(AppNumeroReferencia)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppMontoPagar", Funciones.CheckStr(AppMontoPagar)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppFlagBiometria", Funciones.CheckStr(AppFlagBiometria)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppCodMedioPago", Funciones.CheckStr(AppCodMedioPago)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppTipoOperacion", Funciones.CheckStr(AppTipoOperacion)))

            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppFlagTiendaVirtual", Funciones.CheckStr(AppFlagTiendaVirtual)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppTipoVentaPago", Funciones.CheckStr(AppTipoVentaPago)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppTipoOperacionPago", Funciones.CheckStr(AppTipoOperacionPago)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppFlagPortabilidadPago", Funciones.CheckStr(AppFlagPortabilidadPago)))

            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppFlagPoolPagos", Funciones.CheckStr(AppFlagPoolPagos)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppNC", Funciones.CheckStr(AppNC)))


            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "TipoDocCliente", Funciones.CheckStr(TipoDocCliente)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "NroDocCliente", Funciones.CheckStr(NroDocCliente)))



            Dim ipServer As String = String.Empty
            Dim hostInfo As String = String.Empty
            Dim usuario_id As String = String.Empty
            Dim ipcliente As String = String.Empty

            Dim objOffline As New COM_SIC_OffLine.clsOffline
            Dim dsPedido As DataSet
            Dim dtsap As New DataTable
            Dim objclsConsultaMsSap As New COM_SIC_Activaciones.clsConsultaMsSap
            FechaPedido = Left(FechaPedido, 10)

            Dim CodOficina As String
            CodOficina = ConsultaPuntoVenta(oEmpleados.ALMACEN)

            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "CodOficina", Funciones.CheckStr(CodOficina)))

            dtsap = objclsConsultaMsSap.ConsultaPoolPagos(ConfigurationSettings.AppSettings("PEDIC_ESTADO"), DateTime.ParseExact(FechaPedido, "dd/MM/yyyy", CultureInfo.InvariantCulture), CodOficina, "", TipoDocCliente, NroDocCliente)

            Dim colPorta As New Data.DataColumn("PEDIC_PORTA", GetType(System.String))
            colPorta.DefaultValue = "N"
            dtsap.Columns.Add(colPorta)


            dtsap.Columns.Add("Estado_SAP", GetType(String))
            dtsap.Columns.Add("ID_T_TRS_PEDIDO", GetType(String))
            dtsap.Columns.Add("PEDMC_TIPO_ENTREGA", GetType(String))

            Dim e As Integer
            Dim PEDIC_TIPOOFICINA As String = ""
            Dim PEDIC_ISRENTA As String = ""
            Dim DRA_ASOCIADO As String = ""

            Dim TIPO_ENTREGA As String = ""
            Dim DESCCLASEFACTURA As String = ""


            Dim flag_multi As String = ""

            Dim tipoVenta As String = ""
            Dim desTipoOpe As String = ""
            Dim dvPagos As New DataView(dtsap)

            If dtsap.Rows.Count > 0 Then
                For e = 0 To dtsap.Rows.Count - 1
                    dtsap.Rows.Item(e)("Estado_SAP") = "PROCESADO"

                    PEDIC_ISRENTA = dtsap.Rows.Item(e)("PEDIC_ISRENTA")

                    If PEDIC_ISRENTA = "S" Then
                        dtsap.Rows.Item(e)("PAGOC_CODSUNAT") = ""
                    End If

                    tipoVenta = Funciones.CheckStr(dtsap.Rows.Item(e)("PEDIC_TIPOVENTA"))
                    desTipoOpe = Funciones.CheckStr(dtsap.Rows.Item(e)("PEDIV_DESCTIPOOPERACION"))
                    If (desTipoOpe = strDescriOpePrePago AndAlso tipoVenta = strTVPrepago) OrElse (desTipoOpe = strDescriOpePostPago AndAlso tipoVenta = strTVPostpago) Then
                        dtsap.Rows.Item(e)("PEDIC_PORTA") = "P"
                    End If

                    TIPO_ENTREGA = Convert.ToString(dtsap.Rows.Item(e)("TIPO_ENTREGA"))

                    If TIPO_ENTREGA = "0" Then
                        dtsap.Rows.Item(e)("TIPO_ENTREGA") = "Presencial"
                    ElseIf TIPO_ENTREGA = "1" Then
                        dtsap.Rows.Item(e)("TIPO_ENTREGA") = "Delivery"
                    Else
                        dtsap.Rows.Item(e)("TIPO_ENTREGA") = ""
                    End If



                    DESCCLASEFACTURA = dtsap.Rows.Item(e)("PEDIV_DESCCLASEFACTURA")

                    If (DESCCLASEFACTURA = "NOTA DE CREDITO") Then
                        dtsap.Rows.Item(e)("TIPO_ENTREGA") = ""
                    End If
                    If (DESCCLASEFACTURA = "NOTA DE CANJE") Then
                        dtsap.Rows.Item(e)("TIPO_ENTREGA") = ""
                    End If

                Next
            End If

            If Len(Trim(strPedido)) > 0 Then
                Dim filter As String = String.Empty
                filter = "PEDIN_NROPEDIDO=" & strPedido
                dvPagos.RowFilter = filter
                drPagos = dvPagos.Item(0).Row
            End If

            AppOFICINA = oEmpleados.OFICINA ' AppOFICINA

            AppQnumeroTelefono = Funciones.CheckStr(drPagos.Item(31))
            hidNumeroTelefono = AppQnumeroTelefono

            AppnumeroTelefono = Funciones.CheckStr(drPagos.Item(31))

            AppQdocSunat = Funciones.CheckStr(drPagos.Item(10))

           

            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppOFICINA", Funciones.CheckStr(AppOFICINA)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppQnumeroTelefono", Funciones.CheckStr(AppQnumeroTelefono)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "hidNumeroTelefono", Funciones.CheckStr(hidNumeroTelefono)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppnumeroTelefono", Funciones.CheckStr(AppnumeroTelefono)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppQdocSunat", Funciones.CheckStr(AppQdocSunat)))


            objFileLog.Log_WriteLog(pathFile, strArchivo, "Inicio Obtener cuota inicial")

            'JCC INI'
            Dim dsCuotasxPedido As DataSet
            dsCuotasxPedido = Nothing
            Dim objClsTrsPvu As New COM_SIC_Activaciones.clsTrsPvu
            Dim strContrato As String = String.Empty
            Dim strTelef As String = String.Empty
            Dim CadenaPedido As String
            Dim strCodRptaCuota As String
            Dim strMsjRptaCuota As String
            Dim TamCadPedido As Integer

            CadenaPedido = "'" + (Funciones.CheckStr(strPedido)) + "'"
            'TamCadPedido = CadenaPedido.Length
            'CadenaPedido = CadenaPedido.Substring(0, CadenaPedido - 1)

            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "IN Pedidos:", CadenaPedido))
            dsCuotasxPedido = objClsTrsPvu.ObtenerMontoInicialxPedidos(CadenaPedido, strContrato, strTelef, strCodRptaCuota, strMsjRptaCuota)
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "OUT Cod Rpta:", strCodRptaCuota & "|" & strMsjRptaCuota))

            If Not dsCuotasxPedido Is Nothing AndAlso dsCuotasxPedido.Tables(0).Rows.Count > 0 Then
                AppMontoCuota = dsCuotasxPedido.Tables(0).Rows(0).Item("MONTO_CUOTA_INICIAL")
            End If

            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppMontoCuota", Funciones.CheckStr(AppMontoCuota)))
            'JCC FIN'
            If AppMontoCuota <> String.Empty Then
                If AppMontoCuota > 0 Then
                objFileLog.Log_WriteLog(pathFile, strArchivo, strPedido & "- " & "Var Monto Cuota Inicial : " & AppMontoCuota)
                dblMontoCuotaInicial = Funciones.CheckDbl(AppMontoCuota)
            Else
                dblMontoCuotaInicial = 0
            End If
            Else
                dblMontoCuotaInicial = 0
            End If
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "dblMontoCuotaInicial", Funciones.CheckStr(dblMontoCuotaInicial)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, "Fin Obtener cuota inicial")

            objFileLog.Log_WriteLog(pathFile, strArchivo, "Inicio ConsultaParametrosFormaPagoPerfil")
            ConsultaParametrosFormaPagoPerfil(strIdentifyLogGeneral) ' INICIATIVA-318
            objFileLog.Log_WriteLog(pathFile, strArchivo, "Inicio ConsultaParametrosFormaPagoPerfil")

            objFileLog.Log_WriteLog(pathFile, strArchivo, "Inicio de la pàgina formas de pago.")
            objFileLog.Log_WriteLog(pathFile, strArchivo, "Inicio Page_Load")

            'cboTipDocumento1.Attributes.Add("onChange", "f_CambiaArti()")

            objFileLog.Log_WriteLog(pathFile, strArchivo, "Inicio consulta BuyBack")
            '//PROY-BUYBACK INI
            Dim objConsultaMSSAP As New clsConsultaMsSap
            Dim strCodRespuesta As String = String.Empty
            Dim strMsjRespuesta As String = String.Empty
            Dim strDocSap As String = strPedido
            Dim montoCupon As Decimal = 0.0
            Dim row As DataRow
            Dim dsCupon As DataTable
            dsCupon = objConsultaMSSAP.ConsultaCupon(strDocSap, strCodRespuesta, strMsjRespuesta)
            If strCodRespuesta.Equals("0") Then
                If Not IsNothing(dsCupon) Then
                    row = dsCupon.Rows(dsCupon.Rows.Count - 1)
                    montoCupon = Funciones.CheckStr(row("CUPN_MONTO_CUPON"))
                    'txtMonto1.Text = (montoCupon.ToString("0.00", CultureInfo.InvariantCulture))
                    hidCupon = "1"
                    hidValorCupon = montoCupon
                    hidCodigoCupon = Funciones.CheckStr(row("CUPV_NROCUPON"))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strDocSap & "- " & "montoCupon: " & montoCupon)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strDocSap & "- " & "codigo cupon : " & hidCodigoCupon)
                End If
            End If
            objFileLog.Log_WriteLog(pathFile, strArchivo, "Fin consulta BuyBack")
            '//PROY-BUYBACK INI

            objFileLog.Log_WriteLog(pathFile, strArchivo, "Inicio CargarVaribalesOLO()")
            'PROY-31850 - INICIO
            CargarVaribalesOLO()
            'PROY-31850 - FIN
            objFileLog.Log_WriteLog(pathFile, strArchivo, "Fin CargarVaribalesOLO()")


            Try
                Dim RenoIFIGroup As String = ConfigurationSettings.AppSettings("RenoIFIGroup")
                oTipiConfiguration = LoadConfiguration(RenoIFIGroup)

            Catch ex As Exception
                objFileLog.Log_WriteLog(pathFile, strArchivo, "Error al cargar Configuración: " & ex.Message)
            End Try



            Dim PuntoVentaSinergia As String = String.Empty

            Try
                PuntoVentaSinergia = Funciones.CheckStr(objConsultaMSSAP.ConsultaPuntoVenta(AppAlmacen).Tables(0).Rows(0).Item("OVENV_CODIGO_SINERGIA"))
            Catch ex As Exception
                objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Error al consulta los Puntos de Venta para Sinergia")
                objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Error: " & PuntoVentaSinergia)
                objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & ex.Message.ToString)
                PuntoVentaSinergia = ""
            End Try

            If PuntoVentaSinergia = "" Then
                objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "PuntoVentaSinergia: " & PuntoVentaSinergia)
                objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "MEnsaje: No existe Codigo de Punto de Venta Nuevo.")
                'Response.Write("<script>alert('No existe Codigo de Punto de Venta.')</script>")
                Exit Function
            End If

            AppPuntoVentaSinergia = PuntoVentaSinergia

            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppPuntoVentaSinergia", Funciones.CheckStr(AppPuntoVentaSinergia)))

            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Inicio consulta las formas de Pago")
            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Método: Obtener_ConsultaViasPago(USRSICAR.PCK_SICAR_OFF_SAP.PROC_DATOS_VIAS_PAGO)")
            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Parámetros: ")
            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Param1: " & PuntoVentaSinergia)
            dsFormaPago = objOfflineCaja.Obtener_ConsultaViasPago(AppAlmacen)

            AppVias_Pago = dsFormaPago
            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Fin consulta las formas de Pago")
            '**************************************************************************************************************************************************************

            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Inicio asignaciòn de variables: ")
            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Nombre del Cliente: " & Funciones.CheckStr(drPagos.Item("PEDIV_NOMBRECLIENTE")))
            txtNomCliente = Funciones.CheckStr(drPagos.Item("PEDIV_NOMBRECLIENTE")) 'ES - 
            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Valor Neto: " & Funciones.CheckStr(Format(drPagos.Item("INPAN_TOTALDOCUMENTO"), "###0.00")))
            txtNeto = Format(drPagos.Item("INPAN_TOTALDOCUMENTO"), "###0.00")
            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Valor Cuota Inicial: " & Funciones.CheckStr(Format(dblMontoCuotaInicial, "###0.00")))
            txtCuotaIni = Format(dblMontoCuotaInicial, "###0.00")
            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Fin asignaciòn de variables: ")
            'INI PROY 30166 
            If Not IsNothing(AppFlagPoolPagos) Then
                objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "AppFlagPoolPagos no es nulo")
                If AppFlagPoolPagos = 1 Then
                    cuota = Funciones.CheckInt(drPagos.Item("DEPEN_NROCUOTA"))
                    HidNroCuotas = cuota
                End If
            Else
                objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "AppFlagPoolPagos es nulo")
                cuota = 0
                HidNroCuotas = cuota
            End If
            'FIN PROY 30166

            Try
                objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Inicia asignaciòn del saldo - pedido")
                If CDbl(drPagos.Item("PEDIN_PAGO")) <> 0 Then
                    objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Var INPAN_TOTALDOCUMENTO: " & Funciones.CheckStr(Format(drPagos.Item("INPAN_TOTALDOCUMENTO"), "###0.00")))
                    txtSaldo = Format(drPagos.Item("INPAN_TOTALDOCUMENTO"), "###0.00")
                Else
                    objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Var PEDIN_SALDO: " & Funciones.CheckStr(Format(drPagos.Item("PEDIN_SALDO"), "###0.00")))
                    txtSaldo = Format(drPagos.Item("PEDIN_SALDO"), "###0.00")
                End If
                objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Fin asignaciòn del saldo - pedido")
            Catch ex As Exception
                objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Error al tratar de asignar el saldo - pedido")
                objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & ex.Message.ToString)
            End Try


            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "txtSaldo", Funciones.CheckStr(txtSaldo)))

            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Inicia validaciòn si el pedido seleccionado es una NC")
            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "isNotaCredigo : " & Funciones.CheckStr(AppNC))
            Dim isNotaCredigo As Boolean = AppNC
            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Termina validaciòn si el pedido seleccionado es una NC")

            'PROY-31766 - INICIO
            Try
                dblValorIGVActual = ObtenerIGVActual()
            Catch ex As Exception
                objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "ERROR:" & ex.Message.ToString())
            End Try
            'PROY-31766 - INICIO

            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "dblValorIGVActual", Funciones.CheckStr(dblValorIGVActual)))

            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Inicia asignaciòn el importe total")
            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "INPAN_TOTALDOCUMENTO : " & Funciones.CheckStr(Format(drPagos.Item("INPAN_TOTALDOCUMENTO"), "###0.00")))

            'PROY BUYBACK - INICIO'

            If (hidCupon = "1") Then
                If Funciones.CheckDbl(drPagos.Item("INPAN_TOTALDOCUMENTO")) > Funciones.CheckDbl(hidValorCupon) Then
                    ApptxtMonto2 = Format(drPagos.Item("INPAN_TOTALDOCUMENTO") - hidValorCupon, "###0.00")
                    ApptxtMonto1 = Funciones.CheckStr(hidValorCupon)
                Else
                    ApptxtMonto1 = Format(drPagos.Item("INPAN_TOTALDOCUMENTO"), "###0.00")
                End If
            Else
                ApptxtMonto1 = Format(drPagos.Item("INPAN_TOTALDOCUMENTO"), "###0.00")
            End If

            'PROY BUYBACK - FIN'

            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "ApptxtMonto1", Funciones.CheckStr(ApptxtMonto1)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "ApptxtMonto2", Funciones.CheckStr(ApptxtMonto2)))

            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Fin asignaciòn el importe total")

            'Session("Carga") = 0
            'hidFlagCargaDoc.Value = "0"

            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Asigna(PEDIN_NRODOCUMENTO): " & Funciones.CheckStr(strPedido))
            Dim PEDIN_NRODOCUMENTO As Int64 = Funciones.CheckInt64(strPedido)


            'INICIO - IDEA-141711 - Pack Internet Móvil Prepago
            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Inicio ConsultaPaqueteAdicional")
            ApppaqueteAdicional = False
            dsPedido = objConsultaMSSAP.ConsultaPaqueteAdicional(PEDIN_NRODOCUMENTO, "", "")
            If Not dsPedido Is Nothing Then
                If dsPedido.Tables(0).Rows.Count > 0 Then
                    ApprecargaVirtual = True
                    ApppaqueteAdicional = True
                End If
            End If
            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Fin ConsultaPaqueteAdicional")
            'FIN - IDEA-141711 - Pack Internet Móvil Prepago

            'Prepago cuotas 23/10/2006

            'CNH PORTABILIDAD
            Dim dsData As DataSet
            Dim odtPrePago As DataTable, odtPosPago As DataTable
            Dim odtLineasEvaluadas As DataTable
            Dim odtPrePagoPedido As DataTable
            Dim odtPrePagoDetPedido As DataTable
            Dim strNroSec As String = String.Empty
            Dim strLineaValidar As String = String.Empty
            Dim strMensajeAlert As String = String.Empty
            Dim strTipo As String = String.Empty


            Dim TIPO_VENTA As String = String.Empty
            Dim NRO_CUOTAS As String = String.Empty
            Dim NUMERO_CONTRATO As String = String.Empty
            Dim ARTICULO As String = String.Empty
            Dim TIPO_DOC_CLIENTE As String = String.Empty
            Dim strCodTipOpe As String = String.Empty
            Dim strDesTipOpe As String = String.Empty

            '***********************************************************************************'
            '**ESTA PUESTO EN DURO:
            NRO_CUOTAS = "00"
            TIPO_VENTA = "02"
            NUMERO_CONTRATO = ""
            ARTICULO = "SERECVILIM"
            TIPO_DOC_CLIENTE = "01"



            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Inicio Obtener monto a pagar")

            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Fin Obtener monto a pagar")

            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Inicio txtRecibidoPen")

            'PROY BUYBACK - INICIO'
            If (hidCupon = "1") Then
                txtRecibidoPen = Funciones.CheckDbl(ApptxtMonto2) + Funciones.CheckDbl(ApptxtMonto1)
            Else
                txtRecibidoPen = ApptxtMonto1
            End If

            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "txtRecibidoPen", Funciones.CheckStr(txtRecibidoPen)))

            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Fin txtRecibidoPen")
            'PROY BUYBACK - FIN'

            txtRecibidoUsd = "0.00"
            txtVuelto = "0.00"

            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Inicio txtTipoCambio")
            ''TODO: CAMBIADO POR JYMMY TORRES
            txtTipoCambio = objOffline.Obtener_TipoCambio(Format(Now.Day, "00") & "/" & Format(Now.Month, "00") & "/" & Format(Now.Year, "0000")).ToString("N3") 'aotane 05.08.2013
            ''CAMBIADO HASTA AQUI
            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "txtTipoCambio=> " & Funciones.CheckStr(txtTipoCambio))
            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Fin txtTipoCambio")

            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Inicio Validar cuota inicial")
            'PROY-30166 - IDEA  38934  INICIO
            If (cuota > 0 And dblMontoCuotaInicial >= 0) Then
                ApptxtMonto1 = txtCuotaIni
                hidTotalSinInicial = txtNeto
                txtNeto = Format(Double.Parse(txtNeto), "###0.00")
                txtRecibidoPen = txtCuotaIni
            End If
            'PROY-30166 - IDEA  38934  FIN	

            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "ApptxtMonto1", Funciones.CheckStr(ApptxtMonto1)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "hidTotalSinInicial", Funciones.CheckStr(hidTotalSinInicial)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "txtNeto", Funciones.CheckStr(txtNeto)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "txtRecibidoPen", Funciones.CheckStr(txtRecibidoPen)))

            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Fin Validar cuota inicial")

            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Inicio LeerReferenciaPuntosCC")
            ' Inicio PS - Automatización de canje y nota de crédito
            Call LeerReferenciaPuntosCC(drPagos.Item("PEDIN_NROPEDIDO"))
            ' Fin PS - Automatización de canje y nota de crédito
            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Inicio LeerReferenciaPuntosCC")

            Dim codUsuario As String = Convert.ToString(AppUsuario).PadLeft(10, CChar("0"))
            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "codUsuario=> " & Funciones.CheckStr(codUsuario))

            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Consulta los datos del pedido=> " & Funciones.CheckStr(strPedido))
            dsPedido = objConsultaMSSAP.ConsultaPedido(Funciones.CheckInt64(strPedido), "", "")
            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Fin consulta pedido.")

            AppNumeroDocumentoOLO = String.Empty
            AppCodImprTicket = String.Empty
            AppTraceRecarga = String.Empty
            AppNC = False
            AppmsgErrorDevolverRV = String.Empty

            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Inicio ValidarEstadoPendienteSP")

            Dim strTipo_opera_Des As String
            strTipo_opera_Des = dsPedido.Tables(0).Rows(0).Item("PEDIV_DESCTIPOOPERACION")
            AppstrTipo_opera_Des = Funciones.CheckStr(strTipo_opera_Des)

            'Dim AppstrTipo_Opera_Cod As String = "" 'Session("strTipo_Opera_Cod")
            Dim strTipo_Opera_Cod As String
            strTipo_Opera_Cod = dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION")
            AppstrTipo_Opera_Cod = Funciones.CheckStr(strTipo_Opera_Cod)

            'Dim AppstrNro_Sec As String = "" 'Session("strNro_Sec")
            Dim sNroSec As String = Obtener_NroSec_PostPago(Funciones.CheckStr(strPedido))
            AppstrNro_Sec = sNroSec
            'Dim AppstrNro_Ped_Det As String = "" 'Session("strNro_Ped_Det")
            Dim strNro_Ped_Det As String
            strNro_Ped_Det = dsPedido.Tables(1).Rows(0).Item("DEPEN_CONSECUTIVO")
            AppstrNro_Ped_Det = Funciones.CheckStr(strNro_Ped_Det)


            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppstrTipo_opera_Des", Funciones.CheckStr(AppstrTipo_opera_Des)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppstrTipo_Opera_Cod", Funciones.CheckStr(AppstrTipo_Opera_Cod)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "AppstrNro_Ped_Det", Funciones.CheckStr(AppstrNro_Ped_Det)))


            'Dim AppIdSolicitudPorta As ArrayList = Nothing 'Session("IdSolicitudPorta") 
            Dim obj As New ClsPortabilidad
            Dim objConsulta As New COM_SIC_Activaciones.ClsPortabilidad
            strDesTipOpe = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("PEDIV_DESCTIPOOPERACION"))
            Dim strCodTipVenta As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("PEDIC_TIPOVENTA"))
            Dim strCodRespPorta As String
            Dim strMensajPorta As String
            Dim strCodRpta As String
            Dim strMsgRpta As String
            Dim pstrCodRpta As String
            Dim pstrMsgRpta As String
            Dim ds_contenedor As DataSet
            Dim intPendienteSP As Integer

            If (strDescriOpePostPago = strDesTipOpe) AndAlso (strCodTipVenta = strTVPostpago) Then
                strNroSec = Me.Obtener_NroSec_PostPago(Funciones.CheckStr(strPedido))
                objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- [IdSolicitudPorta][POSTPAGO-SEC][strNroSec]=>" & strNroSec)
            ElseIf (strDescriOpePrePago = strDesTipOpe) AndAlso (strCodTipVenta = strTVPrepago) Then
                strNroSec = Me.Obtener_NroSec_PrePago(strPedido, strCodRespPorta, strMensajPorta, odtPrePagoPedido, odtPrePagoDetPedido)
                objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- [IdSolicitudPorta][PREPAGO-SEC][strNroSec]=>" & strNroSec)
            End If

            If strNroSec.Length > 0 Then ' SOLO ENTRA SI ES PORTA

                objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- [IdSolicitudPorta][NroPedidoAlta]=>" & strPedido)
                objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- [IdSolicitudPorta[strNroSec]=>" & strNroSec)

                Dim objDatos As DataSet = objConsulta.ValidarSEC(strNroSec, strCodRpta, strMsgRpta)
                ds_contenedor = obj.Obtener_tipo_producto(strNroSec, strPedido, pstrCodRpta, pstrMsgRpta)

                Dim blnExistePEP As Boolean
                Dim strLstIDSolicitud As New ArrayList
                Dim mensajeABDCP As String

                objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- [IdSolicitudPorta][ValidarEstadoPendienteSP]")
                intPendienteSP = New clsActivaciones().ValidarEstadoPendienteSP(objDatos, ds_contenedor, blnExistePEP, strLstIDSolicitud, mensajeABDCP)
                objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- [IdSolicitudPorta][ValidarEstadoPendienteSP][blnExistePEP]=>" & blnExistePEP.ToString())
                objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- [IdSolicitudPorta][ValidarEstadoPendienteSP][mensajeABDCP]=>" & Funciones.CheckStr(mensajeABDCP))
                objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- [IdSolicitudPorta][ValidarEstadoPendienteSP][intPendienteSP]=>" & Funciones.CheckStr(intPendienteSP.ToString()))

                If intPendienteSP Then
                    objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- [IdSolicitudPorta][ValidarEstadoPendienteSP][SOLICITUD DE PORTABIIDAD PENDIENTE]")
                End If

                AppIdSolicitudPorta = strLstIDSolicitud

            End If

            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Fin ValidarEstadoPendienteSP")


            AppWS_OpcionesPagina = New ArrayList
            AppDocSel = drPagos
            AppCarga = 0

            rpta = True

        Catch ex As Exception

            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "ERROR LOAD SESSIONES" & Funciones.CheckStr(ex.Message))
            objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "ERROR LOAD SESSIONES=> " & Funciones.CheckStr(ex.StackTrace))

        End Try

        Return rpta
    End Function

    Private Function Obtener_NroSec_PostPago(ByVal strNroPedido As String) As String
        Dim objConsultaPvu As New COM_SIC_Activaciones.clsConsultaPvu
        Dim strNroSec As String = ""

        strNroSec = objConsultaPvu.ObtenerSec(strNroPedido)


        objConsultaPvu = Nothing
        Return strNroSec

    End Function
    Private Function Obtener_NroSec_PrePago(ByVal strNroPedido As String, _
    ByRef CodResp As String, ByRef Mensaje As String, ByRef odtVentaRef As DataTable, ByRef odtVentaDetRef As DataTable) As String

        Dim strNroSec As String = ""

        Dim odtVenta As DataTable
        Dim odtVentaDet As DataTable



        Dim objClsConsultaPvu As New clsConsultaPvu
        objClsConsultaPvu.ConsultarPedidosPrepago(strNroPedido, CodResp, Mensaje, odtVenta, odtVentaDet)

        If (odtVenta.Rows.Count > 0 And odtVentaDet.Rows.Count > 0) Then
            strNroSec = Funciones.CheckStr(odtVenta.Rows(0)("VEPR_SEC_PORT"))
        End If

        objClsConsultaPvu = Nothing

        odtVentaDetRef = odtVenta
        odtVentaDetRef = odtVentaDet



        Return strNroSec

    End Function

    Private Function guardarConectado() As BEResponseWebMethod

        Try

            Dim ResponseWebMethod As BEResponseWebMethod = New BEResponseWebMethod

            Dim blnPagoRealizado As Boolean = False
            'Dim strTelefonoNumero = String.Empty
            'Dim strRegistroDOLRespuesta = String.Empty
            Dim int64IdVenta As Int64 = 0
            Dim strDocumentoIdentidadNumero As String = String.Empty

            Dim objClsConsultaPvu As New COM_SIC_Activaciones.clsConsultaPvu
            '==================================================================='
            ' PARAMETROS DE RETORNO DE GUARDAR PAGO
            Dim K_PAGOV_CORRELATIVO As String = ""
            Dim K_PAGOC_CORRELATIVO As String = ""

            Dim consultaDato As DataSet

            Dim K_NROLOG As String = ""
            Dim K_DESLOG As String = ""
            Dim K_NROLOG_DET As String = ""
            Dim K_DESLOG_DET As String = ""
            Dim K_PAGON_IDPAGO As Int64 = 0
            Dim K_CU_CORRELATIVOFE As String = ""

            Dim objContrato As DataSet          '*** guardar la informaciòn recuperada del contrato - dg ***'
            Dim P_COD_RESP As String = ""       '*** variables del contrato -dg ***'
            Dim P_MSG_RESP As String = ""       '*** variables del contrato -dg ***'

            'FIN DE PARAMETROS DE RETORNO DE GUARDAR PAGO 
            '==================================================================='


            ' PARAMETROS DE RETORNO DE CONSULTA PEDIDO PVU
            Dim P_CODIGO_RESPUESTA As String = ""
            Dim P_MENSAJE_RESPUESTA As String = ""
            Dim C_VENTA As DataTable
            Dim C_VENTA_DET As DataTable
            'FIN PARAMETROS DE RETORNO DE CONSULTA PEDIDO PVU

            Dim C_VENTA_Prepago As DataSet

            Dim Campania As String = ""
            Dim campania_Pre As String = ""
            Dim campania_Post As String = ""

            Dim Plan_final As String = ""
            Dim plan_pre As String = ""
            Dim plan_post As String = ""

            Dim tipo_venta_pvu As String = "NTRR"
            Dim cod_Prod_TFI As String = ""

            Dim flag_ped_repo As String = ""

            'Parametros cuando se graban los pagos prepagos
            Dim objPvu As New COM_SIC_Activaciones.clsTrsPvu
            Dim RptaPrepago As Integer


            Dim strNumAsignado As String
            Dim strNumSunat As String
            Dim i As Integer
            Dim j As Integer
            Dim strDetallePago As String
            Dim dsResult As DataSet
            Dim strNumAsignaSUNAT As String
            Dim strErrorMsg As String
            Dim blnSunat As Boolean
            Dim strNroDoc As String
            Dim strPrepago As String
            Dim strPostPago As String
            Dim intCeros As Integer
            Dim blnFlagPago As Boolean
            Dim strMensaje As String
            Dim strEstado As String
            Dim strCadenaCam As String
            Dim strContrato As String           '*** en el conectado ****'

            Dim PorMigracion As String
            Dim PorRenovacion As String
            Dim PorReposicion As String
            Dim PorAprobador As String
            Dim EstadoActualAcuerdo As String
            Dim strObsEstado As String

            'CARIAS
            'Conectado
            Dim strNroSEC, strNroDocSEC, strTipDocSEC, strNroAprobacion, strMotivoMig, strConSinEq As String
            'FIN CARIAS

            Dim strIND_ACTIV_BSCS As String
            Dim dsAcuerdo As DataSet
            Dim dsEstado As DataSet
            Dim dsDatGenerales As DataSet
            Dim conEquipo As Boolean

            Dim strValSAP As String
            Dim blnDebeSerRevisado As Boolean
            Dim strRespuesta As String

            Dim dblEfectivo As Double
            Dim dblEfecCaja As Double
            Dim dblTolerancia As Double
            Dim dsEfectivo As DataSet
            Dim dblMontoTarjeta As Double
            Dim dblTotalTarjeta As Double

            '140245 Inicio
            Dim strNro_cont_Det As Integer '140245
            Dim strNro_cont As Integer '140245
            Dim strCo_Id As Integer 'nuevo
            '140245 Fin

            Dim objActivaciones As New COM_SIC_Activaciones.clsActivacion
            Dim objConfig As New COM_SIC_Configura.clsConfigura
            Dim objClsPagosWS As New COM_SIC_Activaciones.clsPagosWS

            Dim objActiv As New COM_SIC_Activaciones.clsBDSiscajas
            Dim msgj As String = ""

            '****************************** Para Impresion
            'Dim strDocSap As String = "" 'drPagos.Item("VBELN")TODOEB
            Dim strDocSap As String = drPagos.Item("PEDIN_NROPEDIDO")


            Dim strDocSunat As String = ""
            Dim sTipoVenta, sTipoOperacion As String
            '<33062>
            Dim sDescripcionOperacion As String
            '</33062>

            'Dim strDocSunat As String = drPagos.Item("XBLNR")TODOEB
            ' Dim strDocSunat As String = drPagos.Item("PAGOC_CODSUNAT") '"AC111"

            Dim strNroDG As String = "" 'drPagos.Item("NRO_DEP_GARANTIA")TODOEB
            'Dim strTipDoc As String = drPagos.Item("FKART")TODOEB

            '****************************************************************************
            'VARIABLES: INFORMACIÒN DEL PEDIDO
            '****************************************************************************
            Dim strTipDoc As String = drPagos.Item("PEDIC_CLASEFACTURA")
            'Dim strDescTipDoc As String = drPagos.Item("PEDIV_DESCCLASEFACTURA")
            'Dim strCodVendedor As String = drPagos.Item("VENDEDOR")
            'Dim totalDocumento As Double = drPagos.Item("INPAN_TOTALDOCUMENTO")
            '****************************************************************************


            '****************************************************************************
            'VARIABLES: Desglosamiento del correlativo para 
            '****************************************************************************
            Dim Var_Corr1 As String = ""
            Dim Var_Corr2 As String = ""
            Dim Var_Corr3 As String = ""
            Dim Var_Corr4 As String = ""
            Dim Var_Corr5 As String = ""
            Dim Var_Corr6 As String = ""
            '****************************************************************************

            Dim P_tipo_doc_pago As String = "" 'Variable para grabar la descripcion del tipo de comprobante (BOLETA O FACTURA)

            Dim sisact_Cod_Operacion As String = "" ' variable que se utiliza para obtener el codigo de operacion sisact.

            Dim intOper As Int32
            '*******************************

            ' FLAG PILOTO
            Dim booDol As Boolean = True

            'Variables de Auditoria
            Dim wParam1 As Long
            Dim wParam2 As String
            Dim wParam3 As String
            Dim wParam4 As Long
            Dim wParam5 As Integer
            Dim wParam6 As String
            Dim wParam7 As Long
            Dim wParam8 As Long
            Dim wParam9 As Long
            Dim wParam10 As String
            Dim wParam11 As Integer
            Dim Detalle(,) As Object
            Dim objAudiBus As New COM_SIC_AudiBus.clsAuditoria
            Dim dtDatos As New DataTable
            Dim objBus As New COM_SIC_Cajas.clsCajas
            Dim isRecargaVirtual As Boolean = ApprecargaVirtual 'INC000001089654

            'NRO CONTRATO  TODOEB 

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Grabar pagos.")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")

            '************************************************************************************************************'
            'CONSULTA EL CONTRATO:
            Try
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Inicio Obtener contrato={1}]", strIdentifyLog, Not isRecargaVirtual)) 'INC000001089654  

                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - guardarConectado()", strIdentifyLog) & " - Session('recargaVirtual') : " & Funciones.CheckStr(ApprecargaVirtual))     'NUEVO  
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - guardarConectado()", strIdentifyLog) & " - PEDIN_NROPEDIDO : " & drPagos.Item("PEDIN_NROPEDIDO"))   'NUEVO  

                If Not ApprecargaVirtual Then
                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - SISACT_PKG_ACUERDO_6.SP_CON_ACUERDOS_X_DOCSAP", strIdentifyLog)) 'INC000001089654  
                    objContrato = objClsConsultaPvu.ObtenerDrsap(Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")), P_COD_RESP, P_MSG_RESP)   'EGSC001 ACA SE OBTIENE EL CONTRATO  NUEVO
                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} -  Contrato P_COD_RESP : {1}", strIdentifyLog, Funciones.CheckStr(P_COD_RESP))) 'INC000001089654  
                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} -  Contrato P_MSG_RESP : {1}", strIdentifyLog, Funciones.CheckStr(P_MSG_RESP))) 'INC000001089654  
                Else
                    objContrato = Nothing
                End If


                'inicio nuevo
                If Not (objContrato Is Nothing) Then
                    If (objContrato.Tables(0).Rows.Count > 0) Then
                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} -  Contrato  : {1}", strIdentifyLog, Funciones.CheckStr(objContrato.Tables(0).Rows(0).Item("ID_CONTRATO"))))
                    Else
                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} -  Contrato  : {1}", strIdentifyLog, "El metodo ObtenerDrsap no retorno resultado"))
                    End If
                Else
                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - guardarConectado() ", strIdentifyLog, "El objContrato es Nothing"))
                End If
                'fin nuevo


                '140245 Inicio
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Proy-140245 Capturar variables ")

                If objContrato.Tables(1).Rows.Count > 0 Then
                    strNro_cont = objContrato.Tables(1).Rows(0).Item("ID_CONTRATO")
                    'Session("strNro_cont") = strNro_cont

                    strNro_cont_Det = objContrato.Tables(1).Rows(0).Item("CORRELATIVO")
                    'Session("strNro_cont_Det") = strNro_cont_Det

                    'ASIGNACION DE LOG 
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Llenar a Nro_Contrato" & strNro_cont)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Llenar a  CO_ID" & strCo_Id)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Llenar a Nro_Contrato_Detalle" & strNro_cont_Det)
                End If
                '140245 Fin


                If Not (objContrato Is Nothing) Then
                    If objContrato.Tables(0).Rows(0).Item("ID_CONTRATO") <> Nothing Then
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Contrato Obtenido: " & Funciones.CheckStr(objContrato.Tables(0).Rows(0).Item("ID_CONTRATO")))
                    Else
                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - Contrato Obtenido con ID_CONTRATO nulo", strIdentifyLog)) 'INC000001089654  
                    End If
                Else
                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - No se obtuvo datos de contrato", strIdentifyLog)) 'INC000001089654
                End If


                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Contrato Obtenido: " & Funciones.CheckStr(objContrato.Tables(0).Rows(0).Item("ID_CONTRATO")))
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Contrato P_COD_RESP : " & Funciones.CheckStr(P_COD_RESP))
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Contrato P_MSG_RESP : " & Funciones.CheckStr(P_MSG_RESP))
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Obtener contrato.")
            Catch ex As Exception
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Error en obtener contrato :" & drPagos.Item("PEDIN_NROPEDIDO"))
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Err." & ex.Message.ToString)
            End Try
            '************************************************************************************************************'

            Dim dsPedido As DataSet

            '****** CONSULTA PRINCIPAL PARA EL PREOCESO *****'
            '***************************************************************************************************'
            '***************************************************************************************************'
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Consulta los datos del pedido=> " & Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")))
            dsPedido = objConsultaMssap.ConsultaPedido(drPagos.Item("PEDIN_NROPEDIDO"), "", "")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin consulta pedido.")
            '***************************************************************************************************'
            '***************************************************************************************************'
            '***************************************************************************************************'

            '****** VALIDANDO QUE LA CONSULTA PRINCIPAL TENGA DETALLE DE PEDIDO *****'
            '***************************************************************************************************'
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Validar si la consulta tiene detalle de pedido ")
            If Not dsPedido Is Nothing Then
                If dsPedido.Tables.Count > 1 Then
                    If dsPedido.Tables(1).Rows.Count = 0 Then
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " Pedido sin Detalle")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " dsPedido.Tables(1).Rows.Count :" & dsPedido.Tables(1).Rows.Count)
                        'Response.Write("<script>alert('" & ConfigurationSettings.AppSettings("MSG_Pedido_Sin_Detalle") & "')</script>")
                        AppErrorPedido = ConfigurationSettings.AppSettings("MSG_Pedido_Sin_Detalle")
                        Exit Function
                    End If
                Else
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " Pedido sin Retorno de Tablas")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " dsPedido.Tables.Count :" & dsPedido.Tables.Count)
                    'Response.Write("<script>alert('" & ConfigurationSettings.AppSettings("MSG_Pedido_Sin_Retorno_Datos") & "')</script>")
                    AppErrorPedido = ConfigurationSettings.AppSettings("MSG_Pedido_Sin_Retorno_Datos")
                    Exit Function
                End If
            Else
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " Pedido sin Retorno de Cursores")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " dsPedido Is Nothing ")
                ' Response.Write("<script>alert('" & ConfigurationSettings.AppSettings("MSG_Pedido_Sin_Retorno_Datos") & "')</script>")
                AppErrorPedido = ConfigurationSettings.AppSettings("MSG_Pedido_Sin_Retorno_Datos")
                Exit Function
            End If

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Validar si la consulta tiene detalle de pedido ")

            '********************************************************************************************'
            '** Estas variables no estan siendo utilizadas, lo comentamos
            sTipoVenta = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA"))
            sTipoOperacion = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION"))

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Consulta los datos del pedido sTipoVenta=> " & Funciones.CheckStr(sTipoVenta))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Consulta los datos del pedido sTipoOperacion=> " & Funciones.CheckStr(sTipoOperacion))


            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Asignar valores")
            'Proy 140245 Ini
            Dim dsprueba As DataSet
            Dim strTipo_opera_Des As String = AppstrTipo_opera_Des
            Dim strNro_Sec As Integer = Funciones.CheckInt(AppstrNro_Sec)
            Dim strNro_Ped_Det As Integer = Funciones.CheckInt(AppstrNro_Ped_Det)
            Dim strTipo_Opera_Cod As String = AppstrTipo_Opera_Cod
            sDescripcionOperacion = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIV_DESCTIPOOPERACION"))

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Consulta los datos del pedido strTipo_opera_Des => " & Funciones.CheckStr(strTipo_opera_Des))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Consulta los datos del pedido strNro_Sec=> " & Funciones.CheckStr(strNro_Sec))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Consulta los datos del pedido strNro_Ped_Det=> " & Funciones.CheckStr(strNro_Ped_Det))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Consulta los datos del pedido strTipo_Opera_Cod=> " & Funciones.CheckStr(strTipo_Opera_Cod))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Consulta los datos del pedido sDescripcionOperacion=> " & Funciones.CheckStr(sDescripcionOperacion))

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Asignar valores")

            Dim strNumero_linea As String
            Dim strPlan_Codigo As String
            Dim strPlan_Desc As String
            Dim strTipo_Prod_Cod As String
            Dim strTipo_Prod_Des As String
            Dim strCampanaCod As String
            Dim strCampanaDesc As String
            Dim strCamp_Estado As String
            Dim strFecha_crea As String
            Dim strFecha_Act As String 'CAMBIO
            Dim strTipo_Doc As String
            Dim strNro_Doc As String
            Dim strNro_Ped As String
            Dim PO_COD_RPTA As String = ""
            Dim PO_MSG_RPTA As String = ""
            'Proy 140245 Fin
            '<33062>

            '</33062>

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " Consulta el efectivo para la caja")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " Parametro de consulta :" & AppAlmacen)
            '** CONSULTA EFECTIVO:
            Dim Codaplic As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("CodAplicacion"))
            objCajas = New COM_SIC_Cajas.clsCajas
            Try
                dsEfectivo = objCajas.FP_Get_ListaParamOficina(AppCanal, Codaplic, AppAlmacen)
            Catch ex As Exception

            End Try

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " Fin consulta paràmetros oficina")

            'dblEfecCaja = objCajas.FP_CalculaEfectivo(Session("ALMACEN"), Session("USUARIO"), drPagos.Item("FKDAT")) TODOEB
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " Inicia Consulta Càlculo Efectivo")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " Paràmetros: Punto Venta: " & AppAlmacen & "  Fecha: " & DateTime.Now)
            'dblEfecCaja = objCajas.FP_CalculaEfectivo(Session("ALMACEN"), Session("USUARIO"), DateTime.Now)
            '** CONSULTA EFECTIVO CAJA:
            Dim cultureNameCaja As String = "es-PE"
            Dim cultureCaja As CultureInfo = New CultureInfo(cultureNameCaja)
            Dim dateTimeValueCajaEfe As DateTime
            dateTimeValueCajaEfe = Convert.ToDateTime(DateTime.Now, cultureCaja)
            Dim dFechaCaj0 As Date
            Dim sFechaCaj0 As String = dateTimeValueCajaEfe.ToLocalTime.ToShortDateString
            'PROY-140397-MCKINSEY -> JSQ INICIO
            sFechaCaj0 = DateTime.Now().ToString("dd/MM/yyyy")
            'PROY-140397-MCKINSEY -> JSQ FIN
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - Fecha Pedido : " & sFechaCaj0)

            dblEfecCaja = objCajas.FP_CalculaEfectivo(AppAlmacen, AppUsuario, sFechaCaj0)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " Paràmetros: Punto Venta: " & AppAlmacen & "  Fecha: " & Funciones.CheckStr(sFechaCaj0))

            '*** AVILLAR  ****'
            Try
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " -Consulta el monto configurado de tarjeta.")
                dsDatGenerales = objConfig.FP_Lista_Param_Tarjeta(1)
                'Valor de monto de tarjeta configurado.
                If Not dsDatGenerales Is Nothing Then
                    dblMontoTarjeta = dsDatGenerales.Tables(0).Rows(0).Item("PARTN_MONTO")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " -dblMontoTarjeta: " & Funciones.CheckStr(dsDatGenerales.Tables(0).Rows(0).Item("PARTN_MONTO")))
                End If
            Catch ex As Exception
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - Error al consultar el monto configurado para la tarjeta.")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - Err." & ex.Message.ToString)
            End Try
            ' *** AVILLAR  ****'


            If dsEfectivo.Tables(0).Rows.Count = 0 Then
                'Response.Write("<script>alert('No existe configuracion de caja para este punto de venta.')</script>")
                AppErrorCaja = "No existe configuracion de caja para este punto de venta."
                Exit Function
            End If

            dblTolerancia = dsEfectivo.Tables(0).Rows(0).Item("CAJA_TOLERANCIA_SOL")

            If dblEfecCaja >= dsEfectivo.Tables(0).Rows(0).Item("CAJA_MAX_DISP_SOL") + dblTolerancia Then
                'Response.Write("<script>alert('Ha alcanzado su maximo disponible de efectivo en caja. Debe depositar en caja buzón')</script>")
            Else

                'blnSunat = (drPagos.Item("XBLNR") = "" Or drPagos.Item("XBLNR") = "0000000000000000") TODOEB
                If Not Convert.IsDBNull(drPagos.Item("PAGOC_CODSUNAT")) Then
                    blnSunat = (drPagos.Item("PAGOC_CODSUNAT") = "" Or drPagos.Item("PAGOC_CODSUNAT") = "0000000000000000")
                Else
                    blnSunat = False
                End If

                If Trim(txtNumSunat) = "" Then
                    strNumSunat = txtCorrelativo
                Else
                    strNumSunat = txtNumSunat
                End If
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "NumSunat : " & strNumSunat.ToString())

                If blnSunat Then
                    strNumAsignaSUNAT = txtCompleto
                Else
                    strNumAsignaSUNAT = strNumSunat
                End If

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "strNumAsignaSUNAT : " & strNumAsignaSUNAT.ToString())



                Dim K_COD_RESPUESTA As String
                Dim K_MSJ_RESPUESTA As String
                Dim K_ID_TRANSACCION As String

                Dim p_limpiador As Integer = 0


                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Validar detalle del pedido")

                If sTipoVenta = ConfigurationSettings.AppSettings("strTVPrepago") Then
                    If sTipoOperacion = ConfigurationSettings.AppSettings("COD_OPERACION_ALTAyPORTABILIDAD") Then
                        '*******************************************************************************************************
                        'Consulta las siguientes Tablas.
                        '**1. sisact_venta_prepago. 
                        '**2. sisact_detalle_venta_prepago. 
                        Try
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicia consulta datos Pedido Prepagos Alta y Portabilidad en PVU ")
                            objClsConsultaPvu.ConsultarPedidosPrepago(drPagos.Item("PEDIN_NROPEDIDO"), P_CODIGO_RESPUESTA, P_MENSAJE_RESPUESTA, C_VENTA, C_VENTA_DET)

                            int64IdVenta = Funciones.CheckInt64(C_VENTA.Rows(0).Item("VEPR_ID"))
                            strDocumentoIdentidadNumero = Funciones.CheckStr(C_VENTA.Rows(0).Item("VEPR_NUM_DOC"))

                            If P_MENSAJE_RESPUESTA <> "OK" Then
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  No se encontro el pedido en la tabla : sisact_info_venta_sap. pkg:sisact_pkg_venta sp:sp_con_venta_x_docsap => " & drPagos.Item("PEDIN_NROPEDIDO"))
                            End If
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin consulta datos Pedido Prepagos Alta y Porta en PVU ")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "P_MENSAJE_RESPUESTA: " & P_MENSAJE_RESPUESTA)
                        Catch ex As Exception
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Error al ejecutar el sp: SP_CON_VENTA_PREPAGO , para el pedido => " & drPagos.Item("PEDIN_NROPEDIDO"))
                            'INI PROY-140126
                            Dim MaptPath As String
                            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                            MaptPath = "( Class : " & MaptPath & "; Function: guardarConectado)"
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     Exception: " & ex.ToString() & MaptPath)
                            'FIN PROY-140126

                        End Try
                    Else
                        'Consulta las siguientes Tablas.
                        '**1. SISACT_VENTA_REPO_PRE.
                        p_limpiador = 1
                        Try
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicia consulta datos pedido Prepago diferentes a las Altas y Portabilidad en PVU")
                            C_VENTA_Prepago = objClsConsultaPvu.ObtenerDatosVentaPrepago(drPagos.Item("PEDIN_NROPEDIDO"), P_MENSAJE_RESPUESTA)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin consulta datos pedido Prepago diferentes a las Altas y Portabilidad en PVU, P_MENSAJE_RESPUESTA :  " & P_MENSAJE_RESPUESTA)
                        Catch ex As Exception
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Ingreso a EX : " & ex.Message.ToString())
                        End Try
                    End If

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "p_limpiador :  " & p_limpiador)

                    If p_limpiador = 1 Then
                        If Not C_VENTA_Prepago Is Nothing Then
                            If C_VENTA_Prepago.Tables.Count > 0 Then
                                If C_VENTA_Prepago.Tables(0).Rows.Count > 0 Then
                                    campania_Pre = Funciones.CheckStr(C_VENTA_Prepago.Tables(0).Rows(0).Item("CAMPANIA_COD"))
                                    plan_pre = Funciones.CheckStr(C_VENTA_Prepago.Tables(0).Rows(0).Item("PLAN_TARIFARIO_COD"))
                                    tipo_venta_pvu = Funciones.CheckStr(C_VENTA_Prepago.Tables(0).Rows(0).Item("Tipo_Operacion"))
                                    flag_ped_repo = Funciones.CheckStr(C_VENTA_Prepago.Tables(0).Rows(0).Item("flag_tipo_venta_repo"))
                                End If
                            End If
                        End If
                    Else
                        If Not C_VENTA_DET Is Nothing Then
                            If C_VENTA_DET.Rows.Count > 0 Then
                                campania_Pre = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("DVPR_COD_CAMPANA"))
                                plan_pre = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("DVPR_COD_PLAN"))
                                cod_Prod_TFI = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("DVPR_COD_PROD_PREP"))
                                tipo_venta_pvu = "NTRR"
                            End If
                        End If
                    End If

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "campania_Pre :  " & campania_Pre)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "plan_pre :  " & plan_pre)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "tipo_venta_pvu : " & tipo_venta_pvu)
                Else
                    '*******************************************************************************************************
                    '**1. sisact_info_venta_sap => consulta con el numero de pedido(nro_documento), retorna el n_id_venta.
                    '**2. sisact_ap_venta v / sisact_ap_contrato, donde  v.id_documento=n_id_venta => c_venta
                    '**3. sisact_ap_venta_detalle vd => vd.id_documento = n_id_venta => c_venta_det  
                    Try
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicia consulta datos Pedido PostPsgo en PVU ")
                        objClsConsultaPvu.ConsultarPedidosPVU(drPagos.Item("PEDIN_NROPEDIDO"), _
                                                                      P_CODIGO_RESPUESTA, _
                                                                      P_MENSAJE_RESPUESTA, _
                                                                      C_VENTA, _
                                                                      C_VENTA_DET)

                        If P_MENSAJE_RESPUESTA <> "OK" Then
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  No se encontro el pedido en la tabla : sisact_info_venta_sap. pkg:sisact_pkg_venta sp:sp_con_venta_x_docsap => " & drPagos.Item("PEDIN_NROPEDIDO"))
                        End If

                        If Not C_VENTA_DET Is Nothing Then
                            If C_VENTA_DET.Rows.Count > 0 Then
                                campania_Post = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("campana"))
                                plan_post = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("plan"))
                                tipo_venta_pvu = Funciones.CheckStr(C_VENTA.Rows(0).Item("TVENC_CODIGO"))
                            End If
                        End If

                        '140245 Inicio

                        Dim strPedi_NroPed As String = String.Empty 'Session("strPedi_NroPed")
                        strNumero_linea = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("TELEFONO"))
                        strPlan_Codigo = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("PLAN"))
                        strPlan_Desc = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("PLAN_DESC"))
                        strTipo_Prod_Cod = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("PRDC_CODIGO"))
                        strFecha_crea = ""

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Fecha de Creacion" & strFecha_crea)

                        Select Case (strTipo_Prod_Cod)
                            Case "01"
                                strTipo_Prod_Des = "MOVIL"
                                AppstrTipo_Prod_Des = strTipo_Prod_Des
                            Case "02"
                                strTipo_Prod_Des = "TFI"
                                AppstrTipo_Prod_Des = strTipo_Prod_Des
                            Case "03"
                                strTipo_Prod_Des = "TVSAT"
                                AppstrTipo_Prod_Des = strTipo_Prod_Des
                            Case "04"
                                strTipo_Prod_Des = "BAM"
                                AppstrTipo_Prod_Des = strTipo_Prod_Des
                            Case "05"
                                strTipo_Prod_Des = "3PLAY"
                                AppstrTipo_Prod_Des = strTipo_Prod_Des
                            Case "06"
                                strTipo_Prod_Des = "IFI"
                                AppstrTipo_Prod_Des = strTipo_Prod_Des
                            Case "08"
                                strTipo_Prod_Des = "LTE"
                                AppstrTipo_Prod_Des = strTipo_Prod_Des
                        End Select

                        strCampanaCod = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("CAMPANA"))
                        strCampanaDesc = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("CAMPANA_DESC"))
                        strTipo_Doc = Funciones.CheckStr(C_VENTA.Rows(0).Item("TIPO_DOC_CLIENTE"))
                        strNro_Doc = Funciones.CheckStr(C_VENTA.Rows(0).Item("NRO_DOC_CLIENTE"))
                        strNro_Ped = Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO"))

                        ' INC000002161718 INI
                        Dim strExiste As String = String.Empty
                        Dim strCfMax As Double = 0
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Ini INC000002161718 ValidarWhitelist")
                        Dim isWhitelist As Boolean = objClsConsultaPvu.ValidarWhitelist(strExiste, _
                                                            strCfMax, _
                                                            strTipo_Doc, _
                                                            strNro_Doc, _
                                                            "E4")
                        If isWhitelist Then
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Respuesta ValidarWhitelist strExiste : " & "true")
                            If strExiste = "S" Then
                                strCamp_Estado = "P1"
                            Else
                                strCamp_Estado = "P2"
                            End If
                        Else
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Respuesta ValidarWhitelist strExiste : " & "false")
                            strCamp_Estado = "P1"
                        End If
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin INC000002161718 ValidarWhitelist")
                        ' INC000002161718 FIN

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Proy-140245 CO-ID:" & strCo_Id)

                        'LOG
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Llenar numero Pedido" & strPedi_NroPed)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Llenar numero de Linea" & strNumero_linea)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Llenar numero de Documento" & strNro_Doc)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Llenar estado" & strCamp_Estado)

                        '140245 Fin

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "campania_Post :  " & campania_Post)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "plan_post :  " & plan_post)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "tipo_venta_pvu :  " & tipo_venta_pvu)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin consulta datos Pedido PostPsgo en PVU")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "P_MENSAJE_RESPUESTA: " & P_MENSAJE_RESPUESTA)
                    Catch ex As Exception
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Error al ejecutar el sp: SP_CON_VENTA_X_DOCSAP , para el pedido => " & drPagos.Item("PEDIN_NROPEDIDO"))
                        'INI PROY-140126
                        Dim MaptPath As String
                        MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                        MaptPath = "( Class : " & MaptPath & "; Function: guardarConectado)"
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     Exception: " & ex.ToString() & MaptPath)
                        'FIN PROY-140126

                    End Try
                    '*******************************************************************************************************
                End If

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Validar detalle del pedido")

                '140245 Validacion Inicio

                Dim strTVPost As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("strTVPostpago")) '220719
                Dim strReno As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("CONS_RENOVACION"))
                Dim strTipoVent As String
                Dim dsDatoPedido As DataSet
                dsDatoPedido = objConsultaMssap.ConsultaPedido(strNro_Ped, "", "")

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio consultar datos del pedido")

                If dsDatoPedido.Tables(0).Rows.Count > 0 Then
                    strTipoVent = Funciones.CheckStr(dsDatoPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA"))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Proy-140245 strTipoVent : " & strTipoVent)
                    If strTVPost = strTipoVent Then '220719 then 
                        If strNro_cont > 0 And strNro_Ped <> "" And Not strNro_Ped Is Nothing Then
                            If sDescripcionOperacion.IndexOf(strReno) > -1 Then
                                ' INI INC000002259009
                                Dim datosRenoPlan As String()
                                ' FIN INC000002259009
                                Dim strUsuario As String = AppstrUsuario
                                'INC000002161718 inicio
                                Dim strCodRpt, strMsjRpt As String
                                Dim objRegistrarCampaniasRequest As New COM_SIC_Activaciones.RegistrarCampaniasRequest
                                Dim objRegistrarCampaniasResponse As New COM_SIC_Activaciones.RegistrarCampaniasResponse
                                Dim objBEAuditoriaREST As New COM_SIC_Activaciones.AuditoriaEWS
                                Dim objHeaderRequest As New COM_SIC_Activaciones.HeaderRequest
                                Dim objauditRequest As New COM_SIC_Activaciones.BEAuditRequest
                                Dim objRegistrarCampania As New COM_SIC_Activaciones.RegistrarCampania
                                Dim objRegistrar As New COM_SIC_Activaciones.BWRegistrarCampania
                                Dim fechaMigPlan As String

                                ' INI INC000002259009
                                Try
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INC000002259009 Antes de  ServicioSIACPostpagoConsultas")
                                    datosRenoPlan = ServicioSIACPostpagoConsultas("", strNumero_linea).Split("|")
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INC000002259009 Despues de  ServicioSIACPostpagoConsultas")
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Resultado CO_ID : " & datosRenoPlan(1))
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Resultado Ciclo Fact : " & datosRenoPlan(4))
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INI INC000002259009 INICIO CalcularFechaTopeProgramacion")
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "IN - " & datosRenoPlan(4))
                                    fechaMigPlan = CalcularFechaTopeProgramacion(datosRenoPlan(4), strIdentifyLog)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "OUT - " & fechaMigPlan)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FIN INC000002259009 CalcularFechaTopeProgramacion")

                                    If datosRenoPlan(1) = 0 Then
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, "INC000002259009 Error en la obtencion del CO_ID : " & datosRenoPlan(1))
                                        'Session.Add("msgErrorGenerarSot", Funciones.CheckStr(ConfigurationSettings.AppSettings("MsjErrorServDatosCliente")))
                                        'Response.Redirect("PoolPagos.aspx") ################ VALIDAR APP - SICAR ################
                                        AppmsgErrorGenerarSot = Funciones.CheckStr(ConfigurationSettings.AppSettings("MsjErrorServDatosCliente"))
                                        AppCodigoExitFunction = "-2"
                                        AppMensajeExitFunction = AppmsgErrorGenerarSot
                                        Exit Function
                                    End If
                                Catch ex As Exception
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, "INC000002259009 Error en la ejecucion del servicio ServicioSIACPostpagoConsultas")
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Detalle del error : " & ex.Message)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Detalle del error : " & ex.StackTrace)
                                    'Session.Add("msgErrorGenerarSot", Funciones.CheckStr(ConfigurationSettings.AppSettings("MsjErrorServDatosCliente")))
                                    'Response.Redirect("PoolPagos.aspx") ################ VALIDAR APP - SICAR ################
                                    AppmsgErrorGenerarSot = Funciones.CheckStr(ConfigurationSettings.AppSettings("MsjErrorServDatosCliente"))
                                    AppCodigoExitFunction = "-2"
                                    AppMensajeExitFunction = AppmsgErrorGenerarSot
                                    Exit Function
                                End Try

                                ' FIN INC000002259009

                                'INI: INICIATIVA-219
                                Dim objCbioWS As New BWServicesCBIO
                                Dim strOrigenLinea As String = objCbioWS.ConsultarLineaCuentaWSCBIO(strNumero_linea)
                                'FIN: INICIATIVA-219

                                If Not strOrigenLinea = "1" Then
                                objHeaderRequest.consumer = ""
                                objHeaderRequest.country = CheckStr(ConfigurationSettings.AppSettings("DAT_ConsultaNacionalidad_country"))
                                objHeaderRequest.dispositivo = ""
                                objHeaderRequest.language = CheckStr(ConfigurationSettings.AppSettings("DAT_ConsultaNacionalidad_language"))
                                objHeaderRequest.modulo = ""
                                objHeaderRequest.msgType = CheckStr(ConfigurationSettings.AppSettings("DAT_ConsultaNacionalidad_msgType"))
                                objHeaderRequest.operation = ""
                                objHeaderRequest.pid = ""
                                objHeaderRequest.system = ""
                                objHeaderRequest.timestamp = Convert.ToDateTime(String.Format("{0:u}", DateTime.UtcNow))
                                objHeaderRequest.userId = ""
                                objHeaderRequest.wsIp = Funciones.CheckStr(ConfigurationSettings.AppSettings("DAT_RegistrarCampana_wsIp"))

                                objRegistrarCampaniasRequest.MessageRequest.Header.HeaderRequest = objHeaderRequest

                                objauditRequest.idTransaccion = DateTime.Now.ToString("yyyyMMddHHmmssfff")
                                objauditRequest.ipAplicacion = CurrentTerminal
                                objauditRequest.nombreAplicacion = Funciones.CheckStr(ConfigurationSettings.AppSettings("constAplicacion"))
                                objauditRequest.usuarioAplicacion = CurrentUser

                                objRegistrarCampania.tipoDocumento = strTipo_Doc
                                objRegistrarCampania.nroDocumento = strNro_Doc
                                objRegistrarCampania.nroLinea = strNumero_linea
                                objRegistrarCampania.nroSec = strNro_Sec
                                objRegistrarCampania.nroPed = strNro_Ped
                                objRegistrarCampania.nroPedDet = strNro_Ped_Det
                                objRegistrarCampania.nroCont = strNro_cont
                                objRegistrarCampania.nroContDet = strNro_cont_Det
                                objRegistrarCampania.tmCode = "0"
                                objRegistrarCampania.planCodigo = strPlan_Codigo
                                objRegistrarCampania.planDescripcion = strPlan_Desc
                                objRegistrarCampania.tipoPrdCodigo = strTipo_Prod_Cod
                                objRegistrarCampania.tipoPrdDescripcion = strTipo_Prod_Des
                                objRegistrarCampania.campaniaCodigo = strCampanaCod
                                objRegistrarCampania.campaniaDescripcion = strCampanaDesc
                                objRegistrarCampania.coId = datosRenoPlan(1)
                                objRegistrarCampania.tipoOpeCodigo = strTipo_Opera_Cod
                                objRegistrarCampania.tipoOpeDescripcion = strTipo_opera_Des
                                objRegistrarCampania.estado = strCamp_Estado
                                objRegistrarCampania.usuarioCrea = strUsuario
                                objRegistrarCampania.fechaCrea = strFecha_crea
                                objRegistrarCampania.usuarioModifica = ""
                                objRegistrarCampania.fechaModifica = ""
                                objRegistrarCampania.fechaActivacion = fechaMigPlan

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "campaniaDescripcion:" & objRegistrarCampania.campaniaDescripcion)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "fechaActivacion:" & objRegistrarCampania.fechaActivacion)

                                objRegistrarCampaniasRequest.MessageRequest.Body.registrarCampaniaRequest.auditRequest = objauditRequest
                                objRegistrarCampaniasRequest.MessageRequest.Body.registrarCampaniaRequest.registrarCampania = objRegistrarCampania

                                objBEAuditoriaREST.IDTRANSACCION = Now.Year & Now.Month & Now.Day & Now.Hour & Now.Minute & Now.Second
                                objBEAuditoriaREST.IPAPLICACION = AppLOCAL_ADDR
                                objBEAuditoriaREST.idTransaccionNegocio = CurrentTerminal
                                objBEAuditoriaREST.USRAPP = CurrentUser
                                objBEAuditoriaREST.applicationCodeWS = ConfigurationSettings.AppSettings("strAplicacionSISACT")
                                objBEAuditoriaREST.APLICACION = ConfigurationSettings.AppSettings("constAplicacion")
                                objBEAuditoriaREST.userId = CurrentUser
                                objBEAuditoriaREST.nameRegEdit = ""

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Proy-140245 IDTRANSACCION:" & objBEAuditoriaREST.IDTRANSACCION)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Proy-140245 IPAPLICACION:" & objBEAuditoriaREST.IPAPLICACION)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Proy-140245 idTransaccionNegocio:" & objBEAuditoriaREST.idTransaccionNegocio)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Proy-140245 idTransaccionNegocio:" & objBEAuditoriaREST.APLICACION)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Proy-140245 idTransaccionNegocio:" & objBEAuditoriaREST.applicationCodeWS)

                                objRegistrarCampaniasResponse = objRegistrar.RegistrarCampaniasResponse(objRegistrarCampaniasRequest, objBEAuditoriaREST)

                                strCodRpt = objRegistrarCampaniasResponse.MessageResponse.Body.registrarCampaniaResponse.auditResponse.codigoRespuesta
                                strMsjRpt = objRegistrarCampaniasResponse.MessageResponse.Body.registrarCampaniaResponse.auditResponse.mensajeRespuesta

                                'objRegistrarCampaniasResponse = objRegistrar.RegistrarCampaniasResponse(objRegistrarCampaniasRequest, objBEAuditoriaREST)

                                'strCodRpt = "0" 'objRegistrarCampaniasResponse.MessageResponse.Body.registrarCampaniaResponse.auditResponse.codigoRespuesta
                                'strMsjRpt = "Exito" 'objRegistrarCampaniasResponse.MessageResponse.Body.registrarCampaniaResponse.auditResponse.mensajeRespuesta

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Response WS RegistrarCampana")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "COD_RPTA: " & strCodRpt)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "MSG_RPTA: " & strMsjRpt)
                                End If
                                'INC000002161718 fin 

                                strTipo_opera_Des = ""
                                strNro_Sec = "0"
                                strNro_Ped_Det = "0"
                                strTipo_Opera_Cod = ""
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Proy-140245 limpiar variables")
                            End If
                            '140245: Fin()
                        End If
                    End If
                End If


                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin consultar datos del pedido")

                If p_limpiador = 1 Then
                    C_VENTA_DET = Nothing
                    C_VENTA = Nothing
                Else
                    If C_VENTA.Rows.Count = 0 Then
                        C_VENTA = Nothing
                    End If

                    If C_VENTA_DET.Rows.Count = 0 Then
                        C_VENTA_DET = Nothing
                    End If

                    C_VENTA_DET = C_VENTA_DET
                    C_VENTA = C_VENTA
                End If


                Dim dblTotPreCuo As Double
                Dim dblTotalReg As Double
                'si es venta prepago y ademas tiene cuotas  
                'inicio promocion modem + laptop

                If campania_Pre <> "" Then
                    Campania = campania_Pre
                    Plan_final = plan_pre
                End If

                If campania_Post <> "" Then
                    Campania = campania_Post
                    Plan_final = plan_post
                End If

                ' E75893 - Validacion Adjuntar Documento Cliente solo Ventas Altas Prepago
                'If ValidacionVentaDOL(drPagos.Item("VBELN"), CStr(drPagos.Item("PEDIDO"))) Then TODOEB
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicia ValidacionVentaDOL")
                'INICIATIVA-318 INI
                'If divPagos.Visible Then
                '    If ValidacionVentaDOL(dsPedido.Tables(0).Rows(0)("PEDIN_NROPEDIDO"), dsPedido.Tables(0).Rows(0)("PEDIN_NROPEDIDO")) Then
                '        If hidFlagCargaDocDOL.Value <> "1" Then
                '            Dim tipoDocCliente As String

                '            tipoDocCliente = dsPedido.Tables(0).Rows(0)("CLIEC_TIPODOCCLIENTE")

                '            If Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")) <> ConfigurationSettings.AppSettings("strTipDoc") Then
                '                If Not Right("00" & tipoDocCliente, 2) = "06" Then
                '                    Response.Write("<script>alert('" & ConfigurationSettings.AppSettings("mensajeAdjuntarDNI") & "')</script>")
                '                    Exit Sub
                '                End If
                '            End If
                '        End If
                '    End If
                'End If
                'INICIATIVA-318 FIN

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin ValidacionVentaDOL")


                '***IDG****'
                '*****Validación Pago del documento total **********************************************************************************************'
                If Trim(ApptxtMonto1) <> "" Then
                    dblTotalReg = CDbl(ApptxtMonto1)
                End If
                'If Trim(txtMonto2) <> "" Then
                '    dblTotalReg += CDbl(txtMonto2)
                'End If
                'If Trim(txtMonto3) <> "" Then
                '    dblTotalReg += CDbl(txtMonto3)
                'End If
                'If Trim(txtMonto4) <> "" Then
                '    dblTotalReg += CDbl(txtMonto4)
                'End If
                'If Trim(txtMonto5) <> "" Then
                '    dblTotalReg += CDbl(txtMonto5)
                'End If

                Dim dblMontoGrilla As String = Funciones.CheckStr(drPagos.Item("INPAN_TOTALDOCUMENTO"))
                Dim dblMontoConsulta As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO"))
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - INICIO VALIDAR MONTOS")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " -      MONTO TOTAL GRILLA: " & dblMontoGrilla)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " -      MONTO TOTAL CONSULTA PEDIDO: " & dblMontoConsulta)
                If Not dblMontoGrilla.Equals(dblMontoConsulta) Then
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " -      RPTA: MONTOS DIFERENTES")
                    AppmsgDevolucion = ConfigurationSettings.AppSettings("strMsgErrorMonto")
                    AppCodigoExitFunction = "-2"
                    AppMensajeExitFunction = AppmsgDevolucion
                    'Response.Redirect("PoolPagos.aspx", False)
                    Exit Function
                End If
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " -      RPTA: MONTOS CORRECTOS")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - FIN VALIDAR MONTOS")

                If Funciones.CheckDbl(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")) <> ConfigurationSettings.AppSettings("ClaseNotaCanje") And _
                    Funciones.CheckDbl(dsPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO")) = 0 And _
                    Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_ESQUEMACALCULO")) <> ConfigurationSettings.AppSettings("ESQUEMACALCULO_TG") Then
                    'Response.Write("<script>alert('" & ConfigurationSettings.AppSettings("MSG_MontoCero_NO_ES_TG") & "')</script>")
                    AppErrorPagoParcial = ConfigurationSettings.AppSettings("MSG_MontoCero_NO_ES_TG")
                    Exit Function
                End If

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "dblTotalReg : " & Funciones.CheckStr(dblTotalReg))
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "txtNeto.Text : " & Funciones.CheckStr(txtNeto))

                'PROY-30166 - IDEA  38934  INICIO
                Dim cuota As Integer = HidNroCuotas
                If (cuota = 0 And dblMontoCuotaInicial <= 0) Then
                    If Math.Round(dblTotalReg, 2) <> Math.Round(Funciones.CheckDbl(txtNeto), 2) Then
                        'Response.Write("<script>alert('No se permiten pagos parciales. El pago debe ser por el total del documento.')</script>")
                        AppErrorPagoParcial = "No se permiten pagos parciales. El pago debe ser por el total del documento."
                        Exit Function
                    End If
                Else
                    If Math.Round(dblTotalReg, 2) <> Math.Round(Funciones.CheckDbl(txtCuotaIni), 2) Then
                        'Response.Write("<script>alert('No se permiten pagos parciales. El pago debe ser por el monto de la cuota inicial.')</script>")
                        AppErrorPagoParcial = "No se permiten pagos parciales. El pago debe ser por el monto de la cuota inicial."
                        Exit Function
                    End If
                End If
                'PROY-30166 - IDEA  38934  FIN			
                '***************************************************************************************************************************************'
                '***FDG******'

                '***************************************************************************************************************************************'
                '***FDG******'


                If blnSunat Then
                    'dsResult = objPagos.Get_ConsultaPedido("", Session("ALMACEN"), drPagos.Item("VBELN"), "")
                    dsResult = objConsultaMssap.ConsultaPedido(drPagos.Item("PEDIN_NROPEDIDO"), "", "")

                    If Not IsNothing(dsResult) Then
                        'strNroDoc = dsResult.Tables(0).Rows(0).Item("DOCUMENTO") TODOEB
                        'strNroDoc = dsResult.Tables(0).Rows(0).Item("PEDIV_NRODOCCLIENTE")
                        strNroDoc = dsResult.Tables(0).Rows(0).Item("CLIEV_NRODOCCLIENTE")
                    Else
                        strNroDoc = ""
                    End If

                    blnFlagPago = True

                    '************************************************************************************************'
                    '**
                    '** La parte de la Triaciòn, queda sin Efecto. ** Consultado y validado por Eriberto  14.01.15 **
                    '************************************************************************************************'
                    'If strNroDoc <> "" Then
                    '    dsResult = objPagos.ConsultaTriacionPrePost(strNroDoc, "", "", "")
                    '    If Not IsNothing(dsResult) Then
                    '        'blnFlagPago = True
                    '        For i = 0 To dsResult.Tables(0).Rows.Count - 1
                    '            strPrepago = dsResult.Tables(0).Rows(i).Item("NRO_DOC_PREPAGO")
                    '            strPostPago = dsResult.Tables(0).Rows(i).Item("NRO_DOC_POSTPAGO")
                    '            intCeros = (Len(strNroDoc) - Len(strPrepago))

                    '            If intCeros > 0 Then
                    '                For j = 1 To intCeros
                    '                    strPrepago = "0" & strPrepago
                    '                Next
                    '            End If

                    '            intCeros = Len(strNroDoc) - Len(strPostPago)
                    '            If intCeros > 0 Then
                    '                For j = 1 To intCeros
                    '                    strPostPago = "0" & strPostPago
                    '                Next
                    '            End If

                    '            If strNroDoc = strPrepago Then
                    '                strEstado = ConfigurationSettings.AppSettings("gstrCamEstadoVendido")
                    '                strMensaje = ConfigurationSettings.AppSettings("gstrMsgPagodePre")
                    '                If dsResult.Tables(0).Rows(i).Item("ESTADO") <> ConfigurationSettings.AppSettings("gstrCamEstadoPagado") Then
                    '                    blnFlagPago = False
                    '                End If
                    '            End If
                    '            If strNroDoc = strPostPago Then
                    '                strEstado = ConfigurationSettings.AppSettings("gstrCamEstadoPagado")
                    '                strMensaje = ConfigurationSettings.AppSettings("gstrMsgPagodePost")
                    '                If dsResult.Tables(0).Rows(i).Item("ESTADO") <> ConfigurationSettings.AppSettings("gstrCamEstadoUsado") Then
                    '                    blnFlagPago = False
                    '                End If
                    '            End If

                    '            strCadenaCam = strCadenaCam & dsResult.Tables(0).Rows(i).Item("SECUENCIAL") & ";"
                    '            strCadenaCam = strCadenaCam & dsResult.Tables(0).Rows(i).Item("OFICINA_VENTA") & ";"
                    '            strCadenaCam = strCadenaCam & dsResult.Tables(0).Rows(i).Item("CLIENTE") & ";"
                    '            strCadenaCam = strCadenaCam & dsResult.Tables(0).Rows(i).Item("TIPO_DOC_CLIENTE") & ";"
                    '            strCadenaCam = strCadenaCam & dsResult.Tables(0).Rows(i).Item("NRO_TEL_PREPAGO") & ";"
                    '            strCadenaCam = strCadenaCam & dsResult.Tables(0).Rows(i).Item("NRO_DOC_PREPAGO") & ";"
                    '            strCadenaCam = strCadenaCam & dsResult.Tables(0).Rows(i).Item("NRO_TEL_POSTPAGO") & ";"
                    '            strCadenaCam = strCadenaCam & dsResult.Tables(0).Rows(i).Item("NRO_DOC_POSTPAGO") & ";"
                    '            strCadenaCam = strCadenaCam & strEstado & "|"

                    '        Next

                    '        If Len(Trim(strCadenaCam)) > 0 Then
                    '            strCadenaCam = Mid(strCadenaCam, 1, Len(strCadenaCam) - 1)
                    '        End If
                    '    End If

                    '    If Not blnFlagPago Then
                    '        Session("strMensajeCaja") = strMensaje
                    '        'Response.Write("<script>alert('" & strMensaje & "')</script>")
                    '        Response.Redirect("PoolPagos.aspx")
                    '    End If
                    'End If '***********  FIN DE LA TRIACIÒN *****************************************************'
                    '*************************************************************************************'
                End If
                ' FIN CAMPAÑA PRE + POST
                dblEfectivo = 0
                dblTotalTarjeta = 0
                If hidNumFilas = "" Then hidNumFilas = 0
                strDetallePago = ""
                'PROY-27440 INI
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicia asignaciòn el importe total")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INPAN_TOTALDOCUMENTO : " & Funciones.CheckStr(Format(dsPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO"), "###0.00")))
                ApptxtMonto1 = Format(dsPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO"), "###0.00")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin asignaciòn el importe total")

                Dim strMonto As String = ""
                Dim strTipoDocPago As String = ""
                'PROY-27440 FIN
                For i = 1 To hidNumFilas

                    'PROY-27440 INI
                    'Dim objTxt As TextBox
                    'objTxt = CType(Me.FindControl("txtMonto" & i), TextBox)
                    'strMonto = "" : strMonto = Trim(objTxt.Text)

                    strMonto = ApptxtMonto1

                    'Dim objCbo As DropDownList
                    'objCbo = CType(Me.FindControl("cboTipDocumento" & i), DropDownList)
                    'strTipoDocPago = "" : strTipoDocPago = Trim(objCbo.SelectedValue)

                    strTipoDocPago = AppCboTipoDocumento

                    'PROY-27440 FIN
                    strDetallePago = strDetallePago & ";"
                    'strDetallePago = strDetallePago & Session("ALMACEN") & ";" ' Concatenar detalles de pag
                    strDetallePago = strDetallePago & AppAlmacen & ";"    ' Concatenar detalles de pago
                    strDetallePago = strDetallePago & strTipoDocPago & ";"  ' Codigo del Tipo de documento (Via de Pago) ''PROY-27440
                    strDetallePago = strDetallePago & ";"
                    strDetallePago = strDetallePago & ";"
                    strDetallePago = strDetallePago & strMonto & ";" ' Monto de pago ''PROY-27440
                    'If (Session("VarVal2") = Session("CANAL")) Then      ' averiguar en que variable se guarda canal - MONEDA
                    strDetallePago = strDetallePago & "PEN" & ";"
                    'Else
                    '    strDetallePago = strDetallePago & "L" & ";"
                    'End If

                    strDetallePago = strDetallePago & ";"

                    strDetallePago = strDetallePago & strNumAsignaSUNAT & ";"
                    strDetallePago = strDetallePago & strTipoDocPago & ";"    ' GLOSA QUE ES LO MISMO DE VIA_PAGO ''PROY-27440
                    '  strDetallePago = strDetallePago &  DateTime.Now & ";"    ' Fecha de documento que esta en el detalle - F_PEDIDO TODOEB
                    strDetallePago = strDetallePago & DateTime.Now & ";"    ' Fecha de documento que esta en el detalle - F_PEDIDO
                    strDetallePago = strDetallePago & ";"

                    'If (Session("VarVal2") = Session("CANAL")) Then
                    strDetallePago = strDetallePago & ";"
                    'Else
                    '    strDetallePago = strDetallePago & strTipoFact & ";"
                    'End If

                    If Trim(strTipoDocPago) = "ZEFE" Then ''PROY-27440
                        dblEfectivo += CDbl(Trim(strMonto)) ''PROY-27440
                    End If

                    If (i < CInt(hidNumFilas)) Then
                        strDetallePago = strDetallePago & "|"
                    End If

                    'Valida sumatoria de tarjetas....
                    'AVILLAR : ZNCR
                    ''PROY-27440 - INI
                    If strTipoDocPago <> "ZNCR" And strTipoDocPago <> "ZEFE" And strTipoDocPago <> "ZEAM" And strTipoDocPago <> "ZEOV" And strTipoDocPago <> "TDPP" And strTipoDocPago <> "ZDEL" And strTipoDocPago <> "ZBUY" Then
                        dblTotalTarjeta += strMonto
                    End If
                    ''PROY-27440 - FIN
                    'FIN AVILLAR
                Next

                'AVILLAR
                If dblTotalTarjeta > dblMontoTarjeta Then
                    If AppCarga = 0 Then
                        'INICIATIVA - 529 INI
                        'Session("strMensajeCaja") = "Debe adjuntar una copia del Documento de Identidad"
                        'Response.Redirect("PoolPagos.aspx")
                        'INICIATIVA - 529 FIN
                    End If
                End If
                'FIN AVILLAR

                If (dblEfectivo + dblEfecCaja) >= dblTolerancia + dsEfectivo.Tables(0).Rows(0).Item("CAJA_MAX_DISP_SOL") Then
                    'Response.Write("<script>alert('Este pago excede su tolerancia de monto máximo de efectivo en caja')</script>")
                    AppstrMensajeCaja = "Este pago excedió su tolerancia de monto máximo de efectivo en caja"
                End If
                'Else

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ListarDatosCabeceraVenta - strDocSap: " & strDocSap)
                dtDatos = objBus.ListarDatosCabeceraVenta(strDocSap)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ListarDatosCabeceraVenta - dtDatos: " & dtDatos.Rows.Count.ToString)

                ' INICIO FMES :DETERMINA SI TIENE EL FLAG DE PILOTO VENTA EN CAC
                'If dtDatos.Rows.Count > 0 Then
                'If Funciones.CheckStr(dtDatos.Rows(0).Item("VEPR_FLAG_VENTA_CAC").ToString()) = "1" Then
                'booDol = False
                'End If
                'End If

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ListarDatosCabeceraVenta - booDol: " & booDol.ToString)
                ' FIN FMES :DETERMINA SI TIENE EL FLAG DE PILOTO VENTA EN CAC


                If dsPedido.Tables(0).Rows.Count Then
                    ''''***IDG*****************************************************************************************************************************************************'
                    '''**** CONSULTA DATOS DEL CAJERO ****'
                    Dim cultureNameX As String = "es-PE"
                    Dim cultureX As CultureInfo = New CultureInfo(cultureNameX)
                    Dim dateTimeValueCaja As DateTime
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Iniciamos la consulta de los datos CAJA")
                    dateTimeValueCaja = Convert.ToDateTime(DateTime.Now, cultureX)
                    Dim strFecha As String = ""
                    strFecha = Format(Now.Day, "00") & "/" & Format(Now.Month, "00") & "/" & Format(Now.Year, "0000")
                    Dim codigo_vendedor_session As String = ""

                    'Try
                    '    objOfflineCaja = New COM_SIC_OffLine.clsOffline
                    '    codigo_vendedor_session = Funciones.CheckStr(AppUsuario).PadLeft(10, "0")

                    '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "---------------------------------------------------- ")
                    '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Paràmetros : GetDatosAsignacionCajero")
                    '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Param1: " & Funciones.CheckStr(AppAlmacen))
                    '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Param2: " & Funciones.CheckStr(dateTimeValueCaja.ToShortDateString))
                    '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Param2: " & Funciones.CheckStr(strFecha.ToString))
                    '    'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Param3: " & "00000" & Funciones.CheckStr(Session("USUARIO")))
                    '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Param3: " & codigo_vendedor_session)
                    '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "---------------------------------------------------- ")



                    '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-----------------------------------------------------------------------------")
                    '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "Test de fechas:")
                    '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- strFecha " & strFecha.ToString)
                    '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- dateTimeValueCaja " & dateTimeValueCaja.ToLocalTime.ToShortDateString)
                    '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Fecha Pedido " & CStr(dsPedido.Tables(0).Rows(0).Item("PEDID_FECHADOCUMENTO")))
                    '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-----------------------------------------------------------------------------")


                    '    'dsCajeroA = objOfflineCaja.GetDatosAsignacionCajero(Funciones.CheckStr(Session("ALMACEN")), Funciones.CheckStr(dateTimeValueCaja.ToShortDateString), "00000" & Funciones.CheckStr(Session("USUARIO")).ToString)
                    '    Dim dFechaCaj As Date
                    '    Dim sFechaCaj As String = dateTimeValueCaja.ToLocalTime.ToShortDateString
                    '    'PROY-140397-MCKINSEY -> JSQ INICIO
                    '    sFechaCaj = DateTime.Now.ToString("dd/MM/yyyy")
                    '    'PROY-140397-MCKINSEY -> JSQ FIN
                    '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - Fecha Pedido : " & sFechaCaj)
                    '    dsCajeroA = objOfflineCaja.GetDatosAsignacionCajero(Funciones.CheckStr(AppAlmacen), sFechaCaj, codigo_vendedor_session)
                    '    If (dsCajeroA Is Nothing OrElse dsCajeroA.Tables(0).Rows.Count <= 0) Then
                    '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- No se pudo determinar el numero de la caja asignada.")
                    '        'Response.Write("<script>alert('No se encontro el Nùmero/Nombre de caja asignado.')</script>")
                    '        AppErrorCaja = "No se encontro el Nùmero/Nombre de caja asignado."
                    '        Exit Function
                    '    End If
                    '    ' Validar cierre de caja
                    '    If Not dsCajeroA Is Nothing Then
                    '        For cont As Int32 = 0 To dsCajeroA.Tables(0).Rows.Count - 1
                    '            If dsCajeroA.Tables(0).Rows(cont).Item("CAJA_CERRADA") = "S" Then
                    '                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "MENSAJE : " & "Caja Cerrada, no es posible realizar el pago.")
                    '                Dim script$ = String.Format("<script language=javascript>alert('{0}')</script>", "Caja Cerrada, no es posible realizar el pago.")
                    '                'Me.RegisterStartupScript("RegistraAlerta", script)
                    '                AppErrorCaja = "Caja Cerrada, no es posible realizar el pago."
                    '                Exit Function
                    '            End If
                    '        Next
                    '    End If

                    'Catch ex As Exception
                    '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Error al tratar de consultar los datos de CAJA")
                    '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Error: " & ex.Message.ToString)
                    'End Try

                    ''**Buscamos el nombre de la Caja
                    'If dsCajeroA.Tables(0).Rows.Count > 0 Then
                    '    dsCajeroB = objOfflineCaja.Get_CajaOficinas(AppAlmacen)
                    '    If (dsCajeroB Is Nothing OrElse dsCajeroA.Tables(0).Rows.Count <= 0) Then
                    '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- No se pudo determinar el nombre de la caja asignada.")
                    '        'Response.Write("<script>alert('No se encontro el Nùmero/Nombre de caja asignado.')</script>")
                    '        AppErrorCaja = "No se encontro el Nùmero/Nombre de caja asignado."
                    '        Exit Function
                    '    Else
                    '        For c As Int16 = 0 To dsCajeroB.Tables(0).Rows.Count - 1
                    '            '**Comparamos los numeros de caja:
                    '            If dsCajeroA.Tables(0).Rows(0).Item("CAJA") = dsCajeroB.Tables(0).Rows(c).Item("CASNR") Then
                    '                strNombreCaja = Funciones.CheckStr(dsCajeroB.Tables(0).Rows(c).Item("BEZEI")).ToString.Trim
                    '            End If
                    '        Next
                    '    End If
                    'End If
                    ''***FDG*****************************************************************************************************************************************************'

                    '**IDG**
                    '***Cuando el pago se hace con forma NC y no cumple las validaciones ***
                    'Try
                    '    If ConsultaFormaPagoNotaCredito() = False Then
                    '        Exit Function    '** terminamos el proceso **'
                    '    End If
                    'Catch ex As Exception

                    'End Try
                    '**FDG*********************************************************************

                    '****Valores para la caja:
                    'strNombreCaja, _
                    'dsCajeroA.Tables(0).Rows(0).Item("CAJA"), _

                    'PROY-31850 - INICIO
                    blnIsOLO = False
                    If blnSunat Then
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INICIO VALIDACIONES VENTA OLO")
                        Try
                            Dim objClsActivacionPEL As New ClsActivacionPel
                            Dim strNumeroPedidoOLO = Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO"))
                            Dim strCodRespuestaPrepago As String = ""
                            Dim strCodProductoPrepago As String = ""

                            '1. Validar si es venta prepago - OLO
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " INICIO Lis_Lista_Detalle_Venta_Prepago")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " IN strNumeroPedidoOLO:" & strNumeroPedidoOLO)
                            Dim arrListaPrepago As ArrayList = objClsActivacionPEL.Lis_Lista_Detalle_Venta_Prepago(strNumeroPedidoOLO, strCodRespuestaPrepago)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " OUT arrListaPrepago :" & arrListaPrepago.Count)

                            If arrListaPrepago.Count > 0 Then
                                For Each item As COM_SIC_Activaciones.DetalleVentaPrepago In arrListaPrepago
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     INICIO LEER DATOS PREPAGO")
                                    strCodProductoPrepago = Funciones.CheckStr(item.COD_PROD_PREP)
                                    strIdPedidoVentaPVU = Funciones.CheckStr(item.ID)
                                    strSerieChip = strSerieChip & "|" & Funciones.CheckStr(item.SERIE_CHIP)
                                    strSerieEquipo = strSerieEquipo & "|" & Funciones.CheckStr(item.SERIE_EQUI)
                                    strCodMaterialChip = strCodMaterialChip & "|" & Funciones.CheckStr(item.COD_MATERIAL_CHIP)
                                    strNumDocumento = Funciones.CheckStr(item.NUM_DOC)
                                    strTipoDocumento = Funciones.CheckStr(item.TIPO_DOC)
                                    If strCodProductoPrepago = Funciones.CheckStr(strCodProductoOLO) Then
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strCodProductoPrepago: " & strCodProductoPrepago)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strIdPedidoVentaPVU: " & strIdPedidoVentaPVU)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strSerieChip: " & Funciones.CheckStr(item.SERIE_CHIP))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strCodMaterialChip: " & Funciones.CheckStr(item.COD_MATERIAL_CHIP))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strNumDocumento: " & strNumDocumento)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strTipoDocumento: " & strTipoDocumento)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     blnIsOLO: True")
                                        blnIsOLO = True
                                        'Exit For
                                    End If


                                    If blnIsOLO Then
                                        Dim strCodMensaje As String
                                        Dim strDesMensaje As String
                                        Dim strCodMnjG As String
                                        Dim strDesMnjG As String
                                        Dim strNumLinea As String = ""
                                        Dim strDescMensaje As String = ""
                                        Dim intNumIntentosMobile As String = Funciones.CheckInt(strMobileNumberWS_NumIntentos)
                                        Dim intNumIntentosGeneric As String = Funciones.CheckInt(strGenericWS_NumIntentos)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     intNumIntentosMobile: " & intNumIntentosMobile)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     intNumIntentosGeneric: " & intNumIntentosGeneric)

                                        Dim objLinea As New COM_SIC_Activaciones.BWMobileNumberService
                                        Dim objMensaje As New COM_SIC_Activaciones.BWGenericEntityService

                                        Dim IdTransa As String = DateTime.Now.ToString("yyyyMMddHHmmss") + "_" + strNumeroPedidoOLO
                                        Dim CodApli As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("CodAplicacion"))
                                        Dim UserApli As String = Funciones.CheckStr(AppUsuario)
                                        '2. Obtener Lineas
                                        If (intNumIntentosMobile = 0) Then
                                            intNumIntentosMobile = 1
                                        End If

                                        Dim k As Integer = 0
                                        Do While (k < intNumIntentosMobile)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     INICIO: ObtenerLineaOLO")
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         IN IdTransa: " & IdTransa)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         IN CodApli: " & CodApli)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         IN UserApli: " & UserApli)
                                            strLineaOLO = objLinea.ObtenerLineaOLO(IdTransa, CodApli, UserApli, strCodMensaje, strDesMensaje)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         OUT strCodMensaje: " & strCodMensaje)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         OUT strDesMensaje: " & strDesMensaje)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     FIN: ObtenerLineaOLO")

                                            If (strCodMensaje = "0" And strLineaOLO.Length > 0) Then
                                                Exit Do
                                            End If
                                            k = (k + 1)
                                        Loop

                                        If strCodMensaje <> "0" Or strLineaOLO = "" Then
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         ERROR ObtenerLineaOLO: " & Funciones.CheckStr(clsKeyOLO.strVentaErrorObtenerLineas))
                                            AppstrMensajeCaja = Funciones.CheckStr(clsKeyOLO.strVentaErrorObtenerLineas)
                                            blnIsOLO = False
                                            AppCodigoExitFunction = "-2"
                                            AppMensajeExitFunction = AppstrMensajeCaja
                                            'Response.Redirect("PoolPagos.aspx")
                                            Exit Function
                                        Else
                                            '2. Reservar Lineas
                                            If (intNumIntentosGeneric = 0) Then
                                                intNumIntentosGeneric = 1
                                            End If

                                            Dim y As Integer = 0

                                            Do While (y < intNumIntentosGeneric)
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     INICIO: ReservarLineaOLO")
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         IN IdTransa: " & IdTransa)
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         IN CodApli: " & CodApli)
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         IN UserApli: " & UserApli)
                                                objMensaje.ReservarLineaOLO(IdTransa, CodApli, UserApli, strLineaOLO, strCodMnjG, strDesMnjG)
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         OUT strCodMnjG: " & strCodMnjG)
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         OUT strDesMnjG: " & strDesMnjG)
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     FIN: ReservarLineaOLO")
                                                If strCodMnjG = "0" Then
                                                    Exit Do
                                                End If
                                                y = (y + 1)
                                            Loop
                                            If strCodMnjG <> "0" Then
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         ERROR ObtenerLineaOLO: " & Funciones.CheckStr(clsKeyOLO.strVentaErrorReservarLinea))
                                                AppstrMensajeCaja = Funciones.CheckStr(clsKeyOLO.strVentaErrorReservarLinea)
                                                blnIsOLO = False
                                                AppCodigoExitFunction = "-2"
                                                AppMensajeExitFunction = AppstrMensajeCaja
                                                'Response.Redirect("PoolPagos.aspx")
                                                Exit Function
                                            End If
                                            strLineaActivacion = strLineaActivacion & "|" & strLineaOLO
                                        End If
                                    Else
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "NO ES PREPAGO OLO")
                                    End If
                                Next
                            Else
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "NO ES PREPAGO")
                            End If
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FIN FLUJO VENTA OLO")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                        Catch ex As Exception
                            'INI PROY-140126
                            Dim MaptPath As String
                            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                            MaptPath = "( Class : " & MaptPath & "; Function: guardarConectado)"
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR FLUJO VENTA OLO" & ex.Message.ToString() & MaptPath)
                            'FIN PROY-140126

                        End Try
                    End If

                    'PROY-31850 - FIN


                    Dim strRespPago As Boolean 'PROY-23700 

                    '**** INICIO NOTAS DE CANJE*****
                    If dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA") = ConfigurationSettings.AppSettings("ClaseNotaCanje") Then
                        Try
                            'PROY-23700 INICIO
                            'If drPagos.Item("PAGOC_CODSUNAT") = "0000000000000000" Then
                            PagarNotaCanje(drPagos.Item("PEDIN_NROPEDIDO"), dsPedido, strRespPago)

                            If AppCodigoDeshacerCambios = "-3" Then
                                AppCodigoExitFunction = "-2"
                                AppMensajeExitFunction = AppMensajeDeshacerCambios
                                Exit Function
                            End If

                            If (strRespPago) Then
                                Exit Function
                            Else
                                AppCodigoExitFunction = "-2"
                                AppMensajeExitFunction = "Error al pagar la nota de canje"

                                'Response.Redirect("PoolPagos.aspx", False)
                                Exit Function
                            End If
                            'PROY-23700 FIN
                        Catch ex As Exception
                            'Response.Redirect("PoolPagos.aspx", False)
                            AppCodigoExitFunction = "-2"
                            AppMensajeExitFunction = "Error al pagar la nota de canje"
                            Exit Function
                        End Try

                    End If
                    '**** FIN NOTAS DE CANJE ******
                    Try
                        'inicio whzr 23062015
                        Dim strEmpleado As String = AppstrUsuario
                        Dim strUrl As String = ConfigurationSettings.AppSettings("consConsultaProgramacion")
                        Dim objCambioPlan As COM_SIC_Activaciones.CambioPlanPostpago
                        Dim strTipTransaccion As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("consTipoTransaccion"))
                        Dim strFechaDesde As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("consFechaDesde"))
                        Dim strFechaHasta As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("consFechaHasta"))
                        Dim strAsesor As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("consAsesor"))
                        Dim strCuenta As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("consCuenta"))
                        Dim strCodInteraccion As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("consCodInteraccion"))
                        Dim strCadDac As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("consCadDac"))
                        Dim strServCod As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("consServCod"))
                        Dim strTipServicio As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("consTipoServicio"))
                        Dim strEstadoTrans As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("consEstadoTrans"))
                        Dim mensajeError As String = String.Empty
                        Dim strNroLinea As String = FormatoTelefonoPrepago(Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO")))

                        If dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVPostpago") And _
                                    dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION") = ConfigurationSettings.AppSettings("strDTVRenovacion") Then
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "-----------------------------------------------------------------------------------------------------------------")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "                                 INICIO WS -> ConsultaProgramacion (" & strNroLinea & ") ")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, " URL -> " & strUrl & " || USER -> " & strEmpleado)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "-----------------------------------------------------------------------------------------------------------------")

                            objCambioPlan = (New COM_SIC_Activaciones.clsConsultaProgramacion).ConsultaProgramacion(strNroLinea, strTipTransaccion, strEstadoTrans, strTipServicio, strFechaDesde, _
                                                                                                strFechaHasta, strAsesor, strCuenta, strCodInteraccion, strCadDac, strServCod, strEmpleado, mensajeError)
                            'objCambioPlan = (New COM_SIC_Activaciones.clsConsultaCambioPlan).ConsultaCambioPlan(strNroLinea, strTipTransaccion, strEstadoTrans, mensajeError)

                            If mensajeError.Equals(String.Empty) Then
                                objFileLog.Log_WriteLog(pathFile, strArchivo, "-  ConsultaProgramacion()  (output) -> mensaje: La Lectura de los datos del NroLinea " & strNroLinea & " fue correcta")
                            Else
                                objFileLog.Log_WriteLog(pathFile, strArchivo, "-  ConsultaProgramacion()  (output) -> mensaje: Error al leer datos del NroLinea: " & strNroLinea & " " & mensajeError)
                                AppstrMensajeCaja = mensajeError
                                ' Response.Redirect("PoolPagos.aspx")
                                AppCodigoExitFunction = "-2"
                                AppMensajeExitFunction = AppstrMensajeCaja
                                Exit Function
                            End If

                            objFileLog.Log_WriteLog(pathFile, strArchivo, "-----------------------------------------------------------------------------------------------------------------")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "                                 FIN WS -> ConsultaProgramacion (" & strNroLinea & ") ")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "-----------------------------------------------------------------------------------------------------------------")

                        End If

                    Catch ex As Exception
                        'INI PROY-140126
                        Dim MaptPath As String
                        MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                        MaptPath = "( Class : " & MaptPath & "; Function: guardarConectado)"
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "- Error ConsultaCambioPlanPendiente: " & ex.Message.ToString() & MaptPath)
                        'FIN PROY-140126

                    End Try

                    Dim pedic_tipoOficina As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOOFICINA"))
                    Dim objAnnula As COM_SIC_Activaciones.clsTrsMsSap

                    '/*----------------------------------------------------------------------------------------------------------------*/
                    '/*--JR  INICIO  -  PROY-29380 IDEA-38934 - Iteración 2 y 3 2da Fase Sinergia Adec en Sist de Venta y Post-Venta --*/
                    '/*----------------------------------------------------------------------------------------------------------------*/
                    Dim strCodTipOpe As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("PEDIC_CODTIPOOPERACION"))
                    Dim strDesTipOpe As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("PEDIV_DESCTIPOOPERACION"))
                    '/*----------------------------------------------------------------------------------------------------------------*/
                    '/*--JR  FIN     -  PROY-29380 IDEA-38934 - Iteración 2 y 3 2da Fase Sinergia Adec en Sist de Venta y Post-Venta --*/
                    '/*----------------------------------------------------------------------------------------------------------------*/

                    ' PROY 31850 FASE IV INICIO
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "-----------------------------------------------------------------------------------------------------------------")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, " INICIO RECARGAS OLO ")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "-----------------------------------------------------------------------------------------------------------------")

                    Dim strTipoVenta As String = dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA")
                    Dim strTipoDocumento2 As String = dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")
                    Dim flagNC As Boolean = False


                    Dim keyTipoDocumentoCanjeOrDev As String = ConfigurationSettings.AppSettings("KeyTipoDocumentoCanjeOrDev")
                    Dim keyCodTipOperacionCanjeOrDev As String = ConfigurationSettings.AppSettings("KeyCodTipOperacionCanjeOrDev")


                    If NumeroTelefono = "0" And (strTipoVenta = ConfigurationSettings.AppSettings("strTVPrepago") Or strTipoVenta = ConfigurationSettings.AppSettings("strTVPostpago")) _
                    And (strTipoDocumento2 = ConfigurationSettings.AppSettings("strTipDoc") Or _
                    strTipoDocumento2 = ConfigurationSettings.AppSettings("ClaseNotaCanje") Or _
                    (keyTipoDocumentoCanjeOrDev.IndexOf(strTipoDocumento2.Trim()) <> -1 And keyCodTipOperacionCanjeOrDev.IndexOf(strCodTipOpe.Trim()) <> -1)) Then
                        flagNC = True
                    End If

                    If flagNC = False Then
                        If NumeroTelefono <> "" Then
                            If (NumeroTelefono.Trim.Substring(0, intLongNroOLO) = strInicioNroOLO) Then ' PROY 31850 MEJORAS
                                blnRecargaOlo = True
                            End If
                        End If
                    End If

                    If blnRecargaOlo = False Then

                        '/*----------------------------------------------------------------------------------------------------------------*/
                        '/*--JR  INICIO  -  PROY-29380 IDEA-38934 - Iteración 2 y 3 2da Fase Sinergia Adec en Sist de Venta y Post-Venta --*/
                        '/*----------------------------------------------------------------------------------------------------------------*/
                        If strCodTipOpe = "20" Or strCodTipOpe.ToUpper() = "DEVOLUCION" Or strDesTipOpe.ToUpper() = "DEVOLUCION" Then
                            flagDevolucion = True
                        Else
                            If ApprecargaVirtual Then        'se agrego esta variable session
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Ejecuta el mètodo : Recarga ")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- TipoOficina : " & pedic_tipoOficina)
                                Recarga(pedic_tipoOficina)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Fin del mètodo recarga.")
                            End If
                        End If
                        '/*----------------------------------------------------------------------------------------------------------------*/
                        '/*--JR  FIN  -  PROY-29380 IDEA-38934 - Iteración 2 y 3 2da Fase Sinergia Adec en Sist de Venta y Post-Venta --*/
                        '/*----------------------------------------------------------------------------------------------------------------*/
                    End If

                    'Dim strDesMnj As String
                    Dim strCodMensajeOlo As String
                    Dim strDescMensajeOlo As String = ""
                    Dim sDocumentoSapOLO As String
                    sDocumentoSapOLO = drPagos.Item("PEDIN_NROPEDIDO")
                    Dim keyOLO As New clsKeyOLO
                    ''-----------------------------
                    Dim strCodLog, strMsjLog As String
                    Dim strIdVenta As String
                    Dim strIdService As String
                    Dim _clsConsultaPvuBL As New COM_SIC_Activaciones.clsConsultaPvu
                    Dim dsDatosOLO As New DataSet
                    Dim strTipoOperacionOLO As String
                    Dim strTipoDocOlo As String
                    Dim strNroDocOlo As String
                    Dim objMensajeOlo As New COM_SIC_Activaciones.BWProcesaVentaActivacionOlo
                    Dim objCorreo As New COM_SIC_Activaciones.BWEnvioCorreo

                    If blnRecargaOlo = True Then

                        strCodMaterialOLO = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEC_CODMATERIAL"))
                        If (strCodMaterialOLO = keyOLO.strRecupera_Valor_CodMaterial.ToString()) Then 'HARCODE 

                            strIdPlanOLO = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEV_CODIGOLP"))
                            strIdService = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEV_DESCRIPCIONLP"))
                            strLineaRecargaOLO = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO"))
                            strTipoOperacionOLO = "R" 'Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION")) 'PEDIV_DESCTIPOOPERACION
                            strTipoDocumento = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("CLIEC_TIPODOCCLIENTE"))
                            strNumDocumento = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("CLIEV_NRODOCCLIENTE"))
                            '---------------------------------------------------------------    
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Ejecuta el mètodo : GetDatosVentasOLO() ")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Nùmero Linea : " & strLineaRecargaOLO)
                            dsDatosOLO = _clsConsultaPvuBL.GetDatosVentasOLO(strLineaRecargaOLO, strCodLog, strMsjLog) 'HARCODE 
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- FIN  mètodo : GetDatosVentasOLO() ")
                            Try 'INI 31850 MEJORAS
                                strIdVenta = Funciones.CheckStr(dsDatosOLO.Tables(0).Rows(0).Item("PO_VEPR_ID"))
                                strTipoDocOlo = Funciones.CheckStr(dsDatosOLO.Tables(0).Rows(0).Item("PO_VEPR_TIPO_DOC"))
                                strNroDocOlo = Funciones.CheckStr(dsDatosOLO.Tables(0).Rows(0).Item("PO_VEPR_NUM_DOC"))
                            Catch ex As Exception
                                objFileLog.Log_WriteLog(pathFile, strArchivo, "- Error ConsultaDatosOlo: " & ex.Message.ToString())
                            End Try 'FIN 31850 MEJORAS
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- GetDatosVentasOLO ID VENTA : GetDatosVentasOLO() " & strIdVenta)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- GetDatosVentasOLO TIPO DOC VENTA OLO : GetDatosVentasOLO() " & strTipoDocOlo)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- GetDatosVentasOLO NUM DOC VENTA OLO : GetDatosVentasOLO() " & strNroDocOlo)

                        End If

                        If (Funciones.CheckStr(AppNumeroDocumentoOLO) <> Nothing Or Funciones.CheckStr(AppNumeroDocumentoOLO) <> "") Then  'INC000002542709 
                            strNroDocOlo = Funciones.CheckStr(AppNumeroDocumentoOLO) 'PROY-31850 - INCIDENCIA RECARGA POR NUMERO DOCUMENTO
                        End If  'INC000002542709

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- strNroDocOlo" & strNroDocOlo)  'INC000002542709



                        '---------------------------------------------------------------  
                        ' Invocar  ProcesaVentaActivacionOloWS  | procesarVentaActivacion
                        Dim strIdTransaccionOLO As String = DateTime.Now.ToString("yyyyMMddHHmmss") + "_" + sDocumentoSapOLO
                        Dim strCodAplicacionoOLO As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("CodAplicacion"))
                        Dim strUserAplicacionOLO As String = Funciones.CheckStr(AppUsuario)

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio  WS ProcesarActivacionOLO ")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp sDocumentoSapOLO	  :" & sDocumentoSapOLO)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp strIdVenta	          :" & strIdVenta)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp strTipoDocumento        :" & strTipoDocOlo)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp strNumDocumento             :" & strNroDocOlo)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp strIdTransaccionOLO      :" & strIdTransaccionOLO)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp strCodAplicacionoOLO          :" & strCodAplicacionoOLO)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp strUserAplicacionOLO              :" & strUserAplicacionOLO)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp strUserAplicacionOLO           :" & strUserAplicacionOLO)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp strTipoOperacionOLO     :" & strTipoOperacionOLO)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp strIdPlanOLO            :" & strIdPlanOLO)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp strIdService               :" & strIdService)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Out strCodMensajeOlo     :" & strCodMensajeOlo)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Out strDescMensajeOlo            :" & strDescMensajeOlo)

                        'PROY-31850 JECC1118 INI
                        'objMensajeOlo.ProcesarActivacionOLO(sDocumentoSapOLO, strIdVenta, strTipoDocOlo, strNroDocOlo, _
                        'strIdTransaccionOLO, strCodAplicacionoOLO, strUserAplicacionOLO, _
                        'strUserAplicacionOLO, strTipoOperacionOLO, strIdPlanOLO, strIdService, strCodMensajeOlo, strDescMensajeOlo)

                        objMensajeOlo.ProcesarActivacionOLO(sDocumentoSapOLO, strIdVenta, strTipoDocOlo, strNroDocOlo, _
                                                                     sDocumentoSapOLO, strCodAplicacionoOLO, strUserAplicacionOLO, _
                                                                     strUserAplicacionOLO, strTipoOperacionOLO, strIdPlanOLO, strIdService, strCodMensajeOlo, strDescMensajeOlo)
                        'PROY-31850 JECC1118 FIN

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin  WS ProcesarActivacionOLO ")
                    End If
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "-----------------------------------------------------------------------------------------------------------------")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, " FIN RECARGAS OLO ")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "-----------------------------------------------------------------------------------------------------------------")
                    'PROY 31850 FASE IV FIN

                    Try
                        '*************************'
                        '**** BLOQUE DE PAGO *******:
                        '*************************'
                        Dim txtMonto As Double
                        Dim cboTipDocumento As String
                        Dim cboDescTipDocumento As String

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio RegistrarPago (SSAPSI_PAGO2)")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Nro_Documento	  :" & drPagos.Item("PEDIN_NROPEDIDO"))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Estado	  :" & System.Configuration.ConfigurationSettings.AppSettings("ESTADO_PAG"))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Nro_Asignar        :" & strNumSunat)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Moneda :" & System.Configuration.ConfigurationSettings.AppSettings("MONEDA"))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Oficina_Venta      :" & AppAlmacen)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Reasignar          :" & "")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Fecha              :" & DateTime.Now)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp strPagos           :" & strDetallePago)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Nro_Ref_Corner     :" & "")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Usuario            :" & AppUsuario)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Caja               :" & Trim(AppCodImprTicket))


                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio del registro de la Cabecera del pago")
                        objTrsMsSap.RegistrarPago(drPagos.Item("PEDIN_NROPEDIDO"), DBNull.Value, _
                                                     System.Configuration.ConfigurationSettings.AppSettings("ESTADO_PAG"), _
                                                     "CAJA PRUEBA", _
                                                     0, _
                                                      System.Configuration.ConfigurationSettings.AppSettings("MONEDA"), _
                                                      AppUsuario, _
                                                      DBNull.Value, _
                                                      AppUsuario, _
                                                      DBNull.Value, _
                                                      K_NROLOG, K_DESLOG, K_PAGON_IDPAGO, K_PAGOC_CORRELATIVO)


                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin del registro de la Cabecera del pago")
                        If K_DESLOG = "OK" Then
                            'Session.Add("msgErrorGenerarSot", "Registro de Pago Correctamente")
                            AppmsgErrorGenerarSot = "Registro de Pago Correctamente"
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Registro de forma correcta de la cabecera del pago :" & K_PAGON_IDPAGO)

                            '************************************************************************
                            If (dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA") <> ConfigurationSettings.AppSettings("strTipDoc") And Funciones.CheckDbl(dsPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO")) > 0) Then
                                '** se preocesan los otros tipos de documentos.
                                Dim dTotPagoNoCuota As Double = 0 ' PROY-30166 GPRD
                                For i = 1 To hidNumFilas
                                    'PROY-27440 INI
                                    'Dim objTxt As TextBox
                                    'objTxt = CType(Me.FindControl("txtMonto" & i), TextBox)
                                    'strMonto = "" : strMonto = Trim(objTxt.Text)

                                    strMonto = ApptxtMonto1

                                    'Dim objCbo As DropDownList
                                    'objCbo = CType(Me.FindControl("cboTipDocumento" & i), DropDownList)
                                    'strTipoDocPago = "" : strTipoDocPago = Trim(objCbo.SelectedValue)

                                    strTipoDocPago = AppCboTipoDocumento

                                    cboTipDocumento = strTipoDocPago
                                    txtMonto = Double.Parse(strMonto)
                                    'PROY-27440 FIN
                                    cboDescTipDocumento = DevuelteTipoDescPago(cboTipDocumento)
                                    'INI PROY 30166 
                                    If (HidNroCuotas > 0 And dblMontoCuotaInicial = 0) Then
                                        txtMonto = Funciones.CheckDbl(txtNeto)
                                    End If
                                    'JCC INI
                                    If (HidNroCuotas > 0 And dblMontoCuotaInicial > 0) Then
                                        strMonto = dblMontoCuotaInicial
                                        txtMonto = Double.Parse(strMonto)
                                    End If
                                    'JCC FIN'
                                    'FIN PROY 30166 
                                    cboDescTipDocumento = IIf(dblMontoCuotaInicial <= 0, cboDescTipDocumento, String.Format("{0}{1}", cboDescTipDocumento, "|")) 'PROY-30166 - IDEA  38934  INICIO

                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " K_PAGON_IDPAGO : " & K_PAGON_IDPAGO)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " cboTipDocumento : " & cboTipDocumento)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " cboDescTipDocumento : " & cboDescTipDocumento)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " txtMonto : " & txtMonto)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " Session(USUARIO) : " & AppUsuario)


                                    objTrsMsSap.RegistrarDetallePago(K_PAGON_IDPAGO, cboTipDocumento, _
                                                                        cboDescTipDocumento, _
                                                                        System.Configuration.ConfigurationSettings.AppSettings("MONEDA"), _
                                                                        txtMonto, _
                                                                        AppUsuario, _
                                                                        DBNull.Value, AppUsuario, _
                                                                        DBNull.Value, _
                                                                        IIf(arrayListaReferencia(i) = "", "", Funciones.CheckStr(arrayListaReferencia(i))), _
                                                                        arrayListaRefPedido(i), _
                                                                        K_NROLOG_DET, K_DESLOG_DET)

                                    'PROY-30166 - IDEA  38934  INICIO GPRD
                                    dTotPagoNoCuota = dTotPagoNoCuota + Double.Parse(strMonto)
                                    If (i = hidNumFilas AndAlso dblMontoCuotaInicial > 0) Then
                                        txtMonto = Double.Parse(hidTotalSinInicial) - dTotPagoNoCuota ' PROY-30166 GPRD
                                        cboDescTipDocumento = DevuelteTipoDescPago(cboTipDocumento)

                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Adic X Cuotas K_PAGON_IDPAGO : " & K_PAGON_IDPAGO)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Adic X Cuotas cboTipDocumento : " & cboTipDocumento)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Adic X Cuotas cboDescTipDocumento : " & cboDescTipDocumento)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Adic X Cuotas txtMonto : " & txtMonto)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Adic X Cuotas Session(USUARIO) : " & AppUsuario)


                                        objTrsMsSap.RegistrarDetallePago(K_PAGON_IDPAGO, cboTipDocumento, _
                                                                            cboDescTipDocumento, _
                                                                            System.Configuration.ConfigurationSettings.AppSettings("MONEDA"), _
                                                                            txtMonto, _
                                                                            AppUsuario, _
                                                                            DBNull.Value, AppUsuario, _
                                                                            DBNull.Value, _
                                                                            IIf(arrayListaReferencia(i) = "", "", Funciones.CheckStr(arrayListaReferencia(i))), _
                                                                            arrayListaRefPedido(i), _
                                                                            K_NROLOG_DET, K_DESLOG_DET)
                                    End If
                                    'PROY-30166 - IDEA  38934  FIN
                                Next
                            Else
                                '** Registro del detalle de pago de la Nota de Crèdito/ TG  **
                                cboDescTipDocumento = DevuelteTipoDescPago(AppCboTipoDocumento)
                                objTrsMsSap.RegistrarDetallePago(K_PAGON_IDPAGO, AppCboTipoDocumento, _
                                                                  cboDescTipDocumento, _
                                                                 System.Configuration.ConfigurationSettings.AppSettings("MONEDA"), _
                                                                 Funciones.CheckDbl(ApptxtMonto1), _
                                                                 AppUsuario, _
                                                                 DBNull.Value, AppUsuario, _
                                                                 DBNull.Value, _
                                                                 "", 0, _
                                                                 K_NROLOG_DET, K_DESLOG_DET)
                            End If

                            '************************************************************************

                            Dim FE_NRO_ERROR As Int16 = 0
                            Dim FE_DES_ERROR As String = ""
                            Dim K_PAGOV_RECUP_CORRELATIVO As String = ""
                            Dim flag_paperless As String = ""
                            Dim correlativo_recu As String = ""
                            Dim K_CORRC_TIPODOC_REFERENCIA As String = ""
                            Dim Origen As String = "3" 'Valor para validar que sea SICAR 6.0


                            If K_DESLOG_DET = "OK" Then
                                'INC000000961273 - INI
                                Dim arrayLineas As String
                                Dim blnOk As Boolean = False
                                'INC000000961273 - FIN
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Registro de forma correcta del detalle del pago :" & K_DESLOG_DET & " - " & K_PAGON_IDPAGO)
                                Try

                                    '=================================================================================================================================================================================================================='
                                    'CORRELATIVO Y ACTUALIZACIÒN DEL PAGO PEDIDO'
                                    '=================================================================================================================================================================================================================='

                                    K_NROLOG = ""
                                    K_DESLOG = ""

                                    '***************************Inicio Validacion de que no consulte correlativo para Renta Adelantada************************************
                                    If Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")) <> ConfigurationSettings.AppSettings("TIPO_RENTA_ADELANTADA") Then
                                        '**Proceso de Obtener Correlativo y Envio a Paperless y actualizar en Sicar_trs_pagos.

                                        '**Verificar si el pedido tiene correlativo generado:**
                                        '*Ini:
                                        '**DESARROLLO
                                        Dim dsConsultaDoc As DataSet
                                        Dim arrValor As String()

                                        'Dim strCuentaRedCajero As String

                                        dsConsultaDoc = objCajas.ConsultaDocPagos(drPagos.Item("PEDIN_NROPEDIDO"), Origen)
                                        If dsConsultaDoc.Tables.Count > 0 AndAlso dsConsultaDoc.Tables(0).Rows.Count > 0 Then
                                            flag_paperless = Funciones.CheckStr(dsConsultaDoc.Tables(0).Rows(0).Item("FLAG_PAPERLESS"))
                                            correlativo_recu = Funciones.CheckStr(dsConsultaDoc.Tables(0).Rows(0).Item("REFERENCIA"))

                                            If Not correlativo_recu.Equals("") Then
                                                arrValor = correlativo_recu.Trim.ToString.Split("|")
                                                If arrValor(1).ToString <> "" Then
                                                    K_PAGOV_RECUP_CORRELATIVO = arrValor(1)
                                                End If
                                            Else
                                                K_PAGOV_RECUP_CORRELATIVO = ""
                                            End If

                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Reutilizar el Correlativo ")
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "flag_paperless : " & flag_paperless)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "correlativo_recu : " & correlativo_recu)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "K_PAGOV_RECUP_CORRELATIVO : " & K_PAGOV_RECUP_CORRELATIVO)
                                        End If

                                        '*Fin:
                                        '*******************************************************

                                        If K_PAGOV_RECUP_CORRELATIVO <> "" Then
                                            K_CU_CORRELATIVOFE = K_PAGOV_RECUP_CORRELATIVO
                                        Else
                                            '++ IDG: ++++++++++++++++++++++++++++++++++!
                                            '** consulta del correlativo ***'
                                            'objTrsMsSap.CalculoCorrelativoSUNAT(dsPedido.Tables(0).Rows(0).Item("OFICV_CODOFICINA"), Microsoft.VisualBasic.Right(Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")).ToString, 2), Funciones.CheckInt64(drPagos.Item("PEDIN_NROPEDIDO")), K_PAGOV_CORRELATIVO)
                                            'Dim K_CORRC_TIPODOC_REFERENCIA As String = ""
                                            'Dim consultaDato As DataSet
                                            If Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")) = ConfigurationSettings.AppSettings("strTipDoc") Then
                                                If Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("CLIEC_TIPODOCCLIENTE")).Trim = ConfigurationSettings.AppSettings("tipo_Docu_RUC") Then
                                                    K_CORRC_TIPODOC_REFERENCIA = "01"
                                                Else
                                                    K_CORRC_TIPODOC_REFERENCIA = "03"
                                                End If
                                                'K_CORRC_TIPODOC_REFERENCIA = Microsoft.VisualBasic.Right(Funciones.CheckStr(consultaDato.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")), 2)
                                            End If

                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Mètodo => CalculoCorrelativoSUNAT")
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Cod_Oficina : " & Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("OFICV_CODOFICINA")))
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo_Documento : " & Microsoft.VisualBasic.Right(Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")).ToString, 2))
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo_Documento_Origen : " & K_CORRC_TIPODOC_REFERENCIA)

                                            objTrsMsSap.CalculoCorrelativoFE(dsPedido.Tables(0).Rows(0).Item("OFICV_CODOFICINA"), _
                                                                                Microsoft.VisualBasic.Right(Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")).ToString, 2), _
                                                                                K_CORRC_TIPODOC_REFERENCIA, FE_NRO_ERROR, FE_DES_ERROR, K_CU_CORRELATIVOFE)

                                            'INI PROY-140126
                                            Dim MaptPath As String
                                            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                                            MaptPath = "( Class : " & MaptPath & "; Function: guardarConectado)"
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out FE_NRO_ERROR  : " & FE_NRO_ERROR & MaptPath)
                                            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                                            MaptPath = "( Class : " & MaptPath & "; Function: guardarConectado)"
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out FE_DES_ERROR  : " & FE_DES_ERROR & MaptPath)
                                            'FIN PROY-140126

                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out K_CU_CORRELATIVOFE  : " & K_CU_CORRELATIVOFE)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Mètodo => CalculoCorrelativoSUNAT")
                                            '++ FDG ++++++++++++++++++++++++++++++++++++++!
                                        End If
                                    End If
                                    '***************************Fin Validacion de que no consulte correlativo para Renta Adelantada************************************

                                    If K_CU_CORRELATIVOFE <> "" Then
                                        Var_Corr1 = Obtener_serie_correlativo(K_CU_CORRELATIVOFE, "1", Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")))
                                        Var_Corr2 = Obtener_serie_correlativo(K_CU_CORRELATIVOFE, "2", Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")))
                                        Var_Corr3 = ""
                                        Var_Corr4 = Obtener_serie_correlativo(K_CU_CORRELATIVOFE, "4", Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")))
                                        Var_Corr5 = ""
                                        Var_Corr6 = Obtener_serie_correlativo(K_CU_CORRELATIVOFE, "6", Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")))

                                        If Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")) = ConfigurationSettings.AppSettings("PEDIC_CLASEFACTURA") Then
                                            P_tipo_doc_pago = ConfigurationSettings.AppSettings("PEDIC_DESCCLASEFACTURA")
                                        End If
                                        If Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")) = ConfigurationSettings.AppSettings("PEDIC_CLASEBOLETA") Then
                                            P_tipo_doc_pago = ConfigurationSettings.AppSettings("PEDIC_DESCCLASEBOLETA")
                                        End If
                                        '***************************Inicio Validacion de que no consulte correlativo para Renta Adelantada************************************
                                        If Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")) <> ConfigurationSettings.AppSettings("TIPO_RENTA_ADELANTADA") Then
                                            If K_PAGOV_RECUP_CORRELATIVO = "" Then
                                                '***Grabar el correlativo el correlativo Nuevo en SICAR_TRS_PAGOS**
                                                'Dim Origen As String = "3" 'Valor para validar que sea SICAR 6.0
                                                Dim corrCompleto As String = ""
                                                Dim updCorrCompleto As String = ""

                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Registro de datos del pago de la Boleta o Factura (SP_SET_CORRELATIVO_BF)")
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Numero de DocSap            :" & drPagos.Item("PEDIN_NROPEDIDO"))
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Tipo de Documento           :" & Microsoft.VisualBasic.Right(Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")), 2))
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Serie Sunat                 :" & Var_Corr1)
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Correlativo Sunat           :" & Var_Corr2)
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Código de Usuario           :" & CurrentUser.ToString)
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Origen                      :" & Origen)
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Punto de Venta              :" & AppAlmacen)

                                                Dim resultado As String = objTrsMsSap.FP_Grabar_PagoBF(drPagos.Item("PEDIN_NROPEDIDO"), _
                                                                                        Microsoft.VisualBasic.Right(Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")), 2), _
                                                                                    Var_Corr1, _
                                                                                    Var_Corr2, _
                                                                                        CurrentUser.ToString, _
                                                                                        Origen, _
                                                                                        AppAlmacen)
                                                If resultado = "" Then
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     Out Resultado           :" & "No se ha Grabado los Datos del Pago.")
                                                Else
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     Out Resultado         :" & "Registro de Datos del pago Exitoso.")
                                                    If (Microsoft.VisualBasic.Right(Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")), 2) = "01" Or Microsoft.VisualBasic.Right(Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")), 2) = "03") Then
                                                        corrCompleto = "00" & "|" & K_CU_CORRELATIVOFE
                                                    Else
                                                        corrCompleto = K_CORRC_TIPODOC_REFERENCIA & "|" & K_CU_CORRELATIVOFE
                                                    End If
                                                    updCorrCompleto = objCajas.SP_UPD_FLAG_PAPER(drPagos.Item("PEDIN_NROPEDIDO"), "V", corrCompleto)
                                                End If
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin del Registro de datos de la Boleta o Factura.")
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "*****************************************************************")
                                                '***********************************************'
                                            End If
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Correlativo Utilizado :" & K_CU_CORRELATIVOFE)
                                        End If
                                        '***************************Fin Validacion de que no consulte correlativo para Renta Adelantada************************************
                                        K_NROLOG = ""
                                        K_DESLOG = ""

                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inicia actualizar pago: ActualizarPagodelPedido")
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "SP: " & "PKG_MSSAP.SSAPSU_UPDATEPAGO")
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ID de Pedido : " & Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ID de Pago : " & Funciones.CheckStr(K_PAGON_IDPAGO))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "CORRELATIVO : " & Funciones.CheckStr(K_CU_CORRELATIVOFE))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "PEDIC_CLASEFACTURA :" & Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "CODIGO DE OFICINA : " & Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("OFICV_CODOFICINA")))

                                        'PEDIC_CLASEFACTURA
                                        objTrsMsSap.ActualizarPagodelPedido(drPagos.Item("PEDIN_NROPEDIDO"), _
                                                                                            K_PAGON_IDPAGO, _
                                                                                            K_CU_CORRELATIVOFE, _
                                                                                            dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA"), _
                                                                                            dsPedido.Tables(0).Rows(0).Item("OFICV_CODOFICINA"), _
                                                                                            K_NROLOG, K_DESLOG)

                                        If (K_DESLOG = "OK") Then
                                            hidDESLOG = K_DESLOG
                                            AppActualizarMSSAP = "0"
                                        Else
                                            AppActualizarMSSAP = "1"
                                            hidDESLOG = ""
                                        End If
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " OUT K_DESLOG :" & K_DESLOG)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " OUT K_NROLOG :" & K_NROLOG)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Fin actualizar pago: ActualizarPagodelPedido")
                                    Else
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  ERROR EN EL Correlativo :" & K_CU_CORRELATIVOFE)
                                        '** RollBack a los Pagos ************************'

                                        objActiv.AsignarPagoAcuerdosXDocSap(drPagos.Item("PEDIN_NROPEDIDO"), "", 0, CurrentUser, msgj)
                                        DeshacerCambiosPagos(K_PAGON_IDPAGO)
                                        If AppCodigoDeshacerCambios = "-3" Then
                                            AppCodigoExitFunction = "-2"
                                            AppMensajeExitFunction = AppMensajeDeshacerCambios
                                            Exit Function
                                        End If
                                        'Response.Write("<script>alert('No tiene configurado correlativo para el punto de venta : ' & '" & dsPedido.Tables(0).Rows(0).Item("OFICV_CODOFICINA") & "')</script>")
                                        AppErrorDeshacerCambios = "No tiene configurado correlativo para el punto de venta : ' & '" & dsPedido.Tables(0).Rows(0).Item("OFICV_CODOFICINA") & ""
                                        Exit Function
                                        '*************************************************'
                                    End If

                                    ' INICIO|PROY-30162-IDEA-32487 ENVIO BOLETA ELECTRONICA PREPAGO //RGP_BOL_18
                                    ' Envio de SMS
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, "sTipoVenta: " & sTipoVenta)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, "strTVPrepago: " & ConfigurationSettings.AppSettings("strTVPrepago"))
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, "sTipoOperacion: " & sTipoOperacion)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, "COD_OPERACION_ALTAyPORTABILIDAD: " & ConfigurationSettings.AppSettings("COD_OPERACION_ALTAyPORTABILIDAD"))
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, "sTipoVenta: " & sTipoVenta)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, "strTVPostpago: " & ConfigurationSettings.AppSettings("strTVPostpago"))
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, "SmsWS_horas_prepago: " & ConfigurationSettings.AppSettings("SmsWS_horas_prepago"))
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, "SmsWS_horas_postpago: " & ConfigurationSettings.AppSettings("SmsWS_horas_postpago"))
                                    Dim fechaEnvio As DateTime = DateTime.Now ' PROY-30162-IDEA-32487
                                    Try
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " VerificaciÃ³n de Envio de SMS")

                                        Dim procesarSMS As Boolean = False
                                        Dim horasAdicionar As Int32 = 0

                                        If sTipoVenta = ConfigurationSettings.AppSettings("strTVPrepago") Then
                                            procesarSMS = True
                                            horasAdicionar = CInt(ConfigurationSettings.AppSettings("SmsWS_horas_prepago"))

                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Pre-Pago " & CStr(horasAdicionar))
                                        ElseIf sTipoVenta = ConfigurationSettings.AppSettings("strTVPostpago") Then
                                            procesarSMS = True
                                            horasAdicionar = CInt(ConfigurationSettings.AppSettings("SmsWS_horas_postpago"))

                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Post-Pago " & CStr(horasAdicionar))
                                        End If

                                        If procesarSMS = True Then
                                            Dim smsMensaje As String = "Estimado usuario, se genera comprobante """ + K_CU_CORRELATIVOFE + """ que puede visualizar en http://www.claro.com.pe/comprobantes-electronicos/" 'URL en SMS modificada a solicitud de Claro.
                                            Dim usuarioAplicacion = CStr(AppUsuario)
                                            fechaEnvio = fechaEnvio.AddHours(horasAdicionar)

                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inicio Envio SMS ")
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Envio Parametros - Metodo EnviarSMS()")
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Usuario Aplicacion - " & usuarioAplicacion)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Numero Telefono - " & CStr(hidNumeroTelefono))
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Mensaje SMS - " & smsMensaje)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Fecha Envio - " & fechaEnvio)
                                            Dim smsENVIADO = EnviarSMS(usuarioAplicacion, CStr(hidNumeroTelefono), smsMensaje, fechaEnvio)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Resultado Exitoso ")
                                        End If
                                    Catch ex As Exception
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Error de Envio de SMS " & ex.Message)
                                    End Try
                                    ' FIN|PROY-30162-IDEA-32487 ENVIO BOLETA ELECTRONICA PREPAGO //RGP_BOL_18

                                    'PROY-31867 INI
                                    '********************************CAMBIO DE MIGRACION ENVIO EMAIL ***************************'

                                    Dim dsAcuerdoMigra As DataSet

                                    Dim strContratoMigra As String
                                    Dim sisact_Cod_OperacionMigra As String


                                    Try
                                        strContratoMigra = objContrato.Tables(0).Rows(0).Item("ID_CONTRATO") 'drPagos.Item("NRO_CONTRATO")
                                    Catch ex As Exception
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "objContrato.Tables(0).Rows(0).Item(ID_CONTRATO)" & ex.Message)
                                    End Try

                                    Try

                                        dsAcuerdoMigra = objClsConsultaPvu.ConsultaAcuerdoPCS(Funciones.CheckInt64(strContratoMigra), DBNull.Value)    'Consulta PVU
                                        If Not dsAcuerdoMigra Is Nothing Then

                                            sisact_Cod_OperacionMigra = Funciones.CheckStr(dsAcuerdoMigra.Tables(0).Rows(0).Item("contc_tipo_operacion"))

                                        End If
                                    Catch ex As Exception
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error al tratar de recuperar el contrato" & ex.Message)

                                    End Try


                                    ''if EsMigracion == true && EsVentaSinEquipo == true then
                                    If sisact_Cod_OperacionMigra = ConfigurationSettings.AppSettings("strDTVMigracion") And Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("MATEC_TIPOMATERIAL")) = ConfigurationSettings.AppSettings("constPacks") Then


                                        'Consulta Email Cliente
                                        Dim objConsultaPvuMigra As New clsConsultaPvu
                                        Dim dsClienteDatosMigra As New DataSet
                                        Dim strCodRptaMigra, strMsjRptaMigra As String
                                        Dim strEmailMigra As String
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--INICIO Consulta Cliente Email --")
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo Documento : " & Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("CLIEC_TIPODOCCLIENTE")))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Numero Documento : " & Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("CLIEV_NRODOCCLIENTE")))

                                        dsClienteDatosMigra = objConsultaPvuMigra.ConsultaCorreoCliente(Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("CLIEC_TIPODOCCLIENTE")), Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("CLIEV_NRODOCCLIENTE")), strCodRptaMigra, strMsjRptaMigra)
                                        If Not dsClienteDatosMigra Is Nothing Then
                                            If dsClienteDatosMigra.Tables(0).Rows.Count > 0 Then
                                                strEmailMigra = Funciones.CheckStr(dsClienteDatosMigra.Tables(0).Rows(0).Item("CLIEV_CORREO_FACT"))
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Email  : " & strEmailMigra)
                                            End If
                                        End If
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Codigo Respuesta : " & strCodRptaMigra)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje Respuesta : " & strMsjRptaMigra)

                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--FIN Consulta Cliente Email --")



                                        Dim objResponseDoc As New COM_SIC_Activaciones.BEResponseDocumentosGenerados
                                        Dim objTransaccionDocumentosMigra As New COM_SIC_Activaciones.BWDocumentosGenerados
                                        Dim BeDocumentosMigra As New COM_SIC_Activaciones.BEDocumentosGenerados
                                        Dim itemHeaderDataPower As New COM_SIC_Activaciones.BEHeaderDataPower


                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " EjecutarTranssaccionGeneracionDocumento Migra - Inicio WS")
                                        itemHeaderDataPower.consumer = ""
                                        itemHeaderDataPower.country = ""
                                        itemHeaderDataPower.dispositivo = ""
                                        itemHeaderDataPower.language = ""
                                        itemHeaderDataPower.modulo = ""
                                        itemHeaderDataPower.msgType = ""
                                        itemHeaderDataPower.operation = ""
                                        itemHeaderDataPower.pid = ""
                                        itemHeaderDataPower.userId = ""
                                        itemHeaderDataPower.wsIp = ConfigurationSettings.AppSettings("consIpTranssaccionGeneracionDocumento")

                                        Dim strUsuario As String = ""
                                        Dim strPassword As String = ""

                                        'INC000001492087: INI
                                        Try
                                            Dim strIDTrans_ As String = String.Empty
                                            Dim strIpAplicacion_ As String = String.Empty
                                            Dim strAplicacion_ As String = String.Empty
                                            strIDTrans_ = Now.Year & Now.Month & Now.Day & Now.Hour & Now.Minute & Now.Second
                                            strAplicacion_ = ConfigurationSettings.AppSettings("constAplicacion")
                                            strIpAplicacion_ = AppLOCAL_ADDR
                                            Dim sAuditoriastring_ As New AuditoriaEWS
                                            sAuditoriastring_.IDTRANSACCION = strIDTrans_
                                            sAuditoriastring_.IPAPLICACION = strIpAplicacion_
                                            sAuditoriastring_.APLICACION = strAplicacion_
                                            sAuditoriastring_.USRAPP = CurrentUser

                                            Dim objClave As ConsultaClavesNegocio = New ConsultaClavesNegocio
                                            Dim mensajeError As String = ""

                                            Dim codAplicacionClave As String = ConfigurationSettings.AppSettings("strAplicacionSISACT")
                                            Dim usuarioEncrypt As String = ConfigurationSettings.AppSettings("consUserDataPowerDocumentos")
                                            Dim claveEncrypt As String = ConfigurationSettings.AppSettings("consPASWDataPowerDocumentos")
                                            Dim usuarioDesencrypt As String = String.Empty
                                            Dim claveDesencrypt As String = String.Empty

                                            objClave.ejecutarConsultaClave(sAuditoriastring_, codAplicacionClave, usuarioEncrypt, claveEncrypt, usuarioDesencrypt, claveDesencrypt, mensajeError)

                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ejecutarConsultaClave Mensaje ws :" & mensajeError)

                                            strUsuario = usuarioDesencrypt
                                            strPassword = claveDesencrypt

                                        Catch ex As Exception
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ejecutarConsultaClave Exception :" & ex.Message)
                                        End Try
                                        'INC000001492087: FIN

                                        Dim ipAplicacion As String = CurrentTerminal

                                        BeDocumentosMigra.idTransaccion = DateTime.Now.ToString("yyyyMMddHHmmssfff")
                                        BeDocumentosMigra.ipAplicacion = "SICAR"
                                        BeDocumentosMigra.nombreAplicacion = "SICAR"
                                        BeDocumentosMigra.idVenta = ""
                                        BeDocumentosMigra.nroContrato = Funciones.CheckStr(objContrato.Tables(0).Rows(0).Item("ID_CONTRATO"))
                                        BeDocumentosMigra.nroDocumento = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("CLIEV_NRODOCCLIENTE"))
                                        BeDocumentosMigra.nroPedido = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIN_NROPEDIDO"))
                                        BeDocumentosMigra.tipoDocumento = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("CLIEC_TIPODOCCLIENTE"))
                                        BeDocumentosMigra.tipoOperacion = "02"
                                        BeDocumentosMigra.usuarioAplicacion = CurrentUser.ToString
                                        BeDocumentosMigra.correo = ""

                                        objFileLog.Log_WriteLog(pathFile, strArchivo, BeDocumentosMigra.idTransaccion & "- " & BeDocumentosMigra.idTransaccion)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, BeDocumentosMigra.idTransaccion & "- nroContrato : " & BeDocumentosMigra.nroContrato)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, BeDocumentosMigra.idTransaccion & "- nroDocumento : " & BeDocumentosMigra.nroDocumento)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, BeDocumentosMigra.idTransaccion & "- nroPedido : " & BeDocumentosMigra.nroPedido)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, BeDocumentosMigra.idTransaccion & "- tipoDocumento : " & BeDocumentosMigra.tipoDocumento)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, BeDocumentosMigra.idTransaccion & "- tipoOperacion : " & BeDocumentosMigra.tipoOperacion)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, BeDocumentosMigra.idTransaccion & "- usuarioAplicacion : " & BeDocumentosMigra.usuarioAplicacion)

                                        objResponseDoc = objTransaccionDocumentosMigra.EjecutarTranssaccionGeneracionDocumento("CAC", CurrentUser, BeDocumentosMigra, itemHeaderDataPower, strUsuario, strPassword, "SICAR")



                                        Dim k_estado As String = objResponseDoc.K_estado
                                        Dim k_codigo_respuesta As String = objResponseDoc.k_codigo_respuesta
                                        Dim k_descripcion As String = objResponseDoc.k_descripcion
                                        Dim k_ubicacionError As String = objResponseDoc.k_ubicacionError
                                        Dim k_fecha As String = objResponseDoc.k_fecha
                                        Dim k_origen As String = objResponseDoc.k_origen

                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", strIdentifyLog, "k_estado", Funciones.CheckStr(k_estado)))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", strIdentifyLog, "k_codigo_respuesta", Funciones.CheckStr(k_codigo_respuesta)))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", strIdentifyLog, "k_descripcion", Funciones.CheckStr(k_descripcion)))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", strIdentifyLog, "k_ubicacionError", Funciones.CheckStr(k_ubicacionError)))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", strIdentifyLog, "k_fecha", Funciones.CheckStr(k_fecha)))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", strIdentifyLog, "k_origen", Funciones.CheckStr(k_origen)))


                                        If objResponseDoc.k_codigo_respuesta <> "0" Then

                                        End If

                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " EjecutarTranssaccionGeneracionDocumento Migra - FIN WS")

                                    End If


                                    '********************************CAMBIO DE MIGRACION ENVIO EMAIL ***************************'
                                    'PROY-31867 FIN

                                    'PROY-24274 - IIteracion 3 - INICIO
                                    Dim strCodRptaAjuste As String = String.Empty
                                    Dim strMsjRptaAjuste As String = String.Empty
                                    Dim strRptaAjuste As String = String.Empty
                                    Dim strPedidoEquipo As String = String.Empty
                                    Dim strCodRpt As String = String.Empty
                                    Dim strMsjRpt As String = String.Empty
                                    Dim objProteccionMovilAjuste As New COM_SIC_Activaciones.clsProteccionMovil
                                    Dim objAjustePedidoAsurionWS As New COM_SIC_Activaciones.BWAjustePedidoProteccionMovil
                                    Dim strIdTransaccion As String = String.Empty
                                    Dim strIPAplicacion As String = String.Empty
                                    Dim strNombaplicacion As String = String.Empty
                                    Dim strUsrProceso As String = String.Empty
                                    Dim strCodMat As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEC_CODMATERIAL")) 'PROY-24724 - Iteracion 2 Siniestros

                                    strIdTransaccion = DateTime.Now.ToString("yyyyMMddHHmmssfff")
                                    strIPAplicacion = CurrentTerminal
                                    strNombaplicacion = ConfigurationSettings.AppSettings("constAplicacion")
                                    strUsrProceso = CurrentUser
                                    Try

                                        'PROY-24724 - Iteracion 2 Siniestros -INI
                                        If (strCodMat.Equals(clsKeyAPP.strCodMaterialSiniestro)) Then
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " INICIO Ajuste de Pedido Siniestro")
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " WS: " & ConfigurationSettings.AppSettings("consAjusteProteccionMovilWS_URL"))
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Método WS: ajustarPedido ")
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " SP: " & "PKG_VENTA.SSAPSU_CALC_IGV")
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " ID de Pedido : " & Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")))
                                            objAjustePedidoAsurionWS.AjustarPedido(Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")), strIdTransaccion, strIPAplicacion, strNombaplicacion, strUsrProceso, strCodRptaAjuste, strMsjRptaAjuste)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " OUT K_COD_RESULTADO :" & strCodRptaAjuste)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " OUT K_MSJ_RESULTADO :" & strMsjRptaAjuste)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " FIN Ajuste de Pedido Siniestro")
                                        End If
                                        'PROY-24724 - Iteracion 2 Siniestros -FIN
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " Inicio - Validar Equipo Protección Móvil")
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " Validar Equipo Protección Móvil. Parámetros de entrada:")
                                        'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " NroPedido:" & Trim(Request.QueryString("codRefer")))
                                        objProteccionMovilAjuste.ValidaPagoEquipoProteccionMovil(Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")), strPedidoEquipo, strCodRpt, strMsjRpt)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " Validar Equipo Protección Móvil. Parámetros de salida:")
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " strNroPedidoEquipo:" & strPedidoEquipo)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " strCodRpta:" & strCodRpt)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " strMsgRpta:" & strMsjRpt)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " Fin - Validar Equipo Protección Móvil")
                                        If (strCodRpt.Equals("0") Or strCodRpt.Equals("-1")) AndAlso Not Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")).Equals("") Then
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inicia Ajuste Pedido Protección Móvil: AjustePedidoProteccionMovil")
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " WS: " & ConfigurationSettings.AppSettings("consAjusteProteccionMovilWS_URL"))
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Método WS: ajustarPedido ")
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " SP: " & "PKG_VENTA.SSAPSU_CALC_IGV")
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " ID de Pedido : " & Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")))
                                            objAjustePedidoAsurionWS.AjustarPedido(Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")), strIdTransaccion, strIPAplicacion, strNombaplicacion, strUsrProceso, strCodRptaAjuste, strMsjRptaAjuste)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " OUT K_COD_RESULTADO :" & strCodRptaAjuste)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " OUT K_MSJ_RESULTADO :" & strMsjRptaAjuste)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Fin Ajuste Pedido Protección Móvil: AjustePedidoProteccionMovil")
                                        End If

                                    Catch ex As Exception
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  -- Error Ejecución Ajuste Proteccion Movil")
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  -- Error :" & ex.Message.ToString())
                                    End Try
                                    'PROY-24724 - IIteracion 3 - FIN

                                    'INC000000961273 - INICIO
                                    Dim flagActivaSimcard As String = ConfigurationSettings.AppSettings("constActivaSimcardsWS")
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " flagActivaSimcard: " & flagActivaSimcard)
                                    If flagActivaSimcard.Equals("0") Then
                                        If K_DESLOG = "OK" Then
                                            Dim descOpePortaPost As String = ConfigurationSettings.AppSettings("DESCTIPOOPERACION_PORTA_POST")
                                            Dim descOpePortaPre As String = ConfigurationSettings.AppSettings("DESCTIPOOPERACION_PORTA_PRE")
                                            If dsPedido.Tables(0).Rows(0).Item("PEDIV_DESCTIPOOPERACION") = descOpePortaPost Then
                                                Dim codigoRed As String
                                                Dim tipoNumero As String = ConfigurationSettings.AppSettings("portaSap_tipoNumero")
                                                Dim mensajeCrear As String
                                                Dim strOpCedenteCod As String
                                                Dim auxLinea As String = ""

                                                If sTipoVenta = ConfigurationSettings.AppSettings("strTVPrepago") Then
                                                    codigoRed = ConfigurationSettings.AppSettings("codOperadorRedPre")
                                                    strNroSEC = C_VENTA.Rows(0).Item("VEPR_SEC_PORT")
                                                Else
                                                    codigoRed = ConfigurationSettings.AppSettings("codOperadorRedPost")
                                                    If Not objContrato Is Nothing Then
                                                        strContrato = objContrato.Tables(0).Rows(0).Item("ID_CONTRATO")
                                                        If Funciones.CheckInt(strContrato) > 0 Then
                                                            dsAcuerdo = objClsConsultaPvu.ConsultaAcuerdoPCS(strContrato, DBNull.Value)
                                                        End If
                                                    End If

                                                    strNroSEC = Funciones.CheckStr(dsAcuerdo.Tables(0).Rows(0).Item("contn_numero_sec"))
                                                End If

                                                strOpCedenteCod = ObtenerOpeCedente(strNroSEC).Rows(0).Item("SOPOC_CODIGO_CEDENTE")

                                                For i = 0 To dsPedido.Tables(1).Rows.Count - 1
                                                    Dim serieIccid As String = dsPedido.Tables(1).Rows(i).Item("SERIC_CODSERIE")
                                                    Dim codMaterial As String = dsPedido.Tables(1).Rows(i).Item("DEPEC_CODMATERIAL")
                                                    Dim nroTelefono As String = dsPedido.Tables(1).Rows(i).Item("DEPEV_NROTELEFONO")
                                                    Dim hr As String = serieIccid.Substring(6, 2)
                                                    Dim region As String = ObtenerRegion(hr)

                                                    If dsPedido.Tables(1).Rows(i).Item("MATEC_TIPOMATERIAL") = ConfigurationSettings.AppSettings("constChips") Then
                                                        If Not CrearNumeroPortabilidad(codigoRed, strOpCedenteCod, nroTelefono, region, serieIccid, _
                                                                                                tipoNumero, mensajeCrear, codMaterial) Then
                                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  # Resultado: ERROR")
                                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  # Mensaje: " & mensajeCrear)
                                                            blnOk = False
                                                        Else
                                                            arrayLineas = arrayLineas + nroTelefono + ";"
                                                            blnOk = True
                                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  # Resultado: OK")
                                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  # Mensaje: " & mensajeCrear)
                                                        End If

                                                        If Not blnOk Then
                                                            BorrarNumerosPortabilidad(strIdentifyLog, arrayLineas)
                                                            Throw New Exception(mensajeCrear)
                                                        End If
                                                    End If

                                                Next
                                            End If
                                        End If
                                    End If
                                    'INC000000961273 - FIN



                                    If K_DESLOG = "OK" Then
                                        blnPagoRealizado = True

                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  SE ACTUALIZORN LOS PAGOS :" & K_PAGON_IDPAGO)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  K_DESLOG :" & K_DESLOG)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  K_NROLOG :" & K_NROLOG)
                                        ActualizarWL()
                                        '***********************************Inicio de Metodo para Envio a Paperless*****************************************
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inicio Factura Electronica ")
                                        '·····························································································

                                        If flag_paperless = "" Then
                                            Paperless(K_CU_CORRELATIVOFE, drPagos.Item("PEDIN_NROPEDIDO"), K_PAGON_IDPAGO, Origen)
                                        End If
                                        '·····························································································
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Fin Factura Electronica ")
                                        '**

                                        If Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")) <> ConfigurationSettings.AppSettings("TIPO_RENTA_ADELANTADA") Then
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inicio Actualizar metodo AsignarPagoAcuerdosXDocSap")
                                            objActiv.AsignarPagoAcuerdosXDocSap(strDocSap, Var_Corr6, CheckDbl(txtNeto.ToString()), CurrentUser, msgj)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Fin Actualizar metodo AsignarPagoAcuerdosXDocSap")
                                            'continuara
                                            If dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVPrepago") Then

                                                Try
                                                    If Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION")) = ConfigurationSettings.AppSettings("COD_OPERACION_RENOVACION") Or Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION")) = ConfigurationSettings.AppSettings("COD_OPERACION_REPOSICION") Then

                                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inicio Actualizar metodo Actualizar_Prepago_RenoYRepo")
                                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inp P_documento :" & Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIN_NROPEDIDO")))
                                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inp P_tipo_doc_pago :" & P_tipo_doc_pago)
                                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inp P_numero_referencia :" & Var_Corr6)
                                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inp P_numero_ticket : - ")

                                                        objPvu.Actualizar_Prepago_RenoYRepo(Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIN_NROPEDIDO")), _
                                                                                            P_tipo_doc_pago, _
                                                                                        Var_Corr6, _
                                                                                            "", _
                                                                                            RptaPrepago)

                                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Out P_Valor_retorno :" & Funciones.CheckStr(RptaPrepago))
                                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Fin Actualizar metodo Actualizar_Prepago_RenoYRepo")
                                                    End If

                                                    If Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION")) = ConfigurationSettings.AppSettings("COD_OPERACION_ALTAyPORTABILIDAD") Then

                                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inicio Actualizar metodo Actualizar_Prepago_AltaYPorta")
                                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inp P_ID :" & Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIN_NROPEDIDO")))
                                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inp P_Estado :" & ConfigurationSettings.AppSettings("CONS_ESTADO_PREPAGO_ALTAyPORTABILIDAD"))
                                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inp P_Almacen :" & Funciones.CheckStr(AppAlmacen))
                                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inp P_tipo_doc_pago :" & P_tipo_doc_pago)
                                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inp P_numero_referencia :" & Var_Corr6)
                                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inp P_numero_ticket : - ")

                                                        objPvu.Actualizar_Prepago_AltaYPorta(Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIN_NROPEDIDO")), _
                                                                                            ConfigurationSettings.AppSettings("CONS_ESTADO_PREPAGO_ALTAyPORTABILIDAD"), _
                                                                                            Funciones.CheckStr(AppAlmacen), _
                                                                                            P_tipo_doc_pago, _
                                                                                        Var_Corr6, _
                                                                                            "", _
                                                                                            RptaPrepago)

                                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Out P_Valor_retorno :" & Funciones.CheckStr(RptaPrepago))
                                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Fin Actualizar metodo Actualizar_Prepago_AltaYPorta")
                                                    End If
                                                Catch ex As Exception
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  -- Error desPues de Paperless")
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  -- Error :" & ex.Message.ToString())
                                                End Try
                                            End If

                                            ' PS - Automatización de canje y nota de crédito.
                                            ' Verificar si existe reserva de puntos Claro Club para efectuar el canje de puntos
                                            ' por soles de decuento.
                                            If Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")) <> ConfigurationSettings.AppSettings("strTipDoc") Then
                                                Try
                                                    Dim nroLinea As String = ""
                                                    If ExisteCanjePuntosClaroClub(drPagos.Item("PEDIN_NROPEDIDO"), strIdentifyLog, nroLinea) Then
                                                        ' Actualiza WS PuntosCC
                                                        If drPagos.Item("PEDIC_TIPOVENTA") <> ConfigurationSettings.AppSettings("strTVPrepago") Then
                                                            nroLinea = ""
                                                        End If
                                                        If CanjeDescuentoEquipo(drPagos.Item("PEDIN_NROPEDIDO"), strIdentifyLog, nroLinea) Then
                                                            ' Actualizar canje puntos SISACT_CANJE_PUNTOS
                                                            ActualizarCanjePuntos(drPagos.Item("PEDIN_NROPEDIDO"), Var_Corr6, strIdentifyLog)
                                                        End If
                                                    End If
                                                Catch ex As Exception
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Error en Canje Claro Club ")
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  -- Error :" & ex.Message.ToString())
                                                End Try
                                            End If
                                        End If
                                    Else
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  ERROR EN LA ACTUALIZACIÒN")
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  K_DESLOG :" & K_DESLOG)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  K_NROLOG :" & K_NROLOG)
                                        '** RollBack a los Pagos en la Actualizaciòn pagos ************************'
                                        objActiv.AsignarPagoAcuerdosXDocSap(drPagos.Item("PEDIN_NROPEDIDO"), "", 0, CurrentUser, msgj)
                                        '***INICIO CAMBIO ROLLBACK SICAR***'
                                        If K_NROLOG = "-2" Then
                                            AnulaPagoSICAR(drPagos.Item("PEDIN_NROPEDIDO"), Microsoft.VisualBasic.Right(Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")), 2), Var_Corr1, Var_Corr2)
                                        End If
                                        '***FIN CAMBIO ROLLBACK SICAR***'
                                        DeshacerCambiosPagos(K_PAGON_IDPAGO)

                                        If AppCodigoDeshacerCambios = "-3" Then
                                            AppCodigoExitFunction = "-2"
                                            AppMensajeExitFunction = AppMensajeDeshacerCambios
                                            Exit Function
                                        End If
                                        '*************************************************'
                                    End If
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Registro de forma correcta el detalle del Pago :" & K_PAGON_IDPAGO)
                                    '=================================================================================================================================================================================================================='
                                Catch ex As Exception
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  K_DESLOG :" & K_DESLOG)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  K_NROLOG :" & K_NROLOG)
                                    objActiv.AsignarPagoAcuerdosXDocSap(drPagos.Item("PEDIN_NROPEDIDO"), "", 0, CurrentUser, msgj)
                                    DeshacerCambiosPagos(K_PAGON_IDPAGO)
                                    If AppCodigoDeshacerCambios = "-3" Then
                                        AppCodigoExitFunction = "-2"
                                        AppMensajeExitFunction = AppMensajeDeshacerCambios
                                        Exit Function
                                    End If
                                    'Session.Add("msgErrorGenerarSot", "Ocurrio un error al tratar de obtener el Correlativo")
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  -- Error :" & ex.Message.ToString())
                                    'Response.Redirect("PoolPagos.aspx") ################ VALIDAR APP - SICAR ################
                                    AppmsgErrorGenerarSot = "Ocurrio un error al tratar de obtener el Correlativo"
                                    AppCodigoExitFunction = "-2"
                                    AppMensajeExitFunction = AppmsgErrorGenerarSot
                                    Exit Function
                                End Try
                            Else
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Ocurrio un error al tratar de registrar el detalle del pedido :" & K_PAGON_IDPAGO)
                                '** RollBack a los Pagos ************************'
                                objActiv.AsignarPagoAcuerdosXDocSap(drPagos.Item("PEDIN_NROPEDIDO"), "", 0, CurrentUser, msgj)
                                DeshacerCambiosPagos(K_PAGON_IDPAGO)
                                If AppCodigoDeshacerCambios = "-3" Then
                                    AppCodigoExitFunction = "-2"
                                    AppMensajeExitFunction = AppMensajeDeshacerCambios
                                    Exit Function
                                End If
                                '*************************************************'
                            End If
                            'Session.Add("msgErrorGenerarSot", "Registro de Pago Correctamente")
                        Else
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  No registro de forma correcta el Pago :" & K_PAGON_IDPAGO)
                            '** RollBack al registro del pago ************************'
                            objActiv.AsignarPagoAcuerdosXDocSap(drPagos.Item("PEDIN_NROPEDIDO"), "", 0, CurrentUser, msgj)
                            DeshacerCambiosPagos(K_PAGON_IDPAGO)
                            If AppCodigoDeshacerCambios = "-3" Then
                                AppCodigoExitFunction = "-2"
                                AppMensajeExitFunction = AppMensajeDeshacerCambios
                                Exit Function
                            End If
                            '*************************************************'
                        End If
                    Catch ex As Exception
                        'Session.Add("msgErrorGenerarSot", "Error Al registrar Pagos")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  -- Error :" & ex.Message.ToString())
                        'Response.Redirect("PoolPagos.aspx")
                        AppmsgErrorGenerarSot = "Error Al registrar Pagos"
                        AppCodigoExitFunction = "-2"
                        AppMensajeExitFunction = AppmsgErrorGenerarSot
                        Exit Function
                    End Try
                    ''FIN DEL METODO GRABAR TRY
                    Dim blnErrorPago As Boolean = False


                    'If Not blnErrorPago Then
                    '    Recarga(strNumAsignado)
                    'End If
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Fin del proceso de pagos")

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Ini - ConsultaPedido - dsDatosPedido ")
                    dsDatosPedido = objConsultaMssap.ConsultaPedido(drPagos.Item("PEDIN_NROPEDIDO"), "", "")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Fin - ConsultaPedido - dsDatosPedido ")

                    '***********************************************************************************************************

                    'PROY-31850 - INICIO
                    If blnSunat Then
                        Try
                            Dim Lineas() As String = Split(strLineaActivacion, "|")
                            Dim strEquipos() As String = Split(strSerieEquipo, "|")
                            Dim strMaterialChips() As String = Split(strCodMaterialChip, "|")
                            Dim strChips() As String = Split(strSerieChip, "|")

                            Dim y As Int16
                            For y = 1 To Lineas.Length - 1
                                If blnIsOLO Then
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, "-------------------------------------")
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, "INICIO ACTUALIZACION DE TELEFONO OLO")
                                    Dim obj As New ClsActivacionPel
                                    Dim strUpdate As String = String.Empty
                                    Dim boolblnUpdate As Boolean
                                    Dim iDetalle As New COM_SIC_Activaciones.clsDetallePedidoMsSap


                                    iDetalle.K_PEDIN_NROPEDIDO = drPagos.Item("PEDIN_NROPEDIDO")
                                    iDetalle.K_SERIC_CODSERIE = strChips(y).PadLeft(18, "0")

                                    If Lineas(y).ToString().Length >= Funciones.CheckInt(clsKeyOLO.strNroDigitosLinea) Then
                                        Lineas(y) = Lineas(y).ToString().Substring(Lineas(y).ToString().Length - Funciones.CheckInt(clsKeyOLO.strNroDigitosLinea), Funciones.CheckInt(clsKeyOLO.strNroDigitosLinea))
                                    End If

                                    iDetalle.K_DEPEV_NROTELEFONO = Funciones.CheckStr(Lineas(y).ToString())

                                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas PVU")
                                    Dim respuesta As Integer = obj.actualizaTelefono(strChips(y), strMaterialChips(y), Lineas(y).ToString())
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Respuesta: " & respuesta.ToString)


                                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas MSINCDB")
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas MSINCDB[K_PEDIN_NROPEDIDO]->" & Funciones.CheckStr(iDetalle.K_PEDIN_NROPEDIDO))
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas MSINCDB[K_SERIC_CODSERIE]->" & Funciones.CheckStr(iDetalle.K_SERIC_CODSERIE))
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas MSINCDB[K_DEPEV_NROTELEFONO]->" & Funciones.CheckStr(iDetalle.K_DEPEV_NROTELEFONO))

                                    boolblnUpdate = oBusExpress.ActualizarTelefonoMSINCDB(iDetalle, strUpdate)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas MSINCDB[rpsta]->" & Funciones.CheckStr(strUpdate))

                                    If Funciones.CheckStr(strEquipos(y)).Length > 0 And Funciones.CheckStr(strChips(y)) <> Funciones.CheckStr(strEquipos(y)) Then

                                        iDetalle.K_SERIC_CODSERIE = strEquipos(y).PadLeft(18, "0")
                                        iDetalle.K_SERIC_CODSERIE = iDetalle.K_SERIC_CODSERIE.Substring(iDetalle.K_SERIC_CODSERIE.Length - 18)

                                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas MSINCDB Equipo")
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas MSINCDB[K_PEDIN_NROPEDIDO]->" & Funciones.CheckStr(iDetalle.K_PEDIN_NROPEDIDO))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas MSINCDB[K_SERIC_CODSERIE]->" & Funciones.CheckStr(iDetalle.K_SERIC_CODSERIE))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas MSINCDB[K_DEPEV_NROTELEFONO]->" & Funciones.CheckStr(iDetalle.K_DEPEV_NROTELEFONO))

                                        boolblnUpdate = oBusExpress.ActualizarTelefonoMSINCDB(iDetalle, strUpdate)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas MSINCDB[rpsta]->" & Funciones.CheckStr(strUpdate))

                                    End If
                                End If
                            Next
                        Catch ex As Exception
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "		ERROR: " & ex.Message.ToString())
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "		ERROR: " & ex.StackTrace.ToString())
                        Finally
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "FIN ACTUALIZACION DE TELEFONO OLO")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "-------------------------------------")
                        End Try
                    End If
                    'PROY-31850 - FIN

                    'PROY-24724-IDEA-28174 - INI
                    Dim objProteccionMovil As New COM_SIC_Activaciones.clsProteccionMovil
                    Dim strNroPedidoEquipo As String = ""
                    Dim strCodRpta As String = String.Empty
                    Dim strMsgRpta As String = String.Empty
                    Dim strNroPedidoPM As String = ""
                    Dim strNroTelefono As String = ""

                    If Funciones.CheckStr(drPagos.Item("PAGOC_CODSUNAT")) = "0000000000000000" AndAlso Not dsDatosPedido Is Nothing AndAlso _
                        dsDatosPedido.Tables.Count > 0 AndAlso dsDatosPedido.Tables(0).Rows.Count > 0 Then

                        strNroPedidoPM = Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO"))
                        strNroTelefono = Funciones.CheckStr(dsDatosPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO"))

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==============================")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "== Protección Móvil :: INI  ==")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==============================")

                        If Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION")) = clsKeyAPP.strClaseBolFactCanje Then

                            Dim strNumSEC As String = String.Empty
                            Dim blnEsProteccionMovil As Boolean = False
                            Dim dsMostrarPM As DataSet
                            Dim dtCanjeEquipo As DataTable
                            Dim blnPagoCorrecto As Boolean = False
                            Dim strPedidoEquipo As String = String.Empty

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     ValidarCanjeConProteccionMovil - INICIO ==")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      IN NRO PEDIDO PM: " & strNroPedidoPM)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      IN NRO PEDIDO EQ.: " & strNroPedidoEquipo)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      IN NRO SEC: " & strNumSEC)
                            strNroPedidoPM = Funciones.CheckInt64(strNroPedidoPM)
                            strPedidoEquipo = Funciones.CheckInt64(strPedidoEquipo)

                            ValidarCanjeConProteccionMovil(strNroPedidoPM, strPedidoEquipo, strNumSEC, dsMostrarPM, dtCanjeEquipo, blnEsProteccionMovil)

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      OUT BolEsProtMovil: " & blnEsProteccionMovil)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     ValidarCanjeConProteccionMovil -  F I N ==")

                            If blnEsProteccionMovil Then

                                Dim strNroCertificadoActual As String
                                Dim Flagrpta As String = String.Empty
                                Dim strIdCanje As String = String.Empty

                                strNroCertificadoActual = Funciones.CheckStr(dsMostrarPM.Tables(0).Rows(0).Item("EVALV_NRO_CERTF_RPTA"))
                                strIdCanje = Funciones.CheckStr(dtCanjeEquipo.Rows(0).Item("CANJI_ID"))

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     ProcesarPagoCanjeProteccionMovil -  INICIO ==")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      IN NRO PEDIDO PM: " & strNroPedidoPM)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      IN NRO SEC: " & strNumSEC)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      IN NRO TEL.: " & strNroTelefono)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      IN NRO CERTIFICADO: " & strNroCertificadoActual)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      IN ID Canje: " & strIdCanje)

                                blnPagoCorrecto = ProcesarPagoCanjeProteccionMovil(strNroPedidoPM, strNumSEC, strNroTelefono, strNroCertificadoActual, strIdCanje)

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      OUT FLAG RPTA: " & Flagrpta)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     ProcesarPagoCanjeProteccionMovil -  F I N  ==")

                                If blnPagoCorrecto Then
                                    Dim strTipoOperacion As String = "C"
                                    Dim lstSin As ArrayList 'PROY-24724 - Iteracion 2 Siniestros 
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     TipificarProteccionMovil -  INICIO ==")
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      IN NRO SEC: " & strNumSEC)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      IN NRO TEL: " & strNroTelefono) 'PROY-24724 - Iteracion 2 Siniestros - INI : Se quita strDescEquipo
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      IN TIPO OPERACION: " & strTipoOperacion)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      IN LISTA: " & lstSin.Count) 'PROY-24724 - Iteracion 2 Siniestros -

                                    TipificarProteccionMovil(strNroPedidoPM, strNumSEC, strNroTelefono, strTipoOperacion, dsMostrarPM, dtCanjeEquipo, lstSin, "") 'PROY-24724 - Iteracion 2 Siniestros -

                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     TipificarProteccionMovil -  F I N  ==")

                                End If
                            Else
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      ERROR EN ValidarCanjeConProteccionMovil")
                            End If

                        End If

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     ConsultaPedidoEquipoPM - INICIO ==")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         IN NRO PEDIDO PM: " & strNroPedidoPM)

                        objProteccionMovil.ValidaPagoEquipoProteccionMovil(strNroPedidoPM, strNroPedidoEquipo, strCodRpta, strMsgRpta)

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         OUT NRO PEDIDO EQUIPO: " & strNroPedidoEquipo)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         OUT COD RPTA: " & strCodRpta)
                        'INI PROY-140126
                        Dim MaptPath As String
                        MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                        MaptPath = "( Class : " & MaptPath & "; Function: guardarConectado)"
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         OUT MSG RPTA: " & strMsgRpta & MaptPath)
                        'FIN PROY-140126

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     ConsultaPedidoEquipoPM - FIN ==")

                        If (strCodRpta.Equals("0") Or strCodRpta.Equals("-1")) AndAlso Not strNroPedidoEquipo.Equals("") Then

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "== Seguro Proteccion Movil: SI ==")

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "== ProcesarPagoProteccionMovil :: INI  ==")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==   IN Nro de Pedido: " & strNroPedidoPM)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==   IN Nro de Pedido Equipo: " & strNroPedidoEquipo)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==   IN Nro de Telefono: " & strNroTelefono)

                            ProcesarPagoProteccionMovil(strNroPedidoPM, strNroPedidoEquipo, strNroTelefono)

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "== ProcesarPagoProteccionMovil :: FIN  ==")
                        Else
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "== Seguro Proteccion Movil: NO ==")
                        End If
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==============================")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "== Protección Móvil :: FIN  ==")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==============================")
                    End If

                    'PROY-24724 - Iteracion 2 Siniestros -INI
                    Dim strCodMaterial As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEC_CODMATERIAL"))
                    Dim strTelefono As String = Right(Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO")), 9)
                    Dim strCodOficina As String = dsPedido.Tables(0).Rows(0)("OFICV_CODOFICINA")

                    AppPagoDeducible = "" 'PROY-31836 IDEA-43582_Mejora de Procesos Postventa del servicio Proteccion Movil 
                    If (strCodMaterial.Equals(clsKeyAPP.strCodMaterialSiniestro)) Then
                        AppPagoDeducible = strTelefono ' PROY-31836 IDEA-43582_Mejora de Procesos Postventa del servicio Proteccion Movil
                        ProcesarPagoSiniestro(strIdentifyLog, strTelefono, strCodOficina)
                    End If
                    'PROY-24724 - Iteracion 2 Siniestros -FIN
                    'PROY-24724-IDEA-28174 - FIN

                    '**INICIO FC***'
                    'VOy a considerar este metodo para grabar el correlativo en el flujo de caja
                    '
                    '*** REGISTRO DE DATOS PARA EL FLUJO DE CAJA ***'
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Registro datos del Flujo Caja")
                    objCajas = New COM_SIC_Cajas.clsCajas
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Seteamos la fecha para la concatenaciòn")
                    Dim cultureName As String = "es-PE"
                    Dim culture As CultureInfo = New CultureInfo(cultureName)
                    Dim dateTimeValue As DateTime
                    dateTimeValue = Convert.ToDateTime(DateTime.Now, culture)

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "---------------------------------------------------------------------------------------------------------- ")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Registro datos del Flujo Caja")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Formato de fechas para FC: yyyymmdd")

                    '''*****fechaCajas = dateTimeValue.ToShortDateString.Substring(6, 4) & dateTimeValue.ToShortDateString.Substring(3, 2) & dateTimeValue.ToShortDateString.Substring(0, 2)
                    'Var_Corr6 ----> Valor del correlativo a utilizar
                    'PROY-140397-MCKINSEY -> JSQ INICIO
                    fechaCajas = Format(Now.Year, "0000").ToString.Trim & Format(Now.Month, "00").ToString.Trim & Format(Now.Day, "00").ToString.Trim
                    'PROY-140397-MCKINSEY -> JSQ FIN
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- fechaCajas : " & fechaCajas.ToString)

                    ''''1. Registro de pago: TABLA "TI_VENTAS_FACT"
                    '''*Para las notas de crèdito el monto del saldo enviado debe ser 0.00

                    Dim PEDIC_CLASEFACTURA As String = "" 'valor que sera reemplazado por una key si es una recarga virtual frecuente
                    Dim P_NRO_CUOTAS As Integer 'PROY 30166

                    Try
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio método : RegistrarPago")

                        'MEJORA INC000001503169:  PEDIC_TIPODOCUMENTO <> ZG2
                        If dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CLASEPEDIDO") = System.Configuration.ConfigurationSettings.AppSettings("PEDIC_CLASEPEDIDO_RVF") And Trim(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_TIPODOCUMENTO")) <> System.Configuration.ConfigurationSettings.AppSettings("constSINERGIAClaseDocumentoNC") Then
                            PEDIC_CLASEFACTURA = System.Configuration.ConfigurationSettings.AppSettings("DESC_BOLETA_RVF")
                        Else
                            PEDIC_CLASEFACTURA = Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA"))
                        End If

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_OFICINA_VENTA: " & AppAlmacen)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_FECHA : " & fechaCajas)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_CAJERO : " & Microsoft.VisualBasic.Right(Funciones.CheckStr("0000000000" & AppUsuario), 10))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_DESC_DOCUMENTO : " & dsDatosPedido.Tables(0).Rows(0).Item("PEDIV_DESCCLASEFACTURA"))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_FACTURA_FICTICIA : " & strDocSap)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_REFERENCIA : " & Var_Corr6)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_VENDEDOR : " & Microsoft.VisualBasic.Right(Funciones.CheckStr("0000000000" & dsDatosPedido.Tables(0).Rows(0).Item("VENDEDOR")), 10))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_MONEDA : " & System.Configuration.ConfigurationSettings.AppSettings("MONEDA"))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_CLASE_FACTURA_COD : " & PEDIC_CLASEFACTURA)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_NRO_CUOTAS : " & dsDatosPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA"))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_TOTAL_FACTURA : " & dsDatosPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO"))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_SALDO : " & IIf(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA") <> ConfigurationSettings.AppSettings("strTipDoc"), dsDatosPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO"), 0))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_REFERENCIA_ORIG : " & IIf(IsDBNull(dsDatosPedido.Tables(0).Rows(0).Item("PEDIV_NROREFNCND")), "", dsDatosPedido.Tables(0).Rows(0).Item("PEDIV_NROREFNCND")))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_ESTADO : " & System.Configuration.ConfigurationSettings.AppSettings("ESTADO_VENTA_FLUJOCAJA"))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_NODO : " & Funciones.CheckStr(Right(System.Net.Dns.GetHostName, 2)))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_USUARIO_CREACION : " & System.Configuration.ConfigurationSettings.AppSettings("ConstCuentasCliente_Usuario"))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_NUMERO_TELEFONO : " & CStr(hidNumeroTelefono))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_NROOPE_TRACE : " & CStr(AppTraceRecarga))

                        P_NRO_CUOTAS = dsDatosPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA") 'PROY 30166 

                        resCajas = objCajas.RegistrarPagoAPK(AppAlmacen, fechaCajas, _
                                                    Microsoft.VisualBasic.Right(Funciones.CheckStr("0000000000" & AppUsuario), 10), _
                                                    dsDatosPedido.Tables(0).Rows(0).Item("PEDIV_DESCCLASEFACTURA"), _
                                                    strDocSap, Var_Corr6, _
                                                    Microsoft.VisualBasic.Right(Funciones.CheckStr("0000000000" & dsDatosPedido.Tables(0).Rows(0).Item("VENDEDOR")), 10), _
                                                    System.Configuration.ConfigurationSettings.AppSettings("MONEDA"), _
                                                    PEDIC_CLASEFACTURA, _
                                                    dsDatosPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA"), _
                Funciones.CheckDbl(dsDatosPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO")), _
                                                    IIf(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA") <> ConfigurationSettings.AppSettings("strTipDoc"), Funciones.CheckDbl(dsDatosPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO")), 0), _
                IIf(IsDBNull(dsDatosPedido.Tables(0).Rows(0).Item("PEDIV_NROREFNCND")), "", dsDatosPedido.Tables(0).Rows(0).Item("PEDIV_NROREFNCND")), _
                                                    System.Configuration.ConfigurationSettings.AppSettings("ESTADO_VENTA_FLUJOCAJA"), _
                                                    Funciones.CheckStr(Right(System.Net.Dns.GetHostName, 2)), _
                                                    System.Configuration.ConfigurationSettings.AppSettings("ConstCuentasCliente_Usuario"), _
                                                    "1", P_ID_TI_VENTAS_FACT, P_MSGERR, CStr(hidNumeroTelefono), CStr(AppTraceRecarga))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin método : RegistrarPago")
                    Catch ex As Exception
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error al tratar de ejecutar el método:  RegistrarPago")
                    End Try

                    If P_ID_TI_VENTAS_FACT > 0 Then
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Código generado en la tabla TI_VENTAS_FACT=> " & P_ID_TI_VENTAS_FACT.ToString)

                        '''''''''2. Registro RegistrarPagoDetalle
                        If Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")) <> ConfigurationSettings.AppSettings("strTipDoc") Then '** Las notas de crèdito no van a formar parte de este proceso **'
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicia el proceso para el RegistrarPagoDetalle")

                            If (Funciones.CheckDbl(dsDatosPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO")) > 0) Then
                                Dim dTotPagoNoCuota As Double = 0 ' PROY-30166 GPRD
                                For i = 1 To hidNumFilas
                                    Dim txtMonto As Double
                                    Dim cboTipDocumento As String
                                    Dim cboDescTipDocumento As String
                                    'PROY-27440 INI
                                    'Dim objTxt As TextBox
                                    'objTxt = CType(Me.FindControl("txtMonto" & i), TextBox)
                                    'strMonto = "" : strMonto = Trim(objTxt.Text)

                                    'JCC INI'
                                    If Not (P_NRO_CUOTAS > 0 And dblMontoCuotaInicial >= 0) Then
                                    strMonto = ApptxtMonto1
                                    End If
                                    'JCC FIN'

                                    strTipoDocPago = AppCboTipoDocumento

                                    cboTipDocumento = strTipoDocPago
                                    txtMonto = Double.Parse(strMonto)
                                    'PROY-27440 FIN
                                    'PROY BUYBACK - INICIO'
                                    If (hidCupon = "1" And i = 1) Then
                                        cboTipDocumento = "ZBUY"
                                    Else
                                        cboTipDocumento = strTipoDocPago
                                    End If
                                    'PROY BUYBACK - FIN'
                                    cboDescTipDocumento = DevuelteTipoDescPago(cboTipDocumento)
                                    resCajas = 0

                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  Item : " & i.ToString())
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_ID_TI_VENTAS_FACT : " & P_ID_TI_VENTAS_FACT.ToString())
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_FECHA : " & fechaCajas)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_FACTURA_FICTICIA : " & strDocSap)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_REFERENCIA : " & Var_Corr6)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_CLASE_FACTURA_COD : " & PEDIC_CLASEFACTURA)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_MEDIO_PAGO : " & cboTipDocumento)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_REF_NC : " & IIf(arrayListaRefSunat(i) = "", "", Funciones.CheckStr(arrayListaRefSunat(i))))
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_MONTO : " & txtMonto)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_ESTADO : " & System.Configuration.ConfigurationSettings.AppSettings("ESTADO_VENTA_FLUJOCAJA"))
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_USUARIO_CREACION : " & System.Configuration.ConfigurationSettings.AppSettings("ConstCuentasCliente_Usuario"))

                                    '''''''''''**Registra los medios de pago seleccionado.
                                    '''''''''IIf(arrayListaReferencia(i) = "", "", Funciones.CheckStr(arrayListaReferencia(i))), _
                                    If Not (P_NRO_CUOTAS > 0 And dblMontoCuotaInicial = 0) Then 'PROY 30166 
                                        resCajas = objCajas.RegistrarPagoDetalle(P_ID_TI_VENTAS_FACT, fechaCajas, strDocSap, _
                                                                    Var_Corr6, PEDIC_CLASEFACTURA, _
                                                                    cboTipDocumento, _
                                                                    IIf(arrayListaRefSunat(i) = "", "", Funciones.CheckStr(arrayListaRefSunat(i))), _
                                                                    txtMonto, _
                                                                    System.Configuration.ConfigurationSettings.AppSettings("ESTADO_VENTA_FLUJOCAJA"), _
                                                                    System.Configuration.ConfigurationSettings.AppSettings("ConstCuentasCliente_Usuario"), _
                                                                    P_MSGERR)
                                    End If


                                    'PROY-30166 - IDEA  38934  INICIO GPRD
                                    dTotPagoNoCuota = dTotPagoNoCuota + Double.Parse(strMonto)
                                    'If (i = hidNumFilas.Value AndAlso dblMontoCuotaInicial > 0) Then
                                    If (i = hidNumFilas And P_NRO_CUOTAS > 0 And dblMontoCuotaInicial >= 0) Then
                                        txtMonto = Double.Parse(hidTotalSinInicial) - dTotPagoNoCuota 'jbaca 060918

                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Adic X Cuotas P_ID_TI_VENTAS_FACT : " & P_ID_TI_VENTAS_FACT)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Adic X Cuotas cboTipDocumento : " & "ZCI1")
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Adic X Cuotas cboDescTipDocumento : " & "CUOTA INICIAL")
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Adic X Cuotas txtMonto : " & txtMonto)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Adic X Cuotas ConstCuentasCliente_Usuario : " & System.Configuration.ConfigurationSettings.AppSettings("ConstCuentasCliente_Usuario"))
                                        'VCANCHIC PROY 140743'
                                        Dim tipoPago As String = "ZCI1"
                                        If sTipoOperacion = ConfigurationSettings.AppSettings("COD_TIPO_OPERACION_VENTA_VARIOS") Then
                                            tipoPago = Funciones.CheckStr(ReadKeySettings.Key_TipoPagoAccCuo)
                                        End If
                                        'VCANCHIC PROY 140743'

                                        resCajas = objCajas.RegistrarPagoDetalle(P_ID_TI_VENTAS_FACT, fechaCajas, strDocSap, _
                                                                    Var_Corr6, PEDIC_CLASEFACTURA, _
                                                                    tipoPago, _
                                                                    IIf(arrayListaRefSunat(i) = "", "", Funciones.CheckStr(arrayListaRefSunat(i))), _
                                                                    txtMonto, _
                                                                    System.Configuration.ConfigurationSettings.AppSettings("ESTADO_VENTA_FLUJOCAJA"), _
                                                                    System.Configuration.ConfigurationSettings.AppSettings("ConstCuentasCliente_Usuario"), _
                                                                    P_MSGERR)

                                    End If
                                    'PROY-30166 - IDEA  38934  FIN GPRD
                                Next
                            Else
                                Dim txtMonto As Double
                                Dim cboTipDocumento As String
                                Dim cboDescTipDocumento As String

                                'PROY BUYBACK - INICIO'
                                Dim txtMontoCV As Double
                                Dim cboTipDocumentoCV As String

                                If (hidCupon = "1") Then
                                    'cboTipDocumentoCV = cboTipDocumento1.SelectedValue
                                    'txtMontoCV = Funciones.CheckDbl(txtMonto1)

                                    'cboTipDocumento = cboTipDocumento2.SelectedValue
                                    'txtMonto = Funciones.CheckDbl(txtMonto2)
                                Else
                                    'cboTipDocumento = cboTipDocumento1.SelectedValue
                                    'txtMonto = Funciones.CheckDbl(txtMonto1)
                                    cboTipDocumento = AppCboTipoDocumento
                                    txtMonto = Funciones.CheckDbl(ApptxtMonto1)
                                End If
                                'PROY BUYBACK - FIN'

                                'cboDescTipDocumento = DevuelteTipoDescPago(cboTipDocumento)
                                resCajas = 0

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  Item : " & i.ToString())
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_ID_TI_VENTAS_FACT : " & P_ID_TI_VENTAS_FACT.ToString())
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_FECHA : " & fechaCajas)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_FACTURA_FICTICIA : " & strDocSap)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_REFERENCIA : " & Var_Corr6)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_CLASE_FACTURA_COD : " & PEDIC_CLASEFACTURA)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_MEDIO_PAGO : " & cboTipDocumento)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_REF_NC : " & "")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_MONTO : " & txtMonto)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_ESTADO : " & System.Configuration.ConfigurationSettings.AppSettings("ESTADO_VENTA_FLUJOCAJA"))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_USUARIO_CREACION : " & System.Configuration.ConfigurationSettings.AppSettings("ConstCuentasCliente_Usuario"))

                                '''''''''''**Registra los medios de pago seleccionado.
                                '''''''''IIf(arrayListaReferencia(i) = "", "", Funciones.CheckStr(arrayListaReferencia(i))), _

                                'PROY  BUYBACK - INICIO'
                                If (hidCupon = "1") Then

                                    resCajasCV = objCajas.RegistrarPagoDetalle(P_ID_TI_VENTAS_FACT, fechaCajas, strDocSap, _
                                                                Var_Corr6, PEDIC_CLASEFACTURA, _
                                                                cboTipDocumentoCV, _
                                                                "", _
                                                                txtMontoCV, _
                                                                System.Configuration.ConfigurationSettings.AppSettings("ESTADO_VENTA_FLUJOCAJA"), _
                                                                System.Configuration.ConfigurationSettings.AppSettings("ConstCuentasCliente_Usuario"), _
                                                                P_MSGERR)


                                    resCajas = objCajas.RegistrarPagoDetalle(P_ID_TI_VENTAS_FACT, fechaCajas, strDocSap, _
                                                                Var_Corr6, PEDIC_CLASEFACTURA, _
                                                                cboTipDocumento, _
                                                                "", _
                                                                txtMonto, _
                                                                System.Configuration.ConfigurationSettings.AppSettings("ESTADO_VENTA_FLUJOCAJA"), _
                                                                System.Configuration.ConfigurationSettings.AppSettings("ConstCuentasCliente_Usuario"), _
                                                                P_MSGERR)

                                Else
                                    resCajas = objCajas.RegistrarPagoDetalle(P_ID_TI_VENTAS_FACT, fechaCajas, strDocSap, _
                                                                Var_Corr6, PEDIC_CLASEFACTURA, _
                                                                cboTipDocumento, _
                                                                "", _
                                                                txtMonto, _
                                                                System.Configuration.ConfigurationSettings.AppSettings("ESTADO_VENTA_FLUJOCAJA"), _
                                                                System.Configuration.ConfigurationSettings.AppSettings("ConstCuentasCliente_Usuario"), _
                                                                P_MSGERR)
                                End If
                                'PROY BUYBACK - FIN'

                            End If
                            'PROY BUYBACK - INICIO'
                            If hidCupon = "1" Then
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio actualizacion cupon")
                                Dim objConsultaMssap As New clsConsultaMsSap
                                Dim strCodRespuesta As String = String.Empty
                                Dim strMsjRespuesta As String = String.Empty
                                objConsultaMssap.ActualizaCupon(Funciones.CheckStr(hidCodigoCupon), clsKeyAPP.Key_Estado_Pagado, CurrentUser, strCodRespuesta, strMsjRespuesta)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "strCodRespuesta : " & strCodRespuesta)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "strMsjRespuesta : " & strMsjRespuesta)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin actualizacion cupon")
                            End If
                            'PROY BUYBACK - FIN'
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Termina el proceso para el RegistrarPagoDetalle")
                            '''''''''''''''''''* FIN 2 *'

                            ''''''''''* 3. RegistrarVentaDetalle, consulto el pedido para asegurar la data
                            '''''''''** Registro de los MATERIALES(TI_MATER_FACT):
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicia el proceso para el RegistrarVentaDetalle.")
                            If Not dsDatosPedido Is Nothing Then
                                If dsDatosPedido.Tables(1).Rows.Count > 0 Then
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicia el proceso para registrar la venta en el detalle.")
                                    resCajas = 0
                                    For k As Integer = 0 To dsDatosPedido.Tables(1).Rows.Count - 1
                                        resCajas = objCajas.RegistrarVentaDetalle(AppAlmacen, fechaCajas, _
                                                                                    Microsoft.VisualBasic.Right(Funciones.CheckStr("0000000000" & AppUsuario), 10), _
                                                                                    dsDatosPedido.Tables(0).Rows(0).Item("PEDIV_DESCCLASEFACTURA"), _
                                                                                    strDocSap, Var_Corr6, _
                                                                                    Microsoft.VisualBasic.Right(Funciones.CheckStr("0000000000" & dsDatosPedido.Tables(0).Rows(0).Item("VENDEDOR")), 10), _
                                                                                    dsDatosPedido.Tables(1).Rows(k).Item("DEPEC_CODMATERIAL"), _
                                                                                    dsDatosPedido.Tables(1).Rows(k).Item("DEPEV_DESCMATERIAL"), _
                                                                                    "UN", 1, _
                                                                                    dsDatosPedido.Tables(1).Rows(k).Item("DEPEN_PRECIOIGV"), _
                                                                                    IIf(IsDBNull(dsDatosPedido.Tables(1).Rows(k).Item("SERIC_CODSERIE")), "", dsDatosPedido.Tables(1).Rows(k).Item("SERIC_CODSERIE")), _
                                                                                    IIf(IsDBNull(dsDatosPedido.Tables(1).Rows(k).Item("DEPEV_CODIGOLP")), "", dsDatosPedido.Tables(1).Rows(k).Item("DEPEV_CODIGOLP")), _
                                                                                    IIf(IsDBNull(dsDatosPedido.Tables(1).Rows(k).Item("DEPEV_DESCRIPCIONLP")), "", dsDatosPedido.Tables(1).Rows(k).Item("DEPEV_DESCRIPCIONLP")), _
                                                                                    Funciones.CheckStr(Right(System.Net.Dns.GetHostName, 2)), _
                                                                                    System.Configuration.ConfigurationSettings.AppSettings("ConstCuentasCliente_Usuario"), _
                                                                                    P_MSGERR)


                                    Next
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin el proceso para registrar la venta en el detalle.")
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "JOH" & P_MSGERR)
                                    If P_MSGERR <> "" Then
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error al registrar la venta detalle.")
                                        DeshacerCambiosPagos(K_PAGON_IDPAGO)
                                        If AppCodigoDeshacerCambios = "-3" Then
                                            AppCodigoExitFunction = "-2"
                                            AppMensajeExitFunction = AppMensajeDeshacerCambios
                                            Exit Function
                                        End If
                                        'Response.Write("<script>alert('" & P_MSGERR & "')</script>")
                                        AppErrorDeshacerCambios = P_MSGERR
                                        Exit Function
                                    Else
                                        '**********************************************
                                        '*** 4. Registramos RegistrarDetalleCuota   ***'
                                        '*** DETALLA EL NUMERO DE CUOTAS DEL PEDIDO ***'
                                        '**********************************************
                                        resCajas = 0
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "JOH" & dsDatosPedido.Tables(0).Rows.Count.ToString())

                                        If dsDatosPedido.Tables(0).Rows.Count > 0 Then
                                            '**REGISTRA LAS CUTOAS DEL PEDIDO SI EXISTIERA **'
                                            If dsDatosPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA") > 0 Then
                                                '''For c As Integer = 1 To dsDatosPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA")
                                                resCajas = objCajas.RegistrarDetalleCuota(P_ID_TI_VENTAS_FACT, fechaCajas, _
                                                                                        Funciones.CheckStr(strDocSap), _
                                                                                        Var_Corr6, dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA"), _
                                                                                        dsDatosPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA"), _
                                                                                        0, _
                                                                                        System.Configuration.ConfigurationSettings.AppSettings("ConstCuentasCliente_Usuario"), _
                                                                                        P_MSGERR)

                                                ''JOH
                                                Dim sResultado As String
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Iniciando Actualizar cuota")
                                                'PROY-33313 RP INICIO
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Nro Cuota : " & Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA")))
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Tipo de Operacion : " & Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION")))
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Valor de Operacion Repo : " & Funciones.CheckStr(ConfigurationSettings.AppSettings("COD_OPERACION_REPOSICION")))
                                                If dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVPostpago") And dsDatosPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA") = 1 And dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION") = ConfigurationSettings.AppSettings("COD_OPERACION_REPOSICION") Then
                                                    Dim sCodMsj As String
                                                    Dim sActualizaCVE As Boolean
                                                    sActualizaCVE = objCajas.FnActualizaTipoCVE(Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")), sCodMsj)
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Actualizacion de Tipo CVE : " & sActualizaCVE)
                                                    'INI PROY-140126
                                                    Dim MaptPath As String
                                                    MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                                                    MaptPath = "( Class : " & MaptPath & "; Function: guardarConectado)"
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Mensaje Tipo CVE : " & sCodMsj & MaptPath)
                                                    'FIN PROY-140126
                                                Else
                                                    'BEGIN INC000001089654
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - INIT Flujo Actualizar Cuota", strIdentifyLog))
                                                    'PROY-140743 IDEA141192 VICTOR CANCHICA
                                                    Dim CuotaAcc As Integer = dsDatosPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA")
                                                    Dim Contrato As String
                                                    If objContrato Is Nothing And sTipoOperacion = ConfigurationSettings.AppSettings("COD_TIPO_OPERACION_VENTA_VARIOS") And CuotaAcc > 0 Then
                                                        Contrato = "ACC-" + strDocSap
                                                    Else
                                                        Contrato = objContrato.Tables(0).Rows(0).Item("ID_CONTRATO")
                                                    End If
                                                    If Not objContrato Is Nothing Or sTipoOperacion = ConfigurationSettings.AppSettings("COD_TIPO_OPERACION_VENTA_VARIOS") And CuotaAcc > 0 Then
                                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & Contrato)
                                                        If objCajas.Actualizar_Cuotas(Contrato, sResultado) = 0 Then
                                                            'PROY-140743 IDEA141192 VICTOR CANCHICA
                                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Se Actualizo las cuotas Correctamente.")
                                                        Else
                                                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - Error al actualizar cuota.", strIdentifyLog))
                                                        End If
                                                    Else
                                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Contrato en PVU no existe")
                                                    End If

                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - END Flujo Actualizar Cuota", strIdentifyLog))
                                                    'END INC000001089654
                                                End If
                                                'PROY-33313 RP FIN
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Finalizar Actualizar cuota")
                                                ''''Next
                                            End If
                                        End If
                                    End If
                                Else
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "No se encontraron datos al consultar el pedido.")
                                End If
                            Else
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "La consulta no se realizo correctamente.")
                            End If
                        End If  '** FIN IF DE LA NC
                    Else
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Error devuelto : " & P_MSGERR.ToString)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Error, no se realizo el registro en TI_VENTAS_FACT")
                        objActiv.AsignarPagoAcuerdosXDocSap(drPagos.Item("PEDIN_NROPEDIDO"), "", 0, CurrentUser, msgj)
                    End If
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Registro datos del Flujo Caja")
                    '**FIN FC
                    '*********************************************************************************************************

                    'INI - INSERTAR EFECTIVO - CCC
                    'objCajas.FP_InsertaEfectivo(Session("ALMACEN"), "60138", dblEfectivo)  'Se inserta el efectivo obtenido
                    Dim nroCuotas As Integer = 0
                    If Not CBool(ApprecargaVirtual) Then
                        nroCuotas = CStr(drPagos.Item("DEPEN_NROCUOTA"))
                    End If
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio FP_InsertaEfectivo.")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp ALMACEN: " & AppAlmacen)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp USUARIO: " & AppUsuario)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp dblEfectivo: " & CStr(dblEfectivo))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp FECHA: " & CStr(dsPedido.Tables(0).Rows(0).Item("PEDID_FECHADOCUMENTO")))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Cuotas : " & nroCuotas.ToString())
                    Dim dFecha As Date
                    Dim sFecha As String = Format(Now.Day, "00").ToString.Trim & "/" & Format(Now.Month, "00").ToString.Trim & "/" & Format(Now.Year, "0000").ToString.Trim

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - Fecha Pedido : " & sFecha)
                    Try
                        If nroCuotas = 0 Then  ' No se contabliza el pago en cuotas
                            objCajas.FP_InsertaEfectivo(AppAlmacen, AppUsuario, dblEfectivo, sFecha)     'Se inserta el efectivo obtenido
                            '    objCajas.FP_InsertaEfectivo(Session("ALMACEN"), Session("USUARIO"), dblEfectivo)     'Se inserta el efectivo obtenido
                        End If
                    Catch ex As Exception
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "Entro al Error de insertar efectivo")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "Error " & ex.Message.ToString())
                    End Try

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin FP_InsertaEfectivo.")
                    'FIN - INSERTAR EFECTIVO - CCC

                    '/*----------------------------------------------------------------------------------------------------------------*/
                    '/*--JR  INICIO  -  PROY-29380 IDEA-38934 - Iteración 2 y 3 2da Fase Sinergia Adec en Sist de Venta y Post-Venta --*/
                    '/*----------------------------------------------------------------------------------------------------------------*/
                    'Inicia Devolucion de Efectivo de una Recarga Virtual (reversa Recarga Virtual) solo para las NOTAS DE CREDITO

                    If K_DESLOG = "OK" Then
                        Dim strCanal As String = AppCanal
                        Dim strUserSesion As String = AppUsuario
                        Dim arrDetalle(10) As String
                        'Dim isRecargaVirtual As Boolean
                        Dim isNotaCredito As Boolean = AppNC 'Creo que no tiene valor, elimianrlo

                        'Dim estadoRegistrarRecargaVirtual As Boolean
                        Dim estadoRegistrarRecargaVirtual As Integer

                        arrDetalle(1) = Funciones.CheckStr(dsDatosPedido.Tables(1).Rows(0).Item("DEPEN_PRECIOVENTA"))
                        arrDetalle(2) = Funciones.CheckStr(dsDatosPedido.Tables(1).Rows(0).Item("MATEN_PRECIOBASE"))
                        arrDetalle(3) = Funciones.CheckStr(dsDatosPedido.Tables(1).Rows(0).Item("DEPEN_SUBTOTAL"))
                        arrDetalle(4) = Funciones.CheckStr(dsDatosPedido.Tables(1).Rows(0).Item("DEPEN_IMPUESTO"))
                        arrDetalle(5) = Funciones.CheckStr(dsDatosPedido.Tables(1).Rows(0).Item("DEPEN_PRECIOIGV"))
                        arrDetalle(6) = Funciones.CheckStr(dsDatosPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO"))
                        arrDetalle(7) = Funciones.CheckStr(dsDatosPedido.Tables(1).Rows(0).Item("OFICV_CODOFICINA"))

                        'solo ingresa si es Nota de credito (DEVOLUCION DE EFECTIVO)
                        If Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")) = ConfigurationSettings.AppSettings("strTipDoc") Then
                            If Not IsNothing(ApprecargaVirtual) Then
                                isRecargaVirtual = ApprecargaVirtual
                                If isRecargaVirtual Then

                                    'Obtenemos los mensajes que seran mostrados al realizar la reversa de la RV
                                    Dim msjRV_NoRegistrada As String
                                    Dim msjRV_Devuelta As String
                                    Dim msjRV_FallaValidaLinea As String
                                    Dim msjRV_LineaSinSaldo As String
                                    Dim msjRV_ErrorDevolucion As String
                                    Dim msjRV_ErrorCambioEstado As String
                                    Dim msjRV_ErrorObtenerSaldo As String = ""
                                    Dim msjDevolverRV As String
                                    Dim codGrupoMensajes As Integer = Funciones.CheckDbl(ConfigurationSettings.AppSettings("constGrupoParam_MensajesReversaRecargaVirtual"))

                                    Dim dsMensajesRV As DataSet = (New COM_SIC_Cajas.clsCajas).ObtenerParamByGrupo(codGrupoMensajes)

                                    If Not IsNothing(dsMensajesRV) Then
                                        dsMensajesRV.Tables(0).DefaultView.Sort = "PARAN_CODIGO ASC"

                                        msjRV_NoRegistrada = Funciones.CheckStr(dsMensajesRV.Tables(0).Rows(0).Item("PARAV_VALOR"))
                                        msjRV_Devuelta = Funciones.CheckStr(dsMensajesRV.Tables(0).Rows(1).Item("PARAV_VALOR"))
                                        msjRV_FallaValidaLinea = Funciones.CheckStr(dsMensajesRV.Tables(0).Rows(2).Item("PARAV_VALOR"))
                                        msjRV_LineaSinSaldo = Funciones.CheckStr(dsMensajesRV.Tables(0).Rows(3).Item("PARAV_VALOR"))
                                        msjRV_ErrorDevolucion = Funciones.CheckStr(dsMensajesRV.Tables(0).Rows(4).Item("PARAV_VALOR"))
                                        msjRV_ErrorCambioEstado = Funciones.CheckStr(dsMensajesRV.Tables(0).Rows(5).Item("PARAV_VALOR"))

                                    Else
                                        msjRV_NoRegistrada = "No se pudo obtener datos de la recarga, asegúrese que la recarga este registrada."
                                        msjRV_Devuelta = "No se puede concretar la transaccion, la recarga ya ha sido consumida."
                                        msjRV_FallaValidaLinea = "Error en la valdiacion de la Línea. Intente nuevamente."
                                        msjRV_LineaSinSaldo = "No se procederá con el pago de la Nota de Crédito, el saldo de la bolsa es menor al monto recargado."
                                        msjRV_ErrorDevolucion = "Surgió un error en la Devolución, Aunlar y volver a generar la Nota de Crédito."
                                        msjRV_ErrorCambioEstado = "Surgió un error en el cambio de estado de la RV, informar al supervisor."
                                        msjRV_ErrorObtenerSaldo = "Surgió un error al intentar obtener el Saldo de la Linea."
                                    End If

                                    'invocamos al metodo que realizarala conexion con el WS y la reversa de la Recarga Virtual
                                    estadoRegistrarRecargaVirtual = ExtornarRecargaVirtual(strIdentifyLog, strCanal, strUserSesion, arrDetalle)

                                    '-1 Error en el Servicio
                                    '0  Exito
                                    '1  La recarga ya fue Devuelta
                                    '2	No se pudo obtener la recarga
                                    '3	No se pudo valida si la línea es prepago o postpago
                                    '4	La línea postpago no tiene saldo
                                    '5	No se pudo devolver el efectivo para la línea postpago
                                    '6	La línea prepago no tiene saldo
                                    '7	No se pudo devolver el efectivo para la línea postpago
                                    '8	No se pudo cambiar el estado de la transaccion

                                    If estadoRegistrarRecargaVirtual = 0 Then
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " Se realizò la Reversa de la Recarga Virtual correctamente")
                                    Else
                                        K_DESLOG = ""
                                        hidDESLOG = K_DESLOG
                                        hidExtornoExitoso = False
                                        If estadoRegistrarRecargaVirtual = -1 Then
                                            msjDevolverRV = msjRV_ErrorDevolucion
                                        ElseIf estadoRegistrarRecargaVirtual = 1 Then
                                            'Mostrar mensaje que la Recarga ya fue devuelta 
                                            msjDevolverRV = msjRV_Devuelta
                                        ElseIf estadoRegistrarRecargaVirtual = 2 Then
                                            'Mostrar mensaje No se pudo obtener datos de la recarga
                                            msjDevolverRV = msjRV_NoRegistrada
                                        ElseIf estadoRegistrarRecargaVirtual = 3 Then
                                            'Mostrar mensaje Error de validacion de Linea
                                            msjDevolverRV = msjRV_FallaValidaLinea
                                        ElseIf estadoRegistrarRecargaVirtual = 4 Or estadoRegistrarRecargaVirtual = 5 Then
                                            'Mostrar la alerta Error al intentar obtener el saldo de la Linea... 
                                            msjDevolverRV = msjRV_ErrorObtenerSaldo
                                        ElseIf estadoRegistrarRecargaVirtual = 6 Then
                                            'Mostrar la alerta error al intentar devolver...                                      
                                            msjDevolverRV = msjRV_ErrorDevolucion
                                        ElseIf estadoRegistrarRecargaVirtual = 7 Then
                                            'Mostrar la alerta error al intentar devolver...                                      
                                            msjDevolverRV = msjRV_ErrorCambioEstado
                                        ElseIf estadoRegistrarRecargaVirtual = 8 Or estadoRegistrarRecargaVirtual = 9 Then
                                            'Mostrar la alerta saldo insuficiente para realizar la devolucion... 
                                            msjDevolverRV = msjRV_LineaSinSaldo
                                        End If
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & msjDevolverRV)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " No se procedera con el Extorno de la Recarga Virtual. No enviar la NC a SAP")
                                        'Session.Add("msgErrorDevolverRV", msjDevolverRV)
                                        AppmsgErrorDevolverRV = msjDevolverRV
                                    End If
                                End If
                            End If
                        End If
                    End If
                    '/*----------------------------------------------------------------------------------------------------------------*/
                    '/*--JR  FIN     -  PROY-29380 IDEA-38934 - Iteración 2 y 3 2da Fase Sinergia Adec en Sist de Venta y Post-Venta --*/
                    '/*----------------------------------------------------------------------------------------------------------------*/
                    'INSERTANDO EN SAP EL PAGO
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inicia el bloque para disparar al WS:")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " hidDESLOG: " + hidDESLOG)
                    If hidDESLOG = "OK" Then

                        '******INICIO Consulta si la Boleta viene de un CANJE *******'
                        If Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION")) = ConfigurationSettings.AppSettings("ClaseBolFactCanje") Then
                            Dim blnDocCanje As Boolean
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- INICIO PAGO DEL REGISTRO DE CANJE")
                            blnDocCanje = PagarRegistroCanje(drPagos.Item("PEDIN_NROPEDIDO"))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-   Actualizacion de Registro de Canje: " & blnDocCanje)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- FIN PAGO DEL REGISTRO DE CANJE")
                        End If
                        '******FIN Consulta si la Boleta viene de un CANJE *******'

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio ClsPagosWS")
                        '********************************************************************************************************************************************************************
                        'WS:
                        If Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")) <> ConfigurationSettings.AppSettings("TIPO_RENTA_ADELANTADA") Then
                            '**Dispara SAP.
                            '----
                            If ConfigurationSettings.AppSettings("LanzarServicio") = "0" Then
                                If Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")) <> ConfigurationSettings.AppSettings("strTipDoc") And dsDatosPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO") > 0 Then
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Ejecuta el WS para el pedido : " & Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")) & " Clase pedido(PEDIC_CLASEFACTURA): " & Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")))
                                    objClsPagosWS.RegistrarPagoSap(Funciones.CheckInt64(drPagos.Item("PEDIN_NROPEDIDO")), Funciones.CheckInt64(K_PAGON_IDPAGO), CurrentUser, CurrentTerminal, K_COD_RESPUESTA, K_MSJ_RESPUESTA, K_ID_TRANSACCION, AppUsuario)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin de la ejecuciòn del WS")

                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     ID COD RESPUESTA: " & K_COD_RESPUESTA)

                                    If K_COD_RESPUESTA = "0" Then
                                        AppEnvioSAP = "0"
                                    Else
                                        AppEnvioSAP = "1"
                                    End If
                                Else
                                    If Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")) <> ConfigurationSettings.AppSettings("strTipDoc") And dsDatosPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO") = 0 And dsPedido.Tables(0).Rows(0).Item("PEDIC_ESQUEMACALCULO") = ConfigurationSettings.AppSettings("ESQUEMACALCULO_TG") Then
                                        '**ENTRA AQUI CUANDO SON TRANSFERENCIAS GRATUITAS:
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Ejecuta WS para la TG.")
                                        objClsPagosWS.RegistrarPagoSap(Funciones.CheckInt64(drPagos.Item("PEDIN_NROPEDIDO")), 0, CurrentUser, CurrentTerminal, K_COD_RESPUESTA, K_MSJ_RESPUESTA, K_ID_TRANSACCION, AppUsuario)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin WS para la TG.")
                                    Else
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Entra a evaluar la NC para el WS:")
                                        If Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")) = ConfigurationSettings.AppSettings("strTipDoc") Then
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Ejecuta WS para otros tipos")
                                            'objClsPagosWS.RegistrarPagoSap(Funciones.CheckInt64(drPagos.Item("PEDIN_NROPEDIDO")), 0, CurrentUser, CurrentTerminal, K_COD_RESPUESTA, K_MSJ_RESPUESTA, K_ID_TRANSACCION, Session("USUARIO"))

                                            '/*----------------------------------------------------------------------------------------------------------------*/
                                            '/*--JR  INICIO  -  PROY-29380 IDEA-38934 - Iteración 2 y 3 2da Fase Sinergia Adec en Sist de Venta y Post-Venta --*/
                                            '/*----------------------------------------------------------------------------------------------------------------*/
                                            'Pase o no pase por la solicitud de extornarRecargaVirtual() el extorno siempre sera exitoso (TRUE)
                                            'sera FALSE si ocurre un error en el WS o no procede la solicitud del extorno (Ya se consumio el saldo de la RV)
                                            If hidExtornoExitoso Then
                                                Dim xxNroPedido As Int64 = Funciones.CheckInt64(drPagos.Item("PEDIN_NROPEDIDO")) 'JRJRJR ELIMINAR
                                                Dim xxIdPago As Int64 = Funciones.CheckInt64(K_PAGON_IDPAGO) 'JRJRJR ELIMINAR
                                                Dim xxCurrentUser As String = CurrentUser.ToString 'JRJRJR ELIMINAR
                                                Dim xxCurrentTerminal As String = CurrentTerminal.ToString 'JRJRJR ELIMINAR
                                                Dim xxUsuario As String = Funciones.CheckStr(AppUsuario) 'JRJRJR ELIMINAR

                                                objClsPagosWS.RegistrarPagoSap(Funciones.CheckInt64(drPagos.Item("PEDIN_NROPEDIDO")), Funciones.CheckInt64(K_PAGON_IDPAGO), CurrentUser, CurrentTerminal, K_COD_RESPUESTA, K_MSJ_RESPUESTA, K_ID_TRANSACCION, AppUsuario)

                                            End If
                                            '/*----------------------------------------------------------------------------------------------------------------*/
                                            '/*--JR  FIN     -  PROY-29380 IDEA-38934 - Iteración 2 y 3 2da Fase Sinergia Adec en Sist de Venta y Post-Venta --*/
                                            '/*----------------------------------------------------------------------------------------------------------------*/

                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin WS para otros tipos")
                                        End If
                                    End If
                                End If
                            End If
                            '----
                        End If
                        '********************************************************************************************************************************************************************
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     ID TRANSACCION: " & K_ID_TRANSACCION)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     ID MSN DE RESPUESTA: " & K_MSJ_RESPUESTA)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     ID ID DE TRANSACCION: " & K_ID_TRANSACCION)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin ClsPagosWS")
                    End If
                    ' FIN DE INSERTANDO EN SAP EL PAGO

                    '//PROY-140379 INI
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "############################ INICIO BLOQUE APPLE WATCH ############################")

                    If sTipoOperacion.Trim = "C" Then
                        Try

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "############################ PROCESO DE CANJE APPLE WATCH ############################")

                            Dim objclsConsultaMsSap As New COM_SIC_Activaciones.clsConsultaMsSap
                            Dim dtConsultaCanjeSW As DataTable

                            dtConsultaCanjeSW = objclsConsultaMsSap.ConsultaCanje(drPagos.Item("PEDIN_NROPEDIDO"), "", "")
                            Dim StrMotivoDevolSW As String = Funciones.CheckStr(dtConsultaCanjeSW.Rows(0).Item("CANJV_MOTIVO"))
                            Dim strSerie_entrante As String = Funciones.CheckStr(dtConsultaCanjeSW.Rows(0).Item("CANJV_ENT_SERIE_MAT"))
                            Dim strSerie_saliente As String = Funciones.CheckStr(dtConsultaCanjeSW.Rows(0).Item("CANJV_SAL_SERIE_MAT"))
                            Dim strMaterial As String = Funciones.CheckStr(dtConsultaCanjeSW.Rows(0).Item("CANJV_SAL_COD_MAT"))
                            Dim strMaterialEnt As String = Funciones.CheckStr(dtConsultaCanjeSW.Rows(0).Item("CANJV_ENT_COD_MAT"))

                            Dim blnEncontrado As Boolean = False
                            Dim blnMatEntEncontrado As Boolean = False
                            Dim strSplitMate() As String = Funciones.CheckStr(ReadKeySettings.Key_MaterialPermitidoSW).Split("|")
                            Dim strMatEncontrado As String = String.Empty
                            For x As Integer = 0 To strSplitMate.Length - 1 Step 1
                                If strSplitMate(x).PadLeft(18, "0") = strMaterial And Not blnEncontrado Then
                                    blnEncontrado = True
                                    strMatEncontrado = strSplitMate(x).PadLeft(18, "0")
                                    'Exit For
                                End If
                                If strSplitMate(x).PadLeft(18, "0") = strMaterialEnt And Not blnMatEntEncontrado Then
                                    blnMatEntEncontrado = True
                                End If
                                If blnEncontrado And blnMatEntEncontrado Then
                                    Exit For
                                End If
                            Next x

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strMatEncontrado : " & Funciones.CheckStr(strMatEncontrado))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     blnEncontrado : " & Funciones.CheckStr(blnEncontrado))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strMaterialEnt : " & Funciones.CheckStr(strMaterialEnt))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     blnMatEntEncontrado : " & Funciones.CheckStr(blnMatEntEncontrado))

                            If blnMatEntEncontrado Then

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "== Equipo entrante iphone [Material entrante] [" & strMaterialEnt & "]")
                                Dim blnResEjecucion As Boolean = False
                                Dim strAccion As String = "0"

                                Dim telefonoAP As String = "51" + IIf(dsDatosPedido.Tables(1).Rows(0).IsNull("DEPEV_NROTELEFONO"), "", dsDatosPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO"))

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     telefonoAP : " & telefonoAP)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     StrMotivoDevolSW : " & StrMotivoDevolSW)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strSerie_entrante : " & strSerie_entrante)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strSerie_saliente : " & strSerie_saliente)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strMaterial : " & strMaterial)

                                Dim StrCodigoMotivo As String = Funciones.CheckStr(dtConsultaCanjeSW.Rows(0).Item("CANJV_MOTIVO"))
                                Dim TipoOper_Devol As String = Funciones.CheckStr(COM_SIC_Seguridad.ReadKeySettings.Key_TipoOper_Devol)
                                Dim dtResultMotivo As DataTable
                                Dim objConsultaPvu As New COM_SIC_Activaciones.clsConsultaPvu
                                Dim dr As System.Data.DataRow
                                Dim StrDescripcionMotivo As String
                                Dim strIccid_baja As String = Funciones.CheckStr(dsDatosPedido.Tables(1).Rows(0).Item("SERIC_CODSERIE")) '--GPRD
                                dtResultMotivo = objConsultaPvu.ConsultaMotivosCanje(TipoOper_Devol, "", 1, "", "")

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     StrCodigoMotivo : " & StrCodigoMotivo)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     TipoOper_Devol : " & TipoOper_Devol)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strIccid_baja : " & strIccid_baja)

                                Dim e As Integer = 0
                                For Each dr In dtResultMotivo.Rows
                                    If dtResultMotivo.Rows(e).Item("MOTI_CODIGO") = StrCodigoMotivo Then
                                        StrDescripcionMotivo = dtResultMotivo.Rows(e).Item("MOTI_DESCRIP")
                                        Exit For
                                    End If
                                    e += 1
                                Next
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     StrDescripcionMotivo : " & StrDescripcionMotivo)
                                If blnEncontrado = True Then
                                    blnResEjecucion = ejecutarConsultarProcesarIOT(telefonoAP, StrDescripcionMotivo, strIdentifyLog, strAccion, strSerie_entrante, strSerie_saliente, strIccid_baja) '//ACTUALIZAR IMEI IOT
                                Else
                                    strAccion = "1"
                                    blnResEjecucion = ejecutarConsultarProcesarIOT(telefonoAP, StrDescripcionMotivo, strIdentifyLog, strAccion, strSerie_entrante, strSerie_saliente, strIccid_baja) '//BAJA DEL SERVICIO SW
                                End If

                                If Not blnResEjecucion Then
                                    '//mensaje = IIf(strAccion = 0, "ACTUALIZAR el", "EJECUTAR BAJA del")
                                    'Session("MensajeErrorPagoCanjeAW") = "Ha ocurrido un error al " & mensaje & " servicio Apple Watch de la linea " & telefonoAP & " en IOTDB"
                                    AppMensajeErrorPagoCanjeAW = "Ha ocurrido un error al invocar el servicio bssiotconsultasprocesos"
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & Funciones.CheckStr(AppMensajeErrorPagoCanjeAW))
                                End If
                            Else
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "== Equipo entrante no es iphone : " & strMaterialEnt)
                            End If
                        Catch ex As Exception
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR INESPERADO EN EL FLUJO AW")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR AW " & ex.Message)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR AW " & ex.StackTrace)
                        End Try
                    Else
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "############################ NO ES PAGO DE CANJE APPLE WATCH ############################")
                    End If
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "############################ FIN BLOQUE APPLE WATCH ############################")
                    '//PROY-140379 FIN
                    Try
                        If K_DESLOG <> "OK" Then
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " ERROR: " & K_DESLOG)
                            blnErrorPago = True
                        End If
                    Catch ex As Exception
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "ERROR : " & ex.Message.ToString())
                    End Try

                    strDocSunat = strNumAsignado
                End If

                wParam5 = 1
                wParam6 = "Registro de Pago"
                strErrorMsg = ""

                'PROY-26366-IDEA-34247 FASE 1
                If K_DESLOG = "OK" Then
                    Try
                        'PROY-26366 LOG - INI
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INI Tipificaciones_general_canje() ")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "dsDatosPedido:  " & dsDatosPedido.ToString())
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Var_Corr6:  " & Var_Corr6)
                        Tipificaciones_general_canje(dsDatosPedido, Var_Corr6)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FIN Tipificaciones_general_canje() ")

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INI Tipificaciones_general_renovacionPre() ")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "dsDatosPedido:  " & dsDatosPedido.ToString())
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Var_Corr6:  " & Var_Corr6)
                        Tipificaciones_general_renovacionPre(dsDatosPedido, Var_Corr6)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FIN Tipificaciones_general_renovacionPre() ")



                        'PROY 140743 VC INI'
                        Dim CuotaAcc As Integer = dsDatosPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA")

                        If CuotaAcc > 0 Then
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "No se realiza Tipificaciones_general_VentasVarios() ")
                        Else
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INI Tipificaciones_general_VentasVarios() ")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "dsDatosPedido:  " & dsDatosPedido.ToString())
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Var_Corr6:  " & Var_Corr6)

                        Tipificaciones_general_VentasVarios(dsDatosPedido, Var_Corr6)

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FIN Tipificaciones_general_VentasVarios() ")
                        End If

                        If sTipoOperacion = ConfigurationSettings.AppSettings("COD_TIPO_OPERACION_VENTA_VARIOS") And CuotaAcc > 0 Then

                            Dim serieIccid As String = dsPedido.Tables(1).Rows(0).Item("SERIC_CODSERIE")
                            Dim desMaterial As String = dsDatosPedido.Tables(1).Rows(0).Item("DEPEV_DESCMATERIAL")
                            Dim NroComprobante As String = Funciones.CheckStr(K_CU_CORRELATIVOFE)
                            Dim nombreServer As String = System.Net.Dns.GetHostName
                            Dim strIpServer As String = System.Net.Dns.GetHostByName(nombreServer).AddressList(0).ToString


                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Parametros TipificacionVtaCuo")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "NroPedido:  " & strDocSap)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "NroComprobante:  " & NroComprobante)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "SERIE:  " & serieIccid)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "DESMATERIAL:  " & desMaterial)
                            TipificacionVtaAccCuo(strDocSap, NroComprobante, serieIccid, desMaterial, strIpServer)
                        End If
                        'PROY 140743 VC FIN'
                        'PROY-26366 LOG - FIN
                    Catch ex As Exception

                    End Try

                End If

                If K_DESLOG <> "OK" Then
                    strErrorMsg = K_DESLOG & "Error al Pago"

                    wParam5 = 0
                    wParam6 = "Error en registro de Pago." & strErrorMsg
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INI DeshacerCambiosFlujoDeCaja() ")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "IN P_ID_TI_VENTAS_FACT  " & P_ID_TI_VENTAS_FACT.ToString())
                    DeshacerCambiosFlujoDeCaja(P_ID_TI_VENTAS_FACT, drPagos.Item("PEDIN_NROPEDIDO"))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FIN DeshacerCambiosFlujoDeCaja() ")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR : " & strErrorMsg)
                End If

                If blnSunat Then
                    If K_DESLOG = "OK" Then
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Valida si el pedido es una recarga virtual.")
                        'RecargaVirtual
                        'If Session("recargaVirtual") Then       'se agrego esta variable session
                        '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Ejecuta el mètodo : Recarga ")
                        '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- strNumAsignado: " & Funciones.CheckStr(strNumAsignado).ToString)
                        '    Recarga(strNumAsignado)
                        '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Fin del mètodo recarga.")
                        'End If

                        RenovacionModemPrepago(dsPedido, drPagos.Item("PEDIN_NROPEDIDO"), "") 'Verificar

                        ' Validacion Cambio de SIM 
                        Dim tipoOperacion_PackPrepago As String = ConfigurationSettings.AppSettings("COD_OPERACION_RENOVACION")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Tipo Operacion : " & ConfigurationSettings.AppSettings("strDTVReposicionChip"))
                        If (sTipoOperacion = ConfigurationSettings.AppSettings("strDTVReposicionChip") Or sTipoOperacion = tipoOperacion_PackPrepago) Then

                            objFileLog.Log_WriteLog(pathFile, strArchivo, "Tipo Venta : " & ConfigurationSettings.AppSettings("strTVPostpago"))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "Entro Tipo Operacion : " & sTipoOperacion)
                            If sTipoVenta = ConfigurationSettings.AppSettings("strTVPostpago") Then
                                objFileLog.Log_WriteLog(pathFile, strArchivo, "Entro Tipo Venta : " & sTipoVenta)
                                ActivaChipRespuestoPostPago(drPagos.Item("PEDIN_NROPEDIDO"), dsPedido)
                            Else
                                'PREPAGO
                                objFileLog.Log_WriteLog(pathFile, strArchivo, "Entro Tipo Venta : " & sTipoVenta)
                                ActivaChipRepuesto(drPagos.Item("PEDIN_NROPEDIDO"), strDocSunat, sTipoVenta, sTipoOperacion)
                            End If
                        End If

                        AppmensajeCHIPRepuesto = ""

                    End If
                End If

                'E76009 CEGP INICIO ***********************************************************************************'
                If Not Len(Trim(strErrorMsg)) > 0 Then
                    registro_ventas(dsPedido, strIdentifyLog)
                End If
                'E76009 CEGP FIN************************************************************************************

                '' Roaming 
                If Not Len(Trim(strErrorMsg)) > 0 Then
                    InsertarPlanRoaming(drPagos.Item("PEDIN_NROPEDIDO"))
                End If


                AppCarga = 0
                hidFlagCargaDoc = AppCarga


                If Len(Trim(strErrorMsg)) > 0 Then     'se produjo algun error al momento de pagar
                    'Response.Write("<script>alert('" & strErrorMsg & "')</script>")
                    AppstrMensajeCaja = strErrorMsg
                    '/*----------------------------------------------------------------------------------------------------------------*/
                    '/*--JR  INICIO  -  PROY-29380 IDEA-38934 - Iteración 2 y 3 2da Fase Sinergia Adec en Sist de Venta y Post-Venta --*/
                    '/*----------------------------------------------------------------------------------------------------------------*/
                    If Not AppmsgErrorDevolverRV Is Nothing And AppmsgErrorDevolverRV <> "" Then
                        'Session.Remove("strMensajeCaja")
                        AppstrMensajeCaja = String.Empty
                    End If
                    '/*----------------------------------------------------------------------------------------------------------------*/
                    '/*--JR  INICIO  -  PROY-29380 IDEA-38934 - Iteración 2 y 3 2da Fase Sinergia Adec en Sist de Venta y Post-Venta --*/
                    '/*----------------------------------------------------------------------------------------------------------------*/
                    'Response.Redirect("PoolPagos.aspx", False)
                    'Response.End()
                    AppCodigoExitFunction = "-2"
                    AppMensajeExitFunction = AppstrMensajeCaja
                    Exit Function
                Else
                    '''''''''''''''''''''''
                    ' Inicio IDEA-11056 Renovación TFI para CAC's
                    BonoRenovacionTFI(drPagos.Item("PEDIN_NROPEDIDO"), dsPedido, C_VENTA, C_VENTA_DET)
                    ' Fin IDEA-11056 Renovación TFI para CAC's 

                    ' If dsPedido.Tables(0).Rows(0).Item("TIPO_VENTA") = ConfigurationSettings.AppSettings("strTVPrepago") Then TODOEB
                    If drPagos.Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVPrepago") Then
                        ' Dim objFileLog As New SICAR_Log
                        ' Dim nameFile As String = ConfigurationSettings.AppSettings("constNameLogWSBABB")
                        ' Dim pathFile As String = ConfigurationSettings.AppSettings("constRutaLogWSBABB")
                        ' Dim strArchivo As String = objFileLog.Log_CrearNombreArchivo(nameFile)
                        ' Dim strIdentifyLog As String = drPagos.Item("VBELN")      'strNroPedidoSAP
                        Dim strParametros As String = ""
                        For k As Integer = 0 To dsPedido.Tables(1).Rows.Count - 1
                            Dim strArregloCadena As String = ""
                            strArregloCadena = ConfigurationSettings.AppSettings("strComboAnualBbPrepago") 'modificar key
                            Dim arrCadenas As String() = strArregloCadena.Split(";")
                            For m As Integer = 0 To UBound(arrCadenas)
                                'TODOEB
                                'If dsPedido.Tables(1).Rows(k).Item("ARTICULO") = arrCadenas(m) Then       ' SERCOANPRE

                                '(validar porque no es necesario usar del pvu la consulta)

                                If Not dsPedido.Tables(1) Is Nothing Then
                                    If Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("DEPEC_CODMATERIAL")) = arrCadenas(m) Then       ' SERCOANPRE
                                        Dim obj As New clsBonoComboAnualBB
                                        Dim intRst As Integer
                                        Dim strErrorMsj As String
                                        Dim usuarioBB As String = ConfigurationSettings.AppSettings("strUsuarioBB")
                                        Dim AplicacionRTC As String = ConfigurationSettings.AppSettings("strAplicacionRTC")
                                        Dim strMensajeBB As String
                                        Dim telefono As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("DEPEV_NROTELEFONO"))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio WS Bono Combo Anual BalckBerry.")
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Oficina Venta : " & AppAlmacen & " - " & AppOFICINA)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Usuario : " & AppUsuario)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo bonoBlackberryPrepago()")
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Parametros INP: telefono " & FormatoTelefono(telefono) & "")

                                        intRst = obj.bonoBlackberryPrepago(FormatoTelefonoPrepago(telefono), ConfigurationSettings.AppSettings("urlComboAnualBbPrepago"), Integer.Parse(ConfigurationSettings.AppSettings("timeOutComboAnualBbPrepago")), usuarioBB, AplicacionRTC, strMensajeBB)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Parametros OUT: " & intRst)
                                        If intRst = 0 Then
                                            strErrorMsj = "Operación Exitosa\nEl bono lo seguirá recibiendo los 10 de cada mes."
                                            'Session.Add("strMensajeWSCABB", strErrorMsj)
                                            AppstrMensajeWSCABB = strErrorMsj
                                        ElseIf intRst = 1 Then
                                            strErrorMsj = "Ha ocurrido un error, se procede con la venta\n"
                                            'Session.Add("strMensajeWSCABB", strErrorMsj & " " & ValidaCadena(strMensajeBB))
                                            AppstrMensajeWSCABB = strErrorMsj
                                        Else
                                            strErrorMsj = "Error\nOcurrio un error inesperado."
                                            'Session.Add("strMensajeWSCABB", strErrorMsj & " " & ValidaCadena(strMensajeBB))
                                            AppstrMensajeWSCABB = strErrorMsj
                                        End If
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje:" & strErrorMsj)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje:" & ValidaCadena(strMensajeBB))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo bonoBlackberryPrepago()")
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin WS Bono Combo Anual BalckBerry.")
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                                    End If
                                End If
                            Next

                            'Activacion Bono Anual TFI  (validar porque no es necesario usar del pvu la consulta)
                            'CONFIRMAR
                            'If dsPedido.Tables(1).Rows(k).Item("ARTICULO") = ConfigurationSettings.AppSettings("strCodArticuloBonoAnualTFI").ToString() Then
                            If Not dsPedido.Tables(1) Is Nothing Then
                                If Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("DEPEC_CODMATERIAL")) = ConfigurationSettings.AppSettings("strCodArticuloBonoAnualTFI").ToString() Then
                                    Dim objActivacion As New COM_SIC_Activaciones.clsActivacion
                                    Dim strCodRespuesta As String
                                    Dim strMsg As String = ""
                                    Dim telefono As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("DEPEV_NROTELEFONO"))
                                    Dim nombreServer As String = System.Net.Dns.GetHostName
                                    Dim IPAplicacion As String = System.Net.Dns.GetHostByName(nombreServer).AddressList(0).ToString
                                    Dim strAplicacion As String = ConfigurationSettings.AppSettings("constAplicacion").ToString()
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio WS EjecutarBonoAnualTFI.")
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                                    'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " INP DEPEV_NROTELEFONO:" & FormatoTelefono(dsPedido.Tables(1).Rows(k).Item("CLIEV_TELEFONOCLIENTE")))
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " INP DEPEV_NROTELEFONO:" & FormatoTelefono(telefono))
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " INP idTransaccion:" & strDocSap)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " INP IPAplicacion:" & IPAplicacion)

                                    strCodRespuesta = objActivacion.EjecutarBonoAnualTFI(FormatoTelefono(telefono), strDocSap, IPAplicacion, strAplicacion, strMsg)

                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " OUT strCodRespuesta:" & strCodRespuesta)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " OUT strMsg:" & strMsg)
                                    objActivacion = Nothing

                                    If strCodRespuesta = "0" Then
                                        strMsg = "Operación Exitosa\nSe realizó el registro del Bono Anual TFI."
                                        'Session.Add("strMensajeWSCABB", strMsg)
                                        AppstrMensajeWSCABB = strMsg
                                    ElseIf strCodRespuesta = "2" Or strCodRespuesta = "3" Or strCodRespuesta = "4" Then
                                        ' Session.Add("strMensajeWSCABB", strMsg)
                                        AppstrMensajeWSCABB = strMsg
                                    Else
                                        strMsg = "Ha ocurrido un error en el registro del Bono Anual TFI.\n"
                                        'Session.Add("strMensajeWSCABB", strMsg)
                                        AppstrMensajeWSCABB = strMsg
                                    End If
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin WS EjecutarBonoAnualTFI.")
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")

                                End If
                            End If
                        Next
                    End If

                    'Miguel - Activación de  equipos TFI
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "TIPO_VENTA: " & drPagos.Item("PEDIC_TIPOVENTA"))
                    'If dsPedido.Tables(0).Rows(0).Item("TIPO_VENTA") = ConfigurationSettings.AppSettings("strTVTFI") And booDol = True  Then
                    ' Validar si ahora los tipos de venta TFI como se considera en el modulo

                    ''Queda Pendiente TFI
                    'If cod_Prod_TFI = ConfigurationSettings.AppSettings("Cod_Producto_Prepago_TFI") Or _
                    '   tipo_venta_pvu = ConfigurationSettings.AppSettings("strTVTFI") Then

                    'End If
                    If drPagos.Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVTFI") Then
                        'Miguel - Variables para Log
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Activacion TFI")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")

                        Dim transaccion As String = ConfigurationSettings.AppSettings("strActivacionTFI")
                        Dim codUsuario As String = AppCodUsuario
                        Dim strIPServidor As String = AppREMOTE_ADDR
                        Dim strNombreServidor As String = AppSERVER_NAME
                        Dim strIPCliente As String = AppUserHostAddress
                        Dim strNombreCliente As String = System.Net.Dns.GetHostByAddress(strIPCliente).HostName

                        Dim objActivacion As New COM_SIC_Activaciones.clsActivacion
                        Dim objLog As New COM_SIC_Cajas.clsLog

                        Dim resultadoLineasActivadas As String = ""
                        Dim numerosValidados As String = ""

                        Dim dsParam As DataSet

                        Dim objSicarDB As New COM_SIC_Cajas.clsCajas
                        Dim strGrupo As String = ConfigurationSettings.AppSettings("strGrupoTFI")

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio FP_ConsultaParametros")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     Inp: " & strGrupo)
                        dsParam = objSicarDB.FP_ConsultaParametros(strGrupo)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     OUT CantidadRegistros:  " & Funciones.CheckStr(dsParam.Tables(0).Rows.Count))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin FP_ConsultaParametros")
                        objSicarDB = Nothing

                        Dim k As Integer


                        ''''C_VENTA_DET
                        For k = 0 To dsPedido.Tables(1).Rows.Count - 1
                            'For k = 0 To C_VENTA_DET.Rows.Count - 1
                            Dim strNumero As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("DEPEV_NROTELEFONO"))
                            'Dim strNumero As String = C_VENTA_DET.Rows(k).Item("TELEFONO")
                            'Dim strPreciosUti As String = C_VENTA_DET.Rows(k).Item("LISTA_PRECIO") 'dsPedido.Tables(1).Rows(k).Item("UTILIZACION")
                            Dim strPreciosUti As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("DEPEV_CODIGOLP"))
                            Dim strFormaPago As String = ""       '1 -Contado : 2- Cuotas
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strNumero: " & strNumero)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strPreciosUti(buscar): " & strPreciosUti)

                            If Not IsNothing(dsParam) AndAlso dsParam.Tables(0).Rows.Count > 0 Then
                                For idx As Integer = 0 To dsParam.Tables(0).Rows.Count - 1
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     OUT SPARV_KEY:  " & Funciones.CheckStr(dsParam.Tables(0).Rows(idx).Item("SPARV_KEY")))
                                    If Funciones.CheckStr(dsParam.Tables(0).Rows(idx).Item("SPARV_KEY")).Equals(strPreciosUti) Then
                                        strFormaPago = Funciones.CheckStr(dsParam.Tables(0).Rows(idx).Item("SPARV_VALUE"))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     OUT SPARV_VALUE:  " & Funciones.CheckStr(dsParam.Tables(0).Rows(idx).Item("SPARV_VALUE")))
                                        Exit For
                                    End If
                                Next
                            End If

                            Dim strParamsIn As String
                            Dim strParamsOut As String
                            Dim strResultado As String
                            Dim strMensajeTFI As String
                            Dim strTransaccion As String
                            If strNumero <> String.Empty Or strNumero.ToString <> "" Or strFormaPago <> String.Empty Then
                                If numerosValidados.IndexOf(CDbl(strNumero).ToString()) = -1 Then
                                    Try
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio FK_EjecutarActivacionTFI")
                                        strParamsIn = "telefono: " + CDbl(strNumero).ToString() + " opcion: " + strFormaPago
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strParamsIn: " & strParamsIn)

                                        Call objActivacion.FK_EjecutarActivacionTFI(CDbl(strNumero).ToString(), strFormaPago, strResultado, strMensajeTFI, strTransaccion)

                                        strParamsOut = "resultado: " + strResultado + " Mensaje: " & strMensajeTFI & " transaccion: " + strTransaccion
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strParamsOut: " & strParamsOut)
                                        objLog.FK_RegistrarLog(transaccion, codUsuario, strIPCliente, strNombreCliente, strIPServidor, strNombreServidor, strParamsIn, strParamsOut, "")
                                    Catch ex As Exception

                                        strParamsOut = "resultado: " + strResultado + " transaccion: " + strTransaccion

                                        'INI PROY-140126
                                        Dim MaptPath As String
                                        MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                                        MaptPath = "( Class : " & MaptPath & "; Function: guardarConectado)"
                                        objLog.FK_RegistrarLog(transaccion, codUsuario, strIPCliente, strNombreCliente, strIPServidor, strNombreServidor, strParamsIn, strParamsOut, ex.Message & MaptPath)
                                        'FIN PROY-140126
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     ERROR: " & ex.Message.ToString())
                                        strResultado = "1"
                                    Finally
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin FK_EjecutarActivacionTFI")
                                    End Try
                                    numerosValidados += CDbl(strNumero).ToString() & "|"
                                    If strResultado <> "0" Then
                                        resultadoLineasActivadas += CDbl(strNumero).ToString() & "|"
                                    End If
                                End If
                            End If
                        Next
                        If resultadoLineasActivadas.Trim <> "" Then
                            Dim arrLineas() As String = resultadoLineasActivadas.Split("|")
                            Dim x As Integer
                            Dim mensaje As String = ConfigurationSettings.AppSettings("msjeErrorActivarLinea")
                            For x = 0 To arrLineas.Length - 1
                                mensaje += "\n" & arrLineas(x)
                            Next
                            AppmensajeErrorLineas = mensaje
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Líneas TFI con ERROR en activación: " & resultadoLineasActivadas)
                        End If
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Activacion TFI")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")

                        'Migración Saldo TFI  PLSR -- Solo las líneas sin error en la activación
                        Dim conPag As New COM_SIC_Activaciones.clsMigracionSaldoGSMWS
                        Dim oDatosInteraccion As New clsDatosInteraccion
                        Try
                            Dim str_Aplicacion As String = ConfigurationSettings.AppSettings("constAplicacion").ToString
                            Dim idTransaccion As String = strDocSap
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Migración Saldo TFI")
                            'TODOEB      
                            '  For k = 0 To dsPedido.Tables(1).Rows.Count - 1
                            For k = 0 To dsPedido.Tables(1).Rows.Count - 1
                                'Dim strMaterial As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("DEPEC_CODMATERIAL")) 'TODOEB
                                Dim strMaterial As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("MATEV_CLASIFICACION"))
                                'Campania - Plan_final
                                'Dim strMaterial As String = C_VENTA_DET.Rows(k).Item("MATERIAL")

                                If strMaterial.StartsWith("PS") Then
                                    Dim str_Campana As String = Campania 'C_VENTA_DET.Rows(k).Item("CAMPANA") 'dsPedido.Tables(1).Rows(k).Item("CAMPANA")
                                    Dim str_Tarifa As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("DEPEV_CODIGOLP")) 'C_VENTA_DET.Rows(0).Item("LISTA_PRECIO") 'dsPedido.Tables(1).Rows(k).Item("UTILIZACION")

                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "CAMPANA: " & str_Campana)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "UTILIZACION: " & str_Tarifa)

                                    If (str_Campana = ConfigurationSettings.AppSettings("strCampanaMensual").ToString And str_Tarifa = ConfigurationSettings.AppSettings("strTarifaMensual").ToString) Or _
                                        (str_Campana = ConfigurationSettings.AppSettings("strCampanaAnual").ToString And str_Tarifa = ConfigurationSettings.AppSettings("strTarifaAnual").ToString) Then

                                        ' Dim strNumeroTelefono As String = FormatoTelefonoSinCeros(dsPedido.Tables(1).Rows(k).Item("CLIEV_TELEFONOCLIENTE"))
                                        Dim strNumeroTelefono As String = FormatoTelefonoSinCeros(Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("DEPEV_NROTELEFONO"))) 'FormatoTelefonoSinCeros(C_VENTA_DET.Rows(k).Item("TELEFONO"))

                                        Dim rpta As Integer = objCajas.Registrar_Migracion_Saldo(strNumeroTelefono)

                                        If resultadoLineasActivadas.IndexOf(strNumeroTelefono) = -1 Then
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Inicio de envio al WS Registrar Migracion")
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "NumeroTelefono: " & FormatoTelefono(C_VENTA_DET.Rows(k).Item("TELEFONO")))
                                            oDatosInteraccion = conPag.RegistrarMigracionSaldo(idTransaccion, strIPServidor, str_Aplicacion, codUsuario, strNumeroTelefono)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "CodigoRespuesta: " & oDatosInteraccion.Codigo_Respuesta)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "MensajeRespuesta: " & oDatosInteraccion.Mensaje_Respuesta())
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Fin de envio al WS Registrar Migracion")

                                            If oDatosInteraccion.Codigo_Respuesta <> "0" Then
                                                'Session.Add("msgErrorMigracionSaldoTFI", oDatosInteraccion.Mensaje_Respuesta())
                                                AppmsgErrorMigracionSaldoTFI = oDatosInteraccion.Mensaje_Respuesta()
                                            End If
                                        End If
                                    End If
                                End If
                            Next
                        Catch ex As Exception
                            'INI PROY-140126
                            Dim MaptPath As String
                            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                            MaptPath = "( Class : " & MaptPath & "; Function: guardarConectado)"
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "ERROR: " & ex.Message.ToString() & MaptPath)
                            'FIN PROY-140126
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "ERROR: " & ex.StackTrace.ToString())
                            'Session.Add("msgErrorMigracionSaldoTFI", "Error al realizar migración de saldo TFI.")
                            AppmsgErrorMigracionSaldoTFI = "Error al realizar migración de saldo TFI."
                        Finally
                            oDatosInteraccion = Nothing
                            conPag = Nothing
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Migración Saldo TFI")
                        End Try
                    End If

                    ' Registro Renovacion RPM6
                    Dim strTelefono As String
                    Dim strCodArticulo As String


                    'If dsPedido.Tables(0).Rows(0).Item("TIPO_VENTA") = ConfigurationSettings.AppSettings("strTVPrepago") Then
                    'Validar que se podria utilizar la data del modulo 
                    If drPagos.Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVPrepago") Then
                        ' For idx As Integer = 0 To dsPedido.Tables(1).Rows.Count - 1
                        If Not dsPedido.Tables(1) Is Nothing Then
                            For idx As Integer = 0 To dsPedido.Tables(1).Rows.Count - 1
                                strCodArticulo = Funciones.CheckStr(dsPedido.Tables(1).Rows(idx).Item("DEPEC_CODMATERIAL"))
                                strTelefono = Funciones.CheckStr(dsPedido.Tables(1).Rows(idx).Item("DEPEV_NROTELEFONO"))
                                If strCodArticulo = ConfigurationSettings.AppSettings("strCodArticuloRenovacion") Then
                                    RegistrarPagoRenovacionRPM6(strTelefono)
                                End If
                            Next
                        End If
                    End If
                    ' Registro Renovacion RPM6

                    'Renovacion Corporativa
                    'If dsPedido.Tables(0).Rows(0).Item("TIPO_VENTA") = ConfigurationSettings.AppSettings("strTVPostpago") Then
                    If drPagos.Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVPostpago") Then

                        ' Dim p_nro_pedido As String = dsPedido.Tables(0).Rows(0).Item("DOCUMENTO") TODOEB
                        Dim p_nro_pedido As String = dsPedido.Tables(0).Rows(0).Item("PEDIN_NROPEDIDO")

                        'Renovacion B2E
                        'If dsPedido.Tables(0).Rows(0).Item("CLASE_VENTA") = ConfigurationSettings.AppSettings("constCodRenovB2E") Then
                        If dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION") = ConfigurationSettings.AppSettings("constCodRenovB2E") Then
                            GrabarPagoRenovacion(p_nro_pedido, "B2E")
                            GrabarRenovCorpBSCS(p_nro_pedido, "B2E")
                        End If

                        'Renovacion Business
                        'If dsPedido.Tables(0).Rows(0).Item("CLASE_VENTA") = ConfigurationSettings.AppSettings("constCodRenovBus") Then
                        If dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION") = ConfigurationSettings.AppSettings("constCodRenovBus") Then

                            'If dsPedido.Tables(0).Rows(0).Item("TIPO_DOC_CLIENTE") = ConfigurationSettings.AppSettings("constDocClienteBus") Then
                            If dsPedido.Tables(0).Rows(0).Item("CLIEC_TIPODOCCLIENTE") = ConfigurationSettings.AppSettings("constDocClienteBus") Then
                                GrabarPagoRenovacion(p_nro_pedido, "B2E")
                                GrabarRenovCorpBSCS(p_nro_pedido, "B2E")
                            End If
                        End If
                    End If
                    'Renovacion Corporativa

                    'Miguel - Activación de ciertos equipos PREPAGO                
                    Dim resultadoLineasNoActivadas As String = ""
                    If dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVPrepago") Then
                        Try
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Activacion Bono Prepago Especial")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")

                            Dim k As Integer
                            'For k = 0 To dsPedido.Tables(1).Rows.Count - 1
                            If Not dsPedido.Tables(1) Is Nothing Then
                                'For k = 0 To C_VENTA_Prepago.Rows.Count - 1
                                For k = 0 To dsPedido.Tables(1).Rows.Count - 1
                                    'Dim strEquipo As String = C_VENTA_DET.Rows(k).Item("MATERIAL")
                                    'Dim strNumero As String = FormatoTelefono(C_VENTA_DET.Rows(k).Item("TELEFONO"))
                                    'Dim strListaPrecio As String = C_VENTA_DET.Rows(0).Item("LISTA_PRECIO") 'dsPedido.Tables(1).Rows(k).Item("UTILIZACION")
                                    'Dim strCampana As String = C_VENTA_DET.Rows(0).Item("PLAN") 'dsPedido.Tables(1).Rows(k).Item("CAMPANA")
                                    Dim strEquipo As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("DEPEC_CODMATERIAL")) 'modulo
                                    Dim strNumero As String = FormatoTelefono(Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("DEPEV_NROTELEFONO"))) 'modulo
                                    Dim strListaPrecio As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("DEPEV_CODIGOLP"))  'modulo dsPedido.Tables(1).Rows(k).Item("UTILIZACION")
                                    Dim clase_Material As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("MATEV_CLASIFICACION"))
                                    Dim strCampana As String = Campania 'dsPedido.Tables(1).Rows(k).Item("CAMPANA")
                                    Dim strResultado As String
                                    'I-plsr
                                    Dim strGrupoConEquipo = ConfigurationSettings.AppSettings("constGrupoPrepagoEspecial")
                                    Dim strGrupoSinEquipo = ConfigurationSettings.AppSettings("constGrupoPrepagoEspecialSinEquipo")
                                    'F-plsr
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		strEquipo(" & k & "): " & strEquipo)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		strNumero(" & k & "): " & strNumero)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		strListaPrecio(" & k & "): " & strListaPrecio)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		strCampana(" & k & "): " & strCampana)

                                    If clase_Material.StartsWith("PS") Then  'chips
                                        Dim blnConEquipo As Boolean
                                        blnConEquipo = validaVentaEquipo(strNumero, dsPedido.Tables(1)) ' CURSOR FDEL DETALLE DEL PEDIDO
                                        Try
                                            Dim CodOpcion As String
                                            If blnConEquipo Then
                                                CodOpcion = Get_CodOpcionBBA(strEquipo, strListaPrecio, strCampana, strGrupoConEquipo, strDocSap)
                                            Else
                                                CodOpcion = Get_CodOpcionBBA(strEquipo, strListaPrecio, strCampana, strGrupoSinEquipo, strDocSap)
                                            End If
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		blnConEquipo: " & blnConEquipo)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		CodOpcion: " & CodOpcion)

                                            If CodOpcion <> "" Then
                                                strResultado = EjecutarActivacionBono(strNumero, CodOpcion, strDocSap)
                                            Else
                                                strResultado = "999"  ' No es prepago especial
                                            End If
                                        Catch ex As Exception
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error : " & ex.Message.ToString())
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error : " & ex.StackTrace.ToString())
                                            strResultado = "1"        'Se cambió Codigo Error 0:OK  
                                        End Try

                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		strResultado: " & strResultado)

                                        Dim strMensajeRes As String
                                        If strResultado <> "999" And strResultado <> "0" Then
                                            Dim dsValConfirma As DataSet
                                            Dim l As Integer
                                            dsValConfirma = ValMensajeParametros(strDocSap)

                                            'Se obtiene el mensaje por código de respuesta (tabla de parámetros)
                                            For l = 0 To dsValConfirma.Tables(0).Rows.Count - 1
                                                If strResultado = dsValConfirma.Tables(0).Rows(l).Item("SPARV_KEY") Then
                                                    strMensajeRes = dsValConfirma.Tables(0).Rows(l).Item("SPARV_VALUE")
                                                    Exit For
                                                End If
                                            Next
                                            resultadoLineasNoActivadas += CDbl(strNumero).ToString() & " " & strMensajeRes & "|"
                                        End If
                                    End If
                                Next
                            End If

                            If resultadoLineasNoActivadas.Trim <> "" Then
                                Dim arrLineas() As String = resultadoLineasNoActivadas.Split("|")
                                Dim x As Integer
                                Dim mensaje As String '= ConfigurationSettings.AppSettings("msjeErrorActivarLinea")
                                For x = 0 To arrLineas.Length - 1
                                    mensaje += arrLineas(x) & "\n"
                                Next
                                AppmensajeErrorLineas = mensaje
                            End If
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		mensajeErrorLineas: " & Funciones.CheckStr(AppmensajeErrorLineas))

                        Catch ex As Exception
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		ERROR: " & ex.Message.ToString())
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		ERROR: " & ex.StackTrace.ToString())
                        Finally
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Activacion Bono Prepago Especial")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                        End Try
                    End If
                    'Fin de Activación de los PREPAGOS

                    AppnumeroTelefonoPel = ""
                    ' E75893 - Registro de DOL y Creacion Interaccion solo Ventas Altas Prepago
                    If ValidacionVentaDOL(drPagos.Item("PEDIN_NROPEDIDO"), CStr(drPagos.Item("PEDIN_NROPEDIDO"))) Then
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "VBELN: " & Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ALMACEN: " & AppAlmacen)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "txtNumSunat: " & txtNumSunat.Trim)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FKDAT: " & DateTime.Now)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "sTipoOperacion: " & sTipoOperacion)
                        'RegistrarDOL(drPagos.Item("VBELN"), resultadoLineasNoActivadas) TODOEB
                        'RegistrarDOL(drPagos.Item("PEDIN_NROPEDIDO"), resultadoLineasNoActivadas, True, strTelefonoNumero, strRegistroDOLRespuesta)
                        'PROY-24388 RAR INICIO
                        Dim strDescripcionError As String = ""
                        Dim strTelefonoNumero = String.Empty
                        Dim strRegistroDOLRespuesta = String.Empty
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo pagarCAC() " & CStr(drPagos.Item("PEDIN_NROPEDIDO")))
                        If (pagarCAC(drPagos.Item("PEDIN_NROPEDIDO"), AppAlmacen, txtNumSunat.Trim, DateTime.Now, sTipoOperacion, strDescripcionError, strTelefonoNumero, strRegistroDOLRespuesta)) = False Then
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Respuesta Pagar CAC: " & strDescripcionError)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Nro Telefono: " & strTelefonoNumero)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Respuesta Registro Dol: " & strRegistroDOLRespuesta)
                            'Session.Add("msgActivacionCAC", strDescripcionError)
                            AppmsgActivacionCAC = strDescripcionError
                        Else
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Respuesta Pagar CAC: " & strDescripcionError)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Nro Telefono: " & strTelefonoNumero)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Respuesta Registro Dol: " & strRegistroDOLRespuesta)
                            'Session.Add("msgActivacionCAC", strDescripcionError)
                            AppmsgActivacionCAC = strDescripcionError
                            RegistrarDetalleDOL(drPagos.Item("PEDIN_NROPEDIDO"), resultadoLineasNoActivadas, True)
                            RegistrarCobertura(strIdentifyLog, int64IdVenta, strTelefonoNumero, strDocumentoIdentidadNumero)

                            Dim strVentaTipo As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA"))
                            Dim strVentaPrepago As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("strTVPrepago"))
                            If blnPagoRealizado And strVentaTipo.Equals(strVentaPrepago) Then
                                RegistrarAceptacionContrato(strIdentifyLog, strTelefonoNumero, strRegistroDOLRespuesta)
                            End If
                        End If
                        'PROY-24388 RAR FIN
                    End If

                    'Bono Renovacion Prepago - Ugo Blanco
                    If blnSunat Then
                        If (dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVPrepago")) And _
                                 (ConfigurationSettings.AppSettings("Tipo_operacion_Reno_bono_Pre").IndexOf(Funciones.CheckStr(tipo_venta_pvu)) > -1) Then
                            'Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION")) = ConfigurationSettings.AppSettings("strDTVRenovacion") Then

                            Dim vIdTransaccion, vMsisdn, vImei, vArticulo, vRespuesta, vRespuestaMsj, vMensaje As String
                            Dim Pedido_reno As String = ""
                            'TODOEB
                            '  vIdTransaccion = CStr(drPagos.Item("PEDIDO"))
                            vIdTransaccion = CStr(drPagos.Item("PEDIN_NROPEDIDO"))
                            'For k As Integer = 0 To dsPedido.Tables(1).Rows.Count - 1

                            Try
                                If Not dsPedido.Tables(1) Is Nothing Then
                                    If dsPedido.Tables(1).Rows.Count = 1 Then
                                        'For k As Integer = 0 To dsPedido.Tables(1).Rows.Count - 1
                                        '    If (Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("MATEC_TIPOMATERIAL")) = ConfigurationSettings.AppSettings("constPacks")) Then
                                        '        vMsisdn = "51" & Right(dsPedido.Tables(1).Rows(k).Item("DEPEV_NROTELEFONO"), 9)
                                        '        vImei = Right(dsPedido.Tables(1).Rows(k).Item("SERIC_CODSERIE"), 15)
                                        '        vArticulo = dsPedido.Tables(1).Rows(k).Item("DEPEC_CODMATERIAL")
                                        '    End If
                                        'Next
                                        If (Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("MATEC_TIPOMATERIAL")) = ConfigurationSettings.AppSettings("constPacks")) Then
                                            Pedido_reno = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("MATEC_TIPOMATERIAL"))
                                            vMsisdn = "51" & Right(dsPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO"), 9)
                                            vImei = Right(dsPedido.Tables(1).Rows(0).Item("SERIC_CODSERIE"), 15)
                                            vArticulo = dsPedido.Tables(1).Rows(0).Item("DEPEC_CODMATERIAL")
                                        Else
                                            Pedido_reno = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("MATEC_TIPOMATERIAL"))
                                            vMsisdn = ""
                                            vImei = ""
                                            vArticulo = ""
                                        End If
                                    End If
                                End If
                            Catch ex As Exception
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR : Bono Renovacion Prepago")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR : " & ex.Message.ToString())
                                vMsisdn = ""
                                vImei = ""
                                vArticulo = ""
                            End Try


                            'If ConfigurationSettings.AppSettings("ConsFlagRenovPrepago") Or _
                            '    InStr(1, ConfigurationSettings.AppSettings("ConsLineasRenovPrepago"), vMsisdn) > 0 Then
                            Dim montoVenta, montoVentaSinIgv, origenProceso As String

                            'PROY-31766 - INICIO'
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & vMsisdn & "- " & "IGV ACTUAL: " & dblValorIGVActual)
                            Dim constIGV As Double = dblValorIGVActual 'ObtenerIGVActual()
                            'PROY-31766 - FIN'
                            'montoVenta = CheckStr(CheckDbl(drPagos.Item("INPAN_TOTALDOCUMENTO")) * 100)
                            montoVenta = Funciones.CheckDbl(drPagos.Item("INPAN_TOTALDOCUMENTO"))
                            'montoVentaSinIgv = CheckStr((CheckDbl(drPagos.Item("TOTAL")) / (1 + constIGV)) * 100)TODOEB
                            montoVentaSinIgv = CheckStr(CheckDbl(drPagos.Item("INPAN_TOTALDOCUMENTO")) / (1 + constIGV))
                            'montoVentaSinIgv = CheckStr((CheckDbl(drPagos.Item("INPAN_TOTALDOCUMENTO")) / (1 + constIGV)) * 100)

                            origenProceso = ConfigurationSettings.AppSettings("WSBonoPrepago_codOrigenProceso")

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & vMsisdn & "- " & " montoVenta : " & montoVenta)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & vMsisdn & "- " & " montoVentaSinIgv : " & montoVentaSinIgv)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & vMsisdn & "- " & " origenProceso : " & origenProceso)

                            Dim input As String = String.Format("{0}|{1}|{2}|{3}|{4}|{5}", vMsisdn, vArticulo, vImei, montoVenta, montoVentaSinIgv, origenProceso)

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & vMsisdn & "- " & "Inicio Bono Renovación Prepago")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & vMsisdn & "- " & " MATEC_TIPOMATERIAL : " & Pedido_reno)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & vMsisdn & "- " & "  flag_ped_repo : " & flag_ped_repo)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & vMsisdn & "- " & "     nroLinea|material|imei|montoVenta|montoVentaSinIgv|origenProceso: " & input)

                            If Pedido_reno = ConfigurationSettings.AppSettings("constPacks") Then
                                'Registro Bono Prepago
                                Dim oRenovaPrepago As New COM_SIC_Activaciones.clsBonoRenovaPrepago
                                vRespuesta = oRenovaPrepago.AsignarBonoPrepago(vIdTransaccion, vMsisdn, vImei, vArticulo, montoVenta, montoVentaSinIgv, origenProceso, vRespuestaMsj)

                                'Consulta de Mensaje Renovación Prepago
                                Dim codGrupo As Integer = CInt(ConfigurationSettings.AppSettings("ConstGrupoMensajeAsignacion"))
                                Dim dsMensajes As DataSet = (New COM_SIC_Cajas.clsCajas).ObtenerParamByGrupo(codGrupo)
                                If Not IsNothing(dsMensajes) Then
                                    For i = 0 To dsMensajes.Tables(0).Rows.Count - 1
                                        Dim codigo As String = CheckStr(dsMensajes.Tables(0).Rows(i).Item("PARAV_VALOR")).Split("|")(0)
                                        Dim mensaje As String = CheckStr(dsMensajes.Tables(0).Rows(i).Item("PARAV_VALOR")).Split("|")(1)

                                        If codigo = vRespuesta Then
                                            vMensaje = String.Format(mensaje, vMsisdn)
                                            Exit For
                                        End If
                                    Next
                                End If

                                'Session.Add("mensajeErrorBonoPrepago", vMensaje)
                                AppmensajeErrorBonoPrepago = vMensaje

                                Dim out As String = String.Format("{0}|{1}|{2}", vRespuesta, vRespuestaMsj, vMensaje)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & vMsisdn & "- " & "     codSalida|msgSalida|Mensaje: " & out)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & vMsisdn & "- " & "Fin Bono Renovación Prepago")
                            Else
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & vMsisdn & "- " & "NO se asigno bono Renovacion, es Venta prepago y el tipo de material no es equipo o tiene 2 detalles")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & vMsisdn & "- " & "Fin Bono Renovación Prepago")
                            End If
                        End If
                    End If


                    'End If
                    'Bono Renovacion Prepago - Ugo Blanco

                    'roaming
                    Try
                        'Dim dsPedido As New DataSet
                        'dsPedido = (New SapGeneralNegocios).Get_ConsultaPedido("", Session("Almacen"), sDocumentoSap, "")
                        Dim dtDet As DataTable = CType(dsPedido.Tables(1), DataTable)
                        Dim nroTelefono = Right(Funciones.CheckStr(dtDet.Rows(0)("DEPEV_NROTELEFONO")), 9)
                        Dim Flag As String = "S"
                        Dim retorno As Int64 = 0
                        Dim mensaje As String = ""
                        objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & strDocSap & "- " & "Inicio Actualizacion Servicio Roaming")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & strDocSap & "- " & "Telefono: " & nroTelefono)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & strDocSap & "- " & "Flag: " & Flag)
                        objCajas.ActualizarServRoaming(strDocSap, nroTelefono, Flag, retorno, mensaje)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & strDocSap & "- " & "retorno: " & retorno)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & strDocSap & "- " & "mensaje: " & mensaje)
                    Catch ex As Exception
                        objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & strDocSap & "- " & "Error Actualizacion Servicio Roaming")
                    Finally
                        objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & strDocSap & "- " & "Fin Actualizacion Servicio Roaming")
                    End Try

                    'registro metricas
                    Try
                        'objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("VBELN") & "- " & "Inicio Registro de Metricas Ventas")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("PEDIN_NROPEDIDO") & "- " & "Inicio Registro de Metricas Ventas")
                        Dim oMet As New COM_SIC_Activaciones.clsActivacion
                        Dim oAudit As New ItemGenerico
                        Dim oCabecera As New ArrayList
                        Dim oDetalle As New ArrayList
                        Dim nomCob As String = ""
                        Dim filas As Integer

                        'strContrato = drPagos.Item("NRO_CONTRATO")TODOEB
                        '*********************************************************************************************************************************************************************'
                        '**Error, debido a que consulta el ID_Contrato en la tabla : sisact_info_venta_sap porl el numero del contrato del pedido => sap.nro_documento = p_nrodoc_sap
                        If Not objContrato Is Nothing Then
                            strContrato = objContrato.Tables(0).Rows(0).Item("ID_CONTRATO")
                            If Funciones.CheckInt(strContrato) > 0 Then
                                'dsAcuerdo = objPagos.Get_ConsultaAcuerdoPCS(strContrato)           'conexion SAP
                                dsAcuerdo = objClsConsultaPvu.ConsultaAcuerdoPCS(strContrato, DBNull.Value)
                            End If
                        End If
                        '*********************************************************************************************************************************************************************'

                        'objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("VBELN") & "- " & "Nro contrato" & "- " & strContrato)
                        'objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("VBELN") & "- " & "Inicio Registro de Metricas Ventas")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("PEDIN_NROPEDIDO") & "- " & "Nro contrato" & "- " & strContrato)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("PEDIN_NROPEDIDO") & "- " & "Inicio Registro de Metricas Ventas")
                        With oAudit
                            '.CODIGO = drPagos.Item("VBELN") TODOEB
                            .CODIGO = drPagos.Item("PEDIN_NROPEDIDO")
                            .CODIGO2 = CurrentUser
                            .DESCRIPCION = ConfigurationSettings.AppSettings("constAplicacion")
                            .DESCRIPCION2 = CurrentTerminal
                        End With
                        'obtenerDatosMetrica(dsPedido, dsAcuerdo, oCabecera, oDetalle) TODOE

                        Dim sDatosCabecera As String
                        For Each item As ItemGenerico In oCabecera
                            item.DESCRIPCION = item.DESCRIPCION.ToUpper()
                            sDatosCabecera &= item.CODIGO & ": " & item.DESCRIPCION & "|"
                        Next
                        Dim sDatosDetalle As String
                        For Each item As ItemGenerico In oDetalle
                            item.DESCRIPCION = item.DESCRIPCION.ToUpper()
                            sDatosDetalle &= item.CODIGO & ": " & item.DESCRIPCION & "|"
                        Next

                        'objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("VBELN") & "- " & "Inicio registrarMetricaVentas " & ConfigurationSettings.AppSettings("WSRegMetricaVenta_url")) TODOEB
                        'objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("VBELN") & "- " & "sDatosCabecera: " & sDatosCabecera) TODOEB
                        'objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("VBELN") & "- " & "sDatosDetalle: " & sDatosDetalle) TODOEB

                        objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("PEDIN_NROPEDIDO") & "- " & "Inicio registrarMetricaVentas " & ConfigurationSettings.AppSettings("WSRegMetricaVenta_url"))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("PEDIN_NROPEDIDO") & "- " & "sDatosCabecera: " & sDatosCabecera)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("PEDIN_NROPEDIDO") & "- " & "sDatosDetalle: " & sDatosDetalle)

                        'oMet.registrarMetricaVentas(oAudit, oCabecera, oDetalle) TODOE
                        objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("PEDIN_NROPEDIDO") & "- " & "Fin registrarMetricaVentas")
                    Catch ex As Exception
                        Try
                            Dim strHTMLCuerpo As String
                            strHTMLCuerpo = "<HTML>"
                            strHTMLCuerpo = strHTMLCuerpo & "<HEAD></HEAD><BODY><table>"
                            strHTMLCuerpo = strHTMLCuerpo & "<tr><td>" & ConfigurationSettings.AppSettings("RegMetricaCorreo_Titulo") & "</tr></td>"
                            strHTMLCuerpo = strHTMLCuerpo & "<tr><td>   ERROR: " & ex.Message.ToString() & "</tr></td>"
                            strHTMLCuerpo = strHTMLCuerpo & "</table></BODY></HTML>"
                            'TODOEB    EnviarEmail(ConfigurationSettings.AppSettings("strEmailRemitente"), ConfigurationSettings.AppSettings("RegMetricaCorreo_Para"), "", "", ConfigurationSettings.AppSettings("RegMetricaCorreo_Asunto"), strHTMLCuerpo, "")
                        Catch ex2 As Exception
                            objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("PEDIN_NROPEDIDO") & "- " & "Error Envio correo:" & ex2.Message.ToString())
                            'objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("VBELN") & "- " & "Error Envio correo:" & ex2.Message.ToString()) TODOEB
                        End Try
                        ' objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("VBELN") & "- " & "Error Registro de Metricas Ventas:" & ex.Message.ToString())
                        objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("PEDIN_NROPEDIDO") & "- " & "Error Registro de Metricas Ventas:" & ex.Message.ToString())
                    Finally
                        ' objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("VBELN") & "- " & "Fin Registro de Metricas Ventas")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("PEDIN_NROPEDIDO") & "- " & "Fin Registro de Metricas Ventas")
                    End Try


                    'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Inicio Region Repo Pack Prepago ---")
                    'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "TIPO_VENTA: " & dsPedido.Tables(0).Rows(0).Item("TIPO_VENTA"))
                    'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "CLASE_VENTA: " & dsPedido.Tables(0).Rows(0).Item("CLASE_VENTA"))

                    '' RENOVACION PACK PREPAGO  - EMC
                    'TODOEB
                    'If dsPedido.Tables(0).Rows(0).Item("TIPO_VENTA") = ConfigurationSettings.AppSettings("strTVPrepago") And _  TODOEB
                    '   dsPedido.Tables(0).Rows(0).Item("CLASE_VENTA") = ConfigurationSettings.AppSettings("strRepoPackPrepago") Then  TODOEB

                    If dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVPrepago") And _
                    dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION") = ConfigurationSettings.AppSettings("strRepoPackPrepago") Then

                        Dim NumeroTelefono As String = FormatoTelefonoPrepago(Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("CLIEV_TELEFONOCLIENTE")))

                        ' Consultar el Usuario del Vendedor
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Inicio FP_ConsultaUsuarioRed")

                        Dim oConsulta As New COM_SIC_Activaciones.clsBDSiscajas
                        Dim dsUsuario As DataSet
                        Dim strVendedor As String = dsPedido.Tables(0).Rows(0).Item("VENDEDOR")
                        Dim strEmpleado As String
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Cod Vendedor:" + strVendedor)
                        Dim strResp As String
                        Do While InStr(1, strVendedor, "0") = 1
                            strVendedor = Mid(strVendedor, 2, Len(strVendedor))
                        Loop
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Cod Vendedor:" + strVendedor)
                        dsUsuario = oConsulta.FP_ConsultaUsuarioRed(strVendedor, strResp) 'Validado
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "strRespuesta:" + strResp)

                        If Not IsNothing(dsUsuario) Then
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "nro de registros :" + dsUsuario.Tables(0).Rows.Count.ToString())
                            If dsUsuario.Tables(0).Rows.Count > 0 Then
                                objFileLog.Log_WriteLog(pathFile, strArchivo, "Codigo de red:" + dsUsuario.Tables(0).Rows(0).Item(0))
                                strEmpleado = dsUsuario.Tables(0).Rows(0).Item(0)
                            Else
                                strEmpleado = AppstrUsuario
                            End If
                        Else
                            strEmpleado = AppstrUsuario
                        End If
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "strEmpleado:" + strEmpleado)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Fin FP_ConsultaUsuarioRed")
                        'Guardar Interaccion
                        Dim oInteraccion = New COM_SIC_INActChip.Interaccion
                        With oInteraccion
                            '.OBJID_CONTACTO = objId
                            .TELEFONO = NumeroTelefono
                            .TIPO = ConfigurationSettings.AppSettings("CONS_REPOSICION_TIPO")
                            .CLASE = ConfigurationSettings.AppSettings("CONS_REPOSICION_CLASE")
                            .SUBCLASE = ConfigurationSettings.AppSettings("CONS_REPOSICION_SUBCLASE")
                            .METODO = ConfigurationSettings.AppSettings("CONS_REPOSICION_METODO")
                            .TIPO_INTER = ConfigurationSettings.AppSettings("CONS_REPOSICION_TIPO_INTER")
                            .AGENTE = strEmpleado
                            .USUARIO_PROCESO = ConfigurationSettings.AppSettings("CONS_REPOSICION_USUARIO")
                            .FLAG_CASO = ConfigurationSettings.AppSettings("CONS_REPOSICION_FLAG")
                            .RESULTADO = ConfigurationSettings.AppSettings("CONS_REPOSICION_RESULTADO")
                            .HECHO_EN_UNO = ConfigurationSettings.AppSettings("CONS_REPOSICION_HECHO")

                        End With
                        Dim oTipificacion As New COM_SIC_INActChip.clsTipificacion
                        Dim flagInter As String
                        Dim mensajeInter As String
                        Dim idInteraccion As String

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Inicio Region Repo Pack Prepago ---")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo CrearInteraccion()")
                        Try
                            oTipificacion.CrearInteraccion(oInteraccion, idInteraccion, flagInter, mensajeInter)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Id Interaccion : " & idInteraccion)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Flag Metodo : " & flagInter)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje : " & mensajeInter)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo CrearInteraccion()")

                            If Trim(flagInter) = "OK" Then
                                Dim clarifyTelef As String
                                Dim contactoId As Int64
                                Dim dsCliente As DataSet
                                ' Validacion Telefono TFI
                                If Len(Trim(NumeroTelefono)) = 8 Then
                                    'flagTFI = "X"
                                    clarifyTelef = "000" & Trim(NumeroTelefono)
                                Else
                                    clarifyTelef = NumeroTelefono

                                End If
                                dsCliente = oTipificacion.ConsultaCliente(clarifyTelef, "", contactoId, CInt("1"), "", "")

                                Dim objIdContacto As String
                                Dim nroDocCliente As String
                                Dim nombreCliente As String
                                Dim apellidoCliente As String

                                If dsCliente.Tables(0).Rows.Count > 0 Then
                                    objIdContacto = dsCliente.Tables(0).Rows(0).Item("OBJID_CONTACTO")
                                    nroDocCliente = dsCliente.Tables(0).Rows(0).Item("NRO_DOC")
                                    nombreCliente = dsCliente.Tables(0).Rows(0).Item("NOMBRES")
                                    apellidoCliente = dsCliente.Tables(0).Rows(0).Item("APELLIDOS")
                                End If

                                Dim dtDetalleInterac As New DataTable
                                Dim COD_MOTIVO As String = ""

                                If Not C_VENTA_Prepago Is Nothing Then
                                    If C_VENTA_Prepago.Tables.Count > 0 Then
                                        If C_VENTA_Prepago.Tables(0).Rows.Count > 0 Then
                                            COD_MOTIVO = Funciones.CheckStr(C_VENTA_Prepago.Tables(0).Rows(0).Item("MOTI_REPOSICION_COD"))
                                        End If
                                    End If
                                End If

                                If dsPedido.Tables.Count > 0 Then

                                    dtDetalleInterac = dsPedido.Tables(1)
                                    Dim oPlantilla1 As New COM_SIC_INActChip.PlantillaInteraccion

                                    'VALIDAR EVERIS
                                    'For ii As Integer = 0 To dtDetalleInterac.Rows.Count - 1
                                    'oPlantilla1 = New COM_SIC_INActChip.PlantillaInteraccion
                                    oPlantilla1.X_INTER_15 = dsPedido.Tables(0).Rows(0).Item("OFICV_CODOFICINA")
                                    oPlantilla1.X_INTER_16 = ""
                                    oPlantilla1.X_DOCUMENT_NUMBER = nroDocCliente
                                    oPlantilla1.X_FIRST_NAME = nombreCliente
                                    oPlantilla1.X_LAST_NAME = apellidoCliente
                                    oPlantilla1.X_REASON = COD_MOTIVO
                                    oPlantilla1.X_ICCID = dtDetalleInterac.Rows(0).Item("SERIC_CODSERIE")
                                    oPlantilla1.X_PLUS_INTER2INTERACT = Convert.ToDouble(idInteraccion)
                                    'oPlantilla1.X_ICCID = ICCID
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo InsertarPlantilla()")

                                    oTipificacion.InsertarPlantillaInteraccion(oPlantilla1, idInteraccion, flagInter, mensajeInter)

                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Id Interaccion : " & idInteraccion)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Flag Metodo : " & flagInter)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje : " & mensajeInter)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo InsertarPlantilla()")
                                    ' Next
                                End If
                            End If
                        Catch ex As Exception
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error : " & ex.Message.ToString())
                        End Try
                    End If

                    ' INICIO : BONO REPOSICION EN CAC 
                    If blnSunat Then
                        Try
                            '**No aplicable para NC/TG **'
                            If (Funciones.CheckDbl(dsPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO")) > 0 And _
                                dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA") <> ConfigurationSettings.AppSettings("strTipDoc")) Then

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - Inicio mètodo BonoReposisicon")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "tipo_venta_pvu : " & tipo_venta_pvu)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "flag_ped_repo : " & flag_ped_repo)
                                Dim strResBonoReposisicon As String = BonoReposisicon(dsPedido, drPagos, strDocSap, tipo_venta_pvu, flag_ped_repo)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, "strResBonoReposisicon = " & strResBonoReposisicon)
                                If strResBonoReposisicon <> "OK" Then
                                    'Response.Write("<script>alert('" & strResBonoReposisicon & "')</script>")
                                    'Session.Add("mensajeBonoReposisicon", strResBonoReposisicon)
                                End If
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - FIN mètodo BonoReposisicon")
                            End If
                        Catch ex As Exception
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Error al ejecutar el mètodo: BonoReposisicon")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error : " & ex.Message.ToString())
                        End Try
                    End If
                    ' FIN : BONO REPOSICION EN CAC 


                    '' FIN RENOVACION PACK PREPAGO  - EMC

                    ' 16/01/2013 - ACTUALIZACION DE TABLAS SISACT PREPAGO - INICIO
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "************************************")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "INICIO ACTUALIZACION DE PAGO PREPAGO")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "************************************")

                    dtDatos = objBus.ListarDatosCabeceraVenta(strDocSap)

                    If dtDatos.Rows.Count > 0 Then
                        'Dim strAlmacen As String = Session("ALMACEN")
                        'Dim strCanal As String = Session("CANAL")
                        Dim strAlmacen As String = dtDatos.Rows(0).Item("VEPR_COD_PDV").ToString()
                        Dim strCanal As String = dtDatos.Rows(0).Item("VEPR_COD_CAN").ToString()
                        Try
                            Dim obj As New COM_SIC_Cajas.clsCajas
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza referencia en tablas PVU")
                            Dim respuesta As String = obj.actualizaReferencia(strAlmacen, strDocSap, txtCompleto)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "Respuesta: " & respuesta.ToString)

                        Catch ex As Exception

                            'INI PROY-140126
                            Dim MaptPath As String
                            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                            MaptPath = "( Class : " & MaptPath & "; Function: guardarConetado)"
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "Error: " & ex.Message & MaptPath)
                            'FIN PROY-140126
                        End Try

                        If strCanal = ConfigurationSettings.AppSettings("constCodTipoCAC") Then
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "--- Pago en CAC Prepago---")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "     Metodo: ActualizarPagoCorner")
                            Dim constDocPagado As String = ConfigurationSettings.AppSettings("constDocPagado")
                            Dim objDAC As New COM_SIC_Cajas.clsCajas
                            Dim resultado As Integer = 0
                            Dim updVentaPrepago As Boolean
                            Dim p_TipoDoc As String = ""
                            Dim p_nroRef As String = Var_Corr6

                            If K_CU_CORRELATIVOFE.StartsWith("B") Then
                                p_TipoDoc = "BOLETA"
                            End If
                            If K_CU_CORRELATIVOFE.StartsWith("F") Then
                                p_TipoDoc = "FACTURA"
                            End If

                            objFileLog.Log_WriteLog(pathFile, strArchivo, "     IN Documento: " & strDocSap)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "     IN Estado Doc pagado: " & constDocPagado)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "     IN Almacen : " & strCanal)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "     IN Tipo Doc : " & p_TipoDoc)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "     IN Nro Doc Pago : " & p_nroRef)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "     IN Ticket : ")
                            'updVentaPrepago = objDAC.ActualizarPagoCorner(strDocSap, constDocPagado, strAlmacen, resultado)

                            updVentaPrepago = objDAC.ActualizarPagoCorner(strDocSap, constDocPagado, strAlmacen, p_TipoDoc, p_nroRef, "", resultado)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "Resultado : " & resultado.ToString)
                        End If

                    End If

                    ' 16/01/2013 - ACTUALIZACION DE TABLAS SISACT PREPAGO - FIN

                    '''PROMOCION MODEM'''''''''''''''''''Ugo Blanco
                    Try
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Incio PROMOCION MODEM PREPAGO")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")

                        Dim vValPromM, vIdVtaPromM, vIdOrdVtaPromM As Integer
                        Dim vPlazoACuerdo As String

                        'Validado, debido a que estaba consultando directamente el nroContrato **************
                        Dim nroContrato As String
                        Dim nroSec As String

                        If Not objContrato Is Nothing Then
                            nroContrato = objContrato.Tables(0).Rows(0).Item("ID_CONTRATO")
                        Else
                            nroContrato = ""
                        End If
                        '***********************************************************************************

                        If dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVPostpago") And dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION") = ConfigurationSettings.AppSettings("strDTVAlta") Then
                            '  If dsPedido.Tables(0).Rows(0).Item("TIPO_VENTA") = ConfigurationSettings.AppSettings("strTVPostpago") And dsPedido.Tables(0).Rows(0).Item("CLASE_VENTA") = ConfigurationSettings.AppSettings("strDTVAlta") Then TODOEB
                            Try
                                If IsContratoVacio(nroContrato) Then
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "	Consulta : ObtenerSecByPedido(SISACT_PKG_EXPRESS_PORTA.SP_OBTENER_SEC_BY_PEDIDO) ")
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "	Consulta : Paràmetro: ")
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "	Consulta : Paràm1: " & Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")))
                                    nroSec = objCajas.ObtenerSecByPedido(drPagos.Item("PEDIN_NROPEDIDO"))
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "	Resultado(nroSec): " & Funciones.CheckStr(nroSec))
                                Else
                                    nroSec = objCajas.ObtenerSec(nroContrato)
                                    If nroSec = "" Then
                                        nroSec = objCajas.ObtenerSecByContrato(nroContrato)
                                    End If
                                End If
                            Catch ex As Exception
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Err." & ex.Message.ToString)
                            End Try

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Inicia método LisPlazoAcuerdo(PVU_SEC.SISACT_PKG_VENTAS.SP_LIS_PLAZO_ACUERDO)")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Parámetros")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Parám1: " & Funciones.CheckStr(nroSec))
                            Try
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Ejecuta consulta.")
                                vPlazoACuerdo = Trim(objCajas.LisPlazoAcuerdo(nroSec))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Fi  ejecuciòn consulta.")
                            Catch ex As Exception
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Error método LisPlazoAcuerdo")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Err." & ex.Message.ToString)
                            End Try
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Fin método LisPlazoAcuerdo")

                            '**** Validando para evitar Incidencias: *****'
                            If Not C_VENTA_DET Is Nothing Then
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Inicia la validaciòn de Promociòn Modem")
                                For L As Integer = 0 To dsPedido.Tables(1).Rows.Count - 1
                                    vValPromM = vValPromM + objCajas.ValidaPromoModem(C_VENTA_DET.Rows(0).Item("CAMPANA"), _
                                                                                        C_VENTA_DET.Rows(0).Item("LISTA_PRECIO"), _
                                                                                        C_VENTA_DET.Rows(0).Item("PLAN"), _
                                                                                        vPlazoACuerdo)
                                Next
                            Else
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- No se encontro datos para hacer la validaciòn de Promociòn Modem")
                                vValPromM = 0
                            End If
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		Cumple Regla: " & vValPromM)
                            '*********************************************************************************

                            If vValPromM > 0 Then ''dsPedido.Tables(0).Rows(0).Item("OFICINA_VENTA"), _   'VALIDAR EVERIS
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Se encontraron datos de promociòn Modem.")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		vIdVtaPromM: " & vIdVtaPromM)

                                vIdVtaPromM = objCajas.InsVtaPromoModemCab(dsPedido.Tables(0).Rows(0).Item("CLIEC_TIPODOCCLIENTE"), _
                                                dsPedido.Tables(0).Rows(0).Item("CLIEV_NRODOCCLIENTE"), _
                                                dsPedido.Tables(0).Rows(0).Item("OFICV_CODOFICINA"), _
                                                drPagos.Item("PEDIN_NROPEDIDO"), _
                                                C_VENTA.Rows(0).Item("VENDEDOR"), _
                                                dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA"), _
                                                dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION"), _
                                                vPlazoACuerdo, _
                                                dsPedido.Tables(0).Rows(0).Item("PEDID_FECHADOCUMENTO"))

                                If vIdVtaPromM > 0 Then
                                    'For R As Integer = 0 To dsPedido.Tables(1).Rows.Count - 1


                                    If Not C_VENTA_DET Is Nothing Then  'Inicio de Validaciòn
                                        For R As Integer = 0 To C_VENTA_DET.Rows.Count - 1
                                            vValPromM = objCajas.ValidaPromoModem(C_VENTA_DET.Rows(0).Item("CAMPANA"), _
                                                                                C_VENTA_DET.Rows(0).Item("LISTA_PRECIO"), _
                                                                                C_VENTA_DET.Rows(0).Item("PLAN"), _
                                                                                vPlazoACuerdo)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		vValPromM: " & vValPromM)

                                            If vValPromM > 0 Then
                                                vIdOrdVtaPromM = objCajas.InsVtaPromoModemDet(vIdVtaPromM, _
                                                                            C_VENTA_DET.Rows(R).Item("MATERIAL"), _
                                                                            C_VENTA_DET.Rows(R).Item("MATERUAL_DESC"), _
                                                                            C_VENTA_DET.Rows(R).Item("SERIE"), _
                                                                            C_VENTA_DET.Rows(R).Item("TELEFONO"), _
                                                                            C_VENTA_DET.Rows(R).Item("CAMPANA"), _
                                                                            C_VENTA_DET.Rows(R).Item("LISTA_PRECIO"), _
                                                                            C_VENTA_DET.Rows(R).Item("PLAN"))
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		vIdOrdVtaPromM: " & vIdOrdVtaPromM)
                                            End If
                                        Next
                                    End If  '** Fin Validaciòn C_VENTA_DET ***'
                                End If
                            End If
                        End If
                    Catch ex As Exception
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		ERROR: " & ex.Message.ToString())
                    Finally
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin PROMOCION MODEM PREPAGO")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                    End Try
                    '''fin PROMOCION MODEM'''''''''''''''''''Ugo Blanco

                    'DTH UB
                    Dim nroContratoDTH, codRespuestaDTH As Integer
                    Dim nroSecDTH, nroDocSapDTH, nroDepSapDTH, mensajeDTH As String
                    Dim estadoParcial As String = ConfigurationSettings.AppSettings("constEstadoContrato_Parcial")
                    Dim estadoReservado As String = ConfigurationSettings.AppSettings("constEstadoContrato_Reservado")
                    Dim estadoContrato, nombreArchivo As String
                    Dim blnGenerarSot As Boolean
                    Dim objDir As New COM_SIC_Cajas.clsCajas
                    Dim dtDireccion As New DataTable
                    Try

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Inicio Generar SOT DTH")
                        If objCajas.validaDocSAPxDTH(strDocSap, nroContratoDTH, nroSecDTH, nroDocSapDTH, nroDepSapDTH, codRespuestaDTH, mensajeDTH) Then
                            If codRespuestaDTH = 0 Then
                                dtDireccion = objDir.ConsultarSolDireccion(nroSecDTH)
                                Dim vtaProgramada As String
                                For f As Integer = 0 To dtDireccion.Rows.Count - 1
                                    If dtDireccion.Rows(f).Item("TIPO_DIR") = "I" Then
                                        vtaProgramada = dtDireccion.Rows(f).Item("VENTA_PROGRAMADA")
                                        Exit For
                                    End If
                                Next
                                If vtaProgramada.Equals("") Then
                                    estadoContrato = objCajas.Consulta_estado_contrato(CInt(nroContratoDTH))
                                    If estadoContrato = estadoParcial Then
                                        blnGenerarSot = True
                                        Dim oResponse As New SGAResponseVenta
                                        oResponse = GenerarSot(nroSecDTH, nroDocSapDTH)
                                        If oResponse.codsolot > 0 Then
                                            objCajas.ActualizaContratoSot(nroContratoDTH, CheckStr(oResponse.codsolot), oResponse.numslc, oResponse.fecagenda, oResponse.hora, CheckStr(oResponse.codcon), oResponse.codcuadri, oResponse.codcli)
                                            objCajas.Actualizar_estado_contrato(CheckInt64(nroContratoDTH), estadoReservado, CheckStr(oResponse.codsolot))
                                        Else
                                            Throw New Exception(CheckStr(ConfigurationSettings.AppSettings("consMsgErrorGeneraSot")))
                                        End If
                                    End If
                                End If

                            End If
                        End If
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "estadoContrato:" & estadoContrato)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "nroContratoDTH:" & nroContratoDTH)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "nroDocSapDTH:" & nroDocSapDTH)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "nroDepSapDTH:" & nroDepSapDTH)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "codRespuestaDTH:" & codRespuestaDTH)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "mensajeDTH:" & mensajeDTH)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Fin Generar SOT DTH")
                        'DTH UB
                    Catch ex As Exception
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "ERROR Generar SOT DTH: " & ex.Message.ToString())
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "ERROR Generar SOT DTH: " & ex.StackTrace.ToString())

                        If blnGenerarSot Then
                            If GenerarArchivoTramaSGA(nroContratoDTH, nombreArchivo) Then
                                objCajas.Actualizar_estado_contrato(nroContratoDTH, estadoReservado, "0")
                            Else
                                'Session.Add("msgErrorGenerarSot", CheckStr(ConfigurationSettings.AppSettings("consMsgErrorGeneraSot")))
                                AppmsgErrorGenerarSot = CheckStr(ConfigurationSettings.AppSettings("consMsgErrorGeneraSot"))
                            End If
                        Else
                            'Session.Add("msgErrorGenerarSot", CheckStr(ConfigurationSettings.AppSettings("consMsgErrorGeneraSot")))
                            AppmsgErrorGenerarSot = CheckStr(ConfigurationSettings.AppSettings("consMsgErrorGeneraSot"))
                        End If
                    End Try
                End If

                'Cambio SIM IVR: Insertar Stock PEL
                Try
                    Dim listaMatCambioSIM As String = ConfigurationSettings.AppSettings("codMatChipRepuesto")
                    Dim codResp, sMensaje As String
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Inicio InsertarStockPELCambiSIM (PKG_CAMBIOSIM.SP_INSR_STOCKS_CAMBIO_SIM)")
                    For i = 0 To dsPedido.Tables(1).Rows.Count - 1
                        Dim codMaterial As String = dsPedido.Tables(1).Rows(i).Item("DEPEC_CODMATERIAL")
                        If listaMatCambioSIM.IndexOf(codMaterial) > -1 Then
                            Try
                                Dim ICCID As String = dsPedido.Tables(1).Rows(i).Item("SERIC_CODSERIE")
                                Dim codOficina As String = AppAlmacen
                                Dim clienteSap As String = ConfigurationSettings.AppSettings("codClienteSapPEL")
                                Dim nroTelefono As String = FormatoTelefonoSinCeros(Funciones.CheckStr(dsPedido.Tables(1).Rows(i).Item("DEPEV_NROTELEFONO")))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - InsertarStockPELCambiSIM")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "inp codMaterial: " & codMaterial)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "inp ICCID: " & ICCID)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "inp codOficina: " & codOficina)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "inp clienteSap: " & clienteSap)

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "inp nroTelefono: " & nroTelefono)
                                objCajas.InsertarStockPELCambiSIM(codMaterial, ICCID, codOficina, clienteSap, nroTelefono, codResp, sMensaje)
                            Catch ex As Exception
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - Marca Error. InsertarStockPELCambiSIM")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - Err." & ex.Message.ToString)
                            End Try

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "out codResp: " & codResp)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "out sMensaje: " & sMensaje)
                        End If
                    Next
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Fin InsertarStockPELCambiSIM")
                Catch ex As Exception
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "ERROR Cambio SIM IVR: " & ex.Message.ToString())
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "ERROR Cambio SIM IVR: " & ex.StackTrace.ToString())
                End Try

                Try
                    AlertaTitularidad(dsPedido, drPagos.Item("PEDIN_NROPEDIDO"))
                    'RenovacionModemPrepago(dsPedido, drPagos.Item("PEDIN_NROPEDIDO"), strNumAsignado)
                Catch ex As Exception
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Error bloque: AlertaTitularidad - RenovacionModemPrepago ")
                End Try

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "------ INICIO Consulta la CONTRATO -----")
                If Not objContrato Is Nothing Then
                    If objContrato.Tables(0).Rows.Count > 0 Then
                        strContrato = Funciones.CheckStr2(objContrato.Tables(0).Rows(0).Item("ID_CONTRATO"))
                    Else
                        strContrato = ""
                    End If
                Else
                    strContrato = ""
                End If
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     Nro CONTRATO: " & strContrato)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "------ FIN Consulta la CONTRATO -----")

                '*****************************************************CONSULTA LA SEC******************************************************************'
                Try
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "------ Consulta la SEC -----")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     Metodo: ConsultaAcuerdoPCS -- SP: sp_con_acuerdos -- Packages: sisact_pkg_acuerdo")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         IN Contrato: " & strContrato)

                    dsAcuerdo = objClsConsultaPvu.ConsultaAcuerdoPCS(Funciones.CheckInt64(strContrato), DBNull.Value)

                    If Not dsAcuerdo Is Nothing Then
                        strNroSEC = Funciones.CheckStr(dsAcuerdo.Tables(0).Rows(0).Item("contn_numero_sec"))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         OUT Sec: " & strNroSEC)
                    End If

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "------ Inicio Consulta Acuerdos PCs -----")

                Catch ex As Exception
                    'INI PROY-140126
                    Dim MaptPath As String
                    MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                    MaptPath = "( Class : " & MaptPath & "; Function: guardarConectado)"
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error al tratar de recuperar la SEC" & ex.Message & MaptPath)
                    'FIN PROY-140126

                End Try
                '**************************************************************************************************************************************'

                Dim idInteracccion1, cuentaRedVendedor As String

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "------ Inicio Validacion de Proceso Renovacion CAC -----")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         Tiene Contrato? " & strContrato)


                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "   strContrato : " & Funciones.CheckStr(strContrato)) 'NUEVO

                If Funciones.CheckInt64(strContrato) > 0 Then
                    ProcesoRenovacionCAC(dsPedido, Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")), idInteracccion1, cuentaRedVendedor, strNroSEC, strContrato) 'NUEVO
                    AlertaNotificacionPorRenovacion(Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")), dsPedido, idInteracccion1, cuentaRedVendedor) 'NUEVO
                End If

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "------ FIN Validacion de Proceso Renovacion CAC -----")
                'AUDITORIA

                wParam1 = AppCodUsuario
                wParam2 = AppREMOTE_ADDR
                wParam3 = AppSERVER_NAME
                wParam4 = ConfigurationSettings.AppSettings("gConstOpcPPag")
                wParam7 = ConfigurationSettings.AppSettings("CodAplicacion")
                wParam8 = ConfigurationSettings.AppSettings("gConstEvtPPag")
                wParam9 = AppcodPerfil
                wParam10 = Mid(AppLogon_User, InStr(1, AppLogon_User, "\", vbTextCompare) + 1, 20)
                wParam11 = 1

                If Len(strDetallePago) > 0 Then
                    ReDim Detalle(6, 3)
                    For i = 0 To UBound(Split(strDetallePago, "|"))

                        Detalle(1, 1) = "OfVta"
                        Detalle(1, 2) = Split(Split(strDetallePago, "|")(i), ";")(1)
                        Detalle(1, 3) = "Oficina de Ventas"

                        Detalle(2, 1) = "ViaPago"
                        Detalle(2, 2) = Split(Split(strDetallePago, "|")(i), ";")(2)
                        Detalle(2, 3) = "Via de Pago"

                        Detalle(3, 1) = "Importe"
                        Detalle(3, 2) = Split(Split(strDetallePago, "|")(i), ";")(5)
                        Detalle(3, 3) = "Importe"

                        Detalle(4, 1) = "Refer"
                        Detalle(4, 2) = Split(Split(strDetallePago, "|")(i), ";")(8)
                        Detalle(4, 3) = "Referencia Sunat"

                        Detalle(5, 1) = "Fecha"
                        Detalle(5, 2) = Split(Split(strDetallePago, "|")(i), ";")(10)
                        Detalle(5, 3) = "Fecha"

                        Detalle(6, 1) = "DocSAP"
                        Detalle(6, 2) = drPagos.Item("PEDIN_NROPEDIDO")
                        Detalle(6, 3) = "Documento SAP"

                        objAudiBus.AddAuditoria(wParam1, wParam2, wParam3, wParam4, wParam5, wParam6, wParam7, wParam8, wParam9, wParam10, wParam11, Detalle)

                    Next
                End If
                'FIN AUDITORIA

                If Len(Trim(strErrorMsg)) > 0 Then     'se produjo algun error al momento de pagar
                    'Response.Write("<script>alert('" & strErrorMsg & "')</script>")
                    AppstrMensajeCaja = strErrorMsg
                    AppMensajeExitFunction = "strErrorMsg"
                    AppCodigoExitFunction = "-2"
                    'Response.Redirect("PoolPagos.aspx", False)
                    'Response.End()
                    Exit Function
                Else     ' no hubo errores
                    Try
                        strContrato = objContrato.Tables(0).Rows(0).Item("ID_CONTRATO") 'drPagos.Item("NRO_CONTRATO")
                    Catch ex As Exception
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "objContrato.Tables(0).Rows(0).Item(ID_CONTRATO)" & ex.Message)
                    End Try

                    'If strContrato = "" Then
                    '    'dsResult = objPagos.Get_ConsultaNroContrato(Session("ALMACEN"), "", drPagos.Item("VBELN"), strContrato)
                    '    dsResult = objPagos.Get_ConsultaNroContrato(Session("ALMACEN"), "", drPagos.Item("PEDIN_NROPEDIDO"), strContrato)
                    'End If


                    '**************************************************************************************************************************************'
                    '******CONSULTA LA SEC : **************************************************************************************************************'
                    Try
                        'If Not C_VENTA Is Nothing Then
                        'If Trim(C_VENTA.Rows(0).Item("CODTIPOCLIENTE") = "02") Then
                        'dsAcuerdo = objPagos.Get_ConsultaAcuerdoPCS(strContrato)        'Consulta SAP
                        dsAcuerdo = objClsConsultaPvu.ConsultaAcuerdoPCS(Funciones.CheckInt64(strContrato), DBNull.Value)    'Consulta PVU
                        If Not dsAcuerdo Is Nothing Then
                            'strNroSEC = dsAcuerdo.Tables(0).Rows(0).Item("NRO_CARPETA_OBS")
                            strNroSEC = Funciones.CheckStr(dsAcuerdo.Tables(0).Rows(0).Item("contn_numero_sec"))
                            sisact_Cod_Operacion = Funciones.CheckStr(dsAcuerdo.Tables(0).Rows(0).Item("contc_tipo_operacion"))
                            objCajas.FP_RegistroDespachoPDV(strNroSEC, Right("0000000000" & AppUsuario, 10))    'Consulta PVU

                        End If
                    Catch ex As Exception
                        'INI PROY-140126
                        Dim MaptPath As String
                        MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                        MaptPath = "( Class : " & MaptPath & "; Function: guardarConetado)"
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error al tratar de recuperar la SEC" & ex.Message & MaptPath)
                        'FIN PROY-140126
                    End Try
                    '**************************************************************************************************************************************'

                    ' Para Venta de Portabilidad
                    'ActualizaPago(CStr(drPagos.Item("PEDIDO")))
                    ActualizaPago(CStr(drPagos.Item("PEDIN_NROPEDIDO")))
                    Dim codRespConvergente As String = ""

                    Dim strMontoPago As String = ""

                    If (dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA") <> ConfigurationSettings.AppSettings("strTipDoc") And Funciones.CheckDbl(dsPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO")) > 0) Then
                        strMontoPago = ObtenerMontoPago(strDetallePago)
                    Else
                        strMontoPago = "0"
                    End If

                    'codRespConvergente = EjecutarActivacion(strDocSap, strNumAsignaSUNAT, strMontoPago, CurrentUser, CurrentTerminal, strNroSEC)
                    '** ACTIVACIONES **'
                    Dim esPortabilidad As String = "N"
                    codRespConvergente = EjecutarActivacion(Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")), Var_Corr6, strMontoPago, CurrentUser, CurrentTerminal, strNroSEC, sisact_Cod_Operacion, esPortabilidad)
                    '
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "codRespConvergente: " & Funciones.CheckStr(codRespConvergente))
                    '*****RV : IDG  ***'

                    If esPortabilidad = "S" Then

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo de operacion es PORTABILIDAD POSTPAGO")

                        If codRespConvergente = CheckStr(ConfigurationSettings.AppSettings("WSActivosPostpagoConvergente_codRespOK")) Then

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Se actualizo con exito el contrato")
                            AppActualizarContrato = "0"
                        Else
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Ocurrio un error al actualizar el contrato")
                            AppActualizarContrato = "1"
                        End If

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Operacion Portabilidad no invoca al WS ActivosPostpagoConvergente")

                        AppActivosPostpagoConvergente = String.Empty

                    Else
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo de operacion No es Portabilidad Postpago")

                        If AppTipoOperacionPago = CheckStr(ConfigurationSettings.AppSettings("strDTVRenovacion")) Then

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo de operacion es RENOVACION POSPTAGO")

                            AppActualizarContrato = "1"

                        ElseIf AppTipoOperacionPago = CheckStr(ConfigurationSettings.AppSettings("strDTVReposicionChip")) Then

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo de operacion es REPOSICION POSPTAGO")

                            AppActualizarContrato = String.Empty
                            AppActivosPostpagoConvergente = String.Empty

                        ElseIf AppTipoOperacionPago = CheckStr(ConfigurationSettings.AppSettings("COD_TIPO_OPERACION_VENTA_VARIOS")) Then

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo de operacion es VENTAS VARIAS")

                            AppActualizarContrato = String.Empty
                            AppActivosPostpagoConvergente = String.Empty

                        Else

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo de operacion es ALTA O MIGRACION")

                            If codRespConvergente = CheckStr(ConfigurationSettings.AppSettings("WSActivosPostpagoConvergente_codRespOK")) Then

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Se proceso con exito la activacion")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Se actualizo con exito el contrato")

                                AppActivosPostpagoConvergente = "0"
                                AppActualizarContrato = "0"

                            Else
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Ocurrio un error al procesar la activacion")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "No Se actualizo con exito el contrato")

                                AppActivosPostpagoConvergente = "1"
                                AppActualizarContrato = "1"
                            End If

                        End If
                    End If


                    If codRespConvergente = CheckStr(ConfigurationSettings.AppSettings("codRespDocSapNoConvergente")) Then

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Operacion Renovacion no invoca al WS ActivosPostpagoConvergente")

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strContrato: " & Funciones.CheckInt64(strContrato))
                        '    'If strContrato <> "KO" And CDbl(strContrato) > 0 Then
                        If Funciones.CheckInt64(strContrato) > 0 Then
                            '        'dsAcuerdo = objPagos.Get_ConsultaAcuerdoPCS(strContrato)         'Consulta SAP
                            dsAcuerdo = objClsConsultaPvu.ConsultaAcuerdoPCS(Funciones.CheckInt64(strContrato), DBNull.Value)    'Consulta PVU

                            AppActivosPostpagoConvergente = String.Empty


                            If Not dsAcuerdo Is Nothing Then
                                Try
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "dsAcuerdo.Tables.Count : " & dsAcuerdo.Tables.Count)
                                    If dsAcuerdo.Tables.Count > 1 Then
                                        'PorMigracion = dsAcuerdo.Tables(0).Rows(0).Item("MIGRACION")  ' existe en la tabla (sisact_ap_contrato)
                                        'PorRenovacion = "" 'dsAcuerdo.Tables(0).Rows(0).Item("RENOVACION")  ' existe en la tabla (sisact_ap_contrato)
                                        'PorReposicion = "" 'dsAcuerdo.Tables(0).Rows(0).Item("REPOSICION") '''''''''''' no encuentro

                                        'PorAprobador = dsAcuerdo.Tables(0).Rows(0).Item("APROBADOR")
                                        'PorAprobador = dsAcuerdo.Tables(0).Rows(0).Item("contv_aprobador") ' existe en la tabla (sisact_ap_contrato)
                                        If dsAcuerdo.Tables(1).Rows.Count > 0 Then
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "dsAcuerdo.Tables(1).Rows.Count : " & dsAcuerdo.Tables(1).Rows.Count)
                                            Try
                                                EstadoActualAcuerdo = Funciones.CheckStr(dsAcuerdo.Tables(0).Rows(0).Item("CONTC_ESTADO")) 'cursor detalle
                                            Catch ex As Exception
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "EstadoActualAcuerdo entro al catch ")
                                                EstadoActualAcuerdo = ""
                                            End Try

                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "EstadoActualAcuerdo : " & EstadoActualAcuerdo)
                                            strNroSEC = Funciones.CheckStr(dsAcuerdo.Tables(0).Rows(0).Item("contn_numero_sec"))
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strNroSEC : " & strNroSEC)

                                            If EstadoActualAcuerdo = ConfigurationSettings.AppSettings("CTE_VENTA") Then

                                                'dsResult = objPagos.Get_ParamGlobal(Session("ALMACEN"))
                                                'TODOE: Validar si es correcta la consulta
                                                Try
                                                    Dim objOffline As New COM_SIC_OffLine.clsOffline
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Inicio Parametros Venta--")
                                                    dsResult = objOffline.ParametrosVenta(AppAlmacen)
                                                    strValSAP = Funciones.CheckStr(dsResult.Tables(0).Rows(0).Item("REN_REP_HDC")) 'verificar (si trae ese parametro el de offline)
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Fin Parametros Venta--")
                                                Catch ex As Exception
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--ERROR Parametros Venta-- " & ex.Message)
                                                    strValSAP = ""
                                                End Try
                                                'strIND_ACTIV_BSCS = dsResult.Tables(0).Rows(0).Item("IND_ACTIV_BSCS")
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strValSAP : " & strValSAP)
                                                'Mejora en Bandeja de Renovaciones
                                                If Funciones.CheckStr(dsAcuerdo.Tables(1).Rows(0).Item("material")) <> "" Then
                                                    conEquipo = True
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "conEquipo : true")
                                                Else
                                                    conEquipo = False
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "conEquipo : false")
                                                End If

                                                Dim cod_OperaSisact() As String
                                                cod_OperaSisact = ConfigurationSettings.AppSettings("codOperacionSisact").Split(",")

                                                For z As Integer = 0 To UBound(cod_OperaSisact)
                                                    If sisact_Cod_Operacion = Funciones.CheckStr(cod_OperaSisact(z)) Then
                                                        blnDebeSerRevisado = True
                                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "blnDebeSerRevisado : true")
                                                        Exit For
                                                    Else
                                                        blnDebeSerRevisado = False
                                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "blnDebeSerRevisado : false")
                                                    End If
                                                Next

                                                'If (Trim(sTipoOperacion) = Funciones.CheckStr(ConfigurationSettings.AppSettings("COD_OPERACION_RENOVACION")) Or Trim(sTipoOperacion) = Funciones.CheckStr(ConfigurationSettings.AppSettings("COD_OPERACION_REPOSICION"))) And (strValSAP <> "X") Then          'Not(valSAP=="X"): VIA_DSF = S
                                                '                            blnDebeSerRevisado = True
                                                '                        End If
                                                If blnDebeSerRevisado And (strValSAP <> "X") Then
                                                    blnDebeSerRevisado = True
                                                End If
                                                If blnDebeSerRevisado Then  ' los estados seran cero o 7
                                                    strEstado = ConfigurationSettings.AppSettings("CTE_ESTREVISADO")
                                                Else
                                                    strEstado = ConfigurationSettings.AppSettings("CTE_ESTNUEVO")
                                                End If
                                                Dim Id_contrato As String = Funciones.CheckStr(dsAcuerdo.Tables(1).Rows(0).Item("id_contrato"))
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Id_contrato : " & Id_contrato)
                                                Dim codRespt, msgRespt As String

                                                'dsEstado = objPagos.Set_EstadoAcuerdoPCS(strContrato, strEstado, ConfigurationSettings.AppSettings("gStrUsuarioActivacionWS"), "", "", "", strObsEstado, "")                '                        
                                                objFileLog.EscribirLog(pathFile, strArchivo, strIdentifyLog, "Inicio CambiarEstadoAcuerdo")
                                                objFileLog.EscribirLog(pathFile, strArchivo, strIdentifyLog, "nroAcuerdo : " & Id_contrato)
                                                objFileLog.EscribirLog(pathFile, strArchivo, strIdentifyLog, "Estado : " & strEstado)
                                                objFileLog.EscribirLog(pathFile, strArchivo, strIdentifyLog, "Usuario : " & Funciones.CheckStr(CurrentUser.ToString)) '*********

                                                codRespt = (New COM_SIC_Activaciones.clsBDSiscajas).CambiarEstadoAcuerdo(Id_contrato, strEstado, CurrentUser.ToString, msgRespt)
                                                objFileLog.EscribirLog(pathFile, strArchivo, strIdentifyLog, "Fin CambiarEstadoAcuerdo", codRespt, msgRespt)

                                                If codRespt = "0" Then
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Se actualizo con exito el contrato")
                                                    AppActualizarContrato = "0"
                                                Else
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "No se actualizo con exito el contrato")
                                                    AppActualizarContrato = "1"
                                                End If
                                            End If
                                        End If
                                    End If
                                Catch ex As Exception
                                    '                Response.Write("<script>alert('" & ex.StackTrace.ToString & "')</script>")
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR ConsultaAcuerdoPCS:" & ex.Message.ToString())
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR ConsultaAcuerdoPCS:" & ex.StackTrace.ToString())
                                End Try
                            End If '+++Fin acuerdos+++'
                        Else

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "TIPO DE VENTA ES PREPAGO")

                            AppActualizarContrato = String.Empty
                            AppActivosPostpagoConvergente = String.Empty

                        End If
                    End If
                    '*****RV : FDG  ***'

                    '****************************************************************************'
                    '22-01-15 xD
                    'PVUDB: DEBEMOS CONSULTAR ANTES EL NUMERO DE SEC, CON EL PEDIDO DEL MSSAP
                    'CARIAS: SEC marcada como pagada
                    '** UPDATESEC ***'
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Iniico bloque para actualizar SEC.")
                    Dim Err_MSG As String = ""
                    Dim cod_Rpt As Integer = 3

                    'PROY-140743 IDEA141192 VICTOR CANCHICA
                    Dim CuotaAcc As Integer = dsDatosPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA")

                    'VALIDAMOS PAGO ACCESORIO Y EN CUOTAS
                    If sTipoOperacion = ConfigurationSettings.AppSettings("COD_TIPO_OPERACION_VENTA_VARIOS") And CuotaAcc > 0 Then

                        'OBTENEMOS Y SETEAMOS LA SEC,USANDO EL NUMERO DE PEDIDO
                        strNroSEC = Me.Obtener_NroSec_PostPagoR2(strDocSap)
                        'ACTUALIZAMOS EL FLAG CUOTA, USANDO EL NUMERO DE PEDIDO'
                        ActualizaFlagCuota(Funciones.CheckStr(strDocSap))
                    End If
                    'PROY-140743 IDEA141192 VICTOR CANCHICA



                    If Len(Trim(strNroSEC)) > 0 Then
                        Try
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicia el proceso para actualizar la SEC => " & strNroSEC)
                            cod_Rpt = objCajas.FP_Actualiza_Pago_Solicitud(Funciones.CheckInt(strNroSEC), "X", Err_MSG)
                            'INI PROY-140126
                            Dim MaptPath As String
                            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                            MaptPath = "( Class : " & MaptPath & "; Function: guardarConectado)"
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Respuesta del proceso Err_MSG => " & Err_MSG & MaptPath)
                            'FIN PROY-140126

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Respuesta del proceso cod_Rpt  => " & cod_Rpt)
                        Catch ex As Exception
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Try catch para actualizar SEC.")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Output strContrato: " & strContrato)
                            'INI PROY-140126
                            Dim MaptPath As String
                            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                            MaptPath = "( Class : " & MaptPath & "; Function: guardarConectado)"
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Respuesta del proceso Err_MSG => " & Err_MSG & MaptPath)
                            'FIN PROY-140126
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Respuesta del proceso cod_Rpt  => " & cod_Rpt)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Ocurrio un error al tratar de actualizar la SEC " & strNroSEC)
                        End Try
                    Else
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- No se encontro la SEC para el pedido.")
                    End If
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Fin bloque para actualizar SEC.")
                    'FIN CARIAS: SEC marcada como pagada
                    '****************************************************************************'

                    'CNH WEB SERVICE INI - PORTABILIDAD

                    If dsPedido.Tables(0).Rows.Count > 0 And Len(Trim(strNroSEC)) = 0 Then
                        strNroSEC = objCajas.ObtenerSecByPedido(dsPedido.Tables(0).Rows(0)("PEDIN_NROPEDIDO"))
                    End If

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strNroSEC :" & strNroSEC)
                    If Len(Trim(strNroSEC)) > 0 Then

                        'Validar si es una portabilidad pre o post (Movil o Fija)

                        Dim strCodTipOpe As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("PEDIC_CODTIPOOPERACION"))
                        Dim strDesTipOpe As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("PEDIV_DESCTIPOOPERACION"))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strCodTipOpe :" & strCodTipOpe)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strDesTipOpe :" & strDesTipOpe)

                        'Venta Postpago = 01
                        'Dim strTVPostpago As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("strTVPostpago"))
                        'Dim strDescriOpePostPago As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("DESCTIPOOPERACION_PORTA_POST"))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strTVPostpago :" & strTVPostpago)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strDescriOpePostPago :" & strDescriOpePostPago)


                        'Venta Prepago  = 02
                        'Dim strTVPrepago As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("strTVPrepago"))
                        ' Dim strDescriOpePrePago As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("DESCTIPOOPERACION_PORTA_PRE"))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strTVPrepago :" & strTVPrepago)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strDescriOpePrePago :" & strDescriOpePrePago)


                        Dim FlagPorta As Boolean = False

                        If (strDesTipOpe = strDescriOpePostPago) Then
                            'POSTPAGO                        
                            FlagPorta = True
                        ElseIf (strDesTipOpe = strDescriOpePrePago) Then
                            'PREPAGO                        
                            FlagPorta = True
                        End If

                        If (FlagPorta = True) Then
                            '*** PROY 32089 INI -  ***'
                            Dim objDatosTipoProducto As New ClsPortabilidad
                            Dim pstrCodRpta, pstrMsgRpta As String

                            Dim dtLineas As DataSet = objDatosTipoProducto.Obtener_tipo_producto(strNroSEC, hidDocSap, pstrCodRpta, pstrMsgRpta)
                            If clsKeyAPP.consTipoProductoPermitidosSP.IndexOf(dtLineas.Tables(0).Rows(0).Item("PRDC_CODIGO")) > -1 Then   'PROY 32089 PARA TFI

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Realizando Programación.")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                                Dim oBWProcesoPortabilidad As New BWProcesoPortabilidad
                                Dim oaudit As New ItemGenerico
                                Dim mensajeError As String = String.Empty
                                Dim codError As String = String.Empty
                                Dim strMsgEmailRP As String = ""
                                oaudit.CODIGO = ConfigurationSettings.AppSettings("CONS_APLICACION")
                                oaudit.CODIGO2 = CurrentTerminal
                                oaudit.CODIGO3 = CurrentUser
                                oaudit.DESCRIPCION = Now.ToString("yyMMddhhmmssff")
                                'INI: PROY-140262 BLACKOUT
                                oaudit.CODIGO4 = clsKeyAPP.consFlagBlackOut
                                oaudit.DESCRIPCION4 = clsKeyAPP.consMensajeRealizarProgramacionBlackOut
                                'FIN: PROY-140262 BLACKOUT
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Datos para el servicio realizarProgramación.")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "IdAplicacion: " & oaudit.CODIGO)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "nombreAplicacion: " & oaudit.CODIGO2)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "usuarioAplicacion: " & oaudit.CODIGO3)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "idTransaccionESB: " & oaudit.DESCRIPCION)
                                'INI: PROY-140262 BLACKOUT
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "[ItemGenerico][CODIGO4] " & oaudit.CODIGO4)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "[ItemGenerico][DESCRIPCION4] " & oaudit.DESCRIPCION4)
                                'FIN: PROY-140262 BLACKOUT
                                Dim ipclienteRP As String = CurrentTerminal
                                Dim strIdTransactionRP As String = DateTime.Now.ToString("yyMMddhhmmss")
                                Dim strNameApliRP As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("CONS_APLICACION"))
                                'Inicio PROY 32089
                                strLista_SOPOC_ID_SOLICITUD = CType(AppIdSolicitudPorta, ArrayList)   'PROY-140335
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- [PROY-140335][DETAPAGO][Session(IdSolicitudPorta)=> " & strLista_SOPOC_ID_SOLICITUD.Count)
                                If strLista_SOPOC_ID_SOLICITUD.Count > 0 Then
                                    For Each id_solicitud As String In strLista_SOPOC_ID_SOLICITUD

                                        objFileLog.EscribirLog(pathFile, strArchivo, pathFile, "EnviarProgramacion [IdSolicitud]", id_solicitud)
                                        objFileLog.EscribirLog(pathFile, strArchivo, pathFile, "EnviarProgramacion [ItemGenerico]", oaudit.Codigo)
                                        objFileLog.EscribirLog(pathFile, strArchivo, pathFile, "EnviarProgramacion [codError]", codError)
                                        objFileLog.EscribirLog(pathFile, strArchivo, pathFile, "EnviarProgramacion [mensajeError]", mensajeError)

                                        oBWProcesoPortabilidad.RealizarProgramacion(oaudit, id_solicitud, codError, mensajeError)
                                        objFileLog.EscribirLog(pathFile, strArchivo, pathFile, "EnviarProgramacion - RESPUESTA [codError]", codError)
                                        objFileLog.EscribirLog(pathFile, strArchivo, pathFile, "EnviarProgramacion - RESPUESTA [mensajeError]", mensajeError)
                                        If codError <> "0" Then
                                            'Enviar email a Mesa Portabilidad
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Inicio :  Enviar_Email")
                                            strMsgEmailRP = Me.Enviar_Email(id_solicitud, ipclienteRP, strNameApliRP, CurrentUser, strNroSEC, codError)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Fin :  Enviar_Email")
                                        End If
                                    Next
                                End If
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Datos para el servicio Fin realizarProgramación.")

                                'FIN PROY 32089
                            Else
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Incio Envio de Solicitud de Portabilidad no movil/bam Porta") ' PROY-32089
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strNroSEC :" & strNroSEC)

                                Dim oEnvioPortal As New BWEnvioPortal

                                Dim intNroSec As Int64 = Funciones.CheckInt64(strNroSEC)

                                Dim usuario_id As String = CurrentUser
                                Dim ipcliente As String = CurrentTerminal
                                Dim strIdTransaction As String = DateTime.Now.ToString("yyMMddhhmmss")
                                Dim strNameApli As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("CONS_APLICACION"))
                                Dim strRptaService As String = "", strMsgEmail As String = ""
                                Dim strNameHost As String = Funciones.CheckStr(AppUserHostName)
                                Dim strNameServer As String = Funciones.CheckStr(AppREMOTE_ADDR)
                                Dim strIpServer As String = Funciones.CheckStr(AppHTTP_X_FORWARDED_FOR)
                                Dim strTipoPorta As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("ConsTipoPorta"))
                                Dim strRptService As String = ""

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "usuario_id : " & usuario_id)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "ipcliente : " & ipcliente)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strIdTransaction : " & strIdTransaction)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strNameApli : " & strNameApli)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strNameHost : " & strNameHost)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strNameServer : " & strNameServer)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strIpServer : " & strIpServer)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strTipoPorta : " & strTipoPorta)

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Inicio :  RealizarSolicitudPortabilidad")
                                strRptaService = oEnvioPortal.RealizarSolicitudPortabilidad(CLng(intNroSec), strIdTransaction, _
                                ipcliente, strNameApli, usuario_id, strNameHost, strNameServer, strIpServer, strTipoPorta, strRptService)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Fin :  RealizarSolicitudPortabilidad")

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strRptaService : " & strRptaService)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strRptService : " & strRptService)
                                If strRptaService <> "0" Then
                                    'Enviar email a Mesa Portabilidad
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Inicio :  Enviar_Email")
                                    strMsgEmail = Me.Enviar_Email(strIdTransaction, ipcliente, strNameApli, usuario_id, strNroSEC, strRptService)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Fin :  Enviar_Email")
                                End If
                                oEnvioPortal = Nothing
                            End If
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Fin Porta")
                        End If
                    End If ' PROY 32090

                    'CNH WEB SERVICE FIN


                    'INICIO ACTUALIZAR LA TABLA DE CONTROL (Post + Pre)
                    '''Dim arrCampana() As String
                    '''Dim intCampana As Integer

                    '''If Trim(strCadenaCam) <> "" Then
                    '''    arrCampana = Split(strCadenaCam, "|")
                    '''    If UBound(arrCampana) >= 0 Then
                    '''        For intCampana = 0 To UBound(arrCampana)
                    '''            dsResult = objPagos.Set_TriacionPrePost(arrCampana(intCampana))
                    '''        Next
                    '''    End If
                    '''End If
                    'FIN ACTUALIZAR LA TABLA DE CONTROL (Post + Pre)

                    'CCC - TS - Envio fecha pedido
                    dateTimeValueCajaEfe = Convert.ToDateTime(DateTime.Now, cultureCaja)
                    'PROY-140397-MCKINSEY -> JSQ INICIO
                    sFechaCaj0 = DateTime.Now.ToString("dd/MM/yyyy")
                    'PROY-140397-MCKINSEY -> JSQ FIN

                    'dsEfectivo = objCajas.FP_Get_ListaParamOficina(Session("CANAL"), ConfigurationSettings.AppSettings("CodAplicacion"), Session("ALMACEN"))
                    'dblEfecCaja = objCajas.FP_CalculaEfectivo(Session("ALMACEN"), "60138")
                    objCajas = New COM_SIC_Cajas.clsCajas
                    dsEfectivo = objCajas.FP_Get_ListaParamOficina(AppCanal, ConfigurationSettings.AppSettings("CodAplicacion"), AppAlmacen)
                    dblEfecCaja = objCajas.FP_CalculaEfectivo(AppAlmacen, AppUsuario, sFechaCaj0)

                    If dsEfectivo.Tables(0).Rows(0).Item("CAJA_MAX_DISP_SOL") <= dblEfecCaja Then
                        If AppstrMensajeCaja = "" Then
                            AppstrMensajeCaja = "Ha alcanzado su maximo disponible de efectivo en caja. Aun tiene una tolerancia de " & Format(dblTolerancia, "#####0.00") & " adicionales"
                        End If
                    End If

                    Dim sUrl As String = "PoolPagos.aspx"
                    AppVentaR = "1"
                    If AppVentaR = "1" Then
                        sUrl = "Terminar.aspx"
                        AppVentaR = ""
                    End If

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "booDol: " & booDol.ToString)
                    ' INICIO FMES : ACTIVAR PEL
                    'If booDol = False Then
                    'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "VBELN: " & Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")))
                    'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ALMACEN: " & Session("ALMACEN"))
                    'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "txtNumSunat: " & txtNumSunat.Text.Trim)
                    'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FKDAT: " & drPagos.Item("FKDAT"))
                    'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "sTipoOperacion: " & sTipoOperacion)

                    'Dim strDescripcionError As String = ""
                    'If (pagarCAC(drPagos.Item("PEDIN_NROPEDIDO"), Session("ALMACEN"), txtNumSunat.Text.Trim, drPagos.Item("FKDAT"), sTipoOperacion, strDescripcionError)) = False Then
                    'Session.Add("msgActivacionCAC", strDescripcionError)
                    'Else
                    'Session.Add("msgActivacionCAC", strDescripcionError)
                    'Response.Redirect("PoolPagos.aspx")
                    'End If

                    'End If

                    ' FIN FMES : ACTIVAR PEL
                    'Escribir en diario electronico

                    'PROY-31836 IDEA-43582_Mejora de Procesos Postventa del servicio Proteccion Movil

                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [INICIO Validacion Mejoras Proteccion movil Renovacion  CAC - PROY-31836]", strIdentifyLog))

                    Dim strTipoOperacion As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION"))
                    Dim strDescTipoOperacion As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIV_DESCTIPOOPERACION"))
                    Dim strKey_TipoOperRenovacionPostago = ReadKeySettings.Key_TipoOperRenovacionPostago

                    Dim telefono_PMovil As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO"))
                    Dim codigo_PMovil As String = String.Empty
                    Dim mensaje_PMovil As String = String.Empty

                    Try
                        If (strTipoOperacion = strKey_TipoOperRenovacionPostago.Split("|")(0) And strDescTipoOperacion = strKey_TipoOperRenovacionPostago.Split("|")(1)) Then

                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Tipo de Operacion es Renovacion Postpago", strIdentifyLog))


                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro entrada] [{1}]", strIdentifyLog, telefono_PMovil))
                            dsResult = objPvu.Consultar_ProteccionMovil_Equipo(telefono_PMovil, codigo_PMovil, mensaje_PMovil)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro salida codigo] [{1}]", strIdentifyLog, codigo_PMovil))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro salida mensaje:] [{1}]", strIdentifyLog, mensaje_PMovil))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Fin Ejecucion  Proteccion movil Venta]", strIdentifyLog))
                            Dim nroCertiReq As String = String.Empty
                            Dim nroTelefono As String = String.Empty
                            Dim CodMaterialOrigen As String = String.Empty
                            Dim desMaterialOrigen As String = String.Empty
                            Dim ImeiOrigen As String = String.Empty
                            Dim CodPuntVenta As String = String.Empty
                            Dim CodMaterialNuevo As String = String.Empty
                            Dim DesMaterialNuevo As String = String.Empty
                            Dim ImeiNuevo As String = String.Empty
                            Dim ImeiNuevoRecortado As String = String.Empty
                            Dim ValidarImei As String = String.Empty
                            Dim Longitud As Int16 = 0
                            Dim EstadoSeguro As String = String.Empty
                            Dim FechaAfiliacion As String = String.Empty
                            Dim Nro_Rpta_nuevo As String = String.Empty
                            Dim dtPM As New DataTable
                            If (dsResult.Tables.Count > 0) Then
                                dtPM = dsResult.Tables(0)
                            End If

                            'Validar si la linea tiene proteccion movil
                            If (dtPM.Rows.Count > 0) Then
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [La Linea cuenta con proteccion movil]", strIdentifyLog))
                                With dtPM.Rows(0)
                                    nroCertiReq = CheckStr(.Item("VENTV_NRO_CERTF_REQ"))
                                    nroTelefono = CheckStr(.Item("VENTV_MSISDN_RPTA"))
                                    CodMaterialOrigen = CheckStr(.Item("VENTV_COD_MAT_REQ"))
                                    desMaterialOrigen = CheckStr(.Item("VENTV_DES_MATERIAL"))
                                    ImeiOrigen = CheckStr(.Item("VENTV_IMEI_REQ"))
                                    CodPuntVenta = CheckStr(.Item("VENTV_COD_PNTO_VENT"))
                                    EstadoSeguro = CheckStr(.Item("VENTC_ESTADO_SEGURO"))
                                    FechaAfiliacion = CheckStr(.Item("VENTD_FECH_SERV_REQ"))
                                End With

                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro entrada nroCertiReq] [{1}]", strIdentifyLog, nroCertiReq))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro entrada nroTelefono] [{1}]", strIdentifyLog, nroTelefono))
                                objPvu.Insertar_SeguroEquipo_Historico(nroTelefono, codigo_PMovil, mensaje_PMovil)

                                If codigo_PMovil = "0" Then 'Ejecucion Correcta
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Éxito al actualizar el histórico de Protección Movil]", strIdentifyLog))
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro salida codigo] [{1}]", strIdentifyLog, codigo_PMovil))
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro salida mensaje] [{1}]", strIdentifyLog, mensaje_PMovil))
                                Else
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Ocurrió un error al actualizar el histórico de Protección Movil]", strIdentifyLog))
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro salida codigo] [{1}]", strIdentifyLog, codigo_PMovil))
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro salida mensaje] [{1}]", strIdentifyLog, mensaje_PMovil))
                                End If 'Fin Ejecucion Correcta

                                Dim iCant As Integer = 0
                                Dim strNotas As String = String.Empty
                                strNotas = ReadKeySettings.Key_NotaErrorTipificacionWS
                                iCant = IIf(CheckInt(ReadKeySettings.Key_CantIntentosPagoRenovacion) = 0, 1, CheckInt(ReadKeySettings.Key_CantIntentosPagoRenovacion))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro cantidad intentos] [{1}]", strIdentifyLog, iCant))
                                If dsPedido.Tables(1).Rows.Count = 1 Then
                                    CodMaterialNuevo = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEC_CODMATERIAL"))
                                    DesMaterialNuevo = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEV_DESCMATERIAL"))
                                    ImeiNuevo = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("SERIC_CODSERIE"))
                                End If

                                ValidarImei = Funciones.CheckStr(ImeiNuevo).PadLeft(18, "0")
                                Longitud = ValidarImei.Length - 15
                                ImeiNuevoRecortado = ValidarImei.Substring(Longitud, 15)

                                If iCant > 0 Then
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro entrada nroTelefono] [{1}]", strIdentifyLog, nroTelefono))
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro entrada CodMaterial] [{1}]", strIdentifyLog, CodMaterialNuevo))
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro entrada DesMaterial] [{1}]", strIdentifyLog, DesMaterialNuevo))
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro entrada nroImeiNuevo] [{1}]", strIdentifyLog, ImeiNuevo))
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro entrada nroImeiNuevoRecortado] [{1}]", strIdentifyLog, ImeiNuevoRecortado))
                                    For iPm As Integer = 1 To iCant
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Numero de Intento] [{1}]", strIdentifyLog, iPm))
                                        objPvu.Actualizar_SeguroEquipo(nroTelefono, CodMaterialNuevo, DesMaterialNuevo, ImeiNuevoRecortado, Nro_Rpta_nuevo, codigo_PMovil, mensaje_PMovil)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro salida codigo] [{1}]", strIdentifyLog, codigo_PMovil))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro salida mensaje] [{1}]", strIdentifyLog, mensaje_PMovil))
                                        If codigo_PMovil = "0" Then
                                            strNotas = CheckStr(ReadKeySettings.Key_NotaExitoTipificacionWS)
                                            Exit For
                                        End If
                                    Next
                                    'If codigo_PMovil = "0" Then ' Validacion Si ejecuta el update correcto
                                    Dim strMetodo As String = String.Empty
                                    Try

                                        Dim dtHistoricoEval As DataTable
                                        Dim objProteccionMovil As New COM_SIC_Activaciones.clsProteccionMovil
                                        Dim oWSGestionaPostventa As New BWGestionaPostventaProteccionMovil
                                        Dim strCodRpta As String = String.Empty
                                        Dim strMsgRpta As String = String.Empty
                                        Dim strEstadoTipificacion As String = "A"
                                        Dim strCodEquipoNuevo As String = CodMaterialNuevo ' obligatorio
                                        Dim strIdTransaccion As String = DateTime.Now.ToString("yyyyMMddHHmmssfff") ' obligatorio
                                        Dim strIPAplicacion As String = CurrentTerminal ' obligatorio
                                        Dim strNombaplicacion As String = ConfigurationSettings.AppSettings("constAplicacion") ' obligatorio
                                        Dim strUsrProceso As String = CurrentUser ' obligatorio
                                        Dim strSUBClase As String = CheckStr(ReadKeySettings.Key_SubClaseRenovacionTipificaWS)
                                        Dim strNroCertificado As String = nroCertiReq ' obligatorio
                                        Dim strAgente As String = CurrentUser ' obligatorio
                                        Dim strFechaAfiliacion As String = Format(CDate(FechaAfiliacion), "yyyy-MM-dd") ' obligatorio
                                        Dim strOperacionVenta As String = CheckStr(ReadKeySettings.Key_TipoOperRenoTipificacion)
                                        Dim strMontoPrimaActual As String = String.Empty
                                        Dim strDeducibleDanoActual As String = String.Empty
                                        Dim strDeducibleRoboactual As String = String.Empty
                                        Dim strDescEquipoActual As String = DesMaterialNuevo ' obligatorio
                                        Dim strImeiActual As String = ImeiNuevoRecortado ' obligatorio
                                        Dim strDescEquipoAnterior As String = desMaterialOrigen ' obligatorio
                                        Dim strImeiAnterior As String = ImeiOrigen ' obligatorio
                                        Dim strMontoPrimaAnterior As String = String.Empty
                                        Dim strDeducibleDanoAnterior As String = String.Empty
                                        Dim strDeducibleRoboAnterior As String = String.Empty
                                        Dim strFechaCambioEquipo As String = String.Empty
                                        Dim strFechaCompraEquipo As String = String.Empty
                                        Dim strFlagPlantilla As String = CheckStr(ReadKeySettings.Key_FlagPlantillaRenoTipificaWS) ' obligatorio
                                        Dim strIdTransaccionRpta As String = String.Empty
                                        Dim strCACEntrega As String = CodPuntVenta ' obligatorio
                                        Dim strNroSiniestro As String = String.Empty
                                        Dim strTipoSiniestro As String = String.Empty
                                        Dim strFechaPago As String = DateTime.Now.ToString("yyyy-MM-dd") ' obligatorio
                                        Dim strDevuelveEquipo As String = String.Empty
                                        Dim strMontoDeduSiniestro As String = String.Empty
                                        Dim strMotivoCancel As String = CheckStr(ReadKeySettings.Key_MotivoCancelTipificacionWS) ' obligatorio
                                        Dim strTelefono As String = String.Empty
                                        strTelefono = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO"))

                                        strMetodo = "TipificarProteccionMovil"
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [INICIO TIPIFICACION PROTECCION MOVIL PROY-31836]", strIdentifyLog))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Ruta WS] [{1}]", strIdentifyLog, ConfigurationSettings.AppSettings("consGestionaPostventaProteccionMovilWS_URL")))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Metodo] [{1}]", strIdentifyLog, strMetodo))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [IdTransaccion] [{1}]", strIdentifyLog, strIdTransaccion))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [IP Aplicacion] [{1}]", strIdentifyLog, strIPAplicacion))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Nombre aplicacion ] [{1}]", strIdentifyLog, strNombaplicacion))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Codigo Usuario] [{1}]", strIdentifyLog, CurrentUser))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Usuario Proceso] [{1}]", strIdentifyLog, strUsrProceso))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Codigo Agente] [{1}]", strIdentifyLog, strAgente))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Descripcion Notas] [{1}]", strIdentifyLog, strNotas))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Descripcion Subclase] [{1}]", strIdentifyLog, strSUBClase))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Numero Telefono] [{1}]", strIdentifyLog, strTelefono))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Numero Certificado] [{1}]", strIdentifyLog, strNroCertificado))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Fecha Afiliacion] [{1}]", strIdentifyLog, strFechaAfiliacion))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Estado Tipificacion] [{1}]", strIdentifyLog, strEstadoTipificacion))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Operacion Venta] [{1}]", strIdentifyLog, strOperacionVenta))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Equipo Actual] [{1}]", strIdentifyLog, strDescEquipoActual))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Imei Actual] [{1}]", strIdentifyLog, strImeiActual))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Equipo Anterior] [{1}]", strIdentifyLog, strDescEquipoAnterior))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Imei Anterior] [{1}]", strIdentifyLog, strImeiAnterior))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Motivo Cancelacion] [{1}]", strIdentifyLog, strMotivoCancel))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Flag Plantilla] [{1}]", strIdentifyLog, strFlagPlantilla))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Codido PDV] [{1}]", strIdentifyLog, strCACEntrega))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Motivo Cancelacion] [{1}]", strIdentifyLog, strMotivoCancel))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Fecha Pago] [{1}]", strIdentifyLog, strFechaPago))


                                        oWSGestionaPostventa.RegistrarTipificacion(strIdTransaccion, strIPAplicacion, strNombaplicacion, CurrentUser, strUsrProceso, _
                                                                                    strAgente, strNotas, strSUBClase, strTelefono, strNroCertificado, strFechaAfiliacion, strEstadoTipificacion, _
                                                                                    strOperacionVenta, strDescEquipoActual, strImeiActual, strMontoPrimaActual, strDeducibleDanoActual, _
                                                                                    strDeducibleRoboactual, strDescEquipoAnterior, strImeiAnterior, strMontoPrimaAnterior, _
                                                                                    strDeducibleDanoAnterior, strDeducibleRoboAnterior, strFechaCambioEquipo, strFechaCompraEquipo, strFlagPlantilla, _
                                                                                    strCACEntrega, strNroSiniestro, strTipoSiniestro, strFechaPago, strDevuelveEquipo, strMontoDeduSiniestro, strMotivoCancel, _
                                                                                    strIdTransaccionRpta, strCodRpta, strMsgRpta)

                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [OUT  Id Transaccion] [{1}]", strIdentifyLog, strIdTransaccionRpta))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [OUT Cod. Rpta] [{1}]", strIdentifyLog, strCodRpta))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [OUT Msj. Rpta] [{1}]", strIdentifyLog, strMsgRpta))

                                    Catch ex As Exception
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [ERROR en el método] [{1}]", strIdentifyLog, strMetodo))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [ERROR Tipificacion] [{1}]", strIdentifyLog, ex.Message.ToString()))
                                    Finally
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [FIN TIPIFICACION PROTECCION MOVIL PROY-31836]", strIdentifyLog))
                                    End Try

                                End If 'Fin validacion mayor a 0

                            Else
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [La Linea NO con proteccion movil]", strIdentifyLog))
                            End If
                        Else
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Tipo de Operacion no es Renovacion Postpago", strIdentifyLog))
                        End If

                    Catch ex As Exception
                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [ERROR Ejecutar  Proteccion movil Venta] [{1}]", strIdentifyLog, ex.Message.ToString()))
                    Finally
                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [FIN Validacion Mejoras Proteccion movil Renovacion  CAC - PROY-31836]", strIdentifyLog))
                    End Try

                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [FIN Validacion Mejoras Proteccion movil Renovacion  CAC - PROY-31836]", strIdentifyLog))

                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [INICIO Validacion Mejoras Proteccion movil Pago Deducible  CAC - PROY-31836]", strIdentifyLog))

                    Try
                        If AppPagoDeducible.ToString.Length > 0 Then
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Se encontró pago de deducible]", strIdentifyLog))
                            Dim objProteccionMovil As New COM_SIC_Activaciones.clsProteccionMovil
                            Dim dsListaSiniestros As DataSet
                            Dim dtRobo As New DataTable
                            Dim dtConsulta As New DataTable
                            Dim oFila() As DataRow
                            Dim cod, msje As String
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [INICIO METODO Consulta_linea_robo BSCS]", strIdentifyLog))
                            Try
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro entrada nroTelefono] [{1}]", strIdentifyLog, telefono_PMovil))
                                dsListaSiniestros = objProteccionMovil.Consulta_linea_robo(telefono_PMovil, cod, msje)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro salida codigo] [{1}]", strIdentifyLog, cod))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro salida mensaje] [{1}]", strIdentifyLog, msje))
                            Catch ex As Exception
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [ERROR en Consulta_linea_robo BSCS] [{1}]", strIdentifyLog, ex.Message.ToString()))
                            Finally
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [FIN METODO Consulta_linea_robo BSCS]", strIdentifyLog))
                            End Try

                            If Not dsListaSiniestros Is Nothing Then
                                If dsListaSiniestros.Tables.Count > 0 Then dtConsulta = dsListaSiniestros.Tables(0)
                            End If
                            If dtConsulta.Rows.Count > 0 Then
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Consulta devolvio data, se validara siniestros robo]", strIdentifyLog))
                                dtRobo.Columns.Add("V_NRO_CERTIF_REQ")
                                dtRobo.Columns.Add("V_NRO_SINIESTRO")
                                dtRobo.Columns.Add("C_ESTADO_SINIEST")
                                dtRobo.Columns.Add("V_TIPO_OPERACION")
                                dtRobo.Columns.Add("V_IMEI_NUEVO")
                                dtRobo.Columns.Add("V_IMEI_ORIG")
                                dtRobo.Columns.Add("V_MODELO_EQUIPO")
                                dtRobo.Columns.Add("V_MARCA_EQUIPO")
                                dtRobo.Columns.Add("V_MODELO_NUEVO")
                                dtRobo.Columns.Add("V_MARCA_NUEVO")
                                dtRobo.Columns.Add("D_FECHA_OP")
                                oFila = dtConsulta.Select("V_TIPO_OPERACION = 'ROBO'", "D_FECHA_OP DESC")
                                For Each dr As DataRow In oFila
                                    dtRobo.ImportRow(dr)
                                Next
                                If dtRobo.Rows.Count > 0 Then ' LINEA CON HISTORIAL SINISESTRO ROBO
                                    Dim cod_msje, msje_res As String
                                    Try
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [LINEA {1} CUENTA CON SINIESTRO ROBO]", strIdentifyLog, telefono_PMovil))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [INICIO METODO Insertar_Siniestro_Robo]", strIdentifyLog))
                                        Dim Nro_Siniestro As String = String.Empty
                                        Dim Nro_Certif As String = String.Empty
                                        Dim TipoDesc_Siniestro As String = String.Empty
                                        Dim Marca_Equipo_Orig As String = String.Empty
                                        Dim Modelo_Equipo_Orig As String = String.Empty
                                        Dim IMEI_Equipo_Orig As String = String.Empty
                                        Dim Estado_Siniestro As String = "0"
                                        Dim IMEI_Equipo_Orig_Recortado As String = String.Empty
                                        Dim ValidarIMEI_Equipo_Orig As String = String.Empty
                                        Dim LongitudIMEI_Equipo_Orig As Int16 = 0

                                        With dtRobo.Rows(0)
                                            Nro_Siniestro = CheckStr(.Item("V_NRO_SINIESTRO"))
                                            Nro_Certif = CheckStr(.Item("V_NRO_CERTIF_REQ"))
                                            TipoDesc_Siniestro = CheckStr(.Item("V_TIPO_OPERACION"))
                                            Marca_Equipo_Orig = CheckStr(.Item("V_MARCA_EQUIPO"))
                                            Modelo_Equipo_Orig = CheckStr(.Item("V_MODELO_EQUIPO"))
                                            IMEI_Equipo_Orig = CheckStr(.Item("V_IMEI_ORIG"))
                                        End With

                                        ValidarIMEI_Equipo_Orig = Funciones.CheckStr(IMEI_Equipo_Orig).PadLeft(18, "0")
                                        LongitudIMEI_Equipo_Orig = ValidarIMEI_Equipo_Orig.Length - 15
                                        IMEI_Equipo_Orig_Recortado = ValidarIMEI_Equipo_Orig.Substring(LongitudIMEI_Equipo_Orig, 15)

                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Nro_Siniestro:] [{1}]", strIdentifyLog, Nro_Siniestro))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Nro_Certificado] [{1}]", strIdentifyLog, Nro_Certif))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Tipo_Siniestro] [{1}]", strIdentifyLog, TipoDesc_Siniestro))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Desc_Siniestro] [{1}]", strIdentifyLog, TipoDesc_Siniestro))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Num_Telefono] [{1}]", strIdentifyLog, telefono_PMovil))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Marca_Equipo_Origen] [{1}]", strIdentifyLog, Marca_Equipo_Orig))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Modelo_Equipo_Origen] [{1}]", strIdentifyLog, Modelo_Equipo_Orig))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [IMEI_Equipo_Origen] [{1}]", strIdentifyLog, IMEI_Equipo_Orig))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [IMEI_Equipo_Orig_Recortado] [{1}]", strIdentifyLog, IMEI_Equipo_Orig_Recortado))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Estado_Siniestro] [{1}]", strIdentifyLog, Estado_Siniestro))

                                        objPvu.Insertar_Siniestro_Robo(Nro_Siniestro, Nro_Certif, telefono_PMovil, TipoDesc_Siniestro, _
                                                                                        TipoDesc_Siniestro, Marca_Equipo_Orig, Modelo_Equipo_Orig, IMEI_Equipo_Orig_Recortado, _
                                                                                        Estado_Siniestro, CurrentUser, cod_msje, msje_res)

                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Cod retorno] [{1}]", strIdentifyLog, cod_msje))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Msje retorno] [{1}]", strIdentifyLog, msje_res))
                                    Catch ex As Exception
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Error en Insertar_Siniestro_Robo]", strIdentifyLog))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Msje Error] [{1}]", strIdentifyLog, ex.Message.ToString()))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Cod retorno] [{1}]", strIdentifyLog, cod_msje))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Msje retorno] [{1}]", strIdentifyLog, msje_res))
                                    Finally
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [FIN METODO Insertar_Siniestro_Robo]", strIdentifyLog))
                                    End Try
                                Else
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [LINEA {1} NO CUENTA CON SINIESTRO ROBO]", strIdentifyLog, telefono_PMovil))
                                End If
                            End If
                        Else
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [No se encontró pago del deducible]", strIdentifyLog))
                        End If
                    Catch ex As Exception
                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Error en  VALIDACION PAGO DEDUCIBLE] [{1}]", strIdentifyLog, ex.Message.ToString()))
                    End Try
                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [FIN Validacion Mejoras Proteccion movil Pago Deducible  CAC - PROY-31836]", strIdentifyLog))

                    'Fin PROY-31836 IDEA-43582_Mejora de Procesos Postventa del servicio Proteccion Movil

                    'dsResult = objConsultaMssap.ConsultaPedido(drPagos.Item("PEDIN_NROPEDIDO"), "", "")

                    'If Not IsNothing(dsResult) Then

                    '    Try
                    '        'modificacion registro de importe recibido y vuelto
                    '        Dim decImpPen, decImpUsd, decVuelto As Decimal
                    '        decImpPen = Decimal.Parse(IIf(txtRecibidoPen.Trim() = "", "0.00", txtRecibidoPen))
                    '        decImpUsd = Decimal.Parse(IIf(txtRecibidoUsd.Trim() = "", "0.00", txtRecibidoUsd))
                    '        decVuelto = Decimal.Parse(IIf(txtVuelto.Trim() = "", "0.00", txtVuelto))

                    '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio FP_Cab_Oper.")
                    '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 1:" & AppCanal)
                    '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 2:" & AppAlmacen)
                    '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 3:" & ConfigurationSettings.AppSettings("codAplicacion"))
                    '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 4:" & AppUsuario)
                    '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 5:" & dsResult.Tables(0).Rows(0).Item("CLIEC_TIPODOCCLIENTE"))
                    '        'TODOEB objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 6:" & dsResult.Tables(0).Rows(0).Item("CLIENTE"))
                    '        'TODOEB objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 7:" & dsResult.Tables(0).Rows(0).Item("TIPO_DOCUMENTO"))
                    '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 8:" & drPagos.Item("PEDIN_NROPEDIDO"))
                    '        'TODOEB objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 9:" & dsResult.Tables(0).Rows(0).Item("REFERENCIA"))
                    '        'TODOEB objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 10:" & dsResult.Tables(0).Rows(0).Item("TOTAL_MERCADERIA"))
                    '        'TODOEB objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 11:" & dsResult.Tables(0).Rows(0).Item("TOTAL_IMPUESTO"))
                    '        'TODOEB objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 12:" & dsResult.Tables(0).Rows(0).Item("TOTAL_DOCUMENTO"))
                    '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 13:" & "P")
                    '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 14:" & CStr(decImpPen))
                    '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 15:" & CStr(decImpUsd))
                    '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 16:" & CStr(decVuelto))

                    '        'TODOE
                    '        'intOper = objCajas.FP_Cab_Oper(Session("CANAL"), Session("ALMACEN"), ConfigurationSettings.AppSettings("codAplicacion"), Session("Usuario"), dsResult.Tables(0).Rows(0).Item("CLIEC_TIPODOCCLIENTE"), _
                    '        ' dsResult.Tables(0).Rows(0).Item("CLIEV_NRODOCCLIENTE"), dsResult.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA"), drPagos.Item("PEDIN_NROPEDIDO"), dsResult.Tables(0).Rows(0).Item("PEDIV_NROREFNCND"), _
                    '        ' dsResult.Tables(0).Rows(0).Item("INPAN_TOTALMERCADERIA"), dsResult.Tables(0).Rows(0).Item("INPAN_TOTALIMPUESTO"), dsResult.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO"), "P", _
                    '        ' decImpPen, decImpUsd, decVuelto)

                    '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "out intOper:" & CStr(intOper))
                    '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin FP_Cab_Oper.")

                    '        Dim iRespDetalle As Integer
                    '        For i = 0 To dsResult.Tables(1).Rows.Count - 1
                    '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio FP_Det_Oper.")
                    '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 1: " & CStr(intOper))
                    '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 2: " & CStr((i + 1)))
                    '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 3: " & dsResult.Tables(1).Rows(i).Item("DEPEC_CODMATERIAL"))
                    '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 4: " & dsResult.Tables(1).Rows(i).Item("SERIC_CODSERIE"))
                    '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 5: " & dsResult.Tables(1).Rows(i).Item("DEPEV_NROTELEFONO"))
                    '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 6: " & dsResult.Tables(1).Rows(i).Item("DEPEN_CANTIDAD"))
                    '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 7: " & dsResult.Tables(1).Rows(i).Item("DEPEN_SUBTOTAL"))
                    '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 8: " & dsResult.Tables(1).Rows(i).Item("DEPEN_IMPUESTO"))
                    '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 9: " & dsResult.Tables(1).Rows(i).Item("DEPEN_SUBTOTAL") + dsResult.Tables(1).Rows(i).Item("DEPEN_IMPUESTO"))

                    '            'TODOE
                    '            'iRespDetalle = objCajas.FP_Det_Oper(intOper, i + 1, dsResult.Tables(1).Rows(i).Item("DEPEC_CODMATERIAL"), dsResult.Tables(1).Rows(i).Item("SERIC_CODSERIE"), dsResult.Tables(1).Rows(i).Item("DEPEV_NROTELEFONO"), _
                    '            'dsResult.Tables(1).Rows(i).Item("DEPEN_CANTIDAD"), dsResult.Tables(1).Rows(i).Item("DEPEN_SUBTOTAL"), dsResult.Tables(1).Rows(i).Item("DEPEN_IMPUESTO"), dsResult.Tables(1).Rows(i).Item("DEPEN_SUBTOTAL") + dsResult.Tables(1).Rows(i).Item("DEPEN_IMPUESTO"))

                    '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "out iRespDetalle: " & CStr(iRespDetalle))
                    '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin FP_Det_Oper.")
                    '        Next

                    '        Dim arrDetPago() As String
                    '        Dim arrLinDetPago() As String
                    '        arrDetPago = Split(strDetallePago, "|")
                    '        'PROY-27440 INI
                    '        Dim strDocumento As String = ""
                    '        'PROY-27440 FIN
                    '        For i = 0 To hidNumFilas - 1
                    '            arrLinDetPago = Split(arrDetPago(i), ";")

                    '            'PROY-27440 INI
                    '            'Dim objTxt As TextBox
                    '            'objTxt = CType(Me.FindControl("txtDoc" & i), TextBox)
                    '            'strDocumento = "" : strDocumento = Trim(objTxt.Text)
                    '            'PROY-27440 FIN

                    '            strDocumento = ApptxtDoc1

                    '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio FP_Pag_Oper.")
                    '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 1: " & CStr(intOper))
                    '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 2: " & CStr((i + 1)))
                    '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 3: " & arrLinDetPago(2))
                    '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 4: " & strDocumento) 'PROY-27440
                    '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 5: " & arrLinDetPago(5))

                    '            'TODOE
                    '            'iRespDetalle = objCajas.FP_Pag_Oper(intOper, i + 1, arrLinDetPago(2), Request.Item("txtDoc" & (i + 1)), CDbl(arrLinDetPago(5)))

                    '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "out iRespDetalle: " & CStr(iRespDetalle))
                    '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin FP_Pag_Oper.")
                    '        Next
                    '    Catch ex As Exception
                    '        'INI PROY-140126
                    '        Dim MaptPath As String
                    '        MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                    '        MaptPath = "( Class : " & MaptPath & "; Function: guardarConectado)"
                    '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR DiarioElectronico:" & ex.Message.ToString() & MaptPath)
                    '        MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                    '        MaptPath = "( Class : " & MaptPath & "; Function: guardarConectado)"
                    '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR DiarioElectronico:" & ex.StackTrace.ToString() & MaptPath)
                    '        'FIN PROY-140126 

                    '        ' Session.Add("msgErrorGenerarSot", "No se pudo registrar detalle pago.")
                    '        AppmsgErrorGenerarSot = "No se pudo registrar detalle pago."
                    '    End Try
                    'End If


                    'INICIO PROY-140600 -  IDEA 142054 Contablizar líneas a personas extranjeras

                    'Dim strNumContrato As String = Funciones.CheckStr(objContrato.Tables(0).Rows(0).Item("ID_CONTRATO"))
                    'Dim strNumeroPedido As String = Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO"))
                    'Dim strTipoVenta As String = Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA"))
                    'Dim strUsuarioPago As String = AppstrUsuario

                    'ActualizarInfoConteoLineasCliente(strNumContrato, strNumeroPedido, strUsuarioPago)

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ActualizarInfoConteoLineasCliente INI ")
                    Try

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ActualizarInfoConteoLineasCliente: strNro_cont : " & strNro_cont)
                        Dim strNumContrato As String = strNro_cont '//Funciones.CheckStr(objContrato.Tables(0).Rows(0).Item("ID_CONTRATO"))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ActualizarInfoConteoLineasCliente: strNumContrato : " & strNumContrato)
                    Dim strNumeroPedido As String = Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO"))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ActualizarInfoConteoLineasCliente: strNumeroPedido : " & strNumeroPedido)
                    Dim strTipoVenta As String = Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA"))

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ActualizarInfoConteoLineasCliente: strTipoVenta : " & strTipoVenta)

                        Dim strUsuarioPago As String = Funciones.CheckStr(AppstrUsuario)

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ActualizarInfoConteoLineasCliente: strUsuarioPago : " & strUsuarioPago)

                    ActualizarInfoConteoLineasCliente(strNumContrato, strNumeroPedido, strUsuarioPago)
                    Catch ex As Exception
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR actualizarInfoConteoLineasCliente " & EX.Message)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR actualizarInfoConteoLineasCliente " & EX.StackTrace)
                    End Try
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ActualizarInfoConteoLineasCliente FIN ")

                    'FIN PROY-140600 -  IDEA 142054 Contablizar líneas a personas extranjeras


                    'Validar impresion de ticket equipo prepago
                    Dim flagVentaEquipoPrepago As String = "0"
                    If drPagos.Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVPrepago") Then
                        Dim blnConEquipo As Boolean
                        blnConEquipo = validaVentaEquipo("", dsPedido.Tables(1))
                        If blnConEquipo Then
                            flagVentaEquipoPrepago = "1"
                        End If
                    End If

                    'dsResult = objPagos.Get_ParamGlobal(Session("ALMACEN"))
                    'TODOE: Validar si es correcta la consulta
                    Try
                        Dim objOffline As New COM_SIC_OffLine.clsOffline
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Inicio Parametros Venta--")
                        dsResult = objOffline.ParametrosVenta(AppAlmacen)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Fin Parametros Venta--")
                    Catch ex As Exception
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--ERROR Parametros Venta-- " & ex.Message)
                    End Try

                    '*** Log de registro ****'
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Grabar pagos.")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")

                    ' PROY-27790-IDEA-35384- Venta y Post venta de equipos PLC :: NGC  -   08/06/2017

                    TipificacionRegistraActualiza(dsPedido)

                    'end PROY-27790-IDEA-35384- Venta y Post venta de equipos PLC :: NGC   -   08/06/2017

                    'PROY-33313 RP INICIO
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Validacion de Actualizacion del FlagEnvio - INICIO")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Valor K_DESLOG : " & Funciones.CheckStr(K_DESLOG))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Valor DEPEN_NROCUOTA : " & Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA")))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Valor PEDIC_CODTIPOOPERACION : " & Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION")))
                    If K_DESLOG.Equals("OK") Then
                        If dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVPostpago") And dsDatosPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA") = 1 And dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION") = ConfigurationSettings.AppSettings("COD_OPERACION_REPOSICION") Then
                            ActualizaFlagCuota(Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")))
                        End If
                        If dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVPostpago") And dsDatosPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA") = 1 And dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION") = ConfigurationSettings.AppSettings("COD_OPERACION_ALTAyPORTABILIDAD") And ValidarModalidadVentaChipSuelto(strNroSEC) Then
                            ActualizaFlagCuota(Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")))
                            TipificarChipSueltoUnaCuota(Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")), dsDatosPedido, strNroSEC)
                        ElseIf dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVPostpago") And dsDatosPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA") = 1 And dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION") = ConfigurationSettings.AppSettings("COD_OPERACION_ALTAyPORTABILIDAD") Then    'PROY-140360-IDEA-46301
                            Dim clsConsultaPagos As New WebComunes
                            If (clsConsultaPagos.ValidarModalidadVentaContratoCode(strNroSEC)) Then
                                TipificarContratoCodeUnaCuota(Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")), dsDatosPedido, strNroSEC)
                            End If
                        End If
                    End If
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Validacion de Actualizacion del FlagEnvio - FIN")
                    'PROY-33313 RP FIN

                    '==asignamos los paràmetros para hacer la impresiòn - " ":=============================='
                    '***********DOLARES
                    'Dim RecibidoDolares As Double
                    'RecibidoDolares = CDbl(txtTipoCambio) * CDbl(txtRecibidoUsd)
                    'strDocSunat = ""
                    'Dim pTipDoc As String = ""

                    ''If chkImprimir.Checked Then
                    'Try
                    '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                    '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Llama a la impresiòn del documento: " & Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")))

                    '    sUrl &= "?pImp=S" & _
                    '   "&pDocSap=" & strDocSap & _
                    '   "&pDocSunat=" & strDocSunat & _
                    '   "&pNroDG=" & strNroDG & _
                    '           "&pTipDoc=" & pTipDoc & _
                    '           "&strEfectivo=" & txtNeto & _
                    '           "&strRecibidoUS=" & CStr(RecibidoDolares) & _
                    '           "&strRecibido=" & txtRecibidoPen & _
                    '           "&strEntregar=" & txtVuelto & _
                    '           "&flagVentaEquipoPrepago=" & flagVentaEquipoPrepago & _
                    '           "&strOrigen=" & 1
                    'Catch ex As Exception
                    '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Pedido ya fue pagado.")
                    '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Error al tratar de ejecutar la impresiòn.")
                    '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                    'End Try

                    'End If
                    '============================================================================================='
                    '*** Llama al poolPagos y hace la impresiòn ****'
                    'sUrl &= "?pImp=S"

                    '**** PROY-25335-Contratacion Electronica Release 2 - INICIO
                    Try
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "-----------------INICIO Generar SubProcesoHIT----------------------------------")
                        '<33062>
                        SubProcesoHIT(strIdentifyLog, Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")), Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("CLIEV_NOMBRE")), _
                                      Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("CLIEC_TIPODOCCLIENTE")), Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("CLIEV_NRODOCCLIENTE")), _
                                      Funciones.CheckStr(objContrato.Tables(0).Rows(0).Item("ID_CONTRATO")), Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("PEDIC_CANALVENTA")), _
                                      Funciones.CheckStr(sTipoOperacion), Funciones.CheckStr(sDescripcionOperacion), dsPedido)
                        '</33062>

                    Catch ex As Exception
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Pedido ya fue pagado.")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Error al Generar SubProcesoHIT.")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                    End Try
                    '**** PROY-25335-Contratacion Electronica Release 2 - FIN

                    'Session("msgErrorGenerarSot") = ""      '*** limpiamos el mensaje *****'
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- sUrl: " & sUrl)
                    'Response.Redirect(sUrl, False)                 '*** llamamos al pool pagos ***'
                    '***********************************************'
                End If
                'End If
            End If
            'End If
            Limpiar_datos_id_solicitud()  'PROY 32089


        Catch ex As Exception

            AppMensajeErrorGeneral = "Ocurrio un error al procesar el Pago."
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0},{1} => {2}", strIdentifyLog, "ERROR guardarConectado", Funciones.CheckStr(ex.Message)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0},{1} => {2}", strIdentifyLog, "ERROR guardarConectado", Funciones.CheckStr(ex.StackTrace)))

        End Try


    End Function


     Private Function Enviar_Email(ByVal strIdTran As String, ByVal strIdAplica As String, _
    ByVal strNameAplica As String, ByVal strUser As String, ByVal NroSec As String, ByVal MsgSercice As String) As String

        Dim strRpta As String = ""

        Dim oEnvioEmail As New BWEnvioCorreo
        oEnvioEmail.EnviarCorreoWS(strIdTran, strIdAplica, strNameAplica, strUser, NroSec, MsgSercice, strRpta)
        oEnvioEmail = Nothing


        Return strRpta

    End Function

    '=== Fin Mètodo: guardarConectado

    '****** INICIO PROY-25335-Contratacion Electronica Release 2 *********
    '<33062>
    Private Function SubProcesoHIT(ByVal strIdentifyLog As String, ByVal strPEDIN_NROPEDIDO As String, _
                                   ByVal strNomApeCliente As String, ByVal strTipoDocCliente As String, _
                                   ByVal strNroDocCliente As String, ByVal strContrato As String, _
                                   ByVal CodigoCanal As String, ByVal strTipoOperacion As String, _
                                   ByVal strDescripcionOperacion As String, ByVal dsPedido As DataSet)

        '</33062>
        'PROY-32851 :: INI
        Dim strBiomovil As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("ConstTipOpeBioVA"))
        'PROY-32851 :: FIN
        Dim dsAcuerdo As DataSet
        'Obtenemos Nro de Sec
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Inicio Obtener Nro SEC--")
        Dim stNroSec As String
        Dim strNroSEC As String = Me.Obtener_NroSec_PostPagoR2(strPEDIN_NROPEDIDO)
        ConsultaParametros(strIdentifyLog)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Nro Sec : " & strNroSEC)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Fin Obtener Nro SEC--")

        'Validar HIT
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Inicio Validar HIT--")
        Dim dsBio As DataSet
        Dim objConsultaPvu As New clsConsultaPvu
        Dim objTipificacion As New clsTipificacion
        Dim stCodRptaBio As String
        Dim stMsjRptaBio As String
        Dim sttipoDocCliente As String
        Dim strDocIdentidadCliente As String
        Dim strNombresApellidosCliente As String
        Dim strNroPedido As String = Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO"))
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Nro Pedido : " & strNroPedido)
        Dim oInterac As New COM_SIC_INActChip.Interaccion

        strNombresApellidosCliente = strNomApeCliente
        sttipoDocCliente = strTipoDocCliente
        strDocIdentidadCliente = strNroDocCliente

        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Inicio ValidarIdentidad (PKG_VALIDADOR_IDENTIDAD.VIDSS_IDENTIDAD_HIT)--")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo Documento : " & sttipoDocCliente)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Documento Identidad : " & strDocIdentidadCliente)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Nro Sec : " & strNroSEC)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Nro Pedido : " & strNroPedido)
        dsBio = objConsultaPvu.ValidarIdentidad(sttipoDocCliente, strDocIdentidadCliente, strNroSEC, strNroPedido, stCodRptaBio, stMsjRptaBio) 
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Codigo respuesta : " & stCodRptaBio)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje respuesta : " & stMsjRptaBio)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Fin ValidarIdentidad (PKG_VALIDADOR_IDENTIDAD.VIDSS_IDENTIDAD_HIT)--")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Fin Validar HIT--")

        If stCodRptaBio.Equals("0") Then
        'PROY-32851 :: INI
            If Not dsBio Is Nothing AndAlso dsBio.Tables.Count > 0 AndAlso dsBio.Tables(0).Rows.Count > 0 Then
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "=== INICIO PROY-32851 ===")
                Dim strOperacionValidaHit = Funciones.CheckStr(dsBio.Tables(0).Rows(0).Item("BIOM_TIP_OPERACION"))
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "strOperacionValidaHit: " & strOperacionValidaHit)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "strBiomovil: " & strBiomovil)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "=== FIN PROY-32851 ===")
                If Not strOperacionValidaHit.IndexOf(strBiomovil) > -1 Then
        'PROY-32851 :: FIN
            'INICIO - CONSULTA SI SE REALIZO FIRMA DIGITAL
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1}", strIdentifyLog, "INI|PROY-25335 IDEA-30752-CONTRATACIÓN ELECTRÓNICA - RELEASE 2|BtnGrabar|MÉTODO: ConsultarExpedienteVenta"))
            Dim BLContratacionElectronicaR2 As New COM_SIC_Activaciones.clsConsultaPvu
            Dim BEExpedienteVentaR2 As New BEExpedienteVenta
            Dim strMsjExpVentaR2 As String
            Dim strcodExpVentaR2 As String
            Dim Flag_FirmaDigital As String

                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1}{2}", strIdentifyLog, "INI|PROY-25335 IDEA-30752-CONTRATACIÓN ELECTRÓNICA - RELEASE 2|BtnGrabar|MÉTODO: ConsultarExpedienteVenta| Nro Contrato: ", Funciones.CheckStr(strContrato)))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1}{2}", strIdentifyLog, "INI|PROY-25335 IDEA-30752-CONTRATACIÓN ELECTRÓNICA - RELEASE 2|BtnGrabar|MÉTODO: ConsultarExpedienteVenta| Nro Pedido: ", Funciones.CheckStr(strNroPedido)))

                    'PROY-140578 INICIO
                    Dim srtTipoVentaPrepago As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA"))
                    If (Funciones.CheckStr(srtTipoVentaPrepago) = ConfigurationSettings.AppSettings("strTVPrepago")) Then
                        BEExpedienteVentaR2 = BLContratacionElectronicaR2.ConsultarExpedienteVentaPrepago(Funciones.CheckInt(strNroPedido), strcodExpVentaR2, strMsjExpVentaR2)
                    Else
                        BEExpedienteVentaR2 = BLContratacionElectronicaR2.ConsultarExpedienteVenta(Funciones.CheckStr(strContrato), strcodExpVentaR2, strMsjExpVentaR2)
                    End If
                    'PROY-140578 FIN
                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1}{2}", strIdentifyLog, "INI|PROY-25335 IDEA-30752-CONTRATACIÓN ELECTRÓNICA - RELEASE 2|BtnGrabar|MÉTODO: ConsultarExpedienteVenta| Codigo Respuesta: ", Funciones.CheckStr(strcodExpVentaR2)))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1}{2}", strIdentifyLog, "INI|PROY-25335 IDEA-30752-CONTRATACIÓN ELECTRÓNICA - RELEASE 2|BtnGrabar|MÉTODO: ConsultarExpedienteVenta| Mensaje Respuesta: ", Funciones.CheckStr(strMsjExpVentaR2)))

                    If Not BEExpedienteVentaR2 Is Nothing Then
                        Flag_FirmaDigital = Funciones.CheckStr(BEExpedienteVentaR2.SEVN_TIPO_EXPEDIENTE)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1}{2}", strIdentifyLog, "FIN|PROY-25335 IDEA-30752-CONTRATACIÓN ELECTRÓNICA - RELEASE 2|BtnGrabar|MÉTODO: ConsultarExpedienteVenta|Tipo Expediente : ", Flag_FirmaDigital))
                    End If
                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1}", strIdentifyLog, "FIN|PROY-25335 IDEA-30752-CONTRATACIÓN ELECTRÓNICA - RELEASE 2|BtnGrabar|MÉTODO: ConsultarExpedienteVenta"))
                    ' FIN - CONSULTA SI SE REALIZO FIRMA DIGITAL



                    If BEExpedienteVentaR2.SEVN_TIPO_EXPEDIENTE = "2" Then
                        'Proceso Pagar
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Inicio Proceso Pfagar--")
                        '--> Consultar Documentos Pendientes por Enviar por Correo
                        Dim beexpven As New BEExpedienteVenta
                        Dim codRptaExpVen As String
                        Dim msjRptaExpVen As String
                        Dim flag_Correo As String
                        Dim dsExpVen As DataSet

                        'PROY-140578 INICIO
                        If (Funciones.CheckStr(srtTipoVentaPrepago) = ConfigurationSettings.AppSettings("strTVPrepago")) Then
                            If Not BEExpedienteVentaR2 Is Nothing Then
                                flag_Correo = Funciones.CheckStr(BEExpedienteVentaR2.SEVN_FLAG_CORREO)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1}{2}", strIdentifyLog, "PROY-140578 SI |BtnGrabar|Variable: Flag Envio Correo : ", flag_Correo))
                            End If
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1}{2}", strIdentifyLog, "PROY-140578 NO |BtnGrabar|Variable: Flag Envio Correo : ", flag_Correo))
                        Else 'PROY-140578 FIN  
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Inicio Proceso ConsultarExpedienteVentaEstado--")
                            dsExpVen = objConsultaPvu.ConsultarExpedienteVentaEstado(strContrato)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Nro Pedido : " & strNroPedido)
                            If dsExpVen.Tables(0).Rows.Count > 0 Then
                                flag_Correo = beexpven.SEVN_FLAG_CORREO
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FLAG CORREO : " & flag_Correo)
                            End If
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Fin Proceso ConsultarExpedienteVentaEstado--")
                        End If

                        

                        '--> VERIFICAR ENVIO DE CORREO
                        If flag_Correo.Equals("0") AndAlso clsKeyAPP.consFlagBlackOut <> "1" Then
                            Dim objBWConsultarDocumentosHP As New BWConsultarDocumentosHP
                            Dim usuarioID As String = CurrentUser

                            'Envio por Correo
                            Dim objClsTipifica As New clsTipificacion
                            Dim Key_ContratacionElectronica As Int64 = 0
                            Dim objAppSetting As New AppSettings

                            'Consulta Email Alterno Cliente
                            Dim dsClienteDatos As New DataSet
                            Dim strCodRptaCorreo, strMsjRptaCorreo As String
                            Dim strDestino As String
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--INICIO Consulta Cliente Email Alterno--")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo Documento : " & sttipoDocCliente)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Numero Documento : " & strDocIdentidadCliente)
                            dsClienteDatos = objConsultaPvu.ConsultaCorreoCliente(sttipoDocCliente, strDocIdentidadCliente, strCodRptaCorreo, strMsjRptaCorreo)
                            If Not dsClienteDatos Is Nothing Then
                                If dsClienteDatos.Tables(0).Rows.Count > 0 Then
                                    strDestino = Funciones.CheckStr(dsClienteDatos.Tables(0).Rows(0).Item("CLIEV_EMAIL_ALTERNO"))
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Email Alterno : " & strDestino)
                                End If
                            End If
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Codigo Respuesta : " & strCodRptaCorreo)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje Respuesta : " & strMsjRptaCorreo)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--FIN Consulta Cliente Email Alterno--")

                            Dim stAsunto As String = objAppSetting.Key_AsuntoCorreo
                            'Dim stMensaje As String = objAppSetting.Key_MensajeAltaPost.Replace("\\n", "\n")
                            Dim strRutaBanner As String = objAppSetting.Key_MensajeAltaPost
                            'Dim stMensajeCorreo As String = String.Format(stMensaje, strNombresApellidosCliente)

                            'PROY-140578 - FIRMAS - INI LM
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--INICIO PROY-140578--")
                            Dim srtTipoVentaF As String = String.Empty
                            Dim srtTipoOperacionF As String = String.Empty
                            Dim srtTipoOperacionDeF As String = String.Empty
                            Dim srtNombresClienteF As String = String.Empty
                            Dim srtLineaF As String = String.Empty
                            Dim strCantidadLineasF As Integer = 0

                            If Not dsPedido Is Nothing Then
                                srtTipoVentaF = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA"))
                                srtTipoOperacionF = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION"))
                                srtTipoOperacionDeF = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIV_DESCTIPOOPERACION"))
                                srtNombresClienteF = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("CLIEV_NOMBRE"))

                                If dsPedido.Tables.Count > 0 Then
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Cantidad de Detalles: " & Funciones.CheckStr(dsPedido.Tables(1).Rows.Count))
                                    If dsPedido.Tables(1).Rows.Count = 1 Then
                                        strCantidadLineasF = 1
                                        srtLineaF = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO"))
                                    Else
                                        For l As Integer = 0 To dsPedido.Tables(1).Rows.Count - 1 'PREPAGO - ALTA Y PORTA = RENO PACK Y RENO EQUIPO NO  TIENE CHIP
                                            If (Funciones.CheckStr(dsPedido.Tables(1).Rows(l).Item("MATEC_TIPOMATERIAL")) = ConfigurationSettings.AppSettings("constChips")) Then
                                                strCantidadLineasF = strCantidadLineasF + 1
                                                If srtLineaF = String.Empty Then
                                                    srtLineaF = Funciones.CheckStr(dsPedido.Tables(1).Rows(l).Item("DEPEV_NROTELEFONO"))
                                                Else
                                                    srtLineaF = String.Format("{0}, {1}", srtLineaF, Funciones.CheckStr(dsPedido.Tables(1).Rows(l).Item("DEPEV_NROTELEFONO")))
                                                End If
                                            End If
                                        Next
                                    End If
                                End If
                            End If

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Inicio Proceso Variables 140578 LM--")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo de venta F: " & srtTipoVentaF) 'LM
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo de operacion F: " & srtTipoOperacionF) 'LM
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo de operacion descripcion F: " & srtTipoOperacionDeF) 'LM
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Numero de Lineas F: " & Funciones.CheckStr(strCantidadLineasF)) 'LM
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Linea F: " & srtLineaF) 'LM
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Nombres Cliente : " & strNombresApellidosCliente)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Nombres Cliente F: " & srtNombresClienteF) 'LM
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Correo Cliente Destino: " & strDestino)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Fin Proceso Variables 140578 LM--")
                            'PROY-140578 - FIRMAS - FIN LM

                            'PROCESO OBTENER CUERPO CORREO - INICIO
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Inicio Proceso OBTENER CUERPO CORREO--")
                            Dim stCuerpoCorreo = ObtenerCuerpoCorreo(sttipoDocCliente, strNombresApellidosCliente, strRutaBanner, strIdentifyLog)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Fin Proceso OBTENER CUERPO CORREO--")
                            'PROCESO OBTENER CUERPO CORREO - FIN

                            Dim strCodMensajeEnvio, strMsjEnvio As String

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Inicio Proceso EnviarDocumentosHP--")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Contrato : " & strContrato)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "UsuarioID : " & usuarioID)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Destino : " & strDestino)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Asunto : " & stAsunto)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "MensajeCorreo : " & stCuerpoCorreo)
                            'objBWConsultarDocumentosHP.EnviarDocumentosHP(strContrato, strDestino, stAsunto, stCuerpoCorreo, usuarioID, strCodMensajeEnvio, strMsjEnvio)
                            'PROY-140578 - FIRMAS - INI
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo Venta: " & srtTipoVentaF)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo Operacion Descripcion: " & srtTipoOperacionDeF)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Numero Pedido: " & strNroPedido)
                            objBWConsultarDocumentosHP.EnviarDocumentosHP(strContrato, strDestino, stAsunto, stCuerpoCorreo, usuarioID, srtTipoVentaF, srtTipoOperacionDeF, strNroPedido, strCodMensajeEnvio, strMsjEnvio)
                            'PROY-140578 - FIRMAS - FIN
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Codigo Respuesta : " & strCodMensajeEnvio)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje Respuesta : " & strMsjEnvio)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Fin Proceso EnviarDocumentosHP--")

                            '-->Registrar Evento de Correo || Registrar Trazabilidad
                            Dim strCodTrazabilidad As String = ""
                            Dim strMsjTrazabilidad As String = ""
                            Dim codcanal As String = Funciones.CheckStr(CodigoCanal)
                            Dim codpdv As String = Funciones.CheckStr(AppAlmacen)
                            Dim idPadre As String

                            Dim objTrazabilidad As New BERegistrarTrazabilidadRequest
                            objTrazabilidad.codCanal = Funciones.CheckStr(codcanal)
                            objTrazabilidad.codigoError = Funciones.CheckStr(strCodMensajeEnvio)
                            objTrazabilidad.codPdv = Funciones.CheckStr(codpdv)
                            objTrazabilidad.idPadre = Funciones.CheckStr(objConsultaPvu.GenerarIdTrazabilidad(1))
                            objTrazabilidad.mensajeProceso = Funciones.CheckStr(strMsjEnvio)
                            objTrazabilidad.numeroDocumento = Funciones.CheckStr(strDocIdentidadCliente)
                            objTrazabilidad.tipoDocumento = Funciones.CheckStr(sttipoDocCliente)
                            idPadre = Funciones.CheckStr(objTrazabilidad.idPadre)

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Inicio Proceso RegistrarTrazabilidad--")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Codigo Canal : " & codcanal)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Codigo Error : " & strCodMensajeEnvio)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Codigo PDV : " & codpdv)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Id Padre : " & idPadre)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje Proceso : " & strMsjEnvio)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Numero Documento : " & strDocIdentidadCliente)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo Documento : " & sttipoDocCliente)
                            RegistrarTrazabilidad(objTrazabilidad, strTipoOperacion, strIdentifyLog, strCodTrazabilidad, strMsjTrazabilidad)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Codigo Respuesta : " & strCodTrazabilidad)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensajes Respuesta : " & strMsjTrazabilidad)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Fin Proceso RegistrarTrazabilidad--")

                            '--> Actualizar Estado del Correo
                            Dim FlagCorreo As Integer = 1
                            Dim codRptaEstado As String
                            Dim msjRptaEstado As String

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Inicio Proceso ActualizarFlagCorreoExpedienteVenta--")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Contrato : " & strContrato)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Flag Correo : " & FlagCorreo)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Usuario ID : " & usuarioID)
                            objConsultaPvu.ActualizarFlagCorreoExpedienteVenta(strContrato, FlagCorreo, usuarioID, codRptaEstado, msjRptaEstado)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Codigo Respuesta : " & codRptaEstado)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensajes Respuesta : " & msjRptaEstado)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Fin Proceso ActualizarFlagCorreoExpedienteVenta--")

                            '-->Crear Tipificacion
                            Dim strTipoProducto As String
                            Dim obdIDContactoClf As String
                            Dim strTelerfono As String
                            Dim stNotas As String
                            Dim i As Integer
                            Dim dsCliente2 As DataSet

                            stNotas = String.Format(Funciones.CheckStr(ConfigurationSettings.AppSettings("consMensajeTipiEnvioCorreo")), strDestino)
                            '<33062>
                            If strTipoOperacion.Equals(ConfigurationSettings.AppSettings("strDTVRenovacion")) Then
                                stNotas = stNotas & "Operación: " & strDescripcionOperacion & " ; "
                                stNotas = stNotas & " SEC: " & strNroSEC & " ; "
                                stNotas = stNotas & " ASESOR: " & CurrentUser
                            End If
                            '</33062>

                            dsAcuerdo = objConsultaPvu.ConsultaAcuerdoPCS(strContrato, DBNull.Value)

                            If Not dsAcuerdo Is Nothing Then
                                If dsAcuerdo.Tables(3).Rows.Count > 0 Then

                                    strTelerfono = dsAcuerdo.Tables(3).Rows(0).Item("TELEFONO")

                                    dsCliente2 = objTipificacion.ConsultaCliente(strTelerfono, "", Funciones.CheckInt64(""), CInt("1"), "", "")

                                    If Not dsCliente2 Is Nothing Then
                                        If dsCliente2.Tables(0).Rows.Count > 0 Then
                                            obdIDContactoClf = dsCliente2.Tables(0).Rows(0).Item("OBJID_CONTACTO")
                                        Else
                                            obdIDContactoClf = ""
                                        End If
                                    End If
                                End If
                            End If
                            '-->ObjetoInteraccionEnvioCorreo
                            Dim objgrupotipi As String = Funciones.CheckStr(objAppSetting.Key_GrupoTipificacionEnvioCorreo).Trim()
                            Dim objgrupotipigeneral As String = Funciones.CheckStr(objAppSetting.Key_GrupoTipificacionEnvioCorreoGen).Trim()
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Key_GrupoTipificacionEnvioCorreo: " & objgrupotipi)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Key_GrupoTipificacionEnvioCorreoGen : " & objgrupotipigeneral)
                            If objgrupotipi = "" Then
                                objgrupotipi = "987165811137"
                            ElseIf objgrupotipigeneral = "" Then
                                objgrupotipigeneral = "987165811136"
                            End If

                            Dim dsparamgrupo As ArrayList
                            Dim dsparamgrupogeneral As ArrayList
                            Dim arrTipisParametrov1 As String()
                            Dim arrTipisParametrov1_1 As String()
                            Dim arrTipisParametrov1_2 As String()
                            Dim arrTipisParametrov1_3 As String()
                            Dim arrTipisParametroGeneral As String()
                            Dim strInteracionID As String
                            Dim strFlagInsercion As String
                            Dim strMsjRptaTipifica As String

                            oInterac.OBJID_CONTACTO = obdIDContactoClf
                            oInterac.TELEFONO = strTelerfono
                            oInterac.NOTAS = stNotas

                            'If codcanal.Equals("01") Then
                            oInterac.AGENTE = usuarioID
                            'End If

                            dsparamgrupo = objConsultaPvu.ConsultaParametros(objgrupotipi)

                            If dsparamgrupo.Count > 0 Then
                                For Each reg As BEParametros In dsparamgrupo
                                    arrTipisParametrov1 = reg.strValor1.Split("|")
                                    arrTipisParametrov1_1 = arrTipisParametrov1(0).Split(";")
                                    arrTipisParametrov1_2 = arrTipisParametrov1(1).Split(";")
                                    arrTipisParametrov1_3 = arrTipisParametrov1(2).Split(";")

                                    oInterac.TIPO_CODIGO = Funciones.CheckStr(arrTipisParametrov1_1(0))
                                    oInterac.TIPO = Funciones.CheckStr(arrTipisParametrov1_1(1))
                                    oInterac.CLASE_CODIGO = Funciones.CheckStr(arrTipisParametrov1_2(0))
                                    oInterac.CLASE = Funciones.CheckStr(arrTipisParametrov1_2(1))
                                    oInterac.SUBCLASE_CODIGO = Funciones.CheckStr(arrTipisParametrov1_3(0))
                                    oInterac.SUBCLASE = Funciones.CheckStr(arrTipisParametrov1_3(1))
                                Next
                            End If

                            dsparamgrupogeneral = objConsultaPvu.ConsultaParametros(objgrupotipigeneral)

                            If dsparamgrupogeneral.Count > 0 Then
                                For Each reg As BEParametros In dsparamgrupogeneral
                                    arrTipisParametroGeneral = reg.strValor.Split("|")

                                    oInterac.METODO = Funciones.CheckStr(arrTipisParametroGeneral(0))
                                    oInterac.TIPO_INTER = Funciones.CheckStr(arrTipisParametroGeneral(1))
                                    oInterac.USUARIO_PROCESO = Funciones.CheckStr(arrTipisParametroGeneral(2))
                                    oInterac.FLAG_CASO = Funciones.CheckStr(arrTipisParametroGeneral(3))
                                    oInterac.RESULTADO = Funciones.CheckStr(arrTipisParametroGeneral(4))
                                    oInterac.HECHO_EN_UNO = Funciones.CheckStr(arrTipisParametroGeneral(5))
                                Next
                            End If

                            If Not oInterac Is Nothing Then
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Inicio Proceso Crear Tipificacion--")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Key_GrupoTipificacionEnvioCorreo: " & objgrupotipi)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Key_GrupoTipificacionEnvioCorreoGen : " & objgrupotipigeneral)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ObjID Contacto : " & oInterac.OBJID_CONTACTO)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Telefono : " & oInterac.TELEFONO)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Notas : " & oInterac.NOTAS)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Agente : " & oInterac.AGENTE)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo Codigo : " & oInterac.TIPO_CODIGO)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo : " & oInterac.TIPO)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Clase Codigo : " & oInterac.CLASE_CODIGO)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Clase : " & oInterac.CLASE)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "SubClase Codigo : " & oInterac.SUBCLASE_CODIGO)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "SubClase : " & oInterac.SUBCLASE)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Metodo : " & oInterac.METODO)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo Inter : " & oInterac.TIPO_INTER)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Usuario Proceso : " & oInterac.USUARIO_PROCESO)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Flag Caso : " & oInterac.FLAG_CASO)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Resultado : " & oInterac.RESULTADO)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Hecho en Uno : " & oInterac.HECHO_EN_UNO)
                                objClsTipifica.CrearInteraccion(oInterac, strInteracionID, strFlagInsercion, strMsjRptaTipifica)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Flag Insercion : " & strFlagInsercion)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensajes Respuesta : " & strMsjRptaTipifica)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Fin Proceso Crear Tipificacion--")
                            End If
                        End If
                    End If
                    End If
        'PROY-32851 :: INI
            End If
        End If
        'PROY-32851 :: FIN
    End Function

    Private Function RegistrarTrazabilidad(ByVal objRequestJson As BERegistrarTrazabilidadRequest, ByVal CodTipoOperacion As String, ByVal strIdenLog As String, ByRef strCodRespuesta As String, ByRef strMsjRespuesta As String)

        Dim usuario_id As String = CurrentUser
        Dim ipcliente As String = CurrentTerminal
        Dim constCero As String = "0"
        Dim consCodigoEstado As String = "1"
        Dim constOK As String = "OK"

        Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "--Inicio Proceso Auditoria Trazabilidad--")
            Dim objAuditoria As New BERegistrarTrazabilidadAuditoria
            Dim clsCosnultaPvu As New clsConsultaPvu
            objAuditoria.idTransaccion = DateTime.Now.ToString("yyyyMMddHHmmssfff")
            objAuditoria.ipAplicacion = ipcliente
            'objAuditoria.nombreAplicacion = AppSettings.Key_BioSistema
            objAuditoria.nombreAplicacion = "SISACT"
            objAuditoria.usuarioAplicacion = usuario_id
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Id transaccion : " & Funciones.CheckStr(objAuditoria.idTransaccion.ToString()))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Ip Aplicacion : " & Funciones.CheckStr(objAuditoria.ipAplicacion.ToString()))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Nombre Aplicacion : " & Funciones.CheckStr(objAuditoria.nombreAplicacion.ToString()))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Usuario Aplicacion : " & Funciones.CheckStr(objAuditoria.usuarioAplicacion.ToString()))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "--Fin Proceso Auditoria Trazabilidad--")

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "--Inicio Proceso Request Trazabilidad--")
            Dim objRequest As New BERegistrarTrazabilidadRequest
            objRequest.auditRequest = objAuditoria
            objRequest.codCanal = objRequestJson.codCanal
            objRequest.codigoError = objRequestJson.codigoError
            objRequest.codModalVenta = AppSettings.Key_BioModalidadVenta
            If CodTipoOperacion.Equals("01") Then
                objRequest.codOperacion = AppSettings.Key_BioOperacionAlta
            ElseIf CodTipoOperacion.Equals("02") Then
                objRequest.codOperacion = AppSettings.Key_BioOperacionMigracion
            ElseIf CodTipoOperacion.Equals("03") Then
                objRequest.codOperacion = AppSettings.Key_BioOperacionPorta
            End If
            objRequest.codPdv = objRequestJson.codPdv
            objRequest.dniAutorizado = String.Empty
            objRequest.dniConsultado = String.Empty
            objRequest.estado = consCodigoEstado
            objRequest.flag = constCero
            objRequest.idHijo = clsCosnultaPvu.GenerarIdTrazabilidad(2)
            objRequest.idPadre = Funciones.CheckStr(objRequestJson.idPadre)
            objRequest.lineas = AppSettings.Key_BioLinea
            objRequest.mensajeProceso = objRequestJson.mensajeProceso
            objRequest.numeroDocumento = objRequestJson.numeroDocumento
            objRequest.origenTipo = AppSettings.Key_BioOrigenFirmaDigital
            objRequest.padreAnt = String.Empty
            objRequest.sistema = AppSettings.Key_BioSistema
            objRequest.tipoDocumento = objRequestJson.tipoDocumento
            objRequest.tipoValidacion = AppSettings.Key_BioTipoValFirmaDigital
            objRequest.usuarioCtaRed = Funciones.CheckStr(usuario_id)
            objRequest.veprnId = constCero
            objRequest.wsOrigen = AppSettings.Key_BioOrigenFirmaDigital

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Codigo Canal : " & Funciones.CheckStr(objRequest.codCanal.ToString()))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Codigo Error : " & Funciones.CheckStr(objRequest.codigoError.ToString()))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Codigo Modal Venta : " & Funciones.CheckStr(objRequest.codModalVenta.ToString()))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Codigo Operacion : " & Funciones.CheckStr(objRequest.codOperacion.ToString()))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Codigo PDV : " & Funciones.CheckStr(objRequest.codPdv.ToString()))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "DNI Autorizado : " & Funciones.CheckStr(objRequest.dniAutorizado.ToString()))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "DNI Consultado : " & Funciones.CheckStr(objRequest.dniConsultado.ToString()))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Estado : " & Funciones.CheckStr(objRequest.estado.ToString()))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Flag : " & Funciones.CheckStr(objRequest.flag.ToString()))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Id Hijo : " & Funciones.CheckStr(objRequest.idHijo.ToString()))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Id padre : " & Funciones.CheckStr(objRequest.idPadre.ToString()))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Lineas : " & Funciones.CheckStr(objRequest.lineas.ToString()))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Mensaje Proceso : " & Funciones.CheckStr(objRequest.mensajeProceso.ToString()))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Numero Documento : " & Funciones.CheckStr(objRequest.numeroDocumento.ToString()))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Origen Tipo : " & Funciones.CheckStr(objRequest.origenTipo.ToString()))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Padre Ant : " & Funciones.CheckStr(objRequest.padreAnt.ToString()))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Sistema : " & Funciones.CheckStr(objRequest.sistema.ToString()))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Tipo Documento : " & Funciones.CheckStr(objRequest.tipoDocumento.ToString()))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Tipo Validacion : " & Funciones.CheckStr(objRequest.tipoValidacion.ToString()))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Usuario Cuenta Red : " & Funciones.CheckStr(objRequest.usuarioCtaRed.ToString()))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "VeprnId : " & Funciones.CheckStr(objRequest.veprnId.ToString()))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "wsOrigen : " & Funciones.CheckStr(objRequest.wsOrigen.ToString()))

            'objRequest.codCanal = "01"
            'objRequest.codigoError = "00000"
            'objRequest.codModalVenta = "01"
            'objRequest.codOperacion = "SISACT0001"
            'objRequest.codPdv = "0006"
            'objRequest.dniAutorizado = "47145195"
            'objRequest.dniConsultado = "46081072"
            'objRequest.estado = consCodigoEstado
            'objRequest.flag = constCero
            'objRequest.idHijo = "0000000000075284"
            'objRequest.idPadre = "T000000001076083"
            'objRequest.lineas = "SIN LINEA"
            'objRequest.mensajeProceso = "Evento: Liberar dispositivo. No ocurrieron errores."
            'objRequest.numeroDocumento = "46081072"
            'objRequest.origenTipo = "HUELLERO"
            'objRequest.padreAnt = String.Empty
            'objRequest.sistema = "SICAR"
            'objRequest.tipoDocumento = "01"
            'objRequest.tipoValidacion = "HUELLERO"
            'objRequest.usuarioCtaRed = "E700063"
            'objRequest.veprnId = constCero
            'objRequest.wsOrigen = "Biometria Novatronic"

            Dim objRegistrarTrazabilidad As New BWRegistrarTrazabilidad
            Dim objResponse As BERegistrarTrazabilidadResponse = objRegistrarTrazabilidad.registrarTrazabilidad(objRequest)

            strMsjRespuesta = Funciones.CheckStr(objResponse.msjRespuesta)
            strCodRespuesta = Funciones.CheckStr(objResponse.codRespuesta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "--Fin Proceso Request Trazabilidad--")
        Catch ex As Exception
            strMsjRespuesta = Funciones.CheckStr(ex.Message)
            strCodRespuesta = "-1"
        End Try

    End Function

    Private Function ConsultaParametros(ByVal strIdenLog As String)
        Dim objpvuDB As New COM_SIC_Activaciones.clsConsultaPvu
        Dim arrParametros As ArrayList
        Dim oParamteros As New COM_SIC_Activaciones.BEParametros
        Dim strCodGrupo As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("Key_ContratacionElectronica"))
        Dim objAppSetting As New AppSettings

        'Dim strNotaCanje As String
        Dim strValor As String
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "--Inicio Proceso Consulta Parametros--")
        If strCodGrupo <> "" Then
            arrParametros = objpvuDB.ConsultaParametros(strCodGrupo)

            For Each item As BEParametros In arrParametros
                strValor = item.strValor1
                Select Case strValor
                    Case "Key_AsuntoCorreo"
                        objAppSetting.Key_AsuntoCorreo = Funciones.CheckStr(item.strValor)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Key_AsuntoCorreo : " & Funciones.CheckStr(item.strValor))
                    Case "Key_MensajeAltaPost"
                        objAppSetting.Key_MensajeAltaPost = Funciones.CheckStr(item.strValor)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Key_MensajeAltaPost : " & Funciones.CheckStr(item.strValor))
                    Case "Key_BioModalidadVenta"
                        objAppSetting.Key_BioModalidadVenta = Funciones.CheckStr(item.strValor)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Key_BioModalidadVenta : " & Funciones.CheckStr(item.strValor))
                    Case "Key_BioOperacionAlta"
                        objAppSetting.Key_BioOperacionAlta = Funciones.CheckStr(item.strValor)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Key_BioOperacionAlta : " & Funciones.CheckStr(item.strValor))
                    Case "Key_BioOperacionMigracion"
                        objAppSetting.Key_BioOperacionMigracion = Funciones.CheckStr(item.strValor)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Key_BioOperacionMigracion : " & Funciones.CheckStr(item.strValor))
                    Case "Key_BioOperacionPorta"
                        objAppSetting.Key_BioOperacionPorta = Funciones.CheckStr(item.strValor)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Key_BioOperacionPorta : " & Funciones.CheckStr(item.strValor))
                    Case "Key_BioLinea"
                        objAppSetting.Key_BioLinea = Funciones.CheckStr(item.strValor)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Key_BioLinea : " & Funciones.CheckStr(item.strValor))
                    Case "Key_BioOrigenFirmaDigital"
                        objAppSetting.Key_BioOrigenFirmaDigital = Funciones.CheckStr(item.strValor)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Key_BioOrigenFirmaDigital : " & Funciones.CheckStr(item.strValor))
                    Case "Key_BioSistema"
                        objAppSetting.Key_BioSistema = Funciones.CheckStr(item.strValor)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Key_BioSistema : " & Funciones.CheckStr(item.strValor))
                    Case "Key_BioTipoValFirmaDigital"
                        objAppSetting.Key_BioTipoValFirmaDigital = Funciones.CheckStr(item.strValor)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Key_BioTipoValFirmaDigital : " & Funciones.CheckStr(item.strValor))
                    Case "Key_BioWsOrigenFirmaDigital"
                        objAppSetting.Key_BioWsOrigenFirmaDigital = Funciones.CheckStr(item.strValor)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Key_BioWsOrigenFirmaDigital : " & Funciones.CheckStr(item.strValor))
                    Case "Key_FlagHTML"
                        objAppSetting.Key_FlagHTML = Funciones.CheckStr(item.strValor)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Key_FlagHTML : " & Funciones.CheckStr(item.strValor))
                    Case "Key_GrupoTipificacionEnvioCorreo"
                        objAppSetting.Key_GrupoTipificacionEnvioCorreo = Funciones.CheckStr(item.strValor)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Key_GrupoTipificacionEnvioCorreo : " & Funciones.CheckStr(item.strValor))
                    Case "Key_GrupoTipificacionEnvioCorreoGen"
                        objAppSetting.Key_GrupoTipificacionEnvioCorreoGen = Funciones.CheckStr(item.strValor)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "Key_GrupoTipificacionEnvioCorreoGen : " & Funciones.CheckStr(item.strValor))
                End Select
            Next
        End If
        Return arrParametros
    End Function

    Private Function Obtener_NroSec_PostPagoR2(ByVal strNroPedido As String) As String
        Dim objConsultaPvu As New COM_SIC_Activaciones.clsConsultaPvu
        Dim strNroSec As String = ""

        strNroSec = objConsultaPvu.ObtenerSec(strNroPedido)


        objConsultaPvu = Nothing
        Return strNroSec

    End Function

    Private Function ObtenerCuerpoCorreo(ByVal strTipoDocumento As String, ByVal strNombreCompleto As String, ByVal strRutaBanner As String, ByVal strLog As String) As String

        Dim log As New SrvPago_Log
        Try
            Dim strArchivoXml, strRuta As String
            Dim strNombreCliente As String
            Dim _strRutaBanner As String
            Dim arrRutaBanner() As String = strRutaBanner.Split("|")
            Dim strRutaArchivo As String = "~\Plantillas\"

            If (strTipoDocumento.Equals("06") Or strTipoDocumento.Equals("10") Or strTipoDocumento.Equals("20")) Then
                strArchivoXml = "Claromovil--JURIDICO.xml"
                strNombreCliente = strNombreCompleto
                _strRutaBanner = arrRutaBanner(0)
                strRutaArchivo += strArchivoXml
                log.Log_WriteLog(pathFile, strArchivo, strLog & "- " & "Tipo Documento : " & strTipoDocumento)
                log.Log_WriteLog(pathFile, strArchivo, strLog & "- " & "Nombre Archivo : " & strArchivoXml)
                log.Log_WriteLog(pathFile, strArchivo, strLog & "- " & "Nombre Cliente : " & strNombreCliente)
                log.Log_WriteLog(pathFile, strArchivo, strLog & "- " & "Ruta Banner : " & _strRutaBanner)
                log.Log_WriteLog(pathFile, strArchivo, strLog & "- " & "Ruta Archivo : " & strRutaArchivo)
            Else
                strArchivoXml = "Claromovil--NATURAL.xml"
                strNombreCliente = strNombreCompleto
                _strRutaBanner = arrRutaBanner(1)
                strRutaArchivo += strArchivoXml
                log.Log_WriteLog(pathFile, strArchivo, strLog & "- " & "Tipo Documento : " & strTipoDocumento)
                log.Log_WriteLog(pathFile, strArchivo, strLog & "- " & "Nombre Archivo : " & strArchivoXml)
                log.Log_WriteLog(pathFile, strArchivo, strLog & "- " & "Nombre Cliente : " & strNombreCliente)
                log.Log_WriteLog(pathFile, strArchivo, strLog & "- " & "Ruta Banner : " & _strRutaBanner)
                log.Log_WriteLog(pathFile, strArchivo, strLog & "- " & "Ruta Archivo : " & strRutaArchivo)
            End If

            strRuta = HttpContext.Current.Server.MapPath(strRutaArchivo) 'Server.MapPath(strRutaArchivo)

            If File.Exists(strRuta) = False Then
                log.Log_WriteLog(pathFile, strArchivo, strLog & "- " & "Error : " & String.Format("El archivo XML que contiene la plantilla de correo {0} no existe", strArchivo))
            End If

            Dim salida As New ArrayList
            Dim doc As XmlDocument = New XmlDocument
            doc.Load(strRuta)
            Dim nodeList As XmlNodeList = doc.SelectNodes("descendant::htmlData")
            Dim strCuerpoCorreo As String
            strCuerpoCorreo = String.Empty
            Dim i As Integer
            For i = 0 To nodeList.Count - 1
                strCuerpoCorreo = nodeList.Item(i).ChildNodes(0).InnerText
            Next
            strCuerpoCorreo = strCuerpoCorreo.Replace("%%DATOS_CLIENTE%%", strNombreCliente)
            strCuerpoCorreo = strCuerpoCorreo.Replace("%%FECHA%%", Date.Now.ToString("dd/MM/yyyy"))
            strCuerpoCorreo = strCuerpoCorreo.Replace("%%RUTA_BANNER%%", _strRutaBanner)
            Return strCuerpoCorreo
            log.Log_WriteLog(pathFile, strArchivo, strLog & "- " & "Cuerpo Correo : " & strCuerpoCorreo)

        Catch ex As Exception
            Return String.Format("Error: {0}", ex.Message)
            'INI PROY-140126
            Dim MaptPath As String
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: ObtenerCuerpoCorreo)"
            log.Log_WriteLog(pathFile, strArchivo, strLog & "- " & "Error : " & ex.Message & MaptPath)
            'FIN PROY-140126           
            'Throw ex
        End Try
    End Function

    '====== FIN PROY-25335-Contratacion Electronica Release 2 *********


    '******************Inicio - Funcion Paperless******************

    Private Function Paperless(ByVal K_CU_CORRELATIVOFE As String, _
                                    ByVal K_NRO_PEDIDO As Int64, ByVal K_PAGON_IDPAGO As Int64, ByVal origen As String) As String

        Dim objFE As New COM_SIC_FacturaElectronica.PaperLess
        Dim objCajas As New COM_SIC_Cajas.clsCajas

        Dim mensajePpl As String = ""
        Dim estado As String = ""
        Dim referenciaBF As String = ""
        Dim SociedadSap As String = ""
        Dim strCorrSunat As String = ""
        Dim strIdentifyLog As String = ""

        referenciaBF = Obtener_serie_correlativo(K_CU_CORRELATIVOFE, "5", "")
        strCorrSunat = Obtener_serie_correlativo(K_CU_CORRELATIVOFE, "2", "")

        strIdentifyLog = Funciones.CheckStr(K_NRO_PEDIDO)
        'PROY 32815 - RMZ
        SociedadSap = ConfigurationSettings.AppSettings("Cod_SociedadPE").ToString() '"PE01" 'drPagos.Item("SOCIEDAD")      '**HARDCODE**'
        'PROY 32815 - RMZ
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio de envio al metodo (GenerarFacturaElectronicaMSSAP)")
        mensajePpl = _
        objFE.GenerarFacturaElectronicaMSSAP( _
            strIdentifyLog, _
K_PAGON_IDPAGO, _
            AppAlmacen, _
            referenciaBF, _
            SociedadSap)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin de envio al metodo (GenerarFacturaElectronicaMSSAP)")

        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio de envio al metodo (RegistrarAuditoria)")
        RegistrarAuditoria("Envio factura electrónica NumSunat = " & strCorrSunat, CheckStr(ConfigurationSettings.AppSettings("codTrsPaperless")))
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin de envio al metodo (RegistrarAuditoria)")

        estado = mensajePpl

        If estado = "F" Then
            estado = "E"
        End If

        If estado <> ConfigurationSettings.AppSettings("FE_HC_Pendiente") Then
            AppPaperless = "0"
        Else
            AppPaperless = "1"
        End If


        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Actualización del Estado de la Boleta o Factura (SP_UPD_ESTADO_DOCUM)")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Numero de DocSap   :" & strIdentifyLog)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Origen             :" & origen)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Estado             :" & estado)

        Dim updateEstado As String = objCajas.Actualizar_Estado_Pago(strIdentifyLog, origen, estado)

        If updateEstado = "" Then
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   Out updateEstado  :" & updateEstado)

        Else
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   Out updateEstado  :" & updateEstado)
        End If
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin de la ctualización del Estado de la Boleta o Factura.")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "*****************************************************************")

    End Function

    Private Function Obtener_serie_correlativo(ByVal K_CU_CORRELATIVOFE As String, ByVal tipo As String, ByVal NC As String) As String

        Try

            Dim arrayCorr As String()
            Dim referenciaBF As String = ""
            Dim referenciaBF2 As String = ""
            Dim SociedadSap As String = ""
            Dim SerieSunat As String = ""
            Dim strCorrSunat As String = ""
            Dim cadena As String = ""
            Dim tipoDoc_Sap As String = ""
            Dim Nro_Referencia_Sunat As String = ""
            Dim SerieSunatPP As String = ""
            'Dim SerieSunatFlujoCaja As String = ""
            Dim Nro_Referencia_Sunat_FlujoCaja As String = ""

            arrayCorr = CheckStr(K_CU_CORRELATIVOFE).Split("-")

            If arrayCorr(0).StartsWith("B") Then
                tipoDoc_Sap = "E3"
            ElseIf arrayCorr(0).StartsWith("F") Then
                tipoDoc_Sap = "E1"
            End If

            If NC = CheckStr(ConfigurationSettings.AppSettings("strTipDoc")) Then
                tipoDoc_Sap = "E7"
            End If


            SerieSunat = (arrayCorr(0).ToString).Substring(1, (arrayCorr(0).ToString).Length - 1) 'serie
            SerieSunatPP = arrayCorr(0).ToString
            strCorrSunat = (CInt(arrayCorr(1).ToString)).ToString
            referenciaBF = Funciones.CheckStr(SerieSunat).ToString.Trim & "-" & Funciones.CheckStr(strCorrSunat).ToString.Trim
            referenciaBF2 = Funciones.CheckStr(SerieSunatPP).ToString.Trim & "-" & Funciones.CheckStr(strCorrSunat).ToString.Trim

            Nro_Referencia_Sunat = tipoDoc_Sap & "-" & Format(Funciones.CheckInt(SerieSunat), "00000") & "-" & Format(Funciones.CheckInt(strCorrSunat), "0000000")

            Nro_Referencia_Sunat_FlujoCaja = tipoDoc_Sap & "-" & SerieSunatPP & "-" & Format(Funciones.CheckInt(strCorrSunat), "00000000")

            Select Case tipo
                Case 1
                    cadena = SerieSunat
                Case 2
                    cadena = strCorrSunat
                Case 3
                    cadena = referenciaBF
                Case 4
                    cadena = Nro_Referencia_Sunat
                Case 5
                    cadena = referenciaBF2
                Case 6
                    cadena = Nro_Referencia_Sunat_FlujoCaja
            End Select

            Return cadena
        Catch ex As Exception
            Return ""
        End Try

    End Function

    '************************Registro de Auditoria de Paperless
    Private Sub RegistrarAuditoria(ByVal DesTrx As String, ByVal CodTrx As String)
        Try
            Dim user As String = CurrentUser
            Dim ipHost As String = CurrentTerminal
            Dim nameHost As String = System.Net.Dns.GetHostName
            Dim nameServer As String = System.Net.Dns.GetHostName
            Dim ipServer As String = System.Net.Dns.GetHostByName(nameServer).AddressList(0).ToString
            Dim hostInfo As System.Net.IPHostEntry = System.Net.Dns.GetHostByName(nameHost)

            Dim CadMensaje As String
            Dim CodServicio As String = ConfigurationSettings.AppSettings("CONS_COD_SICAR_SERV")
            Dim oAuditoria As New COM_SIC_Activaciones.clsAuditoriaWS

            oAuditoria.RegistrarAuditoria(CodTrx, _
                                            CodServicio, _
                                            ipHost, _
                                            nameHost, _
                                            ipServer, _
                                            nameServer, _
                                            user, _
                                            "", _
                                            "0", _
                                            DesTrx)

        Catch ex As Exception
            ' Throw New Exception("Error Registrar Auditoria.")
        End Try
    End Sub

    Private Function ConsultaPlanSEC(ByVal strNroSec As String, ByRef strPlanBSCS As String) As String
        Dim objCajas As COM_SIC_Cajas.clsCajas
        Dim planSisact As String
        Dim strIdentifyLog As String = Funciones.CheckStr(strNroSec)
        Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio ConsultaPlanSEC")
            objCajas = New COM_SIC_Cajas.clsCajas
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "strNroSec: " & strNroSec)
            planSisact = objCajas.ConsultaPlanSEC(strNroSec, strPlanBSCS)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "planSisact: " & planSisact)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "strPlanBSCS: " & strPlanBSCS)

        Catch ex As Exception
            Throw ex
        Finally
            objCajas = Nothing
        End Try
        Return planSisact
    End Function

    Private Function ServicioCambioPlanPostPago(ByVal CodigoInteraccionGenerado As String, ByVal documentoSAP As String, ByVal NroSEC As String, ByVal NroLinea As String) As Boolean
        Dim strIdentifyLog As String = documentoSAP
        Dim oCambioPlanPostpago As New CambioPlanPostpago
        Dim oCambioPlanPostpagoNegocios As New CambioPlanPostpagoNg

        Dim Respuesta As Boolean
        Dim idTransaccion_aux, ClicloFacturacion, mensajeRespuesta As String

        Dim fecha As DateTime
        fecha = Date.Now
        Dim Oficina As String = CStr(AppAlmacen)
        Dim Nro_Sap As String = documentoSAP
        Dim CodigoPlan, CodigoPlanBSCS As String
        Dim strMensaje As String

        Dim topeCero As String = ConfigurationSettings.AppSettings("consTopeCero")
        Dim topeAuto As String = ConfigurationSettings.AppSettings("consTopeAuto")
        Dim sinTope As String = ConfigurationSettings.AppSettings("consSinTope")
        Dim objVentaRenovacion As COM_SIC_Cajas.VentaRenovaPost

        Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Cambio ServicioCambioPlanPostPago: ")
            objVentaRenovacion = (New COM_SIC_Cajas.clsCajas).ConsultarVentaRenovPostCAC(documentoSAP)

            'INI: INICIATIVA-219
            Dim objWSCbio As New BWServicesCBIO
            Dim objBLCbio As New BLDatosCBIO
            Dim objBLCbioApp As New BLDatosCBIO_App
            Dim objClienteCBIO As New clsClienteBSCS
            Dim strOrigenLinea As String = String.Empty
            Dim strFechaProgramacion As String = String.Empty
            Dim strUsuario As String = AppstrUsuario
            strOrigenLinea = objWSCbio.ConsultarLineaCuentaWSCBIO(NroLinea)
            'FIN: INICIATIVA-219

            If strOrigenLinea = "1" Then 'FLUJO BSCS9(CBIO)
				objClienteCBIO = objBLCbioApp.LeerDatosCliente(NroLinea, "", strUsuario)
                strFechaProgramacion = CalcularFechaTopeProgramacion(Funciones.CheckStr(objClienteCBIO.ciclo_fac), strIdentifyLog)
                Respuesta = objBLCbioApp.CambioPlanCBIO(CodigoInteraccionGenerado, NroLinea, strFechaProgramacion, objVentaRenovacion.NUMERO_CONTRATO, NroSEC, strUsuario)
            Else 'FLUJO BSCS
            'gaa20150225
            'CodigoPlan = ConsultaPedidoSAP(Oficina, Nro_Sap)
            CodigoPlan = ConsultaPlanSEC(NroSEC, CodigoPlanBSCS)
            'fin gaa20150225

            Dim datosPlan() As String
            datosPlan = ConsultaSolicitudPospago(NroSEC).Split(",")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "antes de  ConsultaSolicitudPospago")

            Dim datos As String()
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "antes de  ServicioSIACPostpagoConsultas")
            datos = ServicioSIACPostpagoConsultas("", NroLinea).Split("|")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "antes de  ServicioSIACPostpagoConsultas")

            'INC000000736080 - INICIO
            Dim fechaMig As String
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INICIO CalcularFechaTopeProgramacion")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "IN - " & datos(4))
            fechaMig = CalcularFechaTopeProgramacion(datos(4), strIdentifyLog)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "OUT - " & fechaMig)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FIN CalcularFechaTopeProgramacion")
            'INC000000736080 - FIN

            oCambioPlanPostpago.idTransaccion = datos(1) & fecha.Year.ToString() & Right("00" & fecha.Month.ToString(), 2) & Right("00" & fecha.Day.ToString(), 2) & Right("00" & fecha.Hour.ToString(), 2) & Right("00" & fecha.Minute.ToString(), 2) & Right("00" & fecha.Second.ToString(), 2)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - idTransaccion - " & Funciones.CheckStr(oCambioPlanPostpago.idTransaccion))
            oCambioPlanPostpago.ipAplicacion = CurrentTerminal
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - CurrentTerminal - " & Funciones.CheckStr(oCambioPlanPostpago.ipAplicacion))
            oCambioPlanPostpago.aplicacion = ConfigurationSettings.AppSettings("usrSisactPrograma") ' cambiado del 22/08/2013 ahora se envia el nombre ConfigurationSettings.AppSettings("CodigoAplicacion")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - aplicacion - " & Funciones.CheckStr(oCambioPlanPostpago.aplicacion))
            oCambioPlanPostpago.msisdn = Right("000000000" & NroLinea.ToString(), 9)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - msisdn - " & Funciones.CheckStr(oCambioPlanPostpago.msisdn))
            oCambioPlanPostpago.coId = datos(1)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - coId - " & Funciones.CheckStr(oCambioPlanPostpago.coId))
            oCambioPlanPostpago.customerId = datos(0)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - customerId - " & Funciones.CheckStr(oCambioPlanPostpago.customerId))
            oCambioPlanPostpago.Cuenta = datos(2)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - Cuenta - " & Funciones.CheckStr(oCambioPlanPostpago.Cuenta))
            oCambioPlanPostpago.escenario = ConfigurationSettings.AppSettings("CONS_RENOV_POS_ESCENARIO") '"POST_POST" 'poner en webconfig
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - escenario - " & Funciones.CheckStr(oCambioPlanPostpago.escenario))
            oCambioPlanPostpago.tipoProducto = ConfigurationSettings.AppSettings("consPostpagoValorUno") '1 = Plan Base 
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - tipoProducto - " & Funciones.CheckStr(oCambioPlanPostpago.tipoProducto))
            oCambioPlanPostpago.serviciosAdicionales = Obtener_CO_SER(NroSEC)  'INC000000824753 - 25/07/2017  
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - serviciosAdicionales - " & Funciones.CheckStr(oCambioPlanPostpago.serviciosAdicionales))
            oCambioPlanPostpago.codigoProducto = CodigoPlan ' Codigo Producto
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - CodigoPlan - " & Funciones.CheckStr(oCambioPlanPostpago.codigoProducto))
            oCambioPlanPostpago.codigoPlanBase = CodigoPlanBSCS 'ObtenerCodigoPlanBase(CodigoPlan) 'CAMBIO PLAN COMERCIAL (SISACT)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - codigoPlanBase - " & Funciones.CheckStr(oCambioPlanPostpago.codigoPlanBase))
            oCambioPlanPostpago.montoApadece = ConfigurationSettings.AppSettings("consPostpagoValorCero")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - montoApadece - " & Funciones.CheckStr(oCambioPlanPostpago.montoApadece))
            oCambioPlanPostpago.montoFidelizar = ConfigurationSettings.AppSettings("consPostpagoValorCero")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - montoFidelizar - " & Funciones.CheckStr(oCambioPlanPostpago.montoFidelizar))
            oCambioPlanPostpago.flagValidaApadece = ConfigurationSettings.AppSettings("consPostpagoValorCero") '0 = No Valida en SIGA
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - flagValidaApadece - " & Funciones.CheckStr(oCambioPlanPostpago.flagValidaApadece))
            oCambioPlanPostpago.flagAplicaApadece = ConfigurationSettings.AppSettings("consPostpagoValorCero") '0 =No Aplica Apadece
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - flagAplicaApadece - " & Funciones.CheckStr(oCambioPlanPostpago.flagAplicaApadece))
            oCambioPlanPostpago.TopeConsumo = ConfigurationSettings.AppSettings("consPostpagoValorCero")     '1= Sin tope            datosPlan(0) ' 13/08/2913    
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - TopeConsumo - " & Funciones.CheckStr(oCambioPlanPostpago.TopeConsumo))
            'oCambioPlanPostpago.tipoTope = ConfigurationSettings.AppSettings("consPostpagoValorVacio")     'vacio               datosPlan(2) ' 13/08/2913    
            If topeCero.IndexOf(objVentaRenovacion.TOPE_CONSUMO) > -1 And Not (objVentaRenovacion.TOPE_CONSUMO).Equals("") Then
                oCambioPlanPostpago.tipoTope = ConfigurationSettings.AppSettings("conscodTopeCero")
                oCambioPlanPostpago.descripcionTipoTpe = ConfigurationSettings.AppSettings("consdesTopeCero")
                oCambioPlanPostpago.tipoRegistroTope = ConfigurationSettings.AppSettings("consRetistroTope")
            End If
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - tipoTope - " & Funciones.CheckStr(oCambioPlanPostpago.tipoTope))
            'oCambioPlanPostpago.descripcionTipoTpe = ConfigurationSettings.AppSettings("consPostpagoValorVacio") ''vacio
            If topeAuto.IndexOf(objVentaRenovacion.TOPE_CONSUMO) > -1 And Not (objVentaRenovacion.TOPE_CONSUMO).Equals("") Then
                oCambioPlanPostpago.tipoTope = ConfigurationSettings.AppSettings("conscodTopeAuto")
                oCambioPlanPostpago.descripcionTipoTpe = ConfigurationSettings.AppSettings("consdesTopeAuto")
                oCambioPlanPostpago.tipoRegistroTope = ConfigurationSettings.AppSettings("consRetistroTope")
            End If
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - descripcionTipoTpe - " & Funciones.CheckStr(oCambioPlanPostpago.descripcionTipoTpe))
            If sinTope.IndexOf(objVentaRenovacion.TOPE_CONSUMO) > -1 And Not (objVentaRenovacion.TOPE_CONSUMO).Equals("") Then
                oCambioPlanPostpago.tipoTope = ConfigurationSettings.AppSettings("consPostpagoValorVacio")
                oCambioPlanPostpago.descripcionTipoTpe = ConfigurationSettings.AppSettings("consPostpagoValorVacio")
                oCambioPlanPostpago.tipoRegistroTope = ConfigurationSettings.AppSettings("consPostpagoValorVacio")
            End If
            'oCambioPlanPostpago.tipoRegistroTope = ConfigurationSettings.AppSettings("consPostpagoValorVacio") 'vacio
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - tipoRegistroTope - " & Funciones.CheckStr(oCambioPlanPostpago.tipoRegistroTope))
            oCambioPlanPostpago.topeControlConsumo = ConfigurationSettings.AppSettings("consPostpagoValorCero") 'ahora es cero,  vacio
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - topeControlConsumo - " & Funciones.CheckStr(oCambioPlanPostpago.topeControlConsumo))

            oCambioPlanPostpago.fechaProgramacionTope = fechaMig 'fchTope 01/09/2016 cambiado para el proy15956 
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - fechaProgramacionTope - " & Funciones.CheckStr(oCambioPlanPostpago.fechaProgramacionTope))
            oCambioPlanPostpago.CAC = CStr(AppAlmacen)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - CAC - " & Funciones.CheckStr(oCambioPlanPostpago.CAC))
            oCambioPlanPostpago.asesor = CurrentUser
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - asesor - " & Funciones.CheckStr(oCambioPlanPostpago.asesor))
            oCambioPlanPostpago.codigoInteraccion = CodigoInteraccionGenerado '18/07/2013
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - codigoInteraccion - " & Funciones.CheckStr(oCambioPlanPostpago.codigoInteraccion))
            oCambioPlanPostpago.montoPCS = ConfigurationSettings.AppSettings("consPostpagoValorCero") '          datosPlan(1) ' 13/08/2913    "0"
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - montoPCS - " & Funciones.CheckStr(oCambioPlanPostpago.montoPCS))
            oCambioPlanPostpago.areaPCS = ConfigurationSettings.AppSettings("consPostpagoValorVacio")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - areaPCS - " & Funciones.CheckStr(oCambioPlanPostpago.areaPCS))
            oCambioPlanPostpago.motivoPCS = ConfigurationSettings.AppSettings("consPostpagoValorVacio")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - motivoPCS - " & Funciones.CheckStr(oCambioPlanPostpago.motivoPCS))
            oCambioPlanPostpago.subMotivoPCS = ConfigurationSettings.AppSettings("consPostpagoValorVacio")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - subMotivoPCS - " & Funciones.CheckStr(oCambioPlanPostpago.subMotivoPCS))
            oCambioPlanPostpago.cicloFacturacion = datos(4) ' agregado el 22/08/2013 "0"
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - cicloFacturacion - " & Funciones.CheckStr(oCambioPlanPostpago.cicloFacturacion))
            oCambioPlanPostpago.idTipoCliente = ConfigurationSettings.AppSettings("consPostpagoValorDos") ' Consumer
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - idTipoCliente - " & Funciones.CheckStr(oCambioPlanPostpago.idTipoCliente))
            oCambioPlanPostpago.numeroDocumento = datos(3) ' Numero de documento
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - numeroDocumento - " & Funciones.CheckStr(oCambioPlanPostpago.numeroDocumento))
            ConsultaSolicitudPospago(NroSEC)
            oCambioPlanPostpago.flagServicioOnTop = ConfigurationSettings.AppSettings("consPostpagoValorUno") '1 = No mantener servicios OnTop
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - flagServicioOnTop - " & Funciones.CheckStr(oCambioPlanPostpago.flagServicioOnTop))
            oCambioPlanPostpago.fechaProgramacion = fechaMig  '-- cambiado el 22/08/2013 segun observacion J.Izquierdo
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - fechaProgramacion - " & Funciones.CheckStr(oCambioPlanPostpago.fechaProgramacion))
            oCambioPlanPostpago.flagLimiteCredito = ConfigurationSettings.AppSettings("consPostpagoValorCero") '0 = No se actualiza limite de crédito
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - flagLimiteCredito - " & Funciones.CheckStr(oCambioPlanPostpago.flagLimiteCredito))
            oCambioPlanPostpago.tipoClarify = UCase(ConfigurationSettings.AppSettings("CONS_RENOV_POS_TIPO")) ' "POSTPAGO" ' poner en webconfig
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - tipoClarify - " & Funciones.CheckStr(oCambioPlanPostpago.tipoClarify))
            oCambioPlanPostpago.numeroCuentaPadre = Left(oCambioPlanPostpago.Cuenta, 9)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - numeroCuentaPadre - " & Funciones.CheckStr(oCambioPlanPostpago.numeroCuentaPadre))
            oCambioPlanPostpago.usuarioAplicacion = ConfigurationSettings.AppSettings("usrSisactPrograma") ' cambiado el 22/08/2013 CurrentUser
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - usuarioAplicacion - " & Funciones.CheckStr(oCambioPlanPostpago.usuarioAplicacion))
            oCambioPlanPostpago.usuarioSistema = ConfigurationSettings.AppSettings("CONS_APLICACION")  ' cambiado el 22/08/2013 ConfigurationSettings.AppSettings("CONS_APLICACION")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - usuarioSistema - " & Funciones.CheckStr(oCambioPlanPostpago.usuarioSistema))
            'objLog.Log_WriteLog(strArchivo, " -" & Nro_Sap & " - " & " despues de parametros ")
            Dim id, mensaje, RespuestaProgramarMigracion As String
            idTransaccion_aux = oCambioPlanPostpago.idTransaccion
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - idTransaccion_aux - " & Funciones.CheckStr(idTransaccion_aux))
            Respuesta = False

            Try
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "llamada al WS de Camnbio PLAN de parametros")

                'Consumo de servicio por 1° vez

                Log_ServicioCambioPlanPostPago("1", "", "1º VEZ", "", oCambioPlanPostpago.idTransaccion, oCambioPlanPostpago.ipAplicacion, oCambioPlanPostpago.aplicacion, oCambioPlanPostpago.msisdn, oCambioPlanPostpago.coId, oCambioPlanPostpago.customerId, oCambioPlanPostpago.Cuenta, oCambioPlanPostpago.escenario, oCambioPlanPostpago.tipoProducto, oCambioPlanPostpago.serviciosAdicionales, oCambioPlanPostpago.codigoProducto, oCambioPlanPostpago.codigoPlanBase, oCambioPlanPostpago.montoApadece, oCambioPlanPostpago.montoFidelizar, oCambioPlanPostpago.flagValidaApadece, oCambioPlanPostpago.flagAplicaApadece, oCambioPlanPostpago.TopeConsumo, oCambioPlanPostpago.tipoTope, oCambioPlanPostpago.descripcionTipoTpe, oCambioPlanPostpago.tipoRegistroTope, oCambioPlanPostpago.topeControlConsumo, oCambioPlanPostpago.fechaProgramacionTope, oCambioPlanPostpago.CAC, oCambioPlanPostpago.asesor, oCambioPlanPostpago.codigoInteraccion, oCambioPlanPostpago.montoPCS, oCambioPlanPostpago.areaPCS, oCambioPlanPostpago.motivoPCS, oCambioPlanPostpago.subMotivoPCS, oCambioPlanPostpago.cicloFacturacion, oCambioPlanPostpago.idTipoCliente, oCambioPlanPostpago.numeroDocumento, oCambioPlanPostpago.flagServicioOnTop, oCambioPlanPostpago.fechaProgramacion, oCambioPlanPostpago.flagLimiteCredito, oCambioPlanPostpago.tipoClarify, oCambioPlanPostpago.numeroCuentaPadre, oCambioPlanPostpago.usuarioAplicacion, oCambioPlanPostpago.usuarioSistema, mensajeRespuesta)

                    Respuesta = oCambioPlanPostpagoNegocios.ServicioCambioPlanPostPago1(oCambioPlanPostpago, id, mensaje)

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje de servicio cambio de plan" & mensaje)
                Log_ServicioCambioPlanPostPago("2", RespuestaProgramarMigracion, "1º VEZ", "", id, oCambioPlanPostpago.ipAplicacion, oCambioPlanPostpago.aplicacion, oCambioPlanPostpago.msisdn, oCambioPlanPostpago.coId, oCambioPlanPostpago.customerId, oCambioPlanPostpago.Cuenta, oCambioPlanPostpago.escenario, oCambioPlanPostpago.tipoProducto, oCambioPlanPostpago.serviciosAdicionales, oCambioPlanPostpago.codigoProducto, oCambioPlanPostpago.codigoPlanBase, oCambioPlanPostpago.montoApadece, oCambioPlanPostpago.montoFidelizar, oCambioPlanPostpago.flagValidaApadece, oCambioPlanPostpago.flagAplicaApadece, oCambioPlanPostpago.TopeConsumo, oCambioPlanPostpago.tipoTope, oCambioPlanPostpago.descripcionTipoTpe, oCambioPlanPostpago.tipoRegistroTope, oCambioPlanPostpago.topeControlConsumo, oCambioPlanPostpago.fechaProgramacionTope, oCambioPlanPostpago.CAC, oCambioPlanPostpago.asesor, oCambioPlanPostpago.codigoInteraccion, oCambioPlanPostpago.montoPCS, oCambioPlanPostpago.areaPCS, oCambioPlanPostpago.motivoPCS, oCambioPlanPostpago.subMotivoPCS, oCambioPlanPostpago.cicloFacturacion, oCambioPlanPostpago.idTipoCliente, oCambioPlanPostpago.numeroDocumento, oCambioPlanPostpago.flagServicioOnTop, oCambioPlanPostpago.fechaProgramacion, oCambioPlanPostpago.flagLimiteCredito, oCambioPlanPostpago.tipoClarify, oCambioPlanPostpago.numeroCuentaPadre, oCambioPlanPostpago.usuarioAplicacion, oCambioPlanPostpago.usuarioSistema, mensaje)

            Catch ex As Exception
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error en camnbio de plan:" & ex.Message)
                Log_ServicioCambioPlanPostPago("3", "", "1º VEZ", ex.ToString(), oCambioPlanPostpago.idTransaccion, oCambioPlanPostpago.ipAplicacion, oCambioPlanPostpago.aplicacion, oCambioPlanPostpago.msisdn, oCambioPlanPostpago.coId, oCambioPlanPostpago.customerId, oCambioPlanPostpago.Cuenta, oCambioPlanPostpago.escenario, oCambioPlanPostpago.tipoProducto, oCambioPlanPostpago.serviciosAdicionales, oCambioPlanPostpago.codigoProducto, oCambioPlanPostpago.codigoPlanBase, oCambioPlanPostpago.montoApadece, oCambioPlanPostpago.montoFidelizar, oCambioPlanPostpago.flagValidaApadece, oCambioPlanPostpago.flagAplicaApadece, oCambioPlanPostpago.TopeConsumo, oCambioPlanPostpago.tipoTope, oCambioPlanPostpago.descripcionTipoTpe, oCambioPlanPostpago.tipoRegistroTope, oCambioPlanPostpago.topeControlConsumo, oCambioPlanPostpago.fechaProgramacionTope, oCambioPlanPostpago.CAC, oCambioPlanPostpago.asesor, oCambioPlanPostpago.codigoInteraccion, oCambioPlanPostpago.montoPCS, oCambioPlanPostpago.areaPCS, oCambioPlanPostpago.motivoPCS, oCambioPlanPostpago.subMotivoPCS, oCambioPlanPostpago.cicloFacturacion, oCambioPlanPostpago.idTipoCliente, oCambioPlanPostpago.numeroDocumento, oCambioPlanPostpago.flagServicioOnTop, oCambioPlanPostpago.fechaProgramacion, oCambioPlanPostpago.flagLimiteCredito, oCambioPlanPostpago.tipoClarify, oCambioPlanPostpago.numeroCuentaPadre, oCambioPlanPostpago.usuarioAplicacion, oCambioPlanPostpago.usuarioSistema, mensajeRespuesta)
                Respuesta = False
            End Try

            If Not Respuesta Then
                Try
                    'Consumo de servicio por 2° vez
                    oCambioPlanPostpago.idTransaccion = idTransaccion_aux
                    Log_ServicioCambioPlanPostPago("1", "", "2º VEZ", "", oCambioPlanPostpago.idTransaccion, oCambioPlanPostpago.ipAplicacion, oCambioPlanPostpago.aplicacion, oCambioPlanPostpago.msisdn, oCambioPlanPostpago.coId, oCambioPlanPostpago.customerId, oCambioPlanPostpago.Cuenta, oCambioPlanPostpago.escenario, oCambioPlanPostpago.tipoProducto, oCambioPlanPostpago.serviciosAdicionales, oCambioPlanPostpago.codigoProducto, oCambioPlanPostpago.codigoPlanBase, oCambioPlanPostpago.montoApadece, oCambioPlanPostpago.montoFidelizar, oCambioPlanPostpago.flagValidaApadece, oCambioPlanPostpago.flagAplicaApadece, oCambioPlanPostpago.TopeConsumo, oCambioPlanPostpago.tipoTope, oCambioPlanPostpago.descripcionTipoTpe, oCambioPlanPostpago.tipoRegistroTope, oCambioPlanPostpago.topeControlConsumo, oCambioPlanPostpago.fechaProgramacionTope, oCambioPlanPostpago.CAC, oCambioPlanPostpago.asesor, oCambioPlanPostpago.codigoInteraccion, oCambioPlanPostpago.montoPCS, oCambioPlanPostpago.areaPCS, oCambioPlanPostpago.motivoPCS, oCambioPlanPostpago.subMotivoPCS, oCambioPlanPostpago.cicloFacturacion, oCambioPlanPostpago.idTipoCliente, oCambioPlanPostpago.numeroDocumento, oCambioPlanPostpago.flagServicioOnTop, oCambioPlanPostpago.fechaProgramacion, oCambioPlanPostpago.flagLimiteCredito, oCambioPlanPostpago.tipoClarify, oCambioPlanPostpago.numeroCuentaPadre, oCambioPlanPostpago.usuarioAplicacion, oCambioPlanPostpago.usuarioSistema, mensajeRespuesta)

                        Respuesta = oCambioPlanPostpagoNegocios.ServicioCambioPlanPostPago1(oCambioPlanPostpago, id, mensaje)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje de servicio cambio de plan2" & mensaje)
                    Log_ServicioCambioPlanPostPago("2", RespuestaProgramarMigracion, "2º VEZ", "", id, oCambioPlanPostpago.ipAplicacion, oCambioPlanPostpago.aplicacion, oCambioPlanPostpago.msisdn, oCambioPlanPostpago.coId, oCambioPlanPostpago.customerId, oCambioPlanPostpago.Cuenta, oCambioPlanPostpago.escenario, oCambioPlanPostpago.tipoProducto, oCambioPlanPostpago.serviciosAdicionales, oCambioPlanPostpago.codigoProducto, oCambioPlanPostpago.codigoPlanBase, oCambioPlanPostpago.montoApadece, oCambioPlanPostpago.montoFidelizar, oCambioPlanPostpago.flagValidaApadece, oCambioPlanPostpago.flagAplicaApadece, oCambioPlanPostpago.TopeConsumo, oCambioPlanPostpago.tipoTope, oCambioPlanPostpago.descripcionTipoTpe, oCambioPlanPostpago.tipoRegistroTope, oCambioPlanPostpago.topeControlConsumo, oCambioPlanPostpago.fechaProgramacionTope, oCambioPlanPostpago.CAC, oCambioPlanPostpago.asesor, oCambioPlanPostpago.codigoInteraccion, oCambioPlanPostpago.montoPCS, oCambioPlanPostpago.areaPCS, oCambioPlanPostpago.motivoPCS, oCambioPlanPostpago.subMotivoPCS, oCambioPlanPostpago.cicloFacturacion, oCambioPlanPostpago.idTipoCliente, oCambioPlanPostpago.numeroDocumento, oCambioPlanPostpago.flagServicioOnTop, oCambioPlanPostpago.fechaProgramacion, oCambioPlanPostpago.flagLimiteCredito, oCambioPlanPostpago.tipoClarify, oCambioPlanPostpago.numeroCuentaPadre, oCambioPlanPostpago.usuarioAplicacion, oCambioPlanPostpago.usuarioSistema, mensaje)

                Catch ex As Exception
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error en camnbio de plan2:" & ex.Message)
                    Log_ServicioCambioPlanPostPago("3", "", "2º VEZ", ex.ToString(), oCambioPlanPostpago.idTransaccion, oCambioPlanPostpago.ipAplicacion, oCambioPlanPostpago.aplicacion, oCambioPlanPostpago.msisdn, oCambioPlanPostpago.coId, oCambioPlanPostpago.customerId, oCambioPlanPostpago.Cuenta, oCambioPlanPostpago.escenario, oCambioPlanPostpago.tipoProducto, oCambioPlanPostpago.serviciosAdicionales, oCambioPlanPostpago.codigoProducto, oCambioPlanPostpago.codigoPlanBase, oCambioPlanPostpago.montoApadece, oCambioPlanPostpago.montoFidelizar, oCambioPlanPostpago.flagValidaApadece, oCambioPlanPostpago.flagAplicaApadece, oCambioPlanPostpago.TopeConsumo, oCambioPlanPostpago.tipoTope, oCambioPlanPostpago.descripcionTipoTpe, oCambioPlanPostpago.tipoRegistroTope, oCambioPlanPostpago.topeControlConsumo, oCambioPlanPostpago.fechaProgramacionTope, oCambioPlanPostpago.CAC, oCambioPlanPostpago.asesor, oCambioPlanPostpago.codigoInteraccion, oCambioPlanPostpago.montoPCS, oCambioPlanPostpago.areaPCS, oCambioPlanPostpago.motivoPCS, oCambioPlanPostpago.subMotivoPCS, oCambioPlanPostpago.cicloFacturacion, oCambioPlanPostpago.idTipoCliente, oCambioPlanPostpago.numeroDocumento, oCambioPlanPostpago.flagServicioOnTop, oCambioPlanPostpago.fechaProgramacion, oCambioPlanPostpago.flagLimiteCredito, oCambioPlanPostpago.tipoClarify, oCambioPlanPostpago.numeroCuentaPadre, oCambioPlanPostpago.usuarioAplicacion, oCambioPlanPostpago.usuarioSistema, mensajeRespuesta)
                    Respuesta = False
                End Try
            End If

            If Not Respuesta Then
                Try
                    'Consumo de servicio por 3° vez
                    oCambioPlanPostpago.idTransaccion = idTransaccion_aux
                    Log_ServicioCambioPlanPostPago("1", "", "3º VEZ", "", oCambioPlanPostpago.idTransaccion, oCambioPlanPostpago.ipAplicacion, oCambioPlanPostpago.aplicacion, oCambioPlanPostpago.msisdn, oCambioPlanPostpago.coId, oCambioPlanPostpago.customerId, oCambioPlanPostpago.Cuenta, oCambioPlanPostpago.escenario, oCambioPlanPostpago.tipoProducto, oCambioPlanPostpago.serviciosAdicionales, oCambioPlanPostpago.codigoProducto, oCambioPlanPostpago.codigoPlanBase, oCambioPlanPostpago.montoApadece, oCambioPlanPostpago.montoFidelizar, oCambioPlanPostpago.flagValidaApadece, oCambioPlanPostpago.flagAplicaApadece, oCambioPlanPostpago.TopeConsumo, oCambioPlanPostpago.tipoTope, oCambioPlanPostpago.descripcionTipoTpe, oCambioPlanPostpago.tipoRegistroTope, oCambioPlanPostpago.topeControlConsumo, oCambioPlanPostpago.fechaProgramacionTope, oCambioPlanPostpago.CAC, oCambioPlanPostpago.asesor, oCambioPlanPostpago.codigoInteraccion, oCambioPlanPostpago.montoPCS, oCambioPlanPostpago.areaPCS, oCambioPlanPostpago.motivoPCS, oCambioPlanPostpago.subMotivoPCS, oCambioPlanPostpago.cicloFacturacion, oCambioPlanPostpago.idTipoCliente, oCambioPlanPostpago.numeroDocumento, oCambioPlanPostpago.flagServicioOnTop, oCambioPlanPostpago.fechaProgramacion, oCambioPlanPostpago.flagLimiteCredito, oCambioPlanPostpago.tipoClarify, oCambioPlanPostpago.numeroCuentaPadre, oCambioPlanPostpago.usuarioAplicacion, oCambioPlanPostpago.usuarioSistema, mensajeRespuesta)

                        Respuesta = oCambioPlanPostpagoNegocios.ServicioCambioPlanPostPago1(oCambioPlanPostpago, id, mensaje)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje de servicio cambio de plan3" & mensaje)
                    Log_ServicioCambioPlanPostPago("2", RespuestaProgramarMigracion, "3º VEZ", "", id, oCambioPlanPostpago.ipAplicacion, oCambioPlanPostpago.aplicacion, oCambioPlanPostpago.msisdn, oCambioPlanPostpago.coId, oCambioPlanPostpago.customerId, oCambioPlanPostpago.Cuenta, oCambioPlanPostpago.escenario, oCambioPlanPostpago.tipoProducto, oCambioPlanPostpago.serviciosAdicionales, oCambioPlanPostpago.codigoProducto, oCambioPlanPostpago.codigoPlanBase, oCambioPlanPostpago.montoApadece, oCambioPlanPostpago.montoFidelizar, oCambioPlanPostpago.flagValidaApadece, oCambioPlanPostpago.flagAplicaApadece, oCambioPlanPostpago.TopeConsumo, oCambioPlanPostpago.tipoTope, oCambioPlanPostpago.descripcionTipoTpe, oCambioPlanPostpago.tipoRegistroTope, oCambioPlanPostpago.topeControlConsumo, oCambioPlanPostpago.fechaProgramacionTope, oCambioPlanPostpago.CAC, oCambioPlanPostpago.asesor, oCambioPlanPostpago.codigoInteraccion, oCambioPlanPostpago.montoPCS, oCambioPlanPostpago.areaPCS, oCambioPlanPostpago.motivoPCS, oCambioPlanPostpago.subMotivoPCS, oCambioPlanPostpago.cicloFacturacion, oCambioPlanPostpago.idTipoCliente, oCambioPlanPostpago.numeroDocumento, oCambioPlanPostpago.flagServicioOnTop, oCambioPlanPostpago.fechaProgramacion, oCambioPlanPostpago.flagLimiteCredito, oCambioPlanPostpago.tipoClarify, oCambioPlanPostpago.numeroCuentaPadre, oCambioPlanPostpago.usuarioAplicacion, oCambioPlanPostpago.usuarioSistema, mensaje)
                Catch ex As Exception
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error en camnbio de plan3:" & ex.Message)
                    Log_ServicioCambioPlanPostPago("3", "", "3º VEZ", ex.ToString(), oCambioPlanPostpago.idTransaccion, oCambioPlanPostpago.ipAplicacion, oCambioPlanPostpago.aplicacion, oCambioPlanPostpago.msisdn, oCambioPlanPostpago.coId, oCambioPlanPostpago.customerId, oCambioPlanPostpago.Cuenta, oCambioPlanPostpago.escenario, oCambioPlanPostpago.tipoProducto, oCambioPlanPostpago.serviciosAdicionales, oCambioPlanPostpago.codigoProducto, oCambioPlanPostpago.codigoPlanBase, oCambioPlanPostpago.montoApadece, oCambioPlanPostpago.montoFidelizar, oCambioPlanPostpago.flagValidaApadece, oCambioPlanPostpago.flagAplicaApadece, oCambioPlanPostpago.TopeConsumo, oCambioPlanPostpago.tipoTope, oCambioPlanPostpago.descripcionTipoTpe, oCambioPlanPostpago.tipoRegistroTope, oCambioPlanPostpago.topeControlConsumo, oCambioPlanPostpago.fechaProgramacionTope, oCambioPlanPostpago.CAC, oCambioPlanPostpago.asesor, oCambioPlanPostpago.codigoInteraccion, oCambioPlanPostpago.montoPCS, oCambioPlanPostpago.areaPCS, oCambioPlanPostpago.motivoPCS, oCambioPlanPostpago.subMotivoPCS, oCambioPlanPostpago.cicloFacturacion, oCambioPlanPostpago.idTipoCliente, oCambioPlanPostpago.numeroDocumento, oCambioPlanPostpago.flagServicioOnTop, oCambioPlanPostpago.fechaProgramacion, oCambioPlanPostpago.flagLimiteCredito, oCambioPlanPostpago.tipoClarify, oCambioPlanPostpago.numeroCuentaPadre, oCambioPlanPostpago.usuarioAplicacion, oCambioPlanPostpago.usuarioSistema, mensajeRespuesta)
                    Respuesta = False
                End Try
            End If
            'afc : Respueta = True .
            'migracion bonos cch 
            If Respuesta = True Then

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " -@cch Ingreso de Migracion y Bonos - " & Respuesta)
                'afc bonos
                'AUDITORIA
                Dim strIDTrans As String = String.Empty
                Dim strIpAplicacion As String = String.Empty
                Dim strAplicacion As String = String.Empty
                strIDTrans = Now.Year & Now.Month & Now.Day & Now.Hour & Now.Minute & Now.Second
                strAplicacion = ConfigurationSettings.AppSettings("constAplicacion")
                strIpAplicacion = AppLOCAL_ADDR
                Dim sAuditoriastring As New AuditoriaEWS
                sAuditoriastring.IDTRANSACCION = strIDTrans
                sAuditoriastring.IPAPLICACION = strIpAplicacion
                sAuditoriastring.APLICACION = strAplicacion
                sAuditoriastring.USRAPP = CurrentUser

                'LOG AUDITORIA

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - LOG DATOS AUDITORIA- " & String.Format("sAuditoriastring.IDTRANSACCION:{0}-sAuditoriastring.IPAPLICACION:{1}-sAuditoriastring.APLICACION{2}- sAuditoriastring.USRAPP{3} ", sAuditoriastring.IDTRANSACCION, sAuditoriastring.IPAPLICACION, sAuditoriastring.APLICACION, sAuditoriastring.USRAPP))

                'DATAPOWER
                Dim sDataPower As New BEHeaderDataPower
                sDataPower.country = ConfigurationSettings.AppSettings("country")
                sDataPower.language = ConfigurationSettings.AppSettings("languaje")
                sDataPower.consumer = ConfigurationSettings.AppSettings("consumer")
                sDataPower.system = ConfigurationSettings.AppSettings("system")
                sDataPower.modulo = ConfigurationSettings.AppSettings("modulo")
                sDataPower.pid = CurrentUser
                sDataPower.userId = CurrentUser
                sDataPower.dispositivo = AppLOCAL_ADDR
                sDataPower.wsIp = ConfigurationSettings.AppSettings("wsIp")
                sDataPower.operation = ConfigurationSettings.AppSettings("operation")
                sDataPower.timestamp = System.DateTime.Now.ToString("dd-MM-yyyy hh:mm:ss")
                sDataPower.msgType = ConfigurationSettings.AppSettings("msgType")

                'LOG ENTRADA DAPA POWER

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - LOG DATOS DATA POWER- " & String.Format("sDataPower.country:{0}- sDataPower.language :{1}-sDataPower.consumer: {2}- sDataPower.system: {3} - sDataPower.modulo:{4} - sDataPower.pid :{5} - sDataPower.userId :{6} - sDataPower.dispositivo :{7}- sDataPower.wsIp :{8} - sDataPower.operation :{9} - sDataPower.timestamp :{10} - sDataPower.msgType  :{11} ", sAuditoriastring.IDTRANSACCION, sAuditoriastring.IPAPLICACION, sAuditoriastring.APLICACION, sAuditoriastring.USRAPP, sDataPower.country, sDataPower.language, sDataPower.consumer, sDataPower.system, sDataPower.modulo, sDataPower.pid, sDataPower.dispositivo, sDataPower.wsIp, sDataPower.operation, sDataPower.timestamp, sDataPower.msgType))
                'REQUEST SERVICIO
                Dim objBonosNegocios As New BWBonosServicios

                'Dim arrBonos As ArrayList = New ArrayList
                Dim fechaProgBono As DateTime = Date.Now
                Dim codigoRespuesta As String = String.Empty
                Dim descRespuesta As String = String.Empty
                Dim flagRegistraBono As String = ConfigurationSettings.AppSettings("flagRegistroBono")

                Dim solin_codigo = NroSEC

                'log parametros insertarBonosMantener

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - log parametros insertarBonosMantener- " & String.Format("solin_codigo:{0}-flagRegistraBono :{1}- fechaProgBono:{2} ", solin_codigo, flagRegistraBono, fechaProgBono))

                Try
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio llamada al WS insertarBonosMantener")
                    codigoRespuesta = objBonosNegocios.insertarBonosMantener(sDataPower, sAuditoriastring, solin_codigo, flagRegistraBono, fechaProgBono, descRespuesta)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Codigo Respuesta servicio insertarBonosMantener" & descRespuesta)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "mnesaje Respuesta servicio insertarBonosMantener" & descRespuesta)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin llamado al WS insertarBonosMantener")


                Catch ex As Exception
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error llamado al WS insertarBonosMantener:" & ex.Message)
                End Try

            End If
            'fin migracion bonos cch 
            End If

        Catch ex As Exception
            Dim strError As String
            strError = ex.Message
        End Try

        Return Respuesta
    End Function

    Private Function ConsultaSolicitudPospago(ByVal nroSEC As String) As String 'Boolean
        Dim oSolicitudNegocios As New COM_SIC_Activaciones.ClsCambioPlanPostpago
        Dim lista As New ArrayList
        Dim Respuesta As String = ",,1,0,"

        lista = oSolicitudNegocios.ConsultaSolicitudNroSEC(nroSEC)

        If Not lista Is Nothing Then
            If lista.Count > 0 Then
                For Each item As clsSolicitudPersona In lista
                    Respuesta = item.CLIEC_NUM_DOC & "," & item.TPROC_CODIGO & "," & item.SOPLN_TOPE_CONSUMO & "," & item.SOPLC_MONTO_TOTAL & "," & item.SOPLN_TOPE_CF
                Next
            End If
        End If

        Return Respuesta
    End Function


    Private Function ServicioSIACPostpagoConsultas(ByVal codigoBSCS As String, ByVal nroTelefono As String) As String
        Dim oSIACPostpagoConsultas As New clsDatosPostpagoNegocios
        Dim objServicio As New clsClienteBSCS

        'INI: INICIATIVA-219
        Dim objBLCbio As New BLDatosCBIO
        'FIN: INICIATIVA-219

        Dim Resultado As String = String.Empty
        Dim strEmpleado As String
        strEmpleado = AppstrUsuario
        Try
            'objLog.Log_WriteLog(strArchivo, " -" & nroTelefono & " - " & "Consulta datos SIACPostpago: ")
            nroTelefono = Right("000000000" & nroTelefono, 9)
            objFileLog.Log_WriteLog(pathFile, strArchivo, "***********************************************************************************************")
            objFileLog.Log_WriteLog(pathFile, strArchivo, "                           Inicio ConsultaPostpagoWS - " & nroTelefono)
            Dim url As String = ConfigurationSettings.AppSettings("RutaWS_DatosPostpago").ToString()
            objFileLog.Log_WriteLog(pathFile, strArchivo, "URL - " & url & " ||  Usuario - " & strEmpleado)
            objFileLog.Log_WriteLog(pathFile, strArchivo, "***********************************************************************************************")
            'INI: INICIATIVA-219
            objServicio = objBLCbio.LeerDatosCliente(nroTelefono, "", strEmpleado)
            'oSIACPostpagoConsultas.LeerDatosCliente(nroTelefono, "", strEmpleado, "")
            'FIN: INICIATIVA-219
            If Not objServicio Is Nothing Then
                objFileLog.Log_WriteLog(pathFile, strArchivo, "customerId - " & objServicio.customerId)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "cuenta - " & objServicio.cuenta)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "Nombre - " & objServicio.Nombre)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "apellidos - " & objServicio.apellidos)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "razonSocial - " & objServicio.razonSocial)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "tip_doc - " & objServicio.tip_doc)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "num_doc - " & objServicio.num_doc)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "titulo - " & objServicio.titulo)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "telef_principal - " & objServicio.telef_principal)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "estado_civil - " & objServicio.estado_civil)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "fecha_nac - " & objServicio.fecha_nac)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "lug_nac - " & objServicio.lug_nac)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "ruc_dni - " & objServicio.ruc_dni)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "nomb_comercial - " & objServicio.nomb_comercial)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "contacto_cliente - " & objServicio.contacto_cliente)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "rep_legal - " & objServicio.rep_legal)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "telef_contacto - " & objServicio.telef_contacto)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "fax - " & objServicio.fax)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "email - " & objServicio.email)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "cargo - " & objServicio.cargo)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "asesor - " & objServicio.asesor)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "direccion_fac - " & objServicio.direccion_fac)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "urbanizacion_fac - " & objServicio.urbanizacion_fac)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "distrito_fac - " & objServicio.distrito_fac)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "provincia_fac - " & objServicio.provincia_fac)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "cod_postal_fac - " & objServicio.cod_postal_fac)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "departamento_fac - " & objServicio.departamento_fac)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "pais_fac - " & objServicio.pais_fac)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "direccion_leg - " & objServicio.direccion_leg)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "urbanizacion_leg - " & objServicio.urbanizacion_leg)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "distrito_leg - " & objServicio.distrito_leg)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "provincia_leg - " & objServicio.provincia_leg)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "cod_postal_leg - " & objServicio.cod_postal_leg)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "departamento_leg - " & objServicio.departamento_leg)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "pais_leg - " & objServicio.pais_leg)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "co_id - " & objServicio.co_id)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "nicho_id - " & objServicio.nicho_id)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "num_cuentas - " & objServicio.num_cuentas)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "num_lineas - " & objServicio.num_lineas)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "ciclo_fac - " & objServicio.ciclo_fac)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "status_cuenta - " & objServicio.status_cuenta)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "modalidad - " & objServicio.modalidad)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "tipo_cliente - " & objServicio.tipo_cliente)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "fecha_act - " & objServicio.fecha_act)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "limite_credito - " & objServicio.limite_credito)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "segmento - " & objServicio.segmento)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "respon_pago - " & objServicio.respon_pago)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "credit_score - " & objServicio.credit_score)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "forma_pago - " & objServicio.forma_pago)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "codigo_tipo_cliente - " & objServicio.codigo_tipo_cliente)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "sexo - " & objServicio.sexo)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "nacionalidad - " & objServicio.nacionalidad)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "estado_civil_id - " & objServicio.estado_civil_id)

                Resultado = objServicio.customerId & "|" & objServicio.co_id & "|" & objServicio.cuenta & "|" & objServicio.num_doc & "|" & objServicio.ciclo_fac
            Else
                objFileLog.Log_WriteLog(pathFile, strArchivo, "Error al consultar - " & nroTelefono)
            End If
            objFileLog.Log_WriteLog(pathFile, strArchivo, "***********************************************************************************************")
            objFileLog.Log_WriteLog(pathFile, strArchivo, "                              Fin ConsultaPostpagoWS - " & nroTelefono)
            objFileLog.Log_WriteLog(pathFile, strArchivo, "***********************************************************************************************")
        Catch ex As Exception
            'objLog.Log_WriteLog(strArchivo, " -" & nroTelefono & " - " & "Error  ServicioSIACPostpagoConsultas: " & ex.Message)
            oSIACPostpagoConsultas = Nothing
            Throw
        End Try
        Return Resultado

    End Function

    '****************************MEtodos para Claro Club*********************************

    Public Function ExisteCanjePuntosClaroClub(ByVal NroDocSap As String, _
                                               ByVal strIdentifyLog As String, _
                                               ByRef nroLinea As String) As Boolean
        Dim bExiste As Boolean = False
        Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio ExisteCanjePuntosClaroClub()")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   INP  NroDocSap : " & NroDocSap)

            Dim objCajas As New COM_SIC_Cajas.clsCajas
            Dim dt As DataTable
            Dim CONS_FLAG_CANJE As String = CheckStr(ConfigurationSettings.AppSettings("CONS_FLAG_CANJE"))
            dt = objCajas.ListarCanjePuntos(NroDocSap)

            If dt.Rows.Count > 0 Then
                Dim dr As DataRow = dt.Rows(0)
                If Funciones.CheckStr(dr.Item("FLAG_CANJE")) <> CONS_FLAG_CANJE Then
                    nroLinea = Funciones.CheckStr(dr.Item("NRO_LINEA"))
                    bExiste = True
                End If
            End If
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   out  bExiste : " & bExiste)

        Catch ex As Exception
            'INI PROY-140126
            Dim MaptPath As String
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: ExisteCanjePuntosClaroClub)"
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   OUT ERROR : " & ex.Message.ToString() & MaptPath)
            'FIN PROY-140126

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   OUT ERROR : " & ex.StackTrace.ToString())

            bExiste = False
        Finally
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin ExisteCanjePuntosClaroClub()")
        End Try
        Return bExiste
    End Function

    Public Function CanjeDescuentoEquipo(ByVal NroDocSap As String, _
                                ByVal strIdentifyLog As String, ByVal nroLiena As String) As Boolean

        Dim blnRespuesta As Boolean
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio CanjeDescuentoEquipo(): " & ConfigurationSettings.AppSettings("WSCanjePuntosCC_url"))
        Dim objCajas As New COM_SIC_Cajas.clsCajas
        Dim dtResultado As DataTable
        Dim drResultado As DataRow
        Dim numDocumento As String

        Try
            drPagos = AppDocSel
            dtResultado = objCajas.ListarCanjePuntos(NroDocSap)
            If dtResultado.Rows.Count > 0 Then
                drResultado = dtResultado.Rows(0)
            End If

            Dim objCanjeDevolucionServicioComercialService As New CanjeDescuentoEquipoWS.ebsCanjeDevolucionServicioComercialService
            objCanjeDevolucionServicioComercialService.Url = ConfigurationSettings.AppSettings("WSCanjePuntosCC_url")
            objCanjeDevolucionServicioComercialService.Timeout = Convert.ToInt32((ConfigurationSettings.AppSettings("WSCanjePuntosCC_timeout")))
            Dim objCanjeDescuentoEquipoRequest As New CanjeDescuentoEquipoWS.canjeDescuentoEquipoRequest
            Dim objInfoDeTransacccion As New CanjeDescuentoEquipoWS.InfoDeTransaccionType
            Dim objCanjeDescuentoEquipoResponse As New CanjeDescuentoEquipoWS.canjeDescuentoEquipoResponse

            objInfoDeTransacccion.usrApp = CurrentUser  ' Usuario de Aplicación que invoca al servicio.
            objInfoDeTransacccion.usrName = AppNOMBRE_COMPLETO ' Nombre de usuario de aplicación cliente.
            objInfoDeTransacccion.aplicacion = ConfigurationSettings.AppSettings("CONS_RENOVACION_USUARIO") ' Alias de la aplicación que invoca al servicio.
            objInfoDeTransacccion.estacion = System.Net.Dns.GetHostName ' Nombre de la aplicación que invoca al servicio.
            objInfoDeTransacccion.ipAplicacion = AppREMOTE_HOST ' IP de la aplicación que invoca el servicio..
            Dim idTime As String = Now.ToString("yyyyMMddHHmmss")
            objInfoDeTransacccion.fechaHora = idTime ' Fecha y hora de la transacción.
            objInfoDeTransacccion.idTransaccion = NroDocSap ' ID que debe ser generada por el cliente que invoca al servicio.
            objCanjeDescuentoEquipoRequest.infoDeTransaccion = objInfoDeTransacccion

            numDocumento = drResultado.Item("NUM_DOC")
            objCanjeDescuentoEquipoRequest.nombreCliente = drPagos.Item("PEDIV_NOMBRECLIENTE") ' Nombre de Cliente.
            objCanjeDescuentoEquipoRequest.tipoDocumento = Funciones.CheckStr(drResultado("ID_CCLUB")) ' Tipo de Documento.
            objCanjeDescuentoEquipoRequest.numDocumento = numDocumento ' Numero del Documento.
            objCanjeDescuentoEquipoRequest.puntoVenta = AppAlmacen ' Punto de Venta.(sera el de siempre o se tiene que convertir) --- OBSERVACION
            objCanjeDescuentoEquipoRequest.codAplicacion = ConfigurationSettings.AppSettings("CodAplicacion")
            ' Inicio SD_812077 
            objCanjeDescuentoEquipoRequest.codAsesor = Funciones.CheckStr(drResultado("USUARIO_REG"))  ' Código del asesor
            'Validarrrr (todo esto para el nombre del vendedor)
            'Dim dsPedido As DataSet = objPagos.Get_ConsultaPedido("", Session("ALMACEN"), NroDocSap, "")
            'Dim codVendedor As String = dsPedido.Tables(0).Rows(0).Item("VENDEDOR")
            'Dim dsVendedor As DataSet = objPagos.Get_ConsultaVend(codVendedor)
            'Dim strNomVendedor As String = CheckStr(dsVendedor.Tables(0).Rows(0).Item("NOMBRE"))
            Dim strNomVendedor As String = "" 'Nombre del asesor de ventas   ---OBSERVACION
            objCanjeDescuentoEquipoRequest.nomAsesor = strNomVendedor ' Nombre del asesor  -----OBSERVACION
            ' Fin SD_812077
            objCanjeDescuentoEquipoRequest.idVenta = NroDocSap ' Codigo del Id de Venta.
            objCanjeDescuentoEquipoRequest.idProceso = ConfigurationSettings.AppSettings("CONST_VTA_RENOVACION") ' Tipo de Operacion  : AP(Vta Alta Postpago)/AE(Vta Alta Prepago)/VR(Vta Renovación).
            objCanjeDescuentoEquipoRequest.puntosVenta = CInt(Funciones.CheckInt64(drResultado("PUNTOS_USADOS")).ToString)
            objCanjeDescuentoEquipoRequest.solesVenta = CInt(Funciones.CheckInt64(drResultado("SOLES_DESCUENTO")).ToString)
            objCanjeDescuentoEquipoRequest.idCampana = Funciones.CheckStr(drResultado("IDCAMPANA")) ' Codigo de Campaña
            objCanjeDescuentoEquipoRequest.usuario = CurrentUser
            objCanjeDescuentoEquipoRequest.codigoCliente = nroLiena 'verificar si es necesario
            objCanjeDescuentoEquipoRequest.segmento = Funciones.CheckStr(drResultado("SEGMENTO"))
            objCanjeDescuentoEquipoRequest.lineaTipificacion = Funciones.CheckStr(drResultado("NRO_LINEA")) 'NRO_LINEA

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp usrApp : " & objInfoDeTransacccion.usrApp)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp usrName : " & objInfoDeTransacccion.usrName)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp aplicacion : " & objInfoDeTransacccion.aplicacion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp estacion : " & objInfoDeTransacccion.estacion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp ipAplicacion : " & objInfoDeTransacccion.ipAplicacion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp fechaHora : " & objInfoDeTransacccion.fechaHora)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp idTransaccion : " & objInfoDeTransacccion.idTransaccion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp nombreCliente : " & objCanjeDescuentoEquipoRequest.nombreCliente)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp tipoDocumento : " & objCanjeDescuentoEquipoRequest.tipoDocumento)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp numDocumento : " & objCanjeDescuentoEquipoRequest.numDocumento)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp puntoVenta : " & objCanjeDescuentoEquipoRequest.puntoVenta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp codAplicacion : " & objCanjeDescuentoEquipoRequest.codAplicacion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp codAsesor : " & objCanjeDescuentoEquipoRequest.codAsesor)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp nomAsesor : " & objCanjeDescuentoEquipoRequest.nomAsesor)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp idVenta : " & objCanjeDescuentoEquipoRequest.idVenta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp idProceso : " & objCanjeDescuentoEquipoRequest.idProceso)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp puntosVenta : " & objCanjeDescuentoEquipoRequest.puntosVenta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp solesVenta : " & objCanjeDescuentoEquipoRequest.solesVenta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp idCampana : " & objCanjeDescuentoEquipoRequest.idCampana)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp usuario : " & objCanjeDescuentoEquipoRequest.usuario)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp segmento : " & objCanjeDescuentoEquipoRequest.segmento)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp lineaTipificacion : " & objCanjeDescuentoEquipoRequest.lineaTipificacion)

            objCanjeDescuentoEquipoResponse = objCanjeDevolucionServicioComercialService.canjeDescuentoEquipo(objCanjeDescuentoEquipoRequest)

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out codigoRespuesta : " & objCanjeDescuentoEquipoResponse.codigoRespuesta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out idTransaccion : " & objCanjeDescuentoEquipoResponse.idTransaccion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out mensajeRespuesta : " & objCanjeDescuentoEquipoResponse.mensajeRespuesta)

            If objCanjeDescuentoEquipoResponse.codigoRespuesta = "0" Then
                blnRespuesta = True
            Else
                Throw New Exception("Ocurrió un error al realizar el canje de los Puntos Claro Club.")
            End If
        Catch ex As Exception
            'INI PROY-140126
            Dim MaptPath As String
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: CanjeDescuentoEquipo)"
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   Out  ERROR : " & ex.Message.ToString() & MaptPath)
            'FIN PROY-140126
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   Out  StackTrace : " & ex.StackTrace.ToString())
            Throw New Exception("Ocurrió un error al realizar el canje de los Puntos Claro Club.")
        Finally
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin CanjeDescuentoEquipo()")
        End Try

        Return blnRespuesta
    End Function

    Public Sub ActualizarCanjePuntos(ByVal NroDocSap As String, _
                                        ByVal NroReferenciaImprimir As String, _
                                        ByVal strIdentifyLog As String)
        Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "---------------Inicio ActualizarCanjePuntos()-----------")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   INP  NroDocSap : " & NroDocSap)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   INP  NroReferenciaImprimir : " & NroReferenciaImprimir)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   INP  USUARIO : " & AppUsuario)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   INP  CONS_FLAG_CANJE : " & ConfigurationSettings.AppSettings("CONS_FLAG_CANJE"))

            Dim objCajas As New COM_SIC_Cajas.clsCajas
            objCajas.actualizarPuntosClaroClub(NroDocSap, _
                                               NroReferenciaImprimir, _
                                               AppUsuario, _
                                               ConfigurationSettings.AppSettings("CONS_FLAG_CANJE"))

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Actualizó correctamente actualizarPuntosClaroClub()")
        Catch ex As Exception
            'INI PROY-140126
            Dim MaptPath As String
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: ActualizarCanjePuntos)"
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   OUT  ERROR : " & ex.Message.ToString() & MaptPath)
            'FIN PROY-140126

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   OUT  ERROR : " & ex.StackTrace.ToString())
        Finally
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "---------------Fin ActualizarCanjePuntos()-----------")
        End Try
    End Sub

    '***************************************************************************************************

    Private Sub DeshacerCambiosPagos(ByVal K_PAGON_IDPAGO As Int64)
        '*** PROCESO DE ROLLBACK AL PROCESO DE PAGOS *****************************************'
        If K_PAGON_IDPAGO > 0 Then
            Dim K_NROLOG As String = ""
            Dim K_DESLOG As String = ""
            Dim strIdentifyLog As String = String.Format("--[{0}]--", numeroOperacion)

            objTrsMsSap.DeshacerCambiosPedidoPagado(K_PAGON_IDPAGO, K_NROLOG, K_DESLOG)
            If K_DESLOG = "OK" Then
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  EL RollBack al pedido :" & K_PAGON_IDPAGO & " se ejecuto con errores.")
                AppCodigoDeshacerCambios = "-3"
                AppMensajeDeshacerCambios = "EL RollBack al pedido :" & K_PAGON_IDPAGO & " se ejecuto con errores."
                ' Response.Redirect("PoolPagos.aspx")
            Else
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  EL RollBack al pedido :" & K_PAGON_IDPAGO & " se ejecuto correctamene.")
            End If
        End If
    End Sub


Private Sub ActualizarWL()
        Dim objClsConsultaPvu As New COM_SIC_Activaciones.clsConsultaPvu
        Dim Rpta As New Integer
        Dim NRO_Telefono As String
        Dim Estado As String
        Dim IMEI As String
        Dim dtResultado As DataTable
        Dim drResultado As DataRow
        Dim DocSunat As String

        DocSunat = AppQdocSunat
        NRO_Telefono = AppQnumeroTelefono

        objFileLog.Log_WriteLog(pathFile, strArchivo, "Inicio del mètodo ActualizarWL")

        dtResultado = objClsConsultaPvu.ConsultaVentaRenoWL(NRO_Telefono, "1")
        If dtResultado.Rows.Count > 0 Then
            drResultado = dtResultado.Rows(0)
            Estado = drResultado.Item("WLRPV_ESTADO") 'Estado en la Tabla WhiteList
            IMEI = drResultado.Item("WLRPV_IMEI_EQUIPO") 'IMEI en la Tabla WhiteList
        End If


        If Estado = "1" And IMEI <> "" Then
            Rpta = objClsConsultaPvu.ActualizaVentaRenoWL(NRO_Telefono, "2")
            If Rpta = "0" Then
                objFileLog.Log_WriteLog(pathFile, strArchivo, "Fin del mètodo ActualizarWL - Actualizado OK")
            Else
                objFileLog.Log_WriteLog(pathFile, strArchivo, "Fin del mètodo ActualizarWL - Error al Actualizar")
            End If
        Else
            objFileLog.Log_WriteLog(pathFile, strArchivo, "Fin del mètodo ActualizarWL - No Actualizado")
        End If
        
    End Sub


#Region "Tipificaciones"

    Public Function Tipificacion1(ByVal strIdentifyLog As String, ByVal numeroTelefono As String, ByVal documentoSAP As String, ByVal vendedor As String, ByVal strcadena As String, ByVal strtipoRenovacion As String) As String ' MOD: PROY 26210 - RMZ
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Inicio Tipificacion1() ---")

        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "numeroTelefono: " & numeroTelefono)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "documentoSAP: " & documentoSAP)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "vendedor: " & vendedor)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "strcadena: " & strcadena)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "strtipoRenovacion: " & strtipoRenovacion) 'ADD: PROY 26210 - RMZ
        Dim idInteraccion1 As String = Tipificacion1(numeroTelefono, documentoSAP, vendedor, strcadena, strtipoRenovacion)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Fin Tipificacion1() ---")

        Return idInteraccion1
    End Function

    Public Sub Tipificacion2(ByVal strIdentifyLog As String, ByVal numeroTelefono As String, ByVal documentoSAP As String, ByVal vendedor As String, ByVal strNotas As String) ' MOD: PROY 26210 - RMZ
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Inicio Tipificacion2() ---")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "numeroTelefono: " & numeroTelefono)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "documentoSAP: " & documentoSAP)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "vendedor: " & vendedor)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "notas: " & strNotas) 'ADD: PROY 26210 - RMZ

        Tipificacion2(numeroTelefono, documentoSAP, vendedor, strNotas) 'MOD: PROY 26210 - RMZ

        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Fin Tipificacion2() ---")
    End Sub

    Public Sub Tipificacion3(ByVal strIdentifyLog As String, ByVal numeroTelefono As String, ByVal documentoSAP As String, ByVal vendedor As String, ByVal strNotas As String) 'MOD: PROY 26210 - RMZ
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Inicio Tipificacion3() ---")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "numeroTelefono: " & numeroTelefono)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "documentoSAP: " & documentoSAP)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "vendedor: " & vendedor)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "notas: " & strNotas) 'ADD: PROY 26210 - RMZ

        Tipificacion3(numeroTelefono, documentoSAP, vendedor, strNotas) 'MOD: PROY 26210 - RMZ

        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Fin Tipificacion3() ---")
    End Sub

    Public Sub Tipificacion4(ByVal strIdentifyLog As String, ByVal numeroTelefono As String, ByVal documentoSAP As String, ByVal vendedor As String, ByVal strNotas As String) 'MOD: PROY 26210 - RMZ
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Inicio Tipificacion4() ---")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "numeroTelefono: " & numeroTelefono)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "documentoSAP: " & documentoSAP)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "vendedor: " & vendedor)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "notas: " & strNotas) 'ADD: PROY 26210 - RMZ

        Tipificacion4(numeroTelefono, documentoSAP, vendedor, strNotas) 'MOD: PROY 26210 - RMZ

        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Fin Tipificacion4() ---")
    End Sub

#End Region

    ' Fin E77568

    Sub ActivaChipRepuesto(ByVal strNroPedidoSAP As String, ByVal strDocSunat As String, ByVal sTipoVenta As String, ByVal sTipoOperacion As String)
        Dim dsResult As DataSet

        Dim i, j As Integer
        Dim strSolicitud As String
        Dim arrSolicitud() As String

        Dim strResultActChip As String

        Dim strIMEI_SANS As String
        Dim strTelefono As String
        Dim strOficVenta As String

        Dim strConsulta As String

        Dim strMSISDN As String
        Dim strCODCAUSA As String
        Dim strICCIDNEW As String
        Dim strICCIDOLD As String
        Dim strNROTXSW As String
        Dim strNROPEDIDO As String
        Dim strNROOFIVENTA As String
        Dim strESTADOINI As String

        Dim strIMSI_NUEVO As String

        Dim arrActualizaCHIP() As String
        Dim strActualizaCHIP As String


        Dim arrFilCHIP
        Dim arrResulFilCHIPError
        Dim arrResulFilCHIPValor
        Dim arrResulFilCHIPNomb
        Dim strConsultaCHIP

        Dim strTipoVenta As String
        Dim strOperacion As String
        Dim strMotivo As String
        Dim strCaso As String
        Dim vendedor As String
        Dim descripcion As String 'dg

        Dim strResLog As String
        Dim strCodError As String
        Dim strMenError As String
        Dim blnAnularVenta As Boolean = False

        Dim objINActCHIP As New COM_SIC_INActChip.clsActivacion
        Dim objComponente As New COM_SIC_ActCHIP.clsActivacion

        Dim objFileLog As New SrvPago_Log
        Dim nameFile As String = ConfigurationSettings.AppSettings("constNameLogCambioSIM")
        Dim pathFile As String = ConfigurationSettings.AppSettings("constRutaLogCambioSIM")
        Dim strArchivo As String = objFileLog.Log_CrearNombreArchivo(nameFile)
        Dim strIdentifyLog As String = strNroPedidoSAP
        Dim strParametros As String = ""

        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio de Transaccion.")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Oficina Venta : " & AppAlmacen & " - " & AppOFICINA)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Usuario : " & AppUsuario)

        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo SetGet_LogActivacionCHIP()")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Parametros : " & strNroPedidoSAP & "|" & AppAlmacen & "|" & "" & "|" & "")

        AppFLAGCHIPREP = ""
        'dsResult = objPagos.SetGet_LogActivacionCHIP(strNroPedidoSAP, Session("ALMACEN"), "", "")

        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo SetGet_LogActivacionCHIP()")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FKART : " & drPagos.Item("PEDIC_CLASEFACTURA"))

        strSolicitud = ""


        Dim tipoVentaPrepago As String = ConfigurationSettings.AppSettings("strTVPrepago")
        Dim tipoOperacionChipRepuesto As String = ConfigurationSettings.AppSettings("strDTVReposicionChip")
        Dim tipoOperacion_PackPrepago As String = ConfigurationSettings.AppSettings("COD_OPERACION_RENOVACION")

        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "sTipoVenta: " & sTipoVenta)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "sTipoOperacion: " & sTipoOperacion)

        If strSolicitud = "" And sTipoVenta = tipoVentaPrepago And (sTipoOperacion = tipoOperacionChipRepuesto Or sTipoOperacion = tipoOperacion_PackPrepago) Then
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Se genera detalle solicitud")
            If (GenerarDetalleChipSap(strNroPedidoSAP, strSolicitud)) Then

            End If
        End If
        'strSolicitud = "1;0197204226;895110010400404862;716100100740825;0013;;R01;895110010401250542;;0000010380;1;28/06/2005;05:35:33;;;;;;"

        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Cadena Solicitud : " & strSolicitud)

        If Trim(strSolicitud) <> "" Then
            arrSolicitud = Split(strSolicitud, ";")
            strMSISDN = arrSolicitud(1)
            strNROPEDIDO = arrSolicitud(5) 'strNroPedidoSAP
            strCODCAUSA = arrSolicitud(6).Replace("n", "ñ") ' PROY 30160 RU02 - RMZ
            strNROOFIVENTA = arrSolicitud(4) 'Session("ALMACEN")
            strNROTXSW = arrSolicitud(0)
            strICCIDOLD = arrSolicitud(2)
            strICCIDNEW = arrSolicitud(7)
            strESTADOINI = arrSolicitud(10)

            arrSolicitud(16) = Format(Day(Now), "00") & "/" & Format(Month(Now), "00") & "/" & Format(Year(Now), "0000") 'Session("FechaAct")
            arrSolicitud(17) = Format(Now, "H:mm:ss")
            arrSolicitud(14) = "X"
            'Inicio Amejia
            strMSISDN = FormatoTelefono(strMSISDN)
            'strMSISDN = Right("0000000000" & strMSISDN, 10)
            'fin Amejia

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo SetGet_LogActivacionCHIP()")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Parametros : " & "" & "|" & "" & "|" & Join(arrSolicitud, ";") & "|" & "")

            'dsResult = objPagos.SetGet_LogActivacionCHIP("", "", Join(arrSolicitud, ";"), "")

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo SetGet_LogActivacionCHIP()")

            'Consultar tipo de venta
            'dsResult = objPagos.Get_ConsultaPedido("", Session("ALMACEN"), strNROPEDIDO, "")


            '****************** PARAMETROS DE RETORNO DE CONSULTA PEDIDO PVU  *********************************'
            Dim P_CODIGO_RESPUESTA As String
            Dim P_MENSAJE_RESPUESTA As String
            Dim C_VENTA As DataTable    '=> numero_sec , PARA LA SEC
            Dim C_VENTA_DET As DataTable
            Dim k As Integer = 0
            '**************************************************************************************************'

            Dim objClsConsultaPvu As New COM_SIC_Activaciones.clsConsultaPvu

            dsResult = objConsultaMsSap.ConsultaPedido(drPagos.Item("PEDIN_NROPEDIDO"), "", "")

            objClsConsultaPvu.ConsultarPedidosPVU(drPagos.Item("PEDIN_NROPEDIDO"), P_CODIGO_RESPUESTA, P_MENSAJE_RESPUESTA, C_VENTA, C_VENTA_DET)

            If Not IsNothing(dsResult) Then
                If dsResult.Tables(0).Rows.Count > 0 Then
                    strTipoVenta = dsResult.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA")
                    strOperacion = dsResult.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION")
                    strCaso = dsResult.Tables(0).Rows(0).Item("PEDIN_NROPEDIDO")
                    'strMotivo = C_VENTA.Rows(0).Item("CODMOTIVO") 'dsResult.Tables(0).Rows(0).Item("AUGRU")
                    vendedor = Funciones.CheckStr(IIf(IsDBNull(dsResult.Tables(0).Rows(0).Item("VENDEDOR")), "", dsResult.Tables(0).Rows(0).Item("VENDEDOR"))) 'C_VENTA.Rows(0).Item("VENDEDOR")
                    For k = 0 To dsResult.Tables(1).Rows.Count - 1
                        If Funciones.CheckStr(dsResult.Tables(1).Rows(k).Item("MATEC_TIPOMATERIAL")) = ConfigurationSettings.AppSettings("constChips") Then
                            descripcion = Funciones.CheckStr(dsResult.Tables(1).Rows(k).Item("DEPEV_DESCMATERIAL")) 'dg
                        End If
                    Next
                End If
            End If
            ' Fin Consultar tipo de venta

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo Venta : " & strTipoVenta)

            If strTipoVenta = ConfigurationSettings.AppSettings("strTVPrepago") Then    'or strTipoVenta = strTVControl then  'CARIAS
                'Activacion de CHIP Repuesto utilizando componente PVUSIX
                strConsulta = strMSISDN & ";" & strNROPEDIDO & ";" & strCODCAUSA & ";" & strNROOFIVENTA & ";" & strNROTXSW & ";" & strICCIDOLD & ";" & Left(strICCIDNEW, 18) & ";" & strCaso & ";" & ConfigurationSettings.AppSettings("cteCODIGO_BINADQUIRIENTE") & ";" & ConfigurationSettings.AppSettings("cteCODIGO_CANAL") & ";PVU"

                ' E75893 - INVOCACION WS CAMBIO DE SIM
                If ConfigurationSettings.AppSettings("constFlagWSCambioSIM") = "S" Then
                    AppFLAGCHIPREP = ""

                    Dim ICCID As String
                    Dim OLD_ICCID As String
                    Dim strAccion As String
                    Dim strBloqueo As String


                    Dim strTipoPlan As String
                    Dim flagBloqueo As String

                    Dim mensajePrepago As String
                    Dim retornoCambioSIM As String
                    Dim mensajeCambioSIM As String
                    Dim retornoDesbloqueo As String
                    Dim mensajeDesbloqueo As String
                    Dim errorCambioSIM As String
                    'PROY 30993

                    Dim strInteractionIdCambioSIM As String
                    Dim strUbicacionError As String
                    Dim strOrigen As String
                    Dim strEstado As Integer = 0
                    Dim strFecha As DateTime = DateTime.Now.ToUniversalTime().ToString("yyyy'-'MM'-'dd'T'HH':'mm':'ss'.'fffzzz")
                    Dim strAPlicacion As String = ConfigurationSettings.AppSettings("Usuario_Aplicacion")
                    Dim strCanal As String = ConfigurationSettings.AppSettings("ConsNombreAplicacion")
                    Dim strIdAplicacion As String = ConfigurationSettings.AppSettings("consIdAplicacion")
                    Dim strIP As String = ""
                    Dim strUsrSession As String = AppstrUsuario
                    Dim strEmpleado As String = ""
                    Dim strIdTransaccionESB As String = ""
                    Dim strID As String = ""
                    Dim dtFechaInicio As DateTime = DateTime.Now.ToUniversalTime().ToString("yyyy'-'MM'-'dd'T'HH':'mm':'ss'.'fffzzz")
                    Dim strNodoAdicional As String = ""
                    Dim MSISDN As String = ""
                    Dim strTipoDocumento As String = ""
                    Dim strNumeroDocumento As String = ""
                    '
                    Dim strCanalAtencion As String = ConfigurationSettings.AppSettings("strCanalAtencion")
                    Dim strCodigoMaterial As String = ""
                    Dim strOficinaVenta As String = ""
                    Dim strClienteSap As String = ""
                    Dim strCodigoBloqueo As String = ""
                    Dim strCodigoRespuesta As String = ""
                    Dim strDescripcionRespuesta As String = ""
                    Dim resultado As Integer = 0
                    'PROY FIN 30993

                    Dim flagTFI As String

                    Dim oCambioSIM As New COM_SIC_INActChip.clsCambioSIM
                    Dim oBloqueoDesbloqueo As New COM_SIC_INActChip.clsBloqueoDesbloqueo
                    'dg020315inicio
                    Dim oActualizarSimCard As New NEGOCIO_SIC_SANS.SimCardRepoNegocio
                    Dim retornoActSimCard As String
                    'dg020315fin

                    Dim idTransaccion As String     ' Formato PVU: "003xxxxxxx" - SICAR: "004xxxxxxx"
                    idTransaccion = Int((9999999 - 1000000 + 1) * Rnd() + 1000000)
                    idTransaccion = "004" & Right("0000000" & idTransaccion, 7)

                    strIP = ConfigurationSettings.AppSettings("constIPServidorSICAR")
                    strAccion = ConfigurationSettings.AppSettings("constDesbloqueoLinea")
                    strBloqueo = ConfigurationSettings.AppSettings("constBloqueoLinea")
                    strID = idTransaccion
                    ICCID = Left(strICCIDNEW, 18)
                    OLD_ICCID = Left(strICCIDOLD, 18)
                    MSISDN = FormatoTelefonoPrepago(strMSISDN)

                    ' Consultar el Usuario del Vendedor
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Inicio FP_ConsultaUsuarioRed")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Cod Vendedor:" + vendedor)
                    Dim strRespuesta As String
                    Dim oConsulta As New COM_SIC_Activaciones.clsBDSiscajas
                    Dim dsUsuario As DataSet

                    Do While InStr(1, vendedor, "0") = 1
                        vendedor = Mid(vendedor, 2, Len(vendedor))
                    Loop

                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Cod Vendedor:" + vendedor)
                    dsUsuario = oConsulta.FP_ConsultaUsuarioRed(vendedor, strRespuesta) 'Validado
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "strRespuesta:" + strRespuesta)

                    If Not IsNothing(dsUsuario) Then
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "nro de registros :" + dsUsuario.Tables(0).Rows.Count.ToString())
                        If dsUsuario.Tables(0).Rows.Count > 0 Then
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "Codigo de red:" + dsUsuario.Tables(0).Rows(0).Item(0))
                            strEmpleado = dsUsuario.Tables(0).Rows(0).Item(0)
                        Else
                            strEmpleado = AppstrUsuario
                        End If
                    Else
                        strEmpleado = AppstrUsuario
                    End If

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Codigo SAP: " & vendedor)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Codigo Red : " & strEmpleado)

                    dsUsuario = Nothing
                    oConsulta = Nothing
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Fin FP_ConsultaUsuarioRed")
                    ' Cadena de Parametros
                    strParametros = ""
                    strParametros = strParametros & MSISDN & "|"
                    strParametros = strParametros & "1" & "|"
                    strParametros = strParametros & ConfigurationSettings.AppSettings("constServicioSMS") & "|"
                    strParametros = strParametros & ConfigurationSettings.AppSettings("constServicioSMS") & "|"
                    strParametros = strParametros & ConfigurationSettings.AppSettings("constServicioSMS") & "|"
                    strParametros = strParametros & Now() & "|"
                    strParametros = strParametros & ConfigurationSettings.AppSettings("constRutaWSDatosLinea") & "|"
                    strParametros = strParametros & ConfigurationSettings.AppSettings("constTimeOutWSDatosLinea")

                    ' Verificar si la Linea se encuentra Bloqueada
                    Dim oDatosLineaPrepago As New COM_SIC_INActChip.clsDatosLinea

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo DatosLineaPrepago()")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Parametros : " & strParametros)

                    strTipoPlan = oDatosLineaPrepago.DatosLineaPrepago(MSISDN, _
                                                                        ConfigurationSettings.AppSettings("providerIdPrepago"), _
                                                                        ConfigurationSettings.AppSettings("providerIdControl"), _
                                                                        ConfigurationSettings.AppSettings("constTimeOutWSDatosLinea"), _
                                                                        ConfigurationSettings.AppSettings("constRutaWSDatosLinea"), _
                                                                        flagBloqueo, _
                                                                        mensajePrepago)

                    oDatosLineaPrepago = Nothing

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo de Plan : " & strTipoPlan)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Flag Bloqueo : " & flagBloqueo)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje : " & mensajePrepago)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo DatosLineaPrepago()")
                    'MODIFICACION DESDE AQUI PROY-30933

                    Dim strFlagCambioSim As String = ConfigurationSettings.AppSettings("consActivaCambioSim")
                    If strFlagCambioSim = "1" Then
                        If UCase(Trim(strTipoPlan)) = "P" Then
                            'INICIO PROY 30993

                            'Obtener datos del cliente
                            Dim oTipificacion As New COM_SIC_INActChip.clsTipificacion
                            Dim dsCliente As DataSet
                            Dim contactoId As Int64
                            dsCliente = oTipificacion.ConsultaCliente(MSISDN, "", contactoId, CInt("1"), "", "")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo ConsultaCliente()")

                            If Not IsNothing(dsCliente) Then
                                If dsCliente.Tables(0).Rows.Count > 0 Then
                                    strTipoDocumento = dsCliente.Tables(0).Rows(0).Item("TIPO_DOC")
                                    strNumeroDocumento = dsCliente.Tables(0).Rows(0).Item("NRO_DOC")
                                Else
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error. Cliente no existe en Clarify. No pudo realizar la creacion de la Interaccion.")
                                End If
                            Else
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error. Cliente no existe en Clarify. No pudo realizar la creacion de la Interaccion.")
                            End If
                            'FIN PROY 30993
                            ' Cadena de Parametros
                            strParametros = ""
                            strParametros = strParametros & MSISDN & "|"
                            strParametros = strParametros & ICCID & "|"
                            strParametros = strParametros & strID & "|"
                            strParametros = strParametros & strIP & "|"
                            strParametros = strParametros & strEmpleado & "|"
                            strParametros = strParametros & ConfigurationSettings.AppSettings("constAplicacion") & "|"
                            strParametros = strParametros & ConfigurationSettings.AppSettings("constTimeOutWSCambioSIMPrepago") & "|"
                            Dim KeyUSR_PWD_CambioSim As String = ConfigurationSettings.AppSettings("KeyUSR_PWD_CambioSim")
                            strParametros = strParametros & ConfigurationSettings.AppSettings("constRutaWSCambioSIMPrepago")
                            ' Leer Usuario y Contraseña
                            Dim objsegu As COM_SIC_Seguridad.Configuracion = New COM_SIC_Seguridad.Configuracion(KeyUSR_PWD_CambioSim)
                            Dim usuario As String
                            Dim contraseña As String

                            Dim strUsrAplicacionEncriptado As String
                            Dim strClaveUsrEncriptado As String
                            strUsrAplicacionEncriptado = objsegu.LeerUsuarioEncriptado()
                            strClaveUsrEncriptado = objsegu.LeerContrasenaEncriptado()
                            ''Consulta Claves
                            Try
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio ConsultaClavesWS")
                                Dim strURL As String = ConfigurationSettings.AppSettings("strURLConsultaClavesWS")
                                Dim strTimeOup As String = ConfigurationSettings.AppSettings("constTimeOutConsultaClavesWS")
                                Dim strCodigoAplicacion As String = ConfigurationSettings.AppSettings("CodAplicacion")
                                Dim strMensaje As String
                                Dim oResultado = ""
                                Dim oConsultaClave As New COM_SIC_INActChip.ConsultarClave
                                oResultado = oConsultaClave.f_strObtenerClaveWeb(strURL, idTransaccion, "", "", _
                                strAPlicacion, strIdAplicacion, strCodigoAplicacion, strUsrAplicacionEncriptado, strClaveUsrEncriptado, _
                                strMensaje, usuario, contraseña)

                                If oResultado = "0" Then
                                    If usuario = "" Or contraseña = "" Then
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error Usuario o Contraseña en vacios")
                                    Else
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Usuario y Contraseña desencriptado correctamente")
                                    End If
                                Else
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error ConsultaClavesWS: " & strMensaje)
                                End If
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FIN ConsultaClavesWS")
                            Catch ex As Exception
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error ConsultaClavesWS: " & ex.Message)
                            End Try
                            ' Invocar WS para Cambio de SIM

                            Dim country As String = ConfigurationSettings.AppSettings("consCountry")
                            Dim language As String = ConfigurationSettings.AppSettings("consLanguage")
                            Dim consumer As String = ConfigurationSettings.AppSettings("consConsumer")
                            Dim _system As String = ConfigurationSettings.AppSettings("consSystem")
                            Dim modulo As String = ConfigurationSettings.AppSettings("consModulo")
                            Dim pid As String = strID
                            Dim userId As String = ConfigurationSettings.AppSettings("consUserId")
                            Dim dispositivo As String = ConfigurationSettings.AppSettings("consDispositivo")
                            Dim wsIp As String = ConfigurationSettings.AppSettings("consIpBSS_CambioSimPrepago")
                            Dim operation As String = ConfigurationSettings.AppSettings("consOperation")
                            Dim msgType As String = ConfigurationSettings.AppSettings("consMsgType")
                            Dim nodoAdicional As String = ConfigurationSettings.AppSettings("consnodoAdicional")
                            ' Cadena de Parametros
                            strParametros = ""
                            strParametros = strParametros & strCanal & "|"
                            strParametros = strParametros & strIdAplicacion & "|"
                            strParametros = strParametros & strAPlicacion & "|"
                            strParametros = strParametros & strUsrSession & "|"
                            strParametros = strParametros & strID & "|"
                            strParametros = strParametros & dtFechaInicio & "|"
                            strParametros = strParametros & nodoAdicional & "|"
                            strParametros = strParametros & MSISDN & "|"
                            strParametros = strParametros & strTipoDocumento & "|"
                            strParametros = strParametros & strNumeroDocumento & "|"
                            strParametros = strParametros & ICCID & "|"
                            strParametros = strParametros & strCanalAtencion & "|"
                            strParametros = strParametros & strCodigoMaterial & "|"
                            strParametros = strParametros & strOficinaVenta & "|"
                            strParametros = strParametros & strClienteSap & "|"
                            strParametros = strParametros & strCodigoBloqueo & "|"
                            strParametros = strParametros & ConfigurationSettings.AppSettings("constTimeOutWSCambioSIMPrepago") & "|"
                            strParametros = strParametros & ConfigurationSettings.AppSettings("constRutaWSCambioSIMPrepago") & "|"
                            strParametros = strParametros & country & "|"
                            strParametros = strParametros & language & "|"
                            strParametros = strParametros & consumer & "|"
                            strParametros = strParametros & _system & "|"
                            strParametros = strParametros & modulo & "|"
                            strParametros = strParametros & pid & "|"
                            strParametros = strParametros & userId & "|"
                            strParametros = strParametros & dispositivo & "|"
                            strParametros = strParametros & wsIp & "|"
                            strParametros = strParametros & operation & "|"
                            strParametros = strParametros & msgType

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo CambioSIMPrepago()")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Parametros : " & strParametros)

                            resultado = oCambioSIM.CambioSIMPrepago(strCanal, strIdAplicacion, strAPlicacion, _
                            strUsrSession, "", strID, dtFechaInicio, nodoAdicional, MSISDN, strTipoDocumento, strNumeroDocumento, _
                            ICCID, strCanalAtencion, strCodigoMaterial, strOficinaVenta, strClienteSap, strCodigoBloqueo, _
                            ConfigurationSettings.AppSettings("constTimeOutWSCambioSIMPrepago"), ConfigurationSettings.AppSettings("constRutaWSCambioSIMPrepago"), _
                            strEstado, strCodigoRespuesta, strDescripcionRespuesta, strUbicacionError, strFecha, strOrigen, _
                            country, language, consumer, _system, modulo, pid, userId, dispositivo, wsIp, operation, msgType, _
                            usuario, contraseña)

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Resultado : " & resultado)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje : " & strDescripcionRespuesta)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo CambioSIMPrepago()")

                            If Trim(resultado) = "0" Then
                                'Response.Write("<script>alert(strDescripcionRespuesta)</script>")
                                AppmensajeCHIPRepuesto = String.Empty
                                'dg24022015
                            Else
                                blnAnularVenta = True
                                AppmensajeCHIPRepuesto = "Hubo inconvenientes al procesar el cambio de Chip Repuesto. " & ConfigurationSettings.AppSettings("Mensaje_ChipRepuesto") & " \n"
                                mensajeCambioSIM = strDescripcionRespuesta
                                AppmensajeCHIPRepuesto = AppmensajeCHIPRepuesto & strDescripcionRespuesta
                            End If
                        Else
                            blnAnularVenta = True
                            AppmensajeCHIPRepuesto = "No se pudo realizar el Cambio de SIM en Linea. Error Metodo Consulta Datos Prepago. " & ConfigurationSettings.AppSettings("Mensaje_ChipRepuesto")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje Error : " & AppmensajeCHIPRepuesto)
                        End If
                    Else
                    If UCase(Trim(strTipoPlan)) = "P" Then
                        If UCase(Trim(flagBloqueo)) = "TRUE" Then
                            ' Cadena de Parametros
                            strParametros = ""
                            strParametros = strParametros & MSISDN & "|"
                            strParametros = strParametros & strAccion & "|"
                            strParametros = strParametros & strID & "|"
                            strParametros = strParametros & strIP & "|"
                            strParametros = strParametros & strEmpleado & "|"
                            strParametros = strParametros & ConfigurationSettings.AppSettings("constAplicacion") & "|"
                            strParametros = strParametros & ConfigurationSettings.AppSettings("constTimeOutWSCambioSIM") & "|"
                            strParametros = strParametros & ConfigurationSettings.AppSettings("constRutaWSCambioSIM")

                            ' Invocar WS para Desbloquear Linea
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo BloqueoDesbloqueo()")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Parametros : " & strParametros)

                            retornoDesbloqueo = oBloqueoDesbloqueo.BloqueoDesbloqueo(MSISDN, _
                                                                                        strAccion, _
                                                                                        strID, _
                                                                                        strIP, _
                                                                                        strEmpleado, _
                                                                                        ConfigurationSettings.AppSettings("constAplicacion"), _
                                                                                        ConfigurationSettings.AppSettings("constTimeOutWSCambioSIM"), _
                                                                                        ConfigurationSettings.AppSettings("constRutaWSCambioSIM"), _
                                                                                        mensajeDesbloqueo)

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Resultado : " & retornoDesbloqueo)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje : " & mensajeDesbloqueo)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo BloqueoDesbloqueo()")

                            ' Si el DesBloqueo de Linea fue exitoso realizar el Cambio de SIM
                            If Trim(retornoDesbloqueo) = "0" Then
                                ' Cadena de Parametros
                                strParametros = ""
                                strParametros = strParametros & MSISDN & "|"
                                strParametros = strParametros & ICCID & "|"
                                strParametros = strParametros & strID & "|"
                                strParametros = strParametros & strIP & "|"
                                strParametros = strParametros & strEmpleado & "|"
                                strParametros = strParametros & ConfigurationSettings.AppSettings("constAplicacion") & "|"
                                strParametros = strParametros & ConfigurationSettings.AppSettings("constTimeOutWSCambioSIM") & "|"
                                strParametros = strParametros & ConfigurationSettings.AppSettings("constRutaWSCambioSIM")

                                ' Invocar WS para Cambio de SIM
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo CambioSIM()")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Parametros : " & strParametros)

                                retornoCambioSIM = oCambioSIM.CambioSIM(MSISDN, _
                                                                        ICCID, _
                                                                        strID, _
                                                                        strIP, _
                                                                        strEmpleado, _
                                                                        ConfigurationSettings.AppSettings("constAplicacion"), _
                                                                        ConfigurationSettings.AppSettings("constTimeOutWSCambioSIM"), _
                                                                        ConfigurationSettings.AppSettings("constRutaWSCambioSIM"), _
                                                                        mensajeCambioSIM)

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Resultado : " & retornoCambioSIM)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje : " & mensajeCambioSIM)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo CambioSIM()")

                                If Trim(retornoCambioSIM) = "0" Then
                                        AppmensajeCHIPRepuesto = ""
                                    'dg24022015
								Else
                                    blnAnularVenta = True
                                    If retornoCambioSIM = "999" Then
                                            'Session("mensajeCHIPRepuesto") = "El Servicio no se encuentra disponible en este momento. Por favor volver a intentar. SE ANULARÁ LA VENTA."
                                            AppmensajeCHIPRepuesto = "El Servicio no se encuentra disponible en este momento. " & ConfigurationSettings.AppSettings("Mensaje_ChipRepuesto")
                                    Else
                                        'Session("mensajeCHIPRepuesto") = "Hubo inconvenientes al procesar el cambio de Chip Repuesto. Para mas detalle contactar con el Administrador. SE ANULARÁ LA VENTA. \n"
                                            AppmensajeCHIPRepuesto = "Hubo inconvenientes al procesar el cambio de Chip Repuesto. " & ConfigurationSettings.AppSettings("Mensaje_ChipRepuesto") & " \n"
                                        mensajeCambioSIM = mensajeCambioSIM.Replace("'", "")
                                        mensajeCambioSIM = mensajeCambioSIM.Replace("\r", "")
                                        mensajeCambioSIM = mensajeCambioSIM.Replace("\n", "")
                                            AppmensajeCHIPRepuesto = AppmensajeCHIPRepuesto & mensajeCambioSIM
                                    End If

                                    ' Cadena de Parametros
                                    strParametros = ""
                                    strParametros = strParametros & MSISDN & "|"
                                    strParametros = strParametros & strBloqueo & "|"
                                    strParametros = strParametros & strID & "|"
                                    strParametros = strParametros & strIP & "|"
                                    strParametros = strParametros & strEmpleado & "|"
                                    strParametros = strParametros & ConfigurationSettings.AppSettings("constAplicacion") & "|"
                                    strParametros = strParametros & ConfigurationSettings.AppSettings("constTimeOutWSCambioSIM") & "|"
                                    strParametros = strParametros & ConfigurationSettings.AppSettings("constRutaWSCambioSIM")

                                    ' Invocar WS para Bloquear Linea
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Rollback BloqueoDesbloqueo()")
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Parametros : " & strParametros)

                                    retornoDesbloqueo = oBloqueoDesbloqueo.BloqueoDesbloqueo(MSISDN, _
                                                                                                strBloqueo, _
                                                                                                strID, _
                                                                                                strIP, _
                                                                                                strEmpleado, _
                                                                                                ConfigurationSettings.AppSettings("constAplicacion"), _
                                                                                                ConfigurationSettings.AppSettings("constTimeOutWSCambioSIM"), _
                                                                                                ConfigurationSettings.AppSettings("constRutaWSCambioSIM"), _
                                                                                                mensajeDesbloqueo)

                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Resultado : " & retornoDesbloqueo)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje : " & mensajeDesbloqueo)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Rollback BloqueoDesbloqueo()")

                                    If retornoCambioSIM <> "999" Then
                                        ' Cadena de Parametros
                                        strParametros = ""
                                        strParametros = strParametros & MSISDN & "|"
                                        strParametros = strParametros & OLD_ICCID & "|"
                                        strParametros = strParametros & strID & "|"
                                        strParametros = strParametros & strIP & "|"
                                        strParametros = strParametros & strEmpleado & "|"
                                        strParametros = strParametros & ConfigurationSettings.AppSettings("constAplicacion") & "|"
                                        strParametros = strParametros & ConfigurationSettings.AppSettings("constTimeOutWSCambioSIM") & "|"
                                        strParametros = strParametros & ConfigurationSettings.AppSettings("constRutaWSCambioSIM")

                                        ' Invocar WS para Cambio de SIM
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Rollback CambioSIM()")
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Parametros : " & strParametros)

                                        errorCambioSIM = oCambioSIM.CambioSIM(MSISDN, _
                                                                                OLD_ICCID, _
                                                                                strID, _
                                                                                strIP, _
                                                                                strEmpleado, _
                                                                                ConfigurationSettings.AppSettings("constAplicacion"), _
                                                                                ConfigurationSettings.AppSettings("constTimeOutWSCambioSIM"), _
                                                                                ConfigurationSettings.AppSettings("constRutaWSCambioSIM"), _
                                                                                mensajeCambioSIM)

                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Resultado : " & errorCambioSIM)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje : " & mensajeCambioSIM)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Rollback CambioSIM()")
                                    End If
                                End If
                            Else
                                    AppmensajeCHIPRepuesto = " No se pudo realizar el Cambio de SIM en Linea. Error Metodo Desbloqueo de Linea. Para mas detalle contactar con el Administrador"

                                ' Cadena de Parametros
                                strParametros = ""
                                strParametros = strParametros & MSISDN & "|"
                                strParametros = strParametros & strBloqueo & "|"
                                strParametros = strParametros & strID & "|"
                                strParametros = strParametros & strIP & "|"
                                strParametros = strParametros & strEmpleado & "|"
                                strParametros = strParametros & ConfigurationSettings.AppSettings("constAplicacion") & "|"
                                strParametros = strParametros & ConfigurationSettings.AppSettings("constTimeOutWSCambioSIM") & "|"
                                strParametros = strParametros & ConfigurationSettings.AppSettings("constRutaWSCambioSIM")

                                ' Invocar WS para Bloquear Linea
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Rollback BloqueoDesbloqueo()")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Parametros : " & strParametros)

                                retornoDesbloqueo = oBloqueoDesbloqueo.BloqueoDesbloqueo(MSISDN, _
                                        strBloqueo, _
                                        strID, _
                                        strIP, _
                                        strEmpleado, _
                                        ConfigurationSettings.AppSettings("constAplicacion"), _
                                        ConfigurationSettings.AppSettings("constTimeOutWSCambioSIM"), _
                                        ConfigurationSettings.AppSettings("constRutaWSCambioSIM"), _
                                        mensajeDesbloqueo)

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Resultado : " & retornoDesbloqueo)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje : " & mensajeDesbloqueo)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Rollback BloqueoDesbloqueo()")
                            End If
                        Else
                            ' Cadena de Parametros
                            strParametros = ""
                            strParametros = strParametros & MSISDN & "|"
                            strParametros = strParametros & ICCID & "|"
                            strParametros = strParametros & strID & "|"
                            strParametros = strParametros & strIP & "|"
                            strParametros = strParametros & strEmpleado & "|"
                            strParametros = strParametros & ConfigurationSettings.AppSettings("constAplicacion") & "|"
                            strParametros = strParametros & ConfigurationSettings.AppSettings("constTimeOutWSCambioSIM") & "|"
                            strParametros = strParametros & ConfigurationSettings.AppSettings("constRutaWSCambioSIM")

                            ' Invocar WS para Cambio de SIM
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo CambioSIM()")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Parametros : " & strParametros)

                            retornoCambioSIM = oCambioSIM.CambioSIM(MSISDN, _
                                                                    ICCID, _
                                                                    strID, _
                                                                    strIP, _
                                                                    strEmpleado, _
                                                                    ConfigurationSettings.AppSettings("constAplicacion"), _
                                                                    ConfigurationSettings.AppSettings("constTimeOutWSCambioSIM"), _
                                                                    ConfigurationSettings.AppSettings("constRutaWSCambioSIM"), _
                                                                    mensajeCambioSIM)

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Resultado : " & retornoCambioSIM)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje : " & mensajeCambioSIM)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo CambioSIM()")

                            If Trim(retornoCambioSIM) = "0" Then
                                    AppmensajeCHIPRepuesto = ""
                            Else
                                blnAnularVenta = True

                                If retornoCambioSIM = "999" Then
                                        AppmensajeCHIPRepuesto = "El Servicio no se encuentra disponible en este momento. " & ConfigurationSettings.AppSettings("Mensaje_ChipRepuesto")
                                Else
                                        AppmensajeCHIPRepuesto = "Hubo inconvenientes al procesar el cambio de Chip Repuesto. " & ConfigurationSettings.AppSettings("Mensaje_ChipRepuesto") & " \n"
                                    mensajeCambioSIM = mensajeCambioSIM.Replace("'", "")
                                    mensajeCambioSIM = mensajeCambioSIM.Replace("\r", "")
                                    mensajeCambioSIM = mensajeCambioSIM.Replace("\n", "")
                                        AppmensajeCHIPRepuesto = AppmensajeCHIPRepuesto & mensajeCambioSIM
                                End If

                                If retornoCambioSIM <> "999" Then
                                    ' Cadena de Parametros
                                    strParametros = ""
                                    strParametros = strParametros & MSISDN & "|"
                                    strParametros = strParametros & OLD_ICCID & "|"
                                    strParametros = strParametros & strID & "|"
                                    strParametros = strParametros & strIP & "|"
                                    strParametros = strParametros & strEmpleado & "|"
                                    strParametros = strParametros & ConfigurationSettings.AppSettings("constAplicacion") & "|"
                                    strParametros = strParametros & ConfigurationSettings.AppSettings("constTimeOutWSCambioSIM") & "|"
                                    strParametros = strParametros & ConfigurationSettings.AppSettings("constRutaWSCambioSIM")

                                    ' Invocar WS para Cambio de SIM
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Rollback CambioSIM()")
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Parametros : " & strParametros)

                                    errorCambioSIM = oCambioSIM.CambioSIM(MSISDN, _
                                                                            OLD_ICCID, _
                                                                            strID, _
                                                                            strIP, _
                                                                            strEmpleado, _
                                                                            ConfigurationSettings.AppSettings("constAplicacion"), _
                                                                            ConfigurationSettings.AppSettings("constTimeOutWSCambioSIM"), _
                                                                            ConfigurationSettings.AppSettings("constRutaWSCambioSIM"), _
                                                                            mensajeCambioSIM)

                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Resultado : " & errorCambioSIM)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje : " & mensajeCambioSIM)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Rollback CambioSIM()")
                                End If
                            End If
                        End If
                    Else
                        blnAnularVenta = True
                            AppmensajeCHIPRepuesto = "No se pudo realizar el Cambio de SIM en Linea. Error Metodo Consulta Datos Prepago. " & ConfigurationSettings.AppSettings("Mensaje_ChipRepuesto")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje Error : " & AppmensajeCHIPRepuesto)
                    End If
                    End If


                    If strFlagCambioSim = "1" Then
                        If Trim(resultado) = "0" Then
                            AppFLAGCHIPREP = "S"
                        Else
                            AppFLAGCHIPREP = "N"
                        End If
                    Else
                    If Trim(retornoCambioSIM) = "0" Then
                            AppFLAGCHIPREP = "S"

                        arrSolicitud(8) = ""
                        arrSolicitud(13) = ConfigurationSettings.AppSettings("gstrEstSolicVariado")
                        arrSolicitud(14) = ""

                        ' Cadena de Parametros
                        strParametros = ""
                        strParametros = strParametros & "" & "|"
                        strParametros = strParametros & "" & "|"
                        strParametros = strParametros & Join(arrSolicitud, ";") & "|"
                        strParametros = strParametros & ""

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo SetGet_LogActivacionCHIP()")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Parametros : " & strParametros)

                        'dsResult = objPagos.SetGet_LogActivacionCHIP("", "", Join(arrSolicitud, ";"), "")

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo SetGet_LogActivacionCHIP()")

                        ' Creacion TIPIFICACION - INTERACCION
                        Dim dsCliente As DataSet
                        Dim strReposicion As String()   'PROY-30160 - JCFM
                        Dim objIdContacto As String
                        Dim contactoId As Int64
                        Dim nroDocCliente As String
                        Dim nombreCliente As String
                        Dim apellidoCliente As String
                        Dim clarifyTelef As String

                        Dim oInteraccion As New COM_SIC_INActChip.Interaccion
                        Dim oPlantilla As New COM_SIC_INActChip.PlantillaInteraccion

                        Dim flagInter As String
                        Dim mensajeInter As String
                        Dim idInteraccion As String

                        ' Validacion Telefono TFI
                        If Len(Trim(MSISDN)) = 8 Then
                            flagTFI = "X"
                            clarifyTelef = "000" & Trim(MSISDN)
                        Else
                            clarifyTelef = MSISDN
                        End If

                        ' Cadena de Parametros
                        strParametros = ""
                        strParametros = strParametros & clarifyTelef & "|"
                        strParametros = strParametros & "" & "|"
                        strParametros = strParametros & "" & "|"
                        strParametros = strParametros & 1

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo ConsultaCliente()")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Parametros : " & strParametros)

                        ' Consulta de Id Cliente Clarify
                        Dim oTipificacion As New COM_SIC_INActChip.clsTipificacion
                        dsCliente = oTipificacion.ConsultaCliente(clarifyTelef, "", contactoId, CInt("1"), "", "")

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo ConsultaCliente()")

                        If Not IsNothing(dsCliente) Then
                            If dsCliente.Tables(0).Rows.Count > 0 Then
                                objIdContacto = dsCliente.Tables(0).Rows(0).Item("OBJID_CONTACTO")
                                nroDocCliente = dsCliente.Tables(0).Rows(0).Item("NRO_DOC")
                                nombreCliente = dsCliente.Tables(0).Rows(0).Item("NOMBRES")
                                apellidoCliente = dsCliente.Tables(0).Rows(0).Item("APELLIDOS")

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Id Contacto: " & objIdContacto)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Nro Doc. Cliente: " & nroDocCliente)

                                ' Verificar si se Realizo Desbloqueo de Linea
                                If Trim(retornoDesbloqueo) = "0" Then
                                    ' Creacion Interaccion de Desbloqueo de Linea
                                    oInteraccion = DatosInteraccion()
                                    oInteraccion.AGENTE = strEmpleado
                                    oInteraccion.OBJID_CONTACTO = objIdContacto
                                    oInteraccion.TELEFONO = MSISDN

                                    ' Validacion Parametros Tipificacion
                                    If flagTFI = "X" Then
                                        oInteraccion.TIPO = ConfigurationSettings.AppSettings("TIPO_DEFAULT_TFI")
                                        oInteraccion.CLASE = ConfigurationSettings.AppSettings("CLASE_DESBLOQUEO_CHIP_TFI")
                                        oInteraccion.SUBCLASE = ConfigurationSettings.AppSettings("SUBCLASE_DESBLOQUEO_TFI")
                                    Else
                                        oInteraccion.TIPO = ConfigurationSettings.AppSettings("TIPO_DEFAULT")
                                        oInteraccion.CLASE = ConfigurationSettings.AppSettings("CLASE_DESBLOQUEO_CHIP")
                                        oInteraccion.SUBCLASE = ConfigurationSettings.AppSettings("SUBCLASE_CHIP")
                                    End If

                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Inicio Region Desbloqueo Linea ---")
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo CrearInteraccion()")

                                    oTipificacion.CrearInteraccion(oInteraccion, idInteraccion, flagInter, mensajeInter)

                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Id Interaccion : " & idInteraccion)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Flag Metodo : " & flagInter)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje : " & mensajeInter)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo CrearInteraccion()")

                                    If Trim(flagInter) = "OK" Then
                                        ' Creacion Plantilla Tipificacion
                                        oPlantilla.X_FIRST_NAME = nombreCliente
                                        oPlantilla.X_LAST_NAME = apellidoCliente
                                        oPlantilla.X_DOCUMENT_NUMBER = nroDocCliente

                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo InsertarPlantilla()")

                                        oTipificacion.InsertarPlantillaInteraccion(oPlantilla, idInteraccion, flagInter, mensajeInter)

                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Id Interaccion : " & idInteraccion)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Flag Metodo : " & flagInter)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje : " & mensajeInter)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo InsertarPlantilla()")
                                    End If
                                End If

                                ' Creacion Interaccion de Cambio de SIM
                                oInteraccion = DatosInteraccion()
                                oInteraccion.AGENTE = strEmpleado
                                oInteraccion.OBJID_CONTACTO = objIdContacto
                                oInteraccion.TELEFONO = MSISDN

                                ' Validacion Parametros Tipificacion
                                If flagTFI = "X" Then
                                    oInteraccion.TIPO = ConfigurationSettings.AppSettings("TIPO_DEFAULT_TFI")
                                    oInteraccion.CLASE = ConfigurationSettings.AppSettings("CLASE_CAMBIO_CHIP_TFI")
                                    oInteraccion.SUBCLASE = ConfigurationSettings.AppSettings("SUBCLASE_CAMBIO_TFI")
                                Else
                                    oInteraccion.TIPO = ConfigurationSettings.AppSettings("TIPO_DEFAULT")
                                    oInteraccion.CLASE = ConfigurationSettings.AppSettings("CLASE_CAMBIO_CHIP")
                                    oInteraccion.SUBCLASE = ConfigurationSettings.AppSettings("SUBCLASE_CHIP")
                                End If

                                ' Creacion Interaccion
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Inicio Region Cambio SIM ---")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo CrearInteraccion()")

                                oTipificacion.CrearInteraccion(oInteraccion, idInteraccion, flagInter, mensajeInter)

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Id Interaccion : " & idInteraccion)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Flag Metodo : " & flagInter)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje : " & mensajeInter)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo CrearInteraccion()")

                                If Trim(flagInter) = "OK" Then
                                    ' Creacion Plantilla Tipificacion
                                    Dim oPlantilla1 As New COM_SIC_INActChip.PlantillaInteraccion
                                    oPlantilla1.X_FIRST_NAME = nombreCliente
                                    oPlantilla1.X_LAST_NAME = apellidoCliente
                                    oPlantilla1.X_DOCUMENT_NUMBER = nroDocCliente
                                    oPlantilla1.X_REASON = strCODCAUSA
                                    oPlantilla1.X_ICCID = ICCID

                                    'PROY-30160 - INICIO
                                    Dim intTipoProducto As Integer = 0
                                    Dim strMontoDescuento As String = String.Empty
                                    Dim strMotivoTG As String = String.Empty

                                    Try
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "    -- ConsultaReposicionPrepagoTGFI - INICIO --")
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "    -- IN strNroPedidoSAP" & strNroPedidoSAP)
                                        strReposicion = objClsConsultaPvu.ConsultaReposicionPrepagoTGFI(strNroPedidoSAP)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "    -- OUT COD RPTA: " & Funciones.CheckStr(strReposicion(2)))

                                            'INI PROY-140126
                                            Dim MaptPath As String
                                            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                                            MaptPath = "( Class : " & MaptPath & "; Function: ActivaChipRepuesto)"
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "    -- OUT MSG RPTA: " & Funciones.CheckStr(strReposicion(3)) & MaptPath)
                                            'FIN PROY-140126

                                        intTipoProducto = Funciones.CheckInt(Funciones.CheckStr(strReposicion(2)))
                                        If intTipoProducto <> -1 Then
                                            Select Case intTipoProducto
                                                Case 1
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "    -- FIDELIZACION")
                                                    strMontoDescuento = Funciones.CheckStr(strReposicion(0))
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        -- Monto descuento: " & strMontoDescuento)
                                                    oPlantilla1.X_INTER_30 = "Monto de descuento: S/." & strMontoDescuento
                                                    oPlantilla1.X_REASON = "Fidelización"
                                                Case 2
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "    -- TRANSFERENCIA GRATUITA")
                                                    strMotivoTG = Funciones.CheckStr(strReposicion(1))
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        -- Motivo TG: " & strMotivoTG)
                                                    oPlantilla1.X_REASON = strMotivoTG
                                                Case 3
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "    -- NINGUNO")
                                                Case Else
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "    -- SIN TIPO DE PRODUCTO")
                                            End Select
                                        Else
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "    -- ERROR: ConsultaReposicionPrepagoTGFI - " & Funciones.CheckStr(strReposicion(3)))
                                        End If
                                    Catch ex As Exception
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "    -- ERROR: ConsultaReposicionPrepagoTGFI - " & ex.Message().ToString())
                                    Finally
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "    -- ConsultaReposicionPrepagoTGFI - FIN --")
                                    End Try
                                    'PROY-30160 - FIN

                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo InsertarPlantilla()")
                                    oTipificacion.InsertarPlantillaInteraccion(oPlantilla1, idInteraccion, flagInter, mensajeInter)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Id Interaccion : " & idInteraccion)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Flag Metodo : " & flagInter)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje : " & mensajeInter)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo InsertarPlantilla()")
                                End If
                            Else
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error. Cliente no existe en Clarify. No pudo realizar la creacion de la Interaccion.")
                            End If
                        Else
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error. Cliente no existe en Clarify. No pudo realizar la creacion de la Interaccion.")
                        End If
                    Else
                            AppFLAGCHIPREP = "N"
                    End If
                    End If


                Else
                    If (strTipoVenta = ConfigurationSettings.AppSettings("strTVPrepago")) And (strESTADOINI = "3") Then       ' (strMotivo = "R01" or strMotivo = "R02") then
                        strConsultaCHIP = objINActCHIP.Set_CHIPPrepagoPorRobo(strConsulta)
                    Else
                        'if strTipoVenta = strTVPrepago then
                        strConsultaCHIP = objINActCHIP.Set_CHIPPrepago(strConsulta)
                        'else
                        '  strConsultaCHIP = objComponente.Set_CHIPControl(strConsulta & ";F")
                        'end if  
                    End If

                    arrFilCHIP = Split(strConsultaCHIP, "|")
                    arrResulFilCHIPError = Split(arrFilCHIP(0), ";")
                    AppFLAGCHIPREP = ""

                    strCodError = Split(arrFilCHIP(2), ";")(1)       'Codigo de mensaje
                    strMenError = Split(arrFilCHIP(2), ";")(2)       'Descripcion de mensaje
                    'Response.Write(strCodError):Response.End 

                    'dsResult = objPagos.Set_LogVariacion(strConsulta, "RETCODE;ERRORMSG", strCodError & ";" & strMenError)

                    'Response.Write(strResLog):Response.end

                    'if arrResulFilCHIPError(0)<>"XX00XX" then
                    If IsNumeric(strCodError) Then
                        If CInt(strCodError) = 0 Then
                            AppFLAGCHIPREP = "S"

                            arrSolicitud(13) = ConfigurationSettings.AppSettings("gstrEstSolicVariado")
                            arrSolicitud(8) = ""       'strIMSI_NUEVO
                            arrSolicitud(14) = ""

                            'Response.Write join(arrSolicitud,";")
                            'Response.End 

                            'dsResult = objPagos.SetGet_LogActivacionCHIP("", "", Join(arrSolicitud, ";"), "")
                        Else
                            AppFLAGCHIPREP = "N"
                        End If
                    Else
                        AppFLAGCHIPREP = "N"
                    End If
                    'end if    

                    If IsNumeric(strCodError) Then
                        If CInt(strCodError) <> 0 Then       'error en el cambio de chip 
                            AppFLAGCHIPREP = "N"
                        End If
                    Else
                        AppFLAGCHIPREP = "N"
                    End If
                End If
            Else
                'Entra si no es prepago
                'Activacion de CHIP Repuesto utilizando Web Service
                strConsulta = strMSISDN & ";" & strNROPEDIDO & ";" & strCODCAUSA & ";" & strNROOFIVENTA & ";" & strNROTXSW & ";" & strICCIDOLD & ";" & strICCIDNEW

                'Response.Write strConsulta & "<br><br>"
                'Response.End 

                strConsultaCHIP = objComponente.FK_ActualizaEstadoChip(strConsulta, ConfigurationSettings.AppSettings("gStrUrlSvrPCR"), ConfigurationSettings.AppSettings("gStrServicioPCR"), ConfigurationSettings.AppSettings("gStrUsuarioPCR"))

                'Response.Write "Resul Int." & strConsultaCHIP
                'Response.End 

                arrFilCHIP = Split(strConsultaCHIP, "|")
                arrResulFilCHIPError = Split(arrFilCHIP(0), ";")
                AppFLAGCHIPREP = ""

                If arrResulFilCHIPError(0) <> "XX00XX" Then
                    If arrResulFilCHIPError(0) <> "0" Then
                        AppFLAGCHIPREP = "N"
                    Else
                        arrResulFilCHIPNomb = Split(arrFilCHIP(1), ";")
                        arrResulFilCHIPValor = Split(arrFilCHIP(2), ";")
                        strIMSI_NUEVO = ValorResultCHIP("IMSI", arrResulFilCHIPNomb, arrResulFilCHIPValor)
                        AppFLAGCHIPREP = "S"

                        arrSolicitud(13) = ConfigurationSettings.AppSettings("gstrEstSolicVariado")
                        arrSolicitud(8) = strIMSI_NUEVO
                        arrSolicitud(14) = ""

                        'Response.Write join(arrSolicitud,";")
                        'Response.End 
                        'consultar a Manuel
                        'dsResult = objPagos.SetGet_LogActivacionCHIP("", "", (Join(arrSolicitud, ";")), "")
                    End If
                Else
                    AppFLAGCHIPREP = "N"
                End If
            End If     'CARIAS 	
        Else
            AppFLAGCHIPREP = ""
        End If
        '******************************Fin Consulta**************************************

        If blnAnularVenta Then
            Dim obAnular As New clsAnulaciones
            Dim strVias() As String = {""}
            Dim strFecha As String = Format(Day(Now), "00") & "/" & Format(Month(Now), "00") & "/" & Format(Year(Now), "0000")

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Inicio Anulacion venta Chip Repuesto")
            Try
                ''Anular Documento Chip Repuesto
                'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Inicio AnularDocCHIPREP_ChipRepuesto")
                'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "    IN " & " strNroPedidoSAP: " & strNroPedidoSAP)
                'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "    IN " & " ALMACEN: " & Session("ALMACEN"))
                'obAnular.AnularDocCHIPREP(strNroPedidoSAP, Session("ALMACEN"))
                'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Fin AnularDocCHIPREP_ChipRepuesto")

                ''ANULAR PAGO
                'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio AnulacionDePago_ChipRepuesto")
                'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "    IN " & " strNroPedidoSAP: " & strNroPedidoSAP)
                'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "    IN " & " strDocSunat: " & strDocSunat)
                'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "    IN " & " CANAL: " & Session("CANAL"))
                'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "    IN " & " ALMACEN: " & Session("ALMACEN"))
                'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "    IN " & " USUARIO: " & Session("USUARIO"))
                ''TS-LGZ **** INICIO (CONSIDERAR EL ESTADO ANULACION PARA QUE EL BATCH ANULE EL PAGO EN SAP)
                ''TS JTN
                'obAnular.AnulacionDePagoSAP(strNroPedidoSAP, strDocSunat, strFecha, strVias, Session("CANAL"), Session("ALMACEN"), Session("USUARIO"), strVias)
                ''TS-LGZ **** FINAL
                'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin AnulacionDePago_ChipRepuesto")

                ''ANULAR PEDIDO
                'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio AnularPedido_ChipRepuesto")
                'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "    IN " & " NroDocSap: " & strNroPedidoSAP)
                'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "    IN " & " ALMACEN: " & Session("ALMACEN"))
                'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "    IN " & " USUARIO: " & Session("USUARIO"))
                'Dim strCodAnulacion As String = AnularPedido(strNroPedidoSAP, Session("ALMACEN"), Session("USUARIO"))
                'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "    OUT " & " strCodAnulacion: " & strCodAnulacion)
                'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin AnularPedido_ChipRepuesto")
                'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "    " & " Session(VentaR): " & Session("VentaR"))
            Catch ex As Exception
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "    HORRORR!!: " & ex.Message.ToString())
            Finally
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Fin Anulacion venta Chip Repuesto")
                obAnular = Nothing
            End Try
            'Cancelar()
        End If
    End Sub

    Sub ActivaChipRespuestoPostPago(ByVal strNroPedidoSAP As String, ByVal dsPedido As DataSet)

        Dim strResultadoInsertaRepo As String

        Dim oReposicion As New COM_SIC_Activaciones.clsReposicion

        Dim strTrama As String = ""

        Dim i, j As Integer

        Dim strMSISDN As String
        Dim strICCID As String
        Dim strTipoDoc As String
        Dim strNroDoc As String
        Dim strTipoOfic As String
        Dim strEstado As String
        Dim strTipoOperacion As String
        Dim strFechaCP As String

        Dim strHTMLCuerpo As String

        Dim objFileLog As New SrvPago_Log
        Dim nameFile As String = ConfigurationSettings.AppSettings("constNameLogReposicionPostPago")
        Dim pathFile As String = ConfigurationSettings.AppSettings("constRutaLogCambioSIM")
        Dim strArchivo As String = objFileLog.Log_CrearNombreArchivo(nameFile)
        Dim strIdentifyLog As String = strNroPedidoSAP
        Dim strParametros As String = ""

        Dim strCurrentUser As String = CurrentUser
        Dim strCurrentTerminal As String = CurrentTerminal

        Dim strCodRpta As String
        Dim strMsgRpta As String

        'INI: INICIATIVA-219 | REPOSICION
        Dim objActivacionCBIO As New ClsActivacionCBIO
        Dim objEncolarCBIO As New BWEncolarTransaccionesCBIO
        Dim objReposicionRequest As New EncolarTransaccionRequest
        Dim objReposicionResponse As New EncolarTransaccionResponse
        Dim objAuditoriaWS As New AuditoriaEWS
        Dim strTipoOperacionEncCBIO As String = String.Empty
        Dim blnTransaccionCBIO As Boolean = False
        'FIN: INICIATIVA-219 | REPOSICION

        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " ------------------------------------")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inicio de Chip Repuesto Post Pago con Activacion 4G ")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " ------------------------------------")

        Try

            If Not IsNothing(dsPedido) Then

                strTipoDoc = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("CLIEC_TIPODOCCLIENTE"))
                strNroDoc = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("CLIEV_NRODOCCLIENTE"))
                strTipoOfic = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOOFICINA"))

                strEstado = Funciones.CheckStr(ConfigurationSettings.AppSettings("strEstadoEncolar"))
                strTipoOperacion = Funciones.CheckStr(ConfigurationSettings.AppSettings("strTipoOperacionEncolar"))
                strFechaCP = "00/00/0000"

                strTipoOperacionEncCBIO = Funciones.CheckStr(KeySettings.key_TipoOperacionReposicionCBIO) 'INICIATIVA-219
                objFileLog.Log_WriteLog(pathFile, strArchivo, "Tipo de operacion CBIO : " & strTipoOperacionEncCBIO) 'INICIATIVA-219

                objFileLog.Log_WriteLog(pathFile, strArchivo, "Tipo de Doc Cliente : " & strTipoDoc)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "Numero de Doc Cliente : " & strNroDoc)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "Tipo de Oficina : " & strTipoOfic)

                objFileLog.Log_WriteLog(pathFile, strArchivo, "Estado: " & strEstado)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "Tipo de Operacion : " & strTipoOperacion)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "Fecha CP: " & strFechaCP)


                If dsPedido.Tables(1).Rows.Count > 0 Then
                    If Funciones.CheckStr(dsPedido.Tables(0).Rows(j).Item("PEDIV_SISTEMAVENTA")) = ConfigurationSettings.AppSettings("strSistVentaChipRepuesto") Then
                        For j = 0 To dsPedido.Tables(1).Rows.Count - 1

                            strMSISDN = Funciones.CheckStr(dsPedido.Tables(1).Rows(j).Item("DEPEV_NROTELEFONO"))
                            strICCID = Funciones.CheckStr(dsPedido.Tables(1).Rows(j).Item("SERIC_CODSERIE"))

                            'INI INICIATIVA-219 | REPOSICION
                            Dim strCodResp = String.Empty
                            Dim strMsgResp = String.Empty

                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [{0} : {1}]", "Consulta origen linea", Funciones.CheckStr(strMSISDN)))

                            Dim arrListaNum As ArrayList = objActivacionCBIO.consultaTransaccion(strMSISDN, Funciones.CheckStr(ConfigurationSettings.AppSettings("strDTVReposicionChip")), strCodResp, strMsgResp)

                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [{0} : {1}]", "strCodResp", Funciones.CheckStr(strCodResp)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [{0} : {1}]", "strMsgResp", Funciones.CheckStr(strMsgResp)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [{0} : {1}]", "CarrListaPrepago", IIf(arrListaNum Is Nothing, "No Existe", arrListaNum.Count.ToString)))

                            If (arrListaNum Is Nothing Or arrListaNum.Count = 0) Then
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [{0} : {1}]", "Datos de Linea Nro", Funciones.CheckStr(j.ToString())))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [{0} : {1}]", "Numero de Telefono ", Funciones.CheckStr(strMSISDN)))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [{0} : {1}]", "Numero de Serie", Funciones.CheckStr(strICCID)))

                            If strTrama = "" Then
                                strTrama = strMSISDN & "_" & strTipoDoc & "_" & strNroDoc & "_" & strICCID & "_" & strTipoOfic & "_" & strEstado & "_" & strTipoOperacion & "_" & strFechaCP & "&"
                            Else
                                strTrama = strTrama & strMSISDN & "_" & strTipoDoc & "_" & strNroDoc & "_" & strICCID & "_" & strTipoOfic & "_" & strEstado & "_" & strTipoOperacion & "_" & strFechaCP & "&"
                            End If

                            Else
                                Dim item As COM_SIC_Activaciones.ItemGenerico = arrListaNum.Item(0)
                                objReposicionRequest.encolarTransaccionRequest.idNegocio = item.CODIGO
                                objReposicionRequest.encolarTransaccionRequest.idNegocioAux = Nothing
                                objReposicionRequest.encolarTransaccionRequest.tipoOperacion = strTipoOperacionEncCBIO '"11"
                                objReposicionRequest.encolarTransaccionRequest.nombreAplicacion = CheckStr(ConfigurationSettings.AppSettings("constAplicacion"))
                                objReposicionRequest.encolarTransaccionRequest.listaOpcional = Nothing 'No se usara

                                blnTransaccionCBIO = True

                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [blnTransaccionCBIO: {0}]", IIf(blnTransaccionCBIO, "SI", "NO")))

                            End If
                            'FIN INICIATIVA-219 | REPOSICION
                        Next

                        If strTrama.Length - strTrama.Replace("_", "").Length <= 8 Then
                            strTrama = strTrama & "_"
                        Else
                            strTrama = strTrama.Substring(0, strTrama.Length - 1)
                        End If

                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Trama con datos de la linea : " & strTrama)

                        'INICIO INICIATIVA-219 | REPOSICION
                        If blnTransaccionCBIO Then 'CBIO
                            objAuditoriaWS.IDTRANSACCION = Now.Year & Now.Month & Now.Day & Now.Hour & Now.Minute & Now.Second
                            objAuditoriaWS.msgId = Now.Year & Now.Month & Now.Day & Now.Hour & Now.Minute & Now.Second
                            objAuditoriaWS.userId = CurrentUser
                            objAuditoriaWS.timestamp = System.DateTime.Now.ToString("dd-MM-yyyy hh:mm:ss")
                            objReposicionRequest.encolarTransaccionRequest.listaOpcional = Nothing 'No se usara

                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [objReposicionRequest] - [{0} : {1}]", "strTipoOperacionEncCBIO", Funciones.CheckStr(strTipoOperacionEncCBIO)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [objReposicionRequest] - [{0} : {1}]", "IdNegocio", Funciones.CheckStr(objReposicionRequest.encolarTransaccionRequest.idNegocio)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [objReposicionRequest] - [{0} : {1}]", "IdNegocioAux", Funciones.CheckStr(objReposicionRequest.encolarTransaccionRequest.idNegocioAux)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [objReposicionRequest] - [{0} : {1}]", "nombreAplicacion", Funciones.CheckStr(ConfigurationSettings.AppSettings("constAplicacion"))))

                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [Parametros Header Request] [{0}] -  INI", "objAuditoriaWS"))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [objAuditoriaWS] - [{0} : {1}]", "IDTRANSACCION", Funciones.CheckStr(objAuditoriaWS.IDTRANSACCION)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [objAuditoriaWS] - [{0} : {1}]", "msgId", Funciones.CheckStr(objAuditoriaWS.msgId)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [objAuditoriaWS] - [{0} : {1}]", "userId", Funciones.CheckStr(objAuditoriaWS.userId)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [objAuditoriaWS] - [{0} : {1}]", "timestamp", Funciones.CheckStr(objAuditoriaWS.timestamp)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [Parametros Header Request] [{0}] -  FIN", "objAuditoriaWS"))

                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [URL : {0}]", Funciones.CheckStr(ConfigurationSettings.AppSettings("EncolarReposicionRest"))))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [Ejecutando: objEncolarCBIO.EncolarTransaccionCBIO()]"))

                            objReposicionResponse = objEncolarCBIO.EncolarTransaccionCBIO(objReposicionRequest, objAuditoriaWS)

                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [objEncolarResponse.encolarReposicionResponse.responseAudit.codigoRespuesta : {0}]", Funciones.CheckStr(objReposicionResponse.encolarReposicionResponse.responseAudit.codigoRespuesta)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [objEncolarResponse.encolarReposicionResponse.responseAudit.mensajeRespuesta : {0}]", Funciones.CheckStr(objReposicionResponse.encolarReposicionResponse.responseAudit.mensajeRespuesta)))
                        Else 'FIN INICIATIVA-219 | REPOSICION
                            If strTrama.Length > 0 Then 'BSCS
                                objFileLog.Log_WriteLog(pathFile, strArchivo, "Cantidad de Chip's a reponer AS IS : " & strTrama.Split("&").Length)
                        oReposicion.EncolarReposicion(strTrama, strNroPedidoSAP, strCurrentUser, strCurrentTerminal, strCodRpta, strMsgRpta)

                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Codigo de Respuesta de EncolarReposicion : " & strCodRpta)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Mensaje de Respuesta de EncolarReposicion : " & strMsgRpta)
                    End If
                End If
            End If
                End If
            End If

        Catch ex As Exception

            objFileLog.Log_WriteLog(pathFile, strArchivo, "Error con el servicio : " & ex.Message.ToString())

            Try
                'INI: INICIATIVA-219
                If blnTransaccionCBIO Then
                    Dim objBLDatosCBIO As New BLDatosCBIO
                    Dim detalleVenta As String = String.Empty
                    Dim strIdNegocio As String = objReposicionRequest.encolarTransaccionRequest.idNegocio
                    Dim strEstadoT As String = "-11"

                    detalleVenta = String.Format("{0},{1},{2},{3},{4},{5},{6},{7}", _
                    strIdNegocio, Nothing, strTipoOperacionEncCBIO, Funciones.CheckStr(CurrentUser), strEstadoT, Nothing, Nothing, Nothing)

                    objBLDatosCBIO.ActualizarTransaccionVentaCBIO(detalleVenta, strCodRpta, strMsgRpta)
                    strTrama = String.Empty
                Else 'FIN: INICIATIVA-219
                If strTrama <> "" Then
                    strResultadoInsertaRepo = oReposicion.RegistrarReposicion(strTrama, AppUsuario, strCodRpta, strMsgRpta)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Codigo de Respuesta de RegistrarReposicion : " & strCodRpta)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Mensaje de Respuesta de RegistrarReposicion : " & strMsgRpta)
                End If
                End If

            Catch ex2 As Exception
                objFileLog.Log_WriteLog(pathFile, strArchivo, "Error con el SP : " & ex2.Message.ToString())

                strHTMLCuerpo = "<HTML>"
                strHTMLCuerpo = strHTMLCuerpo & "<HEAD></HEAD><BODY><table>"
                strHTMLCuerpo = strHTMLCuerpo & "<tr><td>" & "Estimados," & "</tr></td>"
                strHTMLCuerpo = strHTMLCuerpo & "<tr><td></tr></td>"
                strHTMLCuerpo = strHTMLCuerpo & "<tr><td>" & ConfigurationSettings.AppSettings("strCuerpoMensajeReposicionDeta") & "</tr></td>"
                strHTMLCuerpo = strHTMLCuerpo & "<tr><td></tr></td>"

                For j = 0 To dsPedido.Tables(1).Rows.Count - 1
                    strHTMLCuerpo = strHTMLCuerpo & "<tr><td>" & Funciones.CheckStr(dsPedido.Tables(1).Rows(j).Item("DEPEV_NROTELEFONO")) & "</tr></td>"
                Next

                strHTMLCuerpo = strHTMLCuerpo & "<tr><td></tr></td>"
                strHTMLCuerpo = strHTMLCuerpo & "<tr><td>" & ConfigurationSettings.AppSettings("strCuerpoMensajeReposicionCabe") & "</tr></td>"
                strHTMLCuerpo = strHTMLCuerpo & "<tr><td></tr></td>"
                strHTMLCuerpo = strHTMLCuerpo & "<tr><td>" & strTrama & "</tr></td>"
                strHTMLCuerpo = strHTMLCuerpo & "</table></BODY></HTML>"

                oReposicion.EnviarDatosReposicion(ConfigurationSettings.AppSettings("strRemitenteReposicion"), _
                ConfigurationSettings.AppSettings("strDestinatariosReposicion"), _
                ConfigurationSettings.AppSettings("strAsuntoReposicion"), _
                strHTMLCuerpo, _
                ConfigurationSettings.AppSettings("strFlagCorreoReposicion"), strNroPedidoSAP, strCurrentUser, strCurrentTerminal, strCodRpta, strMsgRpta)

                objFileLog.Log_WriteLog(pathFile, strArchivo, "Codigo de Respuesta de EnviarDatosReposicion : " & strCodRpta)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "Mensaje de Respuesta de EnviarDatosReposicion : " & strMsgRpta)

            End Try

        End Try

    End Sub

    Function ValorResultCHIP(ByVal strNombreCampo As String, ByVal arrResulFilCHIPNomb() As String, ByVal arrResulFilCHIPValor() As String)
        Dim i
        For i = 0 To UBound(arrResulFilCHIPNomb)
            If arrResulFilCHIPNomb(i) = strNombreCampo Then
                ValorResultCHIP = arrResulFilCHIPValor(i)
                Exit For
            End If
        Next
        If Trim(ValorResultCHIP) = "" Then
            ValorResultCHIP = "X000X"
        End If
    End Function

    '** ENTRA AQUI PARA LOS PROCESOS DE RECARGAS VIRTUALES **'
    '** EL PARAMETRO strNumAsignado, NO ES USADO. **'
    Private Sub Recarga(ByVal Tipo_oficina As String)
        Dim pvTerminalID As String
        Dim pvTrace As String
        Dim pvCanal As String
        Dim pvTelefono As String
        Dim pvBinAdquiriente As String
        Dim pvCodCadena As String
        Dim pvCodComercio As String
        Dim pvMonto As String
        Dim pvMoneda As String
        Dim pvProducto As String

        Dim strVendedor As String
        Dim strTrama As String
        Dim arrTrama() As String
        Dim strMensaje As String

        'Dim dsRecarga As DataSet

        Dim strSaldo As String
        Dim strvalorrecarga As String
        Dim pvNumRecarga As String
        Dim strRecarga As String
        Dim strvalorventa As String
        Dim strvalordescuento As String
        Dim strvalorsubtotal As String
        Dim strvalorigv As String
        Dim strvalortotal As String
        Dim strnumerodocumentoautorizado As String
        Dim i As Integer

        Dim objRVirt As New COM_SIC_RVirtual.clsRVirtual

        Dim objFileLog As New SrvPago_Log
        Dim nameFile As String = ConfigurationSettings.AppSettings("constNameLogRecarga")
        Dim pathFile As String = ConfigurationSettings.AppSettings("constRutaLogRecarga")
        Dim strArchivo As String = objFileLog.Log_CrearNombreArchivo(nameFile)
        Dim strIdentifyLog As String = String.Format("--[{0}]--", numeroOperacion)

        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "-----Inicio Get_ConsultaVendedorRecarga -----")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "IN" & "ALMACEN:" & AppAlmacen)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "IN" & "Canal: " & AppCanal)

        'strVendedor = objVentas.Get_ConsultaVendedorRecarga(Session("ALMACEN"), Session("CANAL"))

        strVendedor = System.Configuration.ConfigurationSettings.AppSettings("CODIGO_CADENA")   '** VALOR : 6207001 **'

        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "OUT" & "strVendedor: " & strVendedor)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "-----Fin Get_ConsultaVendedorRecarga -----")

        If Len(strVendedor) = 0 Then
            'Response.Write("<script>alert('Error: Se debe configurar el codigo de tienda para realizar recargas.')</script>")
            blnError = True
        Else
            pvBinAdquiriente = Mid(strVendedor, 4, 6)
            pvCodCadena = Mid(strVendedor, 4, 7)
            'pvCodComercio = Session("ALMACEN")
            pvCodComercio = AppAlmacen

            pvTerminalID = "PVU"
            'pvTrace = Right(drPagos.Item("VBELN"), 6)
            pvTrace = Right("00" & Now().Second, 2) + Right("0000" & CDbl(AppUsuario) * Now().Millisecond(), 4)
            pvCanal = "91"

            pvMoneda = "604"
            pvProducto = System.Configuration.ConfigurationSettings.AppSettings("COD_PRODUCTO_RV") 'IDEA-141711 - Pack Internet Móvil Prepago
            'dsRecarga = objPagos.Get_ConsultaDetalleRVirtual(pvTrace, Session("ALMACEN"))

            'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "-----Inicio Get_ConsultaDetalleRVirtual (ZPVU_RFC_CON_TELEF_FACTURA) -----")
            'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     IN" & " VBELN:" & drPagos.Item("VBELN") & " ALMACEN: " & Session("ALMACEN"))

            'dsRecarga = objPagos.Get_ConsultaDetalleRVirtual(drPagos.Item("VBELN"), Session("ALMACEN"))

            'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     OUT" & " Cantidad de filas devueltas " & dsRecarga.Tables(0).Rows.Count.ToString())
            'INICIO - IDEA-141711 - Pack Internet Móvil Prepago
            Dim pvDatosUsuario As String = "01"
            'FIN - IDEA-141711 - Pack Internet Móvil Prepago
            AppstrMensajeCajaRec = ""

            If Not IsNothing(ApprecargaVirtual) Then
                Dim isRecargaVirtual As Boolean = ApprecargaVirtual
                'INICIO - IDEA-141711 - Pack Internet Móvil Prepago
                Dim isPaqueteAdicional As Boolean = ApppaqueteAdicional
                If isRecargaVirtual Then
                    Dim REC_EFECTIVA$ = montoRecarga 'txtNeto.Text
                    Dim NRO_REC_SWITCH$ = ""
                    Dim POSNR$ = "0"
                    If isPaqueteAdicional Then
                        Dim strNroPedido As String = Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO"))
                        RecargaPaquete(pvTerminalID, pvTrace, pvCanal, pvMoneda, pvBinAdquiriente, pvCodCadena, pvCodComercio, strNroPedido)
                    Else
                        pvTelefono = hidNumeroTelefono '' Session("numeroTelefono")
                        pvMonto = REC_EFECTIVA$

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     OUT pvTelefono " & pvTelefono.ToString())
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     OUT pvMonto " & pvMonto.ToString())
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     OUT NRO_REC_SWITCH " & Trim(NRO_REC_SWITCH))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "-----FIN Get_ConsultaDetalleRVirtual -----")

                        'If Trim(dsRecarga.Tables(0).Rows(0).Item("NRO_REC_SWITCH")) = "" Then

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "-----Incio RecargaST -----")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " inp ALMACEN: " & AppAlmacen)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " inp pvTerminalID: " & pvTerminalID)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " inp pvCanal: " & pvCanal)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " inp pvTelefono: " & pvTelefono)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " inp pvMonto: " & pvMonto)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " inp pvMoneda: " & pvMoneda)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " inp pvProducto: " & pvProducto)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " inp pvBinAdquiriente: " & pvBinAdquiriente)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " inp pvCodCadena: " & pvCodCadena)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " inp pvCodComercio: " & pvCodComercio)

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " Fecha Inicio Invocacion ST: " & DateTime.Now)
                        strTrama = objRVirt.Recarga(AppAlmacen, pvTerminalID, pvTrace, pvCanal, pvTelefono, pvMonto, pvMoneda, pvProducto, pvBinAdquiriente, pvCodCadena, pvCodComercio, pvDatosUsuario)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " Fecha Fin Invocacion ST: " & DateTime.Now)
                        'TODO: AQUI HACE LA RECARGA VIRTUAL

                        arrTrama = Split(strTrama, ";")
                        strSaldo = Decimales(arrTrama(4))
                        strnumerodocumentoautorizado = arrTrama(7)
                        strvalorrecarga = arrTrama(13)
                        strvalorventa = arrTrama(9)
                        strvalordescuento = arrTrama(10)
                        strvalorsubtotal = arrTrama(11)
                        strvalorigv = arrTrama(12)
                        strvalortotal = arrTrama(13)

                        pvNumRecarga = Trim(arrTrama(6))
                        AppfechaTransaccionOriginal = arrTrama(14)
                        AppTraceRecarga = arrTrama(15)

                        numeroOperacionST = pvNumRecarga

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " out pvNumRecarga: " & pvNumRecarga)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " out trama " & " strSaldo: " & strSaldo & " strnumerodocumentoautorizado: " & strnumerodocumentoautorizado & " strvalorrecarga: " & strvalorrecarga & " strvalorventa: " & strvalorventa & " strvalordescuento: " & strvalordescuento & " strvalorsubtotal : " & strvalorsubtotal & " strvalorigv: " & strvalorigv & " strvalortotal: " & strvalortotal)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "-----Fin RecargaST -----")
                        'CDbl(Trim(arrTrama(0))) < 0    

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - Validamos si la recarga presenta errores en el servicio.")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - Valor de la Trama arrTrama(2): " & arrTrama(2).ToString)
                        If arrTrama(2) <> 0 Then               '** Linea Origina **'
                            'If arrTrama(2) <> "5" Then             '** Linea Pruebas **'
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - El valor de la trama arrTrama(2) retornado no es el correcto.Se procedera Anular el Pedido de Recarga Virtual.")
                            strMensaje = "Error: No se puede realizar el servicio de recarga virtual. Motivo: " & arrTrama(3)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " trama " & " strMensaje " & strMensaje & " arrTrama(3) " & arrTrama(3).ToString())
                            If Trim(arrTrama(3)) = "" Then
                                strMensaje = "NO SE PUEDEN REALIZAR OPERACIONES DE RECARGA VIRTUAL EN ESTE MOMENTO. Se procedera Anular el Pedido de Recarga Virtual."
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " trama " & " strMensaje " & strMensaje & " arrTrama(3) " & arrTrama(3).ToString())
                            End If
                            AppstrMensajeCajaRec = strMensaje & " Se procedera Anular el Pedido de Recarga Virtual. "

                            Dim obAnular As New COM_SIC_Activaciones.clsTrsMsSap
                            Dim strVias() As String = {""}
                            Dim strFecha As String = Format(Day(Now), "00") & "/" & Format(Month(Now), "00") & "/" & Format(Year(Now), "0000")

                            'ANULAR PAGO RECARGA
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Inicio Anular Pedido - SP: SSAPSU_ANULARPEDIDO")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "IN Nro Pedido: " & drPagos.Item("PEDIN_NROPEDIDO"))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "IN Motivo: " & ConfigurationSettings.AppSettings("Motivo_Anulacion"))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "IN Estado: " & ConfigurationSettings.AppSettings("Estado_Anulacion"))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "IN Tipo de Oficina: " & Tipo_oficina)

                            obAnular.AnularPedido(drPagos.Item("PEDIN_NROPEDIDO"), ConfigurationSettings.AppSettings("Motivo_Anulacion"), ConfigurationSettings.AppSettings("Estado_Anulacion"), Tipo_oficina)

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "FIN Anular Pedido - SP: SSAPSU_ANULARPEDIDO")

                            'ANULA PEDIDO DE RECARGA
                            'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio AnularPedidoRV")
                            'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " IN " & " NroDocSap " & drPagos.Item("PEDIN_NROPEDIDO"))
                            'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " IN " & " ALMACEN " & Session("ALMACEN"))
                            'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " IN " & " USUARIO " & Session("USUARIO"))
                            'Dim strCodAnulacion As String = AnularPedido(drPagos.Item("PEDIN_NROPEDIDO"), Session("ALMACEN"), Session("USUARIO"))
                            ''objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " OUT " & " strCodAnulacion " & strCodAnulacion)
                            'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " OUT " & " strMensajeCajaRec " & Session("strMensajeCajaRec"))
                            'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin AnularPedidoRV")

                            Dim objOffline As New COM_SIC_OffLine.clsOffline
                            Try
                                objOffline.SetErrorRecarga(numeroOperacion)
                            Catch ex As Exception
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & ex.Message & " - " & ex.StackTrace)
                            End Try

                            AppnumeroTelefono = Nothing
                            AppnumeroOperacionSAP = Nothing
                            ApprecargaVirtual = Nothing
                            AppDocSel = Nothing
                            Cancelar()
                        Else
                            strMensaje = "La recarga se realizó satisfactoriamente. \n"
                            strMensaje = strMensaje & "Nro Teléfono          :  " & pvTelefono & " \n"
                            strMensaje = strMensaje & "Importe Recargado: S/ " & strvalorrecarga & " \n"
                            strMensaje = strMensaje & "Nuevo Saldo           : S/ " & strSaldo & " \n"
                            strMensaje = strMensaje & "Nro. Recarga          :  " & pvNumRecarga
                            '/*----------------------------------------------------------------------------------------------------------------*/
                            '/*--JR  INICIO  -  PROY-29380 IDEA-38934 - Iteración 2 y 3 2da Fase Sinergia Adec en Sist de Venta y Post-Venta --*/
                            '/*----------------------------------------------------------------------------------------------------------------*/
                            'Llamamos al Servicio BSS_RecargaVirtual para actualizar el estado de la Recarga Virtual a PAGADO
                            'Iniciamos la actualizacion de la recarga virtual en la tabla  SICAT_RECARGA_VIRTUAL_TRX. mediante el WS: BSS_RECARGAVIRTUAL.ActualizarRecarga.

                            Dim estadoRegistrarRecargaVirtual As Boolean

                            estadoRegistrarRecargaVirtual = ActualizarRecargaVirtual(strIdentifyLog, AppCanal, AppUsuario, pvTelefono, strTrama)

                            If estadoRegistrarRecargaVirtual = True Then
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " Se Actualizo la Recarga Virtual correctamente")
                            Else
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " Ocurrio un ERROR en la actualizacion de la Recarga Virtual")
                            End If
                            '/*----------------------------------------------------------------------------------------------------------------*/
                            '/*--JR  FIN     -  PROY-29380 IDEA-38934 - Iteración 2 y 3 2da Fase Sinergia Adec en Sist de Venta y Post-Venta --*/
                            '/*----------------------------------------------------------------------------------------------------------------*/
                        End If

                        AppstrMensajeCajaRec = strMensaje

                        strRecarga = drPagos.Item("PEDIN_NROPEDIDO") & ";" & POSNR         'drPagos.Item("PEDIN_NROPEDIDO")
                        strRecarga = strRecarga & ";" & AppAlmacen & ";" & pvTelefono & ";" & strvalorrecarga
                        strRecarga = strRecarga & ";" & strvalorventa & ";" & strvalordescuento
                        strRecarga = strRecarga & ";" & strvalorigv & ";" & strvalortotal & ";" & pvNumRecarga
                    End If
                    'FIN - IDEA-141711 - Pack Internet Móvil Prepago
                End If
            End If
        End If
    End Sub



    Private Sub Cancelar()

        AppnumeroTelefono = Nothing
        AppnumeroOperacionSAP = Nothing
        ApprecargaVirtual = Nothing
        AppDocSel = Nothing

        If AppVentaR = "1" Then
            AppVentaR = ""
            'Response.Redirect("Terminar.aspx", False)
            'Response.End()
            'Context.ApplicationInstance.CompleteRequest()
            'Return
            Exit Sub
        Else
            AppFechaPago = String.Format("{0:dd/MM/yyyy}", DateTime.Now)
            'Response.Redirect("PoolPagos.aspx", False)
            'Response.End()
            'Context.ApplicationInstance.CompleteRequest()
            'Return
            Exit Sub
        End If
    End Sub

    Private Function Decimales(ByVal valor)
        If Trim(valor) <> "" Then
            If CDbl(Trim(valor)) <> 0 Then
                Decimales = Left(valor, Len(valor) - 2) & "." & Mid(valor, Len(valor) - 1, 2)
            Else
                Decimales = "0.00"
            End If
        Else
            Decimales = "0.00"
        End If
    End Function


    'Private Sub LeeDatosValidar()
    '    '***************LEE TARJETAS CREDITO
    '    'Dim objSap As New SAP_SIC_Pagos.clsPagos
    '    'Dim dsTmp As DataSet = objSap.Get_Tarjeta_Credito() ''TODO: CALLBACK SAP
    '    ''TODO: CAMBIADO POR JYMMY TORRES
    '    Dim dsTmp As DataSet = (New COM_SIC_OffLine.clsOffline).Get_Tarjeta_Credito
    '    Dim dr As DataRow
    '    txtTarjCred.Text = ""
    '    For Each dr In dsTmp.Tables(0).Rows
    '        txtTarjCred.Text += CStr(dr(0)) + ";"
    '    Next

    '    '*************leee BIN
    '    Dim obCajas As New COM_SIC_Cajas.clsCajas
    '    dsTmp = obCajas.FP_ListaBIN()

    '    txtBIN.Text = ""
    '    For Each dr In dsTmp.Tables(0).Rows
    '        txtBIN.Text += CStr(dr(0)) + ";"
    '    Next

    'End Sub

    'Private Sub UploadArchivo(ByVal sDocSap As String, ByVal sArchivo As String)
    '    'Dim user As String = HttpContext.Current.User.Identity.Name
    '    'Dim user2 As String = System.Security.Principal.WindowsIdentity.GetCurrent.Name
    '    'Dim impersonationContext As System.Security.Principal.WindowsImpersonationContext
    '    'Dim currentWindowsIdentity As System.Security.Principal.WindowsIdentity

    '    'currentWindowsIdentity = CType(HttpContext.Current.User.Identity, System.Security.Principal.WindowsIdentity)
    '    'impersonationContext = currentWindowsIdentity.Impersonate()

    '    If Path.GetFileName(sArchivo).ToString <> "" Then
    '        'Constante con la ruta: \\fileserver1\intradoc\SICAR
    '        Dim sPath As String = ConfigurationSettings.AppSettings("k_gStrRutaUploadDoc")
    '        'Dim sPath As String = Server.MapPath("~/Upload")

    '        'Se verifica la existencia del archivo local
    '        Dim dir As DirectoryInfo = New DirectoryInfo(sPath)
    '        'Dim files As FileInfo() = dir.GetFiles()

    '        'Dim count As Integer = files.Length
    '        'Dim i As Integer
    '        If (File.Exists(sPath & "\" & Path.GetFileName(sArchivo))) Then
    '            Response.Write("<script language='javascript'>alert('Este archivo ya existe')</script>")
    '            Exit Sub
    '        End If

    '        'Concatenando la ruta y el nuevo nombre del archivo
    '        Dim Destino As String = sPath & "\" & AppAlmacen & "_" & Date.Now.ToString("yyyyMMdd") & "_" & sDocSap & Path.GetExtension(sArchivo)

    '        ' Haciendo Upload del Archivo
    '        txtFile.PostedFile.SaveAs(Destino)

    '        'impersonationContext.Undo()

    '        lblArchivo.Style.Item("display") = ""
    '        lblArchivo.Text = CStr(AppAlmacen & "_" & Date.Now.ToString("yyyyMMdd") & "_" & sDocSap & Path.GetExtension(sArchivo))
    '        btnCargarDocumento.Style.Item("display") = "none"
    '        Session("Carga") = 1
    '        'Return True
    '    Else
    '        Session("Carga") = 0
    '        Response.Write("<script language='javascript'>alert('Debe elegir un archivo')</script>")
    '        'Return False
    '        'impersonationContext.Undo()
    '    End If
    'End Sub

   

    'Private Sub UploadArchivo2(ByVal sDocSap As String, ByVal sArchivo As String)

    '    'Dim impersonationContext As System.Security.Principal.WindowsImpersonationContext
    '    'Dim currentWindowsIdentity As System.Security.Principal.WindowsIdentity

    '    ''currentWindowsIdentity = CType(HttpContext.Current.User.Identity, System.Security.Principal.WindowsIdentity)
    '    'currentWindowsIdentity = CType(HttpContext.Current.User.Identity, System.Security.Principal.WindowsIdentity)
    '    'impersonationContext = currentWindowsIdentity.Impersonate()

    '    If Path.GetFileName(sArchivo).ToString <> "" Then
    '        'Constante con la ruta: \\fileserver1\intradoc\SICAR
    '        Dim RequestXForm As Object
    '        Dim objFile As Object
    '        Dim valor As String = "1"
    '        Dim sPath As String = ConfigurationSettings.AppSettings("k_gStrRutaUploadDoc")

    '        If valor = ConfigurationSettings.AppSettings("Flag_Carga_Docu") Then
    '            RequestXForm = CreateObject("ABCUpload4.XForm")
    '            RequestXForm.MaxUploadSize = 138860800
    '            RequestXForm.AbsolutePath = True
    '            RequestXForm.Overwrite = True

    '            'Comentado para que cargue el documento

    '            objFile = RequestXForm("txtFile")(1)
    '            If (objFile.rawFileName <> "") Then
    '                sArchivo = objFile.rawFileName
    '            End If
    '        End If



    '        'Concatenando la ruta y el nuevo nombre del archivo
    '        Dim Destino As String = sPath & "\" & AppAlmacen & "_" & CStr(Date.Now.ToString("yyyyMMdd")) & "_" & sDocSap & Path.GetExtension(sArchivo)

    '        'Grabamos el archivo en el origen

    '        'Comentado para que cargue el documento

    '        If valor = ConfigurationSettings.AppSettings("Flag_Carga_Docu") Then
    '            objFile.Save(Destino)
    '        End If

    '        'impersonationContext.Undo()

    '        lblArchivo.Style.Item("display") = ""
    '        lblArchivo.Text = CStr(AppAlmacen & "_" & Date.Now.ToString("yyyyMMdd") & "_" & sDocSap & Path.GetExtension(sArchivo))
    '        btnCargarDocumento.Style.Item("display") = "none"
    '        Session("Carga") = 1
    '        'Return True
    '    Else
    '        Session("Carga") = 0
    '        Response.Write("<script language='javascript'>alert('Debe elegir un archivo')</script>")
    '        'Return False
    '    End If
    '    'hidFlagCargaDoc.Value = Session("Carga")
    '    hidFlagCargaDocDOL.Value = Session("Carga")
    'End Sub

    'Private Sub UploadArchivo3(ByVal sDocSap As String, ByVal sArchivo As String)

    '    Dim lObjDocumento As Object
    '    Dim objDocumento As Object
    '    Dim lstrRutaOrigen, lstrNombreOrigen, lstrRutaDestino, lstrNombreDestino As String
    '    Dim blnExisteArchivo As Boolean = False
    '    Dim blnGrabarArchivo As Boolean = False

    '    Dim sPath As String = ConfigurationSettings.AppSettings("k_gStrRutaUploadDoc")

    '    objDocumento = CreateObject("Documento_Util.clsUtilitario")
    '    Dim impersonationContext As System.Security.Principal.WindowsImpersonationContext
    '    Dim currentWindowsIdentity As System.Security.Principal.WindowsIdentity

    '    currentWindowsIdentity = CType(HttpContext.Current.User.Identity, System.Security.Principal.WindowsIdentity)
    '    impersonationContext = currentWindowsIdentity.Impersonate()

    '    blnExisteArchivo = objDocumento.FP_existeArchivo(sPath & Path.GetFileName(sArchivo))

    '    If Not blnExisteArchivo Then
    '        lstrRutaOrigen = Path.GetDirectoryName(sArchivo)
    '        lstrNombreOrigen = Path.GetFileName(sArchivo)
    '        lstrRutaDestino = sPath
    '        lstrNombreDestino = AppAlmacen & "_" & Date.Now.ToString("yyyyMMdd") & "_" & sDocSap & Path.GetExtension(sArchivo)
    '        blnGrabarArchivo = objDocumento.FP_CopiaArchivo(CStr(lstrNombreOrigen), CStr(lstrNombreDestino), "", lstrRutaOrigen, lstrRutaDestino)
    '    End If
    '    objDocumento = Nothing

    '    Response.Write("<script language='javascript'>alert('" & blnGrabarArchivo.ToString & "')</script>")    'Si es TRUE grabo correctamente

    '    If blnGrabarArchivo.ToString = "true" Then
    '        Session("Carga") = 1
    '    Else
    '        Session("Carga") = 0
    '    End If

    'End Sub

    Function FormatoTelefono(ByVal telefono)
        Dim aux
        aux = telefono
        If aux <> "" Then
            Dim longitud
            Dim posicion
            longitud = Len(telefono)
            If longitud > 0 Then
                'posicion = 1
                Do While InStr(1, aux, "0") = 1
                    aux = Mid(aux, 2, Len(aux))
                Loop
            End If
            If InStr(1, aux, "1") = 1 Then    'Si es lima adicionar 0 adelante
                aux = "0" & aux
            End If
        End If
        If aux = "" Then
            FormatoTelefono = telefono
        Else
            FormatoTelefono = aux
        End If
    End Function

    Private Sub ActualizaPago(ByVal strNroPedido As String)

        Dim intResultado As Integer
        Dim resultado As Integer
        Dim objCajas As New COM_SIC_Cajas.clsCajas

        If Not strNroPedido.Trim = "" Then
            resultado = objCajas.ActualizaPago(strNroPedido, 1, intResultado)
        End If

    End Sub

    Function FormatoTelefonoPrepago(ByVal telefono)
        Dim aux
        aux = telefono
        If aux <> "" Then
            Dim longitud
            Dim posicion
            longitud = Len(telefono)
            If longitud > 0 Then
                'posicion = 1
                Do While InStr(1, aux, "0") = 1
                    aux = Mid(aux, 2, Len(aux))
                Loop
            End If
        End If
        If aux = "" Then
            FormatoTelefonoPrepago = telefono
        Else
            FormatoTelefonoPrepago = aux
        End If
    End Function

    Private Function DatosInteraccion() As Interaccion

        Dim oInteraccion As New Interaccion

        oInteraccion.TIPO_INTER = ConfigurationSettings.AppSettings("TIPO_INTER_DEFAULT")
        oInteraccion.METODO = ConfigurationSettings.AppSettings("METODO_DEFAULT")
        oInteraccion.USUARIO_PROCESO = ConfigurationSettings.AppSettings("USR_PROCESO")
        oInteraccion.HECHO_EN_UNO = ConfigurationSettings.AppSettings("ECHO_UNO_DEFAULT")
        oInteraccion.FLAG_CASO = ConfigurationSettings.AppSettings("FLAG_CASO_DEFAULT")
        oInteraccion.RESULTADO = ConfigurationSettings.AppSettings("RESULTADO_DEFAULT")

        Return oInteraccion
    End Function

    Private Function ValidaCadena(ByVal cadena As String) As String
        Dim strNew As String = ""
        If Trim(cadena) <> "" Then
            For i As Int32 = 0 To cadena.Length - 1
                If cadena.Chars(i) <> "'" Then
                    strNew = strNew + cadena.Chars(i)
                End If
            Next
        End If
        Return strNew
    End Function

    'Private Sub UploadArchivoDNI(ByVal sDocSap As String, ByVal sArchivo As String)

    '    Dim dsPedido As New DataSet
    '    Dim valor As String = "1"

    '    Try
    '        'dsPedido = objPagos.Get_ConsultaPedido("", Session("ALMACEN"), drPagos.Item("VBELN"), "")
    '        dsPedido = objConsultaMsSap.ConsultaPedido(sDocSap, "", "")
    '        Session("arrNombArchivos") = Nothing

    '        If Not Trim(Path.GetFileName(sArchivo).ToString) = "" Then

    '            Dim RequestXForm As Object
    '            Dim objFile As Object

    '            ' Se almacena en el Servidor Temporalmente
    '            Dim sPath As String = ConfigurationSettings.AppSettings("strRutaOrigenDOL")

    '            objFileLog.Log_WriteLog(pathFile, strArchivo, "UPLOAD ARCHIVO DNI Metodo : UploadArchivoDNI")
    '            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("     -sDocSap: {0}", sDocSap))
    '            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("     -sArchivo: {0}", sArchivo))
    '            objFileLog.Log_WriteLog(pathFile, strArchivo, "     -CREANDO OBJETO ABCUpload4.XForm.4")
    '            If valor = ConfigurationSettings.AppSettings("Flag_Carga_Docu") Then
    '                RequestXForm = CreateObject("ABCUpload4.XForm.4")
    '                RequestXForm.MaxUploadSize = 138860800
    '                RequestXForm.AbsolutePath = True
    '                RequestXForm.Overwrite = True

    '                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("     -RequestXForm.User : {0}", RequestXForm.User))

    '                objFile = RequestXForm("txtFile")(1)
    '                If (objFile.rawFileName <> "") Then
    '                    sArchivo = objFile.rawFileName
    '                End If
    '            End If


    '            'Concatenando la ruta y el nuevo nombre del archivo
    '            Dim Destino As String
    '            Dim strCodArticulo As String
    '            Dim arrayArchivo() As String
    '            Dim strListaArchivo As String = ""
    '            Dim strNombreArchivo As String = ""

    '            For i As Integer = 0 To dsPedido.Tables(1).Rows.Count - 1
    '                'strCodArticulo = dsPedido.Tables(1).Rows(i).Item("DEPEC_CODMATERIAL")
    '                strCodArticulo = dsPedido.Tables(1).Rows(i).Item("MATEC_TIPOMATERIAL")

    '                '
    '                'If strCodArticulo.Substring(0, 2) = "PS" Then
    '                'PROY-24388 INICIO RAR 
    '                If strCodArticulo.ToString.Trim = ConfigurationSettings.AppSettings("constChips") Then
    '                    strNombreArchivo = CStr(Date.Now.ToString("yyyyMMddHHmmss")) & "_"
    '                    strNombreArchivo += Funciones.CheckStr(dsPedido.Tables(1).Rows(i).Item("SERIC_CODSERIE")) & Path.GetExtension(sArchivo)

    '                    Destino = sPath & "\" & strNombreArchivo
    '                    strListaArchivo += Funciones.CheckStr(dsPedido.Tables(1).Rows(i).Item("SERIC_CODSERIE")) & "|" & strNombreArchivo & ";"

    '                    'Grabamos el archivo en el origen

    '                    'Linea comentada para que se pueda adjuntar documentos
    '                    If valor = ConfigurationSettings.AppSettings("Flag_Carga_Docu") Then
    '                        objFile.Save(Destino)
    '                    End If
    '                End If
    '                'PROY-24388 INICIO RAR
    '            Next

    '            ' Alcenamos en Sesion la Lista de Archivos Almacenados
    '            If strListaArchivo <> "" Then
    '                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("     -RstrListaArchivo : {0}", strListaArchivo))
    '                arrayArchivo = Split(strListaArchivo, ";")
    '                Session("arrNombArchivos") = arrayArchivo

    '                lblArchivoDOL.Style.Item("display") = ""
    '                imgElimDoc.Visible = True
    '                lblArchivoDOL.Text = Path.GetFileName(sArchivo).ToString
    '                btnCargarDocumento.Style.Item("display") = "none"
    '                Session("Carga") = 1
    '                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("     Session('Carga') : {0}", Session("Carga")))
    '                objFileLog.Log_WriteLog(pathFile, strArchivo, "FIN UPLOAD ARCHIVO DNI Metodo : UploadArchivoDNI")
    '            End If

    '            dsPedido = Nothing
    '        Else
    '            Session("Carga") = 0
    '            Response.Write("<script language='javascript'>alert('Debe elegir un archivo.')</script>")
    '        End If

    '        hidFlagCargaDocDOL.Value = Session("Carga")
    '    Catch ex As Exception
    '        dsPedido = Nothing
    '        objFileLog.Log_WriteLog(pathFile, strArchivo, "     -ERROR UPLOAD ARCHIVO DNI Metodo : UploadArchivoDNI")
    '        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("     -Descripcion error: {0}", ex.Message))
    '        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("     -Trace error: {0}", ex.StackTrace))
    '        objFileLog.Log_WriteLog(pathFile, strArchivo, "FIN ANOMALO UPLOAD ARCHIVO DNI Metodo : UploadArchivoDNI")
    '    End Try

    'End Sub


    Private Function UploadArchivoFTP(ByVal rutaOrigen As String, ByVal nombreArchivo As String, ByVal rutaDestino As String) As String

        Dim strMensaje As String = ""

        Try
            Dim pRutaArchivoOrigen As String
            Dim pRutaArchivoDestino As String
            Dim objFileFTP As New ControlProxyFTP

            pRutaArchivoOrigen = rutaOrigen & "\" & nombreArchivo
            pRutaArchivoDestino = rutaDestino & "/" & nombreArchivo
            objFileFTP.PutFileFTP(pRutaArchivoOrigen, pRutaArchivoDestino)

        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, "ERROR UploadArchivoFTP: " & ex.Message.ToString())
            objFileLog.Log_WriteLog(pathFile, strArchivo, "ERROR UploadArchivoFTP: " & ex.StackTrace.ToString())
            strMensaje = ex.Message()
        End Try

        Return strMensaje

    End Function

    Private Function CreateDirectorioFTP(ByVal rutaDestino As String, ByVal directorio As String) As String

        Dim strMensaje As String = ""

        Try
            Dim objFileFTP As New ControlProxyFTP
            Dim pRutaDirectorio As String = rutaDestino & "/" & directorio
            objFileFTP.CreateDirFTP(pRutaDirectorio)

        Catch ex As Exception
            strMensaje = ex.Message()
        End Try

        Return strMensaje

    End Function

    Dim oBusExpress As New ClsActivacionPel
    Dim oCajasDol As New clsCajas

    Private Sub Grabar_Cobertura(ByVal nroPedido As String, ByVal strProceso As String)
        Dim dsPedido As DataSet
        Dim objFileLog As New SrvPago_Log
        Dim nameFile As String = ConfigurationSettings.AppSettings("constNameLogDetalleDOL")
        Dim pathFile As String = ConfigurationSettings.AppSettings("constRutaLogRegistroDOL")
        Dim strArchivo As String = objFileLog.Log_CrearNombreArchivo(nameFile)
        Dim strIdentifyLog As String = nroPedido
        Dim strParametros As String = ""
        Dim sDocumentoSap As String = ""
        Dim strOficina As String = ""
        Dim strCodigoResp As String = ""
        Dim strOpcion As String = ""
        Dim strChipPack As String = ""
        Dim strCar1 As String = ""
        Dim strCar5 As String = ""
        Dim strCar6 As String = ""
        Dim strTrace As String = ""
        Dim strFechaHora As String
        Dim strServicioAdicional5 As String = ""
        Dim strOperacionClaro As String
        Dim strEstadoActivacion As String
        Dim strCodigoRespuesta As String
        Dim strDescripcionRespuesta As String
        Dim strTipoProducto As String
        Dim strTipoPreActivacion As String
        Dim strTipoActivacion As String
        Dim strComando As String = ""
        sDocumentoSap = nroPedido
        Dim strDepartamentoCobertura As String = ""
        Dim strProvinciaCobertura As String = ""
        Dim strDisitritoCobertura As String = ""
        Dim strCentroPobladoCobertura As String = ""
        Dim strValorCobertura As String = ""
        Dim strUsuarioCobertura As String = ""
        Dim intCodRespCobertura As Integer
        Dim lineapvu As String = ""
        strIdentifyLog = sDocumentoSap

        Dim lista As ArrayList = oBusExpress.Lis_Lista_Detalle_Venta_Prepago(sDocumentoSap, strCodigoResp)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio array en DetalleVentaPrepago " & strProceso)
        For Each item As DetalleVentaPrepago In lista

            Try
                strDepartamentoCobertura = item.DEPAC_DESC
                strProvinciaCobertura = item.PROVV_DESC
                strDisitritoCobertura = item.DISTV_DESC
                strCentroPobladoCobertura = item.CPF_DESC
                strUsuarioCobertura = item.USUARIO
                lineapvu = item.LINEA

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "lineapvu: " & lineapvu)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "item.DEPAC_DESC: " & item.DEPAC_DESC)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "item.PROVV_DESC: " & item.PROVV_DESC)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "item.DISTV_DESC: " & item.DISTV_DESC)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "item.CPF_DESC: " & item.CPF_DESC)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "item.USUARIO: " & item.USUARIO)

                If item.CPF_DESC <> ConfigurationSettings.AppSettings("consSinCobertura") Then
                    strValorCobertura = "SI"
                Else
                    strValorCobertura = "NO"
                End If

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "strValorCobertura: " & strValorCobertura)

                Dim RespuestaCobertura As String = oCajasDol.RegistroLineaCobertura(Right(lineapvu, 9), _
                                                                                    strDepartamentoCobertura, strProvinciaCobertura, _
                                                                                    strDisitritoCobertura, strCentroPobladoCobertura, _
                                                                                    strValorCobertura, strUsuarioCobertura, intCodRespCobertura)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "RespuestaCobertura: " & RespuestaCobertura)

            Catch ex As Exception
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error en registrar la Cobertura  " & ex.Message)
            End Try

        Next
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin array en DetalleVentaPrepago " & strProceso)
    End Sub

    Private Sub RegistrarDOL(ByVal nroPedido As String, ByVal strLineasNoActivadas As String, ByVal booDol As Boolean, ByRef strTelefonoNumero As String, ByRef strRegistroDOLRespuesta As String) 

        Dim dsPedido As DataSet
        Dim objFileLog As New SrvPago_Log
        Dim nameFile As String = ConfigurationSettings.AppSettings("constNameLogRegistroDOL")
        Dim pathFile As String = ConfigurationSettings.AppSettings("constRutaLogRegistroDOL")
        Dim strArchivo As String = objFileLog.Log_CrearNombreArchivo(nameFile)
        Dim strIdentifyLog As String = nroPedido
        Dim strParametros As String = ""
        Dim clsCajasPrepago As New COM_SIC_Activaciones.clsConsultaPvu

        '******Consulta Venta Prepago******
        Dim intDatosPrepago As Integer
        Dim K_RPTA, K_MENSAJE As String
        Dim C_VENTA, C_VENTA_DET As DataTable

        intDatosPrepago = clsCajasPrepago.ConsultarPedidosPrepago(nroPedido, K_RPTA, K_MENSAJE, C_VENTA, C_VENTA_DET)
        C_VENTA = C_VENTA
        C_VENTA_DET = C_VENTA_DET

        strTelefonoNumero = String.Empty
        Dim strTelefonoSeparador As String = "|"
        Dim strTelefonoNumeroTemporal As String = String.Empty
        strRegistroDOLRespuesta = String.Empty
        Dim strRegistroDOLSeparador As String = "|"
        Dim strRegistroDOLRespuestaTemporal As String = String.Empty

        Try

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "          *********INICIO REGISTRAR DOL*************")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Consulta Pedido - Metodo: ConsultaPedido - SP: SSAPS_PEDIDO")

            Dim PuntoVentaSinergia As String = ""
            Try
                PuntoVentaSinergia = Funciones.CheckStr(objConsultaMsSap.ConsultaPuntoVenta(AppAlmacen).Tables(0).Rows(0).Item("OVENV_CODIGO_SINERGIA"))
            Catch ex As Exception
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error al consulta los Puntos de Venta para Sinergia")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error: " & PuntoVentaSinergia)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & ex.Message.ToString)
                PuntoVentaSinergia = ""
            End Try

            dsPedido = objConsultaMsSap.ConsultaPedido(nroPedido, PuntoVentaSinergia, "")

            'Consulta Parametros SICAR 
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Consulta Paramteros Promocion - Metodo: ListaParamPromocion")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "        IN GrupoBonoDOL" & ConfigurationSettings.AppSettings("strGrupoBonoDol"))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "        IN NroPedido" & strIdentifyLog)

            Dim strListPromo = ListaParamPromocion(ConfigurationSettings.AppSettings("strGrupoBonoDol"), strIdentifyLog)

            'Consulta Parametros por PDV 
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Consulta Paramteros - Metodo: ParametrosVenta")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "        IN Punto de Venta" & AppAlmacen)

            Dim dsResult As DataSet
            Try
                Dim objOffline As New COM_SIC_OffLine.clsOffline
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Inicio Parametros Venta--")
                dsResult = objOffline.ParametrosVenta(AppAlmacen)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Fin Parametros Venta--")
            Catch ex As Exception
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--ERROR Parametros Venta-- " & ex.Message)
            End Try

            'Registro de Venta Prepago WS de Venta Prepago
            RegistroDatosVentaPrepago(dsPedido, dsResult, nroPedido, strLineasNoActivadas, strListPromo, C_VENTA_DET)
            'Fin del Registro de Venta Prepago WS de Venta Prepago

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio de Transaccion.")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Oficina - Usuario : " & PuntoVentaSinergia & " - " & AppUsuario)

            Dim vendedor As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("VENDEDOR"))
            Dim tipoClieDoc As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("CLIEC_TIPODOCCLIENTE"))
            Dim numClieDoc As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("CLIEV_NRODOCCLIENTE"))

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Vendedor: " & vendedor)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Tipo Cliente: " & tipoClieDoc)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Nro Doc Cliente: " & numClieDoc)

            ' Inicio Consulta Codigo RED Vendedor
            Dim dsUsuario As DataSet
            Dim usuarioRed As String
            Dim oConsulta As New COM_SIC_Activaciones.clsBDSiscajas

            objFileLog.Log_WriteLog(pathFile, strArchivo, "Inicio FP_ConsultaUsuarioRed")
            objFileLog.Log_WriteLog(pathFile, strArchivo, "Cod Vendedor:" + vendedor)
            Dim strRespuesta As String

            objFileLog.Log_WriteLog(pathFile, strArchivo, "Cod Vendedor:" + vendedor)
            Do While InStr(1, vendedor, "0") = 1
                vendedor = Mid(vendedor, 2, Len(vendedor))
            Loop
            objFileLog.Log_WriteLog(pathFile, strArchivo, "Cod Vendedor:" + vendedor)
            dsUsuario = oConsulta.FP_ConsultaUsuarioRed(vendedor, strRespuesta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, "strRespuesta:" + strRespuesta)

            If Not IsNothing(dsUsuario) Then
                objFileLog.Log_WriteLog(pathFile, strArchivo, "nro de registros :" + dsUsuario.Tables(0).Rows.Count.ToString())
                If Not dsUsuario.Tables(0).Rows.Count = 0 Then
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Codigo de red:" + dsUsuario.Tables(0).Rows(0).Item(0))
                    usuarioRed = dsUsuario.Tables(0).Rows(0).Item(0)
                Else
                    usuarioRed = vendedor
                End If
            Else
                usuarioRed = vendedor
            End If
            objFileLog.Log_WriteLog(pathFile, strArchivo, "usuarioRed:" + usuarioRed)
            objFileLog.Log_WriteLog(pathFile, strArchivo, "Fin FP_ConsultaUsuarioRed")

            dsUsuario = Nothing
            oConsulta = Nothing
            ' Fin Consulta Codigo RED Vendedor

            ' Inicio Descripcion Documento Cliente
            Dim listaDocumento() As String
            Dim desDocCliente As String

            listaDocumento = Split(ConfigurationSettings.AppSettings("strListaDocumentos"), "|")

            For ii As Integer = 0 To UBound(listaDocumento)
                Dim arrayDocumento() As String = Split(listaDocumento(ii), ";")
                If arrayDocumento(0) = Right("00" & tipoClieDoc, 2) Then
                    desDocCliente = arrayDocumento(1)
                    Exit For
                End If
            Next
            ' Fin Descripcion Documento Cliente

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo|Nro. Cliente : " & tipoClieDoc & "|" & numClieDoc)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Cod.Sap|Cod.Red Vendedor : " & vendedor & "|" & usuarioRed)

            Dim dsCliente As DataSet
            'Dim oConsultaSAP As New SAP_SIC_Pagos.clsPagos

            ' Consulta Datos Cliente SAP
            'Consulta de Cliente
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Inicio Consulta de Cliente - Metodo: Get_ConsultaCliente - SP: SSAPSS_CLIENTE")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "       IN Nro de Documento:" & numClieDoc)

            dsCliente = objConsultaMsSap.Get_ConsultaCliente(numClieDoc, tipoClieDoc)

            'oConsultaSAP = Nothing

            If Not IsNothing(dsCliente) Then

                If dsCliente.Tables(0).Rows.Count > 0 Then

                    ' Datos Template Cliente
                    Dim oCliente As New COM_SIC_Activaciones.clsCliente

                    oCliente.NROTRANSACCION = ""

                    If Right("00" & tipoClieDoc, 2) = "06" Then
                        oCliente.NOMBRES = Left(dsCliente.Tables(0).Rows(0)("CLIEV_RAZONSOCIAL"), 30)
                        oCliente.APELLIDOS = Left(dsCliente.Tables(0).Rows(0)("CLIEV_RAZONSOCIAL"), 30)
                    Else
                        oCliente.NOMBRES = Left(dsCliente.Tables(0).Rows(0)("CLIEV_NOMBRECLIENTE"), 30)
                        oCliente.APELLIDOS = Left(dsCliente.Tables(0).Rows(0)("CLIEV_PATERNOCLIENTE") & " " & dsCliente.Tables(0).Rows(0)("CLIEV_MATERNOCLIENTE"), 30)
                    End If

                    oCliente.TIPODOCUMENTO = desDocCliente
                    oCliente.NUMERODOCUMENTO = dsCliente.Tables(0).Rows(0)("CLIEV_NRODOCCLIENTE")
                    oCliente.TELEFONOREFERENCIA = Funciones.CheckStr(dsCliente.Tables(0).Rows(0)("CLIEV_TELEFONOCLIENTE"))
                    oCliente.FECHANACIMIENTO = ""
                    oCliente.LUGARNACIMIENTO = ""
                    oCliente.MOTIVOREGISTRO = ConfigurationSettings.AppSettings("MOTIVO_DOL")
                    oCliente.DIRECCIONCOMPLETA = ConfigurationSettings.AppSettings("CTE_NO_ESPECIFICADO")
                    oCliente.CIUDAD = ConfigurationSettings.AppSettings("CTE_NO_ESPECIFICADO")
                    oCliente.CODIGOEMPLEADO = usuarioRed
                    oCliente.CODIGOSISTEMA = ConfigurationSettings.AppSettings("COD_SISTEMA_DOL")
                    oCliente.TIPO = ConfigurationSettings.AppSettings("TIPO_CLIE_DOL")
                    oCliente.TEXTO = ConfigurationSettings.AppSettings("TEXTO_DOL")

                    Dim cod_Region As String
                    cod_Region = dsResult.Tables(0).Rows(0).Item("REGION")

                    If booDol = True Then
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "*************************************")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INICIO RegistrarDetalleDOL(" + nroPedido + ") ")

                        ''Grabar_Cobertura(nroPedido, ConfigurationSettings.AppSettings("NombreProcesoPorta"))

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FIN RegistrarDetalleDOL(" + nroPedido + ") ")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "*************************************")
                    End If

                    For i As Integer = 0 To dsPedido.Tables(1).Rows.Count - 1

                        Dim flagErrorDOL As Boolean = False
                        Dim codMaterial As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(i)("MATEV_CLASIFICACION"))

                        ' Inicio Validacion solo Pack SimCard
                        If Len(Trim(codMaterial)) > 0 Then
                            If codMaterial.StartsWith("PS") Then

                                Dim NroTelefono As String
                                NroTelefono = FormatoTelefonoPrepago(Funciones.CheckStr(dsPedido.Tables(1).Rows(i)("DEPEV_NROTELEFONO")))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Telefono : " & NroTelefono)
                                oCliente.MSISDN = NroTelefono

                                'Registra DOL solo para aquellas lineas que fueron activadas.
                                If strLineasNoActivadas.IndexOf(NroTelefono) = -1 Then

                                    If booDol = True Then

                                        ' Inicio Invocar WS DOL
                                        Dim idDOL As String
                                        Dim outDOL As String
                                        Dim mensajeDOL As String
                                        Dim oDOL As New COM_SIC_Activaciones.clsDOL

                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo RegistroDOL()")
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "        IN Cliente: Datos del Cliente")
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "        IN Ruta del WS: " & ConfigurationSettings.AppSettings("constRutaWSDOL"))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "        IN TimeOut WS: " & CInt(ConfigurationSettings.AppSettings("constTimeOutWSDOL")))

                                        ''ava inicio val dol
                                        'If Not (Session("Almacen") = ConfigurationSettings.AppSettings("TIENDA_VIRTUAL")) Then
                                        'outDOL = oDOL.RegistroDOL(oCliente, _
                                         '                           ConfigurationSettings.AppSettings("constRutaWSDOL"), _
                                         '                           CInt(ConfigurationSettings.AppSettings("constTimeOutWSDOL")), _
                                         '                           idDOL, _
                                          '                          mensajeDOL)
                                        'oDOL = Nothing
                                        'End If

                                        ''ava fin val dol

                                        'ava val dol
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo VALIDACION TIENDA VIRTUAL AVA")
                                        Dim listaOficinasVirtuales$ = ConfigurationSettings.AppSettings("TIENDA_VIRTUAL")
                                        Dim isTiendaVirtual As Boolean = False

                                        If (IsNothing(listaOficinasVirtuales)) Then Throw New Exception("Lista oficinas virtuales no configuradas - Activacion Pel")
                                        For Each sTiendaVirtual As String In listaOficinasVirtuales.Split("|"c)
                                            If AppAlmacen = sTiendaVirtual Then
                                                isTiendaVirtual = True
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "SE ENCONTRO TIENDA VIRTUAL AVA")
                                                Exit For
                                            Else
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "NO SE ENCONTRO TIENDA VIRTUAL AVA")
                                            End If

                                        Next
                                        If (Not isTiendaVirtual) Then
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INICIO PROCESO DOL AVA")
                                            outDOL = oDOL.RegistroDOL(oCliente, _
                                            ConfigurationSettings.AppSettings("constRutaWSDOL"), _
                                            CInt(ConfigurationSettings.AppSettings("constTimeOutWSDOL")), _
                                            idDOL, _
                                            mensajeDOL)
                                            oDOL = Nothing
                                        Else
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "NO SE EJECUTO DOL AVA")
                                        End If

                                        'ava fin val dol

                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Id.Interac|Mensaje : " & idDOL & "|" & mensajeDOL)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo RegistroDOL()")
                                        ' Fin Invocar WS DOL

                                        strTelefonoNumeroTemporal = NroTelefono
                                        strTelefonoNumero = strTelefonoNumero & strTelefonoNumeroTemporal.Substring(strTelefonoNumeroTemporal.Length - 9) & strTelefonoSeparador
                                        strRegistroDOLRespuestaTemporal = IIf(outDOL.Equals("0"), "1", "0")
                                        strRegistroDOLRespuesta = strRegistroDOLRespuesta & strRegistroDOLRespuestaTemporal & strRegistroDOLSeparador

                                        If Not Trim(outDOL) = "0" Then
                                            ' Capturamos el Error en el Log
                                            'Session.Add("mensajeErrorDOL", Session("mensajeErrorDOL") & "\nError. No se pudo Registrar WS DOL, Nro Telefono: " & NroTelefono & ".")
                                            AppmensajeErrorDOL = AppmensajeErrorDOL & "\nError. No se pudo Registrar WS DOL, Nro Telefono: " & NroTelefono & "."
                                            flagErrorDOL = True
                                        End If

                                    End If ' FIN FMES : PILOTO

                                    ' Obtenemos los Datos Telefono|Ruta de Sesion
                                    Dim arrayFile() As String
                                    arrayFile = CType(ApparrNombArchivos, String())

                                    If Not IsNothing(arrayFile) Then

                                        If arrayFile.Length > 0 Then

                                            For iii As Integer = 0 To UBound(arrayFile) - 1

                                                Dim Telefono As String = CStr(Split(arrayFile(iii), "|")(0))
                                                Dim NombreArchivo As String = CStr(Split(arrayFile(iii), "|")(1))

                                                If Telefono = Funciones.CheckStr(dsPedido.Tables(1).Rows(i)("DEPEV_NROTELEFONO")) Then

                                                    ' Inicio Region Upload FTP
                                                    Dim mensajeFTP As String
                                                    Dim strDirectorio As String = Date.Now.ToString("yyyyMMdd")
                                                    Dim strRutaDestino As String = ConfigurationSettings.AppSettings("strRutaDestinoDOL") & "/" & strDirectorio

                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Telefono : " & NroTelefono)
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo UploadArchivoFTP()")
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Archivo : " & NombreArchivo)
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Directorio Origen : " & ConfigurationSettings.AppSettings("strRutaOrigenDOL"))
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Directorio Destino : " & strRutaDestino)

                                                    ' Creacion del Directorio Formato YYYYMMDD
                                                    mensajeFTP = CreateDirectorioFTP(ConfigurationSettings.AppSettings("strRutaDestinoDOL"), strDirectorio)
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje Directorio: " & mensajeFTP)
                                                    mensajeFTP = UploadArchivoFTP(ConfigurationSettings.AppSettings("strRutaOrigenDOL"), _
                                                            NombreArchivo, _
                                                            strRutaDestino)
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje FTP: " & mensajeFTP)

                                                    If Not mensajeFTP = "" Then
                                                        'Session.Add("mensajeErrorDOL", Session("mensajeErrorDOL") & "\nError. No se pudo enviar por el archivo " & NombreArchivo & " via FTP.")
                                                        AppmensajeErrorDOL = AppmensajeErrorDOL & "\nError. No se pudo enviar por el archivo " & NombreArchivo & " via FTP."
                                                    End If

                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo UploadArchivoFTP()")
                                                    ' Fin Region Upload FTP

                                                    ' Inicio Registrar BD Prepago
                                                    Dim outBD As Int64
                                                    Dim oCajas As New COM_SIC_Activaciones.clsBDSiscajas
                                                    Dim rutaArchivo As String = strRutaDestino & "/" & NombreArchivo

                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo FP_RegistrarDOL()")
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "      IN Numero de Telefono: " & NroTelefono)
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "      IN Tipo de Cliente: " & tipoClieDoc)
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "      IN Numero de Documento Cliente: " & numClieDoc)
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "      IN Usuario de Red: " & usuarioRed)
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "      IN Punto de Venta: " & AppAlmacen)
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "      IN Ruta de Acrchivo: " & rutaArchivo)
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "      IN Sistema DOL: " & ConfigurationSettings.AppSettings("SISTEMA_DOL"))
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "      IN Estado: 1")
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "      IN FlagDummy: 0")
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "      IN FechaNac: 00000000")

                                                    outBD = oCajas.FP_RegistrarDOL(NroTelefono, _
                                                                                    tipoClieDoc, _
                                                                                    numClieDoc, _
                                                                                    usuarioRed, _
                                                                                    AppAlmacen, _
                                                                                    rutaArchivo, _
                                                                                    ConfigurationSettings.AppSettings("SISTEMA_DOL"), _
                                                                                    "1", _
                                                                                    "0", _
                                                                                    "00000000")
                                                    oCajas = Nothing

                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Resultado : " & outBD)
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo FP_RegistrarDOL()")
                                                    ' Fin Registrar BD Prepago
                                                End If
                                            Next
                                        Else
                                            ' Capturamos el Error en el Log
                                            If Not Right("00" & tipoClieDoc, 2) = "06" Then
                                                'Session.Add("mensajeErrorDOL", Session("mensajeErrorDOL") & "\nError. No se pudo enviar por el archivo via FTP, no se grabo en la BD COBSDB.")
                                                AppmensajeErrorDOL = AppmensajeErrorDOL & "\nError. No se pudo enviar por el archivo via FTP, no se grabo en la BD COBSDB."
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Ocurrio un error al intentar recuperar los datos de Sesion.")
                                            End If
                                        End If
                                    Else
                                        ' Capturamos el Error en el Log
                                        If Not Right("00" & tipoClieDoc, 2) = "06" Then
                                            'Session.Add("mensajeErrorDOL", Session("mensajeErrorDOL") & "\nError. No se pudo enviar por el archivo via FTP, no se grabo en la BD COBSDB.")
                                            AppmensajeErrorDOL = AppmensajeErrorDOL & "\nError. No se pudo enviar por el archivo via FTP, no se grabo en la BD COBSDB."
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Ocurrio un error al intentar recuperar los datos de Sesion.")
                                        End If
                                    End If

                                    ' Inicio Region Entrega de BONO
                                    Dim IMEI As String
                                    Dim flagIMEI As Boolean = False
                                    Dim codMaterialDetalle As String
                                    IMEI = Left(Funciones.CheckStr(dsPedido.Tables(1).Rows(i)("SERIC_CODSERIE")), 18)

                                    For x As Integer = 0 To dsPedido.Tables(1).Rows.Count - 1

                                        If Funciones.CheckStr(dsPedido.Tables(1).Rows(i)("DEPEV_NROTELEFONO")) = Funciones.CheckStr(dsPedido.Tables(1).Rows(x)("DEPEV_NROTELEFONO")) Then
                                            codMaterialDetalle = Funciones.CheckStr(dsPedido.Tables(1).Rows(x)("MATEV_CLASIFICACION"))
                                            If codMaterialDetalle.StartsWith("PB") Then
                                                flagIMEI = True
                                                IMEI = Right(Funciones.CheckStr(dsPedido.Tables(1).Rows(x)("SERIC_CODSERIE")), 15)
                                                Exit For
                                            End If
                                        End If
                                    Next

                                    Dim Telef As String
                                    Dim outBono As Integer
                                    Dim mensajeBono As String
                                    Dim oBono As New COM_SIC_Activaciones.clsBDSiscajas

                                    Telef = "51" & NroTelefono

                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo FP_RegistrarBonoDOL()")

                                    If booDol = True Then
                                        Dim promocion As String
                                        Dim strNumero As String = FormatoTelefono(Funciones.CheckStr(dsPedido.Tables(1).Rows(i).Item("DEPEV_NROTELEFONO")))
                                        Dim strEquipo As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(i).Item("DEPEC_CODMATERIAL"))
                                        Dim strListaPrecio As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(i).Item("DEPEV_CODIGOLP"))
                                        Dim strCampana As String = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("DVPR_COD_CAMPANA"))

                                        promocion = Get_CodPromocion(strListaPrecio, strListPromo, strIdentifyLog)

                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "---INICIO Registrar Bono DOL---")
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Metodo: FP_RegistrarBonoDOL")
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     IN Telefono|ICCID: " & Telef & "|" & IMEI & "@promocion=" & promocion)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     IN IMEI : " & IMEI)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     IN Telef : " & Telef)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     IN ORIGEN_BONO_DOL : " & ConfigurationSettings.AppSettings("ORIGEN_BONO_DOL"))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     IN usuarioRed : " & usuarioRed)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     IN cod_Region : " & cod_Region)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     IN promocion : " & promocion)

                                        Dim p_offer_out As String
                                        Dim p_indneg_out As String
                                        outBono = oBono.FP_RegistrarBonoDOL(IMEI, _
                                                                            Telef, _
                                                                            ConfigurationSettings.AppSettings("ORIGEN_BONO_DOL"), _
                                                                            usuarioRed, _
                                                                            cod_Region, _
                                                                            promocion, _
                                                                            mensajeBono, _
                                                                            p_offer_out, _
                                                                            p_indneg_out)
                                        oBono = Nothing

                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "p_offer_out : " & p_offer_out)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "p_indneg_out : " & p_indneg_out)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "mensajeBono : " & mensajeBono)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "---FIN Registrar Bono DOL---")

                                        If CheckStr(p_offer_out) <> "" And CheckStr(p_indneg_out) <> "" Then
                                            Dim strGrupoConEquipo = ConfigurationSettings.AppSettings("constGrupoPrepagoEspecial")
                                            Dim strGrupoSinEquipo = ConfigurationSettings.AppSettings("constGrupoPrepagoEspecialSinEquipo")

                                            If Len(Trim(strEquipo)) Then
                                                If Funciones.CheckStr(dsPedido.Tables(1).Rows(i).Item("MATEV_CLASIFICACION")).StartsWith("PS") Then
                                                    Dim blnConEquipo As Boolean

                                                    blnConEquipo = validaVentaEquipo(strNumero, dsPedido.Tables(1))
                                                    Try
                                                        Dim CodOpcion As String
                                                        If blnConEquipo Then
                                                            CodOpcion = Get_CodOpcionBBA(strEquipo, strListaPrecio, strCampana, strGrupoConEquipo, nroPedido)
                                                        Else
                                                            CodOpcion = Get_CodOpcionBBA(strEquipo, strListaPrecio, strCampana, strGrupoSinEquipo, nroPedido)
                                                        End If
                                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		blnConEquipo: " & blnConEquipo)
                                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		CodOpcion: " & CodOpcion)
                                                        Dim blnEsBAM As Boolean
                                                        blnEsBAM = (CodOpcion <> "")
                                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		blnEsBAM: " & blnEsBAM)
                                                        If Not blnEsBAM Then
                                                            Call RegistrarPlanPrepagoEspecial(Telef, p_offer_out, p_indneg_out)
                                                        End If
                                                    Catch ex As Exception
                                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error Cambio offer: " & ex.Message.ToString())
                                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error Cambio offer: " & ex.StackTrace.ToString())
                                                    End Try
                                                End If
                                            Else
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "No tiene Codigo de Material")
                                            End If
                                        End If

                                        oBono = Nothing

                                        If outBono < 0 Or outBono = 999 Then
                                            If (outBono = -8) And (Not flagErrorDOL) Then
                                                'Session.Add("mensajeErrorDOL", Session("mensajeErrorDOL") & "\nSe realizo registro DOL, por favor realizar el registro del bono via SMS.")
                                                AppmensajeErrorDOL = AppmensajeErrorDOL & "\nSe realizo registro DOL, por favor realizar el registro del bono via SMS."
                                            Else
                                                'Session.Add("mensajeErrorDOL", Session("mensajeErrorDOL") & "\nError. No se pudo Registrar el Bono, Nro. Telefono: " & Telef & ".")
                                                AppmensajeErrorDOL = AppmensajeErrorDOL & "\nError. No se pudo Registrar el Bono, Nro. Telefono: " & Telef & "."
                                            End If
                                        End If

                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Codigo|Mensaje : " & outBono & "|" & mensajeBono)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo FP_RegistrarBonoDOL()")

                                    End If ' FIN FMES : PILOTO
                                    ' Fin Region Entrega de BONO
                                End If
                                'Fin Registra DOL solo para aquellas lineas que fueron activadas.
                            End If
                            ' Fin Validacion solo Pack SimCard
                        Else
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "No tiene Codigo de Material")
                        End If
                    Next
                Else
                    ' Capturamos el Error en el Log
                    'Session.Add("mensajeErrorDOL", "Cliente No Encontrado en SAP, Nro. Documento: " & numClieDoc & ". No se pudo registrar el DOL.")
                    AppmensajeErrorDOL = "Cliente No Encontrado en SAP, Nro. Documento: " & numClieDoc & ". No se pudo registrar el DOL."
                    Throw New Exception("Cliente No Encontrado en SAP. Numero Documento: " & numClieDoc)
                End If
            Else
                ' Capturamos el Error en el Log
                'Session.Add("mensajeErrorDOL", "Cliente No Encontrado en SAP, Nro. Documento: " & numClieDoc & ". No se pudo registrar el DOL.")
                AppmensajeErrorDOL = "Cliente No Encontrado en SAP, Nro. Documento: " & numClieDoc & ". No se pudo registrar el DOL."
                Throw New Exception("Cliente No Encontrado en SAP. Numero Documento: " & numClieDoc)
            End If

            ApparrNombArchivos = Nothing
            dsCliente = Nothing
            dsPedido = Nothing

        Catch ex As Exception
            dsPedido = Nothing
            ApparrNombArchivos = Nothing

            ' Capurando Mensaje de Error
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & ex.Message)
        End Try

    End Sub

    Function ValidacionVentaDOL(ByVal nroDocumSAP As String, ByVal nroPedido As String) As Boolean

        Dim dsPedido As New DataSet
        Dim strCodArticulo As String
        Dim flag As Boolean = False

        Try
            'dsPedido = objPagos.Get_ConsultaPedido("", Session("ALMACEN"), nroDocumSAP, "")
            Dim objMsSAP As New COM_SIC_Activaciones.clsConsultaMsSap
            Dim strAlmacen As String = objMsSAP.ConsultaPuntoVenta(AppAlmacen).Tables(0).Rows(0).Item("OVENV_CODIGO_SINERGIA")

            If strAlmacen.Trim <> "" Then
                dsPedido = objConsultaMsSap.ConsultaPedido(nroPedido, strAlmacen, "")
            End If

            If Not IsNothing(dsPedido) Then
                If dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVPrepago") And _
                    dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION") = ConfigurationSettings.AppSettings("strDTVAlta") And _
                    dsPedido.Tables(0).Rows(0).Item("PEDIV_DESCTIPOOPERACION") = ConfigurationSettings.AppSettings("strAltaPrepago") Then 'INC000000796204-JCFM-LINEAS PAGADAS QUE NO LLAMAN AL SERVICIO DOL

                    For i As Integer = 0 To dsPedido.Tables(1).Rows.Count - 1
                        strCodArticulo = dsPedido.Tables(1).Rows(i).Item("MATEC_TIPOMATERIAL") 'TODOEB
                        ' Validacion de la Venta de Pack Simcard
                        If strCodArticulo.ToString.Trim = ConfigurationSettings.AppSettings("constChips") Then
                            'Dim listaMatCambioSIM As String = ConfigurationSettings.AppSettings("codMatChipRepuesto")
                            'If listaMatCambioSIM.IndexOf(strCodArticulo) = -1 Then
                                flag = True
                                Exit For
                            'End If
                        End If
                    Next
                End If
            End If
        Catch ex As Exception
            flag = False
        End Try

        Return flag
    End Function

    Private Sub RegistrarPagoRenovacionRPM6(ByVal nroTelefono As String)
        Dim objBSCS As New COM_SIC_Cajas.clsCajas
        Dim Accion, CodOcc, NroCuotas, CodError As Integer
        Dim Monto As Double
        Dim CodRenov, Remark, TipoTickler, DescTickler, MensajeFinal, MsgError As String
        MensajeFinal = String.Empty

        Dim objFileLog As New SrvPago_Log
        Dim nameFile As String = "Log_RenovacionRPC6" 'ConfigurationSettings.AppSettings("constNameLogRegistroDOL")
        Dim pathFile As String = ConfigurationSettings.AppSettings("constRutaLogRegistroDOL")
        Dim strArchivo As String = objFileLog.Log_CrearNombreArchivo(nameFile)
        Dim strIdentifyLog As String = nroTelefono
        Dim strOficina As String = Funciones.CheckStr(AppOFICINA)

        Try
            Dim ArrayParametros() As String = Split(ConfigurationSettings.AppSettings("strGrabarPago"), ";")
            CodRenov = ArrayParametros(0).ToString()
            Accion = Integer.Parse(ArrayParametros(1))
            CodOcc = Integer.Parse(ArrayParametros(2))
            NroCuotas = Integer.Parse(ArrayParametros(3))
            Monto = Double.Parse(ArrayParametros(4))
            Remark = ArrayParametros(5).ToString()
            CodError = 0 : MsgError = String.Empty
            DescTickler = ArrayParametros(6).ToString()
            TipoTickler = ArrayParametros(7).ToString()

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "---------------Inicio RegistrarPagoRenovacionRPM6-----------")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   INP  nroTelefono : " & FormatoTelefono(nroTelefono))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   INP  CodRenov : " & CodRenov)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   INP  Accion : " & Accion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   INP  DescTickler : " & DescTickler)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   INP  strCodUsrRenovRPC : " & ConfigurationSettings.AppSettings("strCodUsrRenovRPC"))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   INP  Cod. Oficina : " & AppAlmacen)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   INP  Oficina : " & strOficina)

            Dim Resultado As String = objBSCS.FP_RegistrarRenovacionRPM6(FormatoTelefono(nroTelefono), CodRenov, Accion, DescTickler, strOficina, ConfigurationSettings.AppSettings("strCodUsrRenovRPC")) ''TODO: CALLBACK ORACLE

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   OUT  Resultado : " & Resultado)

            Select Case Split(Resultado, ";")(0).ToString()
                Case "0"
                    MensajeFinal = "El bono de renovación RPC 6 ha sido programado satisfactoriamente. Su plan caducará el " & Split(Resultado, ";")(2).ToString()
                Case Else
                    MensajeFinal = "Ha ocurrido un error al momento de registrar el pago en el BSCS, comuniquese con ATU"
            End Select

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   OUT  MensajeFinal : " & MensajeFinal)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------Fin RegistrarPagoRenovacionRPM6--------------")

            objBSCS.FP_RegistrarLogRenovacionRPM6(FormatoTelefono(nroTelefono), CodRenov, Accion, CodOcc, NroCuotas, Monto, Remark, TipoTickler, DescTickler, ConfigurationSettings.AppSettings("strCodUsrRenovRPC"), AppstrUsuario, Split(Resultado, ";")(1).ToString(), Split(Resultado, ";")(2).ToString(), strOficina)
            'Session.Add("ErrorRenovacionRPM6", MensajeFinal)
            AppErrorRenovacionRPM6 = MensajeFinal
        Catch ex As Exception

            'INI PROY-140126
            Dim MaptPath As String
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: RegistrarPagoRenovacionRPM6)"
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   ERROR : " & ex.Message & MaptPath)
            'FIN PROY-140126

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------Fin RegistrarPagoRenovacionRPM6--------------")

            MensajeFinal = "Ha ocurrido un error al momento de registrar el pago en el BSCS, comuniquese con ATU."
            ' Session.Add("ErrorRenovacionRPM6", MensajeFinal)
            AppErrorRenovacionRPM6 = MensajeFinal
        End Try

    End Sub

    Private Function EjecutarActivacionBono(ByVal NroTelefono As String, ByVal CodOpcion As String, ByVal strDocSap As String) As String

        Dim strIdentifyLog As String = strDocSap
        Dim strCodRespuesta As String = "1"
        Dim strMensaje As String = ""

        Try

            Dim objActivacion As New COM_SIC_Activaciones.clsActivacion

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "---------------Inicio EjecutarActivacionPrepago-----------")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   INP  nroTelefono : " & NroTelefono)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   INP  CodOpcion : " & CodOpcion)

            strCodRespuesta = objActivacion.FK_EjecutarActivacionBono(NroTelefono, CodOpcion, strMensaje)

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   OUT  resultado : " & strCodRespuesta)
            'INI PROY-140126
            Dim MaptPath As String
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: EjecutarActivacionBono)"
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   OUT  mensaje : " & strMensaje & MaptPath)
            'FIN PROY-140126

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "---------------Fin EjecutarActivacionPrepago-----------")

        Catch ex As Exception

            'INI PROY-140126
            Dim MaptPath As String
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: EjecutarActivacionBono)"
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   OUT  ERROR : " & ex.Message.ToString() & MaptPath)
            'FIN PROY-140126

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "---------------Fin EjecutarActivacionPrepago-----------")
        End Try

        Return strCodRespuesta

    End Function

    Private Function Get_CodOpcionBBA(ByVal strCodMaterial As String, ByVal strListaPrecio As String, ByVal strCampana As String, ByVal strGrupoEquipo As String, ByVal strDocSap As String) As String

        Dim objCajas As New COM_SIC_Cajas.clsCajas
        Dim arrListMateriales As String()
        Dim arrMaterial As String()
        Dim strOpcion As String = ""
        Dim strIdentifyLog As String = strDocSap

        Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "---------------Inicio Get_CodOpcionBBA-----------")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   INP  strCodMaterial : " & strCodMaterial)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   INP  strGrupoEquipo : " & strGrupoEquipo)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   INP  strListaPrecio : " & strListaPrecio)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   INP  strCampana : " & strCampana)

            strOpcion = objCajas.Obtener_codigo_opcion(strCodMaterial, strListaPrecio, strCampana, strGrupoEquipo)
            ' SE CAMBIA POR UN STORED QUE OBTIENE EL CODIGO DE OPCION DIRECTAMENTE A PARTIR DE PARAMETROS 
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   OUT  strOpcion : " & strOpcion)
        Catch ex As Exception
            'INI PROY-140126
            Dim MaptPath As String
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: Get_CodOpcionBBA)"
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   OUT  ERROR : " & ex.Message.ToString() & MaptPath)
            'FIN PROY-140126
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   OUT  ERROR : " & ex.StackTrace.ToString())
        Finally
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "---------------Fin Get_CodOpcionBBA-----------")
        End Try

        Return strOpcion
    End Function

    Private Function registro_ventas(ByVal dsPedido As DataSet, ByVal strIdentifyLog As String) As Boolean
        Dim objregistro As Integer
        Dim objSicarDB As New COM_SIC_Cajas.clsCajas
        Dim vendedor As String
        Dim objFileLog As New SrvPago_Log
        Dim nameFile As String = ConfigurationSettings.AppSettings("constNameLogActivacionPrepago")
        Dim pathFile As String = ConfigurationSettings.AppSettings("constRutaLogActivacionPrepago")
        Dim strArchivo As String = objFileLog.Log_CrearNombreArchivo(nameFile)
        Dim strCodArticulo As String
        Dim strNroTELEFONO As String
        Dim strCodAsesor As String
        Dim strmonto As Double
        'INICIO JTMMY
        Dim objOffline As New COM_SIC_OffLine.clsOffline
        'FIN JYMMY
        Try
            strmonto = 0
            'Consultar datos de venta
            '  dsResult = objPagos.Get_ConsultaPedido("", Session("ALMACEN"), strNROPEDIDO, "")

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   Inicio grabar ventas ")
            If Not IsNothing(dsPedido) Then
                If dsPedido.Tables(0).Rows.Count > 0 Then
                    vendedor = dsPedido.Tables(0).Rows(0).Item("VENDEDOR")
                End If
            End If

            ' Consultar el Usuario del Vendedor
            objFileLog.Log_WriteLog(pathFile, strArchivo, "Inicio FP_ConsultaUsuarioRed")
            objFileLog.Log_WriteLog(pathFile, strArchivo, "Cod Vendedor:" + vendedor)
            Dim strRespuesta As String

            Dim oConsulta As New COM_SIC_Activaciones.clsBDSiscajas
            Dim dsUsuario As DataSet

            Do While InStr(1, vendedor, "0") = 1
                vendedor = Mid(vendedor, 2, Len(vendedor))
            Loop

            objFileLog.Log_WriteLog(pathFile, strArchivo, "Cod Vendedor:" + vendedor)
            dsUsuario = Nothing 'oConsulta.FP_ConsultaUsuarioRed(vendedor, strRespuesta) 'Validado
            objFileLog.Log_WriteLog(pathFile, strArchivo, "strRespuesta:" + strRespuesta)

            If Not IsNothing(dsUsuario) Then
                objFileLog.Log_WriteLog(pathFile, strArchivo, "nro de registros :" + dsUsuario.Tables(0).Rows.Count.ToString())
                If dsUsuario.Tables(0).Rows.Count > 0 Then
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Codigo de red:" + dsUsuario.Tables(0).Rows(0).Item(0))
                    strCodAsesor = dsUsuario.Tables(0).Rows(0).Item(0)
                Else
                    strCodAsesor = AppstrUsuario
                End If
            Else
                strCodAsesor = AppstrUsuario
            End If

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Cod Asesor  " & strCodAsesor)
            objFileLog.Log_WriteLog(pathFile, strArchivo, "Fin FP_ConsultaUsuarioRed")
            ''For idx As Integer = 0 To dsPedido.Tables(1).Rows.Count - 1
            'strmonto = strmonto + dsPedido.Tables(1).Rows(

            For Each row As DataRow In dsPedido.Tables(1).Rows
                'strmonto = strmonto + row("TOTAL_PAGO")
                strmonto = strmonto + row("DEPEN_SUBTOTAL")
            Next

            Dim descerror As String = String.Empty


            For idx As Integer = 0 To dsPedido.Tables(1).Rows.Count - 1
                'strCodArticulo = CStr(dsPedido.Tables(1).Rows(idx).Item("ARTICULO"))
                strCodArticulo = CStr(dsPedido.Tables(1).Rows(idx).Item("MATEV_CLASIFICACION"))
                If (strCodArticulo.StartsWith("PS")) Then
                    'strNroTELEFONO = CStr(dsPedido.Tables(1).Rows(idx).Item("DEPEV_NROTELEFONO"))
                    strNroTELEFONO = Funciones.CheckStr(dsPedido.Tables(1).Rows(idx).Item("DEPEV_NROTELEFONO"))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  strNroTELEFONO  " & FormatoTelefonoPrepago(strNroTELEFONO))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  strmonto S/ " & strmonto.ToString())
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  strCodAsesor  " & strCodAsesor)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  OFICINA  " & Funciones.CheckStr(AppOFICINA))

                    objregistro = objSicarDB.FP_VENTAS_REGISTRADAS(FormatoTelefonoPrepago(strNroTELEFONO), Funciones.CheckDate(Date.Now()), Funciones.CheckDbl(strmonto), strCodAsesor, Funciones.CheckStr(AppOFICINA), descerror)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Respuesta registro " & objregistro.ToString())
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Desc Errror: " & descerror.ToString())
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Fin  ")
                End If
            Next

        Catch ex As Exception

            'INI PROY-140126
            Dim MaptPath As String
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: registro_ventas)"
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Fin ERROR metodo: registro_ventas  " & ex.Message & MaptPath)
            'FIN PROY-140126
        End Try

    End Function

    'Private Function VerificarVias(ByVal ds As DataSet) As DataTable

    '    Dim StrRectricciones As String
    '    Dim StrEfectivo, StrCheque, StrTarjeta, StrDebito, StrOtros As String
    '    Dim ArrEfectivo, ArrCheque, ArrTarjeta, ArrDebito, ArrOtros, ArrTotal As ArrayList
    '    Dim LOpciones As New ArrayList
    '    Dim dtVias As DataTable = New DataTable("ViasPago")
    '    Dim boolexiste As Boolean

    '    Try
    '        If AppWS_OpcionesPagina Is Nothing Then
    '            'Response.Write("<script> alert('Error: No se ubica el perfil para las vias de pago');</script>")
    '        Else
    '            LOpciones = AppWS_OpcionesPagina
    '        End If

    '        'objFileLog.Log_WriteLog(pathFile, strArchivo, "VerificarVias: " & "- constCodigoViasSap : " & ConfigurationSettings.AppSettings("constCodigoViasSap").ToString)
    '        StrRectricciones = ConfigurationSettings.AppSettings("constCodigoViasSap")

    '        StrEfectivo = ExtraerCadena(StrRectricciones)
    '        StrCheque = ExtraerCadena(StrRectricciones)
    '        StrTarjeta = ExtraerCadena(StrRectricciones)
    '        StrDebito = ExtraerCadena(StrRectricciones)
    '        StrOtros = ExtraerCadena(StrRectricciones)

    '        ArrEfectivo = ExtraerValores(StrEfectivo)
    '        ArrCheque = ExtraerValores(StrCheque)
    '        ArrTarjeta = ExtraerValores(StrTarjeta)
    '        ArrDebito = ExtraerValores(StrDebito)
    '        ArrOtros = ExtraerValores(StrOtros)

    '        Dim oEfectivo = ConfigurationSettings.AppSettings("constOpcPagEfectivo")
    '        Dim oCheque = ConfigurationSettings.AppSettings("constOpcPagCheque")
    '        Dim oTarjeta = ConfigurationSettings.AppSettings("constOpcPagTarjeta")
    '        Dim oDebito = ConfigurationSettings.AppSettings("constOpcPagDebito")
    '        Dim oOtros = ConfigurationSettings.AppSettings("constOpcPagOtros")

    '        ArrTotal = New ArrayList

    '        For Each cad As String In LOpciones
    '            If cad = oEfectivo Then
    '                For Each SCad As String In ArrEfectivo
    '                    ArrTotal.Add(SCad)
    '                Next
    '            ElseIf cad = oCheque Then
    '                For Each SCad As String In ArrCheque
    '                    ArrTotal.Add(SCad)
    '                Next
    '            ElseIf cad = oTarjeta Then
    '                For Each SCad As String In ArrTarjeta
    '                    ArrTotal.Add(SCad)
    '                Next
    '            ElseIf cad = oDebito Then
    '                For Each SCad As String In ArrDebito
    '                    ArrTotal.Add(SCad)
    '                Next
    '            ElseIf cad = oOtros Then
    '                For Each SCad As String In ArrOtros
    '                    ArrTotal.Add(SCad)
    '                Next
    '            End If
    '        Next

    '        If ArrTotal.Count = 0 Then
    '            dtVias = ds.Tables(0)
    '        Else
    '            dtVias = ds.Tables(0).Clone
    '            For Each sRow As DataRow In ds.Tables(0).Rows
    '                'boolexiste = False
    '                'For Each sCad As String In ArrTotal
    '                '    If CStr(sRow(0)) = sCad Then
    '                '        boolexiste = True
    '                '    End If
    '                'Next
    '                'If Not boolexiste Then
    '                '    dtVias.ImportRow(sRow)
    '                'End If
    '                For Each Rpt As String In ArrTotal
    '                    If Rpt = sRow(0) Then
    '                        dtVias.ImportRow(sRow)
    '                    End If
    '                Next
    '            Next

    '        End If

    '        Return dtVias

    '    Catch ex As Exception
    '        Response.Write("<script language=jscript> alert('" + ex.Message + "');</script>")
    '        Response.End()
    '    End Try
    'End Function

    Private Function ExtraerCadena(ByRef Cadena As String) As String

        Dim Arr As String = String.Empty
        Dim Posicion As Int32 = 1
        Dim Valor As String

        If Cadena = String.Empty Then
            Return Arr
        End If

        Posicion = InStr(Cadena, ";")

        If Posicion <> 0 Then
            Valor = Mid(Cadena, 1, Posicion - 1)
            Cadena = Mid(Cadena, Posicion + 1)
            Arr += Valor
        Else
            Arr += Cadena
        End If

        Return Arr

    End Function

    Private Function ExtraerValores(ByVal Cadena As String) As ArrayList

        Dim Arr As New ArrayList
        Dim Posicion As Int32 = 1
        Dim Valor As String

        If Cadena = String.Empty Then
            Return Arr
        End If

        While Posicion <> 0
            Posicion = InStr(Cadena, ",")
            If Posicion <> 0 Then
                Valor = Mid(Cadena, 1, Posicion - 1)
                Cadena = Mid(Cadena, Posicion + 1)
                Arr.Add(Valor)
            Else
                Arr.Add(Cadena)
            End If
        End While

        Return Arr

    End Function

    Private Function ValMensajeParametros(ByVal strDocSap As String) As DataSet
        Dim dsParametros As DataSet
        Dim strIdentifyLog As String = strDocSap
        Try
            Dim objSicarDB As New COM_SIC_Activaciones.clsBDSiscajas
            Dim strGrupo As String = ConfigurationSettings.AppSettings("grupoParametroABBA").ToString()

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "---------------Inicio ValMensajeParametros-----------")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   INP  strGrupo : " & strGrupo)
            dsParametros = objSicarDB.FP_ConsultaMaterialBBA(strGrupo)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   out FILAS: " & dsParametros.Tables(0).Rows.Count)
        Catch ex As Exception
            'INI PROY-140126
            Dim MaptPath As String
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: ValMensajeParametros)"
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   ERROR : " & ex.Message.ToString() & MaptPath)
            'FIN PROY-140126

        Finally
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "---------------Fin ValMensajeParametros-----------")
        End Try
        Return dsParametros
    End Function


#Region "Renovacion Corporativa"

    Private Sub GrabarPagoRenovacion(ByVal nroPedido As String, ByVal p_tipo_renov As String)

        Dim oDatos As New COM_SIC_Cajas.clsCajas
        Dim objFileLog As New SrvPago_Log
        Dim nameFile As String = "Log_RenovacionCorporativa"
        Dim pathFile As String = ConfigurationSettings.AppSettings("constRutaLogRenovacion")
        Dim strArchivo As String = objFileLog.Log_CrearNombreArchivo(nameFile)

        Dim blnExito As Boolean = False
        Dim strUsuario As String = AppstrUsuario

        Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, nroPedido & "- " & "---------------Inicio Registrar Pago Renovacion-----------")
            objFileLog.Log_WriteLog(pathFile, strArchivo, nroPedido & "- " & "   INP  Nro Pedido : " & nroPedido)
            objFileLog.Log_WriteLog(pathFile, strArchivo, nroPedido & "- " & "   INP  Usuario Pago : " & strUsuario)

            If p_tipo_renov = "B2E" Then
                blnExito = oDatos.FP_GrabarPagoRenovB2E(nroPedido, strUsuario)
                objFileLog.Log_WriteLog(pathFile, strArchivo, nroPedido & "- " & "   OUT  Resultado : " & blnExito)
            Else
                blnExito = oDatos.FP_GrabarPagoRenovBusiness(nroPedido, strUsuario)
                objFileLog.Log_WriteLog(pathFile, strArchivo, nroPedido & "- " & "   OUT  Resultado : " & blnExito)
            End If

        Catch ex As Exception
            'INI PROY-140126
            Dim MaptPath As String
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: GrabarPagoRenovacion)"
            objFileLog.Log_WriteLog(pathFile, strArchivo, nroPedido & "- " & "   ERROR : " & ex.Message & MaptPath)
            'FIN PROY-140126           
        Finally
            oDatos = Nothing
            objFileLog.Log_WriteLog(pathFile, strArchivo, nroPedido & "- " & "----------------Fin Registrar Pago Renovacion--------------")
        End Try
    End Sub

    Private Sub GrabarRenovCorpBSCS(ByVal p_nro_pedido As String, ByVal p_tipo_renov As String)

        Dim oConsulta As New COM_SIC_Cajas.clsCajas
        Dim objFileLog As New SrvPago_Log
        Dim nameFile As String = "Log_RenovacionCorporativa"
        Dim pathFile As String = ConfigurationSettings.AppSettings("constRutaLogRenovacion")
        Dim strArchivo As String = objFileLog.Log_CrearNombreArchivo(nameFile)

        Dim strOut As String
        Dim MsgError As String
        Dim LineasError As String = ""
        Dim MensajeFinal As String = ""

        Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, p_nro_pedido & "- " & "----------------INICIO RENOVACION CORPORATIVA--------------")
            objFileLog.Log_WriteLog(pathFile, strArchivo, p_nro_pedido & "- " & "   INP  Nro Pedido : " & p_nro_pedido)
            objFileLog.Log_WriteLog(pathFile, strArchivo, p_nro_pedido & "- " & "   INP  Tipo Venta : " & p_tipo_renov)

            'Consultar las líneas para la Renovación
            Dim dsLineas As DataSet = oConsulta.FP_ConsultarDatosRenov(p_nro_pedido, p_tipo_renov)

            If Not IsNothing(dsLineas) AndAlso dsLineas.Tables(0).Rows.Count > 0 Then

                For x As Integer = 0 To dsLineas.Tables(0).Rows.Count - 1

                    Dim telefono As String = CheckStr(dsLineas.Tables(0).Rows(x)(0))
                    Dim nroSEC As String = CheckStr(dsLineas.Tables(0).Rows(x)(1))
                    Dim fechaEntrega As String = CheckStr(dsLineas.Tables(0).Rows(x)(2))
                    Dim fechaActiva As String = CheckStr(dsLineas.Tables(0).Rows(x)(3))
                    Dim oficina As String = CheckStr(dsLineas.Tables(0).Rows(x)(4))
                    Dim equipo As String = CheckStr(dsLineas.Tables(0).Rows(x)(5))

                    Dim plazo_linea As String

                    If p_tipo_renov = "BUS" Then
                        plazo_linea = ConfigurationSettings.AppSettings("plazoLineaBUS")
                    Else
                        plazo_linea = ConfigurationSettings.AppSettings("plazoLineaB2E")
                    End If

                    objFileLog.Log_WriteLog(pathFile, strArchivo, p_nro_pedido & "- " & "-----------------------------------------------------------")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, p_nro_pedido & "- " & "   INP  Nro Telefono     : " & telefono)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, p_nro_pedido & "- " & "   INP  Nro SEC          : " & nroSEC)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, p_nro_pedido & "- " & "   INP  Fecha Entrega    : " & fechaEntrega)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, p_nro_pedido & "- " & "   INP  Fecha Activacion : " & fechaActiva)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, p_nro_pedido & "- " & "   INP  Oficina Venta    : " & oficina)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, p_nro_pedido & "- " & "   INP  Con Sin Equipo   : " & equipo)

                    'Grabar datos de la Renovacion en BSCS
                    'strOut = oConsulta.FP_GrabarRenovCorpBSCS(telefono, _
                    '                                            nroSEC, _
                    '                                            CDate(fechaEntrega), _
                    '                                            CDate(fechaActiva), _
                    '                                            oficina, _
                    '                                            equipo, _
                    '                                            plazo_linea, _
                    '                                            MsgError)

                    strOut = oConsulta.FP_GrabarRenovCorpBSCSNuevo(telefono, _
                                                                nroSEC, _
                                                               (fechaEntrega), _
                                                               (fechaActiva), _
                                                                oficina, _
                                                                equipo, _
                                                                plazo_linea, _
                                                                MsgError)

                    If Not strOut.Equals("0") Then
                        LineasError = LineasError & ";" & telefono
                    End If

                    objFileLog.Log_WriteLog(pathFile, strArchivo, p_nro_pedido & "- " & "   OUT  Codigo : " & strOut)
                    'INI PROY-140126
                    Dim MaptPath As String
                    MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                    MaptPath = "( Class : " & MaptPath & "; Function: GrabarRenovCorpBSCS)"
                    objFileLog.Log_WriteLog(pathFile, strArchivo, p_nro_pedido & "- " & "   OUT  Mensaje : " & CheckStr(MsgError) & MaptPath)
                    'FIN PROY-140126

                Next

                If Not LineasError = "" Then
                    LineasError = Right(LineasError, Len(LineasError) - 1)
                    MensajeFinal = "Ocurrió un Error en el registro en BSCS de la(s) siguiente(s) línea(s): " & LineasError

                    ''Session.Add("PagoBSCSRenovacionCorporativa", MensajeFinal)
                    AppPagoBSCSRenovacionCorporativa = MensajeFinal
                End If
            Else
                'INI PROY-140126
                Dim MaptPath As String
                MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                MaptPath = "( Class : " & MaptPath & "; Function: GrabarRenovCorpBSCS)"
                objFileLog.Log_WriteLog(pathFile, strArchivo, p_nro_pedido & "- " & "   ERROR : " & "No se encontró Datos de Líneas." & MaptPath)
                'FIN PROY-140126

            End If

        Catch ex As Exception
            'INI PROY-140126
            Dim MaptPath As String
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: GrabarRenovCorpBSCS)"
            objFileLog.Log_WriteLog(pathFile, strArchivo, p_nro_pedido & "- " & "   ERROR : " & ex.Message & MaptPath)
            'FIN PROY-140126

        Finally
            oConsulta = Nothing
            objFileLog.Log_WriteLog(pathFile, strArchivo, p_nro_pedido & "- " & "----------------FIN RENOVACION CORPORATIVA--------------")
        End Try
    End Sub

#End Region

    Private Function GenerarDetalleChipSap(ByVal nroPedido As String, ByRef arrayDetalle2 As String) As Boolean

        Dim arrayDetalle(18) As String
        'Dim oConsultaSap As New SAP_SIC_Pagos.clsPagos
        Dim nroLinea As String
        Dim Iccid As String
        Dim codMaterial As String
        Dim motivo As String = ConfigurationSettings.AppSettings("constCodMotivoReposicion")
        Dim puntoVenta As String = AppAlmacen
        Dim codVendedor As String = "" 'Session("CodVendedorSAP")
        Dim dsResult As New DataSet
        Dim dsResultLog As New DataSet
        Dim strIdentifyLog As String = nroPedido
        Dim blnResultado As Boolean
        Dim matev_Clasificacion As String = ""
        Dim j As Integer
        Dim matec_Material As String = ""

        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio GenerarDetalleChipSap")

        Try
            'dsResult = objPagos.Get_ConsultaPedido("", Session("ALMACEN"), nroPedido, "")
            dsResult = objConsultaMsSap.ConsultaPedido(nroPedido, "", "")
            If Not IsNothing(dsResult) Then
                If dsResult.Tables(1).Rows.Count > 0 Then
                    For j = 0 To dsResult.Tables(1).Rows.Count - 1
                        If Funciones.CheckStr(dsResult.Tables(1).Rows(j).Item("MATEC_TIPOMATERIAL")) = ConfigurationSettings.AppSettings("constChips") Then
                            nroLinea = Funciones.CheckStr(dsResult.Tables(1).Rows(j).Item("DEPEV_NROTELEFONO"))
                            Iccid = Funciones.CheckStr(dsResult.Tables(1).Rows(j).Item("SERIC_CODSERIE"))
                            codMaterial = Funciones.CheckStr(dsResult.Tables(1).Rows(j).Item("DEPEC_CODMATERIAL"))
                            codVendedor = Funciones.CheckStr(dsResult.Tables(0).Rows(0).Item("VENDEDOR"))
                            matev_Clasificacion = Funciones.CheckStr(dsResult.Tables(1).Rows(j).Item("MATEV_CLASIFICACION"))
                            matec_Material = Funciones.CheckStr(dsResult.Tables(1).Rows(j).Item("MATEC_TIPOMATERIAL"))
                        End If
                    Next
                    'nroLinea = Funciones.CheckStr(dsResult.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO"))
                    'Iccid = dsResult.Tables(1).Rows(0).Item("SERIC_CODSERIE")
                    'codMaterial = dsResult.Tables(1).Rows(0).Item("DEPEC_CODMATERIAL")
                    'codVendedor = dsResult.Tables(0).Rows(0).Item("VENDEDOR")
                    'matev_Clasificacion = Funciones.CheckStr(dsResult.Tables(1).Rows(0).Item("MATEV_CLASIFICACION"))
                    'If Funciones.CheckStr(ConfigurationSettings.AppSettings("constCodMatChipRepMiClaro")).IndexOf(codMaterial) < 0 Then
                    '    Return False
                    'End If
                End If
            End If

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp nroLinea : " & nroLinea)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Iccid Nuevo: " & Iccid)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp cod Material: " & codMaterial)

            Dim oConsultaSans As New NEGOCIO_SIC_SANS.SansNegocio
            Dim usuario_id As String = CurrentUser

            If matec_Material = ConfigurationSettings.AppSettings("constChips") Then
            arrayDetalle(0) = "" 'nrosolicitud
            arrayDetalle(1) = nroLinea '
            'arrayDetalle(2) = oConsultaSap.ConsultarIccid("", nroLinea, "", "", "", "")
            arrayDetalle(2) = oConsultaSans.ConsultarIccid("", nroLinea, "", codMaterial, "", "", matev_Clasificacion)
            'arrayDetalle(2) = oConsultaSans.ConsultarIccid("", nroLinea, "", codMaterial, Iccid, usuario_id) 'Serie_Actual
            arrayDetalle(3) = ""
            arrayDetalle(4) = puntoVenta
            arrayDetalle(5) = nroPedido 'Documento
            arrayDetalle(6) = motivo 'Motivo_Pedido
            arrayDetalle(7) = Iccid 'Serie_Nueva
            arrayDetalle(9) = codVendedor
            arrayDetalle(10) = ""
            arrayDetalle(11) = String.Format("{0:dd/MM/yyyy}", Now)
            arrayDetalle(12) = Format(Now, "H:mm:ss")
            arrayDetalle(13) = ConfigurationSettings.AppSettings("strEstadoSolNuevo")
            arrayDetalle(14) = "X"
            arrayDetalle(15) = ""
            arrayDetalle(16) = String.Format("{0:dd/MM/yyyy}", Now)
            arrayDetalle(17) = Format(Now, "H:mm:ss")
            arrayDetalle2 = Join(arrayDetalle, ";")
            ' Grabar Datos Pedido

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Iccid Anterior: " & arrayDetalle(2).ToString())
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp arrayDetalle : " & Join(arrayDetalle, ";"))

            blnResultado = True
            Else
                blnResultado = False
                arrayDetalle2 = ""
            End If

        Catch ex As Exception
            blnResultado = False
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Error: " & ex.Message.ToString())
        Finally
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "GenerarDetalleChipSap")
            'oConsultaSap = Nothing
        End Try
        Return blnResultado
    End Function

    Private Function IsContratoVacio(ByVal sNroContrato As String) As Boolean
        sNroContrato = sNroContrato.Replace("0", "")
        Return (sNroContrato.Trim().Equals(""))
    End Function

    Private Function GenerarArchivoTramaSGA(ByVal sNroContrato As String, ByRef nombreArchivo As String) As Boolean
        Dim objCajas As New COM_SIC_Cajas.clsCajas
        Dim dtDTH As DataSet
        Dim cadena1DTH, cadena6DTH, codErrorDTH, descErrorDTH As String

        Dim prefijoArchivo As String = ConfigurationSettings.AppSettings("PrefijoArchivoSGA").ToString()
        Dim strRutaDestino As String = ConfigurationSettings.AppSettings("strRutaDestinoDTH")
        Dim strRutaOrigen As String = ConfigurationSettings.AppSettings("strRutaOrigenDTH")

        Dim sb As StringBuilder = New StringBuilder
        Dim sw As StringWriter = New StringWriter(sb)

        objFileLog.Log_WriteLog(pathFile, strArchivo, sNroContrato & " - " & "Inicio ObtenerTramaSGA")
        objFileLog.Log_WriteLog(pathFile, strArchivo, sNroContrato & " - " & "inp sNroContrato:" & sNroContrato)
        dtDTH = objCajas.ObtenerTramaSGA(sNroContrato, cadena1DTH, cadena6DTH, codErrorDTH, descErrorDTH)
        objFileLog.Log_WriteLog(pathFile, strArchivo, sNroContrato & " - " & "out codErrorDTH:" & codErrorDTH)
        objFileLog.Log_WriteLog(pathFile, strArchivo, sNroContrato & " - " & "Fin ObtenerTramaSGA")

        If codErrorDTH.Equals("00") Then

            sw.Write(cadena1DTH)
            sw.Write(sw.NewLine)
            sw.Write(dtDTH.Tables(1).Rows(0).Item(0))
            sw.Write(sw.NewLine)
            sw.Write(dtDTH.Tables(2).Rows(0).Item(0))
            If dtDTH.Tables(0).Rows.Count > 0 Then
                For dth As Integer = 0 To dtDTH.Tables(0).Rows.Count - 1
                    sw.Write(sw.NewLine)
                    sw.Write(dtDTH.Tables(0).Rows(dth).Item(0))
                Next
            End If
            sw.Write(sw.NewLine)
            sw.Write(cadena6DTH)
            sw.Close()

            Dim strFecha As String = String.Format("{0:ddMMyy}", Now)
            Dim correlativoSGA As String = objCajas.getCorrelativoSGA()
            objFileLog.Log_WriteLog(pathFile, strArchivo, sNroContrato & " - " & "correlativoSGA:" & correlativoSGA)
            If correlativoSGA = "" Then
                correlativoSGA = sNroContrato
            End If
            nombreArchivo = prefijoArchivo & strFecha & String.Empty & correlativoSGA '### CAMBIO APK - SICAR
            saveFile(nombreArchivo, sb.ToString)
            objFileLog.Log_WriteLog(pathFile, strArchivo, sNroContrato & " - " & "Archivo DTH:" & nombreArchivo & ":" & sb.ToString())
            Dim mensajeFTP As String
            objFileLog.Log_WriteLog(pathFile, strArchivo, sNroContrato & " - " & "Inicio UploadArchivoFTP")
            objFileLog.Log_WriteLog(pathFile, strArchivo, sNroContrato & " - " & "inp strRutaOrigen:" & strRutaOrigen)
            objFileLog.Log_WriteLog(pathFile, strArchivo, sNroContrato & " - " & "inp nombreArchivo:" & nombreArchivo)
            objFileLog.Log_WriteLog(pathFile, strArchivo, sNroContrato & " - " & "inp strRutaDestino:" & strRutaDestino)
            mensajeFTP = UploadArchivoFTPSGA(strRutaOrigen, nombreArchivo, strRutaDestino)
            objFileLog.Log_WriteLog(pathFile, strArchivo, sNroContrato & " - " & "out mensajeFTP:" & mensajeFTP)
            objFileLog.Log_WriteLog(pathFile, strArchivo, sNroContrato & " - " & "Fin UploadArchivoFTP")
            If mensajeFTP <> "" Then
                'Response.Write("<script> alert('No se pudo enviar archivo de sincronización DTH.'); </script>")
                Return False
            Else
                Return True
            End If
        Else
            objFileLog.Log_WriteLog(pathFile, strArchivo, sNroContrato & " - " & "ERROR:" & descErrorDTH)
            Return False
        End If
    End Function

    Public Function saveFile(ByVal strNombreArchivoLog As String, ByVal strTexto As String) As String
        Dim objFSO As Scripting.FileSystemObject
        Dim objFile0 As Scripting.TextStream
        Dim Archivo As String
        Dim Resul As String = ""
        Dim strLOGPATH As String = ConfigurationSettings.AppSettings("strRutaOrigenDTH")

        Try
            Archivo = strLOGPATH & "\" & strNombreArchivoLog.Trim()
            objFSO = New Scripting.FileSystemObject
            If Not objFSO.FileExists(Archivo) Then
                objFile0 = objFSO.CreateTextFile(Archivo, True, False)
            Else
                objFSO.DeleteFile(Archivo)
                objFile0 = objFSO.CreateTextFile(Archivo, True, False)
            End If

            objFile0.Write(strTexto)

            objFile0.Close()
            objFile0 = Nothing
            objFSO = Nothing
        Catch ex As Exception
            objFSO = Nothing
            Resul = ex.Message
        End Try
        Return Resul
    End Function

    Private Function UploadArchivoFTPSGA(ByVal rutaOrigen As String, ByVal nombreArchivo As String, ByVal rutaDestino As String) As String

        Dim strMensaje As String = ""

        Try
            Dim pRutaArchivoOrigen As String
            Dim pRutaArchivoDestino As String
            Dim objFileFTP As New ControlProxyFTP

            pRutaArchivoOrigen = rutaOrigen & "\" & nombreArchivo
            pRutaArchivoDestino = rutaDestino & "/" & nombreArchivo
            objFileFTP.PutFileFTPSGA(pRutaArchivoOrigen, pRutaArchivoDestino)

        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, "ERROR UploadArchivoFTP: " & ex.Message.ToString())
            objFileLog.Log_WriteLog(pathFile, strArchivo, "ERROR UploadArchivoFTP: " & ex.StackTrace.ToString())
            strMensaje = ex.Message()
        End Try

        Return strMensaje

    End Function

    Private Function Tipificacion1(ByVal numeroTelefono As String, ByVal documentoSAP As String, ByVal usuario As String, ByVal strcadena As String, ByVal strtipoRenovacion As String) As String 'MOD: PROY 26210 - RMZ

        Dim strIdentifyLog As String = documentoSAP
        'INICIO PROY-140360-IDEA-46301 CONCATENAR_TIPO_OPERACION
        Dim P_COD_RESP As String = ""
        Dim P_MSG_RESP As String = ""
        Dim clsConsultaPagos As New WebComunes
        Dim clsConsultaPvuCuota As New COM_SIC_Activaciones.clsConsultaPvu
        Dim strCodigoPedido As Int64 = AppQpDocSap
        Dim dsAcuerdo As DataSet
        Dim objContrato As DataSet
        Dim dsPedido = objConsultaMsSap.ConsultaPedido(strCodigoPedido, "", "")
        objContrato = clsConsultaPvuCuota.ObtenerDrsap(strCodigoPedido, P_COD_RESP, P_MSG_RESP)
        Dim strContrato As String = objContrato.Tables(0).Rows(0).Item("ID_CONTRATO")
        dsAcuerdo = clsConsultaPvuCuota.ConsultaAcuerdoPCS(strContrato, DBNull.Value)
        Dim strNroSec As String = dsAcuerdo.Tables(0).Rows(0).Item("contn_numero_sec")
        Dim strCodTipoOperacion = dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION")
        Dim strDescTipoOperacion = dsPedido.Tables(0).Rows(0).Item("PEDIV_DESCTIPOOPERACION")
        'FIN PROY-140360-IDEA-46301 CONCATENAR_TIPO_OPERACION

        'Guardar Interaccion 
        Dim oInteraccion = New COM_SIC_INActChip.Interaccion

        If (strtipoRenovacion = "NORMAL") Then

        With oInteraccion
            '.OBJID_CONTACTO = objId
            .TELEFONO = numeroTelefono
                .TIPO = IIf(AppstrTipo_Prod_Des = "IFI", Funciones.CheckStr(oTipiConfiguration.KeyTipoIFI), ConfigurationSettings.AppSettings("CONS_RENOVACION_TIPO1"))
                .CLASE = IIf(AppstrTipo_Prod_Des = "IFI", Funciones.CheckStr(oTipiConfiguration.KeyClaseRenovacionIFIRegular), ConfigurationSettings.AppSettings("CONS_RENOVACION_CLASE1"))
                .SUBCLASE = IIf(AppstrTipo_Prod_Des = "IFI", Funciones.CheckStr(oTipiConfiguration.KeySubClaseRenovacionIFIRegular), ConfigurationSettings.AppSettings("CONS_RENOVACION_SUBCLASE1"))
            .METODO = ConfigurationSettings.AppSettings("CONS_RENOVACION_METODO")
            .TIPO_INTER = ConfigurationSettings.AppSettings("CONS_RENOVACION_TIPO_INTER")
            .AGENTE = ConfigurationSettings.AppSettings("CONS_RENOVACION_AGENTE")
            .USUARIO_PROCESO = ConfigurationSettings.AppSettings("CONS_RENOVACION_USUARIO")
            .FLAG_CASO = ConfigurationSettings.AppSettings("CONS_RENOVACION_FLAG")
            .RESULTADO = ConfigurationSettings.AppSettings("CONS_RENOVACION_RESULTADO")
            .HECHO_EN_UNO = ConfigurationSettings.AppSettings("CONS_RENOVACION_HECHO")
            .NOTAS = strcadena
        End With
        ElseIf (strtipoRenovacion = "ANTICIPADA") Then

            With oInteraccion
                '.OBJID_CONTACTO = objId
                .TELEFONO = numeroTelefono
                .TIPO = IIf(AppstrTipo_Prod_Des = "IFI", Funciones.CheckStr(oTipiConfiguration.KeyTipoIFI), ConfigurationSettings.AppSettings("CONS_RENOVACION_ANT_TIPO"))
                .CLASE = IIf(AppstrTipo_Prod_Des = "IFI", Funciones.CheckStr(oTipiConfiguration.KeyClaseRenovacionIFIAnticipada), ConfigurationSettings.AppSettings("CONS_RENOVACION_ANT_CLASE"))
                .SUBCLASE = IIf(AppstrTipo_Prod_Des = "IFI", Funciones.CheckStr(oTipiConfiguration.KeySubClaseRenovacionIFIAnticipada), ConfigurationSettings.AppSettings("CONS_RENOVACION_ANT_SUBCLASE"))
                .TIPO_CODIGO = IIf(AppstrTipo_Prod_Des = "IFI", Funciones.CheckStr(oTipiConfiguration.KeyCodTipoIFI), ConfigurationSettings.AppSettings("CONS_RENOVACION_ANT_CODTIP"))
                .CLASE_CODIGO = IIf(AppstrTipo_Prod_Des = "IFI", Funciones.CheckStr(oTipiConfiguration.KeyCodClaseRenovacionIFIAnticipada), ConfigurationSettings.AppSettings("CONS_RENOVACION_ANT_CODCLS"))
                .SUBCLASE_CODIGO = IIf(AppstrTipo_Prod_Des = "IFI", Funciones.CheckStr(oTipiConfiguration.KeyCodSubClaseRenovacionIFIAnticipada), ConfigurationSettings.AppSettings("CONS_RENOVACION_ANT_CODSUB"))
                .METODO = ConfigurationSettings.AppSettings("CONS_RENOVACION_METODO_NC")
                .AGENTE = ConfigurationSettings.AppSettings("CONS_RENOVACION_AGENTE")
                .USUARIO_PROCESO = ConfigurationSettings.AppSettings("CONS_RENOVACION_ANT_USER")
                .FLAG_CASO = ConfigurationSettings.AppSettings("CONS_RENOVACION_FLAG_NC")
                .RESULTADO = ConfigurationSettings.AppSettings("CONS_RENOVACION_RESULTADO_NC")
                .NOTAS = strcadena
            End With
        End If

        Dim oTipificacion As New COM_SIC_INActChip.clsTipificacion
        Dim flagInter As String
        Dim mensajeInter As String
        Dim idInteraccion As String


        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Inicio Region Renovacion de Equipo Postpago CAC ---")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Tipificacion 1 ---")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo Tipificacion1()")

        Try

            oTipificacion.CrearInteraccion(oInteraccion, idInteraccion, flagInter, mensajeInter)


            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Id Interaccion : " & idInteraccion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Flag Metodo : " & flagInter)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje : " & mensajeInter)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo Tipificacion1()")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Fin Tipificacion 1 ---")

            ' RegistraPlantilla(numeroTelefono, idInteraccion, documentoSAP)

            ' Inicio E77568
            ' PS_MejorasRenovEquiposCAC_2.0
            Dim objCajas As New COM_SIC_Cajas.clsCajas
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Inicio - Actualizar Numero de Interaccion en Venta Renovacion Postpago - SISACT ---")

            If (objCajas.ActualizarInteraccion_VentaRenovPostCAC(idInteraccion, documentoSAP)) Then
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Actualizó correctamente Numero de Interacción")
            End If

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Fin Actualizar Numero de Interaccion en Venta Renovacion Postpago - SISACT ---")
            ' PS_MejorasRenovEquiposCAC_2.0
            ' Fin E77568

            ' INICIO PROY-140360-IDEA-46301 REGISTRAR PLANTILLA

            If (HidNroCuotas = 1 And AppstrTipo_Prod_Des = "MOVIL" And (AppstrTipo_Opera_Cod = ConfigurationSettings.AppSettings("strDTVRenovacion")) And clsConsultaPagos.ValidarModalidadVentaContratoCode(strNroSec) And Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("PEDIC_TIPOVENTA")) = ConfigurationSettings.AppSettings("strTVPostpago")) Then
                RegistraPlantillaEnCuotaUno(numeroTelefono, idInteraccion, documentoSAP, strDescTipoOperacion)
            End If
            ' FIN PROY-140360-IDEA-46301
        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "error Tipificacion1:" & ex.Message.ToString())
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "error Tipificacion1:" & ex.StackTrace.ToString())
        End Try

        Return idInteraccion
    End Function

    Private Function Tipificacionchip(ByVal numeroTelefono As String, ByVal str4G As String, ByVal documentoSAP As String, ByVal usuario As String, ByVal strcadena As String) As String

        Dim strIdentifyLog As String = documentoSAP

        'Guardar Interaccion 
        Dim oInteraccion = New COM_SIC_INActChip.Interaccion
        Dim subclase As String

        If (str4G = "01") Then
            subclase = ConfigurationSettings.AppSettings("CONS_RENOVACION_SUBCLASE_CHIP_4G")
        Else
            subclase = ConfigurationSettings.AppSettings("CONS_RENOVACION_SUBCLASE_CHIP")
        End If

        With oInteraccion
            '.OBJID_CONTACTO = objId
            .TELEFONO = numeroTelefono
            .TIPO = ConfigurationSettings.AppSettings("CONS_RENOVACION_TIPO_CHIP")
            .CLASE = ConfigurationSettings.AppSettings("CONS_RENOVACION_CLASE_CHIP")
            .SUBCLASE = subclase
            .METODO = ConfigurationSettings.AppSettings("CONS_RENOVACION_METODO_CHIP")
            .TIPO_INTER = ConfigurationSettings.AppSettings("CONS_RENOVACION_TIPO_INTER_CHIP")
            .AGENTE = ConfigurationSettings.AppSettings("CONS_RENOVACION_AGENTE_CHIP")
            .USUARIO_PROCESO = ConfigurationSettings.AppSettings("CONS_RENOVACION_USUARIO_CHIP")
            .FLAG_CASO = ConfigurationSettings.AppSettings("CONS_RENOVACION_FLAG_CHIP")
            .RESULTADO = ConfigurationSettings.AppSettings("CONS_RENOVACION_RESULTADO_CHIP")
            .HECHO_EN_UNO = ConfigurationSettings.AppSettings("CONS_RENOVACION_HECHO_CHIP")
            .NOTAS = strcadena
        End With

        Dim oTipificacion As New COM_SIC_INActChip.clsTipificacion
        Dim flagInter As String
        Dim mensajeInter As String
        Dim idInteraccion As String


        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Inicio Region Renovacion de chip Postpago CAC ---")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Tipificacion chi ---")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo Tipificacion de chip()")

        Try

            oTipificacion.CrearInteraccion(oInteraccion, idInteraccion, flagInter, mensajeInter)


            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Id Interaccion : " & idInteraccion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Flag Metodo : " & flagInter)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje : " & mensajeInter)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo Tipificacion de chip()")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Fin Tipificacion chip ---")

            ' RegistraPlantilla(numeroTelefono, idInteraccion, documentoSAP)

            ' Inicio E77568
            ' PS_MejorasRenovEquiposCAC_2.0
            Dim objCajas As New COM_SIC_Cajas.clsCajas
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Inicio - Actualizar Numero de Interaccion en Venta Renovacion chip Postpago - SISACT ---")

            If (objCajas.ActualizarInteraccion_VentaRenovPostCAC(idInteraccion, documentoSAP)) Then
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Actualizó correctamente Numero de Interacción")
            End If

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Fin Actualizar Numero de Interaccion en Venta Renovacion Postpago - SISACT ---")
            ' PS_MejorasRenovEquiposCAC_2.0
            ' Fin E77568
        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "error Tipificacion1:" & ex.Message.ToString())
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "error Tipificacion1:" & ex.StackTrace.ToString())
        End Try

        Return idInteraccion
    End Function

    Private Function Tipificacion2(ByVal numeroTelefono As String, ByVal documentoSAP As String, ByVal usuario As String, ByVal strNotas As String) ' MOD: PROY 26210 - RMZ

        Dim objCajas As New COM_SIC_Cajas.clsCajas

        Dim strIdentifyLog As String = documentoSAP

        'Guardar Interaccion 
        Dim oInteraccion = New COM_SIC_INActChip.Interaccion
        With oInteraccion
            '.OBJID_CONTACTO = objId
            .TELEFONO = numeroTelefono
            .TIPO = ConfigurationSettings.AppSettings("CONS_RENOVACION_TIPO2")
            .CLASE = ConfigurationSettings.AppSettings("CONS_RENOVACION_CLASE2")
            .SUBCLASE = ConfigurationSettings.AppSettings("CONS_RENOVACION_SUBCLASE2")
            .METODO = ConfigurationSettings.AppSettings("CONS_RENOVACION_METODO")
            .TIPO_INTER = ConfigurationSettings.AppSettings("CONS_RENOVACION_TIPO_INTER")
            .AGENTE = usuario
            .USUARIO_PROCESO = ConfigurationSettings.AppSettings("CONS_RENOVACION_USUARIO")
            .FLAG_CASO = ConfigurationSettings.AppSettings("CONS_RENOVACION_FLAG")
            .RESULTADO = ConfigurationSettings.AppSettings("CONS_RENOVACION_RESULTADO")
            .HECHO_EN_UNO = ConfigurationSettings.AppSettings("CONS_RENOVACION_HECHO")
            ' Inicio E77568
            .NOTAS = ConfigurationSettings.AppSettings("TIPIFICACION2_NOTAS") & vbCrLf & strNotas ' MOD: PROY 26210 - RMZ
            ' Fin E77568
        End With
        Dim oTipificacion As New COM_SIC_INActChip.clsTipificacion
        Dim flagInter As String
        Dim mensajeInter As String
        Dim idInteraccion As String



        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Inicio Region Renovacion de Equipo Postpago CAC ---")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Tipificacion 2 ---")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo Tipificacion2()")

        Try
            oTipificacion.CrearInteraccion(oInteraccion, idInteraccion, flagInter, mensajeInter)

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Id Interaccion : " & idInteraccion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Flag Metodo : " & flagInter)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje : " & mensajeInter)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo Tipificacion2()")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Fin Tipificacion 2 ---")

            RegistraPlantilla(numeroTelefono, idInteraccion, documentoSAP)


            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Inicio - Actualizar Numero de Interaccion en Venta Renovacion Postpago - SISACT ---")

            If (objCajas.ActualizarInteraccion_VentaRenovPostCAC(idInteraccion, documentoSAP)) Then
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Actualizó correctamente Numero de Interacción")
            End If

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Fin Actualizar Numero de Interaccion en Venta Renovacion Postpago - SISACT ---")


        Catch ex As Exception
        End Try

    End Function

    Private Function Tipificacion3(ByVal numeroTelefono As String, ByVal documentoSAP As String, ByVal usuario As String, ByVal Notas As String) ' MOD: PROY 26210 - RMZ

        Dim strIdentifyLog As String = documentoSAP

        'Guardar Interaccion 
        Dim oInteraccion = New COM_SIC_INActChip.Interaccion
        With oInteraccion
            '.OBJID_CONTACTO = objId
            .TELEFONO = numeroTelefono
            .TIPO = ConfigurationSettings.AppSettings("CONS_RENOVACION_TIPO3")
            .CLASE = ConfigurationSettings.AppSettings("CONS_RENOVACION_CLASE3")
            .SUBCLASE = ConfigurationSettings.AppSettings("CONS_RENOVACION_SUBCLASE3")
            .METODO = ConfigurationSettings.AppSettings("CONS_RENOVACION_METODO")
            .TIPO_INTER = ConfigurationSettings.AppSettings("CONS_RENOVACION_TIPO_INTER")
            .AGENTE = usuario
            .USUARIO_PROCESO = ConfigurationSettings.AppSettings("CONS_RENOVACION_USUARIO")
            .FLAG_CASO = ConfigurationSettings.AppSettings("CONS_RENOVACION_FLAG")
            .RESULTADO = ConfigurationSettings.AppSettings("CONS_RENOVACION_RESULTADO")
            .HECHO_EN_UNO = ConfigurationSettings.AppSettings("CONS_RENOVACION_HECHO")
            .NOTAS = Notas 'ADD: PROY 26210 - RMZ

        End With
        Dim oTipificacion As New COM_SIC_INActChip.clsTipificacion
        Dim flagInter As String
        Dim mensajeInter As String
        Dim idInteraccion As String



        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Inicio Region Renovacion de Equipo Postpago CAC ---")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Tipificacion 3 ---")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo Tipificacion3()")

        Try
            oTipificacion.CrearInteraccion(oInteraccion, idInteraccion, flagInter, mensajeInter)

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Id Interaccion : " & idInteraccion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Flag Metodo : " & flagInter)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje : " & mensajeInter)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo Tipificacion3()")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Fin Tipificacion 3 ---")

            'RegistraPlantilla(numeroTelefono, idInteraccion, documentoSAP)

            ' Inicio E77568
            ' PS_MejorasRenovEquiposCAC_2.0
            Dim objCajas As New COM_SIC_Cajas.clsCajas
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Inicio - Actualizar Numero de Interaccion en Venta Renovacion Postpago - SISACT ---")

            If (objCajas.ActualizarInteraccion_VentaRenovPostCAC(idInteraccion, documentoSAP)) Then
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Actualizó correctamente Numero de Interacción")
            End If

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Fin Actualizar Numero de Interaccion en Venta Renovacion Postpago - SISACT ---")
            ' PS_MejorasRenovEquiposCAC_2.0
            ' Fin E77568
        Catch ex As Exception
        End Try

    End Function

    Private Function Tipificacion4(ByVal numeroTelefono As String, ByVal documentoSAP As String, ByVal usuario As String, ByVal strNotas As String) 'MOD: PROY 26210 - RMZ

        Dim strIdentifyLog As String = documentoSAP

        'Guardar Interaccion 
        Dim oInteraccion = New COM_SIC_INActChip.Interaccion
        With oInteraccion
            '.OBJID_CONTACTO = objId
            .TELEFONO = numeroTelefono
            .TIPO = IIf(AppstrTipo_Prod_Des = "IFI", Funciones.CheckStr(oTipiConfiguration.KeyTipoIFI), ConfigurationSettings.AppSettings("CONS_RENOVACION_TIPO4"))
            .CLASE = IIf(AppstrTipo_Prod_Des = "IFI", Funciones.CheckStr(oTipiConfiguration.KeyClaseAjusteOCCIFI), ConfigurationSettings.AppSettings("CONS_RENOVACION_CLASE4"))
            .SUBCLASE = IIf(AppstrTipo_Prod_Des = "IFI", Funciones.CheckStr(oTipiConfiguration.KeySubClaseAjusteOCCIFI), ConfigurationSettings.AppSettings("CONS_RENOVACION_SUBCLASE4"))
            .METODO = ConfigurationSettings.AppSettings("CONS_RENOVACION_METODO")
            .TIPO_INTER = ConfigurationSettings.AppSettings("CONS_RENOVACION_TIPO_INTER")
            .AGENTE = usuario
            .USUARIO_PROCESO = ConfigurationSettings.AppSettings("CONS_RENOVACION_USUARIO")
            .FLAG_CASO = ConfigurationSettings.AppSettings("CONS_RENOVACION_FLAG")
            .RESULTADO = ConfigurationSettings.AppSettings("CONS_RENOVACION_RESULTADO")
            .HECHO_EN_UNO = ConfigurationSettings.AppSettings("CONS_RENOVACION_HECHO")
            .NOTAS = strNotas 'ADD: PROY 26210 - RMZ

        End With
        Dim oTipificacion As New COM_SIC_INActChip.clsTipificacion
        Dim flagInter As String
        Dim mensajeInter As String
        Dim idInteraccion As String



        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Inicio Region Renovacion de Equipo Postpago CAC ---")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Tipificacion 4 ---")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo Tipificacion4()")

        Try
            oTipificacion.CrearInteraccion(oInteraccion, idInteraccion, flagInter, mensajeInter)

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Id Interaccion : " & idInteraccion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Flag Metodo : " & flagInter)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje : " & mensajeInter)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo Tipificacion4()")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Fin Tipificacion 4 ---")

            'RegistraPlantilla(numeroTelefono, idInteraccion, documentoSAP)

            ' Inicio E77568
            ' PS_MejorasRenovEquiposCAC_2.0
            Dim objCajas As New COM_SIC_Cajas.clsCajas
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Inicio - Actualizar Numero de Interaccion en Venta Renovacion Postpago - SISACT ---")

            If (objCajas.ActualizarInteraccion_VentaRenovPostCAC(idInteraccion, documentoSAP)) Then
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Actualizó correctamente Numero de Interacción")
            End If

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Fin Actualizar Numero de Interaccion en Venta Renovacion Postpago - SISACT ---")
            ' PS_MejorasRenovEquiposCAC_2.0
            ' Fin E77568

        Catch ex As Exception
        End Try

    End Function

    Function validaVentaEquipo(ByVal telefono As String, ByVal dtDetalle As DataTable) As Boolean
        Dim i As Integer
        Dim blnRespuesta As Boolean
        Dim strIdentifyLog As String = telefono
        Try
            For i = 0 To dtDetalle.Rows.Count - 1
                'Dim strEquipo As String = dtDetalle.Rows(i).Item("ARTICULO")
                'Dim strNumero As String = FormatoTelefono(dtDetalle.Rows(i).Item("DEPEV_NROTELEFONO"))
                Dim strEquipo As String = dtDetalle.Rows(i).Item("MATEV_CLASIFICACION")
                Dim strNumero As String = FormatoTelefono(Funciones.CheckStr(dtDetalle.Rows(i).Item("DEPEV_NROTELEFONO")))

                If telefono = "" Then ' al menos un equipo
                    If Not strEquipo.StartsWith("PS") Then
                        blnRespuesta = True
                        Exit For
                    End If
                Else
                    If telefono = strNumero And Not strEquipo.StartsWith("PS") Then
                        blnRespuesta = True
                        Exit For
                    End If
                End If
            Next
        Catch ex As Exception
            'INI PROY-140126
            Dim MaptPath As String
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: validaVentaEquipo)"
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR validaVentaEquipo: " & ex.Message.ToString() & MaptPath)
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: validaVentaEquipo)"
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR validaVentaEquipo: " & ex.StackTrace.ToString() & MaptPath)
            'FIN PROY-140126
        End Try

        Return blnRespuesta
    End Function

    Function FormatoTelefonoSinCeros(ByVal telefono)
        Dim aux
        aux = telefono
        If aux <> "" Then
            Dim longitud
            Dim posicion
            longitud = Len(telefono)
            If longitud > 0 Then
                'posicion = 1
                Do While InStr(1, aux, "0") = 1
                    aux = Mid(aux, 2, Len(aux))
                Loop
            End If
        End If
        If aux = "" Then
            FormatoTelefonoSinCeros = telefono
        Else
            FormatoTelefonoSinCeros = aux
        End If
    End Function


    Private Function ListaParamPromocion(ByVal strGrupo As String, ByVal strIdentifyLog As String) As String

        Dim strListMateriales As String = ""

        Try
            Dim dsParam As DataSet
            Dim list_pre As String
            Dim objSicarDB As New COM_SIC_Cajas.clsCajas
            Dim promocion As String
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio FP_ConsultaParametros Promocion")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     Inp: " & strGrupo)
            dsParam = objSicarDB.FP_ConsultaParametros(strGrupo)
            objSicarDB = Nothing
            If Not IsNothing(dsParam) AndAlso dsParam.Tables(0).Rows.Count > 0 Then
                For idx As Integer = 0 To dsParam.Tables(0).Rows.Count - 1
                    strListMateriales += "|" & dsParam.Tables(0).Rows(idx).Item("SPARV_KEY") & ";" & _
                                                dsParam.Tables(0).Rows(idx).Item("SPARV_VALUE") & ";" & _
                                                dsParam.Tables(0).Rows(idx).Item("SPARV_GRUPO")
                Next
            End If

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     OUT CantidadRegistros:  " & Funciones.CheckStr(dsParam.Tables(0).Rows.Count))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin FP_ConsultaParametros promocion")

        Catch ex As Exception
            'INI PROY-140126
            Dim MaptPath As String
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: ListaParamPromocion)"
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   OUT  ERROR : " & ex.Message.ToString() & MaptPath)
            'FIN PROY-140126

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "---------------Fin FP_ConsultaParametros promocion-----------")

        End Try

        Return strListMateriales

    End Function
    Private Function Get_CodPromocion(ByVal strListaPrecio As String, ByVal strListPromocion As String, ByVal strIdentifyLog As String) As String

        Dim arrListPromocion As String()
        Dim arrMaterial As String()
        Dim codPromocion As String = ""

        Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "---------------Inicio Get_CodPromocion-----------")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   INP  strListPromocion : " & strListPromocion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   INP  strListaPrecio : " & strListaPrecio)

            arrListPromocion = strListPromocion.Split("|")

            If arrListPromocion.Length > 0 Then
                For idx As Integer = 0 To arrListPromocion.Length - 1
                    arrMaterial = arrListPromocion(idx).Split(";")
                    If arrMaterial.Length > 2 Then
                        If strListaPrecio.ToUpper() = arrMaterial(0).ToUpper() Then
                            codPromocion = arrMaterial(1).ToString()
                            Exit For
                        End If
                    End If
                Next
            End If

            If (codPromocion = "") Then
                codPromocion = "0000"
            End If

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   OUT  codPromocion : " & codPromocion)
        Catch ex As Exception
            'INI PROY-140126
            Dim MaptPath As String
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: Get_CodPromocion)"
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   OUT  ERROR : " & ex.Message.ToString() & MaptPath)
            'FIN PROY-140126

        Finally
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "---------------Fin Get_CodPromocion-----------")
        End Try

        Return codPromocion

    End Function

    'Private Sub inicializaControles()
    '    objFileLog.Log_WriteLog(pathFile, strArchivo, "Inicio proceso de inicializaciòn de controles.")
    '    Dim dtVias As DataTable
    '    dtVias = New DataTable
    '    objFileLog.Log_WriteLog(pathFile, strArchivo, "Inicia al método: VerificarVias ")
    '    dtVias = VerificarVias(dsFormaPago) ''CALLBAK QUE REVISA LA FILA
    '    objFileLog.Log_WriteLog(pathFile, strArchivo, "Fin al método: VerificarVias ")

    '    'PROY-33188 -IDEA-54658 - INICIO'
    '    If (hidCupon.Value = "1") Then
    '        txtMonto1.Attributes.Add("onChange", "javascript:f_Recalcular(6)")
    '        txtMonto2.Attributes.Add("onChange", "javascript:f_Recalcular(2)")
    '        txtMonto3.Attributes.Add("onChange", "javascript:f_Recalcular(3)")
    '        txtMonto4.Attributes.Add("onChange", "javascript:f_Recalcular(4)")
    '        txtMonto5.Attributes.Add("onChange", "javascript:f_Recalcular(5)")
    '    Else
    '    txtMonto1.Attributes.Add("onChange", "javascript:f_Recalcular(1)")
    '    txtMonto2.Attributes.Add("onChange", "javascript:f_Recalcular(2)")
    '    txtMonto3.Attributes.Add("onChange", "javascript:f_Recalcular(3)")
    '    txtMonto4.Attributes.Add("onChange", "javascript:f_Recalcular(4)")
    '    txtMonto5.Attributes.Add("onChange", "javascript:f_Recalcular(5)")
    '    End If

    '    'PROY-33188-IDEA-54658 - FIN'

    '    txtMonto1.Attributes.Add("onkeypress", "javascript:ValidaNumero(this)")
    '    txtMonto2.Attributes.Add("onkeypress", "javascript:ValidaNumero(this)")
    '    txtMonto3.Attributes.Add("onkeypress", "javascript:ValidaNumero(this)")
    '    txtMonto4.Attributes.Add("onkeypress", "javascript:ValidaNumero(this)")
    '    txtMonto5.Attributes.Add("onkeypress", "javascript:ValidaNumero(this)")

    '    txtRecibidoPen.Attributes.Add("onkeypress", "javascript:ValidaNumero(this)")
    '    txtRecibidoUsd.Attributes.Add("onkeypress", "javascript:ValidaNumero(this)")
    '    'PROY BUYBACK - INICIO'
    '    If (hidCupon.Value = "1") Then
    '        txtRecibidoPen.Attributes.Add("onChange", "javascript:CalculoVueltoCV()")
    '        txtRecibidoUsd.Attributes.Add("onChange", "javascript:CalculoVueltoCV()")
    '    Else
    '    txtRecibidoPen.Attributes.Add("onChange", "javascript:CalculoVuelto()")
    '    txtRecibidoUsd.Attributes.Add("onChange", "javascript:CalculoVuelto()")
    '    End If
    '    'PROY BUYBACK - FIN'


    '    'PROY BUYBACK - INICIO'
    '    If (hidCupon.Value = "1") Then
    '        Dim dtCuponVale As New DataTable
    '        dtCuponVale.Columns.Add("CCINS")
    '        dtCuponVale.Columns.Add("VTEXT")
    '        Dim drTipoDoc As DataRow = dtCuponVale.NewRow()
    '        drTipoDoc("CCINS") = "ZBUY"
    '        drTipoDoc("VTEXT") = "CUPON-BUYBACK"
    '        dtCuponVale.Rows.Add(drTipoDoc)

    '        cboLoadCV(dtCuponVale, cboTipDocumento1)
    '        cboLoad(dtVias, cboTipDocumento2)
    '        cboLoad(dtVias, cboTipDocumento3)
    '        cboLoad(dtVias, cboTipDocumento4)
    '        cboLoad(dtVias, cboTipDocumento5)
    '    Else
    '    cboLoad(dtVias, cboTipDocumento1)
    '    cboLoad(dtVias, cboTipDocumento2)
    '    cboLoad(dtVias, cboTipDocumento3)
    '    cboLoad(dtVias, cboTipDocumento4)
    '    cboLoad(dtVias, cboTipDocumento5)
    '    End If
    '    'PROY BUYBACK - FIN'

    'End Sub

    Private Sub InsertarPlanRoaming(ByVal NroPedido As String)
        Dim dsLineas As New DataSet
        Dim oConsulta As New COM_SIC_Cajas.clsCajas

        Dim oLog As New SrvPago_Log
        Dim nameFile As String = "LogProcesoRoaming"
        Dim pathFile As String = ConfigurationSettings.AppSettings("constRutaLogRegistroDOL")
        Dim strArchivo As String = oLog.Log_CrearNombreArchivo(nameFile)
        Dim strIdentifyLog As String = NroPedido

        Try

            oLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Registro Roaming")
            oLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "---------------------------------")
            oLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Input  --> " & "NroPedido: " & NroPedido)

            'Consulta de Nro de Linea
            dsLineas = oConsulta.ObtenerLineasRoaming(NroPedido)

            If Not IsNothing(dsLineas) Then

                For i As Integer = 0 To dsLineas.Tables(0).Rows.Count - 1

                    Dim linea As String = dsLineas.Tables(0).Rows(i).Item("ROAMV_NRO_LINEA")
                    Dim plan As String = dsLineas.Tables(0).Rows(i).Item("ROAMV_COD_PLAN")

                    oLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Input  --> " & "Linea: " & linea)
                    oLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Input  --> " & "Plan: " & plan)

                    Dim mensaje As String = oConsulta.InsertarLineasRoaming(linea, plan)

                    oLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Output --> " & "Mensaje: " & mensaje)
                Next
            End If
        Catch ex As Exception
            'INI PROY-140126
            Dim MaptPath As String
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: InsertarPlanRoaming)"
            oLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Output --> " & "Error: " & ex.Message & MaptPath)
            'FIN PROY-140126

        Finally
            oConsulta = Nothing
            dsLineas = Nothing
            oLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Registro Roaming")
        End Try

    End Sub

    Private Function RegistraPlantilla(ByVal numeroTelefono As String, ByVal idInteraccion As String, ByVal nroDocSap As String) As Boolean
        Dim strIdentifyLog As String = nroDocSap
        Try
            Dim contactoId As Int64
            Dim dsCliente As DataSet
            Dim oTipificacion As New COM_SIC_INActChip.clsTipificacion

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio RegistraPlantilla()")
            dsCliente = oTipificacion.ConsultaCliente(numeroTelefono, "", contactoId, CInt("1"), "", "")
            Dim objIdContacto As String
            Dim nroDocCliente As String
            Dim nombreCliente As String
            Dim apellidoCliente As String

            If dsCliente.Tables(0).Rows.Count > 0 Then
                objIdContacto = dsCliente.Tables(0).Rows(0).Item("OBJID_CONTACTO")
                nroDocCliente = dsCliente.Tables(0).Rows(0).Item("NRO_DOC")
                nombreCliente = dsCliente.Tables(0).Rows(0).Item("NOMBRES")
                apellidoCliente = dsCliente.Tables(0).Rows(0).Item("APELLIDOS")
            Else
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "No se pudo recuperar datos del cliente")
            End If

            Dim oPlantilla As New COM_SIC_INActChip.PlantillaInteraccion
            oPlantilla.X_FIRST_NAME = nombreCliente
            oPlantilla.X_LAST_NAME = apellidoCliente
            oPlantilla.X_DOCUMENT_NUMBER = nroDocCliente
            oPlantilla.X_ADJUSTMENT_REASON = "RETENIDO"
            ' Motivo
            oPlantilla.X_OPERATION_TYPE = "A solicitud del Cliente"
            ' Acción
            oPlantilla.X_REGISTRATION_REASON = "Renovación"
            ' CAC
            oPlantilla.X_INTER_15 = CStr(AppOFICINA)
            ' Nro. servicio
            oPlantilla.X_CLARO_NUMBER = numeroTelefono

            Dim mensajeInter As String
            Dim sflagInter As String
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo InsertarPlantilla()")
            ' oTipificacion.InsertarPlantillaInteraccion(oPlantilla, idInteraccion, flagInter, mensajeInter)
            oTipificacion.InsertarPlantillaInteraccion(oPlantilla, idInteraccion, sflagInter, mensajeInter)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Id Interaccion : " & idInteraccion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "sflagInter: " & sflagInter)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "mensajeInter: " & mensajeInter)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo InsertarPlantilla()")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "fIN RegistraPlantilla()")

            If sflagInter = "NO OK" Then
                Return False
            Else
                Return True
            End If

        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR RegistraPlantilla: " & ex.Message.ToString())
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR RegistraPlantilla: " & ex.StackTrace.ToString())

            Return False
        End Try

    End Function
'PROY-140360 Inicio
    Private Function RegistraPlantillaEnCuotaUno(ByVal numeroTelefono As String, ByVal idInteraccion As String, ByVal nroDocSap As String, ByVal strTipoOperacion As String) As Boolean
        Dim strIdentifyLog As String = nroDocSap & "-" & "PROY-140360-IDEA-46301"
        Dim dsCliente As DataSet
        Dim contactoId As Int64
        Dim oTipificacion As New COM_SIC_INActChip.clsTipificacion
        dsCliente = oTipificacion.ConsultaCliente(numeroTelefono, "", contactoId, CInt("1"), "", "")
        Dim objIdContacto As String
        Dim nroDocCliente As String
        Dim nombreCliente As String
        Dim apellidoCliente As String

        If dsCliente.Tables(0).Rows.Count > 0 Then
            objIdContacto = dsCliente.Tables(0).Rows(0).Item("OBJID_CONTACTO")
            nroDocCliente = dsCliente.Tables(0).Rows(0).Item("NRO_DOC")
            nombreCliente = dsCliente.Tables(0).Rows(0).Item("NOMBRES")
            apellidoCliente = dsCliente.Tables(0).Rows(0).Item("APELLIDOS")
        Else
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "No se pudo recuperar datos del cliente")
        End If

        Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio RegistraPlantillaEnCuotaUno()")
            Dim oPlantilla As New COM_SIC_INActChip.PlantillaInteraccion
            oPlantilla.X_FIRST_NAME = nombreCliente
            oPlantilla.X_LAST_NAME = apellidoCliente
            oPlantilla.X_DOCUMENT_NUMBER = nroDocCliente
            oPlantilla.X_REGISTRATION_REASON = strTipoOperacion
            oPlantilla.X_INTER_15 = CStr(AppOFICINA)
            oPlantilla.X_CLARO_NUMBER = numeroTelefono

            Dim mensajeInter As String
            Dim sflagInter As String
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo InsertarPlantillaInteraccion()")
            oTipificacion.InsertarPlantillaInteraccion(oPlantilla, idInteraccion, sflagInter, mensajeInter)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Id Interaccion : " & idInteraccion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "sflagInter: " & sflagInter)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "mensajeInter: " & mensajeInter)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo RegistraPlantillaEnCuotaUno()")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "fIN RegistraPlantillaEnCuotaUno()")

            If sflagInter = "NO OK" Then
                Return False
            Else
                Return True
            End If

        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR RegistraPlantillaEnCuotaUno: " & ex.Message.ToString())
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR RegistraPlantillaEnCuotaUno: " & ex.StackTrace.ToString())
        End Try

    End Function
'Proy-140360 fin
    Private Function GenerarSot(ByVal nroSec As String, ByVal strDocSap As String) As SGAResponseVenta
        Dim oConsulta As New COM_SIC_Activaciones.clsBDSiscajas
        Dim oTransaccion As New SGATransaction
        Dim oVenta As New SGAVenta
        Dim oListaServicios As New ArrayList
        Dim oListaPromocion As New ArrayList
        Dim idLog As String = strDocSap & " - " & nroSec
        Dim oSGAResponseTrs As New SGAResponseVenta
        oSGAResponseTrs.codRepuesta = -1
        Dim cadenaRegVenta, cadenaServicio, cadenaPromocion As String

        Try

            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "Inicio ObtenerDatosVentaSGA")
            oConsulta.ObtenerDatosVentaSGA(nroSec, oVenta, oListaServicios, oListaPromocion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "Fin ObtenerDatosVentaSGA")

            oVenta.usuarioRegistro = CurrentUser
            cadenaRegVenta = oTransaccion.ObtenerCadenaRegVentaSGA(oVenta)
            cadenaServicio = oTransaccion.ObtenerCadenaServicioSGA(oListaServicios)
            cadenaPromocion = oTransaccion.ObtenerCadenaPromocionSGA(oListaPromocion)

            Dim oAudit As New ItemGenerico
            oAudit.CODIGO = nroSec
            oAudit.DESCRIPCION = CheckStr(ConfigurationSettings.AppSettings("constAplicacion"))
            oAudit.DESCRIPCION2 = CurrentTerminal

            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "Inicio GenerarSot")
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "WS    : " & ConfigurationSettings.AppSettings("constSGATransaccion_Url"))
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "Method: " & "procesarGeneracionProy")
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "inp cadenaRegVenta: " & cadenaRegVenta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "inp cadenaServicio: " & cadenaServicio)
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "inp cadenaPromocion: " & cadenaPromocion)

            oSGAResponseTrs = oTransaccion.GenerarSot(cadenaRegVenta, cadenaServicio, cadenaPromocion, oAudit)

            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "out codRepuesta: " & oSGAResponseTrs.codRepuesta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "out msgRepuesta: " & oSGAResponseTrs.msgRepuesta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "out codsolot: " & oSGAResponseTrs.codsolot)
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "out numslc: " & oSGAResponseTrs.numslc)
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "out fecagenda: " & oSGAResponseTrs.fecagenda)
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "out hora: " & oSGAResponseTrs.hora)
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "Fin GenerarSot")
        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "ERROR GenerarSot: " & ex.Message.ToString())
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "ERROR GenerarSot: " & ex.StackTrace.ToString())

            Dim oAnular As New clsAnulaciones
            Dim oSGAResponse As New SGAResponseVenta
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "Inicio RollBackSot")
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "WS    : " & ConfigurationSettings.AppSettings("constSGATransaccion_Url"))
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "Method: " & "anularSot")
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "inp nroSec: " & nroSec)
            oSGAResponse = oAnular.RollBackSot(nroSec, strDocSap, CurrentTerminal)
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "out codRepuesta: " & oSGAResponse.codRepuesta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "out msgRepuesta: " & oSGAResponse.msgRepuesta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "Fin RollBackSot")
            Throw New Exception("No se pudo generar la SOT.")
        End Try
        Return oSGAResponseTrs
    End Function

    ' Inicio E7756
    ' Inicio PS - Automatización de canje y nota de crédito
    ' Si el número de la Nota de Crédito puede estar ingresado de manera automática en la Boleta de Venta, 
    ' si la nota de crédito fue cancelada antes.
    Private Sub LeerReferenciaPuntosCC(ByVal nroDocSap As String)
        Dim strIdentifyLog As String = nroDocSap

        Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Inicio LeerReferenciaPuntosCC()")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   IN nroDocSap: " & nroDocSap)

            Dim objCajas As New COM_SIC_Cajas.clsCajas
            Dim dt As DataTable

            dt = objCajas.ListarXDocSAP(nroDocSap)
            If dt.Rows.Count > 0 Then
                'txtNotaCred.Text = Funciones.CheckStr(dt.Rows(0).Item("NRO_NOTA_CREDITO")).Trim
            End If

            'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   OUT Nro. Referencia: " & txtNotaCred.Text)
        Catch ex As Exception
            'INI PROY-140126
            Dim MaptPath As String
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: LeerReferenciaPuntosCC)"
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   OUT ERROR : " & ex.Message.ToString() & MaptPath)
            'FIN PROY-140126

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   OUT ERROR : " & ex.StackTrace.ToString())
        Finally
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Fin LeerReferenciaPuntosCC()")
        End Try
    End Sub

    Private Sub AlertaTitularidad(ByVal dsPedido As DataSet, ByVal nroDocSap As String)
        Dim dtCabecera As New DataTable
        Dim dtDetalle As New DataTable
        Dim idLog As String = CurrentUser & " - " & nroDocSap
        objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "Inicio AlertaTitularidad")
        Try
            dtCabecera = dsPedido.Tables(0)
            dtDetalle = dsPedido.Tables(1)

            'Dim sTipoOperacion As String = dtCabecera.Rows(0).Item("CLASE_VENTA")              '**Linea anterior **'
            Dim sTipoOperacion As String = dtCabecera.Rows(0).Item("PEDIC_CODTIPOOPERACION")    '**Linea actual, consulta a MSSAP **'
            If sTipoOperacion = ConfigurationSettings.AppSettings("strDTVAlta") Then
                Dim oAlertaWS As New COM_SIC_Activaciones.clsActivacion
                Dim respuesta As String
                Dim codigoRespuesta As String = ""
                Dim mensajeRespuesta As String = ""

                Dim tipoDoc, nroDoc, codMensaje, tipoProducto, descProducto As String

                Dim oAudit As New ItemGenerico
                oAudit.CODIGO = nroDocSap
                oAudit.CODIGO2 = CurrentTerminal
                oAudit.DESCRIPCION = ConfigurationSettings.AppSettings("constAplicacion")
                oAudit.DESCRIPCION2 = CurrentUser

                'Dim sTipoVenta As String = dtCabecera.Rows(0).Item("TIPO_VENTA")        'Error
                Dim sTipoVenta As String = dtCabecera.Rows(0).Item("PEDIC_TIPOVENTA")        'Cambio, 14.01.2015


                If sTipoVenta = ConfigurationSettings.AppSettings("strTVPrepago") Then
                    sTipoVenta = ConfigurationSettings.AppSettings("VentaPrepago_Descrip")
                ElseIf sTipoVenta = ConfigurationSettings.AppSettings("strTVPostpago") Then
                    sTipoVenta = ConfigurationSettings.AppSettings("VentaPostpago_Descrip")
                End If

                Dim listaTipoDoc As New ArrayList
                Dim oMaestro As New COM_SIC_Activaciones.clsBDSiscajas
                listaTipoDoc = oMaestro.ListaTipoDocumento("")
                objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "AlertaTitularidad=> Consulta el tipo de documento del cliente")
                objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "tipoDoc" & Format(Funciones.CheckStr(dtCabecera.Rows(0).Item("CLIEC_TIPODOCCLIENTE")), "00"))
                'tipoDoc = Format(CheckInt64(dtCabecera.Rows(0)("CLIEC_TIPODOCCLIENTE")), "00")
                tipoDoc = Format(Funciones.CheckStr(dtCabecera.Rows(0).Item("CLIEC_TIPODOCCLIENTE")), "00")
                For Each item As ItemGenerico In listaTipoDoc
                    If tipoDoc = item.CODIGO Then
                        tipoDoc = item.CODIGO2
                        Exit For
                    End If
                Next

                Try
                    nroDoc = Funciones.CheckStr(dtCabecera.Rows(0)("CLIEV_NRODOCCLIENTE"))
                    codMensaje = ConfigurationSettings.AppSettings("WSAlertaNotificacion_codMensajes")
                    tipoProducto = sTipoVenta
                    descProducto = ConfigurationSettings.AppSettings("WSAlertaNotificacion_descProducto")
                Catch ex As Exception
                    objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - Error al recuperar el nùmero de doc del cliente.")
                End Try

                Dim codMaterial As String
                For i As Integer = 0 To dtDetalle.Rows.Count - 1
                    'codMaterial = CheckStr(dtDetalle.Rows(i)("ARTICULO"))
                    codMaterial = dtDetalle.Rows(i).Item("MATEC_TIPOMATERIAL")
                    'If codMaterial.StartsWith("TV0004") Then
                    If codMaterial = ConfigurationSettings.AppSettings("constChips") Then
                        objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "Inicio alertaNotificacion")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "inp tipoDoc: " & tipoDoc)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "inp nroDoc: " & nroDoc)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "inp codMensaje: " & codMensaje)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "inp tipoProducto: " & tipoProducto)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "inp descProducto: " & descProducto)
                        Try
                            respuesta = oAlertaWS.alertaNotificacion(tipoDoc, nroDoc, codMensaje, tipoProducto, descProducto, oAudit, codigoRespuesta, mensajeRespuesta)
                        Catch ex As Exception
                            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "out respuesta: " & respuesta)
                        End Try
                        objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "out respuesta: " & respuesta)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "out codigoRespuesta: " & codigoRespuesta)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "out mensajeRespuesta: " & mensajeRespuesta)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "Fin alertaNotificacion")
                    End If
                Next
            End If
        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "ERROR AlertaTitularidad: " & ex.Message.ToString() & " " & ex.StackTrace.ToString())
        Finally
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "Fin AlertaTitularidad")
        End Try

    End Sub

    Private Sub RenovacionModemPrepago(ByVal dsPedido As DataSet, ByVal nroDocSap As String, ByVal strNumAsignado As String)

        Dim idLog As String = nroDocSap
        Dim dsParam As DataSet
        Dim objSicarDB As New COM_SIC_Cajas.clsCajas
        Dim oActivacion As New COM_SIC_Activaciones.clsActivacion

        Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "Inicio RenovacionModemPrepago")
            Dim strGrupo As String = ConfigurationSettings.AppSettings("codGrupoRenovacionPlanModem")

            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "Inicio FP_ConsultaParametros")
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "Inp: " & strGrupo)
            dsParam = objSicarDB.FP_ConsultaParametros(strGrupo)
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "OUT CantidadRegistros:  " & Funciones.CheckStr(dsParam.Tables(0).Rows.Count))
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "Fin FP_ConsultaParametros")

            Dim sTelefono, sCodMaterial, codigoPromocion As String
            For i As Integer = 0 To dsPedido.Tables(1).Rows.Count - 1
                'sTelefono = FormatoTelefono(dsPedido.Tables(1).Rows(i).Item("DEPEV_NROTELEFONO"))
                sTelefono = FormatoTelefono(Funciones.CheckStr(dsPedido.Tables(1).Rows(i).Item("DEPEV_NROTELEFONO")))

                'sCodMaterial = dsPedido.Tables(1).Rows(i).Item("ARTICULO")
                sCodMaterial = Funciones.CheckStr(dsPedido.Tables(1).Rows(i).Item("DEPEC_CODMATERIAL"))

                codigoPromocion = ""

                If Not IsNothing(dsParam) AndAlso dsParam.Tables(0).Rows.Count > 0 Then
                    For idx As Integer = 0 To dsParam.Tables(0).Rows.Count - 1
                        If Funciones.CheckStr(dsParam.Tables(0).Rows(idx).Item("SPARV_KEY")).Equals(sCodMaterial) Then
                            codigoPromocion = Funciones.CheckStr(dsParam.Tables(0).Rows(idx).Item("SPARV_VALUE"))
                            Exit For
                        End If
                    Next
                End If
                If codigoPromocion <> "" Then
                    Dim audit As New ItemGenerico
                    audit.CODIGO = nroDocSap
                    audit.CODIGO2 = ConfigurationSettings.AppSettings("constAplicacion")
                    audit.DESCRIPCION = CurrentUser
                    audit.DESCRIPCION2 = CurrentTerminal

                    Dim codigoRespuesta As String = ""
                    Dim mensajeRespuesta As String = ""

                    sTelefono = CheckStr(ConfigurationSettings.AppSettings("codTelefonicoPeru")) & sTelefono
                    objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "Inicio renovarPlanModem WS: " & ConfigurationSettings.AppSettings("WSRenovacionPlanModem_url"))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "inp  sTelefono: " & sTelefono)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "inp  codigoPromocion: " & codigoPromocion)

                    codigoRespuesta = oActivacion.renovarPlanModem(sTelefono, codigoPromocion, audit, mensajeRespuesta)

                    objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "out  codigoRespuesta: " & codigoRespuesta)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "out  mensajeRespuesta: " & mensajeRespuesta)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "Fin renovarPlanModem")

                    If codigoRespuesta <> ConfigurationSettings.AppSettings("WSRenovacionPlanModem_codExito") Then
                        If CheckInt64(codigoRespuesta) > 0 Then
                            AppstrMensajeCaja = mensajeRespuesta
                        Else
                            AppstrMensajeCaja = ConfigurationSettings.AppSettings("msgErrorRenovacionPlanModem")
                        End If

                        Dim obAnular As New clsAnulaciones
                        Dim strVias() As String = {""}
                        Dim strFecha As String = Format(Day(Now), "00") & "/" & Format(Month(Now), "00") & "/" & Format(Year(Now), "0000")

                        'ANULAR PAGO 
                        'objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "Inicio AnulacionDePago")
                        'objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "    IN " & " strNroPedidoSAP: " & nroDocSap)
                        'objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "    IN " & " strDocSunat: " & strNumAsignado)
                        'objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "    IN " & " CANAL: " & Session("CANAL"))
                        'objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "    IN " & " ALMACEN: " & Session("ALMACEN"))
                        'objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "    IN " & " USUARIO: " & Session("USUARIO"))
                        ''obAnular.AnulacionDePagoSAP(nroDocSap, strNumAsignado, strFecha, strVias, Session("CANAL"), Session("ALMACEN"), Session("USUARIO"), strVias)
                        'objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "Fin AnulacionDePago")

                        ''ANULA PEDIDO 
                        'objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "Inicio AnularPedido")
                        'objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & " IN " & " NroDocSap " & nroDocSap)
                        'objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & " IN " & " ALMACEN " & Session("ALMACEN"))
                        'objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & " IN " & " USUARIO " & Session("USUARIO"))
                        ''Dim strCodAnulacion As String = AnularPedido(nroDocSap, Session("ALMACEN"), Session("USUARIO"))
                        ''bjFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & " OUT " & " strCodAnulacion " & strCodAnulacion)
                        'objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & " OUT " & " strMensajeCajaRec " & Session("strMensajeCajaRec"))
                        'objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "Fin AnularPedido")
                        'Cancelar()
                    End If
                End If
            Next
        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "ERROR RenovacionModemPrepago: " & ex.Message.ToString() & " " & ex.StackTrace.ToString())
        Finally
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "Fin RenovacionModemPrepago")
            objSicarDB = Nothing
            oActivacion = Nothing
        End Try
    End Sub
    ' Inicio IDEA-11056 Renovación TFI para CAC's
    Private Sub BonoRenovacionTFI(ByVal nroDocSap As String, ByVal dsPedido As DataSet, ByVal C_VENTA As DataTable, ByVal C_VENTA_DET As DataTable)


        Dim strIdentifyLog As String = nroDocSap

        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio BonoRenovacionTFI")

        Try
            Dim nroTelefono As String
            Dim IMEI As String
            Dim blnProgBonoRenov As Boolean

            If blnEsVentaRenovTFI(dsPedido, nroTelefono, IMEI, C_VENTA_DET) Then

                'Dim objPool As New SAP_SIC_Pagos.clsPagos
                Dim dsPoolPendientes As New DataSet
                Dim dsPoolPagados As New DataSet
                Dim dtsapPendiente As New DataTable
                Dim dtsapPagados As New DataTable
                Dim objclsConsultaMsSap As New COM_SIC_Activaciones.clsConsultaMsSap

                Dim sTipoDocCliente As String = dsPedido.Tables(0).Rows(0).Item("CLIEC_TIPODOCCLIENTE")
                Dim sNroDocCliente As String = dsPedido.Tables(0).Rows(0).Item("CLIEV_NRODOCCLIENTE")

                'Buscar una venta de chip repuesto para el mismo cliente
                'dsPoolPendientes = objPool.Get_ConsultaPoolFactura(Session("ALMACEN"), CStr(Session("FechaPago")), "I", "", "", "", "1000", "1")
                dtsapPendiente = objclsConsultaMsSap.ConsultaPoolPagos(ConfigurationSettings.AppSettings("PEDIC_ESTADO"), DateTime.ParseExact(AppFechaPago, "dd/MM/yyyy", CultureInfo.InvariantCulture), AppPuntoVentaSinergia, "")
                dtsapPagados = objclsConsultaMsSap.ConsultaPoolPagos(ConfigurationSettings.AppSettings("ESTADO_PAG"), DateTime.ParseExact(AppFechaPago, "dd/MM/yyyy", CultureInfo.InvariantCulture), AppPuntoVentaSinergia, "")
                'dsPoolPendientes = objConsultaMsSap.ConsultaPoolPagos("ACT", "", Session("ALMACEN")).DataSet

                If Not dtsapPendiente Is Nothing AndAlso dtsapPendiente.Rows.Count > 0 Then
                    blnProgBonoRenov = blnExisteVentaChipRepTFI(nroDocSap, sTipoDocCliente, sNroDocCliente, dtsapPendiente, C_VENTA_DET) ''Buscar en el Pool de Doc Por Pagar
                End If

                If Not blnProgBonoRenov Then
                    'dsPoolPagados = objPool.Get_ConsultaPoolFactura(Session("ALMACEN"), CStr(Session("FechaPago")), "R", "", "", "", "1000", "1")
                    'dsPoolPagados = objConsultaMsSap.ConsultaPoolPagos("PAG", "", Session("ALMACEN")).DataSet

                    If Not dtsapPagados Is Nothing AndAlso dtsapPagados.Rows.Count > 0 Then
                        blnProgBonoRenov = blnExisteVentaChipRepTFI(nroDocSap, sTipoDocCliente, sNroDocCliente, dtsapPagados, C_VENTA_DET) ''Buscar en el Pool de Doc Pagados
                    End If
                End If

                If blnProgBonoRenov Then
                    Dim P_TIPO_PROC As String = ConfigurationSettings.AppSettings("TFI_RENOV")
                    Dim P_MSISDN As String = CheckStr(ConfigurationSettings.AppSettings("codTelefonicoPeru")) & nroTelefono

                    If ProgramarBonoRenovRepos(P_TIPO_PROC, _
                                              IMEI, _
                                              P_MSISDN, _
                                              Now, _
                                              CurrentUser) Then

                        TipificacionBonoRenovacionTFI(nroTelefono)
                    End If
                End If
            End If
        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR BonoRenovacionTFI: " & ex.Message.ToString() & " " & ex.StackTrace.ToString())
        Finally
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin BonoRenovacionTFI")
        End Try
    End Sub

    Private Function blnEsVentaRenovTFI(ByVal dsPedido As DataSet, ByRef nroTelefono As String, ByRef serie As String, ByVal C_VENTA_DET As DataTable)
        Dim blnRespuesta As Boolean

        Dim sTipoVentaTFI As String = ConfigurationSettings.AppSettings("BonoRenovTFI_Renov_TipoVenta")
        Dim sTipoOperRenovTFI As String = ConfigurationSettings.AppSettings("BonoRenovTFI_Renov_TipoOpera")

        Dim BonoRenovTFI_Renov_Campana As String = ConfigurationSettings.AppSettings("BonoRenovTFI_Renov_Campana")
        Dim BonoRenovTFI_Renov_ListPre As String = ConfigurationSettings.AppSettings("BonoRenovTFI_Renov_ListPre")
        Dim BonoRenovTFI_Renov_Plan As String = ConfigurationSettings.AppSettings("BonoRenovTFI_Renov_Plan")

        '*******************************************************************************************'
        '**Estos tienen que cambiar por el nuevo nombre de los campos del pedido:
        'Dim sTipoVenta As String = dsPedido.Tables(0).Rows(0).Item("TIPO_VENTA")
        'Dim sTipoOperacion As String = dsPedido.Tables(0).Rows(0).Item("CLASE_VENTA")

        Dim sTipoVenta As String = dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA")
        Dim sTipoOperacion As String = dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION")
        '*******************************************************************************************'

        If sTipoVenta = sTipoVentaTFI AndAlso sTipoOperacion = sTipoOperRenovTFI Then
            For k As Integer = 0 To dsPedido.Tables(1).Rows.Count - 1
                Dim strMaterial As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("MATEV_CLASIFICACION"))
                nroTelefono = FormatoTelefonoPrepago(dsPedido.Tables(1).Rows(k).Item("DEPEV_NROTELEFONO"))
                serie = Right(dsPedido.Tables(1).Rows(k).Item("SERIC_CODSERIE"), 15)
                'CAMPAÑA Y PLAN FALTA
                If Not strMaterial.StartsWith("PS") AndAlso _
                    BonoRenovTFI_Renov_Campana = Funciones.CheckStr(C_VENTA_DET.Rows(k).Item("CAMPANA")) AndAlso _
                    BonoRenovTFI_Renov_ListPre = dsPedido.Tables(1).Rows(k).Item("DEPEV_CODIGO_LP") AndAlso _
                    BonoRenovTFI_Renov_Plan = Funciones.CheckStr(C_VENTA_DET.Rows(k).Item("PLAN")) Then
                    blnRespuesta = True
                    Exit For
                End If
            Next
        End If
        Return blnRespuesta
    End Function

    Private Function blnExisteVentaChipRepTFI(ByVal nroDocSap As String, _
                                            ByVal sTipoDocCliente As String, _
                                            ByVal sNroDocCliente As String, _
                                            ByVal dsPool As DataTable, _
                                            ByVal C_VENTA_DET As DataTable) As Boolean

        Dim strIdentifyLog As String = nroDocSap
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio blnExisteVentaChipRepTFI")
        Dim blnRespuesta As Boolean
        Try
            Dim nroFactura As String
            For i As Integer = 0 To dsPool.Rows.Count - 1
                nroFactura = dsPool.Rows(i).Item("PAGOC_CODSUNAT")
                If nroFactura <> nroDocSap Then
                    'Dim ds As DataSet = objPagos.Get_ConsultaPedido("", Session("ALMACEN"), nroFactura, "")
                    Dim ds As DataSet = objConsultaMsSap.ConsultaPedido(nroDocSap, "", "")

                    If Not ds Is Nothing AndAlso ds.Tables.Count > 0 AndAlso ds.Tables(0).Rows.Count > 0 Then
                        If ds.Tables(0).Rows(0).Item("CLIEC_TIPODOCCLIENTE") = sTipoDocCliente AndAlso _
                                           ds.Tables(0).Rows(0).Item("CLIEV_NRODOCCLIENTE") = sNroDocCliente Then
                            If blnEsVentaChipRepTFI(ds, nroDocSap, C_VENTA_DET) Then
                                blnRespuesta = True
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "DOCUMENTO SAP RENOVACION: " & nroDocSap)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "DOCUMENTO SAP CHIP REPUESTO: " & nroFactura)
                                Exit For
                            End If
                        End If
                    End If
                End If
            Next
        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR blnExisteVentaChipRepTFI: " & ex.Message.ToString())
        End Try
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "blnRespuesta: " & blnRespuesta)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin blnExisteVentaChipRepTFI")
        Return blnRespuesta
    End Function


    Private Function blnEsVentaChipRepTFI(ByVal dsPedido As DataSet, ByVal nroDocSap As String, ByVal C_VENTA_DET As DataTable)
        Dim blnRespuesta As Boolean
        Dim strIdentifyLog As String = nroDocSap
        Try
            Dim sTipoVentaTFI As String = ConfigurationSettings.AppSettings("BonoRenovTFI_ChipR_TipoVenta")
            Dim sTipoOperChipRepTFI As String = ConfigurationSettings.AppSettings("BonoRenovTFI_ChipR_TipoOpera")

            Dim BonoRenovTFI_ChipR_Campana As String = ConfigurationSettings.AppSettings("BonoRenovTFI_ChipR_Campana")
            Dim BonoRenovTFI_ChipR_ListPre As String = ConfigurationSettings.AppSettings("BonoRenovTFI_ChipR_ListPre")
            Dim BonoRenovTFI_ChipR_Plan As String = ConfigurationSettings.AppSettings("BonoRenovTFI_ChipR_Plan")

            Dim sTipoVenta As String = dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA")
            Dim sTipoOperacion As String = dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION")

            If sTipoVentaTFI.IndexOf(sTipoVenta) > -1 AndAlso sTipoOperacion = sTipoOperChipRepTFI Then
                For k As Integer = 0 To dsPedido.Tables(1).Rows.Count - 1
                    Dim strMaterial As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("MATEV_CLASIFICACION"))
                    'CAMPAÑA Y PLAN FALTA
                    If strMaterial.StartsWith("PS") AndAlso _
                       BonoRenovTFI_ChipR_Campana = Funciones.CheckStr(C_VENTA_DET.Rows(k).Item("CAMPANA")) AndAlso _
                       BonoRenovTFI_ChipR_ListPre = dsPedido.Tables(1).Rows(k).Item("DEPEV_CODIGOLP") AndAlso _
                       BonoRenovTFI_ChipR_Plan = Funciones.CheckStr(C_VENTA_DET.Rows(k).Item("PLAN")) Then
                        blnRespuesta = True
                        Exit For
                    End If
                Next
            End If
        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR blnEsVentaChipRepTFI: " & ex.Message.ToString())
        End Try
        Return blnRespuesta
    End Function

    Private Function ProgramarBonoRenovRepos(ByVal P_TIPO_PROC As String, _
                                         ByVal P_IMEI As String, _
                                         ByVal P_MSISDN As String, _
                                         ByVal P_FECHA_PROCESO As DateTime, _
                                         ByVal P_USUARIO As String) As Boolean

        Dim blnResultado As Boolean
        Dim P_COD_RESULTADO As String
        Dim P_MSJ_RESULTADO As String

        Dim strIdentifyLog As String = Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO"))
        Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio ProgramarBonoRenovRepos (IDE003_PKG_CONTROL_PROMOCIONES.SP_BONO_RENOV_REPOS)")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     INP P_TIPO_PROC:  " & P_TIPO_PROC)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     INP P_IMEI:  " & P_IMEI)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     INP P_MSISDN:  " & P_MSISDN)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     INP P_FECHA_PROCESO:  " & P_FECHA_PROCESO)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     INP P_USUARIO:  " & P_USUARIO)

            Dim objSapCajas As New COM_SIC_Cajas.clsCajas
            objSapCajas.ProgramarBonoRenovRepos(P_TIPO_PROC, _
                                                 P_IMEI, _
                                                 P_MSISDN, _
                                                 P_FECHA_PROCESO, _
                                                 P_USUARIO, _
                                                 P_COD_RESULTADO, _
                                                 P_MSJ_RESULTADO)

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     out P_COD_RESULTADO  " & P_COD_RESULTADO)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     out P_MSJ_RESULTADO  " & P_MSJ_RESULTADO)


            If P_COD_RESULTADO = "0" Then
                blnResultado = True
            Else
                AppP_MSJ_RESULTADO = P_MSJ_RESULTADO
            End If

        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR ProgramarBonoRenovRepos: " & ex.Message.ToString() & " " & ex.StackTrace.ToString())
            AppP_MSJ_RESULTADO = "No se pudo entregar el bono por Renovación de Equipo TFI."
        Finally
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin ProgramarBonoRenovRepos")

        End Try
        Return blnResultado
    End Function
    Private Sub TipificacionBonoRenovacionTFI(ByVal numeroTelefono As String)
        Dim oInteraccion = New COM_SIC_INActChip.Interaccion
        Dim oTipificacion As New COM_SIC_INActChip.clsTipificacion

        Dim strIdentifyLog As String = Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO"))
        Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio TipificacionBonoRenovacionTFI()")

            With oInteraccion
                .TELEFONO = numeroTelefono
                .TIPO = ConfigurationSettings.AppSettings("CONS_RENOV_TFI_TIPO")
                .CLASE = ConfigurationSettings.AppSettings("CONS_RENOV_TFI_CLASE")
                .SUBCLASE = ConfigurationSettings.AppSettings("CONS_RENOV_TFI_SUBCLASE")
                .NOTAS = ConfigurationSettings.AppSettings("CONS_RENOV_TFI_NOTAS")

                .METODO = ConfigurationSettings.AppSettings("CONS_RENOVACION_METODO")
                .TIPO_INTER = ConfigurationSettings.AppSettings("CONS_RENOVACION_TIPO_INTER")
                .AGENTE = CurrentUser
                .USUARIO_PROCESO = ConfigurationSettings.AppSettings("CONS_RENOVACION_USUARIO")
                .FLAG_CASO = ConfigurationSettings.AppSettings("CONS_RENOVACION_FLAG")
                .RESULTADO = ConfigurationSettings.AppSettings("CONS_RENOVACION_RESULTADO")
                .HECHO_EN_UNO = ConfigurationSettings.AppSettings("CONS_RENOVACION_HECHO")
            End With


            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     INP TELEFONO: " & oInteraccion.TELEFONO)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     INP TIPO: " & oInteraccion.TIPO)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     INP CLASE: " & oInteraccion.CLASE)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     INP SUBCLASE: " & oInteraccion.SUBCLASE)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     INP NOTAS: " & oInteraccion.NOTAS)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     INP AGENTE: " & oInteraccion.AGENTE)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     INP USUARIO_PROCESO: " & oInteraccion.USUARIO_PROCESO)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     INP METODO: " & oInteraccion.METODO)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     INP TIPO_INTER: " & oInteraccion.TIPO_INTER)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     INP FLAG_CASO: " & oInteraccion.FLAG_CASO)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     INP RESULTADO: " & oInteraccion.RESULTADO)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     INP HECHO_EN_UNO: " & oInteraccion.HECHO_EN_UNO)

            Dim flagInter As String
            Dim mensajeInter As String
            Dim idInteraccion As String
            'Guardar Interaccion 
            oTipificacion.CrearInteraccion(oInteraccion, idInteraccion, flagInter, mensajeInter)

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "out Id Interaccion : " & idInteraccion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "out Flag Metodo : " & flagInter)
            'INI PROY-140126
            Dim MaptPath As String
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: TipificacionBonoRenovacionTFI)"
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "out Mensaje : " & mensajeInter & MaptPath)
            'FIN PROY-140126
        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR TipificacionBonoRenovacionTFI:" & ex.Message.ToString() & " " & ex.StackTrace.ToString())
        Finally
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin TipificacionBonoRenovacionTFI()")
        End Try
    End Sub
    ' Fin IDEA-11056 Renovación TFI para CAC's 

    Private Sub RegistrarPlanPrepagoEspecial(ByVal msisdn As String, _
                                             ByVal offer As String, _
                                             ByVal subscriberStatus As String)
        Dim strIdentifyLog As String = msisdn

        Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio RegistrarPlanPrepagoEspecial")

            Dim oWSPlanPrepagoEspecial As New WSPlanPrepagoEspecial.ebsCambioPlanPrepagoEspecialService
            Dim ocambiarPlanPrepagoEspecialRequest As New WSPlanPrepagoEspecial.cambiarPlanPrepagoEspecialRequest
            Dim oAuditType As New WSPlanPrepagoEspecial.AuditType
            Dim ocambiarPlanPrepagoEspecialResponse As New WSPlanPrepagoEspecial.cambiarPlanPrepagoEspecialResponse
            Dim _NOMBRE_SERVER As String = Dns.GetHostName()
            Dim IP_SERVER As String = Dns.GetHostByName(_NOMBRE_SERVER).AddressList(0).ToString()

            oWSPlanPrepagoEspecial.Url = ConfigurationSettings.AppSettings("WSPlanPrepagoEspecial_url")
            oWSPlanPrepagoEspecial.Credentials = CredentialCache.DefaultCredentials
            oWSPlanPrepagoEspecial.Timeout = Funciones.CheckInt(ConfigurationSettings.AppSettings("WSPlanPrepagoEspecial_timeout"))

            oAuditType.idTransaccion = msisdn
            oAuditType.ipAplicacion = IP_SERVER
            oAuditType.nombreAplicacion = ConfigurationSettings.AppSettings("constAplicacion")
            oAuditType.usuarioAplicacion = CurrentUser

            ocambiarPlanPrepagoEspecialRequest.audit = oAuditType
            ocambiarPlanPrepagoEspecialRequest.msisdn = msisdn
            ocambiarPlanPrepagoEspecialRequest.offer = offer
            ocambiarPlanPrepagoEspecialRequest.subscriberStatus = subscriberStatus

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   inp  msisdn : " & ocambiarPlanPrepagoEspecialRequest.msisdn)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   inp  offer : " & ocambiarPlanPrepagoEspecialRequest.offer)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   inp  subscriberStatus : " & ocambiarPlanPrepagoEspecialRequest.subscriberStatus)

            ocambiarPlanPrepagoEspecialResponse = oWSPlanPrepagoEspecial.cambiarPlanPrepagoEspecial(ocambiarPlanPrepagoEspecialRequest)

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   OUT  codigoRetorno : " & ocambiarPlanPrepagoEspecialResponse.codigoRetorno)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   OUT  descripcionRetorno : " & ocambiarPlanPrepagoEspecialResponse.descripcionRetorno)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   OUT  idTransaccion : " & ocambiarPlanPrepagoEspecialResponse.idTransaccion)

        Catch ex As Exception

            'INI PROY-140126
            Dim MaptPath As String
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: RegistrarPlanPrepagoEspecial)"
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   ERROR : " & ex.Message & MaptPath)
            'FIN PROY-140126


        Finally
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin RegistrarPlanPrepagoEspecial")
        End Try
    End Sub

    ' INICIO : BONO REPOSICION EN CAC 
    Private Function BonoReposisicon(ByVal dsPedido As DataSet, ByVal drPagos As DataRow, ByVal nroDocSap As String, ByVal tipo_venta_pvu As String, ByVal flag_venta_repo As String) As String

        Dim nroLineaBono As String = ""
        Dim sDocumentoSap As String = nroDocSap
        objFileLog.Log_WriteLog(pathFile, strArchivo, sDocumentoSap & " - " & "Inicion BonoReposicion")
        'Dim nroLineaBono As String = Right(dsPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO"), 9)

        Try
            If Not dsPedido Is Nothing Then
                objFileLog.Log_WriteLog(pathFile, strArchivo, sDocumentoSap & " - " & "Inicio BonoReposisicon - verifica el nrotelefonico")
                If Not Convert.IsDBNull(dsPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO")) Then
                    objFileLog.Log_WriteLog(pathFile, strArchivo, sDocumentoSap & " - " & "Inicion BonoReposisicon- verifica el nrotelefonico => " & dsPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO"))
                    If Not IsDBNull(dsPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO")) Then
                        If dsPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO") <> "" Then
                            nroLineaBono = Right(dsPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO"), 9)
                        End If
                    Else
                        nroLineaBono = ""
                    End If
                End If
            End If
        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, sDocumentoSap & " - " & "Error, no encontro el nrotelefonico")
        End Try

        Dim strTipoDocumento As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("CLIEC_TIPODOCCLIENTE"))
        Dim strNumeroDocumento As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("CLIEV_NRODOCCLIENTE"))
        Dim strMsisdn As String = "" 'Right(Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO")), 9)

        Dim strCodTipoCanal As String
        Dim strCanalAtencion As String = CheckStr(AppAlmacen)
        Dim strEstadoRegistro As String = ConfigurationSettings.AppSettings("constEstadoPendienteReposicion")
        Dim intFlagBloqueo As Integer
        Dim strCodBloqueo As String
        Dim strTipoBloqueo As String
        Dim strIccidActual As String
        Dim strIccidNuevo As String
        Dim strUsuario As String
        Dim strMensaje As String ' Resultado general
        Dim strTipoVenta As String
        Dim imei As String = ""
        Dim codigoArticulo As String = ""

        Dim obj As New COM_SIC_Cajas.clsCajas
        'Dim intExistePedidoSisact As Integer = obj.Consulta_Existe_Pedido_Reposicion(sDocumentoSap, strEstadoRegistro, intFlagBloqueo, strCodBloqueo, strTipoBloqueo, strIccidActual, strIccidNuevo, strUsuario, strTipoVenta)

        'If intExistePedidoSisact = 1 Then
            ' Registrar Pago Reposicion Prepago 
        'RegistrarPagoReposicionPrepago(sDocumentoSap, nroLineaBono, strCodTipoCanal)
        If (ConfigurationSettings.AppSettings("Tipo_operacion_Reno_bono_Pre").IndexOf(Funciones.CheckStr(tipo_venta_pvu)) > -1) Then
            If (ConfigurationSettings.AppSettings("Flag_PEd_Repo").IndexOf(Funciones.CheckStr(flag_venta_repo)) > -1) Then

                ' Ejecutar Cambio de Sim
                'Dim boolEstadoCambioSim As Boolean = EjecutarCambioSim(nroLineaBono, strTipoDocumento, strNumeroDocumento, strMsisdn, strIccidNuevo, strCodBloqueo, strCanalAtencion, strTipoBloqueo)
                'If boolEstadoCambioSim = False Then
                '    'Mensaje de Error 
                '    strMensaje = "Se grabó el Pago pero debido a que no se pudo Realizar el Cambio de Sim no se realizo la Asignación de Bono."
                '    Return strMensaje
                'End If
                'Si cambio de Sim se realiza correctamente
                ' Asignar Bono Prepago
                '
                Try
                    If Not dsPedido.Tables(1) Is Nothing Then
                        If dsPedido.Tables(1).Rows.Count > 1 Then
                            For k As Integer = 0 To dsPedido.Tables(1).Rows.Count - 1
                                If (Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("MATEC_TIPOMATERIAL")) = ConfigurationSettings.AppSettings("constPacks")) Then
                                    strMsisdn = "51" & Right(dsPedido.Tables(1).Rows(k).Item("DEPEV_NROTELEFONO"), 9)
                                    imei = Right(dsPedido.Tables(1).Rows(k).Item("SERIC_CODSERIE"), 15)
                                    codigoArticulo = Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("DEPEC_CODMATERIAL"))
                                End If
                            Next
                        End If
                    End If
                Catch ex As Exception
                    objFileLog.Log_WriteLog(pathFile, strArchivo, sDocumentoSap & " - " & "ERROR : Bono Reposicion PAck Prepago")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, sDocumentoSap & " - " & "ERROR : " & ex.Message.ToString())
                    strMsisdn = ""
                    imei = ""
                    codigoArticulo = ""
                End Try

                Try
                    'Dim dtDetalle As DataTable = CType(dsPedido.Tables(1), DataTable)
                    'Dim arr() As DataRow = dtDetalle.Select("", "DEPEC_CODMATERIAL")
                    'Dim row As DataRow = arr(0)
                    Try
                        ' objFileLog.Log_WriteLog(pathFile, strArchivo, "Fecha :" & drPagos.Item("FKDAT"))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, sDocumentoSap & " - " & "Fecha :" & DateTime.Now)
                    Catch ex1 As Exception
                        objFileLog.Log_WriteLog(pathFile, strArchivo, sDocumentoSap & " - " & "Error Fecha :")
                    End Try

                    Dim strMontoVenta As String = Funciones.CheckDbl(drPagos.Item("INPAN_TOTALDOCUMENTO"))

                    objFileLog.Log_WriteLog(pathFile, strArchivo, sDocumentoSap & " - " & "Imei : " & imei)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, sDocumentoSap & " - " & "codigoArticulo : " & codigoArticulo)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, sDocumentoSap & " - " & "strMontoVenta : " & strMontoVenta)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, sDocumentoSap & " - " & "Fecha : " & DateTime.Now)

                    'Dim imei As String = Right(CheckStr(row("SERIC_CODSERIE")), 15) 
                    Dim fecha As String = DateTime.Now 'drPagos.Item("FKDAT")
                    ' Dim codigoArticulo As String = CheckStr(row("DEPEC_CODMATERIAL"))
                    'Dim strMontoVenta As String = Funciones.CheckDbl(drPagos.Item("INPAN_TOTALDOCUMENTO"))

                    'PROY-31766- INICIO'
                    objFileLog.Log_WriteLog(pathFile, strArchivo, sDocumentoSap & " - IGV ACTUAL: " & dblValorIGVActual)
                    Dim constIGV As Double = dblValorIGVActual ' ObtenerIGVActual()
                    'PROY-31766 - FIN'

                    'Dim strMontoVentaSinIGV As String = CheckStr((CheckDbl(drPagos.Item("INPAN_TOTALDOCUMENTO")) / (1 + constIGV)) * 100)
                    Dim strMontoVentaSinIGV As String = CheckStr(CheckDbl(drPagos.Item("INPAN_TOTALDOCUMENTO")) / (1 + constIGV))
                    Dim srtMenasjeBonoPre As String = ""

                    Dim strParametros As String = sDocumentoSap & "," & nroLineaBono & "," & imei & "," & strCodTipoCanal & "," & strCanalAtencion & "," & fecha & "," & codigoArticulo & "," & strMontoVenta & "," & strMontoVentaSinIGV & "," & srtMenasjeBonoPre
                    objFileLog.Log_WriteLog(pathFile, strArchivo, sDocumentoSap & " - " & "Parametros AsignarBonoPrepago : " & strParametros)

                    AsignarBonoPrepago(sDocumentoSap, nroLineaBono, imei, strCodTipoCanal, strCanalAtencion, fecha, codigoArticulo, strMontoVenta, strMontoVentaSinIGV, srtMenasjeBonoPre)

                    strMensaje = strMensaje & srtMenasjeBonoPre

                    objFileLog.Log_WriteLog(pathFile, strArchivo, sDocumentoSap & " - " & "strMensaje: " & strMensaje)

                Catch ex As Exception
                    objFileLog.Log_WriteLog(pathFile, strArchivo, sDocumentoSap & " - " & "ex invocar AsignarBonoPrepago : " & ex.Message.ToString())
                    strMensaje = strMensaje & ex.Message.ToString()
                End Try
            Else
                strMensaje = "El Flag de Pedido no es reposicion: " & flag_venta_repo
                objFileLog.Log_WriteLog(pathFile, strArchivo, sDocumentoSap & " - " & "strMensaje : " & strMensaje)
            End If
        Else
            strMensaje = "El Pedido no es reposicion (tipo_venta_pvu): " & tipo_venta_pvu
            objFileLog.Log_WriteLog(pathFile, strArchivo, sDocumentoSap & " - " & "strMensaje : " & strMensaje)
        End If
        'End If
        objFileLog.Log_WriteLog(pathFile, strArchivo, sDocumentoSap & " - " & "Return BonoReposisicon : " & strMensaje)
        Return strMensaje
    End Function

    Private Sub RegistrarPagoReposicionPrepago(ByVal sDocumentoSap As String, ByVal nroLineaBono As String, ByRef strCanal As String)

        Try

            Dim objVentaExpressNegocios As New COM_SIC_Cajas.clsCajas

            objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & nroLineaBono & "- " & "Inicio Registrar Pago Reposicion")
            objFileLog.Log_WriteLog(pathFile, strArchivo, "Inicio Lista_Venta_Reposicion")

            Dim lista As ArrayList = objVentaExpressNegocios.Lista_Venta_Reposicion(sDocumentoSap)

            objFileLog.Log_WriteLog(pathFile, strArchivo, "Registros en Lista_Venta_Reposicion: " & lista.Count.ToString())
            objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & nroLineaBono & "- " & "Se registro correctamente el pago.")


            Dim strPuntoVenta As String
            Dim strTicketPreventa As String

            For Each item As COM_SIC_Cajas.VentaReposicion In lista

                strCanal = item.TIPO_OFICINA
                strPuntoVenta = item.OFICINA
                strTicketPreventa = item.TICKET_PRE_VENTA


                If strCanal <> ConfigurationSettings.AppSettings("constCodTipoCRN") Then
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Inicio RegistrarPagoReposicionPrepago")
                    If objVentaExpressNegocios.RegistrarPagoReposicionPrepago(sDocumentoSap) Then
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "RegistrarPagoReposicionPrepago OK")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & nroLineaBono & "- " & "Se registro correctamente el pago.")
                    End If
                End If

                objFileLog.Log_WriteLog(pathFile, strArchivo, "Validacion si Punto de Venta usa SISCAD")
                objFileLog.Log_WriteLog(pathFile, strArchivo, "Canal: " & strCanal)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "Punto de Venta: " & strPuntoVenta)

                'If strCanal = ConfigurationSettings.AppSettings("constCodTipoCRN") Then


                '    objFileLog.Log_WriteLog(pathFile, strArchivo, "--- Ingreso al Pago en SISCAD ---")
                '    Dim intpagarCornerReposicion = pagarCornerReposicion(sDocumentoSap, strPuntoVenta, strTicketPreventa)

                '    If intpagarCornerReposicion = 0 Then
                '        bProcesoPagos = True
                '    Else
                '        bProcesoPagos = False
                '    End If

                'End If
            Next

        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & nroLineaBono & "- " & "Exception Registrar Pago Reposicion: " + ex.Message)
        Finally
            objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & nroLineaBono & "- " & "Fin Registrar Pago Reposicion")
        End Try

    End Sub

    Private Function EjecutarCambioSim(ByVal nroLineaBono As String, ByVal strTipoDocumento As String, _
                                  ByVal strNumeroDocumento As String, ByVal strMsisdn As String, ByVal strIccidNuevo As String, _
                                  ByVal strCodBloqueo As String, ByVal strCanalAtencion As String, ByVal strTipoBloqueo As String) As Boolean

        '------------------------------
        ''--Inicio Desbloquear Linea
        '-----------------------------

        ' Verificar si la Linea se encuentra Bloqueada
        Dim strMensajePrepago As String
        Dim strParametros As String


        '------------------------------
        ''--Inicio Cambio de SIM CARD -  URL Desarollo: http://172.19.74.118:7909/CambioSimPrepago/ebsCambioSimPrepagoSB11?wsdl
        '------------------------------

        Dim strIdTransaccion As String
        Dim strMensajeRespuesta As String
        Dim flagCambioSim As Boolean
        Dim oCambioSimNegocios As New COM_SIC_Cajas.clsCajas


        ' Cadena de Parametros
        Dim strNombreServer As String = System.Net.Dns.GetHostName()
        Dim strIp As String = System.Net.Dns.GetHostByName(strNombreServer).AddressList(0).ToString()
        Dim strUsuarioApp As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("CONST_USUARIO_CAMBIO_SIM_SISACT"))

        Dim strId As String
        Dim idTransaccion As String
        Dim randomClass As New Random

        idTransaccion = DateTime.Now.ToString("yyyyMMddHHmmss")
        idTransaccion = idTransaccion & Right("000" & Int(randomClass.Next(1, 100)), 3)

        strId = idTransaccion

        strParametros = ""
        strParametros = strParametros & strId & "|"
        strParametros = strParametros & strIp & "|"
        strParametros = strParametros & strUsuarioApp & "|"
        strParametros = strParametros & strTipoDocumento & "|"
        strParametros = strParametros & strNumeroDocumento & "|"
        strParametros = strParametros & strMsisdn & "|"
        strParametros = strParametros & strIccidNuevo & "|"
        strParametros = strParametros & strCodBloqueo & "|"
        strParametros = strParametros & strCanalAtencion & "|"
        strParametros = strParametros & strTipoBloqueo & "|"
        strParametros = strParametros & strMensajeRespuesta


        ' Invocar WS para Cambio de SIM
        objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & nroLineaBono & "- " & "Inicio Metodo EjecutarCambioSim()")
        objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & nroLineaBono & "- " & "Parametros : " & strParametros)
        Dim boolEstadoCambioSim As Boolean = False

        Try
            boolEstadoCambioSim = oCambioSimNegocios.EjecutarCambioSim(strId, _
                                                                       strIp, _
                                                                       strUsuarioApp, _
                                                                       strTipoDocumento, _
                                                                       strNumeroDocumento, _
                                                                       strMsisdn, _
                                                                       strIccidNuevo, _
                                                                       strCodBloqueo, _
                                                                       strCanalAtencion, _
                                                                       strTipoBloqueo, _
                                                                       strMensajeRespuesta)

        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, " - ERROR oCambioSimNegocios.EjecutarCambioSim:  - " & ex.Message)
            boolEstadoCambioSim = False
        End Try

        objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & nroLineaBono & "- " & "estadoCambioSim : " & boolEstadoCambioSim)
        objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & nroLineaBono & "- " & "vIdTransaccion : " & strIdTransaccion)
        objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & nroLineaBono & "- " & "vMensajeRespuesta : " & strMensajeRespuesta)
        objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & nroLineaBono & "- " & "Fin Metodo EjecutarCambioSim()")

        Return boolEstadoCambioSim

        '------------------------------
        ''--Fin Cambio de SIM CARD
        '------------------------------

    End Function

    Private Sub AsignarBonoPrepago(ByVal sDocumentoSap As String, ByVal nroLinea As String, ByVal imei As String, ByVal tipoOficina As String, _
ByVal oficina As String, ByVal fechaVenta As String, ByVal codigoArticulo As String, ByVal strMontoVenta As String, ByVal strMontoVentaSinIGV As String, _
ByRef strMensaje As String)

        objFileLog.Log_WriteLog(pathFile, strArchivo, "Inicio Metodo AsignarBonoPrepago()")

        '------------------------------
        ''--Inicio Entregar bono para la venta del pack prepago en reposición. 
        '------------------------------
        Dim objBonoRenoPrepago As New COM_SIC_Cajas.clsCajas

        Dim nroLineaBono As String = "51" & nroLinea
        Dim codSalida As String = ""
        Dim msgSalida As String = ""

        Dim input As String = String.Format("{0}|{1}", nroLineaBono, imei)

        If ConfigurationSettings.AppSettings("ConsFlagRenovPrepago") Or _
            InStr(1, ConfigurationSettings.AppSettings("ConsLineasRenovPrepago"), nroLineaBono) > 0 Then

            objFileLog.Log_WriteLog(pathFile, strArchivo, sDocumentoSap & " - " & nroLineaBono & "- " & "Inicio Bono Reposición Prepago solo Pack")
            objFileLog.Log_WriteLog(pathFile, strArchivo, sDocumentoSap & " - " & nroLineaBono & "- " & "    nroLinea|imei: " & input)

            'Asignación Bono Prepago

            Dim Proceso As String = ConfigurationSettings.AppSettings("constProcesoReposicion")
            objFileLog.Log_WriteLog(pathFile, strArchivo, sDocumentoSap & " - " & nroLineaBono & "- " & "  sDocumentoSap : " & sDocumentoSap)
            objFileLog.Log_WriteLog(pathFile, strArchivo, sDocumentoSap & " - " & nroLineaBono & "- " & "  nroLineaBono : " & nroLineaBono)
            objFileLog.Log_WriteLog(pathFile, strArchivo, sDocumentoSap & " - " & nroLineaBono & "- " & "  imei : " & imei)
            objFileLog.Log_WriteLog(pathFile, strArchivo, sDocumentoSap & " - " & nroLineaBono & "- " & "  codigoArticulo : " & codigoArticulo)
            objFileLog.Log_WriteLog(pathFile, strArchivo, sDocumentoSap & " - " & nroLineaBono & "- " & "  strMontoVenta : " & strMontoVenta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, sDocumentoSap & " - " & nroLineaBono & "- " & "  strMontoVentaSinIGV : " & strMontoVentaSinIGV)
            objFileLog.Log_WriteLog(pathFile, strArchivo, sDocumentoSap & " - " & nroLineaBono & "- " & "  strMontoVentaSinIGV : " & strMontoVentaSinIGV)
            objFileLog.Log_WriteLog(pathFile, strArchivo, sDocumentoSap & " - " & nroLineaBono & "- " & "  Proceso : " & Proceso)

            codSalida = objBonoRenoPrepago.AsignarBonoPrepago(sDocumentoSap, nroLineaBono, imei, codigoArticulo, strMontoVenta, strMontoVentaSinIGV, Proceso, msgSalida)

            'Consulta de Mensaje Renovación Prepago
            Dim codGrupo As Integer = Funciones.CheckInt64(ConfigurationSettings.AppSettings("ConstGrupoMensajeAsignacionReposicion"))
            Dim ds As DataSet = objBonoRenoPrepago.ObtenerParamByGrupo(codGrupo)
            Dim dt As DataTable = ds.Tables(0)
            For Each row As DataRow In dt.Rows
                Dim codigo As String = Funciones.CheckInt64(row("PARAV_VALOR").ToString.Split("|")(0)) 'item.CODIGO.Split("|")(0)
                Dim mensaje As String = Funciones.CheckStr(row("PARAV_VALOR").ToString.Split("|")(1)) 'item.CODIGO.Split("|")(1)

                If codigo = codSalida Then
                    'Error en TipoReposicionPrepago
                    'blnTipoReposicionPre = False
                    'Mensaje de Error 
                    strMensaje = String.Format(mensaje, nroLineaBono)
                    Exit For
                End If
            Next
            Dim out As String = String.Format("{0}|{1}|{2}", codSalida, msgSalida, strMensaje)
            objFileLog.Log_WriteLog(pathFile, strArchivo, sDocumentoSap & " - " & nroLineaBono & "- " & "    codSalida|msgSalida|strMensaje: " & out)
            objFileLog.Log_WriteLog(pathFile, strArchivo, sDocumentoSap & " - " & nroLineaBono & "- " & "Fin Bono Reposición Prepago")
            ' Insertar Bono Reposicion
            Dim strEntregaBono = "N"
            If codSalida = 0 Then
                strEntregaBono = "S"
            End If
        End If
        '------------------------------
        ''--Fin Entregar bono para la venta del pack prepago en reposición. 
        '------------------------------
    End Sub
    ' FIN : BONO REPOSICION EN CAC 


    ' Inicio IDEA 10071  PROY 10018 SMS para renovaciones
    Private Sub AlertaNotificacionPorRenovacion(ByVal nroDocSap As String, _
                                       ByVal dsPedido As DataSet, ByVal idInteracccion1 As String, ByVal cuentaRedVendedor As String)
        Dim idLog As String = nroDocSap
        Dim objContrato As DataSet
        Dim objClsConsultaPvu As New COM_SIC_Activaciones.clsConsultaPvu

        Dim sTipoVentaPostpago As String = ConfigurationSettings.AppSettings("strTVPostpago")
        Try

            objContrato = objClsConsultaPvu.ObtenerDrsap(drPagos.Item("PEDIN_NROPEDIDO"), "", "")

            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "--- Inicio AlertaNotificacionPorRenovacion ---")

            If dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA") = sTipoVentaPostpago AndAlso _
                CheckStr(ConfigurationSettings.AppSettings("codTipoOper_AlertaRenov")).IndexOf(dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION")) > -1 Then

                Dim idCaso As String
                If CheckStr(idInteracccion1) = "" Then
                    idCaso = TipificacionSmsEmailParaRenovacion(FormatoTelefono(dsPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO")), cuentaRedVendedor)
                Else
                    idCaso = idInteracccion1
                End If

                Dim descTipoDocumento As String = getDocumento(Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("CLIEC_TIPODOCCLIENTE")))
                Dim nroDocumento As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("CLIEV_NRODOCCLIENTE"))
                Dim misdn As String = FormatoTelefono(Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO")))

                'Dim oConsultaSap As New SAP_SIC_Ventas.clsVentas
                Dim codMaterial, descMaterial As String
                'oConsultaSap.ConsultarMaterial(Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("SERIC_CODSERIE")), codMaterial, descMaterial)
                'Dim precioEquipo As String = dsPedido.Tables(1).Rows(0).Item("PRECIO_TOTAL")
                'Validar 27092015
                codMaterial = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEC_CODMATERIAL"))
                descMaterial = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEV_DESCMATERIAL"))

                Dim precioEquipo As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEN_SUBTOTAL"))
                Dim dsAcuerdo As DataSet
                Dim desPlazoAcuerdo As String = ""
                Dim strContrato As String = ""

                If Not objContrato Is Nothing Then
                    If objContrato.Tables(0).Rows.Count > 0 Then
                        strContrato = Funciones.CheckStr2(objContrato.Tables(0).Rows(0).Item("ID_CONTRATO"))
                    Else
                        strContrato = ""
                    End If
                Else
                    strContrato = ""
                End If


                If CheckStr(strContrato) <> "" Then
                    'dsAcuerdo = objPagos.Get_ConsultaAcuerdoPCS(dsPedido.Tables(0).Rows(0).Item("NUMERO_CONTRATO"))    '** Ya estaba comentado **'
                    'dsAcuerdo = objPagos.Get_ConsultaAcuerdoPCS(objContrato.Tables(0).Rows(0).Item("ID_CONTRATO"))     '** consulta a SAP **'
                    dsAcuerdo = objClsConsultaPvu.ConsultaAcuerdoPCS(strContrato, DBNull.Value) '** consulta a PVU **'

                    Dim codPlazoAcuerdo As String = dsAcuerdo.Tables(0).Rows(0).Item("PLAZO_ACUERDO")
                    Dim dsPlazoAcuerdo As DataSet
                    Dim oConsultaMaestro As New COM_SIC_Cajas.clsConsultaGeneral
                    dsPlazoAcuerdo = oConsultaMaestro.ListadoPlazoAcuerdo()
                    If Not IsNothing(dsPlazoAcuerdo) AndAlso dsPlazoAcuerdo.Tables.Count > 0 Then
                        For i As Integer = 0 To dsPlazoAcuerdo.Tables(0).Rows.Count - 1
                            If dsPlazoAcuerdo.Tables(0).Rows(i).Item("PACUC_CODIGO") = codPlazoAcuerdo Then
                                desPlazoAcuerdo = dsPlazoAcuerdo.Tables(0).Rows(i).Item("PACUV_DESCRIPCION")
                                Exit For
                            End If
                        Next
                    End If
                End If

                Dim oAudit As New ItemGenerico
                oAudit.CODIGO = nroDocSap
                oAudit.CODIGO2 = CurrentTerminal
                oAudit.DESCRIPCION = ConfigurationSettings.AppSettings("constAplicacion")
                oAudit.DESCRIPCION2 = CurrentUser

                Dim respuesta, codigoRespuesta, mensajeRespuesta As String
                Dim oAlertaWS As New COM_SIC_Activaciones.clsActivacion

                objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "Inicio AlertaNotificacionPorRenovacion")
                objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "inp descTipoDocumento: " & descTipoDocumento)
                objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "inp nroDocumento: " & nroDocumento)
                objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "inp misdn: " & misdn)
                objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "inp descMaterial: " & descMaterial)
                objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "inp precioEquipo: " & precioEquipo)
                objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "inp desPlazoAcuerdo: " & desPlazoAcuerdo)
                objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "inp idCaso: " & idCaso)

                respuesta = oAlertaWS.AlertaNotificacionPorRenovacion(descTipoDocumento, nroDocumento, misdn, descMaterial, precioEquipo, desPlazoAcuerdo, idCaso, oAudit, codigoRespuesta, mensajeRespuesta)

                objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "out codigoRespuesta: " & codigoRespuesta)
                objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "out mensajeRespuesta: " & mensajeRespuesta)
                objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "Fin AlertaNotificacionPorRenovacion")
            End If
        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "ERROR AlertaNotificacionPorRenovacion:" & ex.Message.ToString())
        Finally
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "--- Fin AlertaNotificacionPorRenovacion ---")
        End Try
    End Sub
    Private Function TipificacionSmsEmailParaRenovacion(ByVal numeroTelefono As String, _
                                                        ByVal usuario As String) As String
        Dim oInteraccion = New COM_SIC_INActChip.Interaccion
        Dim oTipificacion As New COM_SIC_INActChip.clsTipificacion
        Dim idInteraccion As String = ""

        Dim strIdentifyLog As String = numeroTelefono
        Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio TipificacionEmailParaRenovacion()")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     INP numeroTelefono  " & numeroTelefono)

            With oInteraccion
                .TELEFONO = numeroTelefono
                .TIPO = ConfigurationSettings.AppSettings("CONS_SmsEmailRenov_TIPO")
                .CLASE = ConfigurationSettings.AppSettings("CONS_SmsEmailRenov_CLASE")
                .SUBCLASE = ConfigurationSettings.AppSettings("CONS_SmsEmailRenov_SUBCLASE")
                .AGENTE = IIf(usuario = "", CurrentUser, usuario)

                .USUARIO_PROCESO = ConfigurationSettings.AppSettings("CONS_RENOVACION_USUARIO")
                .METODO = ConfigurationSettings.AppSettings("CONS_RENOVACION_METODO")
                .TIPO_INTER = ConfigurationSettings.AppSettings("CONS_RENOVACION_TIPO_INTER")
                .FLAG_CASO = ConfigurationSettings.AppSettings("CONS_RENOVACION_FLAG")
                .RESULTADO = ConfigurationSettings.AppSettings("CONS_RENOVACION_RESULTADO")
                .HECHO_EN_UNO = ConfigurationSettings.AppSettings("CONS_RENOVACION_HECHO")
            End With

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     INP AGENTE  " & CheckStr(oInteraccion.AGENTE))

            Dim flagInter As String
            Dim mensajeInter As String
            'Guardar Interaccion 
            oTipificacion.CrearInteraccion(oInteraccion, idInteraccion, flagInter, mensajeInter)

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "out Id Interaccion : " & idInteraccion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "out Flag Metodo : " & flagInter)
            'INI PROY-140126
            Dim MaptPath As String
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: TipificacionSmsEmailParaRenovacion)"
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "out Mensaje : " & mensajeInter & MaptPath)
            'FIN PROY-140126

        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR Message:" & ex.Message.ToString())
        Finally
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Fin TipificacionEmailParaRenovacion() ---")
        End Try

        Return idInteraccion
    End Function
    ''' <summary>
    ''' Obtiene el nombre del tipo de documento, a partir de su código.
    ''' </summary>
    Public Function getDocumento(ByVal TDOCC_CODIGO As String) As String
        Dim Descripcion As String = ""

        Try
            Dim oMaestro As New COM_SIC_Activaciones.clsBDSiscajas
            Dim lista As ArrayList = oMaestro.ListaTipoDocumento("")

            For Each item As ItemGenerico In lista
                If CheckInt64(item.CODIGO) = CheckInt64(TDOCC_CODIGO) Then
                    Descripcion = item.DESCRIPCION
                    Exit For
                End If
            Next item

            Return Descripcion
        Catch ex As Exception
            Return Descripcion
        End Try
    End Function
    ' Fin IDEA 10071  PROY 10018 SMS para renovaciones
    Public Sub obtenerDatosMetrica(ByVal dsPedido As DataSet, ByVal dsAcuerdo As DataSet, ByRef arrayCabecera As ArrayList, ByRef ArrayDetalle As ArrayList)

        Dim oConsultaMaestro As New COM_SIC_Cajas.clsConsultaGeneral
        Dim dsPlazoAcuerdo As DataSet
        dsPlazoAcuerdo = oConsultaMaestro.ListadoPlazoAcuerdo()

        'Dim oConsulta As New SapGeneralNegocios
        Dim item As ItemGenerico
        Dim dsOficina As DataSet
        'dsOficina = objPagos.Get_ParamGlobal(Session("ALMACEN"))
        'TODOE: Validar si es correcta la consulta
        Dim strIdentifyLog As String = String.Format("--[{0}]--", numeroOperacion & " - Metrica")
        Try
            Dim objOffline As New COM_SIC_OffLine.clsOffline
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Inicio Parametros Venta--")
            dsOficina = objOffline.ParametrosVenta(AppAlmacen)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Fin Parametros Venta--")
        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--ERROR Parametros Venta-- " & ex.Message)
        End Try

        item = New ItemGenerico
        item.CODIGO = "oficinaVentas"
        item.DESCRIPCION = AppAlmacen
        arrayCabecera.Add(item)

        item = New ItemGenerico
        item.CODIGO = "desOfVenta"
        item.DESCRIPCION = dsOficina.Tables(0).Rows(0).Item("BEZEI")
        arrayCabecera.Add(item)

        item = New ItemGenerico
        item.CODIGO = "departamento"
        item.DESCRIPCION = dsOficina.Tables(0).Rows(0).Item("den_region")
        arrayCabecera.Add(item)

        item = New ItemGenerico
        item.CODIGO = "canal"
        item.DESCRIPCION = AppCanal
        arrayCabecera.Add(item)

        Dim sDesTipoVenta As String
        Dim sCodTipoVenta As String = dsPedido.Tables(0).Rows(0).Item("TIPO_VENTA")
        For Each sTipoVenta As String In ConfigurationSettings.AppSettings("codDescTipoVenta").Split("|"c)
            Dim arrTipoVenta() As String = sTipoVenta.Split(";"c)
            If sCodTipoVenta = arrTipoVenta(0) Then
                sDesTipoVenta = arrTipoVenta(1)
                Exit For
            End If
        Next

        item = New ItemGenerico
        item.CODIGO = "tipoVenta"
        item.DESCRIPCION = sDesTipoVenta
        arrayCabecera.Add(item)

        item = New ItemGenerico
        item.CODIGO = "operacion"
        item.DESCRIPCION = dsPedido.Tables(0).Rows(0).Item("Des_Clase_Venta")
        arrayCabecera.Add(item)

        Dim fecha As String = dsPedido.Tables(0).Rows(0).Item("Fecha_Documento")
        item = New ItemGenerico
        item.CODIGO = "fechaVenta"
        item.DESCRIPCION = DateTime.ParseExact(fecha, "yyyyMMdd", Nothing).ToString("yyyy-MM-ddTHH:mm:ss.fffzzz")
        arrayCabecera.Add(item)

        Dim nroSec As Int64 = 0
        Dim dsDetalleVenta As DataSet
        If Not (dsAcuerdo Is Nothing) AndAlso dsAcuerdo.Tables.Count > 0 Then
            nroSec = Funciones.CheckInt64(dsAcuerdo.Tables(0).Rows(0).Item("NRO_APROBACION"))
            If nroSec > 0 Then
                dsDetalleVenta = (New COM_SIC_Cajas.clsCajas).ObtenerDetalleVentaSisact(nroSec)
            End If
        End If

        Dim iCont As Integer = 0
        Dim sCadenaTelefonos As String = ""
        Dim sCodChip, sDesChip As String
        Dim sCodEquipo, sDesEquipo As String
        Dim dblPrecioTotal As Double
        For i As Integer = 0 To dsPedido.Tables(1).Rows.Count - 1
            Dim dt As DataTable = dsPedido.Tables(1)
            Dim sNumeroTelefono As String = FormatoTelefonoSinCeros(Funciones.CheckStr(dsPedido.Tables(1).Rows(i).Item("DEPEV_NROTELEFONO")))

            dblPrecioTotal = 0.0
            sCodChip = ""
            sDesChip = ""
            sCodEquipo = ""
            sDesEquipo = ""

            If sCadenaTelefonos.IndexOf(sNumeroTelefono) = -1 Then
                For x As Int32 = 0 To dt.Rows.Count - 1
                    If Not CStr(dt.Rows(x).Item("Articulo")).StartsWith("PS") Then
                        If Funciones.CheckStr(dt.Rows(x).Item("DEPEV_NROTELEFONO")) = Funciones.CheckStr(dsPedido.Tables(1).Rows(i).Item("DEPEV_NROTELEFONO")) Then
                            dblPrecioTotal = dblPrecioTotal + Funciones.CheckDbl(dt.Rows(x).Item("PRECIO_TOTAL"))
                            sCodEquipo = dt.Rows(x).Item("Articulo")
                            sDesEquipo = dt.Rows(x).Item("Des_Articulo")
                            Exit For
                        End If
                    End If
                Next
                For x As Int32 = 0 To dt.Rows.Count - 1
                    If CStr(dt.Rows(x).Item("Articulo")).StartsWith("PS") Then
                        If Funciones.CheckStr(dt.Rows(x).Item("DEPEV_NROTELEFONO")) = Funciones.CheckStr(dsPedido.Tables(1).Rows(i).Item("DEPEV_NROTELEFONO")) Then
                            dblPrecioTotal = dblPrecioTotal + Funciones.CheckDbl(dt.Rows(x).Item("PRECIO_TOTAL"))
                            sCodChip = dt.Rows(x).Item("Articulo")
                            sDesChip = dt.Rows(x).Item("Des_Articulo")
                            Exit For
                        End If
                    End If
                Next

                item = New ItemGenerico
                item.CODIGO = "codEquipo"
                item.DESCRIPCION = sCodEquipo
                ArrayDetalle.Add(item)

                item = New ItemGenerico
                item.CODIGO = "desEquipo"
                item.DESCRIPCION = sDesEquipo
                ArrayDetalle.Add(item)

                Dim sPlazoAcuerdo As String = ""
                Dim sTipoProducto As String = ""
                ObtenerPlazoTipoProducto(dsDetalleVenta, sNumeroTelefono, sPlazoAcuerdo, sTipoProducto)
                If sPlazoAcuerdo = "" Then
                    Dim sCodPlazoAcuerdo As String = ""
                    If Not (dsAcuerdo Is Nothing) AndAlso dsAcuerdo.Tables.Count > 0 Then
                        sCodPlazoAcuerdo = dsAcuerdo.Tables(0).Rows(0).Item("PLAZO_ACUERDO")
                    End If
                    If Not IsNothing(dsPlazoAcuerdo) Then
                        For y As Integer = 0 To dsPlazoAcuerdo.Tables(0).Rows.Count - 1
                            If dsPlazoAcuerdo.Tables(0).Rows(y).Item("PACUC_CODIGO") = sCodPlazoAcuerdo Then
                                sPlazoAcuerdo = dsPlazoAcuerdo.Tables(0).Rows(y).Item("PACUV_DESCRIPCION")
                                Exit For
                            End If
                        Next
                    End If
                End If

                item = New ItemGenerico
                item.CODIGO = "campanna"
                item.DESCRIPCION = dsPedido.Tables(1).Rows(i).Item("Campana")
                ArrayDetalle.Add(item)

                item = New ItemGenerico
                item.CODIGO = "desCampanna"
                item.DESCRIPCION = dsPedido.Tables(1).Rows(i).Item("Des_Campana")
                ArrayDetalle.Add(item)

                item = New ItemGenerico
                item.CODIGO = "precioVenta"
                item.DESCRIPCION = Funciones.CheckStr(dblPrecioTotal)
                ArrayDetalle.Add(item)

                item = New ItemGenerico
                item.CODIGO = "codPlanTarif"
                item.DESCRIPCION = dsPedido.Tables(1).Rows(i).Item("Plan_Tarifario")
                ArrayDetalle.Add(item)

                item = New ItemGenerico
                item.CODIGO = "desPlanTarif"
                item.DESCRIPCION = dsPedido.Tables(1).Rows(i).Item("Des_Plan_Tarifar")
                ArrayDetalle.Add(item)

                item = New ItemGenerico
                item.CODIGO = "plazoAcuerdo"
                item.DESCRIPCION = IIf(sPlazoAcuerdo = "", ConfigurationSettings.AppSettings("constDescSinPlazo"), sPlazoAcuerdo)
                ArrayDetalle.Add(item)

                item = New ItemGenerico
                item.CODIGO = "codChip"
                item.DESCRIPCION = sCodChip
                ArrayDetalle.Add(item)

                item = New ItemGenerico
                item.CODIGO = "desChip"
                item.DESCRIPCION = sDesChip
                ArrayDetalle.Add(item)

                If Not (dsAcuerdo Is Nothing) AndAlso dsAcuerdo.Tables.Count > 0 Then
                    For x As Int32 = 0 To dsAcuerdo.Tables(1).Rows.Count - 1
                        If dsAcuerdo.Tables(1).Rows(x).Item("Nro_Telefono") = Funciones.CheckStr(dsPedido.Tables(1).Rows(i).Item("DEPEV_NROTELEFONO")) Then
                            item = New ItemGenerico
                            item.CODIGO = "nroCuotas"
                            item.DESCRIPCION = dsAcuerdo.Tables(1).Rows(x).Item("cuotas")
                            ArrayDetalle.Add(item)
                            Exit For
                        End If
                    Next
                Else
                    item = New ItemGenerico
                    item.CODIGO = "nroCuotas"
                    item.DESCRIPCION = ""
                    ArrayDetalle.Add(item)
                End If

                item = New ItemGenerico
                item.CODIGO = "tipoProducto"
                item.DESCRIPCION = IIf(sTipoProducto = "", ConfigurationSettings.AppSettings("constDescProdDefault"), sTipoProducto)
                ArrayDetalle.Add(item)

                sCadenaTelefonos &= "|" & sNumeroTelefono
            End If
        Next
    End Sub

    Private Sub ObtenerPlazoTipoProducto(ByVal dsDetalleVenta As DataSet, ByVal sNumeroTelefono As String, ByRef sPlazoAcuerdo As String, ByRef sTipoProducto As String)
        If Not dsDetalleVenta Is Nothing AndAlso dsDetalleVenta.Tables.Count > 0 Then
            For Each dr As DataRow In dsDetalleVenta.Tables(0).Rows
                If Funciones.CheckStr(dr("TELEFONO")) = sNumeroTelefono Then
                    sPlazoAcuerdo = Funciones.CheckStr(dr("PACUV_DESCRIPCION"))
                    sTipoProducto = Funciones.CheckStr(dr("PRDV_DESCRIPCION"))
                End If
            Next
        End If
    End Sub

    Private Sub RegistroDatosVentaPrepago(ByVal dsPedido As DataSet, ByVal dsParamOfVenta As DataSet, ByVal nroPedido As String, ByVal strLineasNoActivadas As String, ByVal strListPromo As String, ByVal C_VENTA_DET As DataTable)
        Dim idLog As String = nroPedido
        Try
            objFileLog.EscribirLog(pathFile, strArchivo, idLog, "Inicio RegistroDatosVentaPrepago ")

            Dim NroTelefono, strICCID, strIMEI, strListaPrecio, Telef As String
            Dim blnConEquipo As Boolean
            Dim cod_Region As String = dsParamOfVenta.Tables(0).Rows(0).Item("REGION")
            Dim strEquipo As String
            For i As Integer = 0 To dsPedido.Tables(1).Rows.Count - 1

                NroTelefono = FormatoTelefono(Funciones.CheckStr(dsPedido.Tables(1).Rows(i)("DEPEV_NROTELEFONO")))
                strEquipo = Funciones.CheckStr(dsPedido.Tables(1).Rows(i)("DEPEC_CODMATERIAL"))
                Dim strCampana As String = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("DVPR_COD_CAMPANA"))

                objFileLog.EscribirLog(pathFile, strArchivo, idLog, "  Numero de Telefono: " & NroTelefono)
                objFileLog.EscribirLog(pathFile, strArchivo, idLog, "  Equipo: " & strEquipo)
                objFileLog.EscribirLog(pathFile, strArchivo, idLog, "  Campaña: " & strCampana)

                If Len(Trim(strEquipo)) > 0 Then
                    If strLineasNoActivadas.IndexOf(NroTelefono) = -1 And Funciones.CheckStr(dsPedido.Tables(1).Rows(i).Item("MATEV_CLASIFICACION")).StartsWith("PS") Then
                        strICCID = Left(Funciones.CheckStr(dsPedido.Tables(1).Rows(i)("SERIC_CODSERIE")), 18)
                        strIMEI = ""
                        For x As Integer = 0 To dsPedido.Tables(1).Rows.Count - 1
                            If Funciones.CheckStr(dsPedido.Tables(1).Rows(i)("DEPEV_NROTELEFONO")) = Funciones.CheckStr(dsPedido.Tables(1).Rows(x)("DEPEV_NROTELEFONO")) Then
                                If Len(Trim(Funciones.CheckStr(dsPedido.Tables(1).Rows(x)("MATEV_CLASIFICACION")))) > 0 Then
                                    If Not CStr(dsPedido.Tables(1).Rows(x)("MATEV_CLASIFICACION")).StartsWith("PS") Then
                                        strIMEI = Right(Funciones.CheckStr(dsPedido.Tables(1).Rows(x)("SERIC_CODSERIE")), 15)
                                        Exit For
                                    End If
                                Else
                                    objFileLog.EscribirLog(pathFile, strArchivo, idLog, "No tiene Codido de Material")
                                End If

                            End If
                        Next

                        strListaPrecio = Funciones.CheckStr(dsPedido.Tables(1).Rows(i).Item("DEPEV_CODIGOLP"))
                        blnConEquipo = (strIMEI <> "")
                        Telef = ConfigurationSettings.AppSettings("codTelefonicoPeru") & NroTelefono

                        Dim strGrupoConEquipo = ConfigurationSettings.AppSettings("constGrupoPrepagoEspecial")
                        Dim strGrupoSinEquipo = ConfigurationSettings.AppSettings("constGrupoPrepagoEspecialSinEquipo")
                        Try
                            Dim CodOpcion As String

                            If blnConEquipo Then
                                CodOpcion = Get_CodOpcionBBA(strEquipo, strListaPrecio, strCampana, strGrupoConEquipo, nroPedido)
                            Else
                                CodOpcion = Get_CodOpcionBBA(strEquipo, strListaPrecio, strCampana, strGrupoSinEquipo, nroPedido)
                            End If

                            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "		blnConEquipo: " & blnConEquipo)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "		CodOpcion: " & CodOpcion)

                            Dim blnEsBAM As Boolean
                            blnEsBAM = (CodOpcion <> "")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "		blnEsBAM: " & blnEsBAM)
                            If Not blnEsBAM Then
                                Dim codRespuesta As String
                                Dim idTransaccion As String = nroPedido
                                Dim ipAplicacion As String = CurrentTerminal
                                Dim nombreAplicacion As String = ConfigurationSettings.AppSettings("constAplicacion")
                                Dim chippack As String
                                Dim opcion As String
                                Dim msisdn As String = Telef
                                Dim numeroin As String = Telef
                                Dim promocion As String = Get_CodPromocion(strListaPrecio, strListPromo, nroPedido)
                                Dim tipoActivacion As String
                                Dim tipoProducto As String
                                Dim adicional1 As String
                                Dim adicional2 As String
                                Dim puntoVenta As String
                                Dim departamento As String = cod_Region
                                Dim fechaRegistro As Date = Now
                                Dim origen As String = ConfigurationSettings.AppSettings("WSRegistroDatosVentaPrepago_origen")
                                Dim imei As String = strIMEI
                                Dim iccid As String = strICCID
                                Dim codpromo As String
                                Dim offer As String
                                Dim subscriberstatusFinal As String
                                Dim usuario As String = CurrentUser
                                Dim mensajeRespuesta As String

                                Dim oRegistroVenta As New RegistroDatosVentaPrepago

                                objFileLog.EscribirLog(pathFile, strArchivo, idLog, "Inicio registrarVenta " & ConfigurationSettings.AppSettings("WSRegistroDatosVentaPrepago_url"))
                                objFileLog.EscribirLog(pathFile, strArchivo, idLog, "           IN idTransaccion: " & idTransaccion)
                                objFileLog.EscribirLog(pathFile, strArchivo, idLog, "           IN ipAplicacion: " & ipAplicacion)
                                objFileLog.EscribirLog(pathFile, strArchivo, idLog, "           IN nombreAplicacion: " & nombreAplicacion)
                                objFileLog.EscribirLog(pathFile, strArchivo, idLog, "           IN chippack: " & chippack)
                                objFileLog.EscribirLog(pathFile, strArchivo, idLog, "           IN opcion: " & opcion)
                                objFileLog.EscribirLog(pathFile, strArchivo, idLog, "           IN msisdn: " & msisdn)
                                objFileLog.EscribirLog(pathFile, strArchivo, idLog, "           IN numeroin: " & numeroin)
                                objFileLog.EscribirLog(pathFile, strArchivo, idLog, "           IN promocion: " & promocion)
                                objFileLog.EscribirLog(pathFile, strArchivo, idLog, "           IN tipoActivacion: " & tipoActivacion)
                                objFileLog.EscribirLog(pathFile, strArchivo, idLog, "           IN tipoProducto: " & tipoProducto)
                                objFileLog.EscribirLog(pathFile, strArchivo, idLog, "           IN adicional1: " & adicional1)
                                objFileLog.EscribirLog(pathFile, strArchivo, idLog, "           IN adicional2: " & adicional2)
                                objFileLog.EscribirLog(pathFile, strArchivo, idLog, "           IN puntoVenta: " & puntoVenta)
                                objFileLog.EscribirLog(pathFile, strArchivo, idLog, "           IN departamento: " & departamento)
                                objFileLog.EscribirLog(pathFile, strArchivo, idLog, "           IN fechaRegistro: " & fechaRegistro)
                                objFileLog.EscribirLog(pathFile, strArchivo, idLog, "           IN origen: " & origen)
                                objFileLog.EscribirLog(pathFile, strArchivo, idLog, "           IN imei: " & imei)
                                objFileLog.EscribirLog(pathFile, strArchivo, idLog, "           IN iccid: " & iccid)
                                objFileLog.EscribirLog(pathFile, strArchivo, idLog, "           IN codpromo: " & codpromo)
                                objFileLog.EscribirLog(pathFile, strArchivo, idLog, "           IN offer: " & offer)
                                objFileLog.EscribirLog(pathFile, strArchivo, idLog, "           IN subscriberstatusFinal: " & subscriberstatusFinal)
                                objFileLog.EscribirLog(pathFile, strArchivo, idLog, "           IN usuario: " & usuario)

                                codRespuesta = oRegistroVenta.registrarVenta(idTransaccion, ipAplicacion, nombreAplicacion, chippack, opcion, msisdn, numeroin, promocion, tipoActivacion, tipoProducto, adicional1, adicional2, puntoVenta, departamento, fechaRegistro, origen, imei, iccid, codpromo, offer, subscriberstatusFinal, usuario, mensajeRespuesta)

                                objFileLog.EscribirLog(pathFile, strArchivo, idLog, "           OUT codRespuesta: " & codRespuesta)
                                objFileLog.EscribirLog(pathFile, strArchivo, idLog, "           OUT mensajeRespuesta: " & mensajeRespuesta)
                                objFileLog.EscribirLog(pathFile, strArchivo, idLog, "Fin registrarVenta")

                            End If
                        Catch ex As Exception
                            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "Error :" & ex.Message.ToString())
                        End Try
                    End If
                Else
                    objFileLog.EscribirLog(pathFile, strArchivo, idLog, "No tiene Codido de Material")
                End If
            Next
        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & "- " & "ERROR RegistroDatosVentaPrepago : " & ex.Message.ToString())
        Finally
            objFileLog.EscribirLog(pathFile, strArchivo, idLog, "Fin RegistroDatosVentaPrepago ")
        End Try
    End Sub

    Private Sub ProcesoRenovacionCAC(ByVal dsPedido As DataSet, ByVal nroDocSap As String, ByRef idInteracccion1 As String, ByRef cuentaRedVendedor As String, ByVal NroSec As String, ByVal nroContrato As String)

        Dim strIdentifyLog As String = nroDocSap
        Dim dsDatosVenta As New DataSet

        Dim n_tipoprod As String
        Dim n_nrolinea As String
        Dim n_Plazo As String
        Dim n_Campana As String = ""
        Dim n_Plan As String = ""
        Dim n_Cargofijo As String
        Dim n_CargofijoN As String
        Dim n_EquipoEval As String
        Dim n_pventaEquipo As String
        Dim n_EquipoDesc As String
        Dim n_EquipoCod As String
        Dim n_EquipoSerie As String
        Dim n_ListaPrecio As String
        Dim n_PreVentaEquipo As String = ""
        Dim n_DctoEquipo As String
        Dim n_ChipDesc As String
        Dim n_ChipCodigo As String
        Dim n_ChipSerie As String
        Dim n_chipPrecio As String
        Dim n_chipDcto As String
        Dim n_MotivRenov As String
        Dim n_ClaroPuntosUti As String
        Dim n_DctoSoles As String
        Dim n_PrecioEquipo As String
        Dim n_totalpagar As String
        Dim strcadena1 As String
        Dim strcadena2 As String
        Dim strcadena3 As String
        Dim strcadena4 As String
        Dim strcadenaRenoReten As String = "" 'INICIATIVA 315 - JFG
        Dim strCadenaNota As String
        Dim n_Descuento As String
        Dim n_NroSec As String
        Dim n_NroContrato As String = nroContrato
        Dim objClsConsultaPvu As New COM_SIC_Activaciones.clsConsultaPvu


        Dim retornoCambioSIM As String
        Dim mensajeCambioSIM As String
        Dim strEmpleado As String
        Dim errorCambioSIM As String

        Dim oCambioSIM As New COM_SIC_INActChip.clsCambioSIM

        Dim strIP As String
        Dim strID As String
        '<33062>
        Dim correo As String
        Dim flag_afilia_correo As String
        '<33062>

        'INI: INICIATIVA-219 | RENOVACION
        Dim objActivacionCBIO As New ClsActivacionCBIO
        Dim objEncolarCBIO As New BWEncolarTransaccionesCBIO
        Dim objReposicionRequest As New EncolarTransaccionRequest
        Dim objReposicionResponse As New EncolarTransaccionResponse
        Dim objAuditoriaWS As New AuditoriaEWS
        Dim strTipoOperacionEncCBIO As String = String.Empty
        Dim blnTransaccionCBIO As Boolean = False
        Dim strCodResp = String.Empty
        Dim strMsgResp = String.Empty
        Dim strNumeroTelefono = String.Empty
        Dim strCodSerie = String.Empty
        Dim arrListaNum As ArrayList
        Dim objAct As New ClsActivacionCBIO
        Dim objCBIO As New BLDatosCBIO
        Dim objConsultaPvu As New clsConsultaPvu
        Dim dsClienteDatos As New DataSet
        Dim strCorreo As String = String.Empty
        Dim strTipoDocumento As String = String.Empty
        Dim strNroDocumento As String = String.Empty
        Dim blActualizarAfiliacionCorreoCBIO As Boolean = False
        Dim blActualizarLimiteCreditoCBIO As Boolean = False
        Dim strTipoOperacionReno As String = String.Empty
        'FIN: INICIATIVA-219 | RENOVACION

        strEmpleado = AppstrUsuario

        Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "-----------------------------------------------")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         Inicio ProcesoRenovacionCAC           ")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "-----------------------------------------------")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   Inicio ObtenerDatosVenta: [IN Doc SAP" & nroDocSap & "]")

            dsDatosVenta = (New COM_SIC_Activaciones.clsConsultaPvu).ObetenerDatosVenta(nroDocSap)

            n_tipoprod = AppstrTipo_Prod_Des

            For n As Integer = 0 To dsPedido.Tables(1).Rows.Count - 1
                If dsPedido.Tables(1).Rows.Count = 1 Then
                    n_EquipoCod = Funciones.CheckStr(dsPedido.Tables(1).Rows(n).Item("DEPEC_CODMATERIAL"))
                    n_EquipoDesc = Funciones.CheckStr(dsPedido.Tables(1).Rows(n).Item("DEPEV_DESCMATERIAL"))
                    n_ListaPrecio = Funciones.CheckStr(dsPedido.Tables(1).Rows(n).Item("DEPEV_DESCRIPCIONLP"))
                    n_EquipoSerie = Funciones.CheckStr(dsPedido.Tables(1).Rows(n).Item("SERIC_CODSERIE"))

                    If Not dsDatosVenta Is Nothing Then
                        If dsDatosVenta.Tables(0).Rows.Count > 0 Then

                            For Each item As DataRow In dsDatosVenta.Tables(0).Rows
                                If n_EquipoSerie = item("SERIE") Then
                                    n_Campana = Funciones.CheckStr(item("DESC_CAMPANA"))
                                    n_Plan = Funciones.CheckStr(item("DESC_PLAN"))
                                    Exit For
                                End If
                            Next

                        End If
                    End If
                    'n_PreVentaEquipo = dsPedido.Tables(1).Rows(n).Item("DEPEN_PRECIOVENTA")
                    'n_DctoEquipo = dsPedido.Tables(1).Rows(n).Item("DESCUENTO") 'OJO
                    n_nrolinea = FormatoTelefono(Funciones.CheckStr(dsPedido.Tables(1).Rows(n).Item("DEPEV_NROTELEFONO")))
                    n_NroContrato = nroContrato

                Else
                    If n = 0 Then
                        n_ChipCodigo = dsPedido.Tables(1).Rows(n).Item("DEPEC_CODMATERIAL")
                        n_ChipDesc = dsPedido.Tables(1).Rows(n).Item("DEPEV_DESCMATERIAL")
                        n_ChipSerie = dsPedido.Tables(1).Rows(n).Item("SERIC_CODSERIE")
                        n_chipPrecio = dsPedido.Tables(1).Rows(n).Item("DEPEN_PRECIOVENTA")
                        'n_chipDcto = dsPedido.Tables(1).Rows(n).Item("DESCUENTO") 'OJO
                    Else
                        n_EquipoCod = Funciones.CheckStr(dsPedido.Tables(1).Rows(n).Item("DEPEC_CODMATERIAL"))
                        n_EquipoDesc = Funciones.CheckStr(dsPedido.Tables(1).Rows(n).Item("DEPEV_DESCMATERIAL"))
                        n_ListaPrecio = Funciones.CheckStr(dsPedido.Tables(1).Rows(n).Item("DEPEV_DESCRIPCIONLP"))
                        n_EquipoSerie = Funciones.CheckStr(dsPedido.Tables(1).Rows(n).Item("SERIC_CODSERIE"))
                        n_PrecioEquipo = dsPedido.Tables(1).Rows(n).Item("DEPEN_PRECIOVENTA")

                        If Not dsDatosVenta Is Nothing Then
                            If dsDatosVenta.Tables(0).Rows.Count > 0 Then

                                For Each item As DataRow In dsDatosVenta.Tables(0).Rows
                                    If n_EquipoSerie = item("SERIE") Then
                                        n_Campana = Funciones.CheckStr(item("DESC_CAMPANA"))
                                        n_Plan = Funciones.CheckStr(item("DESC_PLAN"))
                                        Exit For
                                    End If
                                Next

                            End If
                        End If
                        'n_PreVentaEquipo = dsPedido.Tables(1).Rows(n).Item("DEPEN_PRECIOVENTA")
                        'n_DctoEquipo = dsPedido.Tables(1).Rows(n).Item("DESCUENTO") 'OJO
                        n_nrolinea = FormatoTelefono(Funciones.CheckStr(dsPedido.Tables(1).Rows(n).Item("DEPEV_NROTELEFONO")))
                        n_NroContrato = nroContrato

                    End If
                End If
            Next
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   Fin ObtenerDatosVenta: [IN Doc SAP" & nroDocSap & "]")

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   Inicio ConsultaAcuerdoPCS: [IN Nro Contrato" & n_NroContrato & "]")

            Dim dsAcuerdo As DataSet = objClsConsultaPvu.ConsultaAcuerdoPCS(n_NroContrato, DBNull.Value)
            If Not dsAcuerdo Is Nothing Then
                If dsAcuerdo.Tables(0).Rows.Count > 0 Then
                    n_PreVentaEquipo = Funciones.CheckStr(dsAcuerdo.Tables(1).Rows(0).Item("PRECIO_VENTA"))
                End If
            End If

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     OUT Pre Venta Equipo: " & n_PreVentaEquipo)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   Fin ConsultaAcuerdoPCS: [IN Nro Contrato" & n_NroContrato & "]")

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   Inicio ConsultarClaroPuntosCanje: [IN Doc SAP" & nroDocSap & "]")
            Dim objCajas As New COM_SIC_Cajas.clsCajas
            Dim result As String = objCajas.ConsultarClaroPuntosCanje(nroDocSap)
            Dim rs As String() = result.Split(New Char() {","})

            If rs(0) = "" Then
                n_ClaroPuntosUti = "0"
            Else
                n_ClaroPuntosUti = rs(0)
            End If

            If rs(1) = "" Then
                n_DctoSoles = "0"
            Else
                n_DctoSoles = rs(1)
            End If
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   Fin ConsultarClaroPuntosCanje: [OUT result: " & n_ClaroPuntosUti & ", " & n_DctoSoles & "]")

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   Inicio ConsultarDatosComplementariosVentaRenovacion: [IN Doc SAP" & nroDocSap & "]")
            Dim rslt As String = objCajas.ConsultarDatosComplementariosVentaRenovacion(nroDocSap)
            Dim rsl As String() = rslt.Split(New Char() {","})

            If rsl(0) = "" Then
                n_Descuento = "0"
            Else
                n_Descuento = rsl(0)
            End If

            If rsl(1) = "" Then
                n_Cargofijo = "0"
            Else
                n_Cargofijo = rsl(2)
            End If

            If rsl(2) = "" Then
                n_CargofijoN = "0"
            Else
                n_CargofijoN = rsl(2)
            End If

            If rsl(3) = "" Then
                n_MotivRenov = ""
            Else
                n_MotivRenov = rsl(3)
            End If

            'If rsl(4) = "" Then
            '    n_NroSec = ""
            'Else
            '    n_NroSec = rsl(4)
            'End If
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   Fin ConsultarDatosComplementariosVentaRenovacion: [OUT result: " & n_Descuento & ", " & n_Cargofijo & ", " & n_CargofijoN & ", " & n_MotivRenov & ", " & NroSec & "]")

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   Inicio ObtenerSolicitudPersonaCons: [IN Nro SEC" & NroSec & "]")

            Dim oSolicitud As clsSolicitudPersona
            oSolicitud = (New COM_SIC_Activaciones.ClsCambioPlanPostpago).ObtenerSolicitudPersonaCons(NroSec)
            n_Plazo = Funciones.CheckStr(oSolicitud.PACUV_DESCRIPCION)

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   Fin ObtenerSolicitudPersonaCons: [OUT Plazo" & n_Plazo & "]")
            Dim precioEquipo As String = Convert.ToString(Math.Round(Convert.ToDouble(n_PrecioEquipo), 2))
            Dim precioChip As String = Convert.ToString(Math.Round(Convert.ToDouble(n_chipPrecio), 2))
            Dim totpagar As Double = Convert.ToDouble(Math.Round(Convert.ToDouble(n_PrecioEquipo), 2)) + Convert.ToDouble(Math.Round(Convert.ToDouble(n_chipPrecio), 2)) - Convert.ToDouble(n_Descuento) - Convert.ToDouble(n_DctoSoles)

            n_totalpagar = totpagar

            strcadena1 = "RESUMEN DE COMPRAS:" & "TIPO PRODUCTO:" & n_tipoprod & "," & "NUMERO LINEA:" & n_nrolinea & "," & "PLAZO:" & n_Plazo _
            & "," & "PLAN:" & n_Plan & "," & "CAMPAÑA:" & n_Campana & "," & "EQUIPO:" & n_EquipoDesc & "," & "CARGO FIJO:" & n_Cargofijo & "," & "PRECIO VENTA EQUIPO:" & precioEquipo


            strcadena2 = "DATOS DE EQUIPO:" & "DESCRIPCION EQUIPO:" & n_EquipoDesc & "," & "CODIGO EQUIPO:" & n_EquipoCod & "," & "SERIE EQUIPO:" & n_EquipoSerie & "," & "LISTA DE PRECIOS:" & n_ListaPrecio _
            & "," & "PRECIO VENTA:" & n_PreVentaEquipo & "," & "DESCUENTO EQUIPO:" & n_Descuento & "  " & "DESCRIPCION CHIP:" & n_ChipDesc & "," & "CODIGO CHIP:" & n_ChipCodigo & "," & " SERIE CHIP:" & n_ChipSerie _
            & "," & "MOTIVO RENOVACION:" & n_MotivRenov & "," & "NUMERO LINEA:" & n_nrolinea

            strcadena3 = "CLARO PUNTOS A UTILIZAR:" & " " & n_ClaroPuntosUti & "," & "DESCUENTO EN SOLES:" & n_DctoSoles

            strcadena4 = "DATOS VENTA:" & "PRECIO DE EQUIPO:" & precioEquipo & "," & "TOTAL A PAGAR:" & n_totalpagar

            'INI: PROY 26210 - RMZ
            Dim strcadena5 As String
            strcadena5 = "NRO SEC: " & NroSec

            strCadenaNota = strcadena1 & vbCrLf & strcadena2 & vbCrLf & strcadena3 & vbCrLf & strcadena4 & vbCrLf & strcadena5
            'FIN: PROY 26210 - RMZ
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     cadena: " & strCadenaNota)

            If dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVPostpago") And _
                                dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION") = ConfigurationSettings.AppSettings("strDTVRenovacion") Then

                Dim vendedor As String
                Dim tipoRenovacion As String
                Dim flagExoneracion, flagDescuento As Integer
                Dim flagFidelizadoRetenido As String
                Dim numeroTelefono As String = FormatoTelefonoPrepago(Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO")))
                Dim documentoSAP As String = drPagos.Item("PEDIN_NROPEDIDO")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     cadena: " & strCadenaNota)
                Dim objVentaRenovacion As COM_SIC_Cajas.VentaRenovaPost

                Try
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA"))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION"))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         IN Documento SAP: " & documentoSAP)
                    objVentaRenovacion = (New COM_SIC_Cajas.clsCajas).ConsultarVentaRenovPostCAC(documentoSAP)
                Catch ex As Exception
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Exception ConsultarVentaRenovPostCAC()---" & ex.Message)
                Finally
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " objVentaRenovacion.DOC_CLIEN_NUMERO : " & objVentaRenovacion.DOC_CLIEN_NUMERO) 'ADD: PROY 26210 - RMZ
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Fin ConsultarVentaRenovPostCAC()---")
                End Try

                If Not objVentaRenovacion Is Nothing Then
                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - objVentaRenovacion.DOC_CLIEN_NUMERO : {1}", strIdentifyLog, Funciones.CheckStr(objVentaRenovacion.DOC_CLIEN_NUMERO))) 'INC000001089654
                    Try
                        If objCajas.ActualizarInteraccion_VentaRenovPostCAC("0", documentoSAP) Then
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Actualizó correctamente Flag Cuota")
                        Else
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "No Actualizó correctamente Flag Cuota")
                        End If
                    Catch ex As Exception
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "No Actualizó correctamente Flag Cuota: " & ex.Message.ToString())
                    End Try


                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Si existem Venta Renovacion Post()---")

                    cuentaRedVendedor = objVentaRenovacion.VENDEDOR
                    vendedor = objVentaRenovacion.VENDEDOR
                    tipoRenovacion = objVentaRenovacion.TIPO_RENOVACION.ToUpper()
                    flagExoneracion = objVentaRenovacion.FLAG_EXONERACION
                    flagDescuento = objVentaRenovacion.FLAG_DESCUENTO
                    flagFidelizadoRetenido = objVentaRenovacion.FLAG_FIDELIZADO_RETENIDO
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "vendedor:" & vendedor)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "tipoRenovacion:" & tipoRenovacion)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "flagExoneracion:" & flagExoneracion)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "flagDescuento:" & flagDescuento)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "flagFidelizadoRetenido:" & flagFidelizadoRetenido)

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "n_ClaroPuntosUti:" & flagDescuento)
                    'If CheckInt(n_ClaroPuntosUti) > 0 Then
                    '    Dim InteraccionClaroPuntos As String = TipificacionCanjePunto(numeroTelefono, documentoSAP, vendedor, "")
                    '    Dim resultado As Boolean = (New COM_SIC_Cajas.clsCajas).ActualizarCanjePuntosCC(documentoSAP, documentoSAP, CurrentUser, "1")

                    'End If

                    Dim Flag_chip As String = objVentaRenovacion.FLAG_CHIP

                    '<33062>
                    Dim strNroTelefono As String = FormatoTelefono(Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO")))
                    Dim strDescTipoOperacion As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIV_DESCTIPOOPERACION"))
                    flag_afilia_correo = objVentaRenovacion.FLAG_AFILIA_CORREO

                    Dim datosConsulta As String()
                    datosConsulta = ServicioSIACPostpagoConsultas("", strNroTelefono).Split("|")
                    Dim strCustomerID As String = Funciones.CheckStr(datosConsulta(0))
                    Dim strFlagAct As String = "X"
                    Dim strCuenta As String

                    'INI: INICIATIVA-219 | RENOVACION
                    strNumeroTelefono = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO"))
                    strCodSerie = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("SERIC_CODSERIE"))
                    strTipoOperacionReno = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION"))
                    strTipoDocumento = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("CLIEC_TIPODOCCLIENTE"))
                    strNroDocumento = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("CLIEV_NRODOCCLIENTE"))

                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [{0} : {1}]", "Consulta origen linea", Funciones.CheckStr(strNumeroTelefono)))

                    arrListaNum = objActivacionCBIO.consultaTransaccion(strNumeroTelefono, strTipoOperacionReno, strCodResp, strMsgResp) 'Consultar Si la transacción va por CBIO

                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [{0} : {1}]", "strCodResp", Funciones.CheckStr(strCodResp)))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [{0} : {1}]", "strMsgResp", Funciones.CheckStr(strMsgResp)))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [{0} : {1}]", "CarrListaPrepago", IIf(arrListaNum Is Nothing, "No Existe", arrListaNum.Count.ToString)))

                    dsClienteDatos = objConsultaPvu.ConsultaCorreoCliente(strTipoDocumento, strNroDocumento, strCodResp, strMsgResp) 'Consultar correo electronico del cliente
                    strCorreo = Funciones.CheckStr(dsClienteDatos.Tables(0).Rows(0).Item("CLIEV_CORREO_FACT"))

                    If (Not IsNothing(arrListaNum)) Then
                        If (arrListaNum.Count > 0) Then
                            blnTransaccionCBIO = True
                        End If
                    End If
                    'FIN: INICIATIVA-219 | RENOVACION

                    Dim InsertaMailResult As Boolean

                    If (flag_afilia_correo <> "0" And flag_afilia_correo.Trim() <> "") Then
                       Dim dsConsultaDatosCliente As DataSet
                        Dim k_nrolog As Long
                        Dim k_deslog As String
                        Dim clsConsultaPvu As New COM_SIC_Activaciones.clsConsultaPvu
                    
                        Dim strTipoDocCliente As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("CLIEC_TIPODOCCLIENTE"))
                        Dim strNroDocCliente As String = objVentaRenovacion.DOC_CLIEN_NUMERO

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "strTipoDocCliente: " & strTipoDocCliente)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "strNroDocCliente: " & strNroDocCliente)

                        dsConsultaDatosCliente = clsConsultaPvu.consultaDatosCliente(strTipoDocCliente, strNroDocCliente, k_nrolog, k_deslog)

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "dsConsultaDatosCliente.Tables(0).Rows.Count: " & dsConsultaDatosCliente.Tables(0).Rows.Count)
                        If dsConsultaDatosCliente.Tables(0).Rows.Count > 0 Then
                            correo = Funciones.CheckStr(dsConsultaDatosCliente.Tables(0).Rows(0).Item("CLIEV_E_MAIL"))
                        End If
                        '<33062>
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Consulta al Método FP_InsertaMail")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Parámetros de Entrada: " & "CustomerID -> " & strCustomerID & " ; Cuenta -> " & String.Empty & " ; Correo -> " & correo & " ; FlagAct -> " & strFlagAct)
                        '<33062>


                        InsertaMailResult = (New COM_SIC_Cajas.clsCajas).FP_InsertaMail(strCustomerID, strCuenta, correo, strFlagAct)

                        If (InsertaMailResult) Then
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "***El método FP_InsertaMail se ha ejecutado correctamente***")

                            'Proceso de creación de Interacción
                            Dim flagConsulta As String = ""
                            Dim mensajeError As String = ""
                            Dim idInteraccion As String = ""
                            Dim isIFI As Boolean = AppstrTipo_Prod_Des = "IFI"
                            Dim strNotasInteraccion As String = ConfigurationSettings.AppSettings("TIPI_AFL_NOTAS_TEXTO")
                            strNotasInteraccion = strNotasInteraccion & "OPERACIÓN: " & strDescTipoOperacion
                            strNotasInteraccion = strNotasInteraccion & " SEC: " & NroSec
                            strNotasInteraccion = strNotasInteraccion & " ASESOR: " & CurrentUser

                            Dim oPlantillaReno As New COM_SIC_INActChip.Interaccion
                            Dim oTipificacion As New COM_SIC_INActChip.clsTipificacion

                            oPlantillaReno.TELEFONO = strNroTelefono
                            oPlantillaReno.TIPO = IIf(isIFI, Funciones.CheckStr(oTipiConfiguration.KeyTipoIFI), ConfigurationSettings.AppSettings("TIPI_AFL_TIPO_POSTPAGO"))
                            oPlantillaReno.CLASE = IIf(isIFI, Funciones.CheckStr(oTipiConfiguration.KeyClaseAfiliacionReciboIFI), ConfigurationSettings.AppSettings("TIPI_AFL_CLASE_VAR_SER"))
                            oPlantillaReno.SUBCLASE = IIf(isIFI, Funciones.CheckStr(oTipiConfiguration.KeySubClaseAfiliacionReciboIFI), ConfigurationSettings.AppSettings("TIPI_AFL_SUB_CLASE_RECIBO_CORREO"))
                            oPlantillaReno.TIPO_CODIGO = IIf(isIFI, Funciones.CheckStr(oTipiConfiguration.KeyCodTipoIFI), ConfigurationSettings.AppSettings("COD_TIPI_AFL_TIPO_POSTPAGO"))
                            oPlantillaReno.CLASE_CODIGO = IIf(isIFI, Funciones.CheckStr(oTipiConfiguration.KeyCodClaseAfiliacionReciboIFI), ConfigurationSettings.AppSettings("COD_TIPI_AFL_CLASE_VAR_SER"))
                            oPlantillaReno.SUBCLASE_CODIGO = IIf(isIFI, Funciones.CheckStr(oTipiConfiguration.KeyCodSubClaseAfiliacionReciboIFI), ConfigurationSettings.AppSettings("COD_TIPI_AFL_SUB_CLASE_RECIBO_CORREO"))
                            oPlantillaReno.TIPO_INTER = IIf(isIFI, Funciones.CheckStr(oTipiConfiguration.KeyConstanteEntrante), String.Empty)
                            oPlantillaReno.METODO = ConfigurationSettings.AppSettings("TIPI_AFL_METODO_NC")
                            oPlantillaReno.RESULTADO = ConfigurationSettings.AppSettings("TIPI_AFL_RESULTADO_NC")
                            oPlantillaReno.HECHO_EN_UNO = IIf(isIFI, Funciones.CheckStr(oTipiConfiguration.KeyConstanteZero), String.Empty)
                            oPlantillaReno.NOTAS = strNotasInteraccion
                            oPlantillaReno.FLAG_CASO = ConfigurationSettings.AppSettings("TIPI_AFL_FLAG_NC")
                            oPlantillaReno.USUARIO_PROCESO = IIf(isIFI, Funciones.CheckStr(oTipiConfiguration.KeyUserSU), ConfigurationSettings.AppSettings("TIPI_AFL_USER"))
                            oPlantillaReno.AGENTE = vendedor

                            Try
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "INICIO - " & "Registrar Tipificacion Afiliación al Recibo por Correo")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "strNroTelefono: " & strNroTelefono)
                                oTipificacion.CrearInteraccion(oPlantillaReno, idInteraccion, flagConsulta, mensajeError)
                            Catch ex As Exception
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-" & "--- Exception CrearInteraccion()---" & ex.Message)
                            Finally
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "idInteraccion: " & idInteraccion)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "flagConsulta: " & flagConsulta)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "mensajeError: " & mensajeError)
                            End Try

                            'Proceso de creación de Plantilla de la Tipificación
                            If Not idInteraccion = "" Then

                                Dim oClient As New clsClienteBSCS
                                Dim oPlantilla1 As New COM_SIC_INActChip.PlantillaInteraccion

                                Dim flagInter As String
                                Dim mensajeInter As String

                                oPlantilla1.X_PLUS_INTER2INTERACT = CheckDbl(idInteraccion)
                                oPlantilla1.X_INTER_15 = dsPedido.Tables(0).Rows(0).Item("OFICV_CODOFICINA")
                                oPlantilla1.X_INTER_17 = ConfigurationSettings.AppSettings("strActivacion")
                                oPlantilla1.X_DOCUMENT_NUMBER = objVentaRenovacion.DOC_CLIEN_NUMERO
                                oPlantilla1.X_EMAIL = correo
                                oplantilla1.X_CLARO_NUMBER = strNroTelefono

                                If isIFI Then
                                    oClient = ObtenerDatosCliente(strNroTelefono)

                                    oplantilla1.NOMBRE_TRANSACCION = Funciones.CheckStr(oTipiConfiguration.KeyTrxReciboEmailIFI)
                                    oplantilla1.X_INTER_20 = Funciones.CheckStr(oTipiConfiguration.KeyFmtAfiliacionReciboIFI)
                                    oplantilla1.X_INTER_21 = DateTime.Now.ToShortDateString
                                    oplantilla1.X_INTER_29 = oClient.razonSocial
                                    oplantilla1.X_TYPE_DOCUMENT = oClient.tip_doc
                                    oplantilla1.X_ADDRESS = oClient.direccion_fac
                                    oplantilla1.X_REFERENCE_ADDRESS = oClient.urbanizacion_fac
                                    oplantilla1.X_DEPARTMENT = oClient.departamento_fac
                                    oplantilla1.X_CITY = oClient.provincia_fac
                                    oplantilla1.X_DISTRICT = oClient.distrito_fac
                                    oplantilla1.X_REFERENCE_PHONE = oClient.telef_principal
                                    oplantilla1.X_INTER_1 = correo
                                Else
                                oPlantilla1.X_REASON = ConfigurationSettings.AppSettings("TIPI_AFL_DESCRIPCION")
                                oPlantilla1.X_OPERATION_TYPE = strDescTipoOperacion
                                End If

                                Try
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "INICIO - " & "Insertar Plantilla Interacción Afiliación al Recibo por Correo")
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "idInteraccion: " & idInteraccion)
                                    oTipificacion.InsertarPlantillaInteraccion(oPlantilla1, idInteraccion, flagInter, mensajeInter)
                                Catch ex As Exception
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-" & "--- Exception InsertarPlantillaInteraccion()---" & ex.Message)
                                Finally
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "flagInter:" & Funciones.CheckStr(flagInter))
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "mensajeInter:" & Funciones.CheckStr(mensajeInter))
                                End Try
                            End If
                        Else
                            AppmsgErrorInsertaMail = ConfigurationSettings.AppSettings("StrErrorInsertaMail")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "***Error al ejecutar el método FP_InsertaMail***")
                        End If
                    End If
                    '</33062>


                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Flag_chip:" & Flag_chip)
                    Dim cicloFact As String = objVentaRenovacion.CICLO_FACT
                    Dim fechaFact, fechaMig As String
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "CALCULO DE FECHA FACT:" & ConfigurationSettings.AppSettings("CONS_FECHA_CONSULTA").ToString())

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INICIO CalcularFechaTopeProgramacion - Interaccion")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "IN - " & cicloFact)
                    fechaMig = CalcularFechaTopeProgramacion(cicloFact, strIdentifyLog)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "OUT - " & fechaMig)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FIN CalcularFechaTopeProgramacion")
                    

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Flag_chip:" & Flag_chip)

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "cicloFact:" & cicloFact)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "fechaMig:" & fechaMig)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "fechaFact:" & fechaFact)
                    If CheckInt(n_ClaroPuntosUti) > 0 Then
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "CLARO PUNTOS:" & n_ClaroPuntosUti)
                        Dim idInteraccion As String = "" 'TipificacionCanjePunto(numeroTelefono, documentoSAP, vendedor, "")
                        Dim resultado As Boolean = (New COM_SIC_Cajas.clsCajas).ActualizarCanjePuntosCC(documentoSAP, documentoSAP, CurrentUser, "1")
                        'inicio whzr 19062015
                        Dim ResultCanjePuntos As Boolean = (New COM_SIC_Cajas.clsCajas).ActualizaInteraccionCanjePuntos(documentoSAP, idInteraccion)
                        'fin whzr 19062015
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ResultCanjePuntos:" & ResultCanjePuntos)
                    End If

                    Dim notasCambioPlan As String
                    notasCambioPlan = "Nuevo Plan: " & objVentaRenovacion.PLAN_NUEVO & vbCrLf
                    notasCambioPlan = notasCambioPlan & "Tipo de Tope de Consumo: " & objVentaRenovacion.TOPE_CONSUMO & vbCrLf
                    notasCambioPlan = notasCambioPlan & "Servicios Adicionales que solicita o desea mantener: " & vbCrLf
                    notasCambioPlan = notasCambioPlan & "RU: " & objVentaRenovacion.LIMITE_CREDITO.ToString() & vbCrLf
                    notasCambioPlan = notasCambioPlan & "Fecha de Migración: " & fechaMig & vbCrLf 'MOD: PROY 26210 - RMZ
                    notasCambioPlan = notasCambioPlan & "Nro SEC: " & NroSec 'PROY 26210 ADD RMZ
                    'PROY-30166 -IDEA-38863 - INICIO
                    notasCambioPlan = notasCambioPlan & "Nro SEC: " & NroSec  & vbCrLf 'PROY 26210 ADD RMZ
                    If dblMontoCuotaInicial > 0 Then
                        notasCambioPlan = notasCambioPlan & "MONTO CUOTA INICIAL : " & dblMontoCuotaInicial
                    End If
                    'PROY-30166 -IDEA-38863 - FIN 
					
                    'Inicio Renovacion  B2E - Incidencia Tipi Cambio Plan JAZ
                    Dim DsCanjeEquipo As DataSet
                    Dim vObClsTrsPvu As New COM_SIC_Activaciones.clsTrsPvu
                    Dim vCursorxIdPedidoActual As Object
                    Dim vCodRpta As Integer
                    Dim vMsjRpta As String
                    Dim dtAcuerdoRenovacion As New DataTable
                    Dim sMontoReintegro As String = ""
                    'Fin Renovacion  B2E - Incidencia Tipi Cambio Plan
                    DsCanjeEquipo = vObClsTrsPvu.ConsultaEstRenoAnticipada(CheckInt(documentoSAP), vCursorxIdPedidoActual, vCodRpta, vMsjRpta)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "vCodRpta:" & CheckStr(vCodRpta))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "vMsjRpta:" & CheckStr(vMsjRpta))
                    If Not IsNothing(DsCanjeEquipo) AndAlso DsCanjeEquipo.Tables(0).Rows.Count > 0 Then
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Es reno anticipada")
                        dtAcuerdoRenovacion = DsCanjeEquipo.Tables(0)
                        sMontoReintegro = Funciones.CheckStr(dtAcuerdoRenovacion.Rows(0)("SARN_MONTO_ORIGINAL"))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "monto reintegro:" & sMontoReintegro)
                    End If
                    'Fin Renovacion  B2E - Incidencia Tipi Cambio Plan JAZ

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " VIGENCIA_PLAN:" & CheckStr(objVentaRenovacion.VIGENCIA_PLAN))

                    If objVentaRenovacion.VIGENCIA_PLAN <> "N" Then

                        Dim FlagMetodo As String = ""
                        Dim MensajeTipi As String = ""
                        Dim strInteraccion As String = TipificacionCambioPlanRenov(numeroTelefono, documentoSAP, vendedor, notasCambioPlan, FlagMetodo, MensajeTipi)

                        Dim oTipificacion As New COM_SIC_INActChip.clsTipificacion
                        Dim oPlantilla1 As New COM_SIC_INActChip.PlantillaInteraccion
                        Dim flagInter As String
                        Dim mensajeInter As String

                        'For ii As Integer = 0 To dtDetalleInterac.Rows.Count - 1
                        'oPlantilla1 = New COM_SIC_INActChip.PlantillaInteraccion
                        oPlantilla1.X_INTER_15 = dsPedido.Tables(0).Rows(0).Item("OFICV_CODOFICINA")
                        oPlantilla1.X_DOCUMENT_NUMBER = objVentaRenovacion.DOC_CLIEN_NUMERO
                        oPlantilla1.X_REASON = dsPedido.Tables(0).Rows(0).Item("PEDIV_MOTIVOPEDIDO")
                        oPlantilla1.X_PLUS_INTER2INTERACT = CheckDbl(strInteraccion)  'Convert.ToDouble(strInteraccion)
                        oPlantilla1.X_INTER_16 = n_CargofijoN
                        oPlantilla1.X_EMAIL = objVentaRenovacion.PLAN_NUEVO
                        'gaa20180326 - PROY 26210
                        'oPlantilla1.X_EXPIRE_DATE = Convert.ToDateTime("04/19/2018") 'Convert.ToDateTime(fechaMig) 'COMENTADO: SALE ERROR - RMZ fechaMig
                        Dim cultureNameCaja As String = "es-PE"
                        Dim cultureCaja As CultureInfo = New CultureInfo(cultureNameCaja)
                        oPlantilla1.X_EXPIRE_DATE = Convert.ToDateTime(fechaMig, cultureCaja) 'Convert.ToDateTime(fechaMig) 'COMENTADO: SALE ERROR - RMZ fechaMig
                        'fin gaa20180326 - PROY 26210
                        oPlantilla1.X_INTER_19 = IIf(sMontoReintegro = "", "0", sMontoReintegro) '"cobro apadece" '

                        If (flagFidelizadoRetenido = "FIDELIZADO") Then 'REGULAR
                            oPlantilla1.X_INTER_20 = "1" '"fidelizacion"                            
                            oPlantilla1.X_INTER_1 = ConfigurationSettings.AppSettings("constFormaPagoTipi") '"forma de pago"
                            oPlantilla1.X_OLD_CLAROLOCAL1 = "0" 'Monto Fideliza Apadece
                            oPlantilla1.X_INTER_21 = IIf(sMontoReintegro = "", "0", sMontoReintegro) '"monto final apadece"
                        Else
                            oPlantilla1.X_INTER_20 = "0" '"fidelizacion"
                            oPlantilla1.X_INTER_1 = "" '"forma de pago"
                            oPlantilla1.X_OLD_CLAROLOCAL1 = IIf(sMontoReintegro = "", "0", sMontoReintegro) 'Monto Fideliza Apadece
                            oPlantilla1.X_INTER_21 = "0" '"monto final apadece"
                        End If

                        oPlantilla1.X_OPERATION_TYPE = objVentaRenovacion.TOPE_CONSUMO '"tope de consumo"                        
                        oPlantilla1.X_MODEL = ConfigurationSettings.AppSettings("constEscenarioTipiPOST_POST")

                        Dim vCodServicioTope As String
                        Dim vCargoFijoTope As String

 Try

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " ------ INICIO - ObtenerDatosTopeConsumo() ------")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " NroSec:" & CheckStr(NroSec))
                     
                        vObClsTrsPvu.ObtenerDatosTopeConsumo(Funciones.CheckInt64(NroSec), vCodServicioTope, vCargoFijoTope)
                        
 objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " vCodServicioTope:" & CheckStr(vCodServicioTope))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " vCargoFijoTope:" & CheckStr(vCargoFijoTope))

                            Catch ex As Exception
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR ObtenerDatosTopeConsumo(): " & ex.Message.ToString())
                            Finally
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " ------ FIN - ObtenerDatosTopeConsumo() ------")
                            End Try

                        oPlantilla1.X_REFERENCE_PHONE = CheckStr(vCargoFijoTope) '"cargo tope"
                        'gaa20180326 - PROY 26210
                        'oPlantilla1.X_BIRTHDAY = Convert.ToDateTime("04/19/2018") '"fecha ejecucion tope"Convert.ToDateTime(fechaMig)
                        oPlantilla1.X_BIRTHDAY = Convert.ToDateTime(fechaMig, cultureCaja) '"fecha ejecucion tope"Convert.ToDateTime(fechaMig)
                        'fin gaa20180326 ' - PROY 26210



 objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " ------ INICIO - Datos de Plantilla de Interaccion ------")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " X_INTER_15:" & CheckStr(oPlantilla1.X_INTER_15))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " X_DOCUMENT_NUMBER:" & CheckStr(oPlantilla1.X_DOCUMENT_NUMBER))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " X_REASON:" & CheckStr(oPlantilla1.X_REASON))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " X_PLUS_INTER2INTERACT:" & CheckStr(oPlantilla1.X_PLUS_INTER2INTERACT))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " X_INTER_16:" & CheckStr(oPlantilla1.X_INTER_16))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " X_EMAIL:" & CheckStr(oPlantilla1.X_EMAIL))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " X_EXPIRE_DATE:" & CheckStr(oPlantilla1.X_EXPIRE_DATE))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " X_INTER_19:" & CheckStr(oPlantilla1.X_INTER_19))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " X_INTER_20:" & CheckStr(oPlantilla1.X_INTER_20))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " X_INTER_1:" & CheckStr(oPlantilla1.X_INTER_1))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " X_OLD_CLAROLOCAL1:" & CheckStr(oPlantilla1.X_OLD_CLAROLOCAL1))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " X_INTER_21:" & CheckStr(oPlantilla1.X_INTER_21))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " X_OPERATION_TYPE:" & CheckStr(oPlantilla1.X_OPERATION_TYPE))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " X_MODEL:" & CheckStr(oPlantilla1.X_MODEL))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " X_REFERENCE_PHONE:" & CheckStr(oPlantilla1.X_REFERENCE_PHONE))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " X_BIRTHDAY:" & CheckStr(oPlantilla1.X_BIRTHDAY))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " ------ FIN - Datos de Plantilla de Interaccion ------")


                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "strInteraccion:" & Funciones.CheckStr(strInteraccion))

                        'Inicio SD854808 Relanzamiento Cambio de Plan JAZ                        
                        If strInteraccion = "" Then

                            'Realizando segundo relanzamiento de la tipi de cambio de plan
                            Dim sUsuarioSistema As String = ConfigurationSettings.AppSettings("CONS_REPOSICION_AGENTE")
                            Dim strInteraccionReintento As String = ""

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "-------------------------------------------")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo Tipificacion Cambio Plan 2°()")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "sUsuarioSistema:" & Funciones.CheckStr(sUsuarioSistema))
                            strInteraccionReintento = TipificacionCambioPlanRenov(numeroTelefono, documentoSAP, sUsuarioSistema, notasCambioPlan, FlagMetodo, MensajeTipi)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "strInteraccionReintento:" & Funciones.CheckStr(strInteraccionReintento))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FlagMetodo:" & Funciones.CheckStr(FlagMetodo))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "MensajeTipi:" & Funciones.CheckStr(MensajeTipi))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo Tipificacion Cambio Plan 2°()")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "-------------------------------------------")

                            If strInteraccionReintento = "" Then

                                Dim bResultadoRelan As Boolean = False
                                Dim nCodRespuesta As Integer
                                Dim sMsgRespuesta As String = ""
                                bResultadoRelan = RegistrarRelanzamientoCambioPlan(nroDocSap, MensajeTipi, nCodRespuesta, sMsgRespuesta)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "FIN - Registro de Relanzamiento Cambio de plan: " & bResultadoRelan.ToString)
                            Else
                                strInteraccion = strInteraccionReintento
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "-------------------------------------")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo InsertarPlantilla 2°()")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "strInteraccionReintento:" & Funciones.CheckStr(strInteraccionReintento))
                                oTipificacion.InsertarPlantillaInteraccion(oPlantilla1, strInteraccionReintento, flagInter, mensajeInter)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "mensajeInter:" & Funciones.CheckStr(mensajeInter))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "flagInter:" & Funciones.CheckStr(flagInter))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo InsertarPlantilla 2°()")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "-------------------------------------")
                            End If

                        Else
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "------------------------------------")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo InsertarPlantilla() 1°")
                            oTipificacion.InsertarPlantillaInteraccion(oPlantilla1, strInteraccion, flagInter, mensajeInter)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "flagInter:" & Funciones.CheckStr(flagInter))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "mensajeInter:" & Funciones.CheckStr(mensajeInter))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo InsertarPlantilla() 1°")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "------------------------------------")
                        End If
                        'Fin SD854808 Relanzamiento Cambio de Plan JAZ


                        'INICIO CAMBIO DE PLAN 09022015
                        Try
                            If ConfigurationSettings.AppSettings("flagCambioPlan") = "1" Then
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ServicioCambioPlan(strInteraccion):" & strInteraccion)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ServicioCambioPlan(documentoSAP):" & documentoSAP)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ServicioCambioPlan(NroSec):" & NroSec)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ServicioCambioPlan(numeroTelefono):" & numeroTelefono)
                                Dim bolCambioPlan As Boolean = ServicioCambioPlanPostPago(strInteraccion, documentoSAP, NroSec, numeroTelefono)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Valor del Cambio de Plan:" & Funciones.CheckStr(bolCambioPlan))
                            End If
                        Catch ex As Exception
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR CambioPlanPostpago: " & ex.Message.ToString())
                        End Try
                        'FIN CAMBIO DE PLAN 09022015
                    End If

                    'CAMBIO JNG
                    Dim cadNotachip As String = "RENOVACION + REPOSICION DE CHIP" & vbCrLf & strCadenaNota
                    Dim dsCliente As DataSet
                    Dim nroDocCliente As String
                    Dim objIdContacto As String
                    Dim nombreCliente As String
                    Dim apellidoCliente As String
                    Dim email As String
                    Dim contactoId As Int64
                    Dim res As String = ""
                    Dim msj As String = ""
                    Dim rep As Integer
					' Add MVC 12/08/2016
                    Dim oReposicion As New COM_SIC_Activaciones.clsReposicion
                    Dim strCurrentUser As String = CurrentUser
                    Dim strCurrentTerminal As String = CurrentTerminal
                    Dim strCodRpta As String
                    Dim strMsgRpta As String
                    Dim strTrama As String = ""
                    Dim strMSISDN As String
                    Dim strICCID As String
                    Dim strTipoDoc As String
                    Dim strNroDoc As String
                    Dim strTipoOfic As String
                    ' Fin MVC 12/08/2016
					
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "cadNotachip:" & cadNotachip)
					' Inicio MVC 12/08/2016
                    Dim strEstado As String = ""
                    Dim strFechaCP As String = ""
                    Dim strTipoOperacion As String = ConfigurationSettings.AppSettings("ConstTipoOperacion")
                    ' Fin MVC 12/08/2016
      
                    If Flag_chip = "1" Then ' = Fidelizado
                        'TIPI 1
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "serie:" & n_ChipSerie)
                        Dim str4G As String = n_ChipSerie.Trim().Substring(5, 2)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "str4G:" & str4G)

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INCIO RENO PACK:")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "objVentaRenovacion.VIGENCIA_PLAN :" & objVentaRenovacion.VIGENCIA_PLAN)
                        If objVentaRenovacion.VIGENCIA_PLAN <> "N" Then
                            ' Inicio MVC 12/08/2016
                            strEstado = CheckStr(ConfigurationSettings.AppSettings("EstadoCambioPlan"))
                            strFechaCP = fechaMig
                            ' Fin MVC 12/08/2016
                        Else
                            ' Inicio MVC 12/08/2016
                            strEstado = CheckStr(ConfigurationSettings.AppSettings("EstadoRepoChip"))
							' Fin MVC 12/08/2016
                        End If
						
                        ' Invocar WS para Cambio de SIM
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo GestionCambioSIM()")
                        ' Inicio MVC 12/08/2016
                        strTipoDoc = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("CLIEC_TIPODOCCLIENTE"))
                        strNroDoc = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("CLIEV_NRODOCCLIENTE"))
                        strTipoOfic = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOOFICINA"))
                        strMSISDN = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO"))
                        strICCID = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("SERIC_CODSERIE"))
                        'INICIO INICIATIVA-219 | RENO + REPO 
                        strTipoOperacionEncCBIO = Funciones.CheckStr(KeySettings.key_TipoOperacionReposicionCBIO)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Tipo de operacion CBIO : " & strTipoOperacionEncCBIO)

                        objFileLog.Log_WriteLog(pathFile, strArchivo, "----- Orden de la Trama -----")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "1.- strMSISDN    : " & strMSISDN)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "2.- strTipoDoc   : " & strTipoDoc)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "3.- strNroDoc    : " & strNroDoc)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "4.- strICCID     : " & strICCID)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "5.- strTipoOfic  : " & strTipoOfic)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Add")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "6.- Estado       : " & strEstado)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "7.- T. Operacion : " & strTipoOperacion)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "8.- FechaCP      : " & strFechaCP)

                        If (blnTransaccionCBIO = False) Then 'Si blnTransaccionCBIO es False entrara por el flujo actual(BSCS)

                        If strTrama = "" Then
                            strTrama = strMSISDN & "_" & strTipoDoc & "_" & strNroDoc & "_" & strICCID & "_" & strTipoOfic & "_" & strEstado & "_" & strTipoOperacion & "_" & strFechaCP & "&"
                        End If

                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Trama con datos de la linea : " & strTrama)

                        If strTrama.Length - strTrama.Replace("_", "").Length <= 8 Then
                            strTrama = strTrama & "_"
                        Else
                            strTrama = strTrama.Substring(0, strTrama.Length - 1)
                        End If

                        End If

                        Dim strNroPedidoSAP As String = nroDocSap
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Trama con datos de la linea : " & strTrama)

                        If blnTransaccionCBIO Then 'Si blnTransaccionCBIO es True entrara por el flujo BSCS9(CBIO)
                            objAuditoriaWS.IDTRANSACCION = Now.Year & Now.Month & Now.Day & Now.Hour & Now.Minute & Now.Second
                            objAuditoriaWS.msgId = Now.Year & Now.Month & Now.Day & Now.Hour & Now.Minute & Now.Second
                            objAuditoriaWS.userId = CurrentUser
                            objAuditoriaWS.timestamp = System.DateTime.Now.ToString("dd-MM-yyyy hh:mm:ss")

                            objReposicionRequest.encolarTransaccionRequest.idNegocio = nroContrato
                            objReposicionRequest.encolarTransaccionRequest.tipoOperacion = strTipoOperacionEncCBIO '"11"
                            objReposicionRequest.encolarTransaccionRequest.nombreAplicacion = CheckStr(ConfigurationSettings.AppSettings("constAplicacion"))
                            objReposicionRequest.encolarTransaccionRequest.listaOpcional = Nothing

                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [objReposicionRequest] - [{0} : {1}]", "strTipoOperacionEncCBIO", Funciones.CheckStr(strTipoOperacionEncCBIO)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [objReposicionRequest] - [{0} : {1}]", "IdNegocio", Funciones.CheckStr(objReposicionRequest.encolarTransaccionRequest.idNegocio)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [objReposicionRequest] - [{0} : {1}]", "IdNegocioAux", Funciones.CheckStr(strMSISDN)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [objReposicionRequest] - [{0} : {1}]", "nombreAplicacion", Funciones.CheckStr(ConfigurationSettings.AppSettings("constAplicacion"))))

                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [Parametros Header Request] [{0}] -  INI", "objAuditoriaWS"))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [objAuditoriaWS] - [{0} : {1}]", "IDTRANSACCION", Funciones.CheckStr(objAuditoriaWS.IDTRANSACCION)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [objAuditoriaWS] - [{0} : {1}]", "msgId", Funciones.CheckStr(objAuditoriaWS.msgId)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [objAuditoriaWS] - [{0} : {1}]", "userId", Funciones.CheckStr(objAuditoriaWS.userId)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [objAuditoriaWS] - [{0} : {1}]", "timestamp", Funciones.CheckStr(objAuditoriaWS.timestamp)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [Parametros Header Request] [{0}] -  FIN", "objAuditoriaWS"))

                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [URL : {0}]", Funciones.CheckStr(ConfigurationSettings.AppSettings("EncolarReposicionRest"))))

                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [Ejecutando: objEncolarCBIO.EncolarTransaccionCBIO()]"))
                            objReposicionResponse = objEncolarCBIO.EncolarTransaccionCBIO(objReposicionRequest, objAuditoriaWS)

                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [objEncolarResponse.encolarReposicionResponse.responseAudit.codigoRespuesta : {0}]", Funciones.CheckStr(objReposicionResponse.encolarReposicionResponse.responseAudit.codigoRespuesta)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[INICIATIVA-219] - [objEncolarResponse.encolarReposicionResponse.responseAudit.mensajeRespuesta : {0}]", Funciones.CheckStr(objReposicionResponse.encolarReposicionResponse.responseAudit.mensajeRespuesta)))

                            If Funciones.CheckStr(objReposicionResponse.encolarReposicionResponse.responseAudit.codigoRespuesta) = "0" Then
                                If (Not IsNothing(arrListaNum)) Then
                                    If (arrListaNum.Count > 0) Then
                                        For Each item As COM_SIC_Activaciones.ItemGenerico In arrListaNum
                                            objCBIO.ActualizarAfiliacionCorreoCBIO(strNroDocumento, flag_afilia_correo, strCorreo)
                                            blActualizarAfiliacionCorreoCBIO = True
                                            objCBIO.ActualizarLimiteCreditoCBIO(strTipoDocumento, strNroDocumento, Funciones.CheckStr(objVentaRenovacion.LIMITE_CREDITO))
                                            blActualizarLimiteCreditoCBIO = True
                                            Exit For
                                        Next
                                    End If
                                End If
                            End If
                        Else
                            If strTrama.Length > 0 Then 'BSCS
                                objFileLog.Log_WriteLog(pathFile, strArchivo, "Cantidad de Chip's a reponer AS IS : " & strTrama.Split("&").Length)
                        oReposicion.GestionarCambioSim(strTrama, strNroPedidoSAP, strCurrentUser, strCurrentTerminal, strCodRpta, strMsgRpta)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Codigo de Respuesta de EncolarReposicion : " & strCodRpta)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Mensaje de Respuesta de EncolarReposicion : " & strMsgRpta)
                            End If
                        End If
                        'FIN INICIATIVA-219 | RENO + REPO 
                        ' Fin MVC 12/08/2016
                        Dim datos As String()
                        datos = ServicioSIACPostpagoConsultas("", n_nrolinea).Split("|")
                        Dim p_customerId As String = Funciones.CheckStr(datos(0))
                        Dim p_contratoId As String = Funciones.CheckStr(datos(1))

                        'ActivacionChipRepuestoRenovacionPostpagoDAC(n_nrolinea, n_nrolinea, n_ChipSerie, p_contratoId, p_customerId)

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo CambioSIM()")
                   
                            idInteracccion1 = Tipificacionchip(numeroTelefono, str4G, documentoSAP, vendedor, cadNotachip)

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "idInteracccion1:" & idInteracccion1)
                            If idInteracccion1 <> "" Then
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Iteraccion de chip grabo con exito:" & idInteracccion1)

                                Dim oTipificacion2 As New COM_SIC_INActChip.clsTipificacion
                                dsCliente = oTipificacion2.ConsultaCliente(numeroTelefono, "", contactoId, CInt("1"), "", "")

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo ConsultaCliente()")

                                If Not IsNothing(dsCliente) Then
                                If dsCliente.Tables(0).Rows.Count > 0 Then

                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Ingreso cliente")
                                    objIdContacto = CheckStr(dsCliente.Tables(0).Rows(0).Item("OBJID_CONTACTO"))
                                    nroDocCliente = CheckStr(dsCliente.Tables(0).Rows(0).Item("NRO_DOC"))
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "nroDocCliente" & nroDocCliente)
                                    nombreCliente = CheckStr(dsCliente.Tables(0).Rows(0).Item("NOMBRES"))
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "nombreCliente" & nombreCliente)
                                    apellidoCliente = CheckStr(dsCliente.Tables(0).Rows(0).Item("APELLIDOS"))
                                    email = CheckStr(dsCliente.Tables(0).Rows(0).Item("EMAIL"))


                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "apellidoCliente" & apellidoCliente)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "email" & email)
                                End If
                                Dim oPlantilla2 As New COM_SIC_INActChip.PlantillaInteraccion
                                Dim flagInter1 As String
                                Dim mensajeInter1 As String


                                'For ii As Integer = 0 To dtDetalleInterac.Rows.Count - 1
                                'oPlantilla1 = New COM_SIC_INActChip.PlantillaInteraccion
                                oPlantilla2.X_INTER_15 = dsPedido.Tables(0).Rows(0).Item("OFICV_CODOFICINA")
                                oPlantilla2.X_INTER_30 = cadNotachip
                                oPlantilla2.X_FIRST_NAME = nombreCliente
                                oPlantilla2.X_LAST_NAME = apellidoCliente
                                oPlantilla2.X_DOCUMENT_NUMBER = CheckStr(objVentaRenovacion.DOC_CLIEN_NUMERO)
                                oPlantilla2.X_ADJUSTMENT_AMOUNT = 0
                                oPlantilla2.X_EMAIL = email
                                oPlantilla2.X_REASON = "Upgrade de SIM"
                                oPlantilla2.X_PLUS_INTER2INTERACT = Convert.ToDouble(idInteracccion1)
                                oPlantilla2.X_CHARGE_AMOUNT = 0
                                oPlantilla2.X_CLARO_NUMBER = n_nrolinea
                                oPlantilla2.X_ICCID = n_ChipSerie

                                If (str4G = "01") Then
                                    oPlantilla2.X_FLAG_OTHER = "S"
                                    oPlantilla2.X_CONTACT_SEX = "S"
                                Else
                                    oPlantilla2.X_FLAG_OTHER = "N"
                                    oPlantilla2.X_CONTACT_SEX = "N"
                                End If


                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo InsertarPlantilla()")

                                oTipificacion2.InsertarPlantillaInteraccion(oPlantilla2, idInteracccion1, flagInter1, mensajeInter1)

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "mensajeInter1" & mensajeInter1)
                            Else
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "No grabo idInteracccion de chip:" & idInteracccion1)
                                End If
                            End If

                        End If
						'gdelasca Inicio Proy-9067
                    
                    If Not IsNothing(DsCanjeEquipo) AndAlso DsCanjeEquipo.Tables(0).Rows.Count > 0 Then
                        Try
                            Dim vObjclsTrsPvu As New COM_SIC_Activaciones.clsTrsPvu
                            Dim vCodMaterialSaliente As String = ""
                            Dim vCodSerieSaliente As String = ""
                            Dim vCodRsptActualiza As Integer
                            Dim vMsjRsptaActualiza As String = ""
                            Dim vObservaciones As String = ConfigurationSettings.AppSettings("obsPagoRenoAnticipada").ToString()
                            Dim ValorObtenido As DataSet


                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INICIO Metodo ActualizarRenoAnticipada()")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp N_NRO_PEDIDO:" & nroDocSap)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp V_ESTADO:" & ConfigurationSettings.AppSettings("EstRenoAntiPagar").ToString())
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp COD_EQUIPO:" & vCodMaterialSaliente)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp COD_MATERIAL:" & vCodSerieSaliente)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp V_USU_ACTUALIZACION:" & CurrentUser)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp OBSERVACION:" & vObservaciones)

                            ValorObtenido = vObjclsTrsPvu.ActualizarRenoAnticipada(nroDocSap, ConfigurationSettings.AppSettings("EstRenoAntiPagar").ToString(), vCodMaterialSaliente, vCodSerieSaliente, CurrentUser, vObservaciones, vCodRsptActualiza, vMsjRsptaActualiza)

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out Valor Cod Rspta:" & vCodRsptActualiza)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out Valor Msj Respta:" & vMsjRsptaActualiza)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FIN Metodo ActualizarRenoAnticipada()")

                        Catch ex As Exception
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "error Metod. ActualizarRenoAnticipada()" & ex.Message.ToString())
                        End Try
                    End If
						
                        'gdelasca FIN Proy-9067 
                        If (tipoRenovacion = "ANTICIPADA") Then

							'Inicio INICIATIVA 315 - JFG
							If n_tipoprod = "IFI" Then
								objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "tipoRenovacion:" & tipoRenovacion)
								objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "n_tipoprod:" & n_tipoprod)
								strcadenaRenoReten = "RETENIDO:" & IIf(flagFidelizadoRetenido = "RETENIDO", "Sí", "No") & ",FECHA:" & objVentaRenovacion.FECHA_REGISTRO & ",MONTO A COBRAR:" & objVentaRenovacion.MONTO_APADECE & ",MONTO A RETENER:" & IIf(flagFidelizadoRetenido = "RETENIDO", objVentaRenovacion.MONTO_APADECE, "0.00") & ",MONTO TOTAL:" & IIf(flagFidelizadoRetenido = "RETENIDO", objVentaRenovacion.MONTO_APADECE, "0.00")
								objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "strcadenaRenoReten:" & strcadenaRenoReten)
							End If
							'Fin INICIATIVA 315 - JFG

                            ' Inicio E77568
							Dim cadNota As String = "RENOVACION ANTICIPADA" & vbCrLf & strCadenaNota & vbCrLf & strcadenaRenoReten 'INICIATIVA 315 - JFG
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "cadNota:" & cadNota)

                            If flagExoneracion = 1 And flagDescuento = 0 Then
                                If flagFidelizadoRetenido = "FIDELIZADO" Then ' = Fidelizado
                                    'TIPI 1
                                idInteracccion1 = Tipificacion1(strIdentifyLog, numeroTelefono, documentoSAP, vendedor, cadNota, tipoRenovacion) 'MOD: PROY 26210 - RMZ
                                End If

                            End If

                            If flagExoneracion = 1 And flagDescuento = 1 Then
                                If flagFidelizadoRetenido = "FIDELIZADO" Then ' = Fidelizado
                                    'TIPI 1 y 3
                                idInteracccion1 = Tipificacion1(strIdentifyLog, numeroTelefono, documentoSAP, vendedor, cadNota, tipoRenovacion) 'MOD: PROY 26210 - RMZ

                                Tipificacion3(strIdentifyLog, numeroTelefono, documentoSAP, vendedor, strcadena5) 'MOD: PROY 26210 - RMZ
                                End If
                            End If

                            If flagExoneracion = 1 And flagDescuento = 0 Then
                                If flagFidelizadoRetenido = "RETENIDO" Then ' =  Retenido
                                    'TIPI 1 y 2
                                    idInteracccion1 = Tipificacion1(strIdentifyLog, numeroTelefono, documentoSAP, vendedor, cadNota, tipoRenovacion) 'MOD: 26210 - RMZ
    
                                If AppstrTipo_Prod_Des = "MOVIL" Then 'INICIATIVA 315 - JFG
                                    Tipificacion2(strIdentifyLog, numeroTelefono, documentoSAP, vendedor, strcadena5) 'MOD: PROY 26210 - RMZ
                                End If
                                End If
                            End If
                            If flagExoneracion = 1 And flagDescuento = 1 Then
                                If flagFidelizadoRetenido = "RETENIDO" Then ' =  Retenido
                                    'TIPI 1, 2, 3
                                    idInteracccion1 = Tipificacion1(strIdentifyLog, numeroTelefono, documentoSAP, vendedor, cadNota, tipoRenovacion) 'MOD: PROY 26210 - RMZ
    
                                If AppstrTipo_Prod_Des = "MOVIL" Then 'INICIATIVA 315 - JFG
                                    Tipificacion2(strIdentifyLog, numeroTelefono, documentoSAP, vendedor, strcadena5) 'MOD: PROY 26210 - RMZ
                                End If
    
                                    Tipificacion3(strIdentifyLog, numeroTelefono, documentoSAP, vendedor, strcadena5) 'MOD: PROY 26210 - RMZ
                                End If
                            End If

                            If flagExoneracion = 0 And flagDescuento = 0 Then
                                If flagFidelizadoRetenido = "FIDELIZADO" Then ' 0 = Fidelizado
                                    'TIPI 1 y 4
                                idInteracccion1 = Tipificacion1(strIdentifyLog, numeroTelefono, documentoSAP, vendedor, cadNota, tipoRenovacion) 'MOD: PROY 26210 - RMZ

                                    'TIPI 4
                                Tipificacion4(strIdentifyLog, numeroTelefono, documentoSAP, vendedor, strcadena5) 'MOD: PROY 26210 - RMZ
                                End If
                            End If

                            If flagExoneracion = 0 And flagDescuento = 1 Then
                                If flagFidelizadoRetenido = "FIDELIZADO" Then ' 0 = Fidelizado
                                    'TIPI 1, 3, 4
                                    'TIPI 1
                                idInteracccion1 = Tipificacion1(strIdentifyLog, numeroTelefono, documentoSAP, vendedor, cadNota, tipoRenovacion) 'MOD: PROY 26210 - RMZ

                                    'TIPI 3
                                Tipificacion3(strIdentifyLog, numeroTelefono, documentoSAP, vendedor, strcadena5) 'MOD: PROY 26210 - RMZ

                                    'TIPI 4
                                Tipificacion4(strIdentifyLog, numeroTelefono, documentoSAP, vendedor, strcadena5) 'MOD: PROY 26210 - RMZ
                                End If
                            End If

                            If flagExoneracion = 0 And flagDescuento = 0 Then
                                If flagFidelizadoRetenido = "RETENIDO" Then ' =  Retenido
                                    'TIPI 1 y 2
                                    'TIPI 1
                                    idInteracccion1 = Tipificacion1(strIdentifyLog, numeroTelefono, documentoSAP, vendedor, cadNota, tipoRenovacion) 'MOD: PROY 26210 - RMZ

                                    'TIPI 2
                                If AppstrTipo_Prod_Des = "MOVIL" Then 'INICIATIVA 315 - JFG
                                    Tipificacion2(strIdentifyLog, numeroTelefono, documentoSAP, vendedor, strcadena5) 'MOD: PROY 26210 - RMZ
                                End If

                                    'TIPI 4
                                    Tipificacion4(strIdentifyLog, numeroTelefono, documentoSAP, vendedor, strcadena5) 'MOD: PROY 26210 - RMZ
                                End If
                            End If

                            If flagExoneracion = 0 And flagDescuento = 1 Then
                                If flagFidelizadoRetenido = "RETENIDO" Then ' =  Retenido
                                    'TIPI 1 y 2
                                    'TIPI 1
                                idInteracccion1 = Tipificacion1(strIdentifyLog, numeroTelefono, documentoSAP, vendedor, cadNota, tipoRenovacion) 'MOD: PROY 26210 - RMZ

                                    'TIPI 2
                                If AppstrTipo_Prod_Des = "MOVIL" Then 'INICIATIVA 315 - JFG
                                    Tipificacion2(strIdentifyLog, numeroTelefono, documentoSAP, vendedor, strcadena5) 'MOD: PROY 26210 - RMZ
                                End If

                                    'TIPI 3
                                Tipificacion3(strIdentifyLog, numeroTelefono, documentoSAP, vendedor, strcadena5) 'MOD: PROY 26210 - RMZ

                                    'TIPI 4
                                Tipificacion4(strIdentifyLog, numeroTelefono, documentoSAP, vendedor, strcadena5) 'MOD: PROY 26210 - RMZ
                                End If
                            End If
                            ' Fin E77568

                        ElseIf (tipoRenovacion = "NORMAL") Then

							'Inicio INICIATIVA 315 - JFG
							If n_tipoprod = "IFI" Then
								objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "tipoRenovacion:" & tipoRenovacion)
								objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "n_tipoprod:" & n_tipoprod)
								strcadenaRenoReten = "RETENIDO:" & IIf(flagFidelizadoRetenido = "RETENIDO", "Sí", "No") & ",FECHA:" & objVentaRenovacion.FECHA_REGISTRO & ",MONTO A COBRAR:" & objVentaRenovacion.MONTO_APADECE & ",MONTO A RETENER:" & IIf(flagFidelizadoRetenido = "RETENIDO", objVentaRenovacion.MONTO_APADECE, "0.00") & ",MONTO TOTAL:" & IIf(flagFidelizadoRetenido = "RETENIDO", objVentaRenovacion.MONTO_APADECE, "0.00")
								objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "strcadenaRenoReten:" & strcadenaRenoReten)
							End If
							'Fin INICIATIVA 315 - JFG

							Dim cadNota As String = "RENOVACION NORMAL" & vbCrLf & strCadenaNota & vbCrLf & strcadenaRenoReten
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "cadNota:" & cadNota)
                            ' Inicio E77568
                            If flagDescuento = 1 Then
                                If flagFidelizadoRetenido = "FIDELIZADO" Then ' = Fidelizado
                                    'TIPI 1 y 3
                                    'TIPI 1
                                idInteracccion1 = Tipificacion1(strIdentifyLog, numeroTelefono, documentoSAP, vendedor, cadNota, tipoRenovacion) 'MOD: PROY 26210 - RMZ

                                    'TIPI 3
                                Tipificacion3(strIdentifyLog, numeroTelefono, documentoSAP, vendedor, strcadena5) 'MOD: PROY 26210 - RMZ
                                End If
                            End If

                            If flagDescuento = 1 Then
                                If flagFidelizadoRetenido = "RETENIDO" Then ' =  Retenido
                                    'TIPI 1
                                idInteracccion1 = Tipificacion1(strIdentifyLog, numeroTelefono, documentoSAP, vendedor, cadNota, tipoRenovacion) 'MOD: PROY 26210 - RMZ

                                    'TIPI 2
                                If AppstrTipo_Prod_Des = "MOVIL" Then 'INICIATIVA 315 - JFG
                                    Tipificacion2(strIdentifyLog, numeroTelefono, documentoSAP, vendedor, strcadena5) 'MOD: PROY 26210 - RMZ
                                End If

                                    'TIPI 3
                                Tipificacion3(strIdentifyLog, numeroTelefono, documentoSAP, vendedor, strcadena5) 'MOD: PROY 26210 - RMZ
                                End If
                            End If

                            If flagDescuento = 0 Then
                                If flagFidelizadoRetenido = "FIDELIZADO" Then ' = Fidelizado
                                    'TIPI 1
                                idInteracccion1 = Tipificacion1(strIdentifyLog, numeroTelefono, documentoSAP, vendedor, cadNota, tipoRenovacion) 'MOD: PROY 26210 - RMZ
                                End If
                            End If

                            ' Fin E77568
                        End If
                Else 
                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - El objeto objVentaRenovacion no obtuvo datos en el metodo ConsultarVentaRenovPostCAC()", strIdentifyLog)) 'INC000001089654  
                    End If

                'INI: INICIATIVA-219
                If blActualizarLimiteCreditoCBIO = False And blActualizarAfiliacionCorreoCBIO = False Then
                    If (Not IsNothing(arrListaNum)) Then
                        If (arrListaNum.Count > 0) Then
                            For Each item As COM_SIC_Activaciones.ItemGenerico In arrListaNum
                                objCBIO.ActualizarAfiliacionCorreoCBIO(strNroDocumento, flag_afilia_correo, strCorreo)
                                objCBIO.ActualizarLimiteCreditoCBIO(strTipoDocumento, strNroDocumento, Funciones.CheckStr(objVentaRenovacion.LIMITE_CREDITO))
                                Exit For
                            Next
                        End If
                    End If
                End If
                'FIN: INICIATIVA-219
            End If

            ' PROY-140360-IDEA-46301
            'GENERACION DE TIPIFICACION DE UNA CUOTA
            Dim objContrato As DataSet
            Dim P_COD_RESP, P_MSG_RESP As String
            Dim clsConsultaPvuCuota As New COM_SIC_Activaciones.clsConsultaPvu
            Dim strNumPedido = drPagos.Item("PEDIN_NROPEDIDO")
            objContrato = clsConsultaPvuCuota.ObtenerDrsap(strNumPedido, P_COD_RESP, P_MSG_RESP)
            Dim strContrato As String = objContrato.Tables(0).Rows(0).Item("ID_CONTRATO")
            Dim strCodTipoOperacionPostpago As String = ConfigurationSettings.AppSettings("strTVPostpago")
            Dim clsConsultaPagos As New WebComunes
            dsAcuerdo = clsConsultaPvuCuota.ConsultaAcuerdoPCS(strContrato, DBNull.Value)
            Dim strNumeroSEc As String = dsAcuerdo.Tables(0).Rows(0).Item("contn_numero_sec")
            If (HidNroCuotas = 1 And AppstrTipo_Prod_Des = "MOVIL" And (AppstrTipo_Opera_Cod = ConfigurationSettings.AppSettings("strDTVRenovacion")) And clsConsultaPagos.ValidarModalidadVentaContratoCode(strNumeroSEc) And dsAcuerdo.Tables(0).Rows(0).Item("contc_tipo_venta") = strCodTipoOperacionPostpago) Then
                'VARIABLES
                Dim flagConsulta As String = ""
                Dim contactoId As Int64
                Dim mensajeError As String = ""
                Dim idInteraccion As String = ""
                Dim idInteraccionDetalle As String = ""
                Dim strDescTipoOperacion As String = AppstrTipo_opera_Des
                Dim strNotasInteraccion As String = ""
                Dim dtDetalleInterac As New DataTable
                Dim oInteraccionCuota As New COM_SIC_INActChip.Interaccion
                Dim oTipificacion As New COM_SIC_INActChip.clsTipificacion
                Dim objVentaRenovacion As COM_SIC_Cajas.VentaRenovaPost
                Dim oPlantillaCuota As New COM_SIC_INActChip.PlantillaInteraccion
                Dim dsCliente As DataSet
                Dim strValor As String
                Dim strValor1 As String
                Dim strCodGrupo As String = ConfigurationSettings.AppSettings("KEY_PARAM_PACK")

                Dim strnNroPedido As Int64 = Funciones.CheckStr(AppQpDocSap) 'Convert.ToInt64(Session("NumeroPedido"))
                Dim flagInter As String
                Dim mensajeInter As String
                Dim monto As Int64 = 0
                Dim tipoRenovacion As String
                Dim strNumTelefono As String
                Dim strCodEmpleado As String = AppstrUsuario
                Dim strConsPack As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("constPacks"))

                Try
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Obtener Parametros IDEA-46301")
                    Dim dsParametros As DataSet = (New COM_SIC_Activaciones.clsConsultaPvu).ListaParametrosGrupo(strCodGrupo)

                    If (dsPedido.Tables.Count > 0) Then
                        For j As Integer = 0 To dsParametros.Tables(0).Rows.Count - 1
                            If (dsParametros.Tables(0).Rows(j).Item("PARAV_DESCRIPCION") = "Key_Concepto1cuota_Sicar") Then
                                strValor = Funciones.CheckStr(dsParametros.Tables(0).Rows(j).Item("PARAV_VALOR"))
                                strValor1 = Funciones.CheckStr(dsParametros.Tables(0).Rows(j).Item("PARAV_VALOR1"))
                            End If
                        Next
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Parametros IDEA-46301:CONCEPTO" & strValor)
                    End If
                Catch ex As Exception
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR Obtener Parametros IDEA-46301:" & ex.Message.ToString() & " " & ex.StackTrace.ToString())

                End Try

                strNotasInteraccion = strNotasInteraccion & "OPERACIÓN: " & strDescTipoOperacion & " " & ConfigurationSettings.AppSettings("CONS_NOTA_TIPI_PACK")

                Try
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "INICIO - " & "Registrar Tipificacion En una cuota")
                    dsPedido = objConsultaMsSap.ConsultaPedido(strnNroPedido, "", "")
                    If dsPedido.Tables.Count > 0 Then

                        monto = dsPedido.Tables(0).Rows(0).Item("INPAN_TOTALMERCADERIA")
                        strNumTelefono = Trim(FormatoTelefono(Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO"))))
                        dsCliente = oTipificacion.ConsultaCliente(strNumTelefono, String.Empty, Funciones.CheckInt64(""), CInt("1"), "", "")

                        objVentaRenovacion = (New COM_SIC_Cajas.clsCajas).ConsultarVentaRenovPostCAC(strnNroPedido)

                        oInteraccionCuota.OBJID_CONTACTO = Funciones.CheckStr(dsCliente.Tables(0).Rows(0).Item("OBJID_CONTACTO"))
                        oInteraccionCuota.TELEFONO = strNumTelefono
                        oInteraccionCuota.TIPO = ConfigurationSettings.AppSettings("CONS_TIPO_TIPI_PACK")
                        oInteraccionCuota.CLASE = ConfigurationSettings.AppSettings("CONS_CLASE_TIPI_PACK")
                        oInteraccionCuota.SUBCLASE = ConfigurationSettings.AppSettings("CONS_SUBCLASE_TIPI_PACK")
                        oInteraccionCuota.TIPO_CODIGO = ConfigurationSettings.AppSettings("CONS_TIPOCOD_TIPI_PACK")
                        oInteraccionCuota.CLASE_CODIGO = ConfigurationSettings.AppSettings("CONS_CLASECOD_TIPI_PACK")
                        oInteraccionCuota.SUBCLASE_CODIGO = ConfigurationSettings.AppSettings("CONS_SUBCLASECOD_TIPI_PACK")
                        oInteraccionCuota.METODO = ConfigurationSettings.AppSettings("CONS_METODO_TIPI_PACK")
                        oInteraccionCuota.AGENTE = strCodEmpleado
                        oInteraccionCuota.USUARIO_PROCESO = ConfigurationSettings.AppSettings("USR_PROCESO")
                        oInteraccionCuota.HECHO_EN_UNO = 0
                        oInteraccionCuota.NOTAS = strNotasInteraccion
                        oInteraccionCuota.FLAG_CASO = "0"
                        oInteraccionCuota.RESULTADO = "NINGUNO"

                        oTipificacion.CrearInteraccion(oInteraccionCuota, idInteraccion, flagConsulta, mensajeError)
                    End If

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "Valores Insertados en la tipificacion: ")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "------- CABECERA TIPIFICACION ---------------------------------")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " OBJID_CONTACTO : " & oInteraccionCuota.OBJID_CONTACTO)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " TELEFONO: " & oInteraccionCuota.TELEFONO)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " TIPO: " & oInteraccionCuota.TIPO)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " CLASE: " & oInteraccionCuota.CLASE)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " SUBCLASE: " & oInteraccionCuota.SUBCLASE)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " TIPO_CODIGO: " & oInteraccionCuota.TIPO_CODIGO)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " CLASE_CODIGO: " & oInteraccionCuota.CLASE_CODIGO)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " SUBCLASE_CODIGO: " & oInteraccionCuota.SUBCLASE_CODIGO)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " METODO: " & oInteraccionCuota.METODO)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " AGENTE: " & oInteraccionCuota.AGENTE)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " USUARIO_PROCESO: " & oInteraccionCuota.USUARIO_PROCESO)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " HECHO_EN_UNO: " & oInteraccionCuota.HECHO_EN_UNO)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " NOTAS: " & oInteraccionCuota.NOTAS)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " FLAG_CASO: " & oInteraccionCuota.FLAG_CASO)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " RESULTADO: " & oInteraccionCuota.RESULTADO)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " RESULTADO GENERAR CABECERA TIPIFICACION ----------")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " ID_INTERACCION: " & idInteraccion)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " FLAG_CONSULTA: " & flagConsulta)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " MENSAJE: " & mensajeError)

                    If (dsPedido.Tables(1).Rows.Count = 1) Then
                        oPlantillaCuota.X_INTER_1 = DateTime.Now.ToString("dd/MM/yyyy")
                        oPlantillaCuota.X_INTER_8 = objContrato.Tables(1).Rows(1).Item("ID_CONTRATO")
                        oPlantillaCuota.X_INTER_15 = dsPedido.Tables(0).Rows(0).Item("OFICV_CODOFICINA")
                        oPlantillaCuota.X_INTER_3 = dsPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA")
                        oPlantillaCuota.X_FIRST_NAME = CheckStr(dsCliente.Tables(0).Rows(0).Item("NOMBRES"))
                        oPlantillaCuota.X_LAST_NAME = CheckStr(dsCliente.Tables(0).Rows(0).Item("APELLIDOS"))
                        oPlantillaCuota.X_EMAIL = CheckStr(dsCliente.Tables(0).Rows(0).Item("EMAIL"))
                        oPlantillaCuota.X_DOCUMENT_NUMBER = CheckStr(dsCliente.Tables(0).Rows(0).Item("NRO_DOC"))
                        oPlantillaCuota.X_PLUS_INTER2INTERACT = Convert.ToDouble(idInteraccion)
                        oPlantillaCuota.X_REASON = ConfigurationSettings.AppSettings("CONS_CONCEPTO_TIPI_PACK")
                        oPlantillaCuota.X_ADJUSTMENT_REASON = strValor
                        oPlantillaCuota.X_ADJUSTMENT_AMOUNT = monto
                        oPlantillaCuota.X_CLARO_NUMBER = strNumTelefono
                        oPlantillaCuota.X_OPERATION_TYPE = CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIV_DESCTIPOOPERACION"))
                        oPlantillaCuota.X_IMEI = CheckStr(dsPedido.Tables(1).Rows(0).Item("SERIC_CODSERIE"))
                        oPlantillaCuota.X_MODEL = CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEV_DESCMATERIAL"))
                        '----------------------- FIN DETALLE TIPIFICACION ------
                    ElseIf (dsPedido.Tables(1).Rows.Count = 2) Then
                        oPlantillaCuota.X_INTER_1 = DateTime.Now.ToString("dd/MM/yyyy")
                        oPlantillaCuota.X_INTER_8 = objContrato.Tables(1).Rows(1).Item("ID_CONTRATO")
                        oPlantillaCuota.X_INTER_15 = dsPedido.Tables(0).Rows(0).Item("OFICV_CODOFICINA")
                        oPlantillaCuota.X_INTER_3 = dsPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA")
                        oPlantillaCuota.X_FIRST_NAME = CheckStr(dsCliente.Tables(0).Rows(0).Item("NOMBRES"))
                        oPlantillaCuota.X_LAST_NAME = CheckStr(dsCliente.Tables(0).Rows(0).Item("APELLIDOS"))
                        oPlantillaCuota.X_EMAIL = CheckStr(dsCliente.Tables(0).Rows(0).Item("EMAIL"))
                        oPlantillaCuota.X_DOCUMENT_NUMBER = CheckStr(dsCliente.Tables(0).Rows(0).Item("NRO_DOC"))
                        If (dsPedido.Tables(1).Rows(0).Item("MATEC_TIPOMATERIAL") = strConsPack) Then
                            oPlantillaCuota.X_ICCID = dsPedido.Tables(1).Rows(1).Item("SERIC_CODSERIE")
                            oPlantillaCuota.X_IMEI = dsPedido.Tables(1).Rows(0).Item("SERIC_CODSERIE")
                        Else
                            oPlantillaCuota.X_ICCID = dsPedido.Tables(1).Rows(0).Item("SERIC_CODSERIE")
                            oPlantillaCuota.X_IMEI = dsPedido.Tables(1).Rows(1).Item("SERIC_CODSERIE")
                        End If

                        oPlantillaCuota.X_REASON = ConfigurationSettings.AppSettings("CONS_CONCEPTO_TIPI_PACK")
                        oPlantillaCuota.X_ADJUSTMENT_REASON = strValor
                        oPlantillaCuota.X_ADJUSTMENT_AMOUNT = monto
                        oPlantillaCuota.X_CLARO_NUMBER = strNumTelefono
                        oPlantillaCuota.X_OPERATION_TYPE = CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIV_DESCTIPOOPERACION"))
                        oPlantillaCuota.X_IMEI = CheckStr(dsPedido.Tables(1).Rows(0).Item("SERIC_CODSERIE"))
                        oPlantillaCuota.X_MODEL = CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEV_DESCMATERIAL"))
                    End If

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "------- DETALLE TIPIFICACION ---------------------------------")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " X_INTER_1: " & oPlantillaCuota.X_INTER_1)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " X_INTER_15: " & oPlantillaCuota.X_INTER_15)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " X_INTER_3: " & oPlantillaCuota.X_INTER_3)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " X_DOCUMENT_NUMBER: " & oPlantillaCuota.X_DOCUMENT_NUMBER)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " X_REASON: " & oPlantillaCuota.X_REASON)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " X_ICCID: " & oPlantillaCuota.X_ICCID)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " X_IMEI: " & oPlantillaCuota.X_IMEI)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " X_PLUS_INTER2INTERACT: " & oPlantillaCuota.X_PLUS_INTER2INTERACT)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " X_REASON: " & oPlantillaCuota.X_REASON)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " X_ADJUSTMENT_REASON: " & oPlantillaCuota.X_ADJUSTMENT_REASON)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " X_ADJUSTMENT_AMOUNT: " & oPlantillaCuota.X_ADJUSTMENT_AMOUNT)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " X_CLARO_NUMBER: " & oPlantillaCuota.X_CLARO_NUMBER)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " RESULTADO- GRABAR DETALLE TIPIFICACION ---------------")
                    oTipificacion.InsertarPlantillaInteraccion(oPlantillaCuota, idInteraccion, flagInter, mensajeInter)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " FLAG ID_INTERACCION : " & idInteraccion)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " FLAG INTERACCION : " & flagInter)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " MENSAJE: " & mensajeInter)
                Catch ex As Exception
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " ERROR AL GENERAR TIPIFICACION:" & ex.Message.ToString() & " " & ex.StackTrace.ToString())
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " MENSAJE ERROR CABECERA TPIFICACION: " & mensajeError)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " MENSAJE ERROR DETALLE TPIFICACION: " & mensajeInter)
                End Try
            End If
            'PROY-140360-IDEA-46301
        Catch ex As Exception
            'INI PROY-140126
            Dim MaptPath As String
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: ProcesoRenovacionCAC)"
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR ProcesoRenovacionCAC:" & ex.Message.ToString() & " " & ex.StackTrace.ToString() & MaptPath)
            'FIN PROY-140126
        End Try
    End Sub

    'INICIO FMES : ACTIVACION PEL

    Private Function pagarCAC(ByVal sDocumentoSap As String, ByVal CodAlmacen As String, ByVal strDocRefe As String, ByRef strFechaVenta As String, ByRef strTipoOperacion As String, ByRef strDescripcionError As String, ByRef TelefonoNumero As String, ByRef RegistroDOLRespuesta As String) As Boolean

        Dim updVentaPrepago As Boolean
        Dim bolRespuestaPEL As Boolean

        'PROY-31850 - INICIO
        Dim sEstado As String
        Dim strMensaje As String
        Dim activacion As String
        Dim strIdentifyLog As String = Funciones.CheckStr(AppUsuario) & " - " & sDocumentoSap
        Try

            If blnIsOLO = True And Funciones.CheckStr(strLineaOLO) <> "" Then
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "---------------------------------------")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INICIO PROCESAR VENTA OLO")
                'Falta logs
                Dim strCodMensaje As String
                Dim strDesMnj As String
                Dim strDescMensaje As String = ""
                Dim intNumIntentos As String = Funciones.CheckInt(strVentaWS_NumIntentos)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " intNumIntentos: " & Funciones.CheckStr(intNumIntentos))

                Dim objMensaje As New COM_SIC_Activaciones.BWProcesaVentaActivacionOlo
                Dim objCorreo As New COM_SIC_Activaciones.BWEnvioCorreo

                Dim strIdTransaccion As String = DateTime.Now.ToString("yyyyMMddHHmmss") + "_" + sDocumentoSap
                Dim strCodAplicacion As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("CodAplicacion"))
                Dim strUserAplicacion As String = Funciones.CheckStr(AppUsuario)


                If (intNumIntentos = 0) Then
                    intNumIntentos = 1
                End If

                Dim k As Integer = 0

                Do While (k < intNumIntentos)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " INICIO ProcesarActivacionOLO")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     IN sDocumentoSap: " & sDocumentoSap)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     IN strIdPedidoVentaPVU: " & strIdPedidoVentaPVU)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     IN strTipoDocumento: " & strTipoDocumento)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     IN strNumDocumento: " & strNumDocumento)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     IN strIdTransaccion: " & strIdTransaccion)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     IN strCodAplicacion: " & strCodAplicacion)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     IN strUserAplicacion: " & strUserAplicacion)
                    objMensaje.ProcesarActivacionOLO(sDocumentoSap, strIdPedidoVentaPVU, strTipoDocumento, strNumDocumento, _
                                                    strIdTransaccion, strCodAplicacion, strUserAplicacion, strUserAplicacion, "", "", "", strCodMensaje, strDescMensaje) 'FASE IV 31850 
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     OUT strCodMensaje: " & strCodMensaje)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     OUT strDescMensaje: " & strDescMensaje)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " FIN ProcesarActivacionOLO")

                    If strCodMensaje = "0" Then
                        Exit Do
                    End If
                    k = (k + 1)
                Loop
                If strCodMensaje <> "0" Then
        Try
                        Dim strRemitente As String = clsKeyOLO.strVentaCorreoSicar_Remitente
                        Dim strDestinatario As String = clsKeyOLO.strVentaCorreoSicar_ParaDefault
                        Dim strMnsaje As String = clsKeyOLO.strVentaCorreoSicar_Cuerpo
                        Dim strAsunto As String = clsKeyOLO.strVentaCorreoSicar_Asunto
                        Dim strFlag As String = clsKeyOLO.strFlagCorreo
                        Dim strMensajeCorreo As String
                        Dim strCodigoCorreo As String
                        Dim strMsjTrama As String = String.Format("[WS|{0}][TIPO_DOC|{1}][NUM_DOC|{2}][PEDIDO|{3}]", ConfigurationSettings.AppSettings("UrlProcesaVentaOLO"), strTipoDocumento, strNumDocumento, sDocumentoSap, strIdPedidoVentaPVU)

                        strAsunto = String.Format(strAsunto, sDocumentoSap)
                        strMnsaje = String.Format(strMnsaje, sDocumentoSap, strDescMensaje, strMsjTrama)
                        strMnsaje = strMnsaje.Replace("(p)", "<p>")
                        strMnsaje = strMnsaje.Replace("(_p)", "</p>")
                        strMnsaje = strMnsaje.Replace("(b)", "<b>")
                        strMnsaje = strMnsaje.Replace("(_b)", "</b>")

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      EnviarCorreoOLO - INICIO ==")
                        objCorreo.EnviarCorreoPM(strRemitente, strDestinatario, strAsunto, strMnsaje, strFlag, CurrentTerminal, CurrentUser, strCodigoCorreo, strMensajeCorreo)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==   Mensaje correo:" & strMnsaje)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      EnviarCorreoOLO - FIN ==")

                    Catch x As Exception
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      ERROR - EnviarCorreoOLO: " & x.Message.ToString())
                    End Try
                End If
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FIN PROCESAR VENTA OLO")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "---------------------------------------")

            Else
                'PROY-31850 - FIN
            objFileLog.Log_WriteLog(pathFile, strArchivo, "Inicio Proceso de Activación PEL")
            objFileLog.Log_WriteLog(pathFile, strArchivo, "sDocumentoSap: " & sDocumentoSap)
            activacion = ActivarPEL(sDocumentoSap, bolRespuestaPEL, TelefonoNumero, RegistroDOLRespuesta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, "bolRespuestaPEL: " & bolRespuestaPEL.ToString)
            objFileLog.Log_WriteLog(pathFile, strArchivo, "RegistroDOLRespuesta: " & RegistroDOLRespuesta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, "activacion: " & activacion)

            If bolRespuestaPEL = False Then
                activacion = "Se procedió con el pago" & "\n" & activacion
                'Response.Redirect("../Pagos/sisact_express_pool_documentos_pagar.aspx?estado=" & "2" & "&fecha=" & strFechaVenta & "&mensaje=" & activacion & "&tipo_operacion=" & strTipoOperacion)
                strDescripcionError = activacion
                Return False
            Else
                sEstado = "7"
                strMensaje = "Se procedió con el pago. \n " & activacion
                strDescripcionError = strMensaje
                Return True
            End If

            'If activacion.Length > 0 Then
            '    Dim constDocPagado As String = ConfigurationSettings.AppSettings("constDocPagado")
            '    Dim objDAC As New COM_SIC_Cajas.clsCajas
            '    Dim resultado As Integer = 0
            '    objFileLog.Log_WriteLog(pathFile, strArchivo, "Proceso de cambio de estado Pagado")
            '    objFileLog.Log_WriteLog(pathFile, strArchivo, "Documento: " & sDocumentoSap)
            '    objFileLog.Log_WriteLog(pathFile, strArchivo, "Estado Doc pagado: " & constDocPagado)
            '    objFileLog.Log_WriteLog(pathFile, strArchivo, "Almacen : " & CodAlmacen)
            '    updVentaPrepago = objDAC.ActualizarPagoCorner(sDocumentoSap, constDocPagado, CodAlmacen, resultado)
            '    objFileLog.Log_WriteLog(pathFile, strArchivo, "Resultado : " & resultado.ToString)

            '    Dim codTrans As String, descTrans As String
            '    'codTrans = ConfigurationSettings.AppSettings("codTrsCierraVenta")
            '    descTrans = "Grabar Cierre de venta en CAC Documento: " & sDocumentoSap & " Doc. Referencia: " & strDocRefe & "Local: " & CodAlmacen
            '    AuditoriaPagarPedido(descTrans)

            End If
        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, "		ERROR: " & ex.Message.ToString())
            objFileLog.Log_WriteLog(pathFile, strArchivo, "		ERROR: " & ex.StackTrace.ToString())
        End Try



    End Function

    Private Function ActivarPEL(ByVal sDocumentoSap As String, ByRef bolRespuesta As Boolean, ByRef strTelefonoNumero As String, ByRef strRegistroDOLRespuesta As String) As String ' Boolean

        Dim proceso As Boolean = False
        Dim oBusExpress As New ClsActivacionPel

        Dim strOficina As String = ""
        Dim strCodigoResp As String = ""
        Dim strOpcion As String = ""
        Dim strChipPack As String = ""
        Dim strCar1 As String = ""
        Dim strCar5 As String = ""
        Dim strCar6 As String = ""
        Dim strTrace As String = ""
        Dim strFechaHora As String
        Dim strServicioAdicional5 As String = ""
        Dim strOperacionClaro As String
        Dim strEstadoActivacion As String
        Dim strCodigoRespuesta As String
        Dim strDescripcionRespuesta As String
        Dim strTipoProducto As String
        Dim i As Int16 = 1
        Dim strTipoPreActivacion As String
        Dim strTipoActivacion As String
        Dim strComando As String = ""
        Dim strPuntoVenta As String


        Dim strRsptaValidacion As String
        Dim objBus As New COM_SIC_Cajas.clsCajas
        Dim dtDatos As New DataTable
        Dim dsPedido As DataSet
        Dim PuntoVentaSinergia As String = ""
        strTelefonoNumero = String.Empty
        Dim strTelefonoSeparador As String = "|"
        Dim strTelefonoNumeroTemporal As String = String.Empty
        strRegistroDOLRespuesta = String.Empty
        Dim strRegistroDOLSeparador As String = "|"
        Dim strRegistroDOLRespuestaTemporal As String = String.Empty


        objFileLog.Log_WriteLog(pathFile, strArchivo, "**********************")
        objFileLog.Log_WriteLog(pathFile, strArchivo, "PROCESO ACTIVACION PEL")
        objFileLog.Log_WriteLog(pathFile, strArchivo, "**********************")
        strOficina = CStr(AppAlmacen)
        strPuntoVenta = String.Empty 'CStr(Session("PtodeVenta"))
        sDocumentoSap = hidDocSap

        Dim numerosTelefono As String = ""
        bolRespuesta = False

        objFileLog.Log_WriteLog(pathFile, strArchivo, "Inicio objBus.ListarDatosCabeceraVenta [sDocumentoSap]-> " + sDocumentoSap)
        dtDatos = objBus.ListarDatosCabeceraVenta(sDocumentoSap)
        objFileLog.Log_WriteLog(pathFile, strArchivo, "Fin objBus.ListarDatosCabeceraVenta [sDocumentoSap]-> " + "|[dtDatos]" + IIf(IsDBNull(dtDatos), "0", dtDatos.Rows.Count.ToString))
        Dim strNombres As String = dtDatos.Rows(0).Item("VEPR_NOM_CLIE").ToString()
        Dim strApellidos As String = dtDatos.Rows(0).Item("VEPR_APE_CLIE").ToString()
        Dim codTipoDocumento As String = dtDatos.Rows(0).Item("VEPR_TIPO_DOC").ToString()
        Dim desDocCliente As String
        Dim dsCliente As DataSet
        Dim oConsultaSAP As New SAP_SIC_Pagos.clsPagos
        Dim listaDocumento() As String

        PuntoVentaSinergia = Funciones.CheckStr(objConsultaMsSap.ConsultaPuntoVenta(AppAlmacen).Tables(0).Rows(0).Item("OVENV_CODIGO_SINERGIA"))

        listaDocumento = Split(ConfigurationSettings.AppSettings("strListaDocumentos"), "|")
        For ii As Integer = 0 To UBound(listaDocumento)
            Dim arrayDocumento() As String = Split(listaDocumento(ii), ";")
            If arrayDocumento(0) = Right("00" & codTipoDocumento, 2) Then
                desDocCliente = arrayDocumento(1)
                Exit For
            End If
        Next

        Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, "Inicio oBusExpress.Lis_Lista_Detalle_Venta_Prepago [sDocumentoSap]-> " + sDocumentoSap)
            Dim lista As ArrayList = oBusExpress.Lis_Lista_Detalle_Venta_Prepago(sDocumentoSap, strCodigoResp)
            objFileLog.Log_WriteLog(pathFile, strArchivo, "Out Lis_Lista_Detalle_Venta_Prepago.Count - " & lista.Count)
            objFileLog.Log_WriteLog(pathFile, strArchivo, "Fin oBusExpress.Lis_Lista_Detalle_Venta_Prepago - Codigo de Respuesta : " & strCodigoResp)

            For Each item As DetalleVentaPrepago In lista
                i = i + 1
                objFileLog.Log_WriteLog(pathFile, strArchivo, "Codigo Activacion: " + item.COD_ACTIVACION)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "Codigo Activacion WCONF: " + ConfigurationSettings.AppSettings("constCodActPrepagoJuerga"))
                dsCliente = objConsultaMsSap.Get_ConsultaCliente(item.NUM_DOC, item.TIPO_DOC)

                If item.COD_ACTIVACION = ConfigurationSettings.AppSettings("constCodActPrepagoJuerga") Then
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "ENTRO PREPAGO JUERGA PEL")
                    If item.FLAG_PACK = "S" Then
                        strOpcion = ConfigurationSettings.AppSettings("constChipPackPrepago")
                        strChipPack = "P"
                        strCar6 = item.COD_MATERIAL_CHIP & "," & item.COD_MATERIAL_EQUI
                        item.SERIE_EQUI = "000000000000000" & item.SERIE_EQUI
                        strServicioAdicional5 = Right(item.SERIE_EQUI, 15)
                    Else
                        strOpcion = ConfigurationSettings.AppSettings("constChipSuelto")
                        strChipPack = "C"
                        strCar6 = item.COD_MATERIAL_CHIP
                        strServicioAdicional5 = ""
                    End If
                    strTrace = Right(("00000" & Trim(item.ID)), 6)
                    strFechaHora = Trim(Str(Year(Date.Today))) & Right("00" & Trim(Str(Month(Date.Today))), 2) & Right("00" & Trim(Str(Day(Date.Today))), 2) & "1230"
                    'strCar5 = Trim(item.COD_VEN_PEL) & "," & item.COD_PDV
                    strCar5 = Trim(item.COD_VEN_PEL) & "," & PuntoVentaSinergia 'strPuntoVenta
                    strOperacionClaro = strTrace + strFechaHora
                    strCar1 = Trim(item.CAR1)

                    Dim oServicioPelBusinessLogic As New ClsActivacionPel
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Parametros PREPAGO JUERGA")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Serie Chip - ICCID: " & item.SERIE_CHIP)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Cod PDV PEL: " & item.COD_PDV_PEL)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Cod Depa: " & item.COD_DEPA)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Opcion - ServicioAdicional1: " & strOpcion)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Cod. Vendedor PEL - ServicioAdicional2: " & item.COD_VEN_PEL)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Chip-pack: " & strChipPack)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Serv. Adicional5: " & strServicioAdicional5)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Cod Prod: " & item.COD_PROD)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Cod Plan: " & item.COD_PLAN)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Cod Promocion: " & item.COD_PROMOCION)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Tip Prod: " & item.TIPO_PROD)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Car 1: " & strCar1)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Car 5: " & strCar5)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Car 6: " & strCar6)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Trace: " & strTrace)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Operacion Claro: " & strOperacionClaro)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Car 1: " & strCar1)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Estado Activacion: " & strEstadoActivacion)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Nro. Documento Sap: " & sDocumentoSap)
                    Dim strLinea As String = oServicioPelBusinessLogic.AltaPrepago(item.SERIE_CHIP, item.COD_PDV_PEL, item.COD_DEPA, strOpcion, Trim(item.COD_VEN_PEL), strChipPack, strServicioAdicional5, item.COD_PROD, item.COD_PLAN, item.COD_PROMOCION, item.TIPO_PROD, strCar5, strCar6, strTrace, strOperacionClaro, strCar1, strEstadoActivacion, sDocumentoSap, strCodigoRespuesta, strDescripcionRespuesta)
                    strLinea = strLinea.Trim
                    strEstadoActivacion = strEstadoActivacion.Trim

                    strRsptaValidacion = strCodigoRespuesta ' aqui la validacion
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Operacion Claro: " & strOperacionClaro)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Estado Activ.: " & strEstadoActivacion)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Cod respuesta: " & strCodigoRespuesta)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Des respuesta: " & strDescripcionRespuesta)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Linea: " & strLinea)

                    ' SI ENTRA AL CATCH EN EL WS GRABA EN UNA TABLA DE LOS ERRROS DE PEL
					If strLinea.Length > 0 Then
						objFileLog.Log_WriteLog(pathFile, strArchivo, "Respuesta PEL OK: " & strEstadoActivacion)
					Else
                        Dim strTelefonoReferencia = Funciones.CheckStr(dsCliente.Tables(0).Rows(0)("CLIEV_TELEFONOCLIENTE"))
                        Dim strRespuestaeai As String
                        Dim strEstado_Proceso_Pel As String = ConfigurationSettings.AppSettings("Estado_Proceso_Pel")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Inicio oBusExpress.GrabarErrorActivacionPel " & "Estado de Proceso PEL " & strEstado_Proceso_Pel)
                        oBusExpress.GrabarErrorActivacionPel(item.SERIE_CHIP, item.COD_PDV_PEL, item.COD_DEPA, strOpcion, Trim(item.COD_VEN_PEL), strChipPack, strServicioAdicional5, item.COD_PROD, item.COD_PLAN, item.COD_PROMOCION, item.TIPO_PROD, strCar5, strCar6, Trim(item.ID), strOperacionClaro, strEstadoActivacion, strCodigoRespuesta, strDescripcionRespuesta, strCar1, strLinea, strNombres, strApellidos, desDocCliente, item.NUM_DOC, strTelefonoReferencia, strEstado_Proceso_Pel, sDocumentoSap, strRespuestaeai)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Respuesta: " & strRespuestaeai.ToString)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Fin oBusExpress.GrabarErrorActivacionPel " & "Estado de Proceso PEL " & strEstado_Proceso_Pel)
                    End If

                    'actulizar numeros en tablas PVU
                    Try
                        If strLinea.Length > 0 Then
                            numerosTelefono = numerosTelefono & "Chip: " & item.SERIE_CHIP & " Nro. asignado: " & strLinea & "\n"
                            Dim lineapvu As String = strLinea.Trim
                            Dim obj As New ClsActivacionPel
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas PVU")
                            Dim respuesta As Integer = obj.actualizaTelefono(item.SERIE_CHIP, item.COD_MATERIAL_CHIP, lineapvu)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "Respuesta: " & respuesta.ToString)
                            bolRespuesta = True

                            'PROY-24388 INICIO
                            Try

                                Dim strUpdate As String = String.Empty
                                Dim boolblnUpdate As Boolean
                                Dim iDetalle As New COM_SIC_Activaciones.clsDetallePedidoMsSap

                                iDetalle.K_PEDIN_NROPEDIDO = sDocumentoSap
                                iDetalle.K_SERIC_CODSERIE = item.SERIE_CHIP.PadLeft(18, "0")
                                iDetalle.K_DEPEV_NROTELEFONO = Funciones.CheckStr(lineapvu)

                                objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas MSINCDB")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas MSINCDB[K_PEDIN_NROPEDIDO]->" & Funciones.CheckStr(iDetalle.K_PEDIN_NROPEDIDO))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas MSINCDB[K_SERIC_CODSERIE]->" & Funciones.CheckStr(iDetalle.K_SERIC_CODSERIE))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas MSINCDB[K_DEPEV_NROTELEFONO]->" & Funciones.CheckStr(iDetalle.K_DEPEV_NROTELEFONO))

                                boolblnUpdate = oBusExpress.ActualizarTelefonoMSINCDB(iDetalle, strUpdate)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas MSINCDB[rpsta]->" & Funciones.CheckStr(strUpdate))

                                If Funciones.CheckStr(item.SERIE_EQUI).Length > 0 And Funciones.CheckStr(item.SERIE_CHIP) <> Funciones.CheckStr(item.SERIE_EQUI) Then

                                    iDetalle.K_SERIC_CODSERIE = item.SERIE_EQUI.PadLeft(18, "0")
                                    iDetalle.K_SERIC_CODSERIE = iDetalle.K_SERIC_CODSERIE.Substring(iDetalle.K_SERIC_CODSERIE.Length - 18)

                                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas MSINCDB Equipo")
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas MSINCDB[K_PEDIN_NROPEDIDO]->" & Funciones.CheckStr(iDetalle.K_PEDIN_NROPEDIDO))
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas MSINCDB[K_SERIC_CODSERIE]->" & Funciones.CheckStr(iDetalle.K_SERIC_CODSERIE))
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas MSINCDB[K_DEPEV_NROTELEFONO]->" & Funciones.CheckStr(iDetalle.K_DEPEV_NROTELEFONO))

                                    boolblnUpdate = oBusExpress.ActualizarTelefonoMSINCDB(iDetalle, strUpdate)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas MSINCDB[rpsta]->" & Funciones.CheckStr(strUpdate))

                                End If

                            Catch ex As Exception
                                objFileLog.Log_WriteLog(pathFile, strArchivo, "		ERROR: " & ex.Message.ToString())
                                objFileLog.Log_WriteLog(pathFile, strArchivo, "		ERROR: " & ex.StackTrace.ToString())
                            End Try
                            'PROY-24388 FIN
                        Else
                            Dim obj As New ClsActivacionPel
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza Error PEL en tablas PVU")
                            Dim respuesta As Integer = obj.actualizaErrorActivacionPEL(item.SERIE_CHIP, item.COD_MATERIAL_CHIP, strCodigoRespuesta, strDescripcionRespuesta)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "Respuesta" & respuesta)
                        End If

                    Catch ex As Exception
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "		ERROR: " & ex.Message.ToString())
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "		ERROR: " & ex.StackTrace.ToString())
                    End Try

                    If strLinea.Length > 0 Then
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "***********")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "PROCESO DOL")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "***********")
                        '<PROCESO PEL - INICIO>'
                        Dim nroTelefonoPEL As String = strLinea.Trim
                        '<PROCESO PEL - FIN>'

                        '<INICIO DOL - INICIO>'
                        Dim idDOL As String = ""
                        Dim msgDOL As String = ""
                        Dim procesoDOL As Boolean = False
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Parametros")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Documento: " & sDocumentoSap)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Nro Linea: " & nroTelefonoPEL)

                        'ava val dol

                        Dim listaOficinasVirtuales$ = ConfigurationSettings.AppSettings("TIENDA_VIRTUAL")
                        Dim isTiendaVirtual As Boolean = False

                        If (IsNothing(listaOficinasVirtuales)) Then Throw New Exception("Lista oficinas virtuales no configuradas - Activacion Pel")
                        For Each sTiendaVirtual As String In listaOficinasVirtuales.Split("|"c)
                            If AppAlmacen = sTiendaVirtual Then
                                isTiendaVirtual = True
                                Exit For
                            End If

                        Next
                        If (Not isTiendaVirtual) Then
                        procesoDOL = RegistroDOL(sDocumentoSap, nroTelefonoPEL, idDOL, msgDOL)
                        End If
                        'ava fin val dol


                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Respuesta")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "idDOL" & idDOL)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Msj DOL: " & msgDOL)
                        '<INICIO DOL - FIN>'

                        If Not procesoDOL Then
                            Dim strTelefonoReferencia = Funciones.CheckStr(dsCliente.Tables(0).Rows(0)("CLIEV_TELEFONOCLIENTE"))
                            Dim strRespuestaeai As String
                            Dim strEstado_Proceso_Dol As String = ConfigurationSettings.AppSettings("Estado_Proceso_Dol")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "Inicio oBusExpress.GrabarErrorActivacionPel " & "Estado Proceso Dol" & strEstado_Proceso_Dol)
                            oBusExpress.GrabarErrorActivacionPel(item.SERIE_CHIP, item.COD_PDV_PEL, item.COD_DEPA, strOpcion, Trim(item.COD_VEN_PEL), strChipPack, strServicioAdicional5, item.COD_PROD, item.COD_PLAN, item.COD_PROMOCION, item.TIPO_PROD, strCar5, strCar6, Trim(item.ID), strOperacionClaro, strEstadoActivacion, strCodigoRespuesta, strDescripcionRespuesta, strCar1, strLinea, strNombres, strApellidos, desDocCliente, item.NUM_DOC, strTelefonoReferencia, strEstado_Proceso_Dol, sDocumentoSap, strRespuestaeai)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "Respuesta: " & strRespuestaeai.ToString)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "Fin oBusExpress.GrabarErrorActivacionPel " & "Estado Proceso Dol" & strEstado_Proceso_Dol)
                        End If

                        strTelefonoNumeroTemporal = strLinea
                        strTelefonoNumero = strTelefonoNumero & strTelefonoNumeroTemporal.Substring(strTelefonoNumeroTemporal.Length - 9) & strTelefonoSeparador
                        strRegistroDOLRespuestaTemporal = IIf(procesoDOL, "1", "0")
                        strRegistroDOLRespuesta = strRegistroDOLRespuesta & strRegistroDOLRespuestaTemporal & strRegistroDOLSeparador

                        If Not procesoDOL Then
                            numerosTelefono = numerosTelefono & "No se pudo completar el proceso DOL del Chip " & item.SERIE_CHIP & "\n"
                        End If

                    Else
                        Dim strColeccion() As String = ConfigurationSettings.AppSettings("ConstErroresMostralPEL").Split("|"c)
                        Dim valido As Boolean = False
                        For indice As Integer = 0 To strColeccion.Length - 1
                            If strRsptaValidacion = strColeccion(indice) Then valido = True
                        Next
                        If valido Then
                            numerosTelefono = numerosTelefono & strDescripcionRespuesta & ". Chip " & item.SERIE_CHIP & "\n"
                        Else
                            numerosTelefono = numerosTelefono & "No se pudo realizar la activación del chip  " & item.SERIE_CHIP & ConfigurationSettings.AppSettings("constMensajeErrorPEL") & "\n"
                        End If

                    End If
                ElseIf item.COD_ACTIVACION = ConfigurationSettings.AppSettings("constCodActProdEspecialesPrepago") Then

                    objFileLog.Log_WriteLog(pathFile, strArchivo, "PROCESO PEL PARA UN PRODUCTO " & item.DESCRIPCION_PRODUCTO)
                    strTrace = Right(("00000" & Trim(item.ID)), 6)

                    strTipoPreActivacion = item.TIPO_ACTI
                    strTipoActivacion = item.TIPO_ACTI_V2

                    If item.FLAG_PACK = "S" Then
                        strCar6 = item.COD_MATERIAL_CHIP & "," & item.COD_MATERIAL_EQUI
                        item.SERIE_EQUI = "000000000000000" & item.SERIE_EQUI
                        strServicioAdicional5 = Right(item.SERIE_EQUI, 15)
                    Else
                        strCar6 = item.COD_MATERIAL_CHIP
                        strServicioAdicional5 = ""
                    End If

                    objFileLog.Log_WriteLog(pathFile, strArchivo, "********************")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Proceso Nuevo PEL " & item.DESCRIPCION_PRODUCTO)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "********************")
                    Dim oServicioNuevoPel As New ClsActivacionPel
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Parametros")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "IdTransaccion: " & sDocumentoSap)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Msisdn: " & item.LINEA)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Iccid: " & item.SERIE_CHIP)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Imsi: " & item.IMSI)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "IMEI: " & strServicioAdicional5)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "TipoPreActivacion: " & strTipoPreActivacion)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "TipoActivacion: " & strTipoActivacion)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Promocion" & item.COD_PROMOCION)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "CodigoMaterial" & strCar6)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Punto Venta " & item.COD_PDV)

                    Dim strRespPelBAM As String = oServicioNuevoPel.ActivacionLinea(item.LINEA, item.SERIE_CHIP, item.IMSI, strServicioAdicional5, strTipoPreActivacion, strTipoActivacion, item.COD_PROMOCION, strCar6, item.COD_PDV, sDocumentoSap, strDescripcionRespuesta)
                    strRespPelBAM = strRespPelBAM.Trim
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Respuesta:" & strRespPelBAM)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Codigo Respuesta" & strDescripcionRespuesta)

                    ' SI ENTRA AL CATCH EN EL WS GRABA EN UNA TABLA DE LOS ERRROS DE NUEVO PEL

                    If strRespPelBAM <> "0" Then
                        Dim strTelefonoReferencia = Funciones.CheckStr(dsCliente.Tables(0).Rows(0)("CLIEV_TELEFONOCLIENTE"))
                        Dim strRespuestaeai As String
                        Dim strEstado_Proceso_PelNew As String = ConfigurationSettings.AppSettings("Estado_Proceso_Pel")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Inicio oBusExpress.GrabarErrorActivacionNuevoPel" & "Estado de Proceso NUEVOPEL" & strEstado_Proceso_PelNew)
                        oBusExpress.GrabarErrorActivacionNuevoPel(item.LINEA, item.SERIE_CHIP, item.IMSI, strServicioAdicional5, strTipoPreActivacion, strTipoActivacion, item.COD_PROMOCION, strCar6, item.COD_PDV, sDocumentoSap, strDescripcionRespuesta, strRespPelBAM, strNombres, strApellidos, desDocCliente, item.NUM_DOC, strTelefonoReferencia, item.COD_PDV_PEL, item.COD_VEN_PEL, item.NUM_OPER, Trim(item.ID), strEstado_Proceso_PelNew, strRespuestaeai)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Respuesta: " & strRespuestaeai.ToString)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Fin oBusExpress.GrabarErrorActivacionNuevoPel" & "Estado de Proceso NUEVOPEL" & strEstado_Proceso_PelNew)
                        numerosTelefono = numerosTelefono & "No se pudo realizar la activación del chip " & item.DESCRIPCION_PRODUCTO & " " & item.SERIE_CHIP & " Nro. Linea " & item.LINEA & " " & ConfigurationSettings.AppSettings("constMensajeErrorPEL") & "\n"
                    Else
                        bolRespuesta = True

                        objFileLog.Log_WriteLog(pathFile, strArchivo, "***************")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "PROCESO DOL " & item.DESCRIPCION_PRODUCTO)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "***************")
                        '<PROCESO PEL - INICIO>'
                        Dim nroTelefonoPEL As String = item.LINEA.Trim
                        '<PROCESO PEL - FIN>'

                        '<INICIO DOL - INICIO>'
                        Dim idDOL As String = ""
                        Dim msgDOL As String = ""
                        Dim procesoDOL As Boolean = False
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Parametros")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Documento: " & sDocumentoSap)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Nro Linea: " & nroTelefonoPEL)

                        'ava val dol

                        Dim listaOficinasVirtuales$ = ConfigurationSettings.AppSettings("TIENDA_VIRTUAL")
                        Dim isTiendaVirtual As Boolean = False

                        If (IsNothing(listaOficinasVirtuales)) Then Throw New Exception("Lista oficinas virtuales no configuradas - Activacion Pel")
                        For Each sTiendaVirtual As String In listaOficinasVirtuales.Split("|"c)
                            If AppAlmacen = sTiendaVirtual Then
                                isTiendaVirtual = True
                                Exit For
                            End If

                        Next
                        If (Not isTiendaVirtual) Then
                        procesoDOL = RegistroDOL(sDocumentoSap, nroTelefonoPEL, idDOL, msgDOL)
                        End If
                        'ava fin val dol

                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Respuesta")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "idDOL" & idDOL)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Msj DOL: " & msgDOL)
                        '<INICIO DOL - FIN>'

                        'PROY-24388 INICIO RAR
                        If Not procesoDOL Then
                            Dim strTelefonoReferencia = Funciones.CheckStr(dsCliente.Tables(0).Rows(0)("CLIEV_TELEFONOCLIENTE"))
                            Dim strRespuestaeai As String
                            Dim strEstado_Proceso_Dol As String = ConfigurationSettings.AppSettings("Estado_Proceso_Dol")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "Inicio oBusExpress.GrabarErrorActivacionNuevoPel" & "Estado de Proceso DOL" & strEstado_Proceso_Dol)
                            oBusExpress.GrabarErrorActivacionNuevoPel(item.LINEA, item.SERIE_CHIP, item.IMSI, strServicioAdicional5, strTipoPreActivacion, strTipoActivacion, item.COD_PROMOCION, strCar6, item.COD_PDV, sDocumentoSap, strDescripcionRespuesta, strRespPelBAM, strNombres, strApellidos, desDocCliente, item.NUM_DOC, strTelefonoReferencia, item.COD_PDV_PEL, item.COD_VEN_PEL, item.NUM_OPER, Trim(item.ID), strEstado_Proceso_Dol, strRespuestaeai)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "Respuesta: " & strRespuestaeai.ToString)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, "Fin oBusExpress.GrabarErrorActivacionNuevoPel" & "Estado de Proceso DOL" & strEstado_Proceso_Dol)
                        End If
                        strTelefonoNumeroTemporal = item.LINEA
                        strTelefonoNumero = strTelefonoNumero & strTelefonoNumeroTemporal.Substring(strTelefonoNumeroTemporal.Length - 9) & strTelefonoSeparador
                        strRegistroDOLRespuestaTemporal = IIf(procesoDOL, "1", "0")
                        strRegistroDOLRespuesta = strRegistroDOLRespuesta & strRegistroDOLRespuestaTemporal & strRegistroDOLSeparador
                        'PROY-24388 FIN RAR
                        If Not procesoDOL Then
                            numerosTelefono = numerosTelefono & "No se pudo completar el proceso DOL del Chip " & item.DESCRIPCION_PRODUCTO & " " & item.SERIE_CHIP & " Nro Linea " & item.LINEA & "\n"
                        End If

                        objFileLog.Log_WriteLog(pathFile, strArchivo, "********************")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Grabar Activación Linea ")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "********************")

                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Parametros " & item.DESCRIPCION_PRODUCTO)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Tipo Documento: " & item.TIPO_DOC)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Numero Documento: " & item.NUM_DOC)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Linea: " & item.LINEA)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Punto de Vental PEL: " & item.COD_PDV_PEL)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Codigo Vendedor PEL: " & item.COD_VEN_PEL)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Operacion Claro: " & item.NUM_OPER)

                        Dim strCodiRespActiBAM As String = oBusExpress.ConsultaGrabarDatosActivacion(item.TIPO_DOC, item.NUM_DOC, item.LINEA, item.COD_PDV_PEL, item.COD_VEN_PEL, item.NUM_OPER, strCodigoRespuesta, strDescripcionRespuesta)
                        strCodiRespActiBAM = strCodiRespActiBAM.Trim
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Cod respuesta Servicio BAM: " & strCodiRespActiBAM)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Cod respuesta: " & strCodigoRespuesta)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Des respuesta: " & strDescripcionRespuesta)

                        If strCodiRespActiBAM = "00" Then
                            numerosTelefono = numerosTelefono & "Se completó el proceso de activación del Chip " & item.DESCRIPCION_PRODUCTO & " " & item.SERIE_CHIP & " Nro Linea " & item.LINEA & "\n"
                        Else
                            numerosTelefono = numerosTelefono & "No se pudo completar el proceso de activación del Chip " & item.DESCRIPCION_PRODUCTO & " " & item.SERIE_CHIP & " Nro Linea " & item.LINEA & "\n"
                        End If
                    End If

                ElseIf item.COD_ACTIVACION = ConfigurationSettings.AppSettings("constCodActTFIPrepago") Then

                    objFileLog.Log_WriteLog(pathFile, strArchivo, "PROCESO PEL PARA UN PRODUCTO " & item.DESCRIPCION_PRODUCTO)
                    strTrace = Right(("00000" & Trim(item.ID)), 6)

                    strTipoPreActivacion = item.TIPO_ACTI
                    strTipoActivacion = item.TIPO_ACTI_V2

                    If item.FLAG_PACK = "S" Then
                        strCar6 = item.COD_MATERIAL_CHIP & "," & item.COD_MATERIAL_EQUI
                        item.SERIE_EQUI = "000000000000000" & item.SERIE_EQUI
                        strServicioAdicional5 = Right(item.SERIE_EQUI, 15)
                    Else
                        strCar6 = item.COD_MATERIAL_CHIP
                        strServicioAdicional5 = ""
                    End If

                    objFileLog.Log_WriteLog(pathFile, strArchivo, "********************")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Proceso PEL " & item.DESCRIPCION_PRODUCTO)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "********************")
                    Dim oServicioNuevoPel As New ClsActivacionPel
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Parametros")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "IdTransaccion: " & sDocumentoSap)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Msisdn: " & item.LINEA)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Iccid: " & item.SERIE_CHIP)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Imsi: " & item.IMSI)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "IMEI: " & strServicioAdicional5)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "TipoPreActivacion: " & strTipoPreActivacion)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "TipoActivacion: " & strTipoActivacion)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Promocion" & item.COD_PROMOCION)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "CodigoMaterial" & strCar6)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Punto Venta " & item.COD_PDV)

                    Dim strRespPelBAM As String = oServicioNuevoPel.ActivacionLinea(item.LINEA, item.SERIE_CHIP, item.IMSI, strServicioAdicional5, strTipoPreActivacion, strTipoActivacion, item.COD_PROMOCION, strCar6, item.COD_PDV, sDocumentoSap, strDescripcionRespuesta)
                    strRespPelBAM = strRespPelBAM.Trim
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Respuesta:" & strRespPelBAM)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Codigo Respuesta" & strDescripcionRespuesta)



                    If strRespPelBAM <> "0" Then
                        numerosTelefono = numerosTelefono & "No se pudo realizar la activación del chip " & item.DESCRIPCION_PRODUCTO & " " & item.SERIE_CHIP & " Nro. Linea " & item.LINEA & " " & ConfigurationSettings.AppSettings("constMensajeErrorPEL") & "\n"
                        Dim strTelefonoReferencia = Funciones.CheckStr(dsCliente.Tables(0).Rows(0)("CLIEV_TELEFONOCLIENTE"))
                        Dim strRespuestaeai As String
                        Dim strEstado_Proceso_PelNew As String = ConfigurationSettings.AppSettings("Estado_Proceso_Pel")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Inicio oBusExpress.GrabarErrorActivacionNuevoPel" & "Estado de Proceso NUEVOPEL" & strEstado_Proceso_PelNew)
                        oBusExpress.GrabarErrorActivacionNuevoPel(item.LINEA, item.SERIE_CHIP, item.IMSI, strServicioAdicional5, strTipoPreActivacion, strTipoActivacion, item.COD_PROMOCION, strCar6, item.COD_PDV, sDocumentoSap, strDescripcionRespuesta, strRespPelBAM, strNombres, strApellidos, desDocCliente, item.NUM_DOC, strTelefonoReferencia, item.COD_PDV_PEL, item.COD_VEN_PEL, item.NUM_OPER, Trim(item.ID), strEstado_Proceso_PelNew, strRespuestaeai)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Respuesta: " & strRespuestaeai.ToString)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Fin oBusExpress.GrabarErrorActivacionNuevoPel" & "Estado de Proceso NUEVOPEL" & strEstado_Proceso_PelNew)
                    Else
                        bolRespuesta = True

                        objFileLog.Log_WriteLog(pathFile, strArchivo, "********************")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Grabar Activación Linea ")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "********************")

                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Parametros " & item.DESCRIPCION_PRODUCTO)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Tipo Documento: " & item.TIPO_DOC)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Numero Documento: " & item.NUM_DOC)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Linea: " & item.LINEA)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Punto de Vental PEL: " & item.COD_PDV_PEL)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Codigo Vendedor PEL: " & item.COD_VEN_PEL)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Operacion Claro: " & item.NUM_OPER)

                        Dim strCodiRespActiBAM As String = oBusExpress.ConsultaGrabarDatosActivacion(item.TIPO_DOC, item.NUM_DOC, item.LINEA, item.COD_PDV_PEL, item.COD_VEN_PEL, item.NUM_OPER, strCodigoRespuesta, strDescripcionRespuesta)
                        strCodiRespActiBAM = strCodiRespActiBAM.Trim
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "strCodiRespActiBAM: " & strCodiRespActiBAM)

                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Cod respuesta: " & strCodigoRespuesta)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "Des respuesta: " & strDescripcionRespuesta)

                        If strCodiRespActiBAM = "00" Then
                            numerosTelefono = numerosTelefono & "Se completó el proceso de activación del Chip " & item.DESCRIPCION_PRODUCTO & " " & item.SERIE_CHIP & " Nro. Linea " & item.LINEA & "\n"
                        Else
                            numerosTelefono = numerosTelefono & "No se pudo completar el proceso de activación del Chip " & item.DESCRIPCION_PRODUCTO & " " & item.SERIE_CHIP & " Nro. Linea " & item.LINEA & "\n"
                        End If
                    End If
                End If

            Next


        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, "		ERROR: " & ex.Message.ToString())
            objFileLog.Log_WriteLog(pathFile, strArchivo, "		ERROR: " & ex.StackTrace.ToString())
            numerosTelefono = "Error al completar el proceso de activación del Chip"
            Return numerosTelefono 'proceso
        End Try

        Return numerosTelefono
    End Function

    Public Function RegistroDOL(ByVal docSap As String, ByVal telefonoPel As String, _
                                ByRef strId As String, ByRef strMensaje As String) As Boolean

        objFileLog.Log_WriteLog(pathFile, strArchivo, "******************")
        objFileLog.Log_WriteLog(pathFile, strArchivo, "INICIO PROCESO DOL")
        objFileLog.Log_WriteLog(pathFile, strArchivo, "******************")

        Try

            Dim numeroTratado As String
            If telefonoPel.Length > 9 Then
                numeroTratado = Microsoft.VisualBasic.Right(telefonoPel, 9)
            End If
            objFileLog.Log_WriteLog(pathFile, strArchivo, "Numero tratado: " & numeroTratado)
            telefonoPel = numeroTratado
            AppnumeroTelefonoPel = numeroTratado

            Dim dtDatos As New DataTable
            Dim objBus As New ClsActivacionPel
            dtDatos = objBus.ListarDatosCabeceraVenta(docSap)

            objFileLog.Log_WriteLog(pathFile, strArchivo, "Datos de Cabecera: " & dtDatos.Rows.Count)

            If dtDatos.Rows.Count > 0 Then
                Dim nombres As String = dtDatos.Rows(0).Item("VEPR_NOM_CLIE").ToString()
                Dim apellidos As String = dtDatos.Rows(0).Item("VEPR_APE_CLIE").ToString()
                Dim documento As String = dtDatos.Rows(0).Item("VEPR_NUM_DOC").ToString()
                Dim codTipoDocumento As String = dtDatos.Rows(0).Item("VEPR_TIPO_DOC").ToString()
                Dim desDocCliente As String
                Dim telefono As String = telefonoPel '<dato PEL>
                Dim codVendedor As String = dtDatos.Rows(0).Item("VEPR_COD_VEN").ToString()

                objFileLog.Log_WriteLog(pathFile, strArchivo, "Datos Principales: " & nombres & ";" & apellidos & ";" & documento & ";" & codTipoDocumento & ";" & desDocCliente & ";" & telefono & ";" & codVendedor)


                Do While InStr(1, codVendedor, "0") = 1
                    codVendedor = Mid(codVendedor, 2, Len(codVendedor))
                Loop

                Dim listaDocumento() As String
                listaDocumento = Split(ConfigurationSettings.AppSettings("strListaDocumentos"), "|")

                For ii As Integer = 0 To UBound(listaDocumento)
                    Dim arrayDocumento() As String = Split(listaDocumento(ii), ";")
                    If arrayDocumento(0) = Right("00" & codTipoDocumento, 2) Then
                        desDocCliente = arrayDocumento(1)
                        Exit For
                    End If
                Next
                If (codTipoDocumento = "11") Then
                    desDocCliente = "CIRE"
                ElseIf (codTipoDocumento = "12") Then
                    desDocCliente = "CIE"
                ElseIf (codTipoDocumento = "13") Then
                    desDocCliente = "CPP"
                ElseIf (codTipoDocumento = "14") Then
                    desDocCliente = "CTM"
                End If
                objFileLog.Log_WriteLog(pathFile, strArchivo, "PROY-31636" & "- " & "  Des.TipoDoc :" & desDocCliente)
                Dim usrDOL As String
                'Si es DAC
                usrDOL = ConfigurationSettings.AppSettings("ConsUsrCAC").ToString()

               'BEGIN PROY-31636 RENTESEG
                Dim sCodNacionalidad As String = String.Empty
                Try
                    Dim iFlagEnviaNac As Integer = 0
                    iFlagEnviaNac = Funciones.CheckInt(ConfigurationSettings.AppSettings("FlagEnviaNac").ToString())
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "PROY-31636" & "- " & "  iFlagEnviaNac :" & iFlagEnviaNac)
                    If iFlagEnviaNac = 1 Then

                        Dim dsCliente As DataSet
                        Dim k_nrolog As Integer = 0
                        Dim k_deslog As String = String.Empty
                        Dim clsConsultaPvu As New COM_SIC_Activaciones.clsConsultaPvu
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "PROY-31636" & "- " & "--Inicio Consulta de Cliente - Metodo: consultaDatosCliente - SP: SSAPSS_CLIENTE")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "PROY-31636" & "- " & "       IN Tipo de Documento:" & codTipoDocumento)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "PROY-31636" & "- " & "       IN Nro de Documento:" & documento)
                        dsCliente = clsConsultaPvu.consultaDatosCliente(codTipoDocumento, documento, k_nrolog, k_deslog)
                        If dsCliente.Tables(0).Rows.Count > 0 Then
                            sCodNacionalidad = IIf(IsDBNull(dsCliente.Tables(0).Rows(0).Item("CLIEC_CODNACION")), String.Empty, dsCliente.Tables(0).Rows(0).Item("CLIEC_CODNACION"))
                        End If
                        objFileLog.Log_WriteLog(pathFile, strArchivo, "PROY-31636" & "- " & "  NACIONALIDAD :" & sCodNacionalidad)
                    Else
                        sCodNacionalidad = String.Empty
                    End If
                Catch Ex As Exception
                    sCodNacionalidad = String.Empty
                End Try
                'END PROY-31636 RENTESEG
                Dim oCliente As New COM_SIC_Activaciones.clsCliente
                oCliente.NROTRANSACCION = DateTime.Now.ToString("yyyyMMddHHmmss")
                oCliente.NOMBRES = nombres 'Left(dsCliente.Tables(0).Rows(0)("RAZON_SOCIAL"), 30)
                oCliente.APELLIDOS = apellidos 'Left(dsCliente.Tables(0).Rows(0)("RAZON_SOCIAL"), 30)
                oCliente.TIPODOCUMENTO = desDocCliente
                oCliente.NUMERODOCUMENTO = documento 'dsCliente.Tables(0).Rows(0)("CLIENTE")
                oCliente.TELEFONOREFERENCIA = telefono 'dsCliente.Tables(0).Rows(0)("TELEFONO")
                oCliente.FECHANACIMIENTO = ""
                oCliente.LUGARNACIMIENTO = sCodNacionalidad 'PROY-31636 RENTESEG
                oCliente.MOTIVOREGISTRO = ConfigurationSettings.AppSettings("MOTIVO_DOL")
                oCliente.DIRECCIONCOMPLETA = ConfigurationSettings.AppSettings("CTE_NO_ESPECIFICADO")
                oCliente.CIUDAD = ConfigurationSettings.AppSettings("CTE_NO_ESPECIFICADO")
                oCliente.CODIGOEMPLEADO = usrDOL 'Me.CurrentUser ' codVendedor 'usuarioRed
                oCliente.CODIGOSISTEMA = usrDOL 'ConfigurationSettings.AppSettings("COD_SISTEMA_DOL")
                oCliente.TIPO = ConfigurationSettings.AppSettings("TIPO_CLIE_DOL")
                oCliente.TEXTO = ConfigurationSettings.AppSettings("TEXTO_DOL")


                Dim NroTelefono As String
                NroTelefono = FormatoTelefonoPrepago(telefonoPel)
                oCliente.MSISDN = NroTelefono
                Dim outDOL As String = ""

                Dim result_id As String = ""
                Dim result_msg As String = ""


                objFileLog.Log_WriteLog(pathFile, strArchivo, "---Parametros---")
                objFileLog.Log_WriteLog(pathFile, strArchivo, "NROTRANSACCION: " & oCliente.NROTRANSACCION)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "NOMBRES: " & oCliente.NOMBRES)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "APELLIDOS: " & oCliente.APELLIDOS)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "TIPODOCUMENTO: " & oCliente.TIPODOCUMENTO)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "NUMERODOCUMENTO: " & oCliente.NUMERODOCUMENTO)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "TELEFONOREFERENCIA: " & oCliente.TELEFONOREFERENCIA)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "FECHANACIMIENTO: " & oCliente.FECHANACIMIENTO)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "LUGARNACIMIENTO: " & sCodNacionalidad) 'PROY-31636
                objFileLog.Log_WriteLog(pathFile, strArchivo, "MOTIVOREGISTRO: " & oCliente.MOTIVOREGISTRO)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "DIRECCIONCOMPLETA: " & oCliente.DIRECCIONCOMPLETA)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "CIUDAD: " & oCliente.CIUDAD)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "CODIGOEMPLEADO: " & oCliente.CODIGOEMPLEADO)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "CODIGOSISTEMA: " & oCliente.CODIGOSISTEMA)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "TIPO: " & oCliente.TIPO)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "TEXTO: " & oCliente.TEXTO)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "MSISDN: " & oCliente.MSISDN)

                Dim oDOL As New COM_SIC_Activaciones.clsDOL
                'ava inicio val dol

                Dim listaOficinasVirtuales$ = ConfigurationSettings.AppSettings("TIENDA_VIRTUAL")
                Dim isTiendaVirtual As Boolean = False

                If (IsNothing(listaOficinasVirtuales)) Then Throw New Exception("Lista oficinas virtuales no configuradas - Activacion Pel")
                For Each sTiendaVirtual As String In listaOficinasVirtuales.Split("|"c)
                    If AppAlmacen = sTiendaVirtual Then
                        isTiendaVirtual = True
                        Exit For
                    End If

                Next
                If (Not isTiendaVirtual) Then ' si no es tienda virtual, hara el proceso dol
                outDOL = oDOL.RegistroDOL(oCliente, _
                                          ConfigurationSettings.AppSettings("constRutaWSDOL"), _
                                          CInt(ConfigurationSettings.AppSettings("constTimeOutWSDOL")), _
                                          result_id, result_msg)
                    oDOL = Nothing
                End If

                'ava fin val dol


                oDOL = Nothing
                objFileLog.Log_WriteLog(pathFile, strArchivo, "--Respuesta--")
                objFileLog.Log_WriteLog(pathFile, strArchivo, "outDOL: " & outDOL)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "result_id: " & result_id)
                objFileLog.Log_WriteLog(pathFile, strArchivo, "result_msg: " & result_msg)

                If Not Trim(outDOL) = "0" Then
                    Dim msgDol As String = "No se pudo Registrar WS DOL, Nro Telefono:" & NroTelefono & ". "
                    Dim StrComando As String = " alert('" & msgDol & "'); "
                    If outDOL = "2" Then
                        StrComando &= " alert('" & result_msg & "'); "
                        msgDol &= result_msg
                    End If
                    'RegisterStartupScript("script", "<script>" & StrComando & "</script>")

                    strMensaje = msgDol
                    Return False
                    ' Capturamos el Error en el Log
                    'Session.Add("mensajeErrorDOL", Session("mensajeErrorDOL") & "\nError. No se pudo Registrar WS DOL, Nro Telefono: " & NroTelefono & ".")
                Else
                    Return True
                End If
            End If
        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, "ERROR EN REGISTRO DOL:" & ex.Message)
            Return False
        End Try

    End Function


    'Private Sub AuditoriaPagarPedido(ByVal desTrans As String)
    '    Try
    '        Dim nombreHost As String = System.Net.Dns.GetHostName
    '        Dim nombreServer As String = System.Net.Dns.GetHostName
    '        Dim ipServer As String = System.Net.Dns.GetHostByName(nombreServer).AddressList(0).ToString
    '        Dim hostInfo As System.Net.IPHostEntry = System.Net.Dns.GetHostByName(nombreHost)
    '        Dim usuario_id As String = CurrentUser
    '        Dim ipcliente As String = CurrentTerminal

    '        Dim strCodAplica As String = ConfigurationSettings.AppSettings("CodAplicacion")
    '        Dim strCodServ As String = ConfigurationSettings.AppSettings("CONS_COD_SICAR_SERV")
    '        Dim strCodTrans As String = ConfigurationSettings.AppSettings("constSicarAuditPagoVenta")

    '        objFileLog.Log_WriteLog(pathFile, strArchivo, "Nombre Host    : " & nombreHost)
    '        objFileLog.Log_WriteLog(pathFile, strArchivo, "Nombre Server  : " & nombreServer)
    '        objFileLog.Log_WriteLog(pathFile, strArchivo, "ipServer       : " & ipServer)
    '        objFileLog.Log_WriteLog(pathFile, strArchivo, "HostInfo       : " & hostInfo.ToString())
    '        objFileLog.Log_WriteLog(pathFile, strArchivo, "Usuario_id     : " & usuario_id)
    '        objFileLog.Log_WriteLog(pathFile, strArchivo, "ipCliente      : " & ipcliente)
    '        objFileLog.Log_WriteLog(pathFile, strArchivo, "Cod Aplica     : " & strCodAplica)
    '        objFileLog.Log_WriteLog(pathFile, strArchivo, "Cod Serv       : " & strCodServ)
    '        objFileLog.Log_WriteLog(pathFile, strArchivo, "CodTrans    : " & strCodTrans)

    '        Dim objClsAuditoriaWS As New clsAuditoriaWS

    '        Dim auditoriaGrabado As Boolean = objClsAuditoriaWS.RegistrarAuditoria(strCodTrans, strCodServ, ipcliente, nombreHost, ipServer, nombreServer, usuario_id, "", "0", desTrans)
    '        If Not auditoriaGrabado Then
    '            Throw New Exception("Error. No se registro en Auditoria la Grabacion Pedido de Venta Prepago.")
    '        End If
    '    Catch ex As Exception
    '        objFileLog.Log_WriteLog(pathFile, strArchivo, "Error : " & ex.Message)
    '    End Try

    '    objFileLog.Log_WriteLog(pathFile, strArchivo, "*********************")
    '    objFileLog.Log_WriteLog(pathFile, strArchivo, "Fin Proceso Auditoria")
    '    objFileLog.Log_WriteLog(pathFile, strArchivo, "*********************")
    'End Sub

    'FIN FMES : ACTIVACION PEL
    Private Function ObtenerMontoPago(ByVal strDetallePago) As String
        Dim arrDetallePago() As String = Split(strDetallePago, "|"c)
        Dim dblMontoPago As Double
        For i As Integer = 0 To UBound(arrDetallePago)
            Dim arrItemPago() As String = Split(arrDetallePago(i), ";"c)
            dblMontoPago += CheckDbl(arrItemPago(5))
        Next
        Return dblMontoPago.ToString()
    End Function

    Private Function TipificacionCambioPlanRenov(ByVal numeroTelefono As String, ByVal documentoSAP As String, ByVal usuario As String, ByVal strNota As String, ByRef FlagMetodo As String, ByRef MensajeTipi As String) As String

        Dim strIdentifyLog As String = documentoSAP

        'Guardar Interaccion 
        Dim oInteraccion = New COM_SIC_INActChip.Interaccion

        With oInteraccion
            '.OBJID_CONTACTO = objId
            .TELEFONO = numeroTelefono
            .TIPO = ConfigurationSettings.AppSettings("CONS_RENOVACION_TIPO1")
            .CLASE = ConfigurationSettings.AppSettings("CONS_CAMBIO_PLAN_CLASE")
            .SUBCLASE = ConfigurationSettings.AppSettings("CONS_CAMBIO_PLAN_SUBCLASE")
            .METODO = ConfigurationSettings.AppSettings("CONS_RENOVACION_METODO")
            .TIPO_INTER = ConfigurationSettings.AppSettings("CONS_RENOVACION_TIPO_INTER")
            .AGENTE = usuario
            .USUARIO_PROCESO = ConfigurationSettings.AppSettings("CONS_RENOVACION_USUARIO")
            .FLAG_CASO = ConfigurationSettings.AppSettings("CONS_RENOVACION_FLAG")
            .RESULTADO = ConfigurationSettings.AppSettings("CONS_RENOVACION_RESULTADO")
            .HECHO_EN_UNO = ConfigurationSettings.AppSettings("CONS_RENOVACION_HECHO")
            If CheckStr(strNota) <> "" Then
                .NOTAS = strNota
            End If
        End With

        Dim oTipificacion As New COM_SIC_INActChip.clsTipificacion
        Dim flagInter As String
        Dim mensajeInter As String
        Dim idInteraccion As String

        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo TipificacionCambioPlanRenov()")
 
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " TELEFONO:" & CheckStr(oInteraccion.TELEFONO))
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " TIPO:" & CheckStr(oInteraccion.TIPO))
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " CLASE:" & CheckStr(oInteraccion.CLASE))
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " SUBCLASE:" & CheckStr(oInteraccion.SUBCLASE))
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " METODO:" & CheckStr(oInteraccion.METODO))
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " TIPO_INTER:" & CheckStr(oInteraccion.TIPO_INTER))
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " AGENTE:" & CheckStr(oInteraccion.AGENTE))
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " USUARIO_PROCESO:" & CheckStr(oInteraccion.USUARIO_PROCESO))
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " FLAG_CASO:" & CheckStr(oInteraccion.FLAG_CASO))
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " RESULTADO:" & CheckStr(oInteraccion.RESULTADO))
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " HECHO_EN_UNO:" & CheckStr(oInteraccion.HECHO_EN_UNO))
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " NOTAS:" & CheckStr(oInteraccion.NOTAS))
           
        Try
            oTipificacion.CrearInteraccion(oInteraccion, idInteraccion, flagInter, mensajeInter)
            'Inicio SD854808 Relanzamiento Cambio de Plan JAZ
            FlagMetodo = flagInter
            MensajeTipi = mensajeInter
            'Fin SD854808 Relanzamiento Cambio de Plan JAZ
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Id Interaccion : " & idInteraccion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Flag Metodo : " & flagInter)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje : " & mensajeInter)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo TipificacionCambioPlanRenov()")
        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "error TipificacionCambioPlanRenov:" & ex.Message.ToString())
        End Try
        Return idInteraccion
    End Function

    'Private Function ConsultaFormaPagoNotaCredito() As Boolean
    '    Dim strDocumento As String = ""
    '    Dim sw As Double = True
    '    Dim valArray As String()
    '    Dim serie As String = ""
    '    Try
    '        For i As Integer = 0 To hidNumFilas
    '            If Trim(Request.Form("cboTipDocumento" & (i + 1))) = "ZNCR" Then
    '                strDocumento = Request.Item("txtDoc" & (i + 1))
    '                If strDocumento.Trim.Length > 0 Then

    '                    valArray = strDocumento.ToString.Split("-")
    '                    serie = valArray(1)
    '                    'If (strDocumento.ToString.Substring(0, 1) = "B" Or strDocumento.ToString.Substring(0, 1) = "F") Then
    '                    '    If ConsultaPedidoXCorrelativoGenerado(strDocumento.Trim.ToString, i) = False Then
    '                    '        sw = False
    '                    '    End If
    '                    'End If
    '                    If (serie.StartsWith("B") Or serie.StartsWith("F")) Then
    '                        If ConsultaPedidoXCorrelativoGenerado(strDocumento.Trim.ToString, i) = False Then
    '                            sw = False
    '                        End If
    '                    End If
    '                End If
    '            End If
    '        Next

    '        Return sw
    '    Catch ex As Exception

    '    End Try
    'End Function

    Private Function ValidaDatosNotaCredito(ByVal dsdatos As DataSet) As Boolean
        Try
            Dim strTipoDoc As String = ""
            Dim strNroDoc As String = ""
            Dim strTipoDoc_origen As String = ""
            Dim strNroDoc_origen As String = ""
            Dim dsPedido As DataSet

            If Not dsdatos Is Nothing Then
                If dsdatos.Tables(0).Rows.Count >= 1 Then
                    strTipoDoc = dsdatos.Tables(0).Rows(0).Item("PEDIC_TIPODOCCLIENTE")
                    strNroDoc = dsdatos.Tables(0).Rows(0).Item("PEDIV_NRODOCCLIENTE")

                    'Validaciòn 1:
                    'If dsdatos.Tables(0).Rows(0).Item("PEDIC_ESTADO") <> "PAG" Then
                    '    hidMensajeNC.Value = "La nota de crèdito seleccionada no se encuentra procesada."
                    '    Response.Write("<script>alert('La nota de crèdito seleccionada no se encuentra procesada.')</script>")
                    '    Return False
                    '    Exit Function
                    'End If

                    '**Inicio consultamos pedido original 
                    dsPedido = objConsultaMsSap.ConsultaPedido(drPagos.Item("PEDIN_NROPEDIDO"), "", "") 'TODOEB
                    If Not dsPedido Is Nothing Then
                        If dsPedido.Tables(0).Rows.Count > 0 Then
                            strTipoDoc_origen = dsPedido.Tables(0).Rows(0).Item("CLIEC_TIPODOCCLIENTE")
                            strNroDoc_origen = dsPedido.Tables(0).Rows(0).Item("CLIEV_NRODOCCLIENTE")
                        End If
                    End If
                    '**Fin consulta original

                    'Validaciòn 2:
                    '** Valida si ambos pedidos son del mismo cliente  **'
                    If (strTipoDoc_origen <> strTipoDoc Or strNroDoc_origen <> strNroDoc) Then
                        hidMensajeNC = "La nota de crédito utilizada no corresponde al cliente"
                        'Response.Write("<script>alert('La nota de crédito utilizada no corresponde al cliente.')</script>")
                        Return False
                        Exit Function
                    End If

                    'Validaciòn3:
                    '**Verifica no se haya usado con atenrioridad... ***'
                    If dsdatos.Tables(0).Rows(0).Item("PEDIC_ISFORMAPAGO") = 1 Then
                        hidMensajeNC = "La nota de crédito ya fue utilizada en un pago anterior."
                        'Response.Write("<script>alert('La nota de crédito ya fue utilizada en un pago anterior.')</script>")
                        Return False
                        Exit Function
                    End If
                End If
            End If
            hidMensajeNC = ""
            Return True
        Catch ex As Exception

        End Try
    End Function

    'Private Function ConsultaPedidoXCorrelativoGenerado(ByVal strDocumento As String, ByVal pos As Integer) As Boolean
    '    Try
    '        Dim dsDatos As DataSet
    '        Dim NLOG As String = ""
    '        Dim DLOG As String = ""
    '        Dim sw As Boolean = True
    '        PEDIN_PEDIDOSAP = ""


    '        dsDatos = objConsultaMsSap.ConsultaPedidoXCorrelativo(strDocumento.Trim.ToString, objConsultaMsSap.ConsultaPuntoVenta(AppAlmacen).Tables(0).Rows(0).Item("OVENV_CODIGO_SINERGIA"), NLOG, DLOG)
    '        If Not dsDatos Is Nothing Then
    '            If dsDatos.Tables(0).Rows.Count >= 1 Then
    '                'Validaciòn Datos NC
    '                If ValidaDatosNotaCredito(dsDatos) Then
    '                    '** guarda los correlativos de las nc usadas para el pago.
    '                    'arrayListaRefSunat(pos + 1) = Funciones.CheckStr(IIf(IsDBNull(dsDatos.Tables(0).Rows(0).Item("PEDIV_NROSUNAT")), "", dsDatos.Tables(0).Rows(0).Item("PEDIV_NROSUNAT")))
    '                    arrayListaRefSunat(pos + 1) = Funciones.CheckStr(IIf(IsDBNull(dsDatos.Tables(0).Rows(0).Item("PEDIV_NUEVONROSUNAT")), "", dsDatos.Tables(0).Rows(0).Item("PEDIV_NUEVONROSUNAT")))
    '                    arrayListaReferencia(pos + 1) = Funciones.CheckStr(IIf(IsDBNull(dsDatos.Tables(0).Rows(0).Item("PEDIN_PEDIDOSAP")), "", dsDatos.Tables(0).Rows(0).Item("PEDIN_PEDIDOSAP")))
    '                    arrayListaRefPedido(pos + 1) = Funciones.CheckStr(IIf(IsDBNull(dsDatos.Tables(0).Rows(0).Item("PEDIN_NROPEDIDO")), "", dsDatos.Tables(0).Rows(0).Item("PEDIN_NROPEDIDO")))

    '                    Select Case pos
    '                        Case 0
    '                            txtMonto1.Text = Format(dsDatos.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO"), "###0.00")
    '                            'Case 1
    '                            '    txtMonto2.Text = Format(dsDatos.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO"), "###0.00")
    '                            'Case 2
    '                            '    txtMonto3.Text = Format(dsDatos.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO"), "###0.00")
    '                            'Case 3
    '                            '    txtMonto4.Text = Format(dsDatos.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO"), "###0.00")
    '                            'Case 4
    '                            '    txtMonto5.Text = Format(dsDatos.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO"), "###0.00")
    '                    End Select
    '                Else
    '                    sw = False
    '                End If
    '            Else
    '                sw = False
    '                hidMensajeNC = "No existe ninguna nota de crédito para el documento ingresado."
    '                'Response.Write("<script>alert('No existe ninguna nota de crédito para el documento ingresado.')</script>")
    '                Return False
    '            End If
    '        Else
    '            sw = False
    '            hidMensajeNC = "No existe ninguna nota de crédito para el documento ingresado."
    '            'Response.Write("<script>alert('No existe ninguna nota de crédito para el documento ingresado.')</script>")
    '            Return False
    '        End If

    '        Return sw
    '    Catch ex As Exception
    '        'Response.Write("<script>alert('" & Session("msgCaducidadRMP6") & "')</script>")
    '    End Try
    'End Function

    Private Sub Log_ServicioCambioPlanPostPago(ByVal TipoLog, ByVal RespuestaProgramarMigracion, ByVal NroVeces, ByVal TryError, ByVal idTransaccion, ByVal ipAplicacion, ByVal aplicacion, ByVal msisdn, ByVal coId, ByVal customerId, ByVal Cuenta, ByVal escenario, ByVal TipoProducto, ByVal serviciosAdicionales, ByVal codigoProducto, ByVal codigoPlanBase, ByVal montoApadece, ByVal montoFidelizar, ByVal flagValidaApadece, ByVal flagAplicaApadece, ByVal TopeConsumo, ByVal tipoTope, ByVal descripcionTipoTpe, ByVal tipoRegistroTope, ByVal topeControlConsumo, ByVal fechaProgramacionTope, ByVal CAC, ByVal asesor, ByVal codigoInteraccion, ByVal montoPCS, ByVal areaPCS, ByVal motivoPCS, ByVal subMotivoPCS, ByVal cicloFacturacion, ByVal idTipoCliente, ByVal numeroDocumento, ByVal flagServicioOnTop, ByVal fechaProgramacion, ByVal flagLimiteCredito, ByVal tipoClarify, ByVal numeroCuentaPadre, ByVal usuarioAplicacion, ByVal usuarioSistema, ByVal mensajeRespuesta)

        Dim strArchivoPostpago As String
        If (TipoLog = "1") Then
            strArchivoPostpago = objFileLog.Log_CrearNombreArchivo(ConfigurationSettings.AppSettings("Log_PagarCambioPlanPostPago"))

            'objFileLog.Log_WriteLog(strArchivoPostpago, " ")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "- " & strArchivoPostpago)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "- " & " ---------------- INICIO CAMBIO PLAN -- " & NroVeces & " -------------- ")
            'objFileLog.Log_WriteLog(strArchivoPostpago, " ---------------- INICIO CAMBIO PLAN -- " & NroVeces & " -------------- ")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "- " & " --- Inicio Envio de parametros  --- ")
            'objFileLog.Log_WriteLog(strArchivoPostpago, " --- Inicio Envio de parametros  --- ")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "idTransaccion        :  " & idTransaccion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "ipAplicacion        :  " & ipAplicacion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "aplicacion        :  " & aplicacion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "coId        :  " & coId)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "customerId        :  " & customerId)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "Cuenta        :  " & Cuenta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "escenario        :  " & escenario)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "TipoProducto        :  " & TipoProducto)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "serviciosAdicionales        :  " & serviciosAdicionales)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "codigoProducto        :  " & codigoProducto)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "codigoPlanBase        :  " & codigoPlanBase)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "montoApadece        :  " & montoApadece)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "montoFidelizar        :  " & montoFidelizar)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "flagValidaApadece        :  " & flagValidaApadece)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "flagAplicaApadece        :  " & flagAplicaApadece)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "TopeConsumo        :  " & TopeConsumo)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "tipoTope        :  " & tipoTope)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "descripcionTipoTpe        :  " & descripcionTipoTpe)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "tipoRegistroTope        :  " & tipoRegistroTope)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "topeControlConsumo        :  " & topeControlConsumo)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "fechaProgramacionTope        :  " & fechaProgramacionTope)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "CAC        :  " & CAC)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "asesor        :  " & asesor)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "codigoInteraccion        :  " & codigoInteraccion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "montoPCS        :  " & montoPCS)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "areaPCS        :  " & areaPCS)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "motivoPCS        :  " & motivoPCS)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "subMotivoPCS        :  " & subMotivoPCS)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "cicloFacturacion        :  " & cicloFacturacion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "idTipoCliente        :  " & idTipoCliente)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "numeroDocumento        :  " & numeroDocumento)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "flagServicioOnTop        :  " & flagServicioOnTop)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "fechaProgramacion        :  " & fechaProgramacion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "flagLimiteCredito        :  " & flagLimiteCredito)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "tipoClarify        :  " & tipoClarify)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "numeroCuentaPadre        :  " & numeroCuentaPadre)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "usuarioAplicacion        :  " & usuarioAplicacion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "usuarioSistema        :  " & usuarioSistema)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "mensajeRespuesta        :  " & mensajeRespuesta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & " --- Fin Envio de parametros  --- ")

        Else
            If (TipoLog = "2") Then
                strArchivoPostpago = objFileLog.Log_CrearNombreArchivo(ConfigurationSettings.AppSettings("Log_PagarCambioPlanPostPago"))
                objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & " --- Inicio parametros respuesta  --- ")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "RespuestaProgramarMigracion        :  " & RespuestaProgramarMigracion)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "Respuesta idTransaccion         :  " & idTransaccion)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "Respuesta mensajeRespuesta        :  " & mensajeRespuesta)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & " --- Fin parametros respuesta  --- ")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "- " & " ---------------- FIN CAMBIO PLAN -- " & NroVeces & " -------------- ")

            Else
                strArchivoPostpago = objFileLog.Log_CrearNombreArchivo(ConfigurationSettings.AppSettings("Log_PagarCambioPlanPostPago"))

                objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & " --- Inicio parametros respuesta ERROR  --- ")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "RespuestaProgramarMigracion        :  " & RespuestaProgramarMigracion)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "Respuesta Try ex         :  " & TryError)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & " --- Fin parametros respuesta ERROR --- ")

                objFileLog.Log_WriteLog(pathFile, strArchivo, strArchivoPostpago & "- " & " ---------------- FIN CAMBIO PLAN -- " & NroVeces & " -------------- ")
            End If
        End If
    End Sub
    Private Sub DeshacerCambiosFlujoDeCaja(ByVal ID_TI_VENTAS_FACT As Int32, ByVal nroPedido As String)
        '***** INICIO : PROCESO DE ROLLBACK AL FLUJO DE CAJA TS-CCC *******'
        Dim objOfflineFC As New COM_SIC_OffLine.clsOffline
        Dim strMensaje As String = String.Empty
        Dim strIdentifyLog As String = CStr(AppUsuario) & " - " & nroPedido
        Dim bResult As Boolean = False
        Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  INI - RollBack Flujo de Caja ")
            bResult = objOfflineFC.DeshacerCambiosFlujoCaja(ID_TI_VENTAS_FACT, strMensaje)

            If bResult Then
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  MENSAJE  :" & strMensaje)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  EL RollBack al ID_TI_VENTAS_FACT :" & ID_TI_VENTAS_FACT.ToString() & " se ejecuto correctamente.")
            Else
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  ERROR MENSAJE  :" & strMensaje)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  EL RollBack al ID_TI_VENTAS_FACT :" & ID_TI_VENTAS_FACT.ToString() & " se ejecuto con errores.")
            End If
        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  ERROR al invoca al metodo:  objOfflineFC.DeshacerCambiosFlujoCaja ")
            'INI PROY-140126
            Dim MaptPath As String
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: DeshacerCambiosFlujoDeaja)"
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  ERROR MENSAJE : " & ex.Message.ToString() & MaptPath)
            'FIN PROY-140126
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  EL RollBack al ID_TI_VENTAS_FACT :" & ID_TI_VENTAS_FACT.ToString() & " se ejecuto con errores.")
        Finally
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  FIN - RollBack Flujo de Caja ")
            objOfflineFC = Nothing
        End Try
        '***** FIN : PROCESO DE ROLLBACK AL FLUJO DE CAJA TS-CCC *******'
    End Sub


    Private Function PagarRegistroCanje(ByVal strNroPedido As String) As Boolean

        Dim objclsConsultaMsSap As New COM_SIC_Activaciones.clsConsultaMsSap
        Dim objTrsConsultaMsSap As New COM_SIC_Activaciones.clsTrsMsSap

        Dim flagPagadoCanje As String = ConfigurationSettings.AppSettings("strFlagPagar")
        Dim estadoPendienteCanje As String = ConfigurationSettings.AppSettings("idPendienteCanje")
        Dim estadoExitoCanje As String = ConfigurationSettings.AppSettings("idExitoCanje")
        Dim escenarioAnuladoCanje As String = ConfigurationSettings.AppSettings("idEscenarioAnu")
        Dim escenarioCanje As String = ConfigurationSettings.AppSettings("idEscenarioCanje")
        Dim strFlagAccion As String = ConfigurationSettings.AppSettings("strAccionPagarSerieCanje")
        Dim blnDocCanje As Boolean
        Dim blnCondicionCanje As Boolean
        Dim dtConsultaCanje As DataTable
        Dim K_CODLOG, K_DESLOG As String
        Dim strIdentifyLog As String = strNroPedido

        Try

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     [INICIO][ConsultaCanje][IN NRO PEDIDO: " & strNroPedido & "]")
            dtConsultaCanje = objclsConsultaMsSap.ConsultaCanje(strNroPedido, K_CODLOG, K_DESLOG)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     [FIN][ConsultaCanje][OUT CODLOG: " & K_CODLOG & "][OUT DESLOG: " & K_DESLOG & "]")

            If Not IsNothing(dtConsultaCanje) AndAlso dtConsultaCanje.Rows.Count > 0 Then

                blnCondicionCanje = (escenarioCanje.IndexOf(Funciones.CheckStr(dtConsultaCanje.Rows(0).Item("CANJV_ESCENARIO"))) > -1)

                If (Funciones.CheckStr(dtConsultaCanje.Rows(0).Item("CANJV_ESTADO")) = estadoPendienteCanje And blnCondicionCanje) Or _
                    (Funciones.CheckStr(dtConsultaCanje.Rows(0).Item("CANJV_ESTADO")) = estadoExitoCanje And _
                    Funciones.CheckStr(dtConsultaCanje.Rows(0).Item("CANJV_ESCENARIO")) = escenarioAnuladoCanje) Then

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         [INICIO][ActualizarEstadoNotaCanje][IN NRO PEDIDO: " & strNroPedido & "][IN FLAG: " & flagPagadoCanje & "]")
                    Dim strActualizaEstado As String = objTrsConsultaMsSap.ActualizarEstadoNotaCanje(strNroPedido, flagPagadoCanje, K_CODLOG, K_DESLOG)
                    If K_CODLOG = "0" And K_DESLOG = "OK" Then
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         Se Realizó Correctamente el cambio de estado del Canje")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "             [INICIO ActualizaEstadoSerieCanje][IN NRO PEDIDO: " & strNroPedido & "][IN FLAG: " & strFlagAccion & "]")
                        Dim strActualizaSerieCanje = objTrsConsultaMsSap.ActualizaEstadoSerieCanje(Funciones.CheckInt64(strNroPedido), strFlagAccion, K_CODLOG, K_DESLOG)
                        If K_CODLOG = "0" And K_DESLOG = "OK" Then
                        blnDocCanje = True
                    End If
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "             [FIN][ActualizaEstadoSerieCanje][OUT CODLOG: " & K_CODLOG & "][OUT DESLOG: " & K_DESLOG & "][OUT strActualizaSerieCanje: " & strActualizaSerieCanje & "]")
                    End If
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         [FIN][ActualizarEstadoNotaCanje][OUT CODLOG: " & K_CODLOG & "][OUT DESLOG: " & K_DESLOG & "][OUT strActualizaEstado: " & strActualizaEstado & "]")
                    'gdelasca Inicio Proy-9067
                    Dim vObClsTrsPvu As New COM_SIC_Activaciones.clsTrsPvu
                    Dim vCursorxIdPedidoActual As Object
                    Dim vCodRpta As String
                    Dim vMsjRpta As String
                    Dim DsCanjeEquipo As DataSet

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INICIO Metodo ConsultaEquipoCanje_XIdPedidoActual()")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp N_NRO_PEDIDO:" & strNroPedido)

                    DsCanjeEquipo = vObClsTrsPvu.ConsultaEquipoCanje_XIdPedidoActual(strNroPedido, vCursorxIdPedidoActual, vCodRpta, vMsjRpta)

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out CU_CONSULTA_CANJE:" & vCursorxIdPedidoActual)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out Valor Cod Rspta:" & vCodRpta)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out Valor Msj Respta:" & vMsjRpta)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FIN Metodo ConsultaEquipoCanje_XIdPedidoActual()")


                    If Not IsNothing(DsCanjeEquipo) AndAlso DsCanjeEquipo.Tables(0).Rows.Count > 0 Then
                        
                        Dim vCanjIdPadre As String
                        vCanjIdPadre = DsCanjeEquipo.Tables(0).Rows(0).Item("CANJI_ID_PADRE").ToString()
                        
                        Dim vEntr_Serie As String
                        Dim vEntr_NroDoc As String
                        Dim vEntr_TipoDoc As String
                        vEntr_Serie = DsCanjeEquipo.Tables(0).Rows(0).Item("CANJV_ENT_SERIE_MAT")
                        vEntr_TipoDoc = DsCanjeEquipo.Tables(0).Rows(0).Item("CANJV_TIPODOCCLIENTE")
                        vEntr_NroDoc = DsCanjeEquipo.Tables(0).Rows(0).Item("CANJV_NRODOCCLIENTE")
                        
                        Dim vCodMaterialSaliente As String
                        Dim vCodSerieSaliente As String
                        vCodMaterialSaliente = DsCanjeEquipo.Tables(0).Rows(0).Item("CANJV_SAL_COD_MAT")
                        vCodSerieSaliente = DsCanjeEquipo.Tables(0).Rows(0).Item("CANJV_SAL_SERIE_MAT")
                        
                        Dim vSerieMat As String
                        Dim vNumDoc As Integer
                        Dim vTipoDoc As String
                        Dim vCursorxSeriTipoNum As Object
                        Dim vNumLog As String
                        Dim vDesLog As String
                        Dim DsSeriTipoNum As DataSet
                        Dim vNumPedidoOriginalBF As String
                        
                        Dim vCursorOriginal As Object
                        Dim vCodRptaOrigen As Integer
                        Dim vMsjRptaOrigen As String
                        Dim DsPedidoOrigenBF As DataSet
                        Dim vDataOrigenBF As String

                        Dim vCodRsptActualiza As String
                        Dim vMsjRsptaActualiza As String
                        Dim ObserPagoCanje As String
                        ObserPagoCanje = ConfigurationSettings.AppSettings("PagoCanje1").ToString() + " " + vCodSerieSaliente + " " + ConfigurationSettings.AppSettings("PagoCanje2").ToString() + " " + vCodMaterialSaliente

                        If vCanjIdPadre <> "" Then 'Tiene Padre

                            Dim vCursorxIdPadre As Object
                            Dim vCodRptaPadre As String
                            Dim vMsjRptaPadre As String
                            Dim DsPadre As DataSet

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INICIO Metodo ConsultaEquipoCanje_xIdPadre()")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp K_CANJI_ID:" & vCanjIdPadre)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp CU_CANJE:" & vCursorxIdPadre)

                            DsPadre = vObClsTrsPvu.ConsultaEquipoCanje_xIdPadre(vCanjIdPadre, vCursorxIdPadre, vCodRptaPadre, vMsjRptaPadre)

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out Valor Cod Rspta:" & vCodRptaPadre)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out Valor Msj Respta:" & vMsjRptaPadre)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FIN Metodo ConsultaEquipoCanje_xIdPadre()")

                            If Not IsNothing(DsPadre) AndAlso DsPadre.Tables(0).Rows.Count > 0 Then
                                vSerieMat = DsPadre.Tables(0).Rows(0).Item("CANJV_ENT_SERIE_MAT")
                                vNumDoc = DsPadre.Tables(0).Rows(0).Item("CANJV_NRODOCCLIENTE")
                                vTipoDoc = DsPadre.Tables(0).Rows(0).Item("CANJV_TIPODOCCLIENTE")

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INICIO Metodo ConsultaEquipoCanje_xSeriTipoNum()")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp K_SERIE:" & vSerieMat)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp K_NRO_DOC:" & vNumDoc)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp K_TIPO_DOC:" & vTipoDoc)

                                DsSeriTipoNum = vObClsTrsPvu.ConsultaEquipoCanje_xSeriTipoNum(vSerieMat, vTipoDoc, vNumDoc, vCursorxSeriTipoNum, vNumLog, vDesLog)

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out CU_PEDIDO:" & vCursorxSeriTipoNum)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out Valor Num Log:" & vNumLog)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out Valor Msj Log:" & vDesLog)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FIN Metodo ConsultaEquipoCanje_xSeriTipoNum()")

                                If Not IsNothing(DsSeriTipoNum) AndAlso DsSeriTipoNum.Tables(0).Rows.Count > 0 Then
                                    vNumPedidoOriginalBF = DsSeriTipoNum.Tables(0).Rows(0).Item("PEDIN_NROPEDIDO")

                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INICIO Metodo ConsultaEstRenoAnticipada()")
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp N_NRO_PEDIDO:" & vNumPedidoOriginalBF)

                                    DsPedidoOrigenBF = vObClsTrsPvu.ConsultaEstRenoAnticipada(vNumPedidoOriginalBF, vCursorOriginal, vCodRptaOrigen, vMsjRptaOrigen)

                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out P_CUR_SALIDA:" & vCursorOriginal)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out Valor Cod Rspt:" & vCodRptaOrigen)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out Valor Msj Rspt:" & vMsjRptaOrigen)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FIN Metodo ConsultaEstRenoAnticipada()")

                                    If Not IsNothing(DsPedidoOrigenBF) AndAlso DsPedidoOrigenBF.Tables(0).Rows.Count > 0 Then
                                        vDataOrigenBF = DsPedidoOrigenBF.Tables(0).Rows(0).Item("SARN_NRO_PEDIDO")

                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INICIO Metodo ActualizarRenoAnticipada()")
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp N_NRO_PEDIDO:" & vDataOrigenBF)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp V_ESTADO:" & "")
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp V_COD_EQUIPO:" & vCodSerieSaliente)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp V_COD_MATERIAL:" & vCodMaterialSaliente)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp V_USU_ACTUALIZACION:" & CurrentUser)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp CL_OBSERVACIONES:" & ObserPagoCanje)

                                        vObClsTrsPvu.ActualizarRenoAnticipadaCanje(vDataOrigenBF, "", vCodSerieSaliente, vCodMaterialSaliente, CurrentUser, ObserPagoCanje, vCodRsptActualiza, vMsjRsptaActualiza)

                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out Valor Cod Rspt:" & vCodRsptActualiza)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out Valor Msj Rspt:" & vMsjRsptaActualiza)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FIN Metodo ActualizarRenoAnticipada()")

                                    End If 
                                End If 
                            End If 

                        ElseIf vCanjIdPadre = "" Then ''No tiene Padre

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INICIO Metodo ConsultaEquipoCanje_xSeriTipoNum()")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp K_SERIE:" & vEntr_Serie)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp K_TIPO_DOC:" & vEntr_TipoDoc)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp K_NRO_DOC:" & vEntr_NroDoc)

                            DsSeriTipoNum = vObClsTrsPvu.ConsultaEquipoCanje_xSeriTipoNum(vEntr_Serie, vEntr_TipoDoc, vEntr_NroDoc, vCursorxSeriTipoNum, vNumLog, vDesLog)

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out CU_PEDIDO:" & vCursorxSeriTipoNum)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out Valor Num Log:" & vNumLog)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out Valor Msj Log:" & vDesLog)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FIN Metodo ConsultaEquipoCanje_xSeriTipoNum()")

                            If Not IsNothing(DsSeriTipoNum) AndAlso DsSeriTipoNum.Tables(0).Rows.Count > 0 Then

                                vNumPedidoOriginalBF = DsSeriTipoNum.Tables(0).Rows(0).Item("PEDIN_NROPEDIDO")

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INICIO Metodo ConsultaEstRenoAnticipada()")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp N_NRO_PEDIDO:" & vNumPedidoOriginalBF)

                                DsPedidoOrigenBF = vObClsTrsPvu.ConsultaEstRenoAnticipada(vNumPedidoOriginalBF, vCursorOriginal, vCodRptaOrigen, vMsjRptaOrigen)

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out P_CUR_SALIDA:" & vCursorOriginal)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out Valor Cod Rspt:" & vCodRptaOrigen)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out Valor Msj Rspt:" & vMsjRptaOrigen)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FIN Metodo ConsultaEstRenoAnticipada()")

                                If Not IsNothing(DsPedidoOrigenBF) AndAlso DsPedidoOrigenBF.Tables(0).Rows.Count > 0 Then
                                    vDataOrigenBF = DsPedidoOrigenBF.Tables(0).Rows(0).Item("SARN_NRO_PEDIDO")

                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INICIO Metodo ActualizarRenoAnticipada()")
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp N_NRO_PEDIDO:" & vDataOrigenBF)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp V_ESTADO:" & "")
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp V_COD_EQUIPO:" & vCodSerieSaliente)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp V_COD_MATERIAL:" & vCodMaterialSaliente)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp V_USU_ACTUALIZACION:" & CurrentUser)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp CL_OBSERVACIONES:" & ObserPagoCanje)

                                    vObClsTrsPvu.ActualizarRenoAnticipadaCanje(vDataOrigenBF, "", vCodSerieSaliente, vCodMaterialSaliente, CurrentUser, ObserPagoCanje, vCodRsptActualiza, vMsjRsptaActualiza)

                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out Valor Cod Rspt:" & vCodRsptActualiza)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out Valor Msj Rspt:" & vMsjRsptaActualiza)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FIN Metodo ActualizarRenoAnticipada()")

                                End If 
                            End If 
                        Else
                        End If 

                    End If 
                    'gdelasca FIN Proy-9067
                Else
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     [No se encontró registro del Canje en SAP]")
                    AppmsgDevolucion = ConfigurationSettings.AppSettings("msgNoExisteCanjeSAP")
                    blnDocCanje = False
                    'Response.Redirect("poolPagos.aspx", False)
                    'Exit Function
                End If
            Else
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     [No se encontró registro del Canje]")
                AppmsgDevolucion = ConfigurationSettings.AppSettings("msgNoExisteCanjeBD")
                blnDocCanje = False
                'Response.Redirect("poolPagos.aspx", False)
                'Exit Function
            End If

        Catch ex As Exception
            blnDocCanje = False
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     [Error - PagarRegistroCanje]" & ex.Message.ToString())
        End Try

        Return blnDocCanje

    End Function

    Public Function RegistrarCobertura(ByVal strIdentificador As String, ByVal int64IdVenta As Int64, ByVal strTelefonoNumero As String, ByVal strDocumentoIdentidadNumero As String)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "==============================")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "== GuardarCobertura :: INI  ==")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "==============================")

        Try
            Dim strUsuarioSistema As String = String.Empty
            Dim strDepartamento As String = String.Empty
            Dim strProvincia As String = String.Empty
            Dim strDistrito As String = String.Empty
            Dim strCentroPoblado As String = String.Empty
            Dim strUbigeoCodigo As String = String.Empty
            Dim strCobertura As String = String.Empty
            Dim strResultadoSP_ObtenerDatosCobertura As String = String.Empty
            Dim strResultadoWS_ObtenerTipoCobertura As String = String.Empty
            Dim strResultadoWS_GuardarCobertura As String = String.Empty

            strUsuarioSistema = Funciones.CheckStr(CurrentUser)

            Dim lstDatosCobertura As New ArrayList
            Dim arrTelefoNumero As Array = strTelefonoNumero.Split("|")

            lstDatosCobertura = (New clsConsultaPvu).ObtenerDatosCobertura(int64IdVenta, strResultadoSP_ObtenerDatosCobertura)

            If lstDatosCobertura.Count > 0 Then
                For i As Integer = 0 To (lstDatosCobertura.Count - 1)
                    strTelefonoNumero = Funciones.CheckStr(arrTelefoNumero(i))
                    strDepartamento = Funciones.CheckStr(lstDatosCobertura(i).strDVPR_DEPAC_DESC)
                    strProvincia = Funciones.CheckStr(lstDatosCobertura(i).strDVPR_PROVV_DESC)
                    strDistrito = Funciones.CheckStr(lstDatosCobertura(i).strDVPR_DISTV_DESC)
                    strCentroPoblado = Funciones.CheckStr(lstDatosCobertura(i).strDVPR_CPF_DESC)
                    strUbigeoCodigo = Funciones.CheckStr(lstDatosCobertura(i).strDVPR_UBIGEO_INEI)

                    strResultadoWS_ObtenerTipoCobertura = (New BWCobertura).ObtenerCobertura(strUbigeoCodigo, strCentroPoblado, strCobertura)

                    If strUsuarioSistema.Trim.Length > 0 And strDepartamento.Trim.Length > 0 And strProvincia.Trim.Length > 0 And strDistrito.Trim.Length > 0 And strCentroPoblado.Trim.Length > 0 And strCobertura.Trim.Length > 0 Then
                        strResultadoWS_GuardarCobertura = (New BWNoBiometria).GuardarCobertura(strUsuarioSistema, strTelefonoNumero, strDepartamento, strProvincia, strDistrito, strCentroPoblado, strCobertura, strDocumentoIdentidadNumero)

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "[Parametros]")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- Usuario: " & Funciones.CheckStr(strUsuarioSistema))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- Telefono: " & Funciones.CheckStr(strTelefonoNumero))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- Departamento: " & Funciones.CheckStr(strDepartamento))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- Provincia: " & Funciones.CheckStr(strProvincia))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- Distrito: " & Funciones.CheckStr(strDistrito))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- CentroPoblado: " & Funciones.CheckStr(strCentroPoblado))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- Cobertura: " & Funciones.CheckStr(strCobertura))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "[Metodo]")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "guardarCobertura()")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- WS: " & Funciones.CheckStr(ConfigurationSettings.AppSettings("constUrlNoBio")))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- TimeOut: " & Funciones.CheckStr(ConfigurationSettings.AppSettings("TimeOutNoBio")))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "[Resultado]")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- Codigo: " & Funciones.CheckStr(strResultadoWS_GuardarCobertura.Split(";")(0)))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- Mensaje: " & Funciones.CheckStr(strResultadoWS_GuardarCobertura.Split(";")(1)))
                    Else
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "[Condiciones]")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- Usuario: " & Funciones.CheckStr(strUsuarioSistema))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- Telefono: " & Funciones.CheckStr(strTelefonoNumero))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- Departamento: " & Funciones.CheckStr(strDepartamento))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- Provincia: " & Funciones.CheckStr(strProvincia))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- Distrito: " & Funciones.CheckStr(strDistrito))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- CentroPoblado: " & Funciones.CheckStr(strCentroPoblado))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- Cobertura: " & Funciones.CheckStr(strCobertura))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "[Error]")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "No se cumplieron las condiciones para ejecutar método WS.")
                    End If
                Next
            Else
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "[Parametros]")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- UbigeoCodigo: " & Funciones.CheckStr(strUbigeoCodigo))
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- CentroPoblado: " & Funciones.CheckStr(strCentroPoblado))
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "[Metodo]")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "ObtenerCobertura()")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- SP: SISACT_PKG_VENTA_PREPAGO2_S6.SISACTSS_COBERTURA_VENTA")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "[Resultado]")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- Codigo: " & Funciones.CheckStr(strResultadoSP_ObtenerDatosCobertura.Split(";")(0)))
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- Mensaje: " & Funciones.CheckStr(strResultadoSP_ObtenerDatosCobertura.Split(";")(1)))
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- Estado: " & Funciones.CheckStr(strResultadoSP_ObtenerDatosCobertura.Split(";")(2)))
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- Cobertura: " & Funciones.CheckStr(strResultadoSP_ObtenerDatosCobertura.Split(";")(3)))
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "[Error]")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "No se pudieron obtener los datos de cobertura asociados a la venta.")
            End If
        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "[Error]")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & Funciones.CheckStr(ex.Message))
        Finally
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "==============================")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "== GuardarCobertura :: FIN  ==")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "==============================")
        End Try
    End Function

    Public Function RegistrarAceptacionContrato(ByVal strIdentificador As String, ByVal strTelefonoNumero As String, ByVal strRegistroDOLRespuesta As String)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "==============================")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "== ContratoAceptado :: INI  ==")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "==============================")

        Try
            Dim arrTelefoNumero As Array = strTelefonoNumero.Split("|")
            Dim arrRegistroDOLRespuesta As Array = strRegistroDOLRespuesta.Split("|")
            Dim blnRegistroDOLRespuesta As Boolean = False
            Dim strResultadoWS_ContratoAceptado As String = String.Empty

            For i As Integer = 0 To (arrTelefoNumero.Length - 2)
                blnRegistroDOLRespuesta = (arrRegistroDOLRespuesta(i).Equals("1"))
                strTelefonoNumero = arrTelefoNumero(i)

                If blnRegistroDOLRespuesta And strTelefonoNumero.Trim().Length > 0 Then
                    strResultadoWS_ContratoAceptado = (New BWContrato).ContratoAceptado(strTelefonoNumero)

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "[Parametros]")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- IdTransaccion: " & Funciones.CheckStr(strResultadoWS_ContratoAceptado.Split(";")(2)))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- Aplicacion: " & Funciones.CheckStr(ConfigurationSettings.AppSettings("constAplicacion")))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- UsrApp: " & Funciones.CheckStr(ConfigurationSettings.AppSettings("Usuario_Aplicacion")))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- Msisdn: " & Funciones.CheckStr(arrTelefoNumero(i)))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- EstadoContrato: " & Funciones.CheckStr(ConfigurationSettings.AppSettings("AceptarContratoEstado")))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- RespuestaConfirmacion: " & Funciones.CheckStr(ConfigurationSettings.AppSettings("AceptarContratoRespuesta")))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "[Metodo]")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "procesarDOL()")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- WS: " & Funciones.CheckStr(ConfigurationSettings.AppSettings("constUrlProcesaDOL")))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- TimeOut: " & Funciones.CheckStr(ConfigurationSettings.AppSettings("TimeOutProcesaDOL")))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "[Resultado]")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- codigo: " & Funciones.CheckStr(strResultadoWS_ContratoAceptado.Split(";")(0)))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- Mensaje: " & Funciones.CheckStr(strResultadoWS_ContratoAceptado.Split(";")(1)))
                Else
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "[Condiciones]")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- Pago: true")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- Dol: false")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "- Telefono: " & Funciones.CheckStr(strTelefonoNumero))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "[Error]")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "No se cumplieron las condiciones para ejecutar método WS.")
                End If
            Next
        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "[Error]")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & Funciones.CheckStr(ex.Message))
        Finally
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "==============================")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "== ContratoAceptado :: FIN  ==")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentificador & "- " & "==============================")
        End Try
    End Function
    Private Sub AnulaPagoSICAR(ByVal strNroPedido As String, ByVal strTipoDoc As String, _
                               ByVal strSerie As String, ByVal strCorrelativo As String)
        Dim strIdentifyLog As String = strNroPedido
        Dim strCodRpta As String = String.Empty
        Dim strMsgRpta As String = String.Empty
        Dim objClsCajas As New COM_SIC_Cajas.clsCajas

        Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " ------------------------------------")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "       INICIO ANULAR PAGO SICAR")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " ------------------------------------")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "    [INICIO][ANULAR PAGO SICAR][IN NRO PEDIDO: " & strNroPedido & "]")
            objClsCajas.AnulaPagoSICAR(strNroPedido, strTipoDoc, strSerie, strCorrelativo, strCodRpta, strMsgRpta)
            'INI PROY-140126
            Dim MaptPath As String
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: AnulaPagoSICAR)"
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "    [FIN][ANULAR PAGO SICAR][OUT COD RPTA: " & strCodRpta & "][OUT MSG RPTA: " & strMsgRpta & "]" & MaptPath)
            'FIN PROY-140126

        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - ERROR: " & ex.Message.ToString())
        Finally
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " ------------------------------------")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "       FIN ANULAR PAGO SICAR")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " ------------------------------------")
        End Try
    End Sub

    'Inicio SD854808 Relanzamiento Cambio de Plan JAZ
    Public Function RegistrarRelanzamientoCambioPlan(ByVal sPedidoSap As String, ByVal sDescError As String, ByRef sCodRespuesta As Int16, ByRef sMsgRespuesta As String) As Boolean
        objFileLog.Log_WriteLog(pathFile, strArchivo, sPedidoSap & " - " & "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~")
        objFileLog.Log_WriteLog(pathFile, strArchivo, sPedidoSap & " - " & "Inicio Registro Relanzamiento Cambio Plan")
        Dim bSalida As Boolean = False
        Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, sPedidoSap & " - " & "IN sPedidoSap -> " & sPedidoSap)
            objFileLog.Log_WriteLog(pathFile, strArchivo, sPedidoSap & " - " & "IN sDescError -> " & sDescError)            

            Dim objClsCajas As New COM_SIC_Cajas.clsCajas
            Dim oRenoVenta As New COM_SIC_Cajas.VentaRenovaPost
            oRenoVenta = objClsCajas.ConsultarVentaRenovPostCAC(sPedidoSap)
            objFileLog.Log_WriteLog(pathFile, strArchivo, sPedidoSap & " - " & "Consulto venta renovacion")
            Dim sFechaEjecucion As String = ObtenerFechaEjecucionTope(oRenoVenta.CICLO_FACT)
            Dim sUsuarioCreacion As String = ConfigurationSettings.AppSettings("Usuario_Aplicacion")

            objFileLog.Log_WriteLog(pathFile, strArchivo, sPedidoSap & " - " & "IN telefono -> " & oRenoVenta.TELEFONO)
            objFileLog.Log_WriteLog(pathFile, strArchivo, sPedidoSap & " - " & "IN numero_contrato -> " & oRenoVenta.NUMERO_CONTRATO)
            objFileLog.Log_WriteLog(pathFile, strArchivo, sPedidoSap & " - " & "IN doc_clien_numero -> " & oRenoVenta.DOC_CLIEN_NUMERO)
            objFileLog.Log_WriteLog(pathFile, strArchivo, sPedidoSap & " - " & "IN titular -> " & oRenoVenta.TITULAR)
            objFileLog.Log_WriteLog(pathFile, strArchivo, sPedidoSap & " - " & "IN ciclo_fact -> " & oRenoVenta.CICLO_FACT)
            objFileLog.Log_WriteLog(pathFile, strArchivo, sPedidoSap & " - " & "IN canal -> " & oRenoVenta.CANAL)
            objFileLog.Log_WriteLog(pathFile, strArchivo, sPedidoSap & " - " & "IN sUsuarioCreacion -> " & sUsuarioCreacion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, sPedidoSap & " - " & "IN sFechaEjecucion -> " & sFechaEjecucion)

            bSalida = objClsCajas.RegistrarRelanzamientoCambioPlan(oRenoVenta.TELEFONO, sPedidoSap, oRenoVenta.NUMERO_CONTRATO, oRenoVenta.DOC_CLIEN_NUMERO, oRenoVenta.TITULAR, sFechaEjecucion, sDescError, oRenoVenta.CICLO_FACT, oRenoVenta.CANAL, sUsuarioCreacion, sCodRespuesta, sMsgRespuesta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, sPedidoSap & " - " & "OUT salida -> " & bSalida)
            objFileLog.Log_WriteLog(pathFile, strArchivo, sPedidoSap & " - " & "OUT sCodRespuesta -> " & Funciones.CheckInt(sCodRespuesta))
            objFileLog.Log_WriteLog(pathFile, strArchivo, sPedidoSap & " - " & "OUT sMsgRespuesta -> " & Funciones.CheckStr(sMsgRespuesta))
            objFileLog.Log_WriteLog(pathFile, strArchivo, sPedidoSap & " - " & "Fin Registro Relanzamiento Cambio Plan")
            objFileLog.Log_WriteLog(pathFile, strArchivo, sPedidoSap & " - " & "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~")

        Catch ex As Exception
            bSalida = False
            objFileLog.Log_WriteLog(pathFile, strArchivo, sPedidoSap & " - " & "ERROR RegistrarRelanzamientoCambioPlan:" & ex.Message)
            objFileLog.Log_WriteLog(pathFile, strArchivo, sPedidoSap & " - " & "Fin Registro Relanzamiento Cambio Plan")
            objFileLog.Log_WriteLog(pathFile, strArchivo, sPedidoSap & " - " & "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~")
        End Try

        Return bSalida
    End Function


    Public Function ObtenerFechaEjecucionTope(ByVal sCicloFac As String) As String

        Dim sFechaConsulta As String = ConfigurationSettings.AppSettings("CONS_FECHA_CONSULTA")
        Dim sFechaAct As String = "" : Dim sFechaMig As String = ""

        Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, " - " & "sCicloFacturacion : " & sCicloFac)

            If CInt(sCicloFac) - CInt(ConfigurationSettings.AppSettings("CONS_FECHA_CONSULTA").ToString()) > CInt(Format(Date.Now, "dd")) Then
                sFechaAct = sCicloFac & "/" & Format(Date.Now, "MM/yyyy")
            Else
                sFechaAct = sCicloFac & "/" & Format(DateAdd(DateInterval.Month, 1, Date.Now), "MM/yyyy")
            End If
            Try
                sFechaMig = Format(DateAdd(DateInterval.Day, -CInt(ConfigurationSettings.AppSettings("CONS_FECHA_CONSULTA").ToString()), Funciones.CheckDate(sFechaAct)), "dd/MM/yyyy")
            Catch ex1 As Exception
                sFechaMig = Format(Date.Now, "MM/yyyy")
                objFileLog.Log_WriteLog(pathFile, strArchivo, "- " & "Error fechaFact:" & ex1.Message)
            End Try


        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, "- " & "Error ObtenerFechaEjecucionTope:" & ex.Message)
            Return ""
        End Try

        Return sFechaMig

    End Function
    'Fin SD854808 Relanzamiento Cambio de Plan JAZ
'PROY-24724-IDEA-28174 - INI
    Private Sub ProcesarPagoProteccionMovil(ByVal strNroPedido As String, ByVal strNroPedidoEquipo As String, ByVal strNroTelefono As String)

        Dim objProteccionMovil As New COM_SIC_Activaciones.clsProteccionMovil
        Dim objWSProteccionMovil As New COM_SIC_Activaciones.BWGestionaProteccionMovil
        Dim strIdentifyLog As String = Funciones.CheckStr(AppUsuario) & " - " & strNroPedido
        Dim dsProteccionMovil As DataSet
        Dim strNroSEC As String
        Dim strNroCertificado As String
        Dim strEstadoRespuesta As String = clsKeyAPP.strEstadoRespuesta 
        Dim strCodRpta As String
        Dim strMsgRpta As String
        Dim strIdCanje As String = String.Empty
        Dim strSplnCodigo As String
        Dim strEstadoError As String = clsKeyAPP.strEstadoError 
        Dim blnErrorPagoSeguro As Boolean = False
        Dim blRegistroPagoExito As Boolean = False ''PROY-24724 - Iteracion 2 Siniestros 

        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     Obtener SEC EQUIPO - INICIO ==")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         IN NRO PEDIDO EQUIPO: " & strNroPedidoEquipo)
        strNroSEC = ConsultarSecEquipo(strNroPedidoEquipo)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     Obtener SEC EQUIPO - FIN ==")

        If Not strNroSEC.Equals("") Then

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     ConsultarDatosPM - INICIO ==")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         SP: PKG_TRANS_ASURION.SISACTSS_CONSULTAR_SEGURO")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         IN NRO PEDIDO EQUIPO: " & strNroPedidoEquipo)

            dsProteccionMovil = objProteccionMovil.ConsultarProteccionMovil(strNroPedidoEquipo, strCodRpta, strMsgRpta)

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         OUT COD RPTA: " & strCodRpta)
            'INI PROY-140126
            Dim MaptPath As String
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: ProcesaragoProteccionMovil)"
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         OUT MSG RPTA: " & strMsgRpta & MaptPath)
            'FIN PROY-140126

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     ConsultarDatosPM - FIN    ==")

            If strCodRpta = "0" AndAlso Not dsProteccionMovil Is Nothing AndAlso dsProteccionMovil.Tables.Count > 0 AndAlso dsProteccionMovil.Tables(0).Rows.Count > 0 Then

                Dim dtCanje As DataTable = Nothing
                Dim strFlagVentaIndividual As String = String.Empty
                strFlagVentaIndividual = Funciones.CheckStr(dsProteccionMovil.Tables(0).Rows(0).Item("EVALV_RESULTADO_RPTA"))

                For Each i As DataRow In dsProteccionMovil.Tables(0).Rows
                    strNroCertificado = Funciones.CheckStr(i.Item("EVALV_NRO_CERTF_RPTA"))
                    strSplnCodigo = Funciones.CheckStr(i.Item("EVALN_SOPLN_CODIGO"))
                    strNroTelefono = Funciones.CheckStr(i.Item("TELEFONO"))

                    If Not strNroTelefono.Equals("") Then
                        Try
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     ProcesarProteccionMovil - INICIO ==")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     WS: " & ConfigurationSettings.AppSettings("consGestionaProteccionMovilWS_URL"))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     Método: procesarPagoPM ")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         IN Nro SEC: " & strNroSEC)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         IN Nro Telefono: " & strNroTelefono)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         IN Nro de Certificado: " & strNroCertificado)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         IN Estado Respuesta: " & strEstadoRespuesta)

                            objWSProteccionMovil.ProcesarProteccionMovil(strNroSEC, strNroTelefono, strNroCertificado, strEstadoRespuesta, _
                                                                         CurrentUser, CurrentTerminal, strCodRpta, strMsgRpta)

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         OUT Codigo Rpta: " & strCodRpta)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         OUT Mensaje Rpta: " & strMsgRpta)

                            If strCodRpta <> "0" Then
                                blnErrorPagoSeguro = True
                            Else ''PROY-24724 - Iteracion 2 Siniestros - INI
                                blRegistroPagoExito = True
                            End If ''PROY-24724 - Iteracion 2 Siniestros - FIN

                        Catch ex As Exception
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "== ERROR - Procesar Protección Móvil: ")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & ConfigurationSettings.AppSettings("consGestionaProteccionMovilWS_Error"))
                            'INI PROY-140126
                            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                            MaptPath = "( Class : " & MaptPath & "; Function: ProcesarPagoProteccionMovil)"
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "== Mensaje Exception: " & ex.Message.ToString() & MaptPath)
                            'FIN PROY-140126 

                            blnErrorPagoSeguro = True
                        Finally
                            If blnErrorPagoSeguro Then
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         RegistrarContingencia - INICIO")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==           IN NRO PEDIDO: " & strNroPedido)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==           IN NRO SEC: " & strNroSEC)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==           IN NRO TELEFONO: " & strNroTelefono)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==           IN NRO CERTIFICADO: " & strNroCertificado)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==           IN ID DE CANJE: " & strIdCanje)
                                blRegistroPagoExito = RegistrarContigenciaProteccionMovil(strNroPedido, strNroSEC, strNroTelefono, strNroCertificado, strIdCanje, strEstadoError) ''PROY-24724 - Iteracion 2 Siniestros
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         RegistrarContingencia - FIN")
                            End If
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "== Procesar Protección Móvil - FIN ==")
                        End Try
                    Else
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "== No se encontro el Telefono ==")
                    End If
                Next
                If strFlagVentaIndividual.Equals("V") Then
                    Dim lst As ArrayList ''PROY-24724 - Iteracion 2 Siniestros
                    If blRegistroPagoExito Then ''PROY-24724 - Iteracion 2 Siniestros
                        TipificarProteccionMovil(strNroPedido, strNroSEC, strNroTelefono, strFlagVentaIndividual, dsProteccionMovil, dtCanje, lst, "")
                    End If ''PROY-24724 - Iteracion 2 Siniestros

                End If
            Else
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "== NO SE ENCONTRARON DATOS DE PROTECCÓN MÓVIL ==")
            End If
        Else
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "== No se encontro el numero de SEC ==")
        End If
    End Sub

    Private Function RegistrarContigenciaProteccionMovil(ByVal strNroPedido As String, ByVal strNroSEC As String, ByVal strNroTelefono As String, _
                                                        ByVal strNroCertificado As String, ByVal strIdCanje As String, ByVal strEstadoError As String) As Boolean
        'Objetos
        Dim objProteccionMovil As New COM_SIC_Activaciones.clsProteccionMovil
        Dim objEnvioCorreoWS As New COM_SIC_Activaciones.BWEnvioCorreo
        Dim strIdentifyLog As String = Funciones.CheckStr(AppUsuario) & " - " & strNroPedido
        'Variables de Envio de Correo
        Dim strRemitente As String = clsKeyAPP.strRemitentePM 
        Dim strDestinatario As String = clsKeyAPP.strDestinatarioPM 
        Dim arrMensajeProtMovil(9) As String
        Dim arrAsunto(0) As String
        Dim strAsunto As String = clsKeyAPP.strAsuntoPM
        Dim strMensaje As String = clsKeyAPP.strMensajePagoPM ''PROY-24724 - Iteracion 2 Siniestross
        arrAsunto(0) = "Pago"
        strAsunto = String.Format(strAsunto, arrAsunto)
        If Not IsNothing(strIdCanje) AndAlso strIdCanje <> "" Then
            arrMensajeProtMovil(0) = "Ocurrió un Error tratando de ejecutar el pago del Canje del Registro de Proteccion Movil <br>"  
        Else
            arrMensajeProtMovil(0) = "Ocurrió un Error tratando de ejecutar el pago del Registro de Proteccion Movil ; Validar que no exista el registro, de no existir realizar el pago ejecutando: " 

        End If
        Dim strFlag As String = clsKeyAPP.strFlagCorreoPM
        Dim strUsuarioAplicacion = ConfigurationSettings.AppSettings("Usuario_Aplicacion")
        Dim strCodRespuesta As String = String.Empty
        Dim strMsgRespuesta As String = String.Empty
        'Variables de control
        Dim strCodRpta As Integer
        Dim strMsgRpta As String
        Dim blnErrorProcesarPago As Boolean = False
        Dim blnRegistroContingencia As Boolean = False
       

        Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         ProcesarPagoPM - INICIO")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==             SP: PKG_TRANS_ASURION.SISACTSI_ALTA_ASURION")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==             IN Nro SEC: " & strNroSEC)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==             IN Nro Telefono: " & strNroTelefono)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==             IN Nro Certificado: " & strNroCertificado)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==             IN Usuario: " & strUsuarioAplicacion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==             IN IP: " & CurrentTerminal)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==             IN Estado Error: " & strEstadoError)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==             IN ID Canje: " & strIdCanje)

            objProteccionMovil.ProcesarPagoProteccionMovil(strNroSEC, strNroTelefono, strNroCertificado, strUsuarioAplicacion, _
                                                           CurrentTerminal, strEstadoError, strIdCanje, strCodRpta, strMsgRpta)

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==             OUT Codigo Rpta: " & Funciones.CheckStr(strCodRpta))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==             OUT Mensaje Rpta: " & strMsgRpta)

            If Not strCodRpta.Equals("0") Then
                blnErrorProcesarPago = True
            Else
                blnRegistroContingencia = True
            End If

        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==             ERROR - ProcesarPagoPM: " & ex.Message.ToString())
            blnErrorProcesarPago = True
        Finally
            If blnErrorProcesarPago Then
                Try
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         EnvioCorreoWS - INICIO")
                    arrMensajeProtMovil(1) = "<br><p><b>- Paquete: PKG_TRANS_ASURION </b>"
                    arrMensajeProtMovil(2) = "<br><b>- SP: SISACTSI_ALTA_ASURION </b>"
                    arrMensajeProtMovil(3) = "<br><b>- Parametros: </b>"
                    arrMensajeProtMovil(4) = "<br>     1. Número de SEC: " & Funciones.CheckStr(strNroSEC)
                    arrMensajeProtMovil(5) = "<br>     2. Número de Teléfono: " & Funciones.CheckStr(strNroTelefono)
                    arrMensajeProtMovil(6) = "<br>     3. Número de Certificado: " & Funciones.CheckStr(strNroCertificado)
                    arrMensajeProtMovil(7) = "<br>     4. Usuario: " & Funciones.CheckStr(strUsuarioAplicacion)
                    arrMensajeProtMovil(8) = "<br>     5. IP: " & Funciones.CheckStr(CurrentTerminal)
                    arrMensajeProtMovil(9) = "<br>     6. Estado del Servicio: " & Funciones.CheckStr(strEstadoError) & "</p>"
                    strMensaje = String.Format(strMensaje, arrMensajeProtMovil)

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==             IN Remitente: " & strRemitente)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==             IN Destinatario: " & strDestinatario)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==             IN Asunto: " & strAsunto)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==             IN Mensaje: " & strMensaje)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==             IN Flag: " & strFlag)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==             IN IP: " & CurrentTerminal)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==             IN Usuario: " & CurrentUser)

                    objEnvioCorreoWS.EnviarCorreoPM(strRemitente, strDestinatario, strAsunto, strMensaje, strFlag, _
                                                            CurrentTerminal, CurrentUser, strCodRespuesta, strMsgRespuesta)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==             OUT Cod Respuesta: " & strCodRespuesta)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==             OUT Mgs Respuesta: " & strMsgRespuesta)
                Catch e As Exception
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         ERROR - EnvioCorreoWS: " & e.Message.ToString())
                End Try
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         EnvioCorreoWS - FIN")
            End If
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         ProcesarPagoPM - FIN")
        End Try

        Return blnRegistroContingencia

    End Function

    Public Function ConsultarSecEquipo(ByVal strNroPedido As String) As String

        Dim objClsConsultaPvu As New COM_SIC_Activaciones.clsConsultaPvu
        Dim strIdentifyLog As String = Funciones.CheckStr(AppUsuario) & " - " & strNroPedido
        Dim dsContrato As DataSet
        Dim dsAcuerdo As DataSet
        Dim strNroContrato As String
        Dim strNroSEC As String = ""
        Dim strCodRptaSEC, strMsgRptaSEC As String

        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         [INICIO][Consulta Contraro][IN Pedido: " & strNroPedido & "]")
        dsContrato = objClsConsultaPvu.ObtenerDrsap(strNroPedido, strCodRptaSEC, strMsgRptaSEC)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         [FIN][Consulta Contraro][OUT COD: " & strCodRptaSEC & "][OUT MSG: " & strMsgRptaSEC & "]")

        If Not dsContrato Is Nothing AndAlso dsContrato.Tables.Count > 0 AndAlso dsContrato.Tables(0).Rows.Count > 0 Then

            strNroContrato = Funciones.CheckStr2(dsContrato.Tables(0).Rows(0).Item("ID_CONTRATO"))

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         [INICIO][Consulta Acuerdo][IN Contrato: " & strNroContrato & "]")
            dsAcuerdo = objClsConsultaPvu.ConsultaAcuerdoPCS(Funciones.CheckInt64(strNroContrato), DBNull.Value)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         [FIN][Consulta Acuerdo]")

            If Not dsAcuerdo Is Nothing AndAlso dsAcuerdo.Tables.Count > 0 AndAlso dsAcuerdo.Tables(0).Rows.Count > 0 Then
                strNroSEC = Funciones.CheckStr(dsAcuerdo.Tables(0).Rows(0).Item("contn_numero_sec"))
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         [SEC: " & strNroSEC & "]")
            End If
        End If

        Return strNroSEC
    End Function

    Private Sub ValidarCanjeConProteccionMovil(ByVal strNroPedidoPM As Int64, ByRef strNroPedidoEquipo As Int64, ByRef strNroSEC As String, ByRef dsMostrarPM As DataSet, _
                                               ByRef dtCanjeEquipo As DataTable, ByRef blnEsProteccionMovil As Boolean)

        Dim objProteccionMovil As New COM_SIC_Activaciones.clsProteccionMovil
        Dim strIdentifyLog As String = Funciones.CheckStr(AppUsuario) & " - " & strNroPedidoPM
        blnEsProteccionMovil = False
        Dim strCodRpta As String = String.Empty
        Dim strMsgRpta As String = String.Empty
        dtCanjeEquipo = Nothing
        Dim strSerieEquipoOrigen As String
        Try
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==   ConsultarPedidoOrigen - INICIO ==")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==   PKG_CONSULTA.SSAPSS_CONSULTAPEDIDOORIGEN")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     IN  NRO DOC: " & strNroPedidoPM)

        dtCanjeEquipo = objProteccionMovil.ConsultarPedidoOrigen(strNroPedidoPM, strNroPedidoEquipo, strCodRpta, strMsgRpta)

        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     OUT NRO. PED. EQ. ORIGEN:" & strNroPedidoEquipo)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     OUT COD RPTA: " & strCodRpta)
            'INI PROY-140126
            Dim MaptPath As String
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: ValidarCanjeConProteccionMovil)"
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     OUT MSJ RPTA: " & strMsgRpta & MaptPath)
            'FIN PROY-140126 

        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==   ConsultarPedidoOrigen - FIN  ==")

        If Not dtCanjeEquipo Is Nothing AndAlso strCodRpta = "0" AndAlso dtCanjeEquipo.Rows.Count > 0 Then

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     ConsultarSecEquipo - INICIO ==")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         IN NRO PEDIDO EQUIPO: " & strNroPedidoEquipo)

            strNroSEC = ConsultarSecEquipo(strNroPedidoEquipo)

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         OUT: " & strNroSEC)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     ConsultarSecEquipo - FIN ==")

            If Not strNroSEC.Equals("") Then

                strSerieEquipoOrigen = Funciones.CheckStr(dtCanjeEquipo.Rows(0).Item("CANJV_ENT_SERIE_MAT"))

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==   MostrarDatosProteccionMovil - INICIO ==")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==   PKG_TRANS_ASURION.")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     IN  NRO SEC: " & strNroSEC)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     IN  NRO Serie Equi. Origen: " & strSerieEquipoOrigen)

                dsMostrarPM = objProteccionMovil.MostrarDatosProteccionMovil(strNroSEC, strSerieEquipoOrigen, strCodRpta, strMsgRpta)

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     OUT COD RPTA: " & strCodRpta)
                    'INI PROY-140126
                    MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                    MaptPath = "( Class : " & MaptPath & "; Function: ValidarCanjeConProteccionMovil)"
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     OUT MSJ RPTA: " & strMsgRpta & MaptPath)
                    'FIN PROY-140126 

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==   MostrarDatosProteccionMovil - FIN ==")

                If Not dsMostrarPM Is Nothing AndAlso dsMostrarPM.Tables(0).Rows.Count > 0 AndAlso strCodRpta.Equals("0") Then
                    blnEsProteccionMovil = True
                Else
                    blnEsProteccionMovil = False
                    dsMostrarPM = Nothing
                End If
            Else
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "== No se encontro el numero de SEC ==")
            End If
        Else
            objFileLog.Log_WriteLog(pathFile, strArchivo, strNroPedidoPM & "- " & "==  Ocurrió un error en: ConsultarPedidoOrigen   ==")
        End If
        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, strNroPedidoPM & "- " & "==  ERROR: " & ex.Message.ToString())
        Finally
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "== FIN ConsultarPedidoOrigen ==")
        End Try
    End Sub
    Private Function ProcesarPagoCanjeProteccionMovil(ByVal strNroPedidoPM As String, ByVal strNumSEC As String, ByVal strNroTelefono As String, _
                                                      ByVal strNroCertificado As String, ByVal strIDCanje As String) As Boolean

        Dim objProteccionMovil As New COM_SIC_Activaciones.clsProteccionMovil
        Dim objWSGestionaPostventa As New COM_SIC_Activaciones.BWGestionaPostventaProteccionMovil
        Dim objEnvioCorreoWS As New COM_SIC_Activaciones.BWEnvioCorreo
        Dim strIdentifyLog As String = Funciones.CheckStr(AppUsuario) & " - " & strNroPedidoPM
        Dim strCodRpta As String = String.Empty
        Dim strMsgRpta As String = String.Empty
        Dim strEstadoRespuesta As String = clsKeyAPP.strEstadoRespuestaCanje  
        Dim strEstadoError As String = clsKeyAPP.strEstadoErrorCanVIn  
        Dim blnProcesarPagoCanje As Boolean = False
        Dim blnErrorRegistrarAlta As Boolean = False

            Try

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     RegistrarAltaProteccionMovil -  INICIO ==")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     WS: " & ConfigurationSettings.AppSettings("consGestionaPostventaProteccionMovilWS_URL"))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     Método: registrarAltaAsurion")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN            Usuario: " & CurrentUser)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN            Terminal: " & CurrentTerminal)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN            Usuario: " & CurrentUser)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN            Nro SEC: " & strNumSEC)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN       Nro Telefono: " & strNroTelefono)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN Nro de Certificado: " & strNroCertificado)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN   Estado Respuesta: " & strEstadoRespuesta)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN           ID Canje: " & strIDCanje)

                objWSGestionaPostventa.RegistrarAltaProteccionMovil(CurrentUser, CurrentTerminal, strNumSEC, strNroTelefono, strNroCertificado, _
                                                          strEstadoRespuesta, strIDCanje, strCodRpta, strMsgRpta)

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       OUT       Codigo Rpta: " & strCodRpta)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       OUT      Mensaje Rpta: " & strMsgRpta)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     RegistrarAltaProteccionMovil -  FIN   ==")

                If strCodRpta <> "0" Then
                    blnErrorRegistrarAlta = True
                Else
                    blnProcesarPagoCanje = True
                End If
            Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, strNroPedidoPM & "- " & "==  ERROR RegistrarAltaProteccionMovil Catch")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & ConfigurationSettings.AppSettings("consGestionaPostventaProteccionMovilWS_Error"))
            'INI PROY-140126
            Dim MaptPath As String
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: ProcesarPagoCanjeProteccionMovil)"
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "== Mensaje Exception: " & ex.Message.ToString() & MaptPath)
            'FIN PROY-140126



                blnErrorRegistrarAlta = True
            Finally
                If blnErrorRegistrarAlta Then
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         RegistrarContingencia - INICIO")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==           IN NRO PEDIDO: " & strNroPedidoPM)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==           IN NRO SEC: " & strNumSEC)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==           IN NRO TELEFONO: " & strNroTelefono)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==           IN NRO CERTIFICADO: " & strNroCertificado)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==           IN ID DE CANJE: " & strIDCanje)
                    blnProcesarPagoCanje = RegistrarContigenciaProteccionMovil(strNroPedidoPM, strNumSEC, strNroTelefono, strNroCertificado, strIDCanje, strEstadoError)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         RegistrarContingencia - FIN")
                End If
            End Try


        Return blnProcesarPagoCanje

    End Function

    'PROY-24388 INICIO RAR
    Private Sub RegistrarDetalleDOL(ByVal nroPedido As String, ByVal strLineasNoActivadas As String, ByVal booDol As Boolean)

        Dim dsPedido As DataSet
        Dim objFileLog As New SrvPago_Log
        Dim nameFile As String = ConfigurationSettings.AppSettings("constNameLogRegistroDOL")
        Dim pathFile As String = ConfigurationSettings.AppSettings("constRutaLogRegistroDOL")
        Dim strArchivo As String = objFileLog.Log_CrearNombreArchivo(nameFile)
        Dim strIdentifyLog As String = nroPedido
        Dim strParametros As String = ""
        Dim clsCajasPrepago As New COM_SIC_Activaciones.clsConsultaPvu

        '******Consulta Venta Prepago******
        Dim intDatosPrepago As Integer
        Dim K_RPTA, K_MENSAJE As String
        Dim C_VENTA, C_VENTA_DET As DataTable

        intDatosPrepago = clsCajasPrepago.ConsultarPedidosPrepago(nroPedido, K_RPTA, K_MENSAJE, C_VENTA, C_VENTA_DET)
        C_VENTA = C_VENTA
        C_VENTA_DET = C_VENTA_DET

        Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "          *********INICIO REGISTRAR DETALLE DOL*************")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Consulta Pedido - Metodo: ConsultaPedido - SP: SSAPS_PEDIDO")

            Dim PuntoVentaSinergia As String = ""
            Try
                PuntoVentaSinergia = Funciones.CheckStr(objConsultaMsSap.ConsultaPuntoVenta(AppAlmacen).Tables(0).Rows(0).Item("OVENV_CODIGO_SINERGIA"))
            Catch ex As Exception
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error al consulta los Puntos de Venta para Sinergia")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error: " & PuntoVentaSinergia)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & ex.Message.ToString)
                PuntoVentaSinergia = ""
            End Try

            dsPedido = objConsultaMsSap.ConsultaPedido(nroPedido, PuntoVentaSinergia, "")

            'Consulta Parametros SICAR 
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Consulta Paramteros Promocion - Metodo: ListaParamPromocion")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "        IN GrupoBonoDOL" & ConfigurationSettings.AppSettings("strGrupoBonoDol"))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "        IN NroPedido" & strIdentifyLog)

            Dim strListPromo = ListaParamPromocion(ConfigurationSettings.AppSettings("strGrupoBonoDol"), strIdentifyLog)

            'Consulta Parametros por PDV 
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Consulta Paramteros - Metodo: ParametrosVenta")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "        IN Punto de Venta" & AppAlmacen)

            Dim dsResult As DataSet
            Try
                Dim objOffline As New COM_SIC_OffLine.clsOffline
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Inicio Parametros Venta--")
                dsResult = objOffline.ParametrosVenta(AppAlmacen)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Fin Parametros Venta--")
            Catch ex As Exception
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--ERROR Parametros Venta-- " & ex.Message)
            End Try

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio de Transaccion.")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Oficina - Usuario : " & PuntoVentaSinergia & " - " & AppUsuario)

            Dim vendedor As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("VENDEDOR"))
            Dim tipoClieDoc As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("CLIEC_TIPODOCCLIENTE"))
            Dim numClieDoc As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("CLIEV_NRODOCCLIENTE"))

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Vendedor: " & vendedor)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Tipo Cliente: " & tipoClieDoc)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Nro Doc Cliente: " & numClieDoc)

            ' Inicio Consulta Codigo RED Vendedor
            objFileLog.Log_WriteLog(pathFile, strArchivo, "Inicio FP_ConsultaUsuarioRed")
            objFileLog.Log_WriteLog(pathFile, strArchivo, "Cod Vendedor:" + vendedor)
            Dim strRespuesta As String

            Dim dsUsuario As DataSet
            Dim usuarioRed As String
            Dim oConsulta As New COM_SIC_Activaciones.clsBDSiscajas

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Inicio Consulta Red de Vendedor")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         IN Cod Vendedro: " & vendedor)


            Do While InStr(1, vendedor, "0") = 1
                vendedor = Mid(vendedor, 2, Len(vendedor))
            Loop

            objFileLog.Log_WriteLog(pathFile, strArchivo, "Cod Vendedor:" + vendedor)
            dsUsuario = oConsulta.FP_ConsultaUsuarioRed(vendedor, strRespuesta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, "strRespuesta:" + strRespuesta)

            If Not IsNothing(dsUsuario) Then
                objFileLog.Log_WriteLog(pathFile, strArchivo, "nro de registros :" + dsUsuario.Tables(0).Rows.Count.ToString())
                If Not dsUsuario.Tables(0).Rows.Count = 0 Then
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Codigo de red:" + dsUsuario.Tables(0).Rows(0).Item(0))
                    usuarioRed = dsUsuario.Tables(0).Rows(0).Item(0)
                Else
                    usuarioRed = vendedor
                End If
            Else
                usuarioRed = vendedor
            End If

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         OUT Red Vendedor: " & usuarioRed)

            dsUsuario = Nothing
            oConsulta = Nothing
            objFileLog.Log_WriteLog(pathFile, strArchivo, "Fin FP_ConsultaUsuarioRed")
            ' Fin Consulta Codigo RED Vendedor

            ' Inicio Descripcion Documento Cliente
            Dim listaDocumento() As String
            Dim desDocCliente As String
            listaDocumento = Split(ConfigurationSettings.AppSettings("strListaDocumentos"), "|")

            For ii As Integer = 0 To UBound(listaDocumento)
                Dim arrayDocumento() As String = Split(listaDocumento(ii), ";")
                If arrayDocumento(0) = Right("00" & tipoClieDoc, 2) Then
                    desDocCliente = arrayDocumento(1)
                    Exit For
                End If
            Next
            ' Fin Descripcion Documento Cliente

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo|Nro. Cliente : " & tipoClieDoc & "|" & numClieDoc)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Cod.Sap|Cod.Red Vendedor : " & vendedor & "|" & usuarioRed)

            Dim dsCliente As DataSet
            Dim oConsultaSAP As New SAP_SIC_Pagos.clsPagos

            ' Consulta Datos Cliente SAP
            'Consulta de Cliente
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Inicio Consulta de Cliente - Metodo: Get_ConsultaCliente - SP: SSAPSS_CLIENTE")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "       IN Nro de Documento:" & numClieDoc)

            dsCliente = objConsultaMsSap.Get_ConsultaCliente(numClieDoc, tipoClieDoc)

            oConsultaSAP = Nothing

            If Not IsNothing(dsCliente) Then

                If dsCliente.Tables(0).Rows.Count > 0 Then

                    ' Datos Template Cliente
                    Dim oCliente As New COM_SIC_Activaciones.clsCliente

                    oCliente.NROTRANSACCION = ""

                    Dim cod_Region As String
                    cod_Region = dsResult.Tables(0).Rows(0).Item("REGION")

                    For i As Integer = 0 To dsPedido.Tables(1).Rows.Count - 1

                        Dim flagErrorDOL As Boolean = False
                        Dim codMaterial As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(i)("MATEV_CLASIFICACION"))

                        ' Inicio Validacion solo Pack SimCard
                        If Len(Trim(codMaterial)) > 0 Then
                            If codMaterial.StartsWith("PS") Then
                                Dim NroTelefono As String
                                NroTelefono = FormatoTelefonoPrepago(Funciones.CheckStr(dsPedido.Tables(1).Rows(i)("DEPEV_NROTELEFONO")))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Telefono : " & NroTelefono)
                                oCliente.MSISDN = NroTelefono

                                'Registra DOL solo para aquellas lineas que fueron activadas.
                                If strLineasNoActivadas.IndexOf(NroTelefono) = -1 Then

                                    If booDol = True Then

                                    End If ' FIN FMES : PILOTO

                                    ' Obtenemos los Datos Telefono|Ruta de Sesion
                                    Dim arrayFile() As String
                                    arrayFile = CType(ApparrNombArchivos, String())

                                    If Not IsNothing(arrayFile) Then

                                        If arrayFile.Length > 0 Then

                                            For iii As Integer = 0 To UBound(arrayFile) - 1

                                                'Dim Telefono As String = CStr(Split(arrayFile(iii), "|")(0))
                                                Dim SerieChip As String = CStr(Split(arrayFile(iii), "|")(0))
                                                Dim NombreArchivo As String = CStr(Split(arrayFile(iii), "|")(1))

                                                'If Telefono = Funciones.CheckStr(dsPedido.Tables(1).Rows(i)("DEPEV_NROTELEFONO")) Then
                                                If SerieChip = Funciones.CheckStr(dsPedido.Tables(1).Rows(i).Item("SERIC_CODSERIE")) Then

                                                    ' Inicio Region Upload FTP
                                                    Dim mensajeFTP As String
                                                    Dim strDirectorio As String = Date.Now.ToString("yyyyMMdd")
                                                    Dim strRutaDestino As String = ConfigurationSettings.AppSettings("strRutaDestinoDOL") & "/" & strDirectorio

                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Telefono : " & NroTelefono)
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo UploadArchivoFTP()")
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Archivo : " & NombreArchivo)
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Directorio Origen : " & ConfigurationSettings.AppSettings("strRutaOrigenDOL"))
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Directorio Destino : " & strRutaDestino)

                                                    ' Creacion del Directorio Formato YYYYMMDD
                                                    mensajeFTP = CreateDirectorioFTP(ConfigurationSettings.AppSettings("strRutaDestinoDOL"), strDirectorio)
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje Directorio: " & mensajeFTP)
                                                    mensajeFTP = UploadArchivoFTP(ConfigurationSettings.AppSettings("strRutaOrigenDOL"), _
                                                            NombreArchivo, _
                                                            strRutaDestino)
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje FTP: " & mensajeFTP)

                                                    If Not mensajeFTP = "" Then
                                                        'Session.Add("mensajeErrorDOL", Session("mensajeErrorDOL") & "\nError. No se pudo enviar por el archivo " & NombreArchivo & " via FTP.")
                                                        AppmensajeErrorDOL = AppmensajeErrorDOL & "\nError. No se pudo enviar por el archivo " & NombreArchivo & " via FTP."
                                                    End If

                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo UploadArchivoFTP()")
                                                    ' Fin Region Upload FTP

                                                    ' Inicio Registrar BD Prepago
                                                    Dim outBD As Int64
                                                    Dim oCajas As New COM_SIC_Activaciones.clsBDSiscajas
                                                    Dim rutaArchivo As String = strRutaDestino & "/" & NombreArchivo

                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo FP_RegistrarDOL()")
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "      IN Numero de Telefono: " & NroTelefono)
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "      IN Tipo de Cliente: " & tipoClieDoc)
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "      IN Numero de Documento Cliente: " & numClieDoc)
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "      IN Usuario de Red: " & usuarioRed)
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "      IN Punto de Venta: " & AppAlmacen)
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "      IN Ruta de Acrchivo: " & rutaArchivo)
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "      IN Sistema DOL: " & ConfigurationSettings.AppSettings("SISTEMA_DOL"))
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "      IN Estado: 1")
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "      IN FlagDummy: 0")
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "      IN FechaNac: 00000000")

                                                    outBD = oCajas.FP_RegistrarDOL(NroTelefono, _
                                                                                    tipoClieDoc, _
                                                                                    numClieDoc, _
                                                                                    usuarioRed, _
                                                                                    AppAlmacen, _
                                                                                    rutaArchivo, _
                                                                                    ConfigurationSettings.AppSettings("SISTEMA_DOL"), _
                                                                                    "1", _
                                                                                    ConfigurationSettings.AppSettings("FlagDummy"), _
                                                                                    "00000000")
                                                    oCajas = Nothing

                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Resultado : " & outBD)
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo FP_RegistrarDOL()")
                                                    ' Fin Registrar BD Prepago
                                                End If
                                            Next
                                        Else
                                            ' Capturamos el Error en el Log
                                            If Not Right("00" & tipoClieDoc, 2) = "06" Then
                                                'Session.Add("mensajeErrorDOL", Session("mensajeErrorDOL") & "\nError. No se pudo enviar por el archivo via FTP, no se grabo en la BD COBSDB.")
                                                AppmensajeErrorDOL = AppmensajeErrorDOL & "\nError. No se pudo enviar por el archivo via FTP, no se grabo en la BD COBSDB."
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Ocurrio un error al intentar recuperar los datos de Sesion.")
                                            End If
                                        End If
                                    Else
                                        ' Capturamos el Error en el Log
                                        If Not Right("00" & tipoClieDoc, 2) = "06" Then
                                            'Session.Add("mensajeErrorDOL", Session("mensajeErrorDOL") & "\nError. No se pudo enviar por el archivo via FTP, no se grabo en la BD COBSDB.")
                                            AppmensajeErrorDOL = AppmensajeErrorDOL & "\nError. No se pudo enviar por el archivo via FTP, no se grabo en la BD COBSDB."
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Ocurrio un error al intentar recuperar los datos de Sesion.")
                                        End If
                                    End If
                                End If
                                'Fin Registra DOL solo para aquellas lineas que fueron activadas.
                            End If
                            ' Fin Validacion solo Pack SimCard
                        Else
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "No tiene Codigo de Material")
                        End If
                    Next
                Else
                    ' Capturamos el Error en el Log
                    'Session.Add("mensajeErrorDOL", "Cliente No Encontrado en SAP, Nro. Documento: " & numClieDoc & ". No se pudo registrar el Detalle DOL.")
                    AppmensajeErrorDOL = "Cliente No Encontrado en SAP, Nro. Documento: " & numClieDoc & ". No se pudo registrar el Detalle DOL."
                    Throw New Exception("Cliente No Encontrado en SAP. Numero Documento: " & numClieDoc)
                End If
            Else
                ' Capturamos el Error en el Log
                'Session.Add("mensajeErrorDOL", "Cliente No Encontrado en SAP, Nro. Documento: " & numClieDoc & ". No se pudo registrar el Detalle DOL.")
                AppmensajeErrorDOL = "Cliente No Encontrado en SAP, Nro. Documento: " & numClieDoc & ". No se pudo registrar el Detalle DOL."
                Throw New Exception("Cliente No Encontrado en SAP. Numero Documento: " & numClieDoc)
            End If

            ApparrNombArchivos = Nothing
            dsCliente = Nothing
            dsPedido = Nothing

        Catch ex As Exception
            dsPedido = Nothing
            ApparrNombArchivos = Nothing

            ' Capurando Mensaje de Error
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & ex.Message)
        End Try

    End Sub

    'PROY-24388 RAR FIN

    Private Sub TipificarProteccionMovil(ByVal NroPedidoPM As String, ByVal strNroSEC As String, ByVal strTelefono As String, _
                                         ByVal strFlagTipoOperacion As String, ByVal dsMostrarEvalPM As DataSet, _
                                         ByVal dtCanjeEquipo As DataTable, ByVal lstDatosSiniestro As ArrayList, ByVal strCACSiniestro As String)
        'PROY-24724 - Iteracion 2 Siniestros 

        Dim strIdentifyLog As String = Funciones.CheckStr(AppUsuario) & " - " & NroPedidoPM
        Dim dtHistoricoEval As DataTable
        Dim objProteccionMovil As New COM_SIC_Activaciones.clsProteccionMovil
        Dim oWSGestionaProteccion As New BWGestionaProteccionMovil ''PROY-24724 - Iteracion 2 Siniestros
        Dim oWSGestionaPostventa As New BWGestionaPostventaProteccionMovil
        Dim strCodRpta As String = String.Empty
        Dim strMsgRpta As String = String.Empty
        Dim strCodEquipoNuevo As String = String.Empty
        Dim strIdTransaccion As String = String.Empty
        Dim strIPAplicacion As String = String.Empty
        Dim strNombaplicacion As String = String.Empty
        Dim strUsrProceso As String = String.Empty
        Dim strNotas As String = String.Empty
        Dim strSUBClase As String = String.Empty
        Dim strNroCertificado As String = String.Empty
        Dim strAgente As String = String.Empty
        Dim strFechaAfiliacion As String = String.Empty
        Dim strEstado As String = String.Empty
        Dim strOperacionVenta As String = String.Empty
        Dim strMontoPrimaActual As String = String.Empty
        Dim strDeducibleDanoActual As String = String.Empty
        Dim strDeducibleRoboactual As String = String.Empty
        Dim dsDatosPedidoEquiOrigen As DataSet
        Dim strDescEquipoActual As String = String.Empty
        Dim strImeiActual As String = String.Empty
        Dim strDescEquipoAnterior As String = String.Empty
        Dim strImeiAnterior As String = String.Empty
        Dim strMontoPrimaAnterior As String = String.Empty
        Dim strDeducibleDanoAnterior As String = String.Empty
        Dim strDeducibleRoboAnterior As String = String.Empty
        Dim strFechaCambioEquipo As String = String.Empty
        Dim strFechaCompraEquipo As String = String.Empty
        Dim strFlagPlantilla As String = String.Empty
        Dim strCodRptaInteraccion As String = String.Empty
        Dim dtConsultaplan As DataTable = Nothing
        Dim strIdTransaccionRpta As String = String.Empty
        'PROY-24724 - Iteracion 2 Siniestros  INI
        Dim strCACEntrega As String = String.Empty
        Dim strNroSiniestro As String = String.Empty
        Dim strTipoSiniestro As String = String.Empty
        Dim strFechaPago As String = String.Empty
        Dim strDevuelveEquipo As String = String.Empty
        Dim strMontoDeduSiniestro As String = String.Empty
        Dim strIdtransGestionaPvta As String = DateTime.Now.ToString("yyyyMMddHHmmssfff")
        Dim strCdRpta As String = String.Empty
        Dim strMjRpta As String = String.Empty
        Dim lstDatosVICanje As New ArrayList
        Dim bolVIdeCanje As Boolean = False
        Dim dsDatosVICAnje As DataSet
        Dim strMetodo As String = String.Empty
        'PROY-24724 - Iteracion 2 Siniestros  FIN

        Try

        strIdTransaccion = DateTime.Now.ToString("yyyyMMddHHmmssfff")
        strIPAplicacion = CurrentTerminal
        strNombaplicacion = ConfigurationSettings.AppSettings("constAplicacion")
        strUsrProceso = CurrentUser  'PROY-24724 - Iteracion 2 Siniestros 
        strAgente = CurrentUser     'PROY-24724 - Iteracion 2 Siniestros 
        'PROY-24724 - Iteracion 2 Siniestros -INI
        If Not strFlagTipoOperacion.Equals("S") Then '' V o C
            strMontoPrimaActual = Funciones.CheckStr(dsMostrarEvalPM.Tables(0).Rows(0).Item("EVALN_MONT_PRIM_RPTA"))
            strDeducibleDanoActual = Funciones.CheckStr(dsMostrarEvalPM.Tables(0).Rows(0).Item("EVALV_DEDUCIBLE_DANO"))
            strDeducibleRoboactual = Funciones.CheckStr(dsMostrarEvalPM.Tables(0).Rows(0).Item("EVALV_DEDUCIBL_ROBO"))
         End If
        'PROY-24724 - Iteracion 2 Siniestros -FIN
        If strFlagTipoOperacion.Equals("V") Then ''venta individual
            strNotas = clsKeyAPP.strNotasVI + strTelefono 
            strSUBClase = clsKeyAPP.strSubClaseVI
            strNroCertificado = Funciones.CheckStr(dsMostrarEvalPM.Tables(0).Rows(0).Item("EVALV_NRO_CERTF_RPTA"))
            strEstado = clsKeyAPP.strEstadoVentaIndividual 
            strFechaAfiliacion = Funciones.CheckDate(dsDatosPedido.Tables(0).Rows(0).Item("PEDID_FECHADOCUMENTO")).ToString("yyyy-MM-dd")
            strOperacionVenta = clsKeyAPP.strOperacionVenta  
            strFechaCompraEquipo = Funciones.CheckDate(dsDatosPedido.Tables(0).Rows(0).Item("PEDID_FECHADOCUMENTO")).ToString("dd/MM/yyyy")
            strFlagPlantilla = clsKeyAPP.strFlagdePlantillaVIndividual
           'PROY-24724 - Iteracion 2 Siniestros  - INI
            strMetodo = "BuscarCanjeVentaIndividual"
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==    BuscarCanjeVentaIndividual - INICIO ==")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     WS: " & ConfigurationSettings.AppSettings("consGestionaPostventaProteccionMovilWS_URL"))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     Método WS: BuscarSeguroCanje ")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         IN Id. Transacción: " & strIdtransGestionaPvta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         IN Nro Pedido VI: " & NroPedidoPM)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         IN Terminal: " & CurrentTerminal)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         IN Usuario: " & CurrentUser)

            oWSGestionaPostventa.BuscarCanjeVentaIndividual(strIdtransGestionaPvta, NroPedidoPM, CurrentTerminal, CurrentUser, strCdRpta, strMjRpta, lstDatosVICanje)

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         OUT Cod. Rpta: " & strCdRpta)
                'INI PROY-140126
                Dim MaptPath As String
                MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                MaptPath = "( Class : " & MaptPath & "; Function: TipificarProteccionMovil)"
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         OUT Msj Rpta: " & strMjRpta & MaptPath)
                'FIN PROY-140126 

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         OUT N. Lista: " & lstDatosVICanje.Count)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==    BuscarCanjeVentaIndividual - FIN ==")

            If strCdRpta.Equals("0") AndAlso lstDatosVICanje.Count > 0 Then
              If Funciones.CheckStr(lstDatosVICanje(0).estado).Equals("0") Then
                  bolVIdeCanje = True
              End If
            Else
                strMetodo = "ConsultarCanjedeVentaIndividual"
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==    ConsultarCanjedeVentaIndividual - INICIO ==")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     PKG_TRANS_ASURION.SISASS_BUSCR_SEGURO_CANJE")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      IN Nro Pedido VI: " & NroPedidoPM)

                dsDatosVICAnje = objProteccionMovil.ConsultarCanjedeVentaIndividual(NroPedidoPM, strCdRpta, strMjRpta)

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      OUT Cod. Rpta: " & strCdRpta)
                    'INI PROY-140126
                    MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                    MaptPath = "( Class : " & MaptPath & "; Function: TipificarProteccionMovil)"
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      OUT Msj Rpta: " & strMjRpta & MaptPath)
                    'FIN PROY-140126

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==    ConsultarCanjedeVentaIndividual - FIN ==")

                If Not dsDatosVICAnje Is Nothing AndAlso strCdRpta = "0" AndAlso dsDatosVICAnje.Tables(0).Rows.Count > 0 Then
                    If Funciones.CheckStr(dsDatosVICAnje.Tables(0).Rows(0).Item("VENTC_ESTADO")) = "0" Then
                        bolVIdeCanje = True
                     End If
                End If
           End If

           If bolVIdeCanje = True Then
                    strImeiActual = Funciones.CheckStr(lstDatosVICanje(0).imei)
                    strDescEquipoActual = Funciones.CheckStr(lstDatosVICanje(0).desMaterial)
            Else
               strMetodo = "ConsultarSeguroPlan"
               'PROY-24724 - Iteracion 2 Siniestros  - FIN
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==   ConsultarSeguroPlan INI   ==")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==    IN SEC : " & strNroSEC)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==    IN Flag VI : " & strFlagTipoOperacion)

            dtConsultaplan = objProteccionMovil.ConsultarSeguroPlan(strNroSEC, strFlagTipoOperacion, strCodRpta, strMsgRpta)

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==    OUT Cod. Rpta : " & strCodRpta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==    OUT Msj Rpta. : " & strMsgRpta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==   ConsultarSeguroPlan FIN   ==")

            If Not dtConsultaplan Is Nothing AndAlso dtConsultaplan.Rows.Count > 0 Then
                strImeiActual = dtConsultaplan.Rows(0).Item("SERIE_EQUIPO")
                strDescEquipoActual = dtConsultaplan.Rows(0).Item("DES_EQUIPO")
            End If
          End If 'PROY-24724 - Iteracion 2 Siniestros  

        ElseIf strFlagTipoOperacion.Equals("C") Then  'PROY-24724 - Iteracion 2 Siniestros 
            strNotas = clsKeyAPP.strNotasCanje + strTelefono 
            strSUBClase = clsKeyAPP.strSubClaseCanje 
            strEstado = clsKeyAPP.strEstadoCanje
            strFechaAfiliacion = DateTime.Now.ToString("yyyy-MM-dd")
            strFechaCambioEquipo = Funciones.CheckDate(dsDatosPedido.Tables(0).Rows(0).Item("PEDID_FECHADOCUMENTO")).ToString("yyyy-MM-dd")
            strImeiActual = Funciones.CheckStr(dtCanjeEquipo.Rows(0).Item("CANJV_SAL_SERIE_MAT"))
            strFlagPlantilla = clsKeyAPP.strFlagdePlantillaCanje
            strDescEquipoAnterior = Funciones.CheckStr(dtCanjeEquipo.Rows(0).Item("V_MATE_ENTRADA"))
            strImeiAnterior = Funciones.CheckStr(dtCanjeEquipo.Rows(0).Item("CANJV_ENT_SERIE_MAT"))
            strDescEquipoActual = Funciones.CheckStr(dtCanjeEquipo.Rows(0).Item("V_MATE_SALIDA"))
            strMetodo = "ObtenerHistoricoEvaluacion" 'PROY-24724 - Iteracion 2 Siniestros  
            objFileLog.Log_WriteLog(pathFile, strArchivo, strTelefono & "- " & "==     ObtenerHistoricoEvaluacion -  INICIO ==")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strTelefono & "- " & "==      IN NRO SEC: " & strNroSEC)

            dtHistoricoEval = objProteccionMovil.ObtenerHistoricoEvaluacion(strNroSEC, strCodRpta, strMsgRpta)

            objFileLog.Log_WriteLog(pathFile, strArchivo, strTelefono & "- " & "==      OUT COD RPTA: " & strCodRpta)
                'INI PROY-140126
                Dim MaptPath As String
                MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                MaptPath = "( Class : " & MaptPath & "; Function: TipificarProteccionMovil)"
                objFileLog.Log_WriteLog(pathFile, strArchivo, strTelefono & "- " & "==      OUT MSJ RPTA: " & strMsgRpta & MaptPath)
                'FIN PROY-140126 

            objFileLog.Log_WriteLog(pathFile, strArchivo, strTelefono & "- " & "==     ObtenerHistoricoEvaluacion -  F I N  ==")

            If Not dtHistoricoEval Is Nothing And dtHistoricoEval.Rows.Count > 0 Then
                strNroCertificado = Funciones.CheckStr(dtHistoricoEval.Rows(0).Item("EVHIV_NRO_CERTF_RPTA"))  
                strMontoPrimaAnterior = Funciones.CheckStr(dtHistoricoEval.Rows(0).Item("EVHIN_MONT_PRIM_RPTA"))
                strDeducibleDanoAnterior = Funciones.CheckStr(dtHistoricoEval.Rows(0).Item("EVHIV_DEDUCIBLE_DANO"))
                strDeducibleRoboAnterior = Funciones.CheckStr(dtHistoricoEval.Rows(0).Item("EVHIV_DEDUCIBLE_ROBO"))
            Else
                objFileLog.Log_WriteLog(pathFile, strArchivo, strTelefono & "- " & "==  Error en obtener ObtenerHistoricoEvaluacion() ==")
            End If
            'PROY-24724 - Iteracion 2 Siniestros -INI 
            Else ' Siniestros 
                strNotas = clsKeyAPP.strNotasSiniestro
                strSUBClase = clsKeyAPP.strTipiSubClaseSiniestro
                strNroCertificado = Funciones.CheckStr(lstDatosSiniestro(0).nroCertif)
                strEstado = clsKeyAPP.strTipiEstadoSiniestro
                strFlagPlantilla = clsKeyAPP.strFlagPlantillaSiniestro
                strNroSiniestro = Funciones.CheckStr(lstDatosSiniestro(0).nroSiniestro)
                strTipoSiniestro = Funciones.CheckStr(lstDatosSiniestro(0).tipoSiniestro)
                strDescEquipoAnterior = Funciones.CheckStr(lstDatosSiniestro(0).marcEquiOrig) + " " + Funciones.CheckStr(lstDatosSiniestro(0).modelEquiOrig)
                strDescEquipoActual = Funciones.CheckStr(lstDatosSiniestro(0).marcEquiNuev) + " " + Funciones.CheckStr(lstDatosSiniestro(0).modelEquiNuev)
                strCACEntrega = strCACSiniestro
                strFechaPago = Funciones.CheckDate(DateTime.Now.ToString("yyyy-MM-dd"))
                strImeiActual = Funciones.CheckStr(lstDatosSiniestro(0).imeiNuev)
                strImeiAnterior = Funciones.CheckStr(lstDatosSiniestro(0).imeiOriginal)
                strMontoDeduSiniestro = Funciones.CheckStr(lstDatosSiniestro(0).montoDeducible)

                If (Funciones.CheckStr(lstDatosSiniestro(0).tipoSiniestro)).Equals("DAÑO") Then
                    strDevuelveEquipo = "TRUE"
                End If
                'PROY-24724 - Iteracion 2 Siniestros - FIN 
        End If
        strMetodo = "RegistrarTipificacion" 'PROY-24724 - Iteracion 2 Siniestros 
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==   RegistrarTipificacion INI   ==")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==   WS: " & ConfigurationSettings.AppSettings("consGestionaPostventaProteccionMovilWS_URL"))
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==   Método: tipificarProteccionMovil")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN IdTransaccion : " & strIdTransaccion)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN IP : " & strIPAplicacion)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN Nombre aplicacion : " & strNombaplicacion)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  Usuario: " & CurrentUser)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  User Proceso: " & strUsrProceso)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  Agente: " & strAgente)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  Notas: " & strNotas)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  SUBClase: " & strSUBClase)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  Telefono: " & strTelefono)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  Nro Certificado: " & strNroCertificado)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  FechaAfiliacion: " & strFechaAfiliacion)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  Estado: " & strEstado)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  Operacion Venta: " & strOperacionVenta)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  Desc. Equipo Actual: " & strDescEquipoActual)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  Imei Actual: " & strImeiActual)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  Monto Prima Anterior: " & strMontoPrimaAnterior)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  Deducible Dano Anterior: " & strDeducibleDanoAnterior)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  DeducibleRoboAnterior: " & strDeducibleRoboAnterior)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  FechaCambioEquipo: " & strFechaCambioEquipo)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  FechaCompraEquipo: " & strFechaCompraEquipo)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  FlagPlantilla: " & strFlagPlantilla)
        'PROY-24724 - Iteracion 2 Siniestros -INI 
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  CAC Entrega: " & strCACEntrega)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  Nro Siniestro: " & strNroSiniestro)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  Tipo Siniestro: " & strTipoSiniestro)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  Fecha Pago: " & strFechaPago)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  Devuelve Equipo: " & strDevuelveEquipo)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  Monto Deducible: " & strMontoDeduSiniestro)

        oWSGestionaPostventa.RegistrarTipificacion(strIdTransaccion, strIPAplicacion, strNombaplicacion, CurrentUser, strUsrProceso, _
                                                   strAgente, strNotas, strSUBClase, strTelefono, strNroCertificado, strFechaAfiliacion, strEstado, _
                                                   strOperacionVenta, strDescEquipoActual, strImeiActual, strMontoPrimaActual, strDeducibleDanoActual, _
                                                   strDeducibleRoboactual, strDescEquipoAnterior, strImeiAnterior, strMontoPrimaAnterior, _
                                                   strDeducibleDanoAnterior, strDeducibleRoboAnterior, strFechaCambioEquipo, strFechaCompraEquipo, strFlagPlantilla, _
                                                               strCACEntrega, strNroSiniestro, strTipoSiniestro, strFechaPago, strDevuelveEquipo, strMontoDeduSiniestro, String.Empty, _
                                                           strIdTransaccionRpta, strCodRpta, strMsgRpta) 'PROY-31836 - Se agregó un parámetro vacío
        'PROY-24724 - Iteracion 2 Siniestros -FIN

        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       OUT  Id Transaccion: " & strIdTransaccionRpta)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       OUT Cod. Rpta: " & strCodRpta)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       OUT Msj. Rpta: " & strMsgRpta)

        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       ERROR en el método: " & strMetodo) 'PROY-24724 - Iteracion 2 Siniestros -INI
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       ERROR Tipificacion: " & ex.Message.ToString())
        Finally
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==   RegistrarTipificacion FIN   ==")
        End Try
    End Sub
    'PROY-24724 - Iteracion 2 Siniestros - INI
    Private Sub ProcesarPagoSiniestro(ByVal strIdentifyLog As String, ByVal strTelefono As String, ByVal strCodOficina As String)

        Dim objGestionaPostventa As New COM_SIC_Activaciones.BWGestionaPostventaProteccionMovil
        Dim strMetodo As String = String.Empty
        'Variables para MostrarDetalleSiniestro
        Dim strNroPedidoDeducible As String
        Dim strNroTelef As String
        Dim strCodRspta As String = String.Empty
        Dim strMsgRspta As String = String.Empty
        Dim lstDetalleSiniestro As New ArrayList
        ''RegistraSiniestro
        Dim bolRegistroSiniestro As Boolean = False
        Dim strEstadPendienteSini As String = Funciones.CheckStr(clsKeyAPP.strEstdPendienteSiniestro).Split(";")(0)
        Dim strEstadFinalizadoSini As String = Funciones.CheckStr(clsKeyAPP.strEstdFinalizadoPagoSiniestro).Split(";")(0)
        Dim strIdTransaccion As String = strTelefono & DateTime.Now.ToString("yyyyMMddHHmmssfff")
        ''Variables de Correo
        Dim strRemitente As String = clsKeyAPP.strRemitentePM
        Dim strDestinatario As String = clsKeyAPP.strDestinatarioPM
        Dim strMsjSiniestro As String = clsKeyAPP.strMensajeSiniestro
        Dim strFlag As String = clsKeyAPP.strFlagCorreoPM
        Dim objEnvioCorreoWS As New COM_SIC_Activaciones.BWEnvioCorreo
        Dim arrMensajeProtMovil(18) As String
        Dim strCodRptaCorreo As String = String.Empty
        Dim strMsjRptaCorreo As String = String.Empty
        Dim arrAsunto(0) As String
        Dim strAsunto As String = clsKeyAPP.strAsuntoSiniestro
        arrAsunto(0) = "PAGO"
        strAsunto = String.Format(strAsunto, arrAsunto)

        strNroPedidoDeducible = Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO"))
        strNroTelef = Funciones.CheckStr(dsDatosPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO"))

        Try
            strMetodo = "MostrarDetalleSiniestro"
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==============================")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "=== Pago Siniestro :: INI  ===")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==============================")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     MostrarDetalleSiniestro -  INICIO ==")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     WS: " & ConfigurationSettings.AppSettings("consGestionaPostventaProteccionMovilWS_URL"))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     Método: obtenerDetalleSiniestro")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  IdTransaccion: " & strIdTransaccion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  Teléfono: " & strNroTelef)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  Estado Siniestro: " & strEstadPendienteSini)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  Usuario: " & CurrentUser)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  Terminal: " & CurrentTerminal)

            objGestionaPostventa.MostrarDetalleSiniestro(strIdTransaccion, strNroTelef, strEstadPendienteSini, CurrentUser, CurrentTerminal, strCodRspta, strMsgRspta, lstDetalleSiniestro)

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       OUT Cod. Rpta : " & strCodRspta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       OUT Msj. Rpta: " & strMsgRspta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       OUT ListaResponse.Count: : " & lstDetalleSiniestro.Count)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     MostrarDetalleSiniestro -  FIN ==")

            If strCodRspta.Equals("0") Then
                strMetodo = "RegistrarAltaSiniestro"
                strIdTransaccion = strTelefono & DateTime.Now.ToString("yyyyMMddHHmmssfff")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     RegistrarAltaSiniestro -  INICIO ==")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     WS: " & ConfigurationSettings.AppSettings("consGestionaPostventaProteccionMovilWS_URL"))
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     Método: registrarAltaSiniestroAsurion ")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  IdTransaccion: " & strIdTransaccion)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  NroCertificado: " & Funciones.CheckStr(lstDetalleSiniestro(0).nroCertif))
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  CustomerID: " & Funciones.CheckStr(lstDetalleSiniestro(0).customerId))
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  Nro Siniestro: " & Funciones.CheckStr(lstDetalleSiniestro(0).nroSiniestro))
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  Teléfono: " & Funciones.CheckStr(lstDetalleSiniestro(0).nroTelefono))
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  CodMaterial: " & Funciones.CheckStr(lstDetalleSiniestro(0).codigoNuevo))
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  Descripción Material: " & Funciones.CheckStr(lstDetalleSiniestro(0).marcEquiNuev) + " " + Funciones.CheckStr(lstDetalleSiniestro(0).modelEquiNuev))
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  IMEI: " & Funciones.CheckStr(lstDetalleSiniestro(0).imeiNuev))
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  Usuario Modif.: " & CurrentUser)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  Flag Siniestro: " & clsKeyAPP.strFlagSiniestro)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  Estado.: " & strEstadFinalizadoSini)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  Terminal: " & CurrentTerminal)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN  Usuario: " & CurrentUser)

                objGestionaPostventa.RegistrarAltaSiniestro(lstDetalleSiniestro, strIdTransaccion, clsKeyAPP.strFlagSiniestro, strEstadFinalizadoSini, CurrentTerminal, CurrentUser, strCodRspta, strMsgRspta)

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       OUT Cod Rpta. : " & strCodRspta)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       OUT Msj. Rpta : " & strMsgRspta)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     RegistrarAltaSiniestro -   FIN    ==")

                If strCodRspta.Equals("0") Then
                    bolRegistroSiniestro = True 
                    Dim dtData As DataTable
                    Dim dtData1 As DataSet
                    Dim strTipoOperacionSin As String = "S" ' Tipificación para Siniestro
                    Dim strCACSiniestro As String = strCodOficina
                    ''tipificar
                    TipificarProteccionMovil(strNroPedidoDeducible, "", strNroTelef, strTipoOperacionSin, dtData1, dtData, lstDetalleSiniestro, strCACSiniestro)

                End If
            Else
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==  No se encontraron datos de Siniestro ==")
                'INI PROY-140126
                Dim MaptPath As String
                MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                MaptPath = "( Class : " & MaptPath & "; Function: ProcesarPagoSiniestro)"
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==  Mensaje : " & strMsgRspta & MaptPath)
                'FIN PROY-140126

            End If

        Catch ex As Exception
            strMsgRspta = ex.Message.ToString()
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "== ERROR " & strMetodo)
            'INI PROY-140126
            Dim MaptPath As String
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: ProcesarPagoSiniestro)"
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "== Mensaje Exception: " & ex.Message.ToString() & MaptPath)
            'FIN PROY-140126
        Finally
            Try
                If bolRegistroSiniestro = False Then
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         EnvioCorreoWS - INICIO")
                    arrMensajeProtMovil(0) = "el pago"
                    arrMensajeProtMovil(1) = "WS GestionaPostventaProteccionMovil: " & ConfigurationSettings.AppSettings("consGestionaPostventaProteccionMovilWS_URL")
                    arrMensajeProtMovil(2) = "Error Encontrado en el Método: " & strMetodo & " Nº Pedido: " & strNroPedidoDeducible & " Descripción de Error: " & strMsgRspta
                    arrMensajeProtMovil(3) = "Regularizar Ejecutando Primer Método: obtenerDetalleSiniestro"
                    arrMensajeProtMovil(4) = "  1. nroTelefono: " & strNroTelef
                    arrMensajeProtMovil(5) = "  2. estado: " & strEstadPendienteSini
                    arrMensajeProtMovil(6) = "Segundo Método: registrarAltaSiniestroAsurion"
                    arrMensajeProtMovil(7) = "1. nroCertif = nroCertif (Obtenido del Primer Método)"
                    arrMensajeProtMovil(8) = "2. customerId = customerId (Obtenido del Primer Método)"
                    arrMensajeProtMovil(9) = "3. nroSiniestro = nroSiniestro(Obtenido del Primer Método)"
                    arrMensajeProtMovil(10) = "4. nroTelefono = nroTelefono(Obtenido del Primer Método)"
                    arrMensajeProtMovil(11) = "5 codMaterial = codigoNuevo(Obtenido del Primer Método)"
                    arrMensajeProtMovil(12) = "6. desMaterial = marcEquiNuev + modelEquiNuev (Obtenido del Primer Método)"
                    arrMensajeProtMovil(13) = "7. imeiNuevo = imeiNuev (Obtenido del Primer Método)"
                    arrMensajeProtMovil(14) = "8. usuarioModif = " & CurrentUser 
                    arrMensajeProtMovil(15) = "9. flagSiniestro = " & clsKeyAPP.strFlagSiniestro
                    arrMensajeProtMovil(16) = "10. estado =" & strEstadFinalizadoSini
                    strMsjSiniestro = strMsjSiniestro.Replace("*", "<br>")
                    strMsjSiniestro = String.Format(strMsjSiniestro, arrMensajeProtMovil)

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==             IN Remitente: " & strRemitente)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==             IN Destinatario: " & strDestinatario)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==             IN Asunto: " & strAsunto)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==             IN Mensaje: " & strMsjSiniestro)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==             IN Flag: " & strFlag)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==             IN IP: " & CurrentTerminal)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==             IN Usuario: " & CurrentUser)

                    objEnvioCorreoWS.EnviarCorreoPM(strRemitente, strDestinatario, strAsunto, strMsjSiniestro, strFlag, _
                                                            CurrentTerminal, CurrentUser, strCodRptaCorreo, strMsjRptaCorreo)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==             OUT Cod Respuesta: " & strCodRptaCorreo)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==             OUT Msj Respuesta: " & strMsjRptaCorreo)

                End If
            Catch x As Exception
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      ERROR - EnviarCorreoPM: " & x.Message.ToString())
            End Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==============================")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "=== Pago Siniestro :: FIN  ===")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==============================")
        End Try
    End Sub
    'PROY-24724 - Iteracion 2 Siniestros -FIN
' PROY-27790-IDEA-35384- Venta y Post venta de equipos PLC :: NGC   -   08-06-2017

    Public Sub TipificacionRegistraActualiza(ByVal dsPedido As DataSet)
        Dim strIdentifyLog As String = Funciones.CheckStr(AppUsuario)
        Dim objTipificacion As New COM_SIC_Activaciones.BWTipificaciones
        Dim objActualiza As New COM_SIC_Activaciones.BWActualizaEquipoContrato

        Try
             
            '**************Actualizar Equipo Contrato**************'
            'DATOS ENTRADA 
            Dim strIdTransaccion = DateTime.Now.ToString("yyyyMMddHHmmssfff")
            Dim strIPAplicacion = CurrentTerminal
            Dim strNombaplicacion = ConfigurationSettings.AppSettings("constAplicacion")
            Dim strUsrProceso = CurrentUser

            Dim strPedido = drPagos.Item("PEDIN_NROPEDIDO")
            Dim strCodCliente = drPagos.Item("PEDIV_NRODOCCLIENTE").PadLeft(16, "0")         
            Dim strVendedor = drPagos.Item("VENDEDOR")
            'END DATOS ENTRADA

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==   ActualizaEquipoContratoTipificacion INI   ==")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==   WS: " & ConfigurationSettings.AppSettings("ActualizaEquipoContratoWS_URL"))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==   Método: ActualizaEquipoContrato")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN IdTransaccion : " & strIdTransaccion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN IPAplicacion : " & strIPAplicacion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN Nombaplicacion : " & strNombaplicacion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN UsrProceso: " & strUsrProceso)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN CodCliente : " & strCodCliente)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN CodNumPedido : " & strPedido)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN CodVendedor : " & strVendedor)

            'ACTUALIZA EQUIPO A ESTADO DE VENTA PAGADO
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - ==   Inicia Metodo actualizarEquiposVarios[Cliente={1} - Pedido={2}]", strIdentifyLog, strCodCliente, strPedido))
            Dim strSalida As String = objActualiza.actualizarEquiposVarios(strIdTransaccion, strIPAplicacion, strNombaplicacion, strUsrProceso, strCodCliente, strPedido, strVendedor)
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - ==   Respuesta={1}", strIdentifyLog, strSalida))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - ==   Fin Metodo actualizarEquiposVarios", strIdentifyLog))

            'VARIABLES DE SALIDA
            Dim Salida As String()
            Salida = strSalida.Split(";")
            Dim strCodRpt As String = Salida(0)
            Dim strMsjRpt As String = Salida(1)
            Dim strIdTransac As String = Salida(2)
            Dim strTipoMate As String = Salida(3)
            Dim strCustomerId As String = Salida(4)

            Dim flTipiPLC As Boolean = False

            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - ==   Se evalua el tipo {1}", strIdentifyLog, strTipoMate))
            If (Funciones.CheckStr(strTipoMate) = "3 PLAY") Then
                strTipoMate = "HFC"
                flTipiPLC = True
            ElseIf (Funciones.CheckStr(strTipoMate) = "3 PLAY INALAMBRICO") Then
                strTipoMate = "LTE"
                flTipiPLC = True
            ElseIf (Funciones.CheckStr(strTipoMate) = "CLARO TV SAT") Then
                strTipoMate = "DTH"
                flTipiPLC = True
            Else
                strTipoMate = Funciones.CheckStr(strTipoMate)
            End If


            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       OUT  CODRESPUESTA : " & strCodRpt)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       OUT  MSJRESPUESTA : " & strMsjRpt)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       OUT IDTRANSACCION : " & strIdTransac)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       OUT TIPOMATERIAL : " & strTipoMate)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       OUT CUSTOMER_ID : " & strCustomerId)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       END ACTUALIZAEQUIPOCONTRATOWS ")

            'OBJETO INTERACCION - DATOS ENTRADA TIPIFICACION_HFC 
            'DATOS PARA NOTAS
            If flTipiPLC Then
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - ==   Se tipifica producto PLC", strIdentifyLog))
                Dim equipo = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEV_DESCMATERIAL"))
                Dim strserie = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("SERIC_CODSERIE"))
                Dim costo = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEN_PRECIOVENTA"))

                Dim strNotas = "Ventas varios  Claro Hogar - Accesorio Fija  se procedió con la venta de un " + "Equipo: " + equipo + " con serie: " + strserie + " de costo: " + costo + "."

                Dim oInteraccionTipPrueba As New COM_SIC_Activaciones.InteraccionTipificacion



                'INICIA CARGA DE PARAMETROS DE BD PARA TIPIFICAR
                Dim dsMensajes As DataSet = (New COM_SIC_Cajas.clsCajas).ObtenerParamByGrupo(ConfigurationSettings.AppSettings("consGrupoTipiHFC"))
                If Not IsNothing(dsMensajes) Then
                    CargarInteraccion(dsMensajes.Tables(0), oInteraccionTipPrueba)
                End If
                 
                With oInteraccionTipPrueba
                    .TIPO = strTipoMate
                    .USUARIO_PROCESO = CurrentUser
                    .NOTAS = strNotas
                    .TELEFONO = "M" + strCustomerId
                End With

                'FINALIZA CARGA DE PARAMETROS DE BD PARA TIPIFICAR
                'DATOS PARA EL METODO

                Dim flagInter As String
                Dim mensajeInter As String
                Dim idInteraccion As String

                'SE REGISTRA EN EL LOG LOS DATOS DE ENTRADA
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     RegistroTipificacionFijaWS INI   ==")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN objidContacto : " & oInteraccionTipPrueba.OBJID_CONTACTO)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN SiteObjID : " & oInteraccionTipPrueba.OBJID_SITE)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN Cuenta : " & oInteraccionTipPrueba.CUENTA)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN Telefono : " & oInteraccionTipPrueba.TELEFONO)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN Tipo : " & oInteraccionTipPrueba.TIPO)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN Clase : " & oInteraccionTipPrueba.CLASE)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN SubClase : " & oInteraccionTipPrueba.SUBCLASE)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN MetodoContacto : " & oInteraccionTipPrueba.METODO_CONTACTO)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN TipoInteraccion : " & oInteraccionTipPrueba.TIPO_INTER)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN Agente : " & oInteraccionTipPrueba.AGENTE)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN Usuario_Proceso : " & oInteraccionTipPrueba.USUARIO_PROCESO)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN HechoenUno : " & oInteraccionTipPrueba.HECHO_EN_UNO)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN Notas : " & oInteraccionTipPrueba.NOTAS)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN FlagCaso : " & oInteraccionTipPrueba.FLAG_CASO)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       IN Resultado : " & oInteraccionTipPrueba.RESULTADO)

                'CREAR TIPIFICACION
                Dim Salidaa As String = objTipificacion.TipificarHFC(strIdTransaccion, oInteraccionTipPrueba)
                'DATOS DE SALIDA
                Dim arraysalida As String()
                arraysalida = Salidaa.Split(";")
                Dim strFlagInteraccion As String = arraysalida(0)
                Dim strIdtransaccTip As String = arraysalida(2)
                Dim strMensajeTip As String = arraysalida(1)

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       OUT  FlagInteraccion : " & strFlagInteraccion)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       OUT  IDTRANSACCION : " & strIdtransaccTip)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       OUT  MENSAJE RESPUESTA: " & strMensajeTip)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==       END RegistroTipificacionFijaWS ")
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - ==   Se finaliza tipificacion producto PLC", strIdentifyLog))
            Else
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - ==   No se tipifica producto PLC", strIdentifyLog))
            End If
        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==    OUT ERROR Tipificacion: " & ex.Message.ToString())
        Finally
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==   RegistrarTipificacion FIN   ==")
        End Try

    End Sub

    'PROY-31766'
    Public Function ObtenerIGVActual() As Double
        Dim objConsultaIGV As New COM_SIC_Activaciones.clsWConsultaIGV
        Dim strCodRpta As String = String.Empty
        Dim strMsgRpta As String = String.Empty
        Dim strIdentifyLog As String = Funciones.CheckStr(AppUsuario)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "== INICIO - Proceso Met. ObtenerIGVActual() ==")
        Dim constIGV As Double = objConsultaIGV.ObtenerIGV(strCodRpta, strMsgRpta)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==   idRespuesta:" & strCodRpta)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==   mensaje:" & strMsgRpta)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==   IGV:" & constIGV)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "== FIN - Proceso Met. ObtenerIGVActual() ==")
        Return constIGV
    End Function
    'PROY-31766'

    'PROY-27790 - Metodo que retornar los valores para la tipificaion HFC 
    Private Sub CargarInteraccion(ByVal tb As DataTable, ByRef Tipi As COM_SIC_Activaciones.InteraccionTipificacion)
        Dim strIdentifyLog As String = Funciones.CheckStr(AppUsuario)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     CargarInteraccion INI   ==")
        Tipi = New COM_SIC_Activaciones.InteraccionTipificacion
        Try


            For i As Integer = 0 To tb.Rows.Count - 1
                Dim dr As DataRow = tb.Rows(i)

                Select Case dr(1)
                    Case "consTransaccIntercionAsnycIdObjTip"
                        Tipi.OBJID_CONTACTO = Funciones.CheckStr(dr(2))
                    Case "consTransaccIntercionAsnycIdObjSiteTip"
                        Tipi.OBJID_SITE = Funciones.CheckStr(dr(2))
                    Case "consTransaccIntercionAsnycCuentaVentaVaria"
                        Tipi.CUENTA = Funciones.CheckStr(dr(2))
                    Case "consTransaccIntercionAsnycClaseVariacionVenta"
                        Tipi.CLASE = Funciones.CheckStr(dr(2))
                    Case "consTransaccIntercionAsnycSubClaseVentaVarios"
                        Tipi.SUBCLASE = Funciones.CheckStr(dr(2))
                    Case "consTransaccIntercionAsnycMetodoTip"
                        Tipi.METODO_CONTACTO = Funciones.CheckStr(dr(2))
                    Case "consTransaccIntercionAsnycTipoInterTip"
                        Tipi.TIPO_INTER = Funciones.CheckStr(dr(2))
                    Case "consTransaccIntercionAsnycUsuarioProcesoTip"
                        Tipi.AGENTE = Funciones.CheckStr(dr(2))
                    Case "consTransaccIntercionAsnycHechoEnUnoTip"
                        Tipi.HECHO_EN_UNO = Funciones.CheckStr(dr(2))
                    Case "consTransaccIntercionAsnycFlagCasoTip"
                        Tipi.FLAG_CASO = Funciones.CheckStr(dr(2))
                    Case "consTransaccIntercionAsnyctxtResultadoVentaVaria"
                        Tipi.RESULTADO = Funciones.CheckStr(dr(2))
                End Select


            Next


        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==    OUT ERROR CargarInteraccion: " & ex.Message.ToString())

        End Try

        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     CargarInteraccion FIN   ==")

    End Sub
   
    ' PROY-27790-IDEA-35384- Venta y Post venta de equipos PLC :: NGC - 08-06-2017
    'INC000000736080 - INICIO
    Public Function CalcularFechaTopeProgramacion(ByVal datos As String, ByVal strIdentifyLog As String) As String
        Dim fechaFact, fechaMig As String
        Dim ClicloFacturacion As String

        If Not (datos = "" Or datos = "1") Then
            ClicloFacturacion = Right("00" & Convert.ToInt32(datos), 2)
        End If

        Dim fchTope As String
        Dim diaTope As String = Right("00" & Convert.ToInt32(CheckInt(ClicloFacturacion) + 1), 2)
        fchTope = diaTope & "/" & Format(Date.Now, "MM/yyyy")

        Dim dia_next As String = Format(DateAdd(DateInterval.Day, 1, CDate(Date.Now)), "dd/MM/yyyy")
        Dim mes_next As String = ClicloFacturacion & "/" & Format(DateAdd(DateInterval.Month, CInt(ConfigurationSettings.AppSettings("CONS_FECHA_CONSULTA").ToString()), CDate(Date.Now)), "MM/yyyy")

        If ClicloFacturacion = "01" And dia_next = mes_next Then
            fechaFact = ClicloFacturacion & "/" & Format(DateAdd(DateInterval.Month, 2, Date.Now), "MM/yyyy")
        Else
            If CInt(ClicloFacturacion) - CInt(ConfigurationSettings.AppSettings("CONS_FECHA_CONSULTA").ToString()) > CInt(Format(Date.Now, "dd")) Then
                fechaFact = ClicloFacturacion & "/" & Format(Date.Now, "MM/yyyy")
                fchTope = diaTope & "/" & Format(Date.Now, "MM/yyyy")
            Else
                fechaFact = ClicloFacturacion & "/" & Format(DateAdd(DateInterval.Month, 1, Date.Now), "MM/yyyy")
                fchTope = diaTope & "/" & Format(DateAdd(DateInterval.Month, 1, Date.Now), "MM/yyyy")
            End If
        End If

	objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - Ciclo - " & ClicloFacturacion)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - fechaFact - " & fechaFact)
        fechaMig = Format(DateAdd(DateInterval.Day, -CheckInt(ConfigurationSettings.AppSettings("CONS_FECHA_CONSULTA").ToString()), Date.ParseExact(fechaFact, "dd/MM/yyyy", Nothing)), "dd/MM/yyyy")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " - fechaMig - " & fechaMig)

        Return fechaMig

    End Function
    'INC000000736080 - FIN

    'INC000000824753 - 25/07/2017 - NUEVO
    Private Function Obtener_CO_SER(ByVal strNroSec As Integer) As String

        Dim CodRespuesta As Integer = 0
        Dim obj As New COM_SIC_Cajas.clsCajas
        Dim sMsgRespuesta As String = ""
        Dim Respuesta As String = String.Empty
        Dim valor As Boolean = False
        Dim lista As ArrayList = New ArrayList
        objFileLog.Log_WriteLog(pathFile, strArchivo, CStr(AppUsuario) & " ------------------------------------")
        objFileLog.Log_WriteLog(pathFile, strArchivo, CStr(AppUsuario) & "       INICIO Obtener_CO_SER")
        objFileLog.Log_WriteLog(pathFile, strArchivo, CStr(AppUsuario) & " ------------------------------------")
        objFileLog.Log_WriteLog(pathFile, strArchivo, CStr(AppUsuario) & "- " & "strNroSec: " & strNroSec)
        Try
            lista = obj.Obtener_CO_SER(strNroSec, CodRespuesta, sMsgRespuesta) 'verificar

            If Not lista Is Nothing And lista.Count > 0 Then 'verificar
                 For Each item As String In lista
                    Respuesta += item & "|"
                 Next
            End If

            If Respuesta.Length > 0 Then
                Respuesta = Respuesta.Substring(0, Respuesta.Length - 1)
            End If

        Catch ex As Exception
			CodRespuesta = -2
			Respuesta = String.Empty
			sMsgRespuesta = ex.Message.ToString
			
		Finally
            objFileLog.Log_WriteLog(pathFile, strArchivo, CStr(AppUsuario) & "- " & "Pagina: Pagos\detaPago.aspx.vb")
            objFileLog.Log_WriteLog(pathFile, strArchivo, CStr(AppUsuario) & "- " & "Codigo respuesta: " & CodRespuesta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, CStr(AppUsuario) & "- " & "Respuesta: " & sMsgRespuesta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, CStr(AppUsuario) & "- " & "Cadena: " & Respuesta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, CStr(AppUsuario) & " ------------------------------------")
            objFileLog.Log_WriteLog(pathFile, strArchivo, CStr(AppUsuario) & "       FIN Obtener_CO_SER")
            objFileLog.Log_WriteLog(pathFile, strArchivo, CStr(AppUsuario) & " ------------------------------------")
            obj = Nothing
        End Try

        Return Respuesta
    End Function
    'PROY-26366-IDEA-34247 FASE 1 - INICIO
    Function Tipificaciones_general_VentasVarios(ByVal dsPedido As DataSet, ByVal Var_Correlativo6 As String)
	
        ' Creacion TIPIFICACION - INTERACCION
        Dim dsCliente As DataSet

        Dim objIdContacto As String
        Dim contactoId As Int64
        Dim nroDocCliente As String
        Dim nombreCliente As String
        Dim apellidoCliente As String
        Dim clarifyTelef As String
        Dim strEmpleado As String = AppstrUsuario
        Dim oInteraccion As New COM_SIC_INActChip.Interaccion
        Dim oPlantilla As New COM_SIC_INActChip.PlantillaInteraccion
        Dim dtConsultaCanje As DataSet
        Dim objclsConsultaMsSap As New COM_SIC_Activaciones.clsConsultaMsSap
        Dim vObClsTrsPvu As New COM_SIC_Activaciones.clsTrsPvu
        Dim ResultadoCLarify As String
        Dim VobClsClarify As New COM_SIC_Activaciones.clsClarify
        Dim oInteraccion_Clarify As New COM_SIC_Activaciones.clsDatosInteraccion
        Dim idWSClarify, MensajeWSClarify As String

        Dim flagInter As String
        Dim mensajeInter As String
        Dim idInteraccion As String
        Dim strParametros As String
        Dim strNroPedido As String
        '--IDENTIFICADOR DEL LOG :----
        Dim strIdentifyLog As String = "Tipificaciones - VENTAS VARIOS"
        Dim vCursorxIdPedidoActual As Object
        Dim vCodRpta As Integer
        Dim vMsjRpta As String
        Dim strMotivoCanje As String
        Dim StrTipoCliente As String
        Dim SrtTipoClientePre As String
        Dim StrTipoOperacion As String
        Dim strTipoProducto As String 
        'validar reno
        Try
            strNroPedido = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("PEDIN_NROPEDIDO"))
            SrtTipoClientePre = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("PEDIC_TIPOVENTA"))
            StrTipoOperacion = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("PEDIC_CODTIPOOPERACION"))
            strTipoProducto = Funciones.CheckStr(dsPedido.Tables(1).Rows(0)("MATEC_TIPOMATERIAL"))

            If StrTipoOperacion = ConfigurationSettings.AppSettings("COD_TIPO_OPERACION_VENTA_VARIOS") Then
                Dim i As Integer

                If dsPedido.Tables(1).Rows.Count > 0 Then
                    For i = 0 To dsPedido.Tables(1).Rows.Count - 1
                        clarifyTelef = Funciones.CheckStr(dsPedido.Tables(1).Rows(i)("DEPEV_NROTELEFONO"))
                        ' Cadena de Parametros
                        strParametros = ""
                        strParametros = strParametros & clarifyTelef & "|"
                        strParametros = strParametros & "" & "|"
                        strParametros = strParametros & "" & "|"
                        strParametros = strParametros & 1

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo ConsultaCliente()")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Parametros : " & strParametros)
                        ' Consulta de Id Cliente Clarify
                        Dim oTipificacion As New COM_SIC_INActChip.clsTipificacion
                        'PROY-26366 LOG - INI
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "clarifyTelef : " & clarifyTelef)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "contactoId : " & contactoId)
                        dsCliente = oTipificacion.ConsultaCliente(clarifyTelef, "", contactoId, CInt("1"), "", "")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "dsCliente : " & dsCliente.Tables(0).Rows.Count)
                        'PROY-26366 LOG - FIN
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo ConsultaCliente()")

                        If Not IsNothing(dsCliente) Then
                            If dsCliente.Tables(0).Rows.Count > 0 Then
                                objIdContacto = dsCliente.Tables(0).Rows(0).Item("OBJID_CONTACTO")
                                nroDocCliente = dsCliente.Tables(0).Rows(0).Item("NRO_DOC")
                                nombreCliente = dsCliente.Tables(0).Rows(0).Item("NOMBRES")
                                apellidoCliente = dsCliente.Tables(0).Rows(0).Item("APELLIDOS")

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Id Contacto: " & objIdContacto)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Nro Doc. Cliente: " & nroDocCliente)

                                strMotivoCanje = ""
                                StrTipoCliente = dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA").ToString()

                                Dim NroGrupoTipificacion As String

                                Dim IntNro As Integer = 3 
                                NroGrupoTipificacion = ConfigurationSettings.AppSettings("StrKeyTipificacionVentasVariasGeneral")

                                oInteraccion_Clarify.TELEFONO = clarifyTelef

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo consultarDatosUsuario()")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Parametros : " & oInteraccion_Clarify.TELEFONO.ToString())
                                ResultadoCLarify = VobClsClarify.consultarDatosUsuario(oInteraccion_Clarify, idWSClarify, MensajeWSClarify)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo consultarDatosUsuario()")

                                If ResultadoCLarify = "" Then
                                    StrTipoCliente = "02"
                                Else
                                    ResultadoCLarify = ResultadoCLarify.ToUpper()
                                    If (ResultadoCLarify.IndexOf("PREPAGO")) >= 0 Then
                                        StrTipoCliente = "02"
                                    Else
                                        StrTipoCliente = "01"
                                    End If

                                End If

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo DatosInteraccion_x_Operacion()")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Parametros : ")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo Producto : " & strTipoProducto)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo Cliente : " & StrTipoCliente)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Nro Grupo Tipificación : " & NroGrupoTipificacion)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Nro : " & IntNro)
                                oInteraccion = DatosInteraccion_x_Operacion(strTipoProducto, StrTipoCliente, NroGrupoTipificacion, IntNro)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo DatosInteraccion_x_Operacion()")

                                oInteraccion.AGENTE = strEmpleado
                                oInteraccion.OBJID_CONTACTO = objIdContacto
                                oInteraccion.TELEFONO = dsPedido.Tables(1).Rows(i).Item("DEPEV_NROTELEFONO")

                                Dim dsDatosVenta As New DataSet

                                Dim NroGrupoTipificacionGeneral As String
                                NroGrupoTipificacionGeneral = ConfigurationSettings.AppSettings("StrKeyTipificacionGeneral")

                                Dim DatosGenerales As String()
                                Dim StrValor As String = ""

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo ObtenerSISACT_Parametros()")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Parametro : ")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Nrop Grupo Tipificación : " & NroGrupoTipificacionGeneral)
                                dsDatosVenta = (New COM_SIC_Activaciones.clsConsultaPvu).ObtenerSISACT_Parametros(NroGrupoTipificacionGeneral)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo ObtenerSISACT_Parametros()")

                                If Not dsDatosVenta Is Nothing Then
                                    If dsDatosVenta.Tables(0).Rows.Count > 0 Then

                                        For Each item As DataRow In dsDatosVenta.Tables(0).Rows
                                            StrValor = Funciones.CheckStr(item("PARAV_VALOR"))
                                            DatosGenerales = StrValor.Split("|")

                                            oInteraccion.METODO = DatosGenerales(0)
                                            oInteraccion.TIPO_INTER = DatosGenerales(1)
                                            oInteraccion.USUARIO_PROCESO = "USRSICAR"
                                            oInteraccion.FLAG_CASO = DatosGenerales(3)
                                            oInteraccion.RESULTADO = DatosGenerales(4)
                                            oInteraccion.HECHO_EN_UNO = DatosGenerales(5)
                                            oInteraccion.Caso = DatosGenerales(6)

                                            'PROY-26366 LOG - INI
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "METODO: " & oInteraccion.METODO)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "TIPO_INTER: " & oInteraccion.TIPO_INTER)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "USUARIO_PROCESO: " & oInteraccion.USUARIO_PROCESO)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FLAG_CASO: " & oInteraccion.FLAG_CASO)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "RESULTADO: " & oInteraccion.RESULTADO)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "HECHO_EN_UNO: " & oInteraccion.HECHO_EN_UNO)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Caso: " & oInteraccion.Caso)
                                            'PROY-26366 LOG - FIN
                                            Exit For
                                        Next
                                    End If
                                End If

                                Dim StrNotas As String = ""
                                Dim DsPedidoOrigen As DataSet
                                Dim vCursorxSeriTipoNum As Object
                                Dim vNumLog As String
                                Dim vDesLog As String
                                Dim vNumPedidoOriginal As String
                                Dim strNroContrato As String
                                Dim DsContrato As DataSet
                                Dim objClsConsultaPvu As New COM_SIC_Activaciones.clsConsultaPvu
                                Dim P_COD_RESP As String = ""
                                Dim P_MSG_RESP As String = ""

                                ' PARAMETROS DE RETORNO DE CONSULTA PEDIDO PVU
                                Dim P_CODIGO_RESPUESTA As String = ""
                                Dim P_MENSAJE_RESPUESTA As String = ""
                                Dim C_VENTA As DataTable
                                Dim C_VENTA_DET As DataTable

                                Dim K_COD_RESPUESTA As String
                                Dim K_MSJ_RESPUESTA As String
                                Dim K_ID_TRANSACCION As String

                                Dim p_limpiador As Integer = 0
                                Dim C_VENTA_Prepago As DataSet

                                'FIN PARAMETROS DE RETORNO DE CONSULTA PEDIDO PVU

                                Dim StrCampana As String = ""
                                Dim StrPlan As String = ""
                                Dim StrNroConstrato As String = ""
                                Dim StrNroReclamoResolucion As String = "" 
                                Dim StrPedido As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("PEDIN_NROPEDIDO"))
                                Dim strDesTipOpe As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("PEDIV_DESCTIPOOPERACION"))
                                Dim sTipoOperacion As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION"))
                                Dim sTipoVenta As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA"))

                                Dim StrNombreCliente As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("CLIEV_NOMBRE"))
                                Dim dFecha As Date
                                dFecha = CDate(dsPedido.Tables(0).Rows(0).Item("PEDID_FECHADOCUMENTO"))
                                Dim StrFechaVenta As String = dFecha.ToString("dd/MM/yyyy")

                                Dim StrTipoDoc As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("CLIEC_TIPODOCCLIENTE"))
                                Dim strTipoDocDes As String
                                Try
                                    Dim objConsultaPvu As New COM_SIC_Activaciones.clsConsultaPvu
                                    Dim dsTipDoc As DataSet
                                    Dim item As Integer
                                    dsTipDoc = objConsultaPvu.ConsultaTipoDocumento("")
                                    For Each row As DataRow In dsTipDoc.Tables(0).Rows
                                        If row("TDOCC_CODIGO") = StrTipoDoc Then
                                            strTipoDocDes = row("TDOCV_DESCRIPCION")
                                            Exit For
                                        End If
                                    Next

                                Catch ex As Exception
                                    If StrTipoDoc.Equals("01") Then
                                        strTipoDocDes = "DNI"
                                    Else
                                        If StrTipoDoc.Equals("02") Then
                                            strTipoDocDes = "CIP"
                                        Else
                                            If StrTipoDoc.Equals("04") Then
                                                strTipoDocDes = "CE"
                                            Else
                                                If StrTipoDoc.Equals("06") Then
                                                    strTipoDocDes = "RUC"
                                                Else
                                                    If StrTipoDoc.Equals("07") Then
                                                        strTipoDocDes = "PASAPORTE"
                                                    Else
                                                        strTipoDocDes = "DNI"
                                                    End If
                                                End If
                                            End If
                                        End If
                                    End If
                                End Try

                                Dim StrNroDoc As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("CLIEV_NRODOCCLIENTE"))
                                Dim strNroLinea As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(i)("DEPEV_NROTELEFONO"))
                                Dim StrMaterial As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(i)("DEPEV_DESCMATERIAL"))
                
                                Dim StrPrecioVenta As String = Math.Round(Funciones.CheckDbl(dsPedido.Tables(1).Rows(0)("DEPEN_PRECIOVENTA")), 2)
                                Dim StrListaPrecios As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(i)("DEPEV_DESCRIPCIONLP"))

                                Dim StrPromocion As String = "" 
                                Dim strOficina As String = AppAlmacen

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo ConsultaPuntoVentaTipi()")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Parametro : ")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Oficina : " & strOficina)
                                Dim StrPunto_Venta As String = ConsultaPuntoVentaTipi(strOficina)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo ConsultaPuntoVentaTipi()")

                                Dim blnConsultaDetPedido As Boolean = False
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo ConsultaDetPedido()")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Parametro : ")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Nro Pedido : " & strNroPedido)
                                blnConsultaDetPedido = ConsultaDetPedido(strNroPedido, StrCampana, StrPromocion)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo ConsultaDetPedido()")

                                If (blnConsultaDetPedido = False) Then
                                    StrCampana = ""
                                    StrPromocion = ""
                                End If

                                StrNotas = StrNotas & "NOMBRE DEL CLIENTE : " & StrNombreCliente & vbCrLf
                                StrNotas = StrNotas & "TIPO DE DOC. DE IDENTIDAD : " & strTipoDocDes & vbCrLf
                                StrNotas = StrNotas & "NRO. DE DOC. DE IDENTIDAD : " & StrNroDoc & vbCrLf
                                StrNotas = StrNotas & "FECHA DE VENTA : " & StrFechaVenta & vbCrLf
                                StrNotas = StrNotas & "NRO. DE LINEA : " & strNroLinea & vbCrLf
                                StrNotas = StrNotas & "CAMPAÑA : " & StrCampana & vbCrLf
                                StrNotas = StrNotas & "PROMOCIÓN : " & StrPromocion & vbCrLf
                                StrNotas = StrNotas & "DESCRIPCIÓN DEL MATERIAL : " & StrMaterial & vbCrLf
                                StrNotas = StrNotas & "LISTA DE PRECIOS : " & StrListaPrecios & vbCrLf
                                StrNotas = StrNotas & "COSTO : " & StrPrecioVenta & vbCrLf
                                StrNotas = StrNotas & "PUNTO DE VENTA : " & StrPunto_Venta & vbCrLf
                                StrNotas = StrNotas & "USUARIO : " & strEmpleado & vbCrLf

                                oInteraccion.NOTAS = StrNotas

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo CrearInteraccion()")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "oInteraccion: " & oInteraccion.NOTAS) 'PROY-26366 LOG
                                oTipificacion.CrearInteraccion(oInteraccion, idInteraccion, flagInter, mensajeInter)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Id Interaccion : " & idInteraccion)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Flag Metodo : " & flagInter)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje : " & mensajeInter)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo CrearInteraccion()")

                                i = i + i

                                If Trim(flagInter) = "OK" Then

                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo CrearInteraccionDetalle()")
                                    oInteraccion.ID_INTERACCION = idInteraccion
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "oInteraccion: " & oInteraccion.NOTAS) 'PROY-26366 LOG
                                    oTipificacion.CrearInteraccionDetalle(oInteraccion, idInteraccion, flagInter, mensajeInter)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Id Interaccion : " & idInteraccion)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Flag Metodo : " & flagInter)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje : " & mensajeInter)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo CrearInteraccionDetalle()")
                                End If
                            End If

                        Else
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error. Cliente no existe en Clarify. No pudo realizar la creacion de la Interaccion.")
                        End If
                    Next
                End If
            End If
        Catch ex As Exception

        End Try
    End Function

    Function Tipificaciones_general_renovacionPre(ByVal dsPedido As DataSet, ByVal Var_Correlativo6 As String)

        ' Creacion TIPIFICACION - INTERACCION
        Dim dsCliente As DataSet
        '--IDENTIFICADOR DEL LOG :-----------------------------------------------------------------------------------------------------------------------------------------------------------------
        Dim strIdentifyLog As String = "Tipificaciones - RENOVACION PREPAGO"
        '-------------------------------------------------------------------------------------------------------------------------------------------------------------------

        Dim objIdContacto As String
        Dim contactoId As Int64
        Dim nroDocCliente As String
        Dim nombreCliente As String
        Dim apellidoCliente As String
        Dim clarifyTelef As String
        Dim strEmpleado As String = AppstrUsuario
        Dim oInteraccion As New COM_SIC_INActChip.Interaccion
        Dim oPlantilla As New COM_SIC_INActChip.PlantillaInteraccion
        Dim dtConsultaCanje As DataSet
        Dim objclsConsultaMsSap As New COM_SIC_Activaciones.clsConsultaMsSap
        Dim vObClsTrsPvu As New COM_SIC_Activaciones.clsTrsPvu

        Dim flagInter As String
        Dim mensajeInter As String
        Dim idInteraccion As String
        Dim strParametros As String
        Dim strNroPedido As String
        '--IDENTIFICADOR DEL LOG :-----------------------------------------------------------------------------------------------------------------------------------------------------------------
        strIdentifyLog = "Tipificaciones"
        '-------------------------------------------------------------------------------------------------------------------------------------------------------------------
        Dim vCursorxIdPedidoActual As Object
        Dim vCodRpta As Integer
        Dim vMsjRpta As String
        Dim strMotivoCanje As String
        Dim StrTipoCliente As String
        Dim SrtTipoClientePre As String
        Dim StrTipoOperacion As String

        'validar reno
        Try
            strNroPedido = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("PEDIN_NROPEDIDO"))
            SrtTipoClientePre = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("PEDIC_TIPOVENTA"))
            StrTipoOperacion = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("PEDIC_CODTIPOOPERACION"))
            clarifyTelef = Funciones.CheckStr(dsPedido.Tables(1).Rows(0)("DEPEV_NROTELEFONO"))

            If SrtTipoClientePre = ConfigurationSettings.AppSettings("strTVPrepago") Then
                If StrTipoOperacion = ConfigurationSettings.AppSettings("COD_OPERACION_RENOVACION") Then

                    ' Cadena de Parametros
                    strParametros = ""
                    strParametros = strParametros & clarifyTelef & "|"
                    strParametros = strParametros & "" & "|"
                    strParametros = strParametros & "" & "|"
                    strParametros = strParametros & 1

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo ConsultaCliente()")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Parametros : " & strParametros)
                    'PROY-26366 LOG -  INI
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "clarifyTelef: " & clarifyTelef)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "contactoId: " & contactoId)

                    ' Consulta de Id Cliente Clarify
                    Dim oTipificacion As New COM_SIC_INActChip.clsTipificacion
                    dsCliente = oTipificacion.ConsultaCliente(clarifyTelef, "", contactoId, CInt("1"), "", "")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "dsCliente: " & dsCliente.Tables(0).Rows.Count)
                    'PROY-26366 LOG -  FIN
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo ConsultaCliente()")

                    If Not IsNothing(dsCliente) Then
                        If dsCliente.Tables(0).Rows.Count > 0 Then
                            objIdContacto = dsCliente.Tables(0).Rows(0).Item("OBJID_CONTACTO")
                            nroDocCliente = dsCliente.Tables(0).Rows(0).Item("NRO_DOC")
                            nombreCliente = dsCliente.Tables(0).Rows(0).Item("NOMBRES")
                            apellidoCliente = dsCliente.Tables(0).Rows(0).Item("APELLIDOS")

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Id Contacto: " & objIdContacto)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Nro Doc. Cliente: " & nroDocCliente)
                            strMotivoCanje = ""
                            StrTipoCliente = dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA").ToString()

                            Dim NroGrupoTipificacionreno As String
                            Dim IntNro As Integer = 2 
                            NroGrupoTipificacionreno = ConfigurationSettings.AppSettings("StrKeyTipificacionRenovacionGeneral") 

                            'PROY-26366 LOG - INI
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Método DatosInteraccion_x_Operacion()")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "strMotivoCanje: " & strMotivoCanje)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "StrTipoCliente: " & StrTipoCliente)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "NroGrupoTipificacionreno: " & NroGrupoTipificacionreno)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "StrTipoCliente: " & IntNro)
                            oInteraccion = DatosInteraccion_x_Operacion(strMotivoCanje, StrTipoCliente, NroGrupoTipificacionreno, IntNro)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "oInteraccion: " & oInteraccion.NOTAS)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo DatosInteraccion_x_Operacion()")
                            'PROY-26366 LOG - FIN

                            Dim dsDatosVenta As New DataSet
                            Dim NroGrupoTipificacion As String
                            NroGrupoTipificacion = ConfigurationSettings.AppSettings("StrKeyTipificacionGeneral")

                            Dim DatosGenerales As String()
                            Dim StrValor As String = ""

                            dsDatosVenta = (New COM_SIC_Activaciones.clsConsultaPvu).ObtenerSISACT_Parametros(NroGrupoTipificacion)

                            If Not dsDatosVenta Is Nothing Then
                                If dsDatosVenta.Tables(0).Rows.Count > 0 Then

                                    For Each item As DataRow In dsDatosVenta.Tables(0).Rows
                                        StrValor = Funciones.CheckStr(item("PARAV_VALOR"))
                                        DatosGenerales = StrValor.Split("|")

                                        oInteraccion.METODO = DatosGenerales(0)
                                        oInteraccion.TIPO_INTER = DatosGenerales(1)
                                        oInteraccion.USUARIO_PROCESO = "USRSICAR"
                                        oInteraccion.FLAG_CASO = DatosGenerales(3)
                                        oInteraccion.RESULTADO = DatosGenerales(4)
                                        oInteraccion.HECHO_EN_UNO = DatosGenerales(5)

                                        'PROY-26366 LOG - INI
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "METODO: " & oInteraccion.METODO)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "TIPO_INTER: " & oInteraccion.TIPO_INTER)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "USUARIO_PROCESO: " & oInteraccion.USUARIO_PROCESO)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FLAG_CASO: " & oInteraccion.FLAG_CASO)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "RESULTADO: " & oInteraccion.RESULTADO)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "HECHO_EN_UNO: " & oInteraccion.HECHO_EN_UNO)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Caso: " & oInteraccion.Caso)
                                        'PROY-26366 LOG - FIN

                                        Exit For
                                    Next
                                End If

                            End If

                            oInteraccion.AGENTE = strEmpleado 
                            oInteraccion.OBJID_CONTACTO = objIdContacto
                            oInteraccion.TELEFONO = dsPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO")
                            Dim StrNotas As String = ""
                            Dim DsPedidoOrigen As DataSet

                            Dim vCursorxSeriTipoNum As Object
                            Dim vNumLog As String
                            Dim vDesLog As String
                            Dim vNumPedidoOriginal As String
                            Dim strNroContrato As String
                            Dim DsContrato As DataSet
                            Dim objClsConsultaPvu As New COM_SIC_Activaciones.clsConsultaPvu
                            Dim P_COD_RESP As String = ""
                            Dim P_MSG_RESP As String = ""

                            ' PARAMETROS DE RETORNO DE CONSULTA PEDIDO PVU
                            Dim P_CODIGO_RESPUESTA As String = ""
                            Dim P_MENSAJE_RESPUESTA As String = ""
                            Dim C_VENTA As DataTable
                            Dim C_VENTA_DET As DataTable

                            Dim K_COD_RESPUESTA As String
                            Dim K_MSJ_RESPUESTA As String
                            Dim K_ID_TRANSACCION As String

                            Dim p_limpiador As Integer = 0
                            Dim C_VENTA_Prepago As DataSet

                            'FIN PARAMETROS DE RETORNO DE CONSULTA PEDIDO PVU
                           Dim StrCampana As String = ""
                            Dim StrPromocion As String = ""
                            Dim StrPlan As String = ""
                            Dim StrNroConstrato As String = ""
                            Dim StrNroReclamoResolucion As String = "" 
                            Dim StrPedido As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("PEDIN_NROPEDIDO"))
                            Dim strDesTipOpe As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("PEDIV_DESCTIPOOPERACION"))
                            Dim sTipoOperacion As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION"))
                            Dim sTipoVenta As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA"))

                            If (sTipoVenta = ConfigurationSettings.AppSettings("strTVPrepago")) Then
                                'PREPAGO
                                StrNroConstrato = ""
                            End If

                            If sTipoVenta = ConfigurationSettings.AppSettings("strTVPrepago") Then
                                If sTipoOperacion = ConfigurationSettings.AppSettings("COD_OPERACION_ALTAyPORTABILIDAD") Then
                                    '*******************************************************************************************************
                                    'Consulta las siguientes Tablas.
                                    '**1. sisact_venta_prepago. 
                                    '**2. sisact_detalle_venta_prepago. 
                                    Try
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicia consulta datos Pedido Prepagos Alta y Portabilidad en PVU ")
                                        objClsConsultaPvu.ConsultarPedidosPrepago(vNumPedidoOriginal, P_CODIGO_RESPUESTA, P_MENSAJE_RESPUESTA, C_VENTA, C_VENTA_DET)

                                        StrCampana = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("DVPR_DES_CAMPANA"))
                                        StrPlan = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("DVPR_DES_PLAN")) 'PROY-26366
                                        StrPromocion = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("DVPR_DES_PROMOCION"))

                                        If P_MENSAJE_RESPUESTA <> "OK" Then
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  No se encontro el pedido en la tabla : sisact_info_venta_sap. pkg:sisact_pkg_venta sp:sp_con_venta_x_docsap => " & vNumPedidoOriginal)
                                        End If
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin consulta datos Pedido Prepagos Alta y Porta en PVU ")
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "P_MENSAJE_RESPUESTA: " & P_MENSAJE_RESPUESTA)
                                    Catch ex As Exception
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Error al ejecutar el sp: SP_CON_VENTA_PREPAGO , para el pedido => " & vNumPedidoOriginal)
                                        'INI PROY-140126
                                        Dim MaptPath As String
                                        MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                                        MaptPath = "( Class : " & MaptPath & "; Function: Tipificaciones_general_renovacionPre)"
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     Exception: " & ex.ToString() & MaptPath)
                                        'FIN PROY-140126

                                    End Try
                                Else
                                    'Consulta las siguientes Tablas.
                                    '**1. SISACT_VENTA_REPO_PRE.
                                    p_limpiador = 1
                                    Try
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicia consulta datos pedido Prepago diferentes a las Altas y Portabilidad en PVU")
                                        C_VENTA_Prepago = objClsConsultaPvu.ObtenerDatosVentaPrepago(vNumPedidoOriginal, P_MENSAJE_RESPUESTA)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin consulta datos pedido Prepago diferentes a las Altas y Portabilidad en PVU, P_MENSAJE_RESPUESTA :  " & P_MENSAJE_RESPUESTA)
                                    Catch ex As Exception
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Ingreso a EX : " & ex.Message.ToString())
                                    End Try
                                End If

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "p_limpiador :  " & p_limpiador)

                                If p_limpiador = 1 Then
                                    If Not C_VENTA_Prepago Is Nothing Then
                                        If C_VENTA_Prepago.Tables.Count > 0 Then
                                            If C_VENTA_Prepago.Tables(0).Rows.Count > 0 Then
                                                StrCampana = Funciones.CheckStr(C_VENTA_Prepago.Tables(0).Rows(0).Item("CAMPANIA_DES"))
                                                StrPlan = Funciones.CheckStr(C_VENTA_Prepago.Tables(0).Rows(0).Item("PLAN_TARIFARIO_DES"))
                                            End If
                                        End If
                                    End If
                                Else
                                    If Not C_VENTA_DET Is Nothing Then
                                        If C_VENTA_DET.Rows.Count > 0 Then


                                            StrCampana = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("DVPR_DES_CAMPANA"))
                                            StrPlan = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("DVPR_DES_PLAN")) 'PROY-26366
                                            StrPromocion = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("DVPR_DES_PROMOCION"))
                                        End If
                                    End If
                                End If

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "campania_Pre :  " & StrCampana)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "plan_pre :  " & StrPlan)

                            End If

                            Dim StrNombreCliente As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("CLIEV_NOMBRE"))
                            Dim dFecha As Date
                            dFecha = CDate(dsPedido.Tables(0).Rows(0).Item("PEDID_FECHADOCUMENTO"))
                            Dim StrFechaVenta As String = dFecha.ToString("dd/MM/yyyy")

                            Dim StrTipoDoc As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("CLIEC_TIPODOCCLIENTE"))
                            Dim strTipoDocDes As String

                            Try
                                Dim objConsultaPvu As New COM_SIC_Activaciones.clsConsultaPvu
                                Dim dsTipDoc As DataSet
                                Dim item As Integer
                                dsTipDoc = objConsultaPvu.ConsultaTipoDocumento("")
                                For Each row As DataRow In dsTipDoc.Tables(0).Rows
                                    If row("TDOCC_CODIGO") = StrTipoDoc Then
                                        strTipoDocDes = row("TDOCV_DESCRIPCION")
                                        Exit For
                                    End If
                                Next

                            Catch ex As Exception
                                If StrTipoDoc.Equals("01") Then
                                    strTipoDocDes = "DNI"
                                Else
                                    If StrTipoDoc.Equals("02") Then
                                        strTipoDocDes = "CIP"
                                    Else
                                        If StrTipoDoc.Equals("04") Then
                                            strTipoDocDes = "CE"
                                        Else
                                            If StrTipoDoc.Equals("06") Then
                                                strTipoDocDes = "RUC"
                                            Else
                                                If StrTipoDoc.Equals("07") Then
                                                    strTipoDocDes = "PASAPORTE"
                                                Else
                                                    strTipoDocDes = "DNI"
                                                End If
                                            End If
                                        End If
                                    End If
                                End If
                            End Try


                            Dim StrNroDoc As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("CLIEV_NRODOCCLIENTE"))
                            Dim strNroLinea As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(0)("DEPEV_NROTELEFONO"))
                            Dim StrMaterial As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(0)("DEPEV_DESCMATERIAL"))
                            Dim StrImeiVendido As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(0)("SERIC_CODSERIE"))
                            Dim StrModeloVendido As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(0)("DEPEV_DESCMATERIAL"))
                            Dim StrPrecioVenta As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(0)("DEPEN_PRECIOVENTA"))
                            Dim StrPrecio_Prepago As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(0)("DEPEN_PRECIOVENTA"))
                            Dim StrListaPrecios As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(0)("DEPEV_DESCRIPCIONLP"))

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   Inicio ConsultarClaroPuntosCanje: [IN Doc SAP" & strNroPedido & "]")
                            Dim objCajas As New COM_SIC_Cajas.clsCajas
                            Dim n_ClaroPuntosUti, n_DctoSoles As String
                            Dim result As String = objCajas.ConsultarClaroPuntosCanje(strNroPedido)
                            Dim rs As String() = result.Split(New Char() {","})

                            If rs(0) = "" Then
                                n_ClaroPuntosUti = "0"
                            Else
                                n_ClaroPuntosUti = rs(0)
                            End If

                            If rs(1) = "" Then
                                n_DctoSoles = "0"
                            Else
                                n_DctoSoles = rs(1)
                            End If

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "   Fin ConsultarClaroPuntosCanje: [OUT result: " & n_ClaroPuntosUti & ", " & n_DctoSoles & "]")

                            Dim StrDescuentoClaroPuntos As String = n_ClaroPuntosUti
                            Dim StrDescuentoEquipo As String = n_DctoSoles

                            Dim strOficina As String = AppAlmacen
                            Dim StrPunto_Venta As String = ConsultaPuntoVentaTipi(strOficina)

                            StrNotas = StrNotas & "NOMBRE DEL CLIENTE: " & StrNombreCliente & vbCrLf
                            StrNotas = StrNotas & "TIPO DE DOC. DE IDENTIDAD: " & strTipoDocDes & vbCrLf
                            StrNotas = StrNotas & "NRO. DOC. DE IDENTIDAD: " & StrNroDoc & vbCrLf
                            StrNotas = StrNotas & "FECHA DE VENTA : " & StrFechaVenta & vbCrLf
                            StrNotas = StrNotas & "NRO DE LINEA: " & strNroLinea & vbCrLf
                            StrNotas = StrNotas & "CAMPAÑA : " & StrCampana & vbCrLf
                            StrNotas = StrNotas & "PROMOCIÓN : " & StrPromocion & vbCrLf
                            StrNotas = StrNotas & "DESCRIPCIÓN DEL MATERIAL: " & StrMaterial & vbCrLf
                            StrNotas = StrNotas & "LISTA DE PRECIOS : " & StrListaPrecios & vbCrLf
                            StrNotas = StrNotas & "DESCUENTO DE CLARO PUNTOS : " & StrDescuentoClaroPuntos & vbCrLf
                            StrNotas = StrNotas & "DESCUENTO DE EQUIPO : " & StrDescuentoEquipo & vbCrLf
                            StrNotas = StrNotas & "IMEI VENDIDO : " & StrImeiVendido & vbCrLf
                            StrNotas = StrNotas & "MODELO VENDIDO : " & StrModeloVendido & vbCrLf
                            StrNotas = StrNotas & "PUNTO DE VENTA : " & StrPunto_Venta & vbCrLf
                            StrNotas = StrNotas & "USUARIO : " & strEmpleado & vbCrLf

                            oInteraccion.NOTAS = StrNotas

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo CrearInteraccion()")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "oInteraccion: " & oInteraccion.NOTAS) 'PROY-26366 LOG
                            oTipificacion.CrearInteraccion(oInteraccion, idInteraccion, flagInter, mensajeInter)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Id Interaccion : " & idInteraccion)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Flag Metodo : " & flagInter)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje : " & mensajeInter)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo CrearInteraccion()")

                            If Trim(flagInter) = "OK" Then
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo CrearInteraccion OK")
                            End If
                        End If

                    Else
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error. Cliente no existe en Clarify. No pudo realizar la creacion de la Interaccion.")
                    End If

                End If
            End If
        Catch ex As Exception
        End Try
    End Function
	
    Function Tipificaciones_general_canje(ByVal dsPedido As DataSet, ByVal Var_Correlativo6 As String)

        ' Creacion TIPIFICACION - INTERACCION
        Dim dsCliente As DataSet

        Dim objIdContacto As String
        Dim contactoId As Int64
        Dim nroDocCliente As String
        Dim nombreCliente As String
        Dim apellidoCliente As String
        Dim clarifyTelef As String
        Dim strEmpleado As String = AppstrUsuario
        Dim oInteraccion As New COM_SIC_INActChip.Interaccion
        Dim oInteraccion_Clarify As New COM_SIC_Activaciones.clsDatosInteraccion
        Dim oPlantilla As New COM_SIC_INActChip.PlantillaInteraccion
        Dim dtConsultaCanje As DataSet
        Dim objclsConsultaMsSap As New COM_SIC_Activaciones.clsConsultaMsSap
        Dim vObClsTrsPvu As New COM_SIC_Activaciones.clsTrsPvu
        Dim VobClsClarify As New COM_SIC_Activaciones.clsClarify
        Dim ResultadoCLarify As String
        Dim TipoVentaClarify As String
        Dim idWSClarify, MensajeWSClarify As String


        Dim flagInter As String
        Dim mensajeInter As String
        Dim idInteraccion As String
        Dim strParametros As String
        Dim strNroPedido As String
        '--IDENTIFICADOR DEL LOG :-----------------------------------------------------------------------------------------------------------------------------------------------------------------
        Dim strIdentifyLog As String = "Tipificaciones - CANJES "
        '-------------------------------------------------------------------------------------------------------------------------------------------------------------------
        Dim vCursorxIdPedidoActual As Object
        Dim vCodRpta As Integer
        Dim vMsjRpta As String
        Dim strMotivoCanje As String
        Dim StrTipoCliente As String
        Dim StrTipoOperacion As String
        'validar canje
        Try

            clarifyTelef = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO"))
            strNroPedido = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("PEDIN_NROPEDIDO"))
            StrTipoOperacion = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("PEDIC_CODTIPOOPERACION"))

            If StrTipoOperacion = "20" Then
                Exit Function
            End If

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INICIO Metodo ConsultaEquipoCanje_XIdPedidoActual_2()")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp N_NRO_PEDIDO:" & strNroPedido)

            dtConsultaCanje = vObClsTrsPvu.ConsultaEquipoCanje_XIdPedidoActual_2(strNroPedido, vCursorxIdPedidoActual, vCodRpta, vMsjRpta)

            Dim StrModalidadVenta_valida As String = Funciones.CheckStr(dtConsultaCanje.Tables(0).Rows(0)("CANJV_TIPO_CANJE"))

            If StrModalidadVenta_valida <> "2" Then
                Exit Function
            End If

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out CU_CONSULTA_CANJE:" & vCursorxIdPedidoActual)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out Valor Cod Rspta:" & vCodRpta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out Valor Msj Respta:" & vMsjRpta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FIN Metodo ConsultaEquipoCanje_XIdPedidoActual_2()")

            If Not IsNothing(dtConsultaCanje) AndAlso dtConsultaCanje.Tables(0).Rows.Count > 0 Then

                ' Cadena de Parametros
                strParametros = ""
                strParametros = strParametros & clarifyTelef & "|"
                strParametros = strParametros & "" & "|"
                strParametros = strParametros & "" & "|"
                strParametros = strParametros & 1

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo ConsultaCliente()")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Parametros : " & strParametros)

                ' Consulta de Id Cliente Clarify
                Dim oTipificacion As New COM_SIC_INActChip.clsTipificacion
                'PROY-26366 LOG -  INI
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "clarifyTelef: " & clarifyTelef)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "contactoId: " & contactoId)
                dsCliente = oTipificacion.ConsultaCliente(clarifyTelef, "", contactoId, CInt("1"), "", "")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "dsCliente: " & dsCliente.Tables(0).Rows.Count)
                'PROY-26366 LOG -  FIN
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo ConsultaCliente()")

                If Not IsNothing(dsCliente) Then
                    If dsCliente.Tables(0).Rows.Count > 0 Then
                        objIdContacto = dsCliente.Tables(0).Rows(0).Item("OBJID_CONTACTO")
                        nroDocCliente = dsCliente.Tables(0).Rows(0).Item("NRO_DOC")
                        nombreCliente = dsCliente.Tables(0).Rows(0).Item("NOMBRES")
                        apellidoCliente = dsCliente.Tables(0).Rows(0).Item("APELLIDOS")

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Id Contacto: " & objIdContacto)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Nro Doc. Cliente: " & nroDocCliente)

                        strMotivoCanje = dtConsultaCanje.Tables(0).Rows(0).Item("CANJV_MOTIVO").ToString()

                        Dim NroGrupoTipificacion As String
                        Dim IntNro As Integer = 1 
                        NroGrupoTipificacion = ConfigurationSettings.AppSettings("StrKeyTipificacionCanjeGeneral") 

                        oInteraccion.AGENTE = strEmpleado
                        oInteraccion.OBJID_CONTACTO = objIdContacto
                        oInteraccion.TELEFONO = dsPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO")

                        oInteraccion_Clarify.TELEFONO = dsPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO")

                        ResultadoCLarify = VobClsClarify.consultarDatosUsuario(oInteraccion_Clarify, idWSClarify, MensajeWSClarify)

                        If ResultadoCLarify = "" Then
                            TipoVentaClarify = "00"
                        Else
                            ResultadoCLarify = ResultadoCLarify.ToUpper()
                            If (ResultadoCLarify.IndexOf("PREPAGO")) >= 0 Then
                                TipoVentaClarify = "02"
                            Else
                                TipoVentaClarify = "01"
                            End If

                        End If
                        StrTipoCliente = TipoVentaClarify
                        Dim dsDatosVenta As New DataSet
                        Dim NroGrupoTipificacionGeneral As String
                        NroGrupoTipificacionGeneral = ConfigurationSettings.AppSettings("StrKeyTipificacionGeneral")

                        Dim DatosGenerales As String()
                        Dim StrValor As String = ""

                        dsDatosVenta = (New COM_SIC_Activaciones.clsConsultaPvu).ObtenerSISACT_Parametros(NroGrupoTipificacionGeneral)

                        If Not dsDatosVenta Is Nothing Then
                            If dsDatosVenta.Tables(0).Rows.Count > 0 Then

                                For Each item As DataRow In dsDatosVenta.Tables(0).Rows
                                    StrValor = Funciones.CheckStr(item("PARAV_VALOR"))
                                    DatosGenerales = StrValor.Split("|")

                                    oInteraccion.METODO = DatosGenerales(0)
                                    oInteraccion.TIPO_INTER = DatosGenerales(1)
                                    oInteraccion.USUARIO_PROCESO = "USRSICAR"
                                    oInteraccion.FLAG_CASO = DatosGenerales(3)
                                    oInteraccion.RESULTADO = DatosGenerales(4)
                                    oInteraccion.HECHO_EN_UNO = DatosGenerales(5)
                                    oInteraccion.Caso = DatosGenerales(6)

                                    'PROY-26366 LOG - INI
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "METODO: " & oInteraccion.METODO)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "TIPO_INTER: " & oInteraccion.TIPO_INTER)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "USUARIO_PROCESO: " & oInteraccion.USUARIO_PROCESO)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FLAG_CASO: " & oInteraccion.FLAG_CASO)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "RESULTADO: " & oInteraccion.RESULTADO)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "HECHO_EN_UNO: " & oInteraccion.HECHO_EN_UNO)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Caso: " & oInteraccion.Caso)
                                    'PROY-26366 LOG - FIN
                                    Exit For
                                Next
                            End If
                        End If

                        Dim StrNotas As String = ""
                        Dim DsPedidoOrigen As DataSet
                        Dim vCursorxSeriTipoNum As Object
                        Dim vNumLog As String
                        Dim vDesLog As String
                        Dim vNumPedidoOriginal As String
                        Dim strNroContrato As String
                        Dim DsContrato As DataSet
                        Dim objClsConsultaPvu As New COM_SIC_Activaciones.clsConsultaPvu
                        Dim P_COD_RESP As String = ""
                        Dim P_MSG_RESP As String = ""

                        ' PARAMETROS DE RETORNO DE CONSULTA PEDIDO PVU
                        Dim P_CODIGO_RESPUESTA As String = ""
                        Dim P_MENSAJE_RESPUESTA As String = ""
                        Dim C_VENTA As DataTable
                        Dim C_VENTA_DET As DataTable

                        Dim K_COD_RESPUESTA As String
                        Dim K_MSJ_RESPUESTA As String
                        Dim K_ID_TRANSACCION As String

                        Dim p_limpiador As Integer = 0
                        Dim C_VENTA_Prepago As DataSet

                        'FIN PARAMETROS DE RETORNO DE CONSULTA PEDIDO PVU

                        Dim StrCampana As String = ""
                        Dim StrDescuentoEquipo As String = ""
                        Dim StrPlan As String = ""
                        Dim StrNroConstrato As String = ""
                        Dim StrNroReclamoResolucion As String = "" 
                        Dim StrPedido As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("PEDIN_NROPEDIDO"))
                        Dim strDesTipOpe As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("PEDIV_DESCTIPOOPERACION"))
                        Dim sTipoOperacion As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION"))
                        Dim sTipoVenta As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA"))

                        Dim vSerieMat As String = Funciones.CheckStr(dtConsultaCanje.Tables(0).Rows(0)("CANJV_ENT_SERIE_MAT"))
                        Dim vTipoDoc As String = Funciones.CheckStr(dtConsultaCanje.Tables(0).Rows(0).Item("CANJV_TIPODOCCLIENTE"))
                        Dim vNumDoc As String = Funciones.CheckStr(dtConsultaCanje.Tables(0).Rows(0).Item("CANJV_NRODOCCLIENTE"))
                        '************************************************************************************************************'
                        'CONSULTA PEDIDO Origen:
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INICIO Metodo ConsultaEquipoCanje_xSeriTipoNum_2()")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp K_SERIE:" & vSerieMat)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp K_NRO_DOC:" & vNumDoc)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp K_TIPO_DOC:" & vTipoDoc)

                        DsPedidoOrigen = vObClsTrsPvu.ConsultaEquipoCanje_xSeriTipoNum_2(vSerieMat, vTipoDoc, vNumDoc, vCursorxSeriTipoNum, vNumLog, vDesLog)

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out CU_CONSULTA_CANJE:" & vCursorxSeriTipoNum)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out Valor Cod Rspta:" & vNumLog)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out Valor Msj Respta:" & vDesLog)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FIN Metodo ConsultaEquipoCanje_xSeriTipoNum_2()")

                        If Not IsNothing(DsPedidoOrigen) AndAlso DsPedidoOrigen.Tables(0).Rows.Count > 0 Then
                            vNumPedidoOriginal = Funciones.CheckStr(DsPedidoOrigen.Tables(0).Rows(0).Item("PEDIN_NROPEDIDO")) ''NUEVO
                        Else
                            vNumPedidoOriginal = ""
                        End If

                        If (TipoVentaClarify = ConfigurationSettings.AppSettings("strTVPostpago")) Then
                            'POSTPAGO                        

                            'CONSULTA EL CONTRATO:
                            Try
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Obtener contrato.")
                                '
                                DsContrato = objClsConsultaPvu.ObtenerDrsap(vNumPedidoOriginal, P_COD_RESP, P_MSG_RESP)
                                '
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Contrato Obtenido: " & Funciones.CheckStr(DsContrato.Tables(0).Rows(0).Item("ID_CONTRATO")))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Contrato P_COD_RESP : " & Funciones.CheckStr(P_COD_RESP))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Contrato P_MSG_RESP : " & Funciones.CheckStr(P_MSG_RESP))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Obtener contrato.")
                                '
                                StrDescuentoEquipo = Funciones.CheckStr(DsContrato.Tables(1).Rows(0)("DESCUENTO"))
                                StrNroConstrato = Funciones.CheckStr(DsContrato.Tables(1).Rows(0)("ID_CONTRATO"))
                            Catch ex As Exception
                                '
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Error en obtener contrato :" & drPagos.Item("PEDIN_NROPEDIDO"))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Err." & ex.Message.ToString)
                                '
                            End Try
                            '************************************************************************************************************'
                        Else
                            'PREPAGO
                            StrDescuentoEquipo = ""
                            StrNroConstrato = ""

                        End If

                        If TipoVentaClarify = ConfigurationSettings.AppSettings("strTVPrepago") Then
                            '*******************************************************************************************************
                            'Consulta las siguientes Tablas.
                            '**1. sisact_venta_prepago. 
                            '**2. sisact_detalle_venta_prepago. 
                            Try
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicia consulta datos Pedido Prepagos Alta y Portabilidad en PVU ")
                                objClsConsultaPvu.ConsultarPedidosPrepago(vNumPedidoOriginal, P_CODIGO_RESPUESTA, P_MENSAJE_RESPUESTA, C_VENTA, C_VENTA_DET)

                                StrCampana = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("DVPR_DES_CAMPANA"))
                                StrPlan = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("DVPR_DES_PLAN")) 'PROY-26366

                                If P_MENSAJE_RESPUESTA <> "OK" Then
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  No se encontro el pedido en la tabla : sisact_info_venta_sap. pkg:sisact_pkg_venta sp:sp_con_venta_x_docsap => " & vNumPedidoOriginal)
                                End If
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin consulta datos Pedido Prepagos Alta y Porta en PVU ")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "P_MENSAJE_RESPUESTA: " & P_MENSAJE_RESPUESTA)
                            Catch ex As Exception
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Error al ejecutar el sp: SP_CON_VENTA_PREPAGO , para el pedido => " & vNumPedidoOriginal)
                                'INI PROY-140126
                                Dim MaptPath As String
                                MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                                MaptPath = "( Class : " & MaptPath & "; Function: Tipificaciones_general_canje)"
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     Exception: " & ex.ToString() & MaptPath)
                                'FIN PROY-140126 

                            End Try

                            If StrCampana.Equals("") And StrPlan.Equals("") Then

                                'Consulta las siguientes Tablas.
                                '**1. SISACT_VENTA_REPO_PRE.
                                p_limpiador = 1
                                Try
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicia consulta datos pedido Prepago diferentes a las Altas y Portabilidad en PVU")
                                    C_VENTA_Prepago = objClsConsultaPvu.ObtenerDatosVentaPrepago(vNumPedidoOriginal, P_MENSAJE_RESPUESTA)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin consulta datos pedido Prepago diferentes a las Altas y Portabilidad en PVU, P_MENSAJE_RESPUESTA :  " & P_MENSAJE_RESPUESTA)
                                Catch ex As Exception
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Ingreso a EX : " & ex.Message.ToString())
                                End Try
                            End If

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "p_limpiador :  " & p_limpiador)

                            If p_limpiador = 1 Then
                                If Not C_VENTA_Prepago Is Nothing Then
                                    If C_VENTA_Prepago.Tables.Count > 0 Then
                                        If C_VENTA_Prepago.Tables(0).Rows.Count > 0 Then
                                            StrCampana = Funciones.CheckStr(C_VENTA_Prepago.Tables(0).Rows(0).Item("CAMPANIA_DES"))
                                            StrPlan = Funciones.CheckStr(C_VENTA_Prepago.Tables(0).Rows(0).Item("PLAN_TARIFARIO_DES"))

                                        End If
                                    End If
                                End If
                            Else
                                If Not C_VENTA_DET Is Nothing Then
                                    If C_VENTA_DET.Rows.Count > 0 Then

                                        StrCampana = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("DVPR_DES_CAMPANA"))
                                        StrPlan = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("DVPR_DES_PLAN")) 'PROY-26366

                                    End If
                                End If
                            End If

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "campania_Pre :  " & StrCampana)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "plan_pre :  " & StrPlan)

                        Else
                            '*******************************************************************************************************
                            '**1. sisact_info_venta_sap => consulta con el numero de pedido(nro_documento), retorna el n_id_venta.
                            '**2. sisact_ap_venta v / sisact_ap_contrato, donde  v.id_documento=n_id_venta => c_venta
                            '**3. sisact_ap_venta_detalle vd => vd.id_documento = n_id_venta => c_venta_det  
                            Try
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicia consulta datos Pedido PostPsgo en PVU ")
                                objClsConsultaPvu.ConsultarPedidosPVU(vNumPedidoOriginal, _
                                                                              P_CODIGO_RESPUESTA, _
                                                                              P_MENSAJE_RESPUESTA, _
                                                                              C_VENTA, _
                                                                              C_VENTA_DET)

                                If P_MENSAJE_RESPUESTA <> "OK" Then
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  No se encontro el pedido en la tabla : sisact_info_venta_sap. pkg:sisact_pkg_venta sp:sp_con_venta_x_docsap => " & vNumPedidoOriginal)
                                End If

                                If Not C_VENTA_DET Is Nothing Then
                                    If C_VENTA_DET.Rows.Count > 0 Then

                                        StrCampana = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("campana_desc"))
                                        StrPlan = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("plan_desc"))

                                    End If
                                End If

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "campania_Post :  " & StrCampana)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "plan_post :  " & StrPlan)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin consulta datos Pedido PostPsgo en PVU")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "P_MENSAJE_RESPUESTA: " & P_MENSAJE_RESPUESTA)
                            Catch ex As Exception
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Error al ejecutar el sp: SP_CON_VENTA_X_DOCSAP , para el pedido => " & vNumPedidoOriginal)
                                'INI PROY-140126
                                Dim MaptPath As String
                                MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                                MaptPath = "( Class : " & MaptPath & "; Function: Tipificaciones_general_canje)"
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     Exception: " & ex.ToString() & MaptPath)
                                'FIN PROY-140126 

                            End Try
                            '*******************************************************************************************************
                        End If

                        Try
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicia consulta datos Pedido PostPsgo en PVU Pedido Devol")
                            objClsConsultaPvu.ConsultarPedidosPVU(StrPedido, _
                                                                          P_CODIGO_RESPUESTA, _
                                                                          P_MENSAJE_RESPUESTA, _
                                                                          C_VENTA, _
                                                                          C_VENTA_DET)

                            If P_MENSAJE_RESPUESTA <> "OK" Then
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  No se encontro el pedido en la tabla : sisact_info_venta_sap. pkg:sisact_pkg_venta sp:sp_con_venta_x_docsap => " & drPagos.Item("PEDIN_NROPEDIDO"))
                            End If

                            If Not C_VENTA Is Nothing Then
                                If C_VENTA.Rows.Count > 0 Then
                                    StrNroReclamoResolucion = Funciones.CheckStr(C_VENTA.Rows(0).Item("observacion"))
                                End If
                            End If

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "StrNroReclamoResolucion :  " & StrNroReclamoResolucion)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin consulta datos Pedido PostPsgo en PVU")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "P_MENSAJE_RESPUESTA: " & P_MENSAJE_RESPUESTA)
                        Catch ex As Exception
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Error al ejecutar el sp: SP_CON_VENTA_X_DOCSAP , para el pedido => " & StrPedido)
                            'INI PROY-140126
                            Dim MaptPath As String
                            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                            MaptPath = "( Class : " & MaptPath & "; Function: Tipificaciones_general_canje)"
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     Exception: " & ex.ToString() & MaptPath)
                            'FIN PROY-140126 

                        End Try

                        Dim StrNombreCliente As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("CLIEV_NOMBRE"))
                        Dim dFecha As Date
                        dFecha = CDate(dsPedido.Tables(0).Rows(0).Item("PEDID_FECHADOCUMENTO"))
                        Dim StrFechaVenta As String = dFecha.ToString("dd/MM/yyyy")

                        Dim StrTipoDoc As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("CLIEC_TIPODOCCLIENTE"))
                        Dim StrNroDoc As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("CLIEV_NRODOCCLIENTE"))

                        Dim strTipoDocDes As String

                        'PROY-26366 TIPO DOC - INI
                        Try
                            Dim objConsultaPvu As New COM_SIC_Activaciones.clsConsultaPvu
                            Dim dsTipDoc As DataSet
                            Dim item As Integer
                            dsTipDoc = objConsultaPvu.ConsultaTipoDocumento("")
                            For Each row As DataRow In dsTipDoc.Tables(0).Rows
                                If row("TDOCC_CODIGO") = StrTipoDoc Then
                                    strTipoDocDes = row("TDOCV_DESCRIPCION")
                                    Exit For
                                End If
                            Next

                        Catch ex As Exception
                            If StrTipoDoc.Equals("01") Then
                                strTipoDocDes = "DNI"
                            Else
                                If StrTipoDoc.Equals("02") Then
                                    strTipoDocDes = "CIP"
                                Else
                                    If StrTipoDoc.Equals("04") Then
                                        strTipoDocDes = "CE"
                                    Else
                                        If StrTipoDoc.Equals("06") Then
                                            strTipoDocDes = "RUC"
                                        Else
                                            If StrTipoDoc.Equals("07") Then
                                                strTipoDocDes = "PASAPORTE"
                                            Else
                                                strTipoDocDes = "DNI"
                                            End If
                                        End If
                                    End If
                                End If
                            End If
                        End Try
                        'PROY-26366 TIPO DOC - FIN

                        Dim strNroLinea As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(0)("DEPEV_NROTELEFONO"))
                        Dim StrMaterial As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(0)("DEPEV_DESCMATERIAL"))
                        Dim StrImeiVendido As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(0)("SERIC_CODSERIE"))
                        Dim StrModeloVendido As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(0)("DEPEV_DESCMATERIAL"))
                        Dim StrPrecioVenta As String = Math.Round(Funciones.CheckDbl(dsPedido.Tables(1).Rows(0)("DEPEN_PRECIOVENTA")), 2)
                        Dim StrPrecio_Prepago As String = Math.Round(Funciones.CheckDbl(dsPedido.Tables(1).Rows(0)("DEPEN_PRECIOVENTA")), 2) '''CAMBIAR
                        Dim StrImei_Devolver As String = Funciones.CheckStr(dtConsultaCanje.Tables(0).Rows(0)("CANJV_ENT_SERIE_MAT"))
                        Dim StrModelo_Devolver As String = Funciones.CheckStr(dtConsultaCanje.Tables(0).Rows(0)("CANJV_ENT_COD_MAT"))
                        Dim StrImei_Nuevo As String = Funciones.CheckStr(dtConsultaCanje.Tables(0).Rows(0)("CANJV_SAL_SERIE_MAT"))
                        Dim StrModelo_Nuevo As String = Funciones.CheckStr(dtConsultaCanje.Tables(0).Rows(0)("CANJV_SAL_COD_MAT"))
                        Dim strOficina As String = AppAlmacen
                        Dim StrPunto_Venta As String = ConsultaPuntoVentaTipi(strOficina)
                        Dim PrecioPrepago As Decimal

                        Try
                            PrecioPrepago = (New COM_SIC_Activaciones.clsConsultaPvu).ObtenerPrecio_Prepago(StrModelo_Nuevo, ConfigurationSettings.AppSettings("LPprepago").ToString())
                            StrPrecio_Prepago = Math.Round(PrecioPrepago, 2)
                        Catch ex As Exception

                        End Try
                      

                        Dim StrListaPrecios As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(0)("DEPEV_DESCRIPCIONLP"))
                        Dim StrMotivoDevol As String = Funciones.CheckStr(dtConsultaCanje.Tables(0).Rows(0)("CANJV_MOTIVO"))
                        Dim dFechaDevol As Date
                        dFechaDevol = CDate(dtConsultaCanje.Tables(0).Rows(0).Item("CANJD_FEC_REG"))
                        Dim StrFechaDevol As String = dFechaDevol.ToString("dd/MM/yyyy")
                        Dim StrOst As String = Funciones.CheckStr(dtConsultaCanje.Tables(0).Rows(0)("CANJV_REFERENCIA"))
                        Dim DsMAterial_ As DataSet
                        Try
                            DsMAterial_ = objclsConsultaMsSap.ConsultaMaterial(StrModelo_Devolver)
                            StrModelo_Devolver = DsMAterial_.Tables(0).Rows(0)("MATEV_DESCMATERIAL")
                            DsMAterial_ = objclsConsultaMsSap.ConsultaMaterial(StrModelo_Nuevo)
                            StrModelo_Nuevo = DsMAterial_.Tables(0).Rows(0)("MATEV_DESCMATERIAL")
                        Catch ex As Exception
                            StrModelo_Devolver = Funciones.CheckStr(dtConsultaCanje.Tables(0).Rows(0)("CANJV_ENT_COD_MAT"))
                            StrModelo_Nuevo = Funciones.CheckStr(dtConsultaCanje.Tables(0).Rows(0)("CANJV_SAL_COD_MAT"))
                        End Try

                        Dim StrModalidadVenta As String = Funciones.CheckStr(dtConsultaCanje.Tables(0).Rows(0)("CANJV_TIPO_CANJE"))

                        If (StrModalidadVenta = "1") Then
                            StrModalidadVenta = "Canje de Gama  Similar"
                        Else
                            If (StrModalidadVenta = "2") Then
                                StrModalidadVenta = "Canje de Gama Superior"
                            Else
                                If (StrModalidadVenta = "3") Then
                                    StrModalidadVenta = "Devolucion de Efectivo"
                                End If
                            End If
                        End If

                        Dim StrNroDocRef As String = Var_Correlativo6
                        Dim StrPromocion As String = "" 
                        Dim dsDatosVenta2 As New DataSet

                        Dim DatosGenerales_ As String()
                        Dim DatosGenerales1 As String()
                        Dim DatosGenarales1_0 As String()
                        Dim DatosGenarales1_1 As String()
                        Dim DatosGenarales1_2 As String()
                        Dim DatosGenarales1_3 As String()
                        Dim StrValor1 As String = ""

                        dsDatosVenta2 = (New COM_SIC_Activaciones.clsConsultaPvu).ObtenerSISACT_Parametros(NroGrupoTipificacion)

                        If Not dsDatosVenta2 Is Nothing Then
                            If dsDatosVenta2.Tables(0).Rows.Count > 0 Then

                                If (IntNro = 1) Then
                                    For Each item As DataRow In dsDatosVenta2.Tables(0).Rows
                                        StrValor = Funciones.CheckStr(item("PARAV_VALOR"))
                                        StrValor1 = Funciones.CheckStr(item("PARAV_VALOR1"))

                                        DatosGenerales_ = StrValor.Split("|")
                                        DatosGenerales1 = StrValor1.Split("|")

                                        If (DatosGenerales_(0).Equals(StrTipoCliente)) Then

                                            If (DatosGenerales_(1).Equals(strMotivoCanje)) Then
                                                DatosGenarales1_0 = DatosGenerales1(0).Split(";")
                                                DatosGenarales1_1 = DatosGenerales1(1).Split(";")
                                                DatosGenarales1_2 = DatosGenerales1(2).Split(";")
                                                DatosGenarales1_3 = DatosGenerales1(3).Split(";")

                                                oInteraccion.TIPO_CODIGO = DatosGenarales1_0(0)
                                                oInteraccion.TIPO = DatosGenarales1_0(1)
                                                oInteraccion.CLASE_CODIGO = DatosGenarales1_1(0)
                                                oInteraccion.CLASE = DatosGenarales1_1(1)
                                                oInteraccion.SUBCLASE_CODIGO = DatosGenarales1_2(0)
                                                oInteraccion.SUBCLASE = DatosGenarales1_2(1)
                                                oInteraccion.SERVAFECT_CODE = DatosGenarales1_3(0)
                                                oInteraccion.SERVAFECT = DatosGenarales1_3(1)
                                                Exit For
                                            End If
                                        End If
                                    Next
                                Else
                                End If
                            End If
                        End If

                        StrMotivoDevol = oInteraccion.SERVAFECT

                        StrNotas = StrNotas & "NOMBRE DEL CLIENTE : " & StrNombreCliente & vbCrLf
                        StrNotas = StrNotas & "NUMERO DEL CONTRATO : " & StrNroConstrato & vbCrLf
                        StrNotas = StrNotas & "TIPO DE DOC. IDENTIDAD : " & strTipoDocDes & vbCrLf
                        StrNotas = StrNotas & "NRO. DOC. IDENTIDAD : " & StrNroDoc & vbCrLf
                        StrNotas = StrNotas & "FECHA DE VENTA : " & StrFechaVenta & vbCrLf
                        StrNotas = StrNotas & "NRO. DE LINEA : " & strNroLinea & vbCrLf
                        StrNotas = StrNotas & "MOTIVO DE DEVOLUCIÓN : " & StrMotivoDevol & vbCrLf
                        StrNotas = StrNotas & "FECHA DE DEVOLUCIÓN : " & StrFechaDevol & vbCrLf
                        StrNotas = StrNotas & "PRECIO DE VENTA : " & StrPrecioVenta & vbCrLf
                        StrNotas = StrNotas & "PRECIO PREPAGO : " & StrPrecio_Prepago & vbCrLf
                        StrNotas = StrNotas & "LISTA DE PRECIOS : " & StrListaPrecios & vbCrLf
                        StrNotas = StrNotas & "PLAN : " & StrPlan & vbCrLf
                        StrNotas = StrNotas & "MODALIDAD DE VENTA : " & StrModalidadVenta & vbCrLf
                        StrNotas = StrNotas & "NRO. DOC. REF. : " & StrNroDocRef & vbCrLf
                        StrNotas = StrNotas & "CAMPAÑA : " & StrCampana & vbCrLf
                        StrNotas = StrNotas & "OST : " & StrOst & vbCrLf
                        StrNotas = StrNotas & "NRO. RECLAMO\RESOLUCIÓN : " & StrNroReclamoResolucion & vbCrLf
                        StrNotas = StrNotas & "IMEI A DEVOLVER : " & StrImei_Devolver & vbCrLf
                        StrNotas = StrNotas & "MODELO A DEVOLVER : " & StrModelo_Devolver & vbCrLf
                        StrNotas = StrNotas & "IMEI DEL NUEVO EQUIPO : " & StrImei_Nuevo & vbCrLf
                        StrNotas = StrNotas & "MODELO DEL NUEVO EQUIPO : " & StrModelo_Nuevo & vbCrLf
                        StrNotas = StrNotas & "PUNTO DE VENTA : " & StrPunto_Venta & vbCrLf
                        StrNotas = StrNotas & "USUARIO : " & strEmpleado & vbCrLf

                        oInteraccion.NOTAS = StrNotas
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo CrearInteraccion()")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "oInteraccion: " & oInteraccion.NOTAS) 'PROY-26366 LOG
                        oTipificacion.CrearInteraccion(oInteraccion, idInteraccion, flagInter, mensajeInter)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Id Interaccion : " & idInteraccion)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Flag Metodo : " & flagInter)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje : " & mensajeInter)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo CrearInteraccion()")

                        If Trim(flagInter) = "OK" Then

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo CrearInteraccionDetalle()")
                            oInteraccion.ID_INTERACCION = idInteraccion
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "oInteraccion: " & oInteraccion.NOTAS) 'PROY-26366 LOG
                            oTipificacion.CrearInteraccionDetalle(oInteraccion, idInteraccion, flagInter, mensajeInter)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Id Interaccion : " & idInteraccion)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Flag Metodo : " & flagInter)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje : " & mensajeInter)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo CrearInteraccionDetalle()")
                        End If
                    Else
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error. Cliente no existe en Clarify. No pudo realizar la creacion de la Interaccion.")
                    End If
                End If
            End If
        Catch ex As Exception

        End Try
    End Function

    Public Function ConsultaDetPedido(ByVal P_OVENC_CODIGO As Int64, ByRef Var_Campana As String, ByRef Var_Promocion As String) As Boolean
        Dim strIdentifyLog As String = "Tipificaciones - VENTAS VARIOS"
        Dim blnConsultaDetPedido As Boolean = False
        Try

            Dim obj As New COM_SIC_Activaciones.clsConsultaMsSap
            Dim dsReturn As New DataSet
            dsReturn = obj.ConsultaDetPedido(P_OVENC_CODIGO)
            If dsReturn.Tables(0).Rows.Count > 0 Then
                Var_Campana = Funciones.CheckStr(dsReturn.Tables(0).Rows(0).Item("DEPEV_DES_CAMPANA")) 'jacosta
                Var_Promocion = Funciones.CheckStr(dsReturn.Tables(0).Rows(0).Item("DEPEV_DES_PROMOCION")) 'jacosta
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Consulta Detalle Adicional de una Venta Varia: ")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "PKG_CONSULTA.SSAPSS_PEDIDO_DET_ADD")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Campaña: " & Var_Campana)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Promoción: " & Var_Promocion)
                blnConsultaDetPedido = True
            Else
                Var_Campana = ""
                Var_Promocion = ""
                blnConsultaDetPedido = False
            End If

        Catch ex As Exception
            'INI PROY-140126
            Dim MaptPath As String
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: ConsultaDetPedido)"
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "== ERROR - Consulta Detalle Adicional de una Venta Varia: " & MaptPath)
            'FIN PROY-140126
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "PKG_CONSULTA.SSAPSS_PEDIDO_DET_ADD")
            'INI PROY-140126
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: ConsultaDetPedido)"
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "== Mensaje Exception: " & ex.Message.ToString() & MaptPath)
            'FIN PROY-140126

        End Try

        Return blnConsultaDetPedido
    End Function

    Private Function DatosInteraccion_x_Operacion(ByVal Strmotivo As String, ByVal StTipoCliente As String, ByVal NroGrupoTipificacion As String, ByVal IntNro As Integer) As Interaccion
        Dim dsDatosVenta As New DataSet
        Dim oInteraccion As New Interaccion

        Dim DatosGenerales As String()
        Dim DatosGenerales1 As String()
        Dim DatosGenarales1_0 As String()
        Dim DatosGenarales1_1 As String()
        Dim DatosGenarales1_2 As String()
        Dim DatosGenarales1_3 As String()
        Dim StrValor As String = ""
        Dim StrValor1 As String = ""

        dsDatosVenta = (New COM_SIC_Activaciones.clsConsultaPvu).ObtenerSISACT_Parametros(NroGrupoTipificacion)

        If Not dsDatosVenta Is Nothing Then
            If dsDatosVenta.Tables(0).Rows.Count > 0 Then

                If (IntNro = 1) Then
                    For Each item As DataRow In dsDatosVenta.Tables(0).Rows
                        StrValor = Funciones.CheckStr(item("PARAV_VALOR"))
                        StrValor1 = Funciones.CheckStr(item("PARAV_VALOR1"))

                        DatosGenerales = StrValor.Split("|")
                        DatosGenerales1 = StrValor1.Split("|")

                        If (DatosGenerales(0).Equals(StTipoCliente)) Then

                            If (DatosGenerales(1).Equals(Strmotivo)) Then
                                DatosGenarales1_0 = DatosGenerales1(0).Split(";")
                                DatosGenarales1_1 = DatosGenerales1(1).Split(";")
                                DatosGenarales1_2 = DatosGenerales1(2).Split(";")
                                DatosGenarales1_3 = DatosGenerales1(3).Split(";")

                                oInteraccion.TIPO_CODIGO = DatosGenarales1_0(0)
                                oInteraccion.TIPO = DatosGenarales1_0(1)
                                oInteraccion.CLASE_CODIGO = DatosGenarales1_1(0)
                                oInteraccion.CLASE = DatosGenarales1_1(1)
                                oInteraccion.SUBCLASE_CODIGO = DatosGenarales1_2(0)
                                oInteraccion.SUBCLASE = DatosGenarales1_2(1)
                                oInteraccion.SERVAFECT_CODE = DatosGenarales1_3(0)
                                oInteraccion.SERVAFECT = DatosGenarales1_3(1)
                                Exit For
                            End If
                        End If
                    Next
                Else
                    If IntNro = 2 Then
                        For Each item As DataRow In dsDatosVenta.Tables(0).Rows
                            StrValor = Funciones.CheckStr(item("PARAV_VALOR"))
                            StrValor1 = Funciones.CheckStr(item("PARAV_VALOR1"))

                            DatosGenerales1 = StrValor1.Split("|")
                            DatosGenarales1_0 = DatosGenerales1(0).Split(";")
                            DatosGenarales1_1 = DatosGenerales1(1).Split(";")
                            DatosGenarales1_2 = DatosGenerales1(2).Split(";")

                            oInteraccion.TIPO_CODIGO = DatosGenarales1_0(0)
                            oInteraccion.TIPO = DatosGenarales1_0(1)
                            oInteraccion.CLASE_CODIGO = DatosGenarales1_1(0)
                            oInteraccion.CLASE = DatosGenarales1_1(1)
                            oInteraccion.SUBCLASE_CODIGO = DatosGenarales1_2(0)
                            oInteraccion.SUBCLASE = DatosGenarales1_2(1)
                            Exit For
                        Next
                    Else
                        For Each item As DataRow In dsDatosVenta.Tables(0).Rows
                            StrValor = Funciones.CheckStr(item("PARAV_VALOR"))
                            StrValor1 = Funciones.CheckStr(item("PARAV_VALOR1"))

                            DatosGenerales = StrValor.Split("|")
                            DatosGenerales1 = StrValor1.Split("|")

                            If (DatosGenerales(0).Equals(StTipoCliente)) Then

                                If (DatosGenerales(1).Equals(Strmotivo)) Then
                                    DatosGenarales1_0 = DatosGenerales1(0).Split(";")
                                    DatosGenarales1_1 = DatosGenerales1(1).Split(";")
                                    DatosGenarales1_2 = DatosGenerales1(2).Split(";")
                                    DatosGenarales1_3 = DatosGenerales1(3).Split(";")

                                    oInteraccion.TIPO_CODIGO = DatosGenarales1_0(0)
                                    oInteraccion.TIPO = DatosGenarales1_0(1)
                                    oInteraccion.CLASE_CODIGO = DatosGenarales1_1(0)
                                    oInteraccion.CLASE = DatosGenarales1_1(1)
                                    oInteraccion.SUBCLASE_CODIGO = DatosGenarales1_2(0)
                                    oInteraccion.SUBCLASE = DatosGenarales1_2(1)
                                    oInteraccion.SERVAFECT_CODE = DatosGenarales1_3(0)
                                    oInteraccion.SERVAFECT = DatosGenarales1_3(1)
                                    Exit For
                                End If
                            End If
                        Next
                    End If
                End If
            End If
        End If
        Return oInteraccion
    End Function

    Private Function ConsultaPuntoVentaTipi(ByVal P_OVENC_CODIGO As String) As String
        Try
            Dim obj As New COM_SIC_Activaciones.clsConsultaMsSap
            Dim dsReturn As DataSet
            dsReturn = obj.ConsultaPuntoVenta(P_OVENC_CODIGO)
            If dsReturn.Tables(0).Rows.Count > 0 Then
                'PROY-26366 PUNTO VENTA CORRECION
                Return "CAC" & "-" & dsReturn.Tables(0).Rows(0).Item("OVENV_DESCRIPCION") & "-" & dsReturn.Tables(0).Rows(0).Item("OVENV_CODIGO_SINERGIA")
            End If
            Return Nothing
        Catch ex As Exception
            Return ""
        End Try
    End Function
    'PROY-26366-IDEA-34247 FASE 1 - FIN	

    ' INICIO|PROY-30162-IDEA-32487 ENVIO BOLETA ELECTRONICA PREPAGO //RGP_BOL_18
    Private Function CreateWebRequest() As HttpWebRequest
        HelperLog.EscribirLog("", "LogEnviarSMS.txt", "---Inicio CreateWebRequest ---", False)

        'Dim urlHP As String = ConfigurationSettings.AppSettings("RutaWS_GestionAcuerdo")
        Dim strIdentifyLog As String = CStr(AppUsuario) & " - " & drPagos.Item("PEDIN_NROPEDIDO")

        Dim urlHP As String = ConfigurationSettings.AppSettings("RutaWS_SmsWS")

        Dim Headers As String = ConfigurationSettings.AppSettings("WS_Headers")
        Dim ContentType As String = ConfigurationSettings.AppSettings("WS_ContentType")
        Dim Accept As String = ConfigurationSettings.AppSettings("WS_Accept")
        Dim Method As String = ConfigurationSettings.AppSettings("WS_Method")

        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Url Servicios SmS - " & urlHP)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " ContentType - " & ContentType)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Accept - " & Accept)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Method - " & Method)

        HelperLog.EscribirLog("", "LogGestionAcuerdoWS.txt", DateTime.Now.ToString("ddMMyyyyHHmmss") + "--->" + "CreateWebRequest --> URLWS:" + urlHP, False)

        Dim webRequest As HttpWebRequest = CType(webRequest.Create(urlHP), HttpWebRequest)

        webRequest.Headers.Add(Headers)

        webRequest.ContentType = ContentType
        webRequest.Accept = Accept
        webRequest.Method = Method
        webRequest.KeepAlive = False
        webRequest.ServicePoint.Expect100Continue = False
        webRequest.ProtocolVersion = HttpVersion.Version10

        Return webRequest

    End Function

    Private Function EnviarSMS( _
        ByVal usuarioaplicacion As String, _
        ByVal numeroTelefono As String, _
        ByVal mensaje As String, _
        ByVal fechaEnvio As DateTime) As BEEnviarMensajeResponse

        HelperLog.EscribirLog("", "LogSmsWS.txt", DateTime.Now.ToString("ddMMyyyyHHmmss") + "--->" + "Metodo: EnviarSMS: -->INPUT -->  Usuario:" + usuarioaplicacion + ", numeroTelefono:" + numeroTelefono + ", mensaje:" + mensaje + ", fechaEnvio:" + fechaEnvio.ToLongDateString(), False)

        Dim item As BEEnviarMensajeResponse = Nothing
        Dim lista As New ArrayList

        Try
            Dim strIdentifyLog As String = CStr(AppUsuario) & " - " & drPagos.Item("PEDIN_NROPEDIDO")
            Dim idTransaccion As String = DateTime.Now.ToString("yyyyMMddHHmmss")
            Dim ipAplicacion As String = ConfigurationSettings.AppSettings("CodigoAplicacion")
            Dim nombreAplicacion As String = ConfigurationSettings.AppSettings("constAplicacion")
            Dim identificadorMAS As String = ConfigurationSettings.AppSettings("SmsWS_identificadorMAS")
            Dim sender As String = ConfigurationSettings.AppSettings("SmsWS_sender")
            Dim campo As String = ConfigurationSettings.AppSettings("SmsWS_campo")
            Dim formato As String = ConfigurationSettings.AppSettings("SmsWS_formato")

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " -------------------------------------------------------- ")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " Inicio de MÃ©todo EnviarSMS ")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " Identificador Log - " & strIdentifyLog)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " ID TransacciÃ³n - " & idTransaccion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " IP AplicaciÃ³n - " & ipAplicacion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " Nombre AplicaciÃ³n - " & nombreAplicacion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " Identificador MAS - " & identificadorMAS)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " Variable Sender - " & sender)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " NRO Telefono - " & numeroTelefono)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " Fecha/Hora EnvÃ­o - " & fechaEnvio.ToString(formato))

            Dim request As HttpWebRequest = CreateWebRequest()

            request.Timeout = ConfigurationSettings.AppSettings("SmsWS_timeout")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " TimeOut - " & request.Timeout.ToString)

            Dim soapEnvelopeXml As New XmlDocument
            Dim sb As New StringBuilder

            sb.Append("<soapenv:Envelope xmlns:soapenv=""http://schemas.xmlsoap.org/soap/envelope/"" xmlns:typ=""http://claro.com.pe/eai/ws/smsws/types"" xmlns:bas=""http://claro.com.pe/eai/ws/baseschema"">")
            sb.Append("<soapenv:Header/>")
            sb.Append("<soapenv:Body>")
            sb.Append("<typ:enviarMensajeRequest>")
            sb.Append("<typ:auditRequest>")
            sb.Append("<bas:idTransaccion>" + idTransaccion + "</bas:idTransaccion>")
            sb.Append("<bas:ipAplicacion>" + ipAplicacion + "</bas:ipAplicacion>")
            sb.Append("<bas:aplicacion>" + nombreAplicacion + "</bas:aplicacion>")
            sb.Append("<bas:usrAplicacion>" + usuarioaplicacion + "</bas:usrAplicacion>")
            sb.Append("</typ:auditRequest>")
            sb.Append("<typ:identificadorMAS>" + identificadorMAS + "</typ:identificadorMAS>")
            sb.Append("<typ:msisdn>" + numeroTelefono + "</typ:msisdn>")
            sb.Append("<typ:mensaje>" + mensaje + "</typ:mensaje>")
            sb.Append("<typ:sender>" + sender + "</typ:sender>")
            sb.Append("<typ:listaRequestOpcional>")
            sb.Append("<!--1 or more repetitions:-->")
            sb.Append("<bas:requestOpcional campo=""" + campo + """ valor=""" + fechaEnvio.ToString(formato) + """/>")
            sb.Append("</typ:listaRequestOpcional>")
            sb.Append("</typ:enviarMensajeRequest>")
            sb.Append("</soapenv:Body>")
            sb.Append("</soapenv:Envelope>")

            soapEnvelopeXml.LoadXml(sb.ToString())
            objFileLog.Log_WriteLog(pathFile, strArchivo, "ARCHIVO XML ==>> : " & sb.ToString())
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "ARCHIVO XML >> : " & sb.ToString())

            Dim stream As Stream = request.GetRequestStream()

            soapEnvelopeXml.Save(stream)
            stream.Close()

            Dim response As WebResponse = request.GetResponse()
            Dim rd As StreamReader = New StreamReader(response.GetResponseStream())
            Dim soapResult As String = rd.ReadToEnd()
            Dim xmlCod As New XmlDocument

            xmlCod.LoadXml(soapResult)

            Dim manager As New XmlNamespaceManager(xmlCod.NameTable)
            manager.AddNamespace(ConfigurationSettings.AppSettings("SmsWS_ns0"), ConfigurationSettings.AppSettings("SmsWS_servicio"))

            Dim nodoResponse As XmlNode = xmlCod.SelectSingleNode(ConfigurationSettings.AppSettings("SmsWS_response"), manager)
            Dim cadenaXML As String = xmlCod.InnerXml

            HelperLog.EscribirLog("", "LogSmsWS.txt", " enviarMensaje--> enviarMensajeResponse:" + cadenaXML, False)

            If Not nodoResponse Is Nothing Then
                item = New BEEnviarMensajeResponse
                item.idTransaccion = nodoResponse("auditResponse")("ns0:codigoRespuesta").InnerText
                item.codigoRespuesta = CInt(nodoResponse("auditResponse")("ns0:codigoRespuesta").InnerText)
                item.mensajeRespuesta = nodoResponse("auditResponse")("ns0:mensajeRespuesta").InnerText
            End If

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " Fin de MÃ©todo EnviarSMS ")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " -------------------------------------------------------- ")

        Catch ex As Exception
            Dim strIdentifyLog As String = CStr(AppUsuario) & " - " & drPagos.Item("PEDIN_NROPEDIDO")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-----------------------" & ex.Message.ToString & " -- " & ex.StackTrace & " ;;; ")
        End Try

        Return item
    End Function
    ' FIN|PROY-30162-IDEA-32487 ENVIO BOLETA ELECTRONICA PREPAGO //RGP_BOL_18

    'INC000000961273 - INICIO
    Private Function CrearNumeroPortabilidad(ByVal CodigoRed As String, ByVal CodOperadorCedente As String, ByVal NroTelefono As String, _
        ByVal region As String, ByVal serie As String, ByVal tipoNumero As String, ByRef mensaje As String, ByVal Material As String) As Boolean
        Dim usuario_id As String = CurrentUser
        Dim oSapConsultaSans As New NEGOCIO_SIC_SANS.SansNegocio
        Return oSapConsultaSans.CrearTelefonoPortable(CodigoRed, CodOperadorCedente, NroTelefono, region, serie, tipoNumero, mensaje, Material, usuario_id)
    End Function

    Private Function BorrarNumerosPortabilidad(ByVal idLog As String, ByVal arrayLineas As String) As Boolean
        Dim retorno As Boolean = True

        Dim oSapConsultaSans As New NEGOCIO_SIC_SANS.SansNegocio
        Dim usuario_id As String = CurrentUser

        objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "INICIO ROlLBACK NUMEROS PORTABLES ZSANS")

        Dim nroTelAux As String = ""
        Dim Lineas() As String = Split(arrayLineas, ";")

        For i As Integer = 0 To Lineas.Length - 2

            Dim nroTelefono As String = Lineas(i)
            If nroTelAux <> nroTelefono Then
                objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " Rollback: Borra Numero Portable # " & nroTelefono)
                objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " Rollback: Usuario: " & usuario_id)
                retorno = retorno And oSapConsultaSans.Set_AnulaTelefonoPortable(nroTelefono, usuario_id)
                objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "  Resultado: " & retorno)
                nroTelAux = nroTelefono
            End If
        Next

        objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "FIN ROlLBACK NUMEROS PORTABLES ZSANS")
        objFileLog.Log_WriteLog(pathFile, strArchivo, idLog & " - " & "----------------------------------------------------------------")

        Return retorno
    End Function

    Public Function ObtenerRegion(ByVal strHRL As String) As String
        Dim rpta As String = ""
        Try
            If strHRL.Length <> 2 Then
                Return rpta
            End If
            Dim regionesHRL() As String = ConfigurationSettings.AppSettings("ExpressRegiones").Split("|"c)
            For Each regionHRL As String In regionesHRL
                Dim region As String = regionHRL.Split(";"c)(0)
                Dim HRLs As String = regionHRL.Split(";"c)(1)
                If HRLs.IndexOf(strHRL) > -1 Then
                    rpta = region
                    Exit For
                End If
            Next
        Catch ex As Exception
        End Try
        Return rpta
    End Function

    Private Function ObtenerOpeCedente(ByVal NroSec As String) As DataTable
        Dim dsData As DataSet
        Dim objPorta As New ClsPortabilidad
        dsData = objPorta.Consulta_Ope_cedente(NroSec)
        Return dsData.Tables(0)
    End Function
    'INC000000961273 - FIN

    'Inicio PROY 32089
    Sub Limpiar_datos_id_solicitud()
        strLista_SOPOC_ID_SOLICITUD = New ArrayList
    End Sub
    'Fin PROY32089

    'PROY-33313 RP INICIO
    Private Sub ActualizaFlagCuota(ByVal sNroPedido As Int64)

        Dim strIdentifyLog As String = CStr(AppUsuario) & " - " & sNroPedido

        Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Actualizacion del FlagEnvio CVE de Reposicion - INICIO")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Nro Pedido para actualizacion : " & sNroPedido)

            Dim objActivaciones As New COM_SIC_Activaciones.clsConsultaPvu
            Dim sEstadoFlag As String = ConfigurationSettings.AppSettings("consEstadoCuota")
            Dim sMensaje As String

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Valor de consEstadoCuota : " & sEstadoFlag)
            Dim blEstadoAct As Boolean = objActivaciones.FnActualizaFlagCuota(sNroPedido, sEstadoFlag, sMensaje)
            'INI PROY-140126
            Dim MaptPath As String
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: ActualizaFlagCuota)"
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Resultado de Actualizacion : " & blEstadoAct & " - Mensaje : " & sMensaje & MaptPath)
            'FIN PROY-140126
        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Error en la Actualizacion del FlagEnvio CVE de Reposicion : " & ex.Message.ToString)
        Finally
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Actualizacion del FlagEnvio CVE de Reposicion - FIN")
        End Try
    End Sub

    Private Sub TipificarChipSueltoUnaCuota(ByVal sNroPedido As Int64, ByVal dsDatosPedido As DataSet, ByVal sNroSec As String)

        Dim strIdentifyLog As String = CStr(AppUsuario) & " - " & sNroPedido

        Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Tipificacion Chip Suelto Alta y Porta con 1 cuota - INICIO")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Nro Pedido para actualizacion : " & sNroPedido)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Nro Sec : " & sNroSec)

            Dim objActivaciones As New COM_SIC_Activaciones.clsConsultaPvu
            Dim oBETipiChipSuelto As New BETipiChipSuelto
            Dim sCodRespuesta, sMsgRespuesta As String
            Dim blEstadoAct As Boolean
            Dim sTipoDoc As String = Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("CLIEC_TIPODOCCLIENTE"))
            Dim sNroDoc As String = Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("CLIEV_NRODOCCLIENTE"))

            oBETipiChipSuelto.VENTV_NROPEDIDO = sNroPedido
            oBETipiChipSuelto.VENTV_NROSEC = sNroSec
            oBETipiChipSuelto.VENTC_TIPODOCUMENTO = sTipoDoc
            oBETipiChipSuelto.VENTV_NRODOCUMENTO = sNroDoc
            oBETipiChipSuelto.VENTD_FEC_OPERACION = Funciones.CheckDate(dsDatosPedido.Tables(0).Rows(0).Item("PEDID_FECHADOCUMENTO"))
            oBETipiChipSuelto.VENTV_APLICACION = Funciones.CheckStr(ConfigurationSettings.AppSettings("constAplicacion"))
            oBETipiChipSuelto.VENTV_TIP_OPERACION = dsDatosPedido.Tables(0).Rows(0).Item("PEDIV_DESCTIPOOPERACION") '("PEDIC_CODTIPOOPERACION")
            oBETipiChipSuelto.VENTV_PDV = dsDatosPedido.Tables(0).Rows(0).Item("OFICV_CODOFICINA")
            oBETipiChipSuelto.VENTV_ESTADO = "PAG" 'HARDCORE RP - TIPIFICACION
            oBETipiChipSuelto.VENTV_MODALIDAD = Funciones.CheckStr(ConfigurationSettings.AppSettings("strTVPostpago"))
            oBETipiChipSuelto.VENTV_CODVENDEDOR = Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("VENDEDOR"))
            oBETipiChipSuelto.VENTV_PRODUCTO = "MOVIL" 'HARDCORE RP - TIPIFICACION
            oBETipiChipSuelto.VENTV_CANAL = "01" 'HARDCORE RP - TIPIFICACION
            oBETipiChipSuelto.VENTV_USUARIO_CREA = CurrentUser
            oBETipiChipSuelto.VENTV_IMEI = String.Empty 'PROY-140360-IDEA-46301
            oBETipiChipSuelto.VENTV_TIPO = "1" 'PROY-140360-IDEA-46301
            oBETipiChipSuelto.VENTV_ID_ONBASE = String.Empty 'Proy-140360 -Onbase
            For i As Int32 = 0 To dsDatosPedido.Tables(1).Rows.Count - 1

                oBETipiChipSuelto.VENTC_LINEA = dsDatosPedido.Tables(1).Rows(i).Item("DEPEV_NROTELEFONO")
                oBETipiChipSuelto.VENTV_ICCID = dsDatosPedido.Tables(1).Rows(i).Item("SERIC_CODSERIE")
                oBETipiChipSuelto.VENTV_PLAN = ObtenerPlan(sNroPedido, Funciones.CheckStr(dsDatosPedido.Tables(1).Rows(i).Item("SERIC_CODSERIE")))
                oBETipiChipSuelto.VENTN_MONTO = Convert.ToDecimal(dsDatosPedido.Tables(1).Rows(i).Item("DEPEN_SUBTOTAL"))

                blEstadoAct = objActivaciones.FnTipificaChipSueltoUnaCuota(oBETipiChipSuelto, sCodRespuesta, sMsgRespuesta)
                If Not sCodRespuesta.Equals("0") Then
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Error al insertar Tipificacion con la Serie : " & Funciones.CheckStr(dsDatosPedido.Tables(1).Rows(i).Item("SERIC_CODSERIE")))
                End If
                'INI PROY-140126
                Dim MaptPath As String
                MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                MaptPath = "( Class : " & MaptPath & "; Function: TipificarChipSueltoUnaCuota)"
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Resultado de Tipificacion Chip Suelto: " & blEstadoAct & " - Mensaje : " & sMsgRespuesta & MaptPath)
                'FIN PROY-140126
            Next

        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Error en la Tipificacion Chip Suelto Alta y Porta con 1 cuota : " & ex.Message.ToString)
        Finally
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Tipificacion Chip Suelto Alta y Porta con 1 cuota - FIN")
        End Try
    End Sub


    'INICIO PROY-140360-IDEA-46301
    Private Sub TipificarContratoCodeUnaCuota(ByVal sNroPedido As Int64, ByVal dsDatosPedido As DataSet, ByVal sNroSec As String)

        Dim strIdentifyLog As String = CStr(AppUsuario) & " - " & sNroPedido

        Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " IDEA-46301 Tipificacion ContratoCode  Alta y Porta con cuota 1 - INICIO")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " IDEA-46301 Nro Pedido para actualizacion : " & sNroPedido)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " IDEA-46301 Nro Sec : " & sNroSec)

            Dim objActivaciones As New COM_SIC_Activaciones.ClsCambioPlanPostpago
            Dim clsConsultaPvuCuota As New COM_SIC_Activaciones.clsConsultaPvu
            Dim oBETipiContratoCode As New COM_SIC_Activaciones.BETipiChipSuelto
            Dim strProducto As String
            Dim numFila As Int16
            Dim montoVenta As Double = 0.0
            Dim strCodigoRespuesta, strMsgRespuesta As String
            Dim dsAcuerdo As DataSet
            Dim dsDatosPedidoAuxiliar As DataSet = dsDatosPedido
            Dim blnResultadoTipificacion As Boolean = False
            Dim lista As New ArrayList
            Dim sTipoDoc As String = Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("CLIEC_TIPODOCCLIENTE"))
            Dim sNroDoc As String = Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("CLIEV_NRODOCCLIENTE"))
            Dim strConsChip = Funciones.CheckStr(ConfigurationSettings.AppSettings("constChips"))
            Dim strConsPack = Funciones.CheckStr(ConfigurationSettings.AppSettings("constPacks"))
            Dim strTelefono As String = ""
            Dim contador, filas As Int16
            Dim blnEncontrado As Boolean
            contador = 0
            filas = 0

            oBETipiContratoCode.VENTV_NROPEDIDO = sNroPedido
            oBETipiContratoCode.VENTV_NROSEC = sNroSec
            oBETipiContratoCode.VENTC_TIPODOCUMENTO = sTipoDoc
            oBETipiContratoCode.VENTV_NRODOCUMENTO = sNroDoc
            oBETipiContratoCode.VENTD_FEC_OPERACION = Funciones.CheckDate(dsDatosPedidoAuxiliar.Tables(0).Rows(0).Item("PEDID_FECHADOCUMENTO"))
            oBETipiContratoCode.VENTV_APLICACION = Funciones.CheckStr(ConfigurationSettings.AppSettings("constAplicacion"))
            oBETipiContratoCode.VENTV_TIP_OPERACION = dsDatosPedidoAuxiliar.Tables(0).Rows(0).Item("PEDIV_DESCTIPOOPERACION")
            oBETipiContratoCode.VENTV_PDV = dsDatosPedidoAuxiliar.Tables(0).Rows(0).Item("OFICV_CODOFICINA")
            oBETipiContratoCode.VENTV_ESTADO = "PAG"
            oBETipiContratoCode.VENTV_MODALIDAD = Funciones.CheckStr(ConfigurationSettings.AppSettings("strTVPostpago"))
            oBETipiContratoCode.VENTV_CODVENDEDOR = Funciones.CheckStr(dsDatosPedidoAuxiliar.Tables(0).Rows(0).Item("VENDEDOR"))
            oBETipiContratoCode.VENTV_CANAL = dsDatosPedidoAuxiliar.Tables(0).Rows(0).Item("PEDIC_TIPOOFICINA")
            oBETipiContratoCode.VENTV_USUARIO_CREA = CurrentUser
            oBETipiContratoCode.VENTV_PRODUCTO = "MOVIL"
            oBETipiContratoCode.VENTV_TIPO = "2"
            oBETipiContratoCode.VENTV_ID_ONBASE = String.Empty 'Proy-140360 ONBASE 

            If (dsDatosPedidoAuxiliar.Tables(0).Rows.Count > 0 And dsDatosPedidoAuxiliar.Tables(1).Rows.Count > 0) Then
                filas = dsDatosPedidoAuxiliar.Tables(1).Rows.Count
                While contador < filas
                    blnEncontrado = False
                    montoVenta = 0
                    strTelefono = dsDatosPedidoAuxiliar.Tables(1).Rows(contador).Item("DEPEV_NROTELEFONO")
                    oBETipiContratoCode.VENTC_LINEA = strTelefono
                    montoVenta = montoVenta + dsDatosPedido.Tables(1).Rows(contador).Item("DEPEN_SUBTOTAL")
                    If (dsDatosPedidoAuxiliar.Tables(1).Rows(contador).Item("MATEC_TIPOMATERIAL") = strConsChip) Then
                        oBETipiContratoCode.VENTV_ICCID = dsDatosPedidoAuxiliar.Tables(1).Rows(contador).Item("SERIC_CODSERIE")
                    End If
                    If (dsDatosPedidoAuxiliar.Tables(1).Rows(contador).Item("MATEC_TIPOMATERIAL") = strConsPack) Then
                        oBETipiContratoCode.VENTV_IMEI = dsDatosPedidoAuxiliar.Tables(1).Rows(contador).Item("SERIC_CODSERIE")
                    End If

                    Dim j As Int32 = contador + 1
                    While j < filas
                        If (strTelefono = dsDatosPedidoAuxiliar.Tables(1).Rows(j).Item("DEPEV_NROTELEFONO")) Then
                            numFila = j
                            montoVenta = montoVenta + dsDatosPedidoAuxiliar.Tables(1).Rows(j).Item("DEPEN_SUBTOTAL")
                            blnEncontrado = True
                            If (dsDatosPedidoAuxiliar.Tables(1).Rows(j).Item("MATEC_TIPOMATERIAL") = strConsChip) Then
                                oBETipiContratoCode.VENTV_ICCID = dsDatosPedidoAuxiliar.Tables(1).Rows(j).Item("SERIC_CODSERIE")
                            End If
                            If (dsDatosPedidoAuxiliar.Tables(1).Rows(j).Item("MATEC_TIPOMATERIAL") = strConsPack) Then
                                oBETipiContratoCode.VENTV_IMEI = dsDatosPedidoAuxiliar.Tables(1).Rows(j).Item("SERIC_CODSERIE")
                            End If

                        End If
                        If blnEncontrado Then
                            Exit While
                        End If
                        j = j + 1
                    End While
                    oBETipiContratoCode.VENTV_PLAN = ObtenerPlan(sNroPedido, Funciones.CheckStr(dsDatosPedidoAuxiliar.Tables(1).Rows(contador).Item("SERIC_CODSERIE")))
                    oBETipiContratoCode.VENTN_MONTO = Convert.ToDecimal(montoVenta) 'Convert.ToDecimal(dsDatosPedido.Tables(1).Rows(i).Item("DEPEN_SUBTOTAL"))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " IDEA-46301 - DATOS INSERTADOS EN LA TIPIFICACION ")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " --------------------------------------------------------------")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Insercion Nº : " & contador)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " VENTV_NROPEDIDO --> " & sNroPedido)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " VENTV_NROSEC --> " & sNroSec)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " VENTC_TIPODOCUMENTO --> " & sTipoDoc)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " VENTD_FEC_OPERACION --> " & oBETipiContratoCode.VENTD_FEC_OPERACION.ToString)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " VENTV_APLICACION --> " & oBETipiContratoCode.VENTV_APLICACION.ToString)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " VENTV_TIP_OPERACION --> " & oBETipiContratoCode.VENTV_TIP_OPERACION.ToString)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " VENTV_PDV --> " & oBETipiContratoCode.VENTV_PDV.ToString)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " VENTV_ESTADO --> " & oBETipiContratoCode.VENTV_ESTADO.ToString)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " VENTV_MODALIDAD --> " & oBETipiContratoCode.VENTV_MODALIDAD.ToString)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " VENTV_CODVENDEDOR --> " & oBETipiContratoCode.VENTV_CODVENDEDOR.ToString)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " VENTV_CANAL --> " & oBETipiContratoCode.VENTV_CANAL.ToString)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " VENTV_USUARIO_CREA --> " & oBETipiContratoCode.VENTV_USUARIO_CREA.ToString)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " VENTV_PRODUCTO --> " & oBETipiContratoCode.VENTV_PRODUCTO.ToString)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " VENTV_TIPO --> " & oBETipiContratoCode.VENTV_TIPO.ToString & " : " & "PACK")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " VENTC_LINEA --> " & oBETipiContratoCode.VENTC_LINEA.ToString)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " VENTV_ICCID --> " & oBETipiContratoCode.VENTV_ICCID.ToString)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " VENTV_IMEI --> " & oBETipiContratoCode.VENTV_IMEI.ToString)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " VENTV_PLAN --> " & oBETipiContratoCode.VENTV_PLAN.ToString)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " VENTN_MONTO --> " & oBETipiContratoCode.VENTN_MONTO.ToString)
                    blnResultadoTipificacion = clsConsultaPvuCuota.FnTipificaContratoCodeUnaCuota(oBETipiContratoCode, strCodigoRespuesta, strMsgRespuesta)  'VALIDAR
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "RESULTADO METODO FnTipificaContratoCodeUnaCuota : " & blnResultadoTipificacion)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "RESULTADO METODO FnTipificaContratoCodeUnaCuota- CODIGO RESPUESTA: " & strCodigoRespuesta)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "RESULTADO METODO FnTipificaContratoCodeUnaCuota- MENSAJE RESPUESTA: " & strMsgRespuesta)

                    If strCodigoRespuesta.Equals("0") Then
                        dsDatosPedidoAuxiliar.Tables(1).Rows.RemoveAt(numFila)
                        filas = dsDatosPedidoAuxiliar.Tables(1).Rows.Count
                        'j = j + 1
                        contador = contador + 1
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-140360-IDEA-46301 Exito al insertar Tipificacion con la Serie : " & oBETipiContratoCode.VENTV_ICCID)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-140360-IDEA-46301 Exito al insertar Tipificacion con el imei : " & oBETipiContratoCode.VENTV_IMEI)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "-----------------------------------------------------------------------")
                    Else
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-140360-IDEA-46301 Error al insertar Tipificacion con la Serie : " & oBETipiContratoCode.VENTV_ICCID)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-140360-IDEA-46301 Error al insertar Tipificacion con el imei : " & oBETipiContratoCode.VENTV_IMEI)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "------------------------------------------------------------------------")
                    End If

                End While
            End If

        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-140360-IDEA-46301 Error en la Tipificacion Chip Suelto Alta y Porta con 1 cuota : " & ex.Message.ToString)
        Finally
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-140360-IDEA-46301 Tipificacion Chip Suelto Alta y Porta con 1 cuota - FIN")
        End Try
    End Sub

    ' FIN PROY-140360-IDEA-46301 
    Private Function ObtenerPlan(ByVal sNroPedido As String, ByVal sImeiPedido As String) As String
        Dim dsDataPedido, dsDataPedidoDet As DataTable
        Dim sCodRespuesta, sMsgRespuesta As String
        Dim strIdentifyLog As String = CStr(AppUsuario) & " - " & sNroPedido
        Dim objActivaciones As New COM_SIC_Activaciones.clsConsultaPvu

        Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Obtener plan para Tipificacion - INICIO")

            objActivaciones.ConsultarPedidosPVU(sNroPedido, sCodRespuesta, sMsgRespuesta, dsDataPedido, dsDataPedidoDet)

            If Not IsNothing(dsDataPedidoDet) Then
                For i As Int32 = 0 To dsDataPedidoDet.Rows.Count - 1
                    If sImeiPedido = Funciones.CheckStr(dsDataPedidoDet.Rows(i).Item("IMEI19")) Then
                        ObtenerPlan = Funciones.CheckStr(dsDataPedidoDet.Rows(i).Item("PLAN"))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Codigo de plan : " & Funciones.CheckStr(dsDataPedidoDet.Rows(i).Item("PLAN")))
                        Exit For
                    End If
                Next
            End If
        Catch ex As Exception
            ObtenerPlan = ""
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Error al obtener plan para Tipificacion : " & ex.Message.ToString)
        Finally
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Obtener plan para Tipificacion - FIN")
        End Try

        Return ObtenerPlan
    End Function

    Private Function ValidarModalidadVentaChipSuelto(ByVal sNroSec As String) As Boolean
        Dim strIdentifyLog As String = CStr(AppUsuario) & " - " & sNroSec
        Dim objActivaciones As New COM_SIC_Activaciones.ClsCambioPlanPostpago
        Dim lista As New ArrayList

        Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Validar Modalidad Venta Chip Suelto - INICIO")
            ValidarModalidadVentaChipSuelto = False

            lista = objActivaciones.ConsultaSolicitud_NROSEC(Funciones.CheckStr(sNroSec))

            If Not lista Is Nothing And lista.Count > 0 Then
                For Each item As clsSolicitudPersona In lista
                    If Funciones.CheckStr(item.MODALIDAD_VENTA).Equals("1") Then
                        ValidarModalidadVentaChipSuelto = True
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Modalidad de Venta : " & Funciones.CheckStr(item.MODALIDAD_VENTA))
                        Exit For
                    End If
                Next
            Else
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 No hay datos de la sec")
            End If

        Catch ex As Exception
            ValidarModalidadVentaChipSuelto = False
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Error al validar Modalidad Venta Chip Suelto : " & ex.Message.ToString)
        Finally
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Validar Modalidad Venta Chip Suelto - FIN")
        End Try

        Return ValidarModalidadVentaChipSuelto
    End Function
    'PROY-33313 RP FIN

    Private Function ObtenerDatosCliente(ByVal nroTelefono As String) As clsClienteBSCS

        Dim strEmpleado As String
        Dim oClient As New clsClienteBSCS
        Dim oService As New clsDatosPostpagoNegocios
        Dim objBLCbio As New BLDatosCBIO 'INI: INICIATIVA-219

        Try

            strEmpleado = AppstrUsuario
            oClient = objBLCbio.LeerDatosCliente(nroTelefono, "", strEmpleado) 'INICIATIVA-219
            'oService.LeerDatosCliente(nroTelefono, "", strEmpleado, "")

            If oClient Is Nothing Then
                objFileLog.Log_WriteLog(pathFile, strArchivo, "No se obtuvieron datos al consultar Cliente - " & nroTelefono)
            End If

        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, "Error al consultar Datos Cliente " & nroTelefono & ": " + ex.Message)
            oService = Nothing
        End Try

        Return oClient

    End Function

    'INICIATIVA-318 INI
    Private Function ConsultaParametrosFormaPagoPerfil(ByVal strIdenLog As String)

        Try

            Dim objpvuDB As New COM_SIC_Activaciones.clsConsultaPvu
            Dim oParamteros As New COM_SIC_Activaciones.BEParametros
            Dim strCodGrupo As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("key_ParanGrupoFormaPagoPerfil"))

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdenLog & "- " & "--Inicio Proceso Consulta Parametros--")
            If strCodGrupo <> "" Then
                arrParametrosFormaPagoPerfil = objpvuDB.ConsultaParametros(strCodGrupo)
            End If

            Dim codAplicacion As String = ConfigurationSettings.AppSettings("codAplicacion")
            Dim objAuditoriaWS As New AuditoriaWS.EbsAuditoriaService
            Dim oAccesoRequest As New AuditoriaWS.AccesoRequest
            Dim oAccesoResponse As New AuditoriaWS.AccesoResponse

            objAuditoriaWS.Url = ConfigurationSettings.AppSettings("consRutaWSSeguridad").ToString()
            objAuditoriaWS.Credentials = System.Net.CredentialCache.DefaultCredentials
            objAuditoriaWS.Timeout = Convert.ToInt32(ConfigurationSettings.AppSettings("ConstTimeOutEmpleado").ToString())

            oAccesoRequest.usuario = AppstrUsuario
            oAccesoRequest.aplicacion = codAplicacion

            oAccesoResponse = objAuditoriaWS.leerDatosUsuario(oAccesoRequest)

            If oAccesoResponse.resultado.estado = "1" Then

                If oAccesoResponse.auditoria.AuditoriaItem.item.Length > 0 Then
                    Dim item As New COM_SIC_Seguridad.EntidadConsulSeguridad
                    For i As Integer = 0 To oAccesoResponse.auditoria.AuditoriaItem.item.Length - 1
                        strCodPerfilFormaPago = strCodPerfilFormaPago & oAccesoResponse.auditoria.AuditoriaItem.item(i).perfil & ","
                    Next
                    strCodPerfilFormaPago = strCodPerfilFormaPago.Substring(0, strCodPerfilFormaPago.Length - 1)
                Else
                    strCodPerfilFormaPago = AppcodPerfil
                End If

            End If

        Catch ex As Exception

        End Try
    End Function
    Public Function ObtenerAprobacionFormaPago(ByVal strFormaPago As String) As Boolean

        Dim strValor As String
        Dim strValor1 As String
        Dim strPerfilusuario As String = ""
        Dim strConfirma As String
        Dim sArrayPerfiles As String()
        Dim bolAutorizado As Boolean

        Try
            strPerfilusuario = AppcodPerfil

            If strCodPerfilFormaPago.Length > 0 Then
                sArrayPerfiles = strCodPerfilFormaPago.Split(","c)
            Else
                sArrayPerfiles = strPerfilusuario.Split("$"c)
            End If

            For Each item As BEParametros In arrParametrosFormaPagoPerfil
                strValor = item.strValor.Split("|")(0)
                strValor1 = item.strValor1.Split("|")(0)
                Select Case strValor
                    Case strFormaPago
                        For Each sPerfil As String In sArrayPerfiles
                            If strValor1 = sPerfil Then
                                bolAutorizado = True
                                Exit For
                            Else
                                bolAutorizado = False
                            End If
                        Next

                        If (bolAutorizado) Then
                            Exit For
                        End If
                End Select
            Next
        Catch ex As Exception
        End Try
        Return bolAutorizado
    End Function

    'INICIO - IDEA-141711 - Pack Internet Móvil Prepago
    Public Sub RecargaPaquete(ByVal pvTerminalID As String, ByVal pvTrace As String, ByVal pvCanal As String, ByVal pvMoneda As String, ByVal pvBinAdquiriente As String, ByVal pvCodCadena As String, ByVal pvCodComercio As String, ByVal strNroPedido As String)
        Dim strTrama As String = String.Empty
        Dim arrTrama() As String
        Dim strMensaje As String = String.Empty
        Dim strSaldo As String = String.Empty
        Dim strnumerodocumentoautorizado As String = String.Empty
        Dim strvalorrecarga As String = String.Empty
        Dim strvalorventa As String = String.Empty
        Dim strvalordescuento As String = String.Empty
        Dim strvalorsubtotal As String = String.Empty
        Dim strvalorigv As String = String.Empty
        Dim strvalortotal As String = String.Empty
        Dim pvNumRecarga As String = String.Empty
        Dim objRVirt As New COM_SIC_RVirtual.clsRVirtual

        Dim objFileLog As New SrvPago_Log
        Dim nameFile As String = ConfigurationSettings.AppSettings("constNameLogRecarga")
        Dim pathFile As String = ConfigurationSettings.AppSettings("constRutaLogRecarga")
        Dim strArchivo As String = objFileLog.Log_CrearNombreArchivo(nameFile)
        Dim strIdentifyLog As String = String.Format("--[{0}{1}]--", "IDEA 141711 Pack Internet Movil Prepago", strNroPedido)

        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "-----Inicio Get_RecargaPaquete -----")
        Dim dsPedido As DataSet
        Dim pvProducto As String = String.Empty
        Dim strErrorMotivo As String = String.Empty
        Dim strError As String = String.Empty

        Dim CodGrupoParamPackInternet As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("CodGrupoParamPackPrepago"))

        Dim objObtenerParamGrupo As New COM_SIC_Cajas.clsCajas
        Dim dsParamGrupoParamPackInternet As DataSet

        dsParamGrupoParamPackInternet = objObtenerParamGrupo.ObtenerParamByGrupo(CodGrupoParamPackInternet)

        Dim i As Integer
        For i = 0 To dsParamGrupoParamPackInternet.Tables(0).Rows.Count - 1
            If dsParamGrupoParamPackInternet.Tables(0).Rows(i).Item("PARAV_VALOR1") = "Key_ProductoRecarga" Then
                pvProducto = dsParamGrupoParamPackInternet.Tables(0).Rows(i).Item("PARAV_VALOR")
            End If
            If dsParamGrupoParamPackInternet.Tables(0).Rows(i).Item("PARAV_VALOR1") = "Key_ErrorMotivoPaquete" Then
                strErrorMotivo = dsParamGrupoParamPackInternet.Tables(0).Rows(i).Item("PARAV_VALOR")
            End If
            If dsParamGrupoParamPackInternet.Tables(0).Rows(i).Item("PARAV_VALOR1") = "Key_ErrorPaquete" Then
                strError = dsParamGrupoParamPackInternet.Tables(0).Rows(i).Item("PARAV_VALOR")
            End If
        Next

        Dim dsPaquetesAdicionales As DataSet
        Dim objConsultaMsSap As New COM_SIC_Activaciones.clsConsultaMsSap

        dsPaquetesAdicionales = objConsultaMsSap.ObtenerPaquete("", "")

        dsPedido = objConsultaMsSap.ConsultaPaqueteAdicional(strNroPedido, "", "")

        For x As Int32 = 0 To dsPedido.Tables(0).Rows.Count - 1
            Dim pvTelefono As String = String.Empty
            Dim pvMonto As String = String.Empty
            Dim pvDatosUsuario As String = String.Empty

            pvTelefono = Funciones.CheckStr(dsPedido.Tables(0).Rows(x)("DEPEV_NROTELEFONO"))
            pvDatosUsuario = Funciones.CheckStr(dsPedido.Tables(0).Rows(x)("DEPEV_DESCRIPCIONLP"))

            For y As Int32 = 0 To dsPaquetesAdicionales.Tables(0).Rows.Count - 1
                If Funciones.CheckStr(dsPaquetesAdicionales.Tables(0).Rows(y).Item("SERVV_COD_PAQUETE")) = pvDatosUsuario Then
                    pvMonto = Funciones.CheckStr(dsPaquetesAdicionales.Tables(0).Rows(y).Item("SERVN_IMP_SERV_RECARGA"))
                End If
            Next

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "-----Incio Recarga Paquete -----")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " inp ALMACEN: " & AppAlmacen)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " inp pvTerminalID: " & pvTerminalID)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " inp pvCanal: " & pvCanal)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " inp pvTelefono: " & pvTelefono)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " inp pvMonto: " & pvMonto)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " inp pvMoneda: " & pvMoneda)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " inp pvProducto: " & pvProducto)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " inp pvBinAdquiriente: " & pvBinAdquiriente)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " inp pvCodCadena: " & pvCodCadena)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " inp pvCodComercio: " & pvCodComercio)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " inp pvDatosUsuario: " & pvDatosUsuario)

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " Fecha Inicio Invocacion ST: " & DateTime.Now)

            strTrama = objRVirt.Recarga(AppAlmacen, pvTerminalID, pvTrace, pvCanal, pvTelefono, pvMonto, pvMoneda, pvProducto, pvBinAdquiriente, pvCodCadena, pvCodComercio, pvDatosUsuario)

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " Fecha Fin Invocacion ST: " & DateTime.Now)

            arrTrama = Split(strTrama, ";")
            strSaldo = Decimales(arrTrama(4))
            strnumerodocumentoautorizado = arrTrama(7)
            strvalorrecarga = arrTrama(13)
            strvalorventa = arrTrama(9)
            strvalordescuento = arrTrama(10)
            strvalorsubtotal = arrTrama(11)
            strvalorigv = arrTrama(12)
            strvalortotal = arrTrama(13)
            pvNumRecarga = Trim(arrTrama(6))
            AppfechaTransaccionOriginal = arrTrama(14)
            AppTraceRecarga = arrTrama(15)
            numeroOperacionST = pvNumRecarga

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " out pvNumRecarga: " & pvNumRecarga)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " out trama " & " strSaldo: " & strSaldo & " strnumerodocumentoautorizado: " & strnumerodocumentoautorizado & " strvalorrecarga: " & strvalorrecarga & " strvalorventa: " & strvalorventa & " strvalordescuento: " & strvalordescuento & " strvalorsubtotal : " & strvalorsubtotal & " strvalorigv: " & strvalorigv & " strvalortotal: " & strvalortotal)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "-----Fin Recarga Paquete-----")

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - Validamos si la recarga presenta errores en el servicio.")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - Valor de la Trama arrTrama(2): " & arrTrama(2).ToString)

            If arrTrama(2) <> 0 Then
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - El valor de la trama arrTrama(2) retornado no es el correcto.")
                strMensaje = String.Format("{0}: {1}", strErrorMotivo, arrTrama(3))
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " trama " & " strMensaje " & strMensaje & " arrTrama(3) " & arrTrama(3).ToString())
                If Trim(arrTrama(3)) = "" Then
                    strMensaje = Funciones.CheckStr(strError)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " trama " & " strMensaje " & strMensaje & " arrTrama(3) " & arrTrama(3).ToString())
                End If
                
                Dim objOffline As New COM_SIC_OffLine.clsOffline
                Try
                    objOffline.SetErrorRecarga(numeroOperacion)
                Catch ex As Exception
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & ex.Message & " - " & ex.StackTrace)
                End Try

                AppstrMensajeCajaRec = strMensaje
                ApppaqueteAdicional = False
                ApprecargaVirtual = Nothing
                Cancelar()
                Exit For
            Else
                strMensaje = "La recarga se realizó satisfactoriamente."
                Dim estadoRegistrarRecargaVirtual As Boolean

                estadoRegistrarRecargaVirtual = ActualizarRecargaVirtual(strIdentifyLog, AppCanal, AppUsuario, pvTelefono, strTrama)

                If estadoRegistrarRecargaVirtual = True Then
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " Se Actualizo la Recarga Virtual correctamente")
                Else
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " Ocurrio un ERROR en la actualizacion de la Recarga Virtual")
                End If

                AppstrMensajeCajaRec = strMensaje
            End If
        Next
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "-----Fin Get_RecargaPaquete -----")
    End Sub
    'FIN - IDEA-141711 - Pack Internet Móvil Prepago
'INICIO PROY-140379
    Private Function ejecutarConsultarProcesarIOT(ByVal telefono As String, ByVal StrMotivoDevolSW As String, ByVal strIdentifyLog As String, ByVal strAccion As String, ByVal strSerie_entrante As String, ByVal strSerie_saliente As String, ByVal strIccid_baja As String) As Boolean
        Dim objConsultar As New COM_SIC_Activaciones.BWConsultasProcesos_IOT

        Dim strResult As String
        Dim strParametroAccion As String = IIf(strAccion = "1", Funciones.CheckStr(COM_SIC_Seguridad.ReadKeySettings.Key_consultarProcesarIotDarBaja), Funciones.CheckStr(COM_SIC_Seguridad.ReadKeySettings.Key_consultarProcesarIotActualizar))
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "strParametroAccion: " & strParametroAccion)
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio ejecutarConsultarProcesarIOT")

        If strParametroAccion.IndexOf("{imei}") > -1 Then
            strParametroAccion = strParametroAccion.Replace("{imei}", strSerie_saliente)
        End If

        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "strParametroAccion: " & strParametroAccion)
        Dim objOpcional As New BElistaOpcional
        Try
            strResult = objConsultar.consultarProcesarUnico(telefono, StrMotivoDevolSW, CurrentUser, strParametroAccion, strSerie_entrante, strIccid_baja, AppLOCAL_ADDR, CurrentTerminal)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Resultado consultarProcesarUnico: " & strResult)
        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "error ejecutarConsultarProcesarIOT Message : " & ex.Message)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "error ejecutarConsultarProcesarIOT stackTrace : " & ex.StackTrace)
            Return False
        End Try
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin ejecutarConsultarProcesarIOT")
        Return True
    End Function
    'FIN PROY-140379

    Public Function DevuelteTipoDescPago(ByVal cboTipDocumento As String) As String

        Dim cboDescTipDocumento As String


        Dim ds_FormaPago As DataSet = CType(AppVias_Pago, DataSet)

        Dim j As Integer = 0
        Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, " - " & "Utilizacion de la variable Session: Vias_Pago")

            If ds_FormaPago.Tables(0).Rows.Count > 0 Then
                If Not IsNothing(ds_FormaPago) Then
                    For j = 0 To ds_FormaPago.Tables(0).Rows.Count - 1
                        If (ds_FormaPago.Tables(0).Rows(j)("CCINS") = cboTipDocumento) Then
                            cboDescTipDocumento = Trim(ds_FormaPago.Tables(0).Rows(j)("VTEXT"))
                            Exit For
                        End If
                    Next
                End If
            End If
        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, " - " & "error Utilizacion de la variable Session: Vias_Pago")
            'INI PROY-140126
            Dim MaptPath As String
            MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            MaptPath = "( Class : " & MaptPath & "; Function: DevuelveTipoDescPago)"
            objFileLog.Log_WriteLog(pathFile, strArchivo, " - " & "ERROR: " & ex.Message.ToString() & MaptPath)
            'FIN PROY-140126

        End Try
        AppFormasPAgo = Nothing
        Return cboDescTipDocumento

        'FPPB

    End Function

    '/*----------------------------------------------------------------------------------------------------------------*/
    Private Function ExtornarRecargaVirtual(ByVal strNumeroDocumento As String, _
                                            ByVal strCanal As String, _
                                            ByVal strUserSesion As String, _
                                            ByVal arrDetalle() As String) As Integer

        Dim strIdentifyLog As String = strNumeroDocumento
        Dim objRevertirRecVirtual As New COM_SIC_RVirtual.clsBSS_RVirtual
        Dim objResponse As New COM_SIC_RVirtual.BEResponseRecargaVirtual
        Dim strEstadoPagadoRV As String
        Dim strEstadoDevueltoRV As String

        'Leer los estados de la recarga Virtual de la tabla de parametros
        'PENDIENTE DE PAGO, PAGADO, CONFIRMADO POR SWITCH, DEVUELTO'
        If (AppESTADO_RECARGA_V Is Nothing) Then
            Dim codGrupo As Integer = Funciones.CheckDbl(ConfigurationSettings.AppSettings("constGrupoParam_EstadosRecargaVirtual"))
            Dim dsCodigos As DataSet = (New COM_SIC_Cajas.clsCajas).ObtenerParamByGrupo(codGrupo)
            If Not IsNothing(dsCodigos) Then
                strEstadoPagadoRV = Funciones.CheckStr(dsCodigos.Tables(0).Rows(1).Item("PARAV_VALOR"))
                strEstadoDevueltoRV = Funciones.CheckStr(dsCodigos.Tables(0).Rows(2).Item("PARAV_VALOR"))
            End If
            AppESTADO_RECARGA_V = dsCodigos
        Else
            Dim dsCodigos As DataSet = AppESTADO_RECARGA_V
            strEstadoPagadoRV = Funciones.CheckStr(dsCodigos.Tables(0).Rows(1).Item("PARAV_VALOR"))
            strEstadoDevueltoRV = Funciones.CheckStr(dsCodigos.Tables(0).Rows(2).Item("PARAV_VALOR"))
        End If


        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " ------------------------------------------------------- ")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " INICIO ExtornarRecargaVirtual() WS:WBSS_RecargaVirtual.revertirRecargaVirtual")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " URL: " & System.Configuration.ConfigurationSettings.AppSettings("constRutaRevertirRecargaVirtual"))
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " BD: SICAT_RECARGA_VIRTUAL_TRX ")

        Try
            Dim dsDatos As DataSet
            Dim K_COD_RESP As String = ""
            Dim K_MEN_RESP As String = ""
            Dim sw As Boolean = True
            Dim itemRecarga As New COM_SIC_RVirtual.BERecargaVirtual
            Dim itemHeaderDataPower As New COM_SIC_RVirtual.BEHeaderDataPower
            Dim ipAplicacion As String = CurrentTerminal

            With itemRecarga
                .linea = hidNumeroTelefono
                .estado = strEstadoPagadoRV ' ConfigurationSettings.AppSettings("constEstadoActualizarRecVirtual").ToString 'Estado: PENDIENTE DE PAGO, PAGADO, CONFIRMADO POR SWITCH, DEVUELTO'
                .fecha = ""
                .nombreUsuario = strUserSesion
                .puntoVenta = AppAlmacen
                '.tipoDocumento = Funciones.CheckStr(cboTipDocumento.SelectedValue).ToString.Trim
                '.numeroDocumento = Funciones.CheckStr(txtNumDocumento.Text)
                .lineaCliente = ""
                .montoRecarga = Funciones.CheckStr(Funciones.CheckDbl(arrDetalle(1)))
                .fechaSwTrx = "" 'Fecha  respuesta del switch transaccional"
                .valorVenta = Funciones.CheckStr(Funciones.CheckDbl(arrDetalle(2)))
                .valorDescuento = "0"
                .valorSubTotal = Funciones.CheckStr(Funciones.CheckDbl(arrDetalle(3)))
                .valorIGV = Funciones.CheckStr(Funciones.CheckDbl(arrDetalle(4)))
                .valorTotal = Funciones.CheckStr(Funciones.CheckDbl(arrDetalle(5)))
                .estadoActualizar = strEstadoDevueltoRV 'ConfigurationSettings.AppSettings("constEstadoRevertirRecVirtual").ToString 'Estado: PENDIENTE DE PAGO, PAGADO, CONFIRMADO POR SWITCH, DEVUELTO'
                .trace = ""
                '.flagOperacion = ""
                .listaResquestOpcional = ""
            End With

            itemHeaderDataPower.consumer = ""
            itemHeaderDataPower.country = ""
            itemHeaderDataPower.dispositivo = ""
            itemHeaderDataPower.language = ""
            itemHeaderDataPower.modulo = ""
            itemHeaderDataPower.msgType = ""
            itemHeaderDataPower.operation = ""
            itemHeaderDataPower.pid = ""
            itemHeaderDataPower.userId = ""
            itemHeaderDataPower.wsIp = ConfigurationSettings.AppSettings("consIpBSS_RecargaVirtual").ToString
            itemHeaderDataPower._system = ""

            ' Leer Usuario y Contraseña del Key Regedit
            Dim KeyUsrPasRecVirtual As String = ConfigurationSettings.AppSettings("KeyUsrPasRecVirtual")
            Dim objsegu As COM_SIC_Seguridad.Configuracion = New COM_SIC_Seguridad.Configuracion(KeyUsrPasRecVirtual)
            Dim usuario As String
            Dim contraseña As String

            'INC000001492087: INI
            Dim strUsrAplicacionEncriptado As String
            Dim strClaveUsrEncriptado As String
            strUsrAplicacionEncriptado = objsegu.LeerUsuarioEncriptado()
            strClaveUsrEncriptado = objsegu.LeerContrasenaEncriptado()

            Try
                Dim strIDTrans_ As String = String.Empty
                Dim strIpAplicacion_ As String = String.Empty
                Dim strAplicacion_ As String = String.Empty
                strIDTrans_ = Now.Year & Now.Month & Now.Day & Now.Hour & Now.Minute & Now.Second
                strAplicacion_ = ConfigurationSettings.AppSettings("constAplicacion")
                strIpAplicacion_ = AppLOCAL_ADDR
                Dim sAuditoriastring_ As New AuditoriaEWS
                sAuditoriastring_.IDTRANSACCION = strIDTrans_
                sAuditoriastring_.IPAPLICACION = strIpAplicacion_
                sAuditoriastring_.APLICACION = strAplicacion_
                sAuditoriastring_.USRAPP = CurrentUser

                Dim objClave As ConsultaClavesNegocio = New ConsultaClavesNegocio
                Dim mensajeError As String = ""

                Dim codAplicacionClave As String = ConfigurationSettings.AppSettings("strAplicacionSISACT")
                Dim usuarioEncrypt As String = strUsrAplicacionEncriptado
                Dim claveEncrypt As String = strClaveUsrEncriptado
                Dim usuarioDesencrypt As String = String.Empty
                Dim claveDesencrypt As String = String.Empty

                objClave.ejecutarConsultaClave(sAuditoriastring_, codAplicacionClave, usuarioEncrypt, claveEncrypt, usuarioDesencrypt, claveDesencrypt, mensajeError)

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ejecutarConsultaClave Mensaje ws :" & mensajeError)

                usuario = usuarioDesencrypt
                contraseña = claveDesencrypt

            Catch ex As Exception
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ejecutarConsultaClave Exception :" & ex.Message)
            End Try
            'INC000001492087: FIN

            'Llamamos al metodo que realizara la reversa/extorno de la recarga
            objResponse = objRevertirRecVirtual.RevertirRecargaVirtual(strCanal, _
                                                                       strUserSesion, _
                                                                       itemRecarga, _
                                                                       itemHeaderDataPower, _
                                                                       usuario, _
                                                                       contraseña, _
                                                                       ipAplicacion)

            Dim K_estado As String = objResponse.K_estado
            Dim k_codigo_respuesta As String = objResponse.k_codigo_respuesta
            Dim k_descripcion As String = objResponse.k_descripcion
            Dim k_ubicacionError As String = objResponse.k_ubicacionError
            Dim k_fecha As String = objResponse.k_fecha
            Dim k_origen As String = objResponse.k_origen
            Dim k_xmlRequest As String = objResponse.k_XML_Request
            Dim k_xmlResponse As String = objResponse.k_XML_Response

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " objResponse.K_estado = " & K_estado)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " objResponse.k_codigo_respuesta = " & k_codigo_respuesta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " objResponse.k_descripcion = " & k_descripcion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " objResponse.k_ubicacionError = " & k_ubicacionError)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " objResponse.k_fecha = " & k_fecha)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " objResponse.k_origen = " & k_origen)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " objResponse.k_XML_Request = " & k_xmlRequest)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " objResponse.k_XML_Response = " & k_xmlResponse)

            Return Funciones.CheckInt64(k_codigo_respuesta)
        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " ERROR = " & ex.Message)
        End Try

        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " FIN  ExtornarRecargaVirtual() WS:WBSS_RecargaVirtual ")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " ------------------------------------------------------- ")
    End Function

    '/*----------------------------------------------------------------------------------------------------------------*/
    '/*--JR  INICIO  -  PROY-29380 IDEA-38934 - Iteración 2 y 3 2da Fase Sinergia Adec en Sist de Venta y Post-Venta --*/
    '/*----------------------------------------------------------------------------------------------------------------*/    
    Private Function ActualizarRecargaVirtual(ByVal strIdentifyLog As String, _
                                              ByVal strCanal As String, _
                                              ByVal strUserSesion As String, _
                                              ByVal strLinea As String, _
                                              ByVal strTramaSwTrx As String) As Boolean
        Dim objActualizarRecVirtual As New COM_SIC_RVirtual.clsBSS_RVirtual
        Dim objResponse As New COM_SIC_RVirtual.BEResponseRecargaVirtual
        Dim strEstadoPendienteRV As String
        Dim strEstadoPagadoRV As String

        'Leer los estados de la recarga Virtual de la tabla de parametros
        'PENDIENTE DE PAGO, PAGADO, CONFIRMADO POR SWITCH, DEVUELTO'
        If (AppESTADO_RECARGA_V Is Nothing) Then
            Dim codGrupo As Integer = Funciones.CheckDbl(ConfigurationSettings.AppSettings("constGrupoParam_EstadosRecargaVirtual"))
            Dim dsCodigos As DataSet = (New COM_SIC_Cajas.clsCajas).ObtenerParamByGrupo(codGrupo)
            If Not IsNothing(dsCodigos) Then
                strEstadoPendienteRV = Funciones.CheckStr(dsCodigos.Tables(0).Rows(0).Item("PARAV_VALOR"))
                strEstadoPagadoRV = Funciones.CheckStr(dsCodigos.Tables(0).Rows(1).Item("PARAV_VALOR"))
            End If
            AppESTADO_RECARGA_V = dsCodigos
        Else
            Dim dsCodigos As DataSet = AppESTADO_RECARGA_V
            strEstadoPendienteRV = Funciones.CheckStr(dsCodigos.Tables(0).Rows(0).Item("PARAV_VALOR"))
            strEstadoPagadoRV = Funciones.CheckStr(dsCodigos.Tables(0).Rows(1).Item("PARAV_VALOR"))
        End If

        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " ------------------------------------------------------- ")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " INICIO ActualizarRecargaVirtual() WS:WBSS_RecargaVirtual ")
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " URL: " & System.Configuration.ConfigurationSettings.AppSettings("constRutaActualizarRecargaVirtual"))
        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " BD: SICAT_RECARGA_VIRTUAL_TRX ")

        Try
            Dim dsDatos As DataSet
            Dim K_COD_RESP As String = ""
            Dim K_MEN_RESP As String = ""
            Dim itemRecarga As New COM_SIC_RVirtual.BERecargaVirtual
            Dim itemHeaderDataPower As New COM_SIC_RVirtual.BEHeaderDataPower
            Dim arrTramaSwTrx() As String

            arrTramaSwTrx = Split(strTramaSwTrx, ";")

            With itemRecarga
                .estado = strEstadoPendienteRV '"PENDIENTE" DE PAGO
                .lineaCliente = strLinea
                .puntoVenta = AppAlmacen
                .tipoDocumento = "01" 'Funciones.CheckStr(cboTipDocumento.SelectedValue).ToString.Trim
                .numeroDocumento = "" 'Funciones.CheckStr(txtNumDocumento.Text)
                '.fecha = ""
                .nombreUsuario = strUserSesion
                '.linea = Trim(arrTramaSwTrx(6))
                .montoRecarga = Trim(arrTramaSwTrx(13))
                .fechaSwTrx = Trim(arrTramaSwTrx(14))
                .valorVenta = Trim(arrTramaSwTrx(9))
                .valorDescuento = Trim(arrTramaSwTrx(10))
                .valorSubTotal = Trim(arrTramaSwTrx(11))
                .valorIGV = Trim(arrTramaSwTrx(12))
                .valorTotal = Trim(arrTramaSwTrx(13))
                .estadoActualizar = strEstadoPagadoRV 'PAGADO
                .trace = Trim(arrTramaSwTrx(15))
                '.flagOperacion = ""
                '.listaResquestOpcional = ""
            End With

            itemHeaderDataPower.consumer = ""
            itemHeaderDataPower.country = ""
            itemHeaderDataPower.dispositivo = ""
            itemHeaderDataPower.language = ""
            itemHeaderDataPower.modulo = ""
            itemHeaderDataPower.msgType = ""
            itemHeaderDataPower.operation = ""
            itemHeaderDataPower.pid = ""
            itemHeaderDataPower.userId = ""
            itemHeaderDataPower.wsIp = ConfigurationSettings.AppSettings("consIpBSS_RecargaVirtual").ToString
            itemHeaderDataPower._system = ""

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " linea :  " & itemRecarga.linea)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " estado :  " & itemRecarga.estado)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " fecha :  " & itemRecarga.fecha)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " nombreUsuario :  " & itemRecarga.nombreUsuario)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " puntoVenta :  " & itemRecarga.puntoVenta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " tipoDocumento :  " & itemRecarga.tipoDocumento)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " numeroDocumento :  " & itemRecarga.numeroDocumento)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " lineaCliente :  " & itemRecarga.lineaCliente)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " montoRecarga :  " & itemRecarga.montoRecarga)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " fechaSwTrx :  " & itemRecarga.fechaSwTrx)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " valorVenta :  " & itemRecarga.valorVenta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " valorDescuento :  " & itemRecarga.valorDescuento)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " valorSubTotal :  " & itemRecarga.valorSubTotal)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " valorIGV :  " & itemRecarga.valorIGV)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " valorTotal :  " & itemRecarga.valorTotal)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " estadoActualizar :  " & itemRecarga.estadoActualizar)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " trace :  " & itemRecarga.trace)
            'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " flagOperacion :  " & itemRecarga.flagOperacion)

            ' Leer Usuario y Contraseña del Key Regedit
            Dim KeyUsrPasRecVirtual As String = ConfigurationSettings.AppSettings("KeyUsrPasRecVirtual")
            Dim objsegu As COM_SIC_Seguridad.Configuracion = New COM_SIC_Seguridad.Configuracion(KeyUsrPasRecVirtual)
            Dim usuario As String
            Dim contraseña As String

            'INC000001492087: INI
            Dim strUsrAplicacionEncriptado As String
            Dim strClaveUsrEncriptado As String
            strUsrAplicacionEncriptado = objsegu.LeerUsuarioEncriptado()
            strClaveUsrEncriptado = objsegu.LeerContrasenaEncriptado()

            Try
                Dim strIDTrans_ As String = String.Empty
                Dim strIpAplicacion_ As String = String.Empty
                Dim strAplicacion_ As String = String.Empty
                strIDTrans_ = Now.Year & Now.Month & Now.Day & Now.Hour & Now.Minute & Now.Second
                strAplicacion_ = ConfigurationSettings.AppSettings("constAplicacion")
                strIpAplicacion_ = AppLOCAL_ADDR
                Dim sAuditoriastring_ As New AuditoriaEWS
                sAuditoriastring_.IDTRANSACCION = strIDTrans_
                sAuditoriastring_.IPAPLICACION = strIpAplicacion_
                sAuditoriastring_.APLICACION = strAplicacion_
                sAuditoriastring_.USRAPP = CurrentUser

                Dim objClave As ConsultaClavesNegocio = New ConsultaClavesNegocio
                Dim mensajeError As String = ""

                Dim codAplicacionClave As String = ConfigurationSettings.AppSettings("strAplicacionSISACT")
                Dim usuarioEncrypt As String = strUsrAplicacionEncriptado
                Dim claveEncrypt As String = strClaveUsrEncriptado
                Dim usuarioDesencrypt As String = String.Empty
                Dim claveDesencrypt As String = String.Empty

                objClave.ejecutarConsultaClave(sAuditoriastring_, codAplicacionClave, usuarioEncrypt, claveEncrypt, usuarioDesencrypt, claveDesencrypt, mensajeError)

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ejecutarConsultaClave Mensaje ws :" & mensajeError)

                usuario = usuarioDesencrypt
                contraseña = claveDesencrypt

            Catch ex As Exception
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ejecutarConsultaClave Exception :" & ex.Message)
            End Try
            'INC000001492087: FIN

            Dim ipAplicacion As String = CurrentTerminal

            objResponse = objActualizarRecVirtual.ActualizarRecargaVirtual(strCanal, _
                                                               strUserSesion, _
                                                               itemRecarga, _
                                                               itemHeaderDataPower, _
                                                               usuario, _
                                                               contraseña, _
                                                               ipAplicacion)

            Dim K_estado As String = objResponse.K_estado
            Dim k_codigo_respuesta As String = objResponse.k_codigo_respuesta
            Dim k_descripcion As String = objResponse.k_descripcion
            Dim k_ubicacionError As String = objResponse.k_ubicacionError
            Dim k_fecha As String = objResponse.k_fecha
            Dim k_origen As String = objResponse.k_origen
            Dim k_xmlRequest As String = objResponse.k_XML_Request
            Dim k_xmlResponse As String = objResponse.k_XML_Response

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " <<<<<<< Parametros de Salida del OSB >>>>>>> ")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " objResponse.K_estado = " & K_estado)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " objResponse.k_codigo_respuesta = " & k_codigo_respuesta)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " objResponse.k_descripcion = " & k_descripcion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " objResponse.k_ubicacionError = " & k_ubicacionError)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " objResponse.k_fecha = " & k_fecha)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " objResponse.k_origen = " & k_origen)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " objResponse.k_XML_Request = " & k_xmlRequest)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " objResponse.k_XML_Response = " & k_xmlResponse)

            If k_codigo_respuesta = "0" Then
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " FIN  RegistrarRecargaVirtual() WS:WBSS_RecargaVirtual ")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " ------------------------------------------------------- ")
                Return True
            Else
                Return False
            End If
        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " ERROR = " & ex.Message)
        End Try
    End Function

    Private Sub CargarVaribalesOLO()
        strCodProductoOLO = clsKeyOLO.strConstCodProdOLO
        strCodActivacionOLO = clsKeyOLO.strConstCodActOLO
        strMobileNumberWS_NumIntentos = clsKeyOLO.strMobileNumberWS_NumIntentos
        strGenericWS_NumIntentos = clsKeyOLO.strGenericEntityWS_NumIntentos
        strVentaWS_NumIntentos = clsKeyOLO.strVentaActivacionWS_NumIntentos
    End Sub

    Public Function LoadConfiguration(ByVal keyGroup As String) As clsTipificationConfiguration

        Dim propName As String
        Dim propValue As Object
        Dim keyList As New clsTipificationConfiguration

        Try

            Dim tipificationList As ArrayList = (New COM_SIC_Activaciones.clsConsultaPvu).ConsultaParametros(keyGroup)

            For Each prop As PropertyInfo In keyList.GetType.GetProperties()

                propName = prop.Name

                For Each oItem As COM_SIC_Activaciones.BEParametros In tipificationList

                    If prop.Name = oItem.strDescripcion Then
                        prop.SetValue(keyList, oItem.strValor, Nothing)
                        Exit For
                    End If

                Next

            Next

        Catch ex As Exception
            Throw ex
        End Try

        Return keyList

    End Function

    Private Function validate_estado_cp(ByVal NroSec As String, ByVal odtPedido As DataTable, _
ByVal odtDetalle As DataTable, ByVal odtLineaEva As DataTable, ByRef strLinea As String, ByVal TipoLinea As String, ByRef strMsgAlert As String) As Short

        Dim intValidarCp As Short = 1
        Dim strconEquipo As String = ""
        Dim strTipoMate As String = ""
        Dim strNroTelefono As String = ""
        Dim strAddLinea As String = ""

        'Dim odtListPorta As DataTable = Me.ListLineasEvaluadasPrepago(NroSec)
        Dim odtListPorta As DataTable = odtLineaEva

        'ListLineasEvaluadasPrepago

        Dim odtHeader As DataTable = odtPedido
        Dim odtDetail As DataTable = odtDetalle
        If (odtHeader.Rows.Count > 0 And odtDetail.Rows.Count > 0) Then
            Dim i As Int32 = 0
            For i = 0 To odtDetail.Rows.Count - 1
                strTipoMate = Funciones.CheckStr(odtDetail.Rows(i)("MATEC_TIPOMATERIAL"))
                'Validar que sea el tipo es CHIP
                If strTipoMate = Funciones.CheckStr(ConfigurationSettings.AppSettings("constChips")) Then
                    strNroTelefono = Funciones.CheckStr(odtDetail.Rows(i)("DEPEV_NROTELEFONO"))
                    If validate_linea(strNroTelefono, odtListPorta, TipoLinea, strMsgAlert) = False Then
                        strLinea = strNroTelefono
                        intValidarCp = 0
                        Exit For
                    Else
                        strAddLinea += strNroTelefono & "|"
                        intValidarCp = 1
                    End If
                End If
            Next
        Else
            'error en el pedido
            intValidarCp = 0
        End If

        If strAddLinea.Length > 0 Then
            strAddLinea = strAddLinea.Substring(0, strAddLinea.Length - 1)
            'Me.hidNroLineas.Value = strAddLinea
        End If

        Return intValidarCp


    End Function

    Private Function validate_linea(ByVal strLinea As String, ByVal listPorta As DataTable, ByVal Tipo As String, ByRef Mensaje As String) As Boolean

        Dim strEstadosPortaCP As String = ConfigurationSettings.AppSettings("ConsEstadosPortaCP").ToString()
        Dim strPortaCPArrys As String()

        If strEstadosPortaCP.IndexOf("|") >= 0 Then
            strPortaCPArrys = strEstadosPortaCP.Split("|"c)
        Else
            strPortaCPArrys = New String(0) {}
            strPortaCPArrys(0) = strEstadosPortaCP
        End If

        Dim bolValidate As Boolean = False
        Dim strEstadoCP As String = ""

        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[{0}|{1}]-INICIO VALIDACION CONSULTA PREVIA", strLinea, Tipo))
        For i As Integer = 0 To listPorta.Rows.Count - 1
            If strLinea.Trim() = Funciones.CheckStr(listPorta.Rows(i)("PORT_NUMERO")) Then
                Dim bolExit As Boolean = True
                'PROY-32089 INI
                Dim str_TIPO_VENTA = ""
                Select Case Tipo
                    Case "PREPAGO"
                        str_TIPO_VENTA = ConfigurationSettings.AppSettings("strTVPrepago")
                    Case "POSTPAGO"
                        str_TIPO_VENTA = ConfigurationSettings.AppSettings("strTVPostpago")
                End Select
                Dim oBEPorttConfiguracion As New BEPorttConfiguracion
                With oBEPorttConfiguracion
                    .PORTV_EST_PROCESO = Funciones.CheckStr(listPorta.Rows(i)("SOPOC_ESTA_PROCESO_CP"))
                    .PORTV_MOTIVO = Funciones.CheckStr(listPorta.Rows(i)("SOPOV_MOTIVO_CP"))
                    .PORTV_FLAG_ACREDITA = Funciones.CheckStr(Funciones.CheckInt(listPorta.Rows(i)("SOPOC_FLAG_ACREDITACION")))
                    .PORTV_OPERADOR = Funciones.CheckStr(listPorta.Rows(i)("SOPOC_CODIGO_CEDENTE"))
                    .PORTC_TIPO_PRODUCTO = Funciones.CheckStr(listPorta.Rows(i)("PRDC_CODIGO"))
                    .PORTV_TIPO_VENTA = str_TIPO_VENTA ' PROY-32089
                    .PORTV_MOD_VENTA = IIf(Funciones.CheckStr(listPorta.Rows(i)("SOPOC_CHIPPACK")).Trim() = "C", "|C|", "|P|")
                    .PORTV_APLICACION = ConfigurationSettings.AppSettings("ConsNombreAplicacion")
                End With
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[{0}|{1}]-INICIO VALIDACION CONSULTA PREVIA-[{2}-{3}-{4}-{5}-{6}-{7}]", strLinea, Tipo, oBEPorttConfiguracion.PORTV_EST_PROCESO, oBEPorttConfiguracion.PORTV_MOTIVO, oBEPorttConfiguracion.PORTV_FLAG_ACREDITA, oBEPorttConfiguracion.PORTV_OPERADOR, oBEPorttConfiguracion.PORTC_TIPO_PRODUCTO, oBEPorttConfiguracion.PORTV_MOD_VENTA))
                Dim resultValidacionCP() As String = New ClsPortabilidad().PorttValidaABCDP(oBEPorttConfiguracion)
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[{0}|{1}]-INICIO VALIDACION CONSULTA PREVIA-[{2}-{3}-{4}]", strLinea, Tipo, resultValidacionCP(0), resultValidacionCP(1), resultValidacionCP(2)))
                bolExit = (resultValidacionCP(0) = 0)
                If bolExit = False Then
                    'rechazar el pago no es procedente para la portabiliad
                    bolValidate = False
                    Mensaje = String.Format(ConfigurationSettings.AppSettings("ConsPortaCPRechazoPago"), strLinea.Trim())
                    Exit For
                Else
                    bolValidate = True
                End If
                'PROY-32089 FIN
            End If
        Next
        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("[{0}|{1}]-FIN VALIDACION CONSULTA PREVIA", strLinea, Tipo))
        Return bolValidate
    End Function

    Private Function ListLineasEvaluadasPostPago(ByVal NroSec As String) As DataTable

        Dim dsData As DataSet
        Dim objPorta As New ClsPortabilidad

        Dim estadoSPEjecutarPort As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("constEstadoSPEjecutarPortabilidad"))

        dsData = objPorta.ObtenerLineasPortabilidadPost(NroSec, Nothing, "", estadoSPEjecutarPort, "")

        Return dsData.Tables(0)

    End Function

    Private Function ListLineasEvaluadasPrepago(ByVal NroSec As String) As DataTable
        Dim dsData As DataSet
        Dim objPorta As New ClsPortabilidad
        dsData = objPorta.ObtenerLineasPortabilidadPre(NroSec, "")
        Return dsData.Tables(0)
    End Function

    Private Sub PagarNotaCanje(ByVal nroPedido As String, ByVal dsPedido As DataSet, ByRef strRespPago As Boolean) 'PROY 23700 ACB
        '***** VARIABLES *****'
        Dim objClsMsSap As New COM_SIC_Activaciones.clsConsultaMsSap
        Dim objTrsMsSap As New COM_SIC_Activaciones.clsTrsMsSap
        Dim strIdentifyLog As String = nroPedido
        Dim estadoPagado As String = System.Configuration.ConfigurationSettings.AppSettings("ESTADO_PAG")
        Dim desMoneda As String = System.Configuration.ConfigurationSettings.AppSettings("MONEDA")
        Dim CorrNotaCanje As String = Funciones.CheckStr(drPagos.Item("PAGOC_CODSUNAT"))
        Dim K_PAGON_IDPAGO As Int64
        Dim K_PAGOC_CORRELATIVO As String = ""
        Dim cboTipDocumento = AppCboTipoDocumento
        Dim cboDescTipDocumento As String = DevuelteTipoDescPago(cboTipDocumento)
        Dim montoPagar As String = ApptxtMonto1
        Dim claseFactCanje As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA"))
        Dim oficinaVenta As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("OFICV_CODOFICINA"))
        Dim NROLOG As String = ""
        Dim NROLOG_DET As String = ""
        Dim DESLOG As String = ""
        Dim DESLOG_DET As String = ""
        Dim objActiv As New COM_SIC_Activaciones.clsBDSiscajas
        Dim msgj As String = ""

        Try
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " ------------------------------------")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "     INICIO PAGOS NOTA DE CANJE")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " ------------------------------------")

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "     INICIO [ConsultaCorrelativoNotasCanje]")
            If CorrNotaCanje = "0000000000000000" Then
                objClsMsSap.ConsultaCorrelativoNotasCanje(CorrNotaCanje, NROLOG, DESLOG)
            Else
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [Correlativo: " & CorrNotaCanje & "]")
                NROLOG = "0"
                DESLOG = "OK"
            End If

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [OUT Correlativo: " & CorrNotaCanje & "]")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [OUT NROLOG: " & NROLOG & "]")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [OUT DESLOG: " & DESLOG & "]")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "     FIN [ConsultaCorrelativoNotasCanje]")

            If NROLOG = "0" AndAlso DESLOG = "OK" Then
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "     INICIO [RegistrarPago]")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [IN NRO PEDIDO: " & nroPedido & "]")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [IN FECHA CONTA: ]")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [IN ESTADO: " & estadoPagado & "]")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [IN CAJA: CAJA PRUEBA]")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [IN NRO CAJA: 0 ]")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [IN USUARIO: " & AppUsuario & "]")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [IN FECHA CREA: ]")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [IN USUARIO MOD: " & AppUsuario & "]")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [IN FECHA MODI: ]")

                objTrsMsSap.RegistrarPago(nroPedido, _
                                        DBNull.Value, _
                                        estadoPagado, _
                                        "CAJA PRUEBA", _
                                        0, _
                                        desMoneda, _
                                        AppUsuario, _
                                        DBNull.Value, _
                                        AppUsuario, _
                                        DBNull.Value, _
                                        NROLOG, DESLOG, K_PAGON_IDPAGO, K_PAGOC_CORRELATIVO)

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [OUT NROLOG: " & NROLOG & "]")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [OUT DESLOG: " & DESLOG & "]")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [OUT K_PAGON_IDPAGO: " & K_PAGON_IDPAGO & "]")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [OUT K_PAGOC_CORRELATIVO: " & K_PAGOC_CORRELATIVO & "]")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "     FIN [RegistrarPago]")

                If DESLOG <> "OK" Then
                    strRespPago = False
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "     [ERROR - RegistrarPago]")
                    DeshacerCambiosPagos(K_PAGON_IDPAGO)
                    If AppCodigoDeshacerCambios = "-3" Then
                        Exit Sub
                    End If
                Else
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "     INICIO [RegistrarDetallePago]")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [IN NRO PAGO: " & K_PAGON_IDPAGO & "]")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [IN TIPO DOC: " & cboTipDocumento & "]")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [IN DES DOC: " & cboDescTipDocumento & "]")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [IN MONEDA: " & desMoneda & "]")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [IN MONTO: " & montoPagar & "]")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [IN USUARIO: " & AppUsuario & "]")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [IN FECHA CREA: ]")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [IN USUARIO MOD: " & AppUsuario & "]")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [IN FECHA MODI: ]")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [IN REF NC/ND: ]")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [IN PEDIDO REF: ]")

                    objTrsMsSap.RegistrarDetallePago(K_PAGON_IDPAGO, _
                                                     cboTipDocumento, _
                                                     cboDescTipDocumento, _
                                                     desMoneda, _
                                                     Funciones.CheckDbl(montoPagar), _
                                                     AppUsuario, _
                                                     DBNull.Value, AppUsuario, _
                                                     DBNull.Value, _
                                                     "", 0, _
                                                     NROLOG_DET, DESLOG_DET)

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [OUT NROLOG_DET: " & NROLOG_DET & "]")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [OUT DESLOG_DET: " & DESLOG_DET & "]")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "     FIN [RegistrarDetallePago]")

                    If DESLOG_DET <> "OK" Then
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "     [ERROR - RegistrarDetallePago]")
                        DeshacerCambiosPagos(K_PAGON_IDPAGO)
                        If AppCodigoDeshacerCambios = "-3" Then
                            Exit Sub
                        End If
                    Else
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "     INICIO [ActualizarPagodelPedido]")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [IN NRO PEDIDO: " & nroPedido & "]")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [IN NRO PAGO: " & K_PAGON_IDPAGO & "]")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [IN CORRELATIVO NOTA CANJE: " & CorrNotaCanje & "]")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [IN CLASE FACTURA: " & claseFactCanje & "]")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [IN OFICINA VENTA: " & oficinaVenta & "]")

                        objTrsMsSap.ActualizarPagodelPedido(nroPedido, _
                                                           K_PAGON_IDPAGO, _
                                                           CorrNotaCanje, _
                                                           claseFactCanje, _
                                                           oficinaVenta, _
                                                           NROLOG, DESLOG)

                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [OUT NROLOG: " & NROLOG & "]")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "        [OUT DESLOG: " & DESLOG & "]")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "     FIN [ActualizarPagodelPedido]")

                        If DESLOG <> "OK" Then
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "     [ERROR - ActualizarPagodelPedido]")
                            DeshacerCambiosPagos(K_PAGON_IDPAGO)
                            If AppCodigoDeshacerCambios = "-3" Then
                                Exit Sub
                            End If
                        Else

                            '***********************************************************************************************************
                            '**INICIO FC***''
                            '*** REGISTRO DE DATOS PARA EL FLUJO DE CAJA ***'
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Registro datos del Flujo Caja")
                            objCajas = New COM_SIC_Cajas.clsCajas
                            Dim cultureName As String = "es-PE"
                            Dim culture As CultureInfo = New CultureInfo(cultureName)
                            Dim dateTimeValue As DateTime
                            dateTimeValue = Convert.ToDateTime(DateTime.Now, culture)
                            Dim dblEfectivo As Decimal = 0

                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "---------------------------------------- ")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Registro datos del Flujo Caja")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Formato de fechas para FC: yyyymmdd")

                            If Not dsPedido.Tables(0).Rows(0).Item("PEDID_FECHADOCUMENTO") Is Nothing Then
                                fechaCajas = CDate(dsPedido.Tables(0).Rows(0).Item("PEDID_FECHADOCUMENTO")).ToString("yyyyMMdd")
                            Else
                                fechaCajas = Format(Now.Year, "0000").ToString.Trim & Format(Now.Month, "00").ToString.Trim & Format(Now.Day, "00").ToString.Trim
                            End If
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- fechaCajas : " & fechaCajas.ToString)

                            ''''1. Registro de pago: TABLA "TI_VENTAS_FACT"
                            '''*Para las notas de crèdito el monto del saldo enviado debe ser 0.00
                            Dim PEDIC_CLASEFACTURA As String = "" 'valor que sera reemplazado por una key si es una recarga virtual frecuente

                            Try
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio método : RegistrarPago")

                                If dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEPEDIDO") = System.Configuration.ConfigurationSettings.AppSettings("PEDIC_CLASEPEDIDO_RVF") Then
                                    PEDIC_CLASEFACTURA = System.Configuration.ConfigurationSettings.AppSettings("DESC_BOLETA_RVF")
                                Else
                                    PEDIC_CLASEFACTURA = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA"))
                                End If

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_OFICINA_VENTA: " & AppAlmacen)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_FECHA : " & fechaCajas)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_CAJERO : " & Microsoft.VisualBasic.Right(Funciones.CheckStr("0000000000" & AppUsuario), 10))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_DESC_DOCUMENTO : " & dsPedido.Tables(0).Rows(0).Item("PEDIV_DESCCLASEFACTURA"))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_FACTURA_FICTICIA : " & nroPedido)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_REFERENCIA : " & CorrNotaCanje)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_VENDEDOR : " & Microsoft.VisualBasic.Right(Funciones.CheckStr("0000000000" & dsPedido.Tables(0).Rows(0).Item("VENDEDOR")), 10))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_MONEDA : " & System.Configuration.ConfigurationSettings.AppSettings("MONEDA"))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_CLASE_FACTURA_COD : " & PEDIC_CLASEFACTURA)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_NRO_CUOTAS : " & dsPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA"))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_TOTAL_FACTURA : " & dsPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO"))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_SALDO : " & IIf(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA") <> ConfigurationSettings.AppSettings("strTipDoc"), dsPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO"), 0))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_REFERENCIA_ORIG : " & IIf(IsDBNull(dsPedido.Tables(0).Rows(0).Item("PEDIV_NROREFNCND")), "", dsPedido.Tables(0).Rows(0).Item("PEDIV_NROREFNCND")))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_ESTADO : " & System.Configuration.ConfigurationSettings.AppSettings("ESTADO_VENTA_FLUJOCAJA"))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_NODO : " & Funciones.CheckStr(Right(System.Net.Dns.GetHostName, 2)))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_USUARIO_CREACION : " & System.Configuration.ConfigurationSettings.AppSettings("ConstCuentasCliente_Usuario"))

                                resCajas = objCajas.RegistrarPagoAPK(AppAlmacen, fechaCajas, _
                                                            Microsoft.VisualBasic.Right(Funciones.CheckStr("0000000000" & AppUsuario), 10), _
                                                            dsPedido.Tables(0).Rows(0).Item("PEDIV_DESCCLASEFACTURA"), _
                                                            nroPedido, CorrNotaCanje, _
                                                            Microsoft.VisualBasic.Right(Funciones.CheckStr("0000000000" & dsPedido.Tables(0).Rows(0).Item("VENDEDOR")), 10), _
                                                            System.Configuration.ConfigurationSettings.AppSettings("MONEDA"), _
                                                            PEDIC_CLASEFACTURA, _
                                                            dsPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA"), _
                                                            dsPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO"), _
                                                            IIf(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA") <> ConfigurationSettings.AppSettings("strTipDoc"), dsPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO"), 0), _
                                                            IIf(IsDBNull(dsPedido.Tables(0).Rows(0).Item("PEDIV_NROREFNCND")), "", dsPedido.Tables(0).Rows(0).Item("PEDIV_NROREFNCND")), _
                                                            System.Configuration.ConfigurationSettings.AppSettings("ESTADO_VENTA_FLUJOCAJA"), _
                                                            Funciones.CheckStr(Right(System.Net.Dns.GetHostName, 2)), _
                                                            System.Configuration.ConfigurationSettings.AppSettings("ConstCuentasCliente_Usuario"), _
                                                            "1", P_ID_TI_VENTAS_FACT, P_MSGERR)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin método : RegistrarPago")

                                'PROY-23700-IDEA-29415 - INI

                                Dim sUrl As String = "Terminar.aspx"
                                Dim strDocSap As String = drPagos.Item("PEDIN_NROPEDIDO")
                                Dim strDocSunat As String = ""
                                Dim strNroDG As String = ""
                                Dim RecibidoDolares As Double
                                RecibidoDolares = CDbl(txtTipoCambio) * CDbl(txtRecibidoUsd)
                                strDocSunat = ""
                                Dim pTipDoc As String = ""
                                Dim flagVentaEquipoPrepago As String = "0"

                                If drPagos.Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVPrepago") Then
                                    Dim blnConEquipo As Boolean
                                    blnConEquipo = validaVentaEquipo("", dsPedido.Tables(1))
                                    If blnConEquipo Then
                                        flagVentaEquipoPrepago = "1"
                                    End If
                                End If

                                pTipDoc = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("CLIEC_TIPODOCCLIENTE"))

                                'Try
                                '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                                '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Llama a la impresiòn del documento: " & Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")))

                                '    strRespPago = True

                                '    ACA SE ESPECIFICA "NCJ" PARA LA IMPRESION DE NOTAS DE CANJE
                                '    sUrl &= "?pImp=NCJ" & _
                                '    "&pDocSap=" & strDocSap & _
                                '   "&pDocSunat=" & strDocSunat & _
                                '   "&pNroDG=" & strNroDG & _
                                '           "&pTipDoc=" & pTipDoc & _
                                '           "&strEfectivo=" & txtNeto & _
                                '           "&strRecibidoUS=" & CStr(RecibidoDolares) & _
                                '           "&strRecibido=" & txtRecibidoPen & _
                                '           "&strEntregar=" & txtVuelto & _
                                '           "&flagVentaEquipoPrepago=" & flagVentaEquipoPrepago & _
                                '           "&strOrigen=" & 1

                                'Catch ex As Exception
                                '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Error al tratar de ejecutar la impresiòn.")
                                '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                                'End Try

                                'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- sUrl: " & sUrl)
                                'Response.Redirect(sUrl, False)


                                'PROY-23700-IDEA-29415 - FIN


                            Catch ex As Exception
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error al tratar de ejecutar el método:  RegistrarPago")
                            End Try

                            If P_ID_TI_VENTAS_FACT > 0 Then
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Código generado en la tabla TI_VENTAS_FACT=> " & P_ID_TI_VENTAS_FACT.ToString)
                            Else
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Error devuelto : " & P_MSGERR.ToString)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Error, no se realizo el registro en TI_VENTAS_FACT")
                                objActiv.AsignarPagoAcuerdosXDocSap(nroPedido, "", 0, CurrentUser, msgj)
                            End If
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Registro datos del Flujo Caja")
                            '**FIN FC
                            '*********************************************************************************************************

                            'INI - INSERTAR EFECTIVO - CCC
                            Dim nroCuotas As Integer = 0
                            If Not CBool(ApprecargaVirtual) Then
                                nroCuotas = CStr(drPagos.Item("DEPEN_NROCUOTA"))
                            End If
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio FP_InsertaEfectivo.")
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp ALMACEN: " & AppAlmacen)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp USUARIO: " & AppUsuario)
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp dblEfectivo: " & CStr(dblEfectivo))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp FECHA: " & CStr(dsPedido.Tables(0).Rows(0).Item("PEDID_FECHADOCUMENTO")))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Cuotas : " & nroCuotas.ToString())
                            Dim dFecha As Date
                            Dim sFecha As String = Format(Now.Day, "00").ToString.Trim & "/" & Format(Now.Month, "00").ToString.Trim & "/" & Format(Now.Year, "0000").ToString.Trim
                            If Not dsPedido.Tables(0).Rows(0).Item("PEDID_FECHADOCUMENTO") Is Nothing Then
                                dFecha = CDate(dsPedido.Tables(0).Rows(0).Item("PEDID_FECHADOCUMENTO"))
                                sFecha = dFecha.ToString("dd/MM/yyyy")
                            End If
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - Fecha Pedido : " & sFecha)
                            If nroCuotas = 0 Then  ' No se contabliza el pago en cuotas
                                objCajas.FP_InsertaEfectivo(AppAlmacen, AppUsuario, dblEfectivo, sFecha)     'Se inserta el efectivo obtenido
                            End If
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin FP_InsertaEfectivo.")
                            'FIN - INSERTAR EFECTIVO - CCC

                            AppstrMensajeCaja = System.Configuration.ConfigurationSettings.AppSettings("msgNotaCanjeOK")
                        End If
                    End If
                End If
            End If

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " ------------------------------------")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "     FIN PAGOS NOTA DE CANJE")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " ------------------------------------")

        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "[ERROR - PagarNotaCanje] " & ex.Message.ToString())
            AppstrMensajeCaja = System.Configuration.ConfigurationSettings.AppSettings("msgNotaCanjeError")
        End Try

    End Sub
#End Region

    'PROY-140582 - INI
    Public Function PagarPM(ByVal strDocumentoSap As String, _
                            ByVal strNumeroDocumento As String, _
                            ByVal strMontoRecarga As String, _
                            ByVal strCodMedioPago As String, _
                            ByVal oEmpleados As BEDatosEmpleado, _
                            ByVal strIpLocal As String, _
                            ByVal TipoDocCliente As String, _
                            ByVal NroDocCliente As String, _
                            ByVal strTipoDocVendedor As String, _
                            ByVal strNumDocVendedor As String, _
                            ByVal strNumReferencia As String, _
                            ByVal strTipoOperacionServ As String, _
                            ByVal strMontoTotal As String, _
                            ByVal strFlagTiendaVirtual As String, _
                            ByVal strFlagBiometria As String, _
                            ByVal UUID As String, _
                            ByVal blFlagPortabilidad As Boolean, _
                            ByVal idPedido As String, _
                            ByVal identificadorProceso As String, _ 
                            ByRef objBEResponseWebMethod As BEResponseWebMethod) As Boolean

        Dim rpta As Boolean = False
        Dim estado_pago As String = String.Empty
        objBEResponseWebMethod = New BEResponseWebMethod
        Dim sbTrazabilidad As StringBuilder = New StringBuilder
        Dim strTrazabilidad As String = String.Empty

        IdentificadorLog = String.Format("{0} || {1} || {2} ", identificadorProceso, strDocumentoSap, UUID) 'INICIATIVA-1006|TIENDA VIRTUAL - ACC CON COSTO
        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1}", IdentificadorLog, "Inicio Pagar Proteccion Movil"))

        Try

            Dim dsPedido As DataSet
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1}", IdentificadorLog, "Inicio Consulta los datos del pedido"))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} => {2}", IdentificadorLog, "Consulta los datos del pedido - Pedido", strDocumentoSap))
            dsPedido = objConsultaMsSap.ConsultaPedido(strDocumentoSap, "", "")
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1}", IdentificadorLog, "Fin Consulta los datos del pedido"))

            If Not dsPedido Is Nothing AndAlso dsPedido.Tables.Count > 0 AndAlso dsPedido.Tables(0).Rows.Count > 0 Then

                Dim strFechaPedido As String = String.Empty
                Dim strTipoVentaPago As String = String.Empty
                Dim strTipoOperacionPago As String = String.Empty

                strFechaPedido = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDID_FECHADOCUMENTO"))
                strTipoVentaPago = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA"))
                strTipoOperacionPago = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION"))

                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "strDocumentoSap", Funciones.CheckStr(strDocumentoSap)))
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "strNumeroDocumento", Funciones.CheckStr(strNumeroDocumento)))
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "strMontoRecarga", Funciones.CheckStr(strMontoRecarga)))
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "strCodMedioPago", Funciones.CheckStr(strCodMedioPago)))
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "strIpLocal", Funciones.CheckStr(strIpLocal)))
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "TipoDocCliente", Funciones.CheckStr(TipoDocCliente)))
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "NroDocCliente", Funciones.CheckStr(NroDocCliente)))
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "strTipoDocVendedor", Funciones.CheckStr(strTipoDocVendedor)))
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "strNumReferencia", Funciones.CheckStr(strNumReferencia)))
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "strTipoOperacionServ", Funciones.CheckStr(strTipoOperacionServ)))
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "strMontoTotal", Funciones.CheckStr(strMontoTotal)))
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "strFlagTiendaVirtual", Funciones.CheckStr(strFlagTiendaVirtual)))
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "strFlagBiometria", Funciones.CheckStr(strFlagBiometria)))
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "UUID", Funciones.CheckStr(UUID)))
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "FechaPedido", Funciones.CheckStr(strFechaPedido)))
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "strTipoVentaPago", Funciones.CheckStr(strTipoVentaPago)))
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "strTipoOperacionPago", Funciones.CheckStr(strTipoOperacionPago)))
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "blFlagPortabilidad", Funciones.CheckStr(blFlagPortabilidad)))
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "idPedido", Funciones.CheckStr(idPedido)))

                If LoadSesiones(strDocumentoSap, _
                             strNumeroDocumento, _
                             strFechaPedido, _
                             strCodMedioPago, _
                             TipoDocCliente, _
                             NroDocCliente, _
                             strTipoDocVendedor, _
                             strNumDocVendedor, _
                             strNumReferencia, _
                             strTipoOperacionServ, _
                             strMontoTotal, _
                             strCodMedioPago, _
                             strFlagTiendaVirtual, _
                             strFlagBiometria, _
                             UUID, _
                             strTipoVentaPago, _
                             strTipoOperacionPago, _
                             blFlagPortabilidad, _
                             oEmpleados) Then

                    guardarConectado()

                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} => {2}", IdentificadorLog, "Consulta los datos del pedido", Funciones.CheckStr(strDocumentoSap)))
                    dsPedido = objConsultaMsSap.ConsultaPedido(strDocumentoSap, "", "")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1}", IdentificadorLog, "Fin consulta pedido."))

                    If Not dsPedido Is Nothing AndAlso dsPedido.Tables.Count > 0 AndAlso dsPedido.Tables(0).Rows.Count > 0 Then

                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} -{1}", IdentificadorLog, "Consulta los datos del pedido=> true"))

                        estado_pago = dsPedido.Tables(0).Rows(0).Item("PEDIC_ESTADO")

                        If estado_pago = ConfigurationSettings.AppSettings("ESTADO_PAG") Then

                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1}", IdentificadorLog, "Pedido en estado pagado correcto"))

                            rpta = True
                            objBEResponseWebMethod.CodigoRespuesta = "0"
                            objBEResponseWebMethod.MensajeRespuesta = "Pago Realizado con éxito."

                            Try

                                Dim fechaRegistro As DateTime = DateTime.Now
                                Dim strCodRpta As String = String.Empty
                                Dim strMsjRpta As String = String.Empty

                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "objBEResponseWebMethod.CodigoRespuesta", Funciones.CheckStr(objBEResponseWebMethod.CodigoRespuesta)))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "objBEResponseWebMethod.MensajeRespuesta", Funciones.CheckStr(objBEResponseWebMethod.MensajeRespuesta)))

                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "Numero Pedido", Funciones.CheckStr(AppQpDocSap)))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "Punto de Venta", Funciones.CheckStr(AppAlmacen)))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "Identificador", Funciones.CheckStr(AppUUID)))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "Fecha Registro", Funciones.CheckStr(fechaRegistro)))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "Es Renta", "N"))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "Pedido Alta", Funciones.CheckStr(idPedido)))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "Monto Calculado", Funciones.CheckStr(AppMontoPagar)))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "Monto Pagado", Funciones.CheckStr(ApptxtMonto1)))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "TipoDoc Vendedor", Funciones.CheckStr(AppTipoDocVendedor)))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "NumDoc Vendedor", Funciones.CheckStr(AppNumDocVendedor)))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "Numero Referencia", Funciones.CheckStr(AppNumeroReferencia)))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "Cod Medio Pago", Funciones.CheckStr(AppCodMedioPago)))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "Tipo Operacion", Funciones.CheckStr(AppTipoOperacion)))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "Flag Biometria", Funciones.CheckStr(AppFlagBiometria)))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "Flag Actualizar MSSAP", Funciones.CheckStr(AppActualizarMSSAP)))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "Flag ActivosPostpagoConvergente", Funciones.CheckStr(AppActivosPostpagoConvergente)))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "Flag Actualizar Contrato", Funciones.CheckStr(AppActualizarContrato)))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "Flag Envio a SAP", Funciones.CheckStr(AppEnvioSAP)))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "Flag Envio a Paperless", Funciones.CheckStr(AppPaperless)))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", IdentificadorLog, "Flag Tienda Virtual", Funciones.CheckStr(AppFlagTiendaVirtual)))


                                Dim idNumeroPedido As Int64 = Funciones.CheckInt64(AppQpDocSap)
                                Dim dblMontoCalculado As Double = Funciones.CheckDbl(AppMontoPagar)
                                Dim dblMontoPagado As Double = Funciones.CheckDbl(ApptxtMonto1)


                                objTrsMsSap.RegistrarPagoSrvSicar(idNumeroPedido, _
                                                                  AppAlmacen, _
                                                                  AppUUID, _
                                                                  AppstrUsuario, _
                                                                  fechaRegistro, _
                                                                  "N", _
                                                                  Funciones.CheckInt64(idPedido), _
                                                                  dblMontoCalculado, _
                                                                  dblMontoPagado, _
                                                                  AppTipoDocVendedor, _
                                                                  AppNumDocVendedor, _
                                                                  AppNumeroReferencia, _
                                                                  AppFlagBiometria, _
                                                                  AppActualizarMSSAP, _
                                                                  AppActivosPostpagoConvergente, _
                                                                  AppActualizarContrato, _
                                                                  AppEnvioSAP, _
                                                                  AppPaperless, _
                                                                  AppCodMedioPago, _
                                                                  AppFlagTiendaVirtual, _
                                                                  AppTipoOperacion, _
                                                                  strCodRpta, _
                                                                  strMsjRpta)


                                rpta = True
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Codigo Respuesta", Funciones.CheckStr(strCodRpta)))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Mensaje Respuesta", Funciones.CheckStr(strMsjRpta)))

                                objBEResponseWebMethod.CodigoRespuesta = "0"
                                objBEResponseWebMethod.MensajeRespuesta = "Pago Realizado con éxito."

                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "objBEResponseWebMethod.CodigoRespuesta", Funciones.CheckStr(objBEResponseWebMethod.CodigoRespuesta)))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "objBEResponseWebMethod.MensajeRespuesta", Funciones.CheckStr(objBEResponseWebMethod.MensajeRespuesta)))
                            Catch ex As Exception

                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "ERROR AL GRABAR EN SSAPT_PAGO_SRVSICAR", Funciones.CheckStr(ex.Message)))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "ERROR AL GRABAR EN SSAPT_PAGO_SRVSICAR", Funciones.CheckStr(ex.StackTrace)))

                                sbTrazabilidad.AppendFormat("{0} || ", "Ocurrio un error al registrar en MSSAP(SSAPT_PAGO_SRVSICAR)")

                            End Try


                            If (AppMensajeErrorGeneral.Length > 0) Then

                                sbTrazabilidad.AppendFormat("{0} || ", AppMensajeErrorGeneral)
                                AppMensajeErrorGeneral = String.Empty

                            ElseIf (AppSPError.Length > 0) Then

                                sbTrazabilidad.Append(AppSPError)
                                AppSPError = String.Empty

                            ElseIf Not AppErrorPedido Is Nothing And AppErrorPedido <> "" Then

                                sbTrazabilidad.AppendFormat("{0} || ", AppErrorPedido)
                                AppErrorPedido = String.Empty

                            ElseIf Not hidMensajeNC Is Nothing And hidMensajeNC <> "" Then
                                sbTrazabilidad.AppendFormat("{0} || ", hidMensajeNC)
                                hidMensajeNC = String.Empty

                            ElseIf Not AppErrorCaja Is Nothing And AppErrorCaja <> "" Then
                                sbTrazabilidad.AppendFormat("{0} || ", AppErrorCaja)
                                AppErrorCaja = String.Empty

                            ElseIf Not AppErrorPagoParcial Is Nothing And AppErrorPagoParcial <> "" Then
                                sbTrazabilidad.AppendFormat("{0} || ", AppErrorPagoParcial)
                                AppErrorPagoParcial = String.Empty

                            ElseIf Not AppErrorRenovacionRPM6 Is Nothing And AppErrorRenovacionRPM6 <> "" Then
                                sbTrazabilidad.AppendFormat("{0} || ", AppErrorRenovacionRPM6)
                                AppErrorRenovacionRPM6 = String.Empty

                            ElseIf Not AppmsgActivacionCAC Is Nothing And AppmsgActivacionCAC <> "" Then
                                sbTrazabilidad.AppendFormat("{0} || ", AppmsgActivacionCAC)
                                AppmsgActivacionCAC = String.Empty

                            ElseIf Not AppmensajeErrorBonoPrepago Is Nothing And AppmensajeErrorBonoPrepago <> "" Then
                                sbTrazabilidad.AppendFormat("{0} || ", AppmensajeErrorBonoPrepago)
                                AppmensajeErrorBonoPrepago = String.Empty

                            ElseIf Not AppPagoBSCSRenovacionCorporativa Is Nothing And AppPagoBSCSRenovacionCorporativa <> "" Then
                                sbTrazabilidad.AppendFormat("{0} || ", AppPagoBSCSRenovacionCorporativa)
                                AppPagoBSCSRenovacionCorporativa = String.Empty

                            ElseIf Not AppmensajeErrorLineas Is Nothing And AppmensajeErrorLineas <> "" Then
                                sbTrazabilidad.AppendFormat("{0} || ", AppmensajeErrorLineas)
                                AppmensajeErrorLineas = String.Empty

                            ElseIf Not AppstrMensajeWSCABB Is Nothing And AppstrMensajeWSCABB <> "" Then
                                sbTrazabilidad.AppendFormat("{0} || ", AppstrMensajeWSCABB)
                                AppstrMensajeWSCABB = String.Empty

                            ElseIf Not AppmsgErrorGenerarSot Is Nothing And AppmsgErrorGenerarSot <> "" And (AppmsgErrorDevolverRV Is Nothing Or AppmsgErrorDevolverRV = "") Then
                                sbTrazabilidad.AppendFormat("{0} || ", AppmsgErrorGenerarSot)
                                AppmsgErrorGenerarSot = String.Empty

                            ElseIf Not AppmsgErrorDevolverRV Is Nothing And AppmsgErrorDevolverRV <> "" Then
                                sbTrazabilidad.AppendFormat("{0} || ", AppmsgErrorDevolverRV)
                                AppmsgErrorDevolverRV = String.Empty

                            ElseIf Not AppmsgDevolucion Is Nothing And AppmsgDevolucion <> "" Then
                                sbTrazabilidad.AppendFormat("{0} || ", AppmsgDevolucion)
                                AppmsgDevolucion = String.Empty

                            ElseIf Not AppmensajeErrorDOL Is Nothing And AppmensajeErrorDOL <> "" Then
                                sbTrazabilidad.AppendFormat("{0} || ", AppmensajeErrorDOL)
                                AppmensajeErrorDOL = String.Empty

                            ElseIf Len(Trim(AppmensajeCHIPRepuesto)) > 0 Then
                                sbTrazabilidad.AppendFormat("{0} || ", AppmensajeCHIPRepuesto)
                                AppmensajeCHIPRepuesto = String.Empty

                            ElseIf Len(Trim(AppstrMensajeCaja)) > 0 Then
                                sbTrazabilidad.AppendFormat("{0} || ", AppstrMensajeCaja)
                                AppstrMensajeCaja = String.Empty

                            ElseIf Len(Trim(AppstrMensajeCajaRec)) > 0 Then
                                sbTrazabilidad.AppendFormat("{0} || ", AppstrMensajeCajaRec)
                                AppstrMensajeCajaRec = String.Empty

                            ElseIf Len(Trim(AppP_MSJ_RESULTADO)) > 0 Then
                                sbTrazabilidad.AppendFormat("{0} || ", AppP_MSJ_RESULTADO)
                                AppP_MSJ_RESULTADO = String.Empty

                            ElseIf Not AppmsgErrorInsertaMail Is Nothing And AppmsgErrorInsertaMail <> "" Then
                                sbTrazabilidad.AppendFormat("{0} || ", AppmsgErrorInsertaMail)
                                AppmsgErrorInsertaMail = String.Empty

                            ElseIf Not AppmensajeErrorLineas Is Nothing And AppmensajeErrorLineas <> "" Then
                                sbTrazabilidad.AppendFormat("{0} || ", AppmensajeErrorLineas)
                                AppmensajeErrorLineas = String.Empty

                            ElseIf Not AppMensajeErrorPagoCanjeAW Is Nothing And AppMensajeErrorPagoCanjeAW <> "" Then
                                sbTrazabilidad.Append(AppMensajeErrorPagoCanjeAW)
                                AppMensajeErrorPagoCanjeAW = String.Empty
                            End If

                            strTrazabilidad = Funciones.CheckStr(sbTrazabilidad)

                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "strTrazabilidad", Funciones.CheckStr(strTrazabilidad)))

                            objBEResponseWebMethod.MensajeErrror = strTrazabilidad

                        Else

                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Pedido no se encuentra pagado"))

                            If AppCodigoExitFunction = "-2" Then

                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Hay error que truncaron el pago"))
                                objBEResponseWebMethod.CodigoRespuesta = "-1"
                                objBEResponseWebMethod.MensajeRespuesta = "Ocurrio un error al realizar el pago de la Boleta/Factura"

                                AppCodigoExitFunction = String.Empty
                                AppMensajeExitFunction = String.Empty

                            Else
                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "No hay errores que truncaron el pago, ocurrio un error parcial"))
                                objBEResponseWebMethod.CodigoRespuesta = "-1"
                                objBEResponseWebMethod.MensajeRespuesta = "Ocurrio un error al realizar el pago de la Boleta/Factura"
                            End If
                        End If

                    Else
                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} => {2}", IdentificadorLog, "Consultar los datos del pedido de Proteccion Movil, no retorno datos"))

                        objBEResponseWebMethod.CodigoRespuesta = "-1"
                        objBEResponseWebMethod.MensajeRespuesta = "Ocurrio un error al realizar el pago de la Protección Movil"

                    End If

                Else
                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} => {2}", IdentificadorLog, "Ocurrio un error en el metodo LOAD SESSIONES"))

                    objBEResponseWebMethod.CodigoRespuesta = "-1"
                    objBEResponseWebMethod.MensajeRespuesta = "Ocurrio un error en el Load del metodo pagar"

                End If

            Else
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} => {2}", IdentificadorLog, "Consultar los datos del pedido de Proteccion Movil, no retorno datos"))

                objBEResponseWebMethod.CodigoRespuesta = "-1"
                objBEResponseWebMethod.MensajeRespuesta = "Ocurrio un error al realizar el pago de la Protección Movil"

            End If

        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} => {2}", IdentificadorLog, "Error al realizar pago de PM", Funciones.CheckStr(ex.Message)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} => {2}", IdentificadorLog, "Error al realizar pago de PM", Funciones.CheckStr(ex.StackTrace)))

            objBEResponseWebMethod.CodigoRespuesta = "-1"
            objBEResponseWebMethod.MensajeRespuesta = "Ocurrio un error al realizar el pago de la Protección Movil"
        End Try

        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} => {2}", IdentificadorLog, "Pagar Proteccion Movil - Respuesta", rpta))
        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1}", IdentificadorLog, "Fin Pagar Proteccion Movil"))

        Return rpta
    End Function
    'PROY-140582 - FIN

'JRM - PROY 140589 INI 
#Region "PagoDlv"
    Public Function RegistrarPagoDLV(ByVal strDocumentoSap As String, _
                                ByVal strDocumentoSapBoleta As String, _
                                ByVal strNumeroDocumento As String, _
                                ByVal strMontoRecarga As String, _
                                ByVal strCodMedioPago As String, _
                                ByVal oEmpleados As BEDatosEmpleado, _
                                ByVal strIpLocal As String, _
                                ByVal TipoDocCliente As String, _
                                ByVal NroDocCliente As String, _
                                ByVal strTipoDocVendedor As String, _
                                ByVal strNumDocVendedor As String, _
                                ByVal strNumReferencia As String, _
                                ByVal strTipoOperacionServ As String, _
                                ByVal strMontoTotal As String, _
                                ByVal strFlagTiendaVirtual As String, _
                                ByVal strFlagBiometria As String, _
                                ByVal UUID As String, _
                                ByVal FechaPedido As String, _
                                ByVal strTipoVentaPago As String, _
                                ByVal strTipoOperacionPago As String, _
                                ByVal blFlagPortabilidad As Boolean, _
                                ByRef objBEResponseWebMethod As BEResponseWebMethod) As Boolean

        Dim rpta As Boolean = False
        Dim estado_pago As String = String.Empty
        objBEResponseWebMethod = New BEResponseWebMethod
        Dim sbTrazabilidad As StringBuilder = New StringBuilder
        Dim strTrazabilidad As String = String.Empty

        Try
            If LoadSesiones(strDocumentoSap, _
                                 strNumeroDocumento, _
                                 FechaPedido, _
                                 strCodMedioPago, _
                                 TipoDocCliente, _
                                 NroDocCliente, _
                                 strTipoDocVendedor, _
                                 strNumDocVendedor, _
                                 strNumReferencia, _
                                 strTipoOperacionServ, _
                                 strMontoTotal, _
                                 strCodMedioPago, _
                                 strFlagTiendaVirtual, _
                                 strFlagBiometria, _
                                 UUID, _
                                 strTipoVentaPago, _
                                 strTipoOperacionPago, _
                                 blFlagPortabilidad, _
                                 oEmpleados) Then
                guardarConectadoDlv()

                Dim dsPedido As DataSet
                objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Consulta los datos del pedido=> " & Funciones.CheckStr(strDocumentoSap))
                dsPedido = objConsultaMsSap.ConsultaPedido(strDocumentoSap, "", "")
                objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Fin consulta pedido.")

                If Not dsPedido Is Nothing AndAlso dsPedido.Tables.Count > 0 AndAlso dsPedido.Tables(0).Rows.Count > 0 Then

                    objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Consulta los datos del pedido=> true")

                    estado_pago = dsPedido.Tables(0).Rows(0).Item("PEDIC_ESTADO")

                    If estado_pago = ConfigurationSettings.AppSettings("ESTADO_PAG") Then

                        objFileLog.Log_WriteLog(pathFile, strArchivo, IdentificadorLog & "- " & "Pedido en estado pagado correcto")

                        rpta = True
                        objBEResponseWebMethod.CodigoRespuesta = "0"
                        objBEResponseWebMethod.MensajeRespuesta = "Pago Realizado con éxito."

                        Try

                            Dim fechaRegistro As DateTime = DateTime.Now
                            Dim strCodRpta As String = String.Empty
                            Dim strMsjRpta As String = String.Empty

                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "objBEResponseWebMethod.CodigoRespuesta", Funciones.CheckStr(objBEResponseWebMethod.CodigoRespuesta)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "objBEResponseWebMethod.MensajeRespuesta", Funciones.CheckStr(objBEResponseWebMethod.MensajeRespuesta)))

                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Numero Pedido", Funciones.CheckStr(AppQpDocSap)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Punto de Venta", Funciones.CheckStr(AppAlmacen)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Identificador", Funciones.CheckStr(AppUUID)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Fecha Registro", Funciones.CheckStr(fechaRegistro)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Es Renta", "N"))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Pedido Alta", Funciones.CheckStr(AppPedidoAlta)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Monto Calculado", Funciones.CheckStr(AppMontoPagar)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Monto Pagado", Funciones.CheckStr(ApptxtMonto1)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "TipoDoc Vendedor", Funciones.CheckStr(AppTipoDocVendedor)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "NumDoc Vendedor", Funciones.CheckStr(AppNumDocVendedor)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Numero Referencia", Funciones.CheckStr(AppNumeroReferencia)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Cod Medio Pago", Funciones.CheckStr(AppCodMedioPago)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Tipo Operacion", Funciones.CheckStr(AppTipoOperacion)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Flag Biometria", Funciones.CheckStr(AppFlagBiometria)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Flag Actualizar MSSAP", Funciones.CheckStr(AppActualizarMSSAP)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Flag ActivosPostpagoConvergente", Funciones.CheckStr(AppActivosPostpagoConvergente)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Flag Actualizar Contrato", Funciones.CheckStr(AppActualizarContrato)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Flag Envio a SAP", Funciones.CheckStr(AppEnvioSAP)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Flag Envio a Paperless", Funciones.CheckStr(AppPaperless)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Flag Tienda Virtual", Funciones.CheckStr(AppFlagTiendaVirtual)))


                            Dim idNumeroPedido As Int64 = Funciones.CheckInt64(AppQpDocSap)
                            Dim dblMontoCalculado As Double = Funciones.CheckDbl(AppMontoPagar)
                            Dim dblMontoPagado As Double = Funciones.CheckDbl(ApptxtMonto1)
                            'JRM
                            Dim PedidoAltaDlv As Int64 = Funciones.CheckInt64(strDocumentoSapBoleta)
                            'JRM


                            objTrsMsSap.RegistrarPagoSrvSicar(idNumeroPedido, _
                                                              AppAlmacen, _
                                                              AppUUID, _
                                                              AppstrUsuario, _
                                                              fechaRegistro, _
                                                              "N", _
                                                              PedidoAltaDlv, _
                                                              dblMontoCalculado, _
                                                              dblMontoPagado, _
                                                              AppTipoDocVendedor, _
                                                              AppNumDocVendedor, _
                                                              AppNumeroReferencia, _
                                                              AppFlagBiometria, _
                                                              AppActualizarMSSAP, _
                                                              AppActivosPostpagoConvergente, _
                                                              AppActualizarContrato, _
                                                              AppEnvioSAP, _
                                                              AppPaperless, _
                                                              AppCodMedioPago, _
                                                              AppFlagTiendaVirtual, _
                                                              AppTipoOperacion, _
                                                              strCodRpta, _
                                                              strMsjRpta)


                            rpta = True
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Codigo Respuesta", Funciones.CheckStr(strCodRpta)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Mensaje Respuesta", Funciones.CheckStr(strMsjRpta)))

                            objBEResponseWebMethod.CodigoRespuesta = "0"
                            objBEResponseWebMethod.MensajeRespuesta = "Pago Realizado con éxito."

                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "objBEResponseWebMethod.CodigoRespuesta", Funciones.CheckStr(objBEResponseWebMethod.CodigoRespuesta)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "objBEResponseWebMethod.MensajeRespuesta", Funciones.CheckStr(objBEResponseWebMethod.MensajeRespuesta)))
                        Catch ex As Exception

                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "ERROR AL GRABAR EN SSAPT_PAGO_SRVSICAR", Funciones.CheckStr(ex.Message)))
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "ERROR AL GRABAR EN SSAPT_PAGO_SRVSICAR", Funciones.CheckStr(ex.StackTrace)))

                            sbTrazabilidad.AppendFormat("{0} || ", "Ocurrio un error al registrar en MSSAP(SSAPT_PAGO_SRVSICAR)")

                        End Try


                        'If (AppMensajeErrorGeneral.Length > 0) Then

                        '    sbTrazabilidad.AppendFormat("{0} || ", AppMensajeErrorGeneral)
                        '    AppMensajeErrorGeneral = String.Empty

                        'ElseIf (AppSPError.Length > 0) Then

                        '    sbTrazabilidad.Append(AppSPError)
                        '    AppSPError = String.Empty

                        'ElseIf Not AppErrorPedido Is Nothing And AppErrorPedido <> "" Then

                        '    sbTrazabilidad.AppendFormat("{0} || ", AppErrorPedido)
                        '    AppErrorPedido = String.Empty

                        'ElseIf Not hidMensajeNC Is Nothing And hidMensajeNC <> "" Then
                        '    sbTrazabilidad.AppendFormat("{0} || ", hidMensajeNC)
                        '    hidMensajeNC = String.Empty

                        'ElseIf Not AppErrorCaja Is Nothing And AppErrorCaja <> "" Then
                        '    sbTrazabilidad.AppendFormat("{0} || ", AppErrorCaja)
                        '    AppErrorCaja = String.Empty

                        'ElseIf Not AppErrorPagoParcial Is Nothing And AppErrorPagoParcial <> "" Then
                        '    sbTrazabilidad.AppendFormat("{0} || ", AppErrorPagoParcial)
                        '    AppErrorPagoParcial = String.Empty

                        'ElseIf Not AppErrorRenovacionRPM6 Is Nothing And AppErrorRenovacionRPM6 <> "" Then
                        '    sbTrazabilidad.AppendFormat("{0} || ", AppErrorRenovacionRPM6)
                        '    AppErrorRenovacionRPM6 = String.Empty

                        'ElseIf Not AppmsgActivacionCAC Is Nothing And AppmsgActivacionCAC <> "" Then
                        '    sbTrazabilidad.AppendFormat("{0} || ", AppmsgActivacionCAC)
                        '    AppmsgActivacionCAC = String.Empty

                        'ElseIf Not AppmensajeErrorBonoPrepago Is Nothing And AppmensajeErrorBonoPrepago <> "" Then
                        '    sbTrazabilidad.AppendFormat("{0} || ", AppmensajeErrorBonoPrepago)
                        '    AppmensajeErrorBonoPrepago = String.Empty

                        'ElseIf Not AppPagoBSCSRenovacionCorporativa Is Nothing And AppPagoBSCSRenovacionCorporativa <> "" Then
                        '    sbTrazabilidad.AppendFormat("{0} || ", AppPagoBSCSRenovacionCorporativa)
                        '    AppPagoBSCSRenovacionCorporativa = String.Empty

                        'ElseIf Not AppmensajeErrorLineas Is Nothing And AppmensajeErrorLineas <> "" Then
                        '    sbTrazabilidad.AppendFormat("{0} || ", AppmensajeErrorLineas)
                        '    AppmensajeErrorLineas = String.Empty

                        'ElseIf Not AppstrMensajeWSCABB Is Nothing And AppstrMensajeWSCABB <> "" Then
                        '    sbTrazabilidad.AppendFormat("{0} || ", AppstrMensajeWSCABB)
                        '    AppstrMensajeWSCABB = String.Empty

                        'ElseIf Not AppmsgErrorGenerarSot Is Nothing And AppmsgErrorGenerarSot <> "" And (AppmsgErrorDevolverRV Is Nothing Or AppmsgErrorDevolverRV = "") Then
                        '    sbTrazabilidad.AppendFormat("{0} || ", AppmsgErrorGenerarSot)
                        '    AppmsgErrorGenerarSot = String.Empty


                        'ElseIf Not AppmsgErrorDevolverRV Is Nothing And AppmsgErrorDevolverRV <> "" Then
                        '    sbTrazabilidad.AppendFormat("{0} || ", AppmsgErrorDevolverRV)
                        '    AppmsgErrorDevolverRV = String.Empty

                        'ElseIf Not AppmsgDevolucion Is Nothing And AppmsgDevolucion <> "" Then
                        '    sbTrazabilidad.AppendFormat("{0} || ", AppmsgDevolucion)
                        '    AppmsgDevolucion = String.Empty

                        'ElseIf Not AppmensajeErrorDOL Is Nothing And AppmensajeErrorDOL <> "" Then
                        '    sbTrazabilidad.AppendFormat("{0} || ", AppmensajeErrorDOL)
                        '    AppmensajeErrorDOL = String.Empty

                        'ElseIf Len(Trim(AppmensajeCHIPRepuesto)) > 0 Then
                        '    sbTrazabilidad.AppendFormat("{0} || ", AppmensajeCHIPRepuesto)
                        '    AppmensajeCHIPRepuesto = String.Empty

                        'ElseIf Len(Trim(AppstrMensajeCaja)) > 0 Then
                        '    sbTrazabilidad.AppendFormat("{0} || ", AppstrMensajeCaja)
                        '    AppstrMensajeCaja = String.Empty

                        'ElseIf Len(Trim(AppstrMensajeCajaRec)) > 0 Then
                        '    sbTrazabilidad.AppendFormat("{0} || ", AppstrMensajeCajaRec)
                        '    AppstrMensajeCajaRec = String.Empty

                        'ElseIf Len(Trim(AppP_MSJ_RESULTADO)) > 0 Then
                        '    sbTrazabilidad.AppendFormat("{0} || ", AppP_MSJ_RESULTADO)
                        '    AppP_MSJ_RESULTADO = String.Empty

                        'ElseIf Not AppmsgErrorInsertaMail Is Nothing And AppmsgErrorInsertaMail <> "" Then
                        '    sbTrazabilidad.AppendFormat("{0} || ", AppmsgErrorInsertaMail)
                        '    AppmsgErrorInsertaMail = String.Empty

                        'ElseIf Not AppmensajeErrorLineas Is Nothing And AppmensajeErrorLineas <> "" Then
                        '    sbTrazabilidad.AppendFormat("{0} || ", AppmensajeErrorLineas)
                        '    AppmensajeErrorLineas = String.Empty

                        'ElseIf Not AppMensajeErrorPagoCanjeAW Is Nothing And AppMensajeErrorPagoCanjeAW <> "" Then
                        '    sbTrazabilidad.Append(AppMensajeErrorPagoCanjeAW)
                        '    AppMensajeErrorPagoCanjeAW = String.Empty
                        'End If

                        'strTrazabilidad = Funciones.CheckStr(sbTrazabilidad)

                        'objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "strTrazabilidad", Funciones.CheckStr(strTrazabilidad)))

                        'objBEResponseWebMethod.MensajeErrror = strTrazabilidad

                    Else
                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Pedid no se encuentra pagado"))

                        If AppCodigoExitFunction = "-2" Then

                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Hay error que truncaron el pago"))
                            objBEResponseWebMethod.CodigoRespuesta = "-1"
                            objBEResponseWebMethod.MensajeRespuesta = "Ocurrio un error al realizar el pago de la Boleta/Factura"

                            AppCodigoExitFunction = String.Empty
                            AppMensajeExitFunction = String.Empty

                        Else
                            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "No hay errores que truncaron el pago, ocurrio un error parcial"))
                            objBEResponseWebMethod.CodigoRespuesta = "-1"
                            objBEResponseWebMethod.MensajeRespuesta = "Ocurrio un error al realizar el pago de la Boleta/Factura"
                        End If
                    End If

                Else
                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Consultar los datos del pedido despues del proceso de pago, no retorno datos"))

                    objBEResponseWebMethod.CodigoRespuesta = "-1"
                    objBEResponseWebMethod.MensajeRespuesta = "Ocurrio un error al realizar el pago de la Boleta/Factura"
                End If
            Else
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "Ocurrio un error en el metodo LOAD SESSIONES"))
                objBEResponseWebMethod.CodigoRespuesta = "-1"
                objBEResponseWebMethod.MensajeRespuesta = "Ocurrio un error en el Load del metodo pagar"
            End If
        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "ERROR AL REALIZAR PAGO", Funciones.CheckStr(ex.Message)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0}- {1} : {2}", IdentificadorLog, "ERROR AL REALIZAR PAGO", Funciones.CheckStr(ex.StackTrace)))

            objBEResponseWebMethod.CodigoRespuesta = "-1"
            objBEResponseWebMethod.MensajeRespuesta = "Ocurrio un error al realizar el pago de la Boleta/Factura"
        End Try

        Return rpta
    End Function

'==================================================================='
    'JRM - PROY 140589 - INI
    'FUNCION PARA PAGAR EL COSTO DELIVERY
    '==================================================================='
    Private Function guardarConectadoDlv() As BEResponseWebMethod

        Try

            Dim ResponseWebMethod As BEResponseWebMethod = New BEResponseWebMethod

            Dim blnPagoRealizado As Boolean = False
            'Dim strTelefonoNumero = String.Empty
            'Dim strRegistroDOLRespuesta = String.Empty
            Dim int64IdVenta As Int64 = 0
            Dim strDocumentoIdentidadNumero As String = String.Empty

            Dim objClsConsultaPvu As New COM_SIC_Activaciones.clsConsultaPvu
            '==================================================================='
            ' PARAMETROS DE RETORNO DE GUARDAR PAGO
            Dim K_PAGOV_CORRELATIVO As String = ""
            Dim K_PAGOC_CORRELATIVO As String = ""

            Dim consultaDato As DataSet

            Dim K_NROLOG As String = ""
            Dim K_DESLOG As String = ""
            Dim K_NROLOG_DET As String = ""
            Dim K_DESLOG_DET As String = ""
            Dim K_PAGON_IDPAGO As Int64 = 0
            Dim K_CU_CORRELATIVOFE As String = ""

            Dim objContrato As DataSet          '*** guardar la informaciòn recuperada del contrato - dg ***'
            Dim P_COD_RESP As String = ""       '*** variables del contrato -dg ***'
            Dim P_MSG_RESP As String = ""       '*** variables del contrato -dg ***'

            'FIN DE PARAMETROS DE RETORNO DE GUARDAR PAGO 
            '==================================================================='


            ' PARAMETROS DE RETORNO DE CONSULTA PEDIDO PVU
            Dim P_CODIGO_RESPUESTA As String = ""
            Dim P_MENSAJE_RESPUESTA As String = ""
            Dim C_VENTA As DataTable
            Dim C_VENTA_DET As DataTable
            'FIN PARAMETROS DE RETORNO DE CONSULTA PEDIDO PVU

            Dim C_VENTA_Prepago As DataSet

            Dim Campania As String = ""
            Dim campania_Pre As String = ""
            Dim campania_Post As String = ""

            Dim Plan_final As String = ""
            Dim plan_pre As String = ""
            Dim plan_post As String = ""

            Dim tipo_venta_pvu As String = "NTRR"
            Dim cod_Prod_TFI As String = ""

            Dim flag_ped_repo As String = ""

            'Parametros cuando se graban los pagos prepagos
            Dim objPvu As New COM_SIC_Activaciones.clsTrsPvu
            Dim RptaPrepago As Integer


            Dim strNumAsignado As String
            Dim strNumSunat As String
            Dim i As Integer
            Dim j As Integer
            Dim strDetallePago As String
            Dim dsResult As DataSet
            Dim strNumAsignaSUNAT As String
            Dim strErrorMsg As String
            Dim blnSunat As Boolean
            Dim strNroDoc As String
            Dim strPrepago As String
            Dim strPostPago As String
            Dim intCeros As Integer
            Dim blnFlagPago As Boolean
            Dim strMensaje As String
            Dim strEstado As String
            Dim strCadenaCam As String
            Dim strContrato As String           '*** en el conectado ****'

            Dim PorMigracion As String
            Dim PorRenovacion As String
            Dim PorReposicion As String
            Dim PorAprobador As String
            Dim EstadoActualAcuerdo As String
            Dim strObsEstado As String

            'CARIAS
            'Conectado
            Dim strNroSEC, strNroDocSEC, strTipDocSEC, strNroAprobacion, strMotivoMig, strConSinEq As String
            'FIN CARIAS

            Dim strIND_ACTIV_BSCS As String
            Dim dsAcuerdo As DataSet
            Dim dsEstado As DataSet
            Dim dsDatGenerales As DataSet
            Dim conEquipo As Boolean

            Dim strValSAP As String
            Dim blnDebeSerRevisado As Boolean
            Dim strRespuesta As String

            Dim dblEfectivo As Double
            Dim dblEfecCaja As Double
            Dim dblTolerancia As Double
            Dim dsEfectivo As DataSet
            Dim dblMontoTarjeta As Double
            Dim dblTotalTarjeta As Double

            '140245 Inicio
            Dim strNro_cont_Det As Integer '140245
            Dim strNro_cont As Integer '140245
            Dim strCo_Id As Integer 'nuevo
            '140245 Fin

            Dim objActivaciones As New COM_SIC_Activaciones.clsActivacion
            Dim objConfig As New COM_SIC_Configura.clsConfigura
            Dim objClsPagosWS As New COM_SIC_Activaciones.clsPagosWS

            Dim objActiv As New COM_SIC_Activaciones.clsBDSiscajas
            Dim msgj As String = ""

            '****************************** Para Impresion
            'Dim strDocSap As String = "" 'drPagos.Item("VBELN")TODOEB
            Dim strDocSap As String = drPagos.Item("PEDIN_NROPEDIDO")


            Dim strDocSunat As String = ""
            Dim sTipoVenta, sTipoOperacion As String
            '<33062>
            Dim sDescripcionOperacion As String
            '</33062>

            'JLOPETAS - PROY 140589 - INI 
            '-- DECLARACION DE VARIABLES PARA SAP - INI
            Dim K_COD_RESPUESTA As String
            Dim K_MSJ_RESPUESTA As String
            Dim K_ID_TRANSACCION As String
            Dim strTipoOperacion As String
            '-- DECLARACION DE VARIABLES PARA SAP - FIN
            'JLOPETAS - PROY 140589 - FIN

            'Dim strDocSunat As String = drPagos.Item("XBLNR")TODOEB
            ' Dim strDocSunat As String = drPagos.Item("PAGOC_CODSUNAT") '"AC111"

            Dim strNroDG As String = "" 'drPagos.Item("NRO_DEP_GARANTIA")TODOEB
            'Dim strTipDoc As String = drPagos.Item("FKART")TODOEB

            '****************************************************************************
            'VARIABLES: INFORMACIÒN DEL PEDIDO
            '****************************************************************************
            Dim strTipDoc As String = drPagos.Item("PEDIC_CLASEFACTURA")
            'Dim strDescTipDoc As String = drPagos.Item("PEDIV_DESCCLASEFACTURA")
            'Dim strCodVendedor As String = drPagos.Item("VENDEDOR")
            'Dim totalDocumento As Double = drPagos.Item("INPAN_TOTALDOCUMENTO")
            '****************************************************************************


            '****************************************************************************
            'VARIABLES: Desglosamiento del correlativo para 
            '****************************************************************************
            Dim Var_Corr1 As String = ""
            Dim Var_Corr2 As String = ""
            Dim Var_Corr3 As String = ""
            Dim Var_Corr4 As String = ""
            Dim Var_Corr5 As String = ""
            Dim Var_Corr6 As String = ""
            '****************************************************************************

            Dim P_tipo_doc_pago As String = "" 'Variable para grabar la descripcion del tipo de comprobante (BOLETA O FACTURA)

            Dim sisact_Cod_Operacion As String = "" ' variable que se utiliza para obtener el codigo de operacion sisact.

            Dim intOper As Int32
            '*******************************

            ' FLAG PILOTO
            Dim booDol As Boolean = True

            'Variables de Auditoria
            Dim wParam1 As Long
            Dim wParam2 As String
            Dim wParam3 As String
            Dim wParam4 As Long
            Dim wParam5 As Integer
            Dim wParam6 As String
            Dim wParam7 As Long
            Dim wParam8 As Long
            Dim wParam9 As Long
            Dim wParam10 As String
            Dim wParam11 As Integer
            Dim Detalle(,) As Object
            Dim objAudiBus As New COM_SIC_AudiBus.clsAuditoria
            Dim dtDatos As New DataTable
            Dim objBus As New COM_SIC_Cajas.clsCajas
            Dim isRecargaVirtual As Boolean = ApprecargaVirtual 'INC000001089654

            'NRO CONTRATO  TODOEB 

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Grabar pagos.")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")

            '************************************************************************************************************'
            'CONSULTA EL CONTRATO:
            Try
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Inicio Obtener contrato={1}]", strIdentifyLog, Not isRecargaVirtual)) 'INC000001089654  

                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - guardarConectado()", strIdentifyLog) & " - Session('recargaVirtual') : " & Funciones.CheckStr(ApprecargaVirtual))     'NUEVO  
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - guardarConectado()", strIdentifyLog) & " - PEDIN_NROPEDIDO : " & drPagos.Item("PEDIN_NROPEDIDO"))   'NUEVO  

                If Not ApprecargaVirtual Then
                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - SISACT_PKG_ACUERDO_6.SP_CON_ACUERDOS_X_DOCSAP", strIdentifyLog)) 'INC000001089654  
                    objContrato = objClsConsultaPvu.ObtenerDrsap(Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")), P_COD_RESP, P_MSG_RESP)   'EGSC001 ACA SE OBTIENE EL CONTRATO  NUEVO
                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} -  Contrato P_COD_RESP : {1}", strIdentifyLog, Funciones.CheckStr(P_COD_RESP))) 'INC000001089654  
                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} -  Contrato P_MSG_RESP : {1}", strIdentifyLog, Funciones.CheckStr(P_MSG_RESP))) 'INC000001089654  
                Else
                    objContrato = Nothing
                End If


                ' 'inicio nuevo
                ' If Not (objContrato Is Nothing) Then
                ' If (objContrato.Tables(0).Rows.Count > 0) Then
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} -  Contrato  : {1}", strIdentifyLog, Funciones.CheckStr(objContrato.Tables(0).Rows(0).Item("ID_CONTRATO"))))
                ' Else
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} -  Contrato  : {1}", strIdentifyLog, "El metodo ObtenerDrsap no retorno resultado"))
                ' End If
                ' Else
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - guardarConectado() ", strIdentifyLog, "El objContrato es Nothing"))
                ' End If
                ' 'fin nuevo


                ' '140245 Inicio
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Proy-140245 Capturar variables ")

                ' If objContrato.Tables(1).Rows.Count > 0 Then
                ' strNro_cont = objContrato.Tables(1).Rows(0).Item("ID_CONTRATO")
                ' 'Session("strNro_cont") = strNro_cont

                ' strNro_cont_Det = objContrato.Tables(1).Rows(0).Item("CORRELATIVO")
                ' 'Session("strNro_cont_Det") = strNro_cont_Det

                ' 'ASIGNACION DE LOG 
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Llenar a Nro_Contrato" & strNro_cont)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Llenar a  CO_ID" & strCo_Id)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Llenar a Nro_Contrato_Detalle" & strNro_cont_Det)
                ' End If
                ' '140245 Fin


                ' If Not (objContrato Is Nothing) Then
                ' If objContrato.Tables(0).Rows(0).Item("ID_CONTRATO") <> Nothing Then
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Contrato Obtenido: " & Funciones.CheckStr(objContrato.Tables(0).Rows(0).Item("ID_CONTRATO")))
                ' Else
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - Contrato Obtenido con ID_CONTRATO nulo", strIdentifyLog)) 'INC000001089654  
                ' End If
                ' Else
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - No se obtuvo datos de contrato", strIdentifyLog)) 'INC000001089654
                ' End If


                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Contrato Obtenido: " & Funciones.CheckStr(objContrato.Tables(0).Rows(0).Item("ID_CONTRATO")))
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Contrato P_COD_RESP : " & Funciones.CheckStr(P_COD_RESP))
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Contrato P_MSG_RESP : " & Funciones.CheckStr(P_MSG_RESP))
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Obtener contrato.")
            Catch ex As Exception
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Error en obtener contrato :" & drPagos.Item("PEDIN_NROPEDIDO"))
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Err." & ex.Message.ToString)
            End Try
            '************************************************************************************************************'

            Dim dsPedido As DataSet

            '****** CONSULTA PRINCIPAL PARA EL PREOCESO *****'
            '***************************************************************************************************'
            '***************************************************************************************************'
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Consulta los datos del pedido=> " & Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")))
            dsPedido = objConsultaMsSap.ConsultaPedido(drPagos.Item("PEDIN_NROPEDIDO"), "", "")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin consulta pedido.")
            '***************************************************************************************************'
            '***************************************************************************************************'
            '***************************************************************************************************'

            '****** VALIDANDO QUE LA CONSULTA PRINCIPAL TENGA DETALLE DE PEDIDO *****'
            '***************************************************************************************************'
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Validar si la consulta tiene detalle de pedido ")
            If Not dsPedido Is Nothing Then
                If dsPedido.Tables.Count > 1 Then
                    If dsPedido.Tables(1).Rows.Count = 0 Then
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " Pedido sin Detalle")
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " dsPedido.Tables(1).Rows.Count :" & dsPedido.Tables(1).Rows.Count)
                        'Response.Write("<script>alert('" & ConfigurationSettings.AppSettings("MSG_Pedido_Sin_Detalle") & "')</script>")
                        AppErrorPedido = ConfigurationSettings.AppSettings("MSG_Pedido_Sin_Detalle")
                        Exit Function
                    End If
                Else
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " Pedido sin Retorno de Tablas")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " dsPedido.Tables.Count :" & dsPedido.Tables.Count)
                    'Response.Write("<script>alert('" & ConfigurationSettings.AppSettings("MSG_Pedido_Sin_Retorno_Datos") & "')</script>")
                    AppErrorPedido = ConfigurationSettings.AppSettings("MSG_Pedido_Sin_Retorno_Datos")
                    Exit Function
                End If
            Else
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " Pedido sin Retorno de Cursores")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " dsPedido Is Nothing ")
                ' Response.Write("<script>alert('" & ConfigurationSettings.AppSettings("MSG_Pedido_Sin_Retorno_Datos") & "')</script>")
                AppErrorPedido = ConfigurationSettings.AppSettings("MSG_Pedido_Sin_Retorno_Datos")
                Exit Function
            End If

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Validar si la consulta tiene detalle de pedido ")

            '********************************************************************************************'
            '** Estas variables no estan siendo utilizadas, lo comentamos
            sTipoVenta = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA"))
            sTipoOperacion = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION"))

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Consulta los datos del pedido sTipoVenta=> " & Funciones.CheckStr(sTipoVenta))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Consulta los datos del pedido sTipoOperacion=> " & Funciones.CheckStr(sTipoOperacion))


            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Asignar valores")
            'Proy 140245 Ini
            Dim dsprueba As DataSet
            Dim strTipo_opera_Des As String = AppstrTipo_opera_Des
            Dim strNro_Sec As Integer = Funciones.CheckInt(AppstrNro_Sec)
            Dim strNro_Ped_Det As Integer = Funciones.CheckInt(AppstrNro_Ped_Det)
            Dim strTipo_Opera_Cod As String = AppstrTipo_Opera_Cod
            sDescripcionOperacion = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIV_DESCTIPOOPERACION"))

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Consulta los datos del pedido strTipo_opera_Des => " & Funciones.CheckStr(strTipo_opera_Des))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Consulta los datos del pedido strNro_Sec=> " & Funciones.CheckStr(strNro_Sec))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Consulta los datos del pedido strNro_Ped_Det=> " & Funciones.CheckStr(strNro_Ped_Det))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Consulta los datos del pedido strTipo_Opera_Cod=> " & Funciones.CheckStr(strTipo_Opera_Cod))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Consulta los datos del pedido sDescripcionOperacion=> " & Funciones.CheckStr(sDescripcionOperacion))

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Asignar valores")

            Dim strNumero_linea As String
            Dim strPlan_Codigo As String
            Dim strPlan_Desc As String
            Dim strTipo_Prod_Cod As String
            Dim strTipo_Prod_Des As String
            Dim strCampanaCod As String
            Dim strCampanaDesc As String
            Dim strCamp_Estado As String
            Dim strFecha_crea As String
            Dim strFecha_Act As String 'CAMBIO
            Dim strTipo_Doc As String
            Dim strNro_Doc As String
            Dim strNro_Ped As String
            Dim PO_COD_RPTA As String = ""
            Dim PO_MSG_RPTA As String = ""
            'Proy 140245 Fin
            '<33062>

            '</33062>

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " Consulta el efectivo para la caja")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " Parametro de consulta :" & AppAlmacen)
            '** CONSULTA EFECTIVO:
            Dim Codaplic As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("CodAplicacion"))
            objCajas = New COM_SIC_Cajas.clsCajas
            Try
                dsEfectivo = objCajas.FP_Get_ListaParamOficina(AppCanal, Codaplic, AppAlmacen)
            Catch ex As Exception

            End Try

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " Fin consulta paràmetros oficina")

            'dblEfecCaja = objCajas.FP_CalculaEfectivo(Session("ALMACEN"), Session("USUARIO"), drPagos.Item("FKDAT")) TODOEB
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " Inicia Consulta Càlculo Efectivo")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " Paràmetros: Punto Venta: " & AppAlmacen & "  Fecha: " & DateTime.Now)
            'dblEfecCaja = objCajas.FP_CalculaEfectivo(Session("ALMACEN"), Session("USUARIO"), DateTime.Now)
            '** CONSULTA EFECTIVO CAJA:
            Dim cultureNameCaja As String = "es-PE"
            Dim cultureCaja As CultureInfo = New CultureInfo(cultureNameCaja)
            Dim dateTimeValueCajaEfe As DateTime
            dateTimeValueCajaEfe = Convert.ToDateTime(DateTime.Now, cultureCaja)
            Dim dFechaCaj0 As Date
            Dim sFechaCaj0 As String = dateTimeValueCajaEfe.ToLocalTime.ToShortDateString
            'PROY-140397-MCKINSEY -> JSQ INICIO
            sFechaCaj0 = DateTime.Now().ToString("dd/MM/yyyy")
            'PROY-140397-MCKINSEY -> JSQ FIN
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - Fecha Pedido : " & sFechaCaj0)

            dblEfecCaja = objCajas.FP_CalculaEfectivo(AppAlmacen, AppUsuario, sFechaCaj0)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " Paràmetros: Punto Venta: " & AppAlmacen & "  Fecha: " & Funciones.CheckStr(sFechaCaj0))

            '*** AVILLAR  ****'
            Try
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " -Consulta el monto configurado de tarjeta.")
                dsDatGenerales = objConfig.FP_Lista_Param_Tarjeta(1)
                'Valor de monto de tarjeta configurado.
                If Not dsDatGenerales Is Nothing Then
                    dblMontoTarjeta = dsDatGenerales.Tables(0).Rows(0).Item("PARTN_MONTO")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " -dblMontoTarjeta: " & Funciones.CheckStr(dsDatGenerales.Tables(0).Rows(0).Item("PARTN_MONTO")))
                End If
            Catch ex As Exception
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - Error al consultar el monto configurado para la tarjeta.")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - Err." & ex.Message.ToString)
            End Try
            ' *** AVILLAR  ****'


            If dsEfectivo.Tables(0).Rows.Count = 0 Then
                'Response.Write("<script>alert('No existe configuracion de caja para este punto de venta.')</script>")
                AppErrorCaja = "No existe configuracion de caja para este punto de venta."
                Exit Function
            End If

            dblTolerancia = dsEfectivo.Tables(0).Rows(0).Item("CAJA_TOLERANCIA_SOL")

            If dblEfecCaja >= dsEfectivo.Tables(0).Rows(0).Item("CAJA_MAX_DISP_SOL") + dblTolerancia Then
                'Response.Write("<script>alert('Ha alcanzado su maximo disponible de efectivo en caja. Debe depositar en caja buzón')</script>")
            Else

                'blnSunat = (drPagos.Item("XBLNR") = "" Or drPagos.Item("XBLNR") = "0000000000000000") TODOEB
                If Not Convert.IsDBNull(drPagos.Item("PAGOC_CODSUNAT")) Then
                    blnSunat = (drPagos.Item("PAGOC_CODSUNAT") = "" Or drPagos.Item("PAGOC_CODSUNAT") = "0000000000000000")
                Else
                    blnSunat = False
                End If

                If Trim(txtNumSunat) = "" Then
                    strNumSunat = txtCorrelativo
                Else
                    strNumSunat = txtNumSunat
                End If
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "NumSunat : " & strNumSunat.ToString())

                If blnSunat Then
                    strNumAsignaSUNAT = txtCompleto
                Else
                    strNumAsignaSUNAT = strNumSunat
                End If

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "strNumAsignaSUNAT : " & strNumAsignaSUNAT.ToString())



                ' Dim K_COD_RESPUESTA As String
                ' Dim K_MSJ_RESPUESTA As String
                ' Dim K_ID_TRANSACCION As String

                ' Dim p_limpiador As Integer = 0


                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Validar detalle del pedido")

                ' If sTipoVenta = ConfigurationSettings.AppSettings("strTVPrepago") Then
                ' If sTipoOperacion = ConfigurationSettings.AppSettings("COD_OPERACION_ALTAyPORTABILIDAD") Then
                ' '*******************************************************************************************************
                ' 'Consulta las siguientes Tablas.
                ' '**1. sisact_venta_prepago. 
                ' '**2. sisact_detalle_venta_prepago. 
                ' Try
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicia consulta datos Pedido Prepagos Alta y Portabilidad en PVU ")
                ' objClsConsultaPvu.ConsultarPedidosPrepago(drPagos.Item("PEDIN_NROPEDIDO"), P_CODIGO_RESPUESTA, P_MENSAJE_RESPUESTA, C_VENTA, C_VENTA_DET)

                ' int64IdVenta = Funciones.CheckInt64(C_VENTA.Rows(0).Item("VEPR_ID"))
                ' strDocumentoIdentidadNumero = Funciones.CheckStr(C_VENTA.Rows(0).Item("VEPR_NUM_DOC"))

                ' If P_MENSAJE_RESPUESTA <> "OK" Then
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  No se encontro el pedido en la tabla : sisact_info_venta_sap. pkg:sisact_pkg_venta sp:sp_con_venta_x_docsap => " & drPagos.Item("PEDIN_NROPEDIDO"))
                ' End If
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin consulta datos Pedido Prepagos Alta y Porta en PVU ")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "P_MENSAJE_RESPUESTA: " & P_MENSAJE_RESPUESTA)
                ' Catch ex As Exception
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Error al ejecutar el sp: SP_CON_VENTA_PREPAGO , para el pedido => " & drPagos.Item("PEDIN_NROPEDIDO"))
                ' 'INI PROY-140126
                ' Dim MaptPath As String
                ' MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                ' MaptPath = "( Class : " & MaptPath & "; Function: guardarConectado)"
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     Exception: " & ex.ToString() & MaptPath)
                ' 'FIN PROY-140126

                ' End Try
                ' Else
                ' 'Consulta las siguientes Tablas.
                ' '**1. SISACT_VENTA_REPO_PRE.
                ' p_limpiador = 1
                ' Try
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicia consulta datos pedido Prepago diferentes a las Altas y Portabilidad en PVU")
                ' C_VENTA_Prepago = objClsConsultaPvu.ObtenerDatosVentaPrepago(drPagos.Item("PEDIN_NROPEDIDO"), P_MENSAJE_RESPUESTA)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin consulta datos pedido Prepago diferentes a las Altas y Portabilidad en PVU, P_MENSAJE_RESPUESTA :  " & P_MENSAJE_RESPUESTA)
                ' Catch ex As Exception
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Ingreso a EX : " & ex.Message.ToString())
                ' End Try
                ' End If

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "p_limpiador :  " & p_limpiador)

                ' If p_limpiador = 1 Then
                ' If Not C_VENTA_Prepago Is Nothing Then
                ' If C_VENTA_Prepago.Tables.Count > 0 Then
                ' If C_VENTA_Prepago.Tables(0).Rows.Count > 0 Then
                ' campania_Pre = Funciones.CheckStr(C_VENTA_Prepago.Tables(0).Rows(0).Item("CAMPANIA_COD"))
                ' plan_pre = Funciones.CheckStr(C_VENTA_Prepago.Tables(0).Rows(0).Item("PLAN_TARIFARIO_COD"))
                ' tipo_venta_pvu = Funciones.CheckStr(C_VENTA_Prepago.Tables(0).Rows(0).Item("Tipo_Operacion"))
                ' flag_ped_repo = Funciones.CheckStr(C_VENTA_Prepago.Tables(0).Rows(0).Item("flag_tipo_venta_repo"))
                ' End If
                ' End If
                ' End If
                ' Else
                ' If Not C_VENTA_DET Is Nothing Then
                ' If C_VENTA_DET.Rows.Count > 0 Then
                ' campania_Pre = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("DVPR_COD_CAMPANA"))
                ' plan_pre = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("DVPR_COD_PLAN"))
                ' cod_Prod_TFI = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("DVPR_COD_PROD_PREP"))
                ' tipo_venta_pvu = "NTRR"
                ' End If
                ' End If
                ' End If

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "campania_Pre :  " & campania_Pre)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "plan_pre :  " & plan_pre)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "tipo_venta_pvu : " & tipo_venta_pvu)
                ' Else
                '*******************************************************************************************************
                '**1. sisact_info_venta_sap => consulta con el numero de pedido(nro_documento), retorna el n_id_venta.
                '**2. sisact_ap_venta v / sisact_ap_contrato, donde  v.id_documento=n_id_venta => c_venta
                '**3. sisact_ap_venta_detalle vd => vd.id_documento = n_id_venta => c_venta_det  
                Try
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicia consulta datos Pedido PostPsgo en PVU ")
                    objClsConsultaPvu.ConsultarPedidosPVU(drPagos.Item("PEDIN_NROPEDIDO"), _
                                                                  P_CODIGO_RESPUESTA, _
                                                                  P_MENSAJE_RESPUESTA, _
                                                                  C_VENTA, _
                                                                  C_VENTA_DET)

                    If P_MENSAJE_RESPUESTA <> "OK" Then
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  No se encontro el pedido en la tabla : sisact_info_venta_sap. pkg:sisact_pkg_venta sp:sp_con_venta_x_docsap => " & drPagos.Item("PEDIN_NROPEDIDO"))
                    End If

                    If Not C_VENTA_DET Is Nothing Then
                        If C_VENTA_DET.Rows.Count > 0 Then
                            campania_Post = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("campana"))
                            plan_post = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("plan"))
                            tipo_venta_pvu = Funciones.CheckStr(C_VENTA.Rows(0).Item("TVENC_CODIGO"))
                        End If
                    End If

                    '140245 Inicio

                    Dim strPedi_NroPed As String = String.Empty 'Session("strPedi_NroPed")
                    strNumero_linea = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("TELEFONO"))
                    strPlan_Codigo = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("PLAN"))
                    strPlan_Desc = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("PLAN_DESC"))
                    strTipo_Prod_Cod = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("PRDC_CODIGO"))
                    strFecha_crea = ""

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Fecha de Creacion" & strFecha_crea)

                    Select Case (strTipo_Prod_Cod)
                        Case "01"
                            strTipo_Prod_Des = "MOVIL"
                            AppstrTipo_Prod_Des = strTipo_Prod_Des
                        Case "02"
                            strTipo_Prod_Des = "TFI"
                            AppstrTipo_Prod_Des = strTipo_Prod_Des
                        Case "03"
                            strTipo_Prod_Des = "TVSAT"
                            AppstrTipo_Prod_Des = strTipo_Prod_Des
                        Case "04"
                            strTipo_Prod_Des = "BAM"
                            AppstrTipo_Prod_Des = strTipo_Prod_Des
                        Case "05"
                            strTipo_Prod_Des = "3PLAY"
                            AppstrTipo_Prod_Des = strTipo_Prod_Des
                        Case "06"
                            strTipo_Prod_Des = "IFI"
                            AppstrTipo_Prod_Des = strTipo_Prod_Des
                        Case "08"
                            strTipo_Prod_Des = "LTE"
                            AppstrTipo_Prod_Des = strTipo_Prod_Des
                    End Select

                    strCampanaCod = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("CAMPANA"))
                    strCampanaDesc = Funciones.CheckStr(C_VENTA_DET.Rows(0).Item("CAMPANA_DESC"))
                    strTipo_Doc = Funciones.CheckStr(C_VENTA.Rows(0).Item("TIPO_DOC_CLIENTE"))
                    strNro_Doc = Funciones.CheckStr(C_VENTA.Rows(0).Item("NRO_DOC_CLIENTE"))
                    strNro_Ped = Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO"))

                    ' INC000002161718 INI
                    Dim strExiste As String = String.Empty
                    Dim strCfMax As Double = 0
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Ini INC000002161718 ValidarWhitelist")
                    Dim isWhitelist As Boolean = objClsConsultaPvu.ValidarWhitelist(strExiste, _
                                                        strCfMax, _
                                                        strTipo_Doc, _
                                                        strNro_Doc, _
                                                        "E4")
                    If isWhitelist Then
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Respuesta ValidarWhitelist strExiste : " & "true")
                        If strExiste = "S" Then
                            strCamp_Estado = "P1"
                        Else
                            strCamp_Estado = "P2"
                        End If
                    Else
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Respuesta ValidarWhitelist strExiste : " & "false")
                        strCamp_Estado = "P1"
                    End If
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin INC000002161718 ValidarWhitelist")
                    ' INC000002161718 FIN

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Proy-140245 CO-ID:" & strCo_Id)

                    'LOG
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Llenar numero Pedido" & strPedi_NroPed)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Llenar numero de Linea" & strNumero_linea)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Llenar numero de Documento" & strNro_Doc)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Llenar estado" & strCamp_Estado)

                    '140245 Fin

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "campania_Post :  " & campania_Post)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "plan_post :  " & plan_post)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "tipo_venta_pvu :  " & tipo_venta_pvu)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin consulta datos Pedido PostPsgo en PVU")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "P_MENSAJE_RESPUESTA: " & P_MENSAJE_RESPUESTA)
                Catch ex As Exception
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Error al ejecutar el sp: SP_CON_VENTA_X_DOCSAP , para el pedido => " & drPagos.Item("PEDIN_NROPEDIDO"))
                    'INI PROY-140126
                    Dim MaptPath As String
                    MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                    MaptPath = "( Class : " & MaptPath & "; Function: guardarConectado)"
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     Exception: " & ex.ToString() & MaptPath)
                    'FIN PROY-140126

                End Try
                '*******************************************************************************************************
                ' End If

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Validar detalle del pedido")

                '140245 Validacion Inicio

                Dim strTVPost As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("strTVPostpago")) '220719
                Dim strReno As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("CONS_RENOVACION"))
                Dim strTipoVent As String
                Dim dsDatoPedido As DataSet
                dsDatoPedido = objConsultaMsSap.ConsultaPedido(strNro_Ped, "", "")

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio consultar datos del pedido")

                ' If dsDatoPedido.Tables(0).Rows.Count > 0 Then
                ' strTipoVent = Funciones.CheckStr(dsDatoPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA"))
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Proy-140245 strTipoVent : " & strTipoVent)
                ' If strTVPost = strTipoVent Then '220719 then 
                ' If strNro_cont > 0 And strNro_Ped <> "" And Not strNro_Ped Is Nothing Then
                ' If sDescripcionOperacion.IndexOf(strReno) > -1 Then
                ' ' INI INC000002259009
                ' Dim datosRenoPlan As String()
                ' ' FIN INC000002259009
                ' Dim strUsuario As String = AppstrUsuario
                ' 'INC000002161718 inicio
                ' Dim strCodRpt, strMsjRpt As String
                ' Dim objRegistrarCampaniasRequest As New COM_SIC_Activaciones.RegistrarCampaniasRequest
                ' Dim objRegistrarCampaniasResponse As New COM_SIC_Activaciones.RegistrarCampaniasResponse
                ' Dim objBEAuditoriaREST As New COM_SIC_Activaciones.AuditoriaEWS
                ' Dim objHeaderRequest As New COM_SIC_Activaciones.HeaderRequest
                ' Dim objauditRequest As New COM_SIC_Activaciones.BEAuditRequest
                ' Dim objRegistrarCampania As New COM_SIC_Activaciones.RegistrarCampania
                ' Dim objRegistrar As New COM_SIC_Activaciones.BWRegistrarCampania
                ' Dim fechaMigPlan As String

                ' ' INI INC000002259009
                ' Try
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INC000002259009 Antes de  ServicioSIACPostpagoConsultas")
                ' datosRenoPlan = ServicioSIACPostpagoConsultas("", strNumero_linea).Split("|")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INC000002259009 Despues de  ServicioSIACPostpagoConsultas")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Resultado CO_ID : " & datosRenoPlan(1))
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Resultado Ciclo Fact : " & datosRenoPlan(4))
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INI INC000002259009 INICIO CalcularFechaTopeProgramacion")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "IN - " & datosRenoPlan(4))
                ' fechaMigPlan = CalcularFechaTopeProgramacion(datosRenoPlan(4), strIdentifyLog)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "OUT - " & fechaMigPlan)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FIN INC000002259009 CalcularFechaTopeProgramacion")

                ' If datosRenoPlan(1) = 0 Then
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "INC000002259009 Error en la obtencion del CO_ID : " & datosRenoPlan(1))
                ' 'Session.Add("msgErrorGenerarSot", Funciones.CheckStr(ConfigurationSettings.AppSettings("MsjErrorServDatosCliente")))
                ' 'Response.Redirect("PoolPagos.aspx") ################ VALIDAR APP - SICAR ################
                ' AppmsgErrorGenerarSot = Funciones.CheckStr(ConfigurationSettings.AppSettings("MsjErrorServDatosCliente"))
                ' AppCodigoExitFunction = "-2"
                ' AppMensajeExitFunction = AppmsgErrorGenerarSot
                ' Exit Function
                ' End If
                ' Catch ex As Exception
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "INC000002259009 Error en la ejecucion del servicio ServicioSIACPostpagoConsultas")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "Detalle del error : " & ex.Message)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "Detalle del error : " & ex.StackTrace)
                ' 'Session.Add("msgErrorGenerarSot", Funciones.CheckStr(ConfigurationSettings.AppSettings("MsjErrorServDatosCliente")))
                ' 'Response.Redirect("PoolPagos.aspx") ################ VALIDAR APP - SICAR ################
                ' AppmsgErrorGenerarSot = Funciones.CheckStr(ConfigurationSettings.AppSettings("MsjErrorServDatosCliente"))
                ' AppCodigoExitFunction = "-2"
                ' AppMensajeExitFunction = AppmsgErrorGenerarSot
                ' Exit Function
                ' End Try

                ' ' FIN INC000002259009

                ' objHeaderRequest.consumer = ""
                ' objHeaderRequest.country = CheckStr(ConfigurationSettings.AppSettings("DAT_ConsultaNacionalidad_country"))
                ' objHeaderRequest.dispositivo = ""
                ' objHeaderRequest.language = CheckStr(ConfigurationSettings.AppSettings("DAT_ConsultaNacionalidad_language"))
                ' objHeaderRequest.modulo = ""
                ' objHeaderRequest.msgType = CheckStr(ConfigurationSettings.AppSettings("DAT_ConsultaNacionalidad_msgType"))
                ' objHeaderRequest.operation = ""
                ' objHeaderRequest.pid = ""
                ' objHeaderRequest.system = ""
                ' objHeaderRequest.timestamp = Convert.ToDateTime(String.Format("{0:u}", DateTime.UtcNow))
                ' objHeaderRequest.userId = ""
                ' objHeaderRequest.wsIp = Funciones.CheckStr(ConfigurationSettings.AppSettings("DAT_RegistrarCampana_wsIp"))

                ' objRegistrarCampaniasRequest.MessageRequest.Header.HeaderRequest = objHeaderRequest

                ' objauditRequest.idTransaccion = DateTime.Now.ToString("yyyyMMddHHmmssfff")
                ' objauditRequest.ipAplicacion = CurrentTerminal
                ' objauditRequest.nombreAplicacion = Funciones.CheckStr(ConfigurationSettings.AppSettings("constAplicacion"))
                ' objauditRequest.usuarioAplicacion = CurrentUser

                ' objRegistrarCampania.tipoDocumento = strTipo_Doc
                ' objRegistrarCampania.nroDocumento = strNro_Doc
                ' objRegistrarCampania.nroLinea = strNumero_linea
                ' objRegistrarCampania.nroSec = strNro_Sec
                ' objRegistrarCampania.nroPed = strNro_Ped
                ' objRegistrarCampania.nroPedDet = strNro_Ped_Det
                ' objRegistrarCampania.nroCont = strNro_cont
                ' objRegistrarCampania.nroContDet = strNro_cont_Det
                ' objRegistrarCampania.tmCode = "0"
                ' objRegistrarCampania.planCodigo = strPlan_Codigo
                ' objRegistrarCampania.planDescripcion = strPlan_Desc
                ' objRegistrarCampania.tipoPrdCodigo = strTipo_Prod_Cod
                ' objRegistrarCampania.tipoPrdDescripcion = strTipo_Prod_Des
                ' objRegistrarCampania.campaniaCodigo = strCampanaCod
                ' objRegistrarCampania.campaniaDescripcion = strCampanaDesc
                ' objRegistrarCampania.coId = datosRenoPlan(1)
                ' objRegistrarCampania.tipoOpeCodigo = strTipo_Opera_Cod
                ' objRegistrarCampania.tipoOpeDescripcion = strTipo_opera_Des
                ' objRegistrarCampania.estado = strCamp_Estado
                ' objRegistrarCampania.usuarioCrea = strUsuario
                ' objRegistrarCampania.fechaCrea = strFecha_crea
                ' objRegistrarCampania.usuarioModifica = ""
                ' objRegistrarCampania.fechaModifica = ""
                ' objRegistrarCampania.fechaActivacion = fechaMigPlan

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "campaniaDescripcion:" & objRegistrarCampania.campaniaDescripcion)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "fechaActivacion:" & objRegistrarCampania.fechaActivacion)

                ' objRegistrarCampaniasRequest.MessageRequest.Body.registrarCampaniaRequest.auditRequest = objauditRequest
                ' objRegistrarCampaniasRequest.MessageRequest.Body.registrarCampaniaRequest.registrarCampania = objRegistrarCampania

                ' objBEAuditoriaREST.IDTRANSACCION = Now.Year & Now.Month & Now.Day & Now.Hour & Now.Minute & Now.Second
                ' objBEAuditoriaREST.IPAPLICACION = AppLOCAL_ADDR
                ' objBEAuditoriaREST.idTransaccionNegocio = CurrentTerminal
                ' objBEAuditoriaREST.USRAPP = CurrentUser
                ' objBEAuditoriaREST.applicationCodeWS = ConfigurationSettings.AppSettings("strAplicacionSISACT")
                ' objBEAuditoriaREST.APLICACION = ConfigurationSettings.AppSettings("constAplicacion")
                ' objBEAuditoriaREST.userId = CurrentUser
                ' objBEAuditoriaREST.nameRegEdit = ""

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Proy-140245 IDTRANSACCION:" & objBEAuditoriaREST.IDTRANSACCION)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Proy-140245 IPAPLICACION:" & objBEAuditoriaREST.IPAPLICACION)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Proy-140245 idTransaccionNegocio:" & objBEAuditoriaREST.idTransaccionNegocio)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Proy-140245 idTransaccionNegocio:" & objBEAuditoriaREST.APLICACION)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Proy-140245 idTransaccionNegocio:" & objBEAuditoriaREST.applicationCodeWS)

                ' objRegistrarCampaniasResponse = objRegistrar.RegistrarCampaniasResponse(objRegistrarCampaniasRequest, objBEAuditoriaREST)

                ' strCodRpt = objRegistrarCampaniasResponse.MessageResponse.Body.registrarCampaniaResponse.auditResponse.codigoRespuesta
                ' strMsjRpt = objRegistrarCampaniasResponse.MessageResponse.Body.registrarCampaniaResponse.auditResponse.mensajeRespuesta

                ' 'objRegistrarCampaniasResponse = objRegistrar.RegistrarCampaniasResponse(objRegistrarCampaniasRequest, objBEAuditoriaREST)

                ' 'strCodRpt = "0" 'objRegistrarCampaniasResponse.MessageResponse.Body.registrarCampaniaResponse.auditResponse.codigoRespuesta
                ' 'strMsjRpt = "Exito" 'objRegistrarCampaniasResponse.MessageResponse.Body.registrarCampaniaResponse.auditResponse.mensajeRespuesta

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Response WS RegistrarCampana")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "COD_RPTA: " & strCodRpt)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "MSG_RPTA: " & strMsjRpt)
                ' 'INC000002161718 fin 

                ' strTipo_opera_Des = ""
                ' strNro_Sec = "0"
                ' strNro_Ped_Det = "0"
                ' strTipo_Opera_Cod = ""
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Proy-140245 limpiar variables")
                ' End If
                ' '140245: Fin()
                ' End If
                ' End If
            End If 'JRM - CREO QUE CAE EN ERROR


            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin consultar datos del pedido")

            ' If p_limpiador = 1 Then
            ' C_VENTA_DET = Nothing
            ' C_VENTA = Nothing
            ' Else
            If C_VENTA.Rows.Count = 0 Then
                C_VENTA = Nothing
            End If

            If C_VENTA_DET.Rows.Count = 0 Then
                C_VENTA_DET = Nothing
            End If

            C_VENTA_DET = C_VENTA_DET
            C_VENTA = C_VENTA
            ' End If


            Dim dblTotPreCuo As Double
            Dim dblTotalReg As Double
            'si es venta prepago y ademas tiene cuotas  
            'inicio promocion modem + laptop

            ' If campania_Pre <> "" Then
            ' Campania = campania_Pre
            ' Plan_final = plan_pre
            ' End If

            ' If campania_Post <> "" Then
            ' Campania = campania_Post
            ' Plan_final = plan_post
            ' End If

            ' ' E75893 - Validacion Adjuntar Documento Cliente solo Ventas Altas Prepago
            ' 'If ValidacionVentaDOL(drPagos.Item("VBELN"), CStr(drPagos.Item("PEDIDO"))) Then TODOEB
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicia ValidacionVentaDOL")
            ' 'INICIATIVA-318 INI
            ' 'If divPagos.Visible Then
            ' '    If ValidacionVentaDOL(dsPedido.Tables(0).Rows(0)("PEDIN_NROPEDIDO"), dsPedido.Tables(0).Rows(0)("PEDIN_NROPEDIDO")) Then
            ' '        If hidFlagCargaDocDOL.Value <> "1" Then
            ' '            Dim tipoDocCliente As String

            ' '            tipoDocCliente = dsPedido.Tables(0).Rows(0)("CLIEC_TIPODOCCLIENTE")

            ' '            If Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")) <> ConfigurationSettings.AppSettings("strTipDoc") Then
            ' '                If Not Right("00" & tipoDocCliente, 2) = "06" Then
            ' '                    Response.Write("<script>alert('" & ConfigurationSettings.AppSettings("mensajeAdjuntarDNI") & "')</script>")
            ' '                    Exit Sub
            ' '                End If
            ' '            End If
            ' '        End If
            ' '    End If
            ' 'End If
            ' 'INICIATIVA-318 FIN

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin ValidacionVentaDOL")


            '***IDG****'
            '*****Validación Pago del documento total **********************************************************************************************'
            If Trim(ApptxtMonto1) <> "" Then
                dblTotalReg = CDbl(ApptxtMonto1)
            End If
            'If Trim(txtMonto2) <> "" Then
            '    dblTotalReg += CDbl(txtMonto2)
            'End If
            'If Trim(txtMonto3) <> "" Then
            '    dblTotalReg += CDbl(txtMonto3)
            'End If
            'If Trim(txtMonto4) <> "" Then
            '    dblTotalReg += CDbl(txtMonto4)
            'End If
            'If Trim(txtMonto5) <> "" Then
            '    dblTotalReg += CDbl(txtMonto5)
            'End If

            Dim dblMontoGrilla As String = Funciones.CheckStr(drPagos.Item("INPAN_TOTALDOCUMENTO"))
            Dim dblMontoConsulta As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO"))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - INICIO VALIDAR MONTOS")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " -      MONTO TOTAL GRILLA: " & dblMontoGrilla)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " -      MONTO TOTAL CONSULTA PEDIDO: " & dblMontoConsulta)
            If Not dblMontoGrilla.Equals(dblMontoConsulta) Then
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " -      RPTA: MONTOS DIFERENTES")
                AppmsgDevolucion = ConfigurationSettings.AppSettings("strMsgErrorMonto")
                AppCodigoExitFunction = "-2"
                AppMensajeExitFunction = AppmsgDevolucion
                'Response.Redirect("PoolPagos.aspx", False)
                Exit Function
            End If
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " -      RPTA: MONTOS CORRECTOS")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - FIN VALIDAR MONTOS")

            If Funciones.CheckDbl(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")) <> ConfigurationSettings.AppSettings("ClaseNotaCanje") And _
                Funciones.CheckDbl(dsPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO")) = 0 And _
                Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_ESQUEMACALCULO")) <> ConfigurationSettings.AppSettings("ESQUEMACALCULO_TG") Then
                'Response.Write("<script>alert('" & ConfigurationSettings.AppSettings("MSG_MontoCero_NO_ES_TG") & "')</script>")
                AppErrorPagoParcial = ConfigurationSettings.AppSettings("MSG_MontoCero_NO_ES_TG")
                Exit Function
            End If

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "dblTotalReg : " & Funciones.CheckStr(dblTotalReg))
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "txtNeto.Text : " & Funciones.CheckStr(txtNeto))

            'PROY-30166 - IDEA  38934  INICIO
            Dim cuota As Integer = HidNroCuotas
            If (cuota = 0 And dblMontoCuotaInicial <= 0) Then
                If Math.Round(dblTotalReg, 2) <> Math.Round(Funciones.CheckDbl(txtNeto), 2) Then
                    'Response.Write("<script>alert('No se permiten pagos parciales. El pago debe ser por el total del documento.')</script>")
                    AppErrorPagoParcial = "No se permiten pagos parciales. El pago debe ser por el total del documento."
                    Exit Function
                End If
            Else
                If Math.Round(dblTotalReg, 2) <> Math.Round(Funciones.CheckDbl(txtCuotaIni), 2) Then
                    'Response.Write("<script>alert('No se permiten pagos parciales. El pago debe ser por el monto de la cuota inicial.')</script>")
                    AppErrorPagoParcial = "No se permiten pagos parciales. El pago debe ser por el monto de la cuota inicial."
                    Exit Function
                End If
            End If
            'PROY-30166 - IDEA  38934  FIN			
            '***************************************************************************************************************************************'
            '***FDG******'

            '***************************************************************************************************************************************'
            '***FDG******'


            If blnSunat Then
                'dsResult = objPagos.Get_ConsultaPedido("", Session("ALMACEN"), drPagos.Item("VBELN"), "")
                dsResult = objConsultaMsSap.ConsultaPedido(drPagos.Item("PEDIN_NROPEDIDO"), "", "")

                If Not IsNothing(dsResult) Then
                    'strNroDoc = dsResult.Tables(0).Rows(0).Item("DOCUMENTO") TODOEB
                    'strNroDoc = dsResult.Tables(0).Rows(0).Item("PEDIV_NRODOCCLIENTE")
                    strNroDoc = dsResult.Tables(0).Rows(0).Item("CLIEV_NRODOCCLIENTE")
                Else
                    strNroDoc = ""
                End If

                blnFlagPago = True

                '************************************************************************************************'
                '**
                '** La parte de la Triaciòn, queda sin Efecto. ** Consultado y validado por Eriberto  14.01.15 **
                '************************************************************************************************'
                'If strNroDoc <> "" Then
                '    dsResult = objPagos.ConsultaTriacionPrePost(strNroDoc, "", "", "")
                '    If Not IsNothing(dsResult) Then
                '        'blnFlagPago = True
                '        For i = 0 To dsResult.Tables(0).Rows.Count - 1
                '            strPrepago = dsResult.Tables(0).Rows(i).Item("NRO_DOC_PREPAGO")
                '            strPostPago = dsResult.Tables(0).Rows(i).Item("NRO_DOC_POSTPAGO")
                '            intCeros = (Len(strNroDoc) - Len(strPrepago))

                '            If intCeros > 0 Then
                '                For j = 1 To intCeros
                '                    strPrepago = "0" & strPrepago
                '                Next
                '            End If

                '            intCeros = Len(strNroDoc) - Len(strPostPago)
                '            If intCeros > 0 Then
                '                For j = 1 To intCeros
                '                    strPostPago = "0" & strPostPago
                '                Next
                '            End If

                '            If strNroDoc = strPrepago Then
                '                strEstado = ConfigurationSettings.AppSettings("gstrCamEstadoVendido")
                '                strMensaje = ConfigurationSettings.AppSettings("gstrMsgPagodePre")
                '                If dsResult.Tables(0).Rows(i).Item("ESTADO") <> ConfigurationSettings.AppSettings("gstrCamEstadoPagado") Then
                '                    blnFlagPago = False
                '                End If
                '            End If
                '            If strNroDoc = strPostPago Then
                '                strEstado = ConfigurationSettings.AppSettings("gstrCamEstadoPagado")
                '                strMensaje = ConfigurationSettings.AppSettings("gstrMsgPagodePost")
                '                If dsResult.Tables(0).Rows(i).Item("ESTADO") <> ConfigurationSettings.AppSettings("gstrCamEstadoUsado") Then
                '                    blnFlagPago = False
                '                End If
                '            End If

                '            strCadenaCam = strCadenaCam & dsResult.Tables(0).Rows(i).Item("SECUENCIAL") & ";"
                '            strCadenaCam = strCadenaCam & dsResult.Tables(0).Rows(i).Item("OFICINA_VENTA") & ";"
                '            strCadenaCam = strCadenaCam & dsResult.Tables(0).Rows(i).Item("CLIENTE") & ";"
                '            strCadenaCam = strCadenaCam & dsResult.Tables(0).Rows(i).Item("TIPO_DOC_CLIENTE") & ";"
                '            strCadenaCam = strCadenaCam & dsResult.Tables(0).Rows(i).Item("NRO_TEL_PREPAGO") & ";"
                '            strCadenaCam = strCadenaCam & dsResult.Tables(0).Rows(i).Item("NRO_DOC_PREPAGO") & ";"
                '            strCadenaCam = strCadenaCam & dsResult.Tables(0).Rows(i).Item("NRO_TEL_POSTPAGO") & ";"
                '            strCadenaCam = strCadenaCam & dsResult.Tables(0).Rows(i).Item("NRO_DOC_POSTPAGO") & ";"
                '            strCadenaCam = strCadenaCam & strEstado & "|"

                '        Next

                '        If Len(Trim(strCadenaCam)) > 0 Then
                '            strCadenaCam = Mid(strCadenaCam, 1, Len(strCadenaCam) - 1)
                '        End If
                '    End If

                '    If Not blnFlagPago Then
                '        Session("strMensajeCaja") = strMensaje
                '        'Response.Write("<script>alert('" & strMensaje & "')</script>")
                '        Response.Redirect("PoolPagos.aspx")
                '    End If
                'End If '***********  FIN DE LA TRIACIÒN *****************************************************'
                '*************************************************************************************'
            End If
            ' FIN CAMPAÑA PRE + POST
            dblEfectivo = 0
            dblTotalTarjeta = 0
            If hidNumFilas = "" Then hidNumFilas = 0
            strDetallePago = ""
            'PROY-27440 INI
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicia asignaciòn el importe total")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INPAN_TOTALDOCUMENTO : " & Funciones.CheckStr(Format(dsPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO"), "###0.00")))
            ApptxtMonto1 = Format(dsPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO"), "###0.00")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin asignaciòn el importe total")

            Dim strMonto As String = ""
            Dim strTipoDocPago As String = ""
            'PROY-27440 FIN
            For i = 1 To hidNumFilas

                'PROY-27440 INI
                'Dim objTxt As TextBox
                'objTxt = CType(Me.FindControl("txtMonto" & i), TextBox)
                'strMonto = "" : strMonto = Trim(objTxt.Text)

                strMonto = ApptxtMonto1

                'Dim objCbo As DropDownList
                'objCbo = CType(Me.FindControl("cboTipDocumento" & i), DropDownList)
                'strTipoDocPago = "" : strTipoDocPago = Trim(objCbo.SelectedValue)

                strTipoDocPago = AppCboTipoDocumento

                'PROY-27440 FIN
                strDetallePago = strDetallePago & ";"
                'strDetallePago = strDetallePago & Session("ALMACEN") & ";" ' Concatenar detalles de pag
                strDetallePago = strDetallePago & AppAlmacen & ";"    ' Concatenar detalles de pago
                strDetallePago = strDetallePago & strTipoDocPago & ";"  ' Codigo del Tipo de documento (Via de Pago) ''PROY-27440
                strDetallePago = strDetallePago & ";"
                strDetallePago = strDetallePago & ";"
                strDetallePago = strDetallePago & strMonto & ";" ' Monto de pago ''PROY-27440
                'If (Session("VarVal2") = Session("CANAL")) Then      ' averiguar en que variable se guarda canal - MONEDA
                strDetallePago = strDetallePago & "PEN" & ";"
                'Else
                '    strDetallePago = strDetallePago & "L" & ";"
                'End If

                strDetallePago = strDetallePago & ";"

                strDetallePago = strDetallePago & strNumAsignaSUNAT & ";"
                strDetallePago = strDetallePago & strTipoDocPago & ";"    ' GLOSA QUE ES LO MISMO DE VIA_PAGO ''PROY-27440
                '  strDetallePago = strDetallePago &  DateTime.Now & ";"    ' Fecha de documento que esta en el detalle - F_PEDIDO TODOEB
                strDetallePago = strDetallePago & DateTime.Now & ";"    ' Fecha de documento que esta en el detalle - F_PEDIDO
                strDetallePago = strDetallePago & ";"

                'If (Session("VarVal2") = Session("CANAL")) Then
                strDetallePago = strDetallePago & ";"
                'Else
                '    strDetallePago = strDetallePago & strTipoFact & ";"
                'End If

                If Trim(strTipoDocPago) = "ZEFE" Then ''PROY-27440
                    dblEfectivo += CDbl(Trim(strMonto)) ''PROY-27440
                End If

                If (i < CInt(hidNumFilas)) Then
                    strDetallePago = strDetallePago & "|"
                End If

                'Valida sumatoria de tarjetas....
                'AVILLAR : ZNCR
                ''PROY-27440 - INI
                If strTipoDocPago <> "ZNCR" And strTipoDocPago <> "ZEFE" And strTipoDocPago <> "ZEAM" And strTipoDocPago <> "ZEOV" And strTipoDocPago <> "TDPP" And strTipoDocPago <> "ZDEL" And strTipoDocPago <> "ZBUY" Then
                    dblTotalTarjeta += strMonto
                End If
                ''PROY-27440 - FIN
                'FIN AVILLAR
            Next

            'AVILLAR
            If dblTotalTarjeta > dblMontoTarjeta Then
                If AppCarga = 0 Then
                    'INICIATIVA - 529 INI
                    'Session("strMensajeCaja") = "Debe adjuntar una copia del Documento de Identidad"
                    'Response.Redirect("PoolPagos.aspx")
                    'INICIATIVA - 529 FIN
                End If
            End If
            'FIN AVILLAR

            If (dblEfectivo + dblEfecCaja) >= dblTolerancia + dsEfectivo.Tables(0).Rows(0).Item("CAJA_MAX_DISP_SOL") Then
                'Response.Write("<script>alert('Este pago excede su tolerancia de monto máximo de efectivo en caja')</script>")
                AppstrMensajeCaja = "Este pago excedió su tolerancia de monto máximo de efectivo en caja"
            End If
            'Else

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ListarDatosCabeceraVenta - strDocSap: " & strDocSap)
            dtDatos = objBus.ListarDatosCabeceraVenta(strDocSap)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ListarDatosCabeceraVenta - dtDatos: " & dtDatos.Rows.Count.ToString)

            ' INICIO FMES :DETERMINA SI TIENE EL FLAG DE PILOTO VENTA EN CAC
            'If dtDatos.Rows.Count > 0 Then
            'If Funciones.CheckStr(dtDatos.Rows(0).Item("VEPR_FLAG_VENTA_CAC").ToString()) = "1" Then
            'booDol = False
            'End If
            'End If

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ListarDatosCabeceraVenta - booDol: " & booDol.ToString)
            ' FIN FMES :DETERMINA SI TIENE EL FLAG DE PILOTO VENTA EN CAC


            If dsPedido.Tables(0).Rows.Count Then
                ''''***IDG*****************************************************************************************************************************************************'
                '''**** CONSULTA DATOS DEL CAJERO ****'
                Dim cultureNameX As String = "es-PE"
                Dim cultureX As CultureInfo = New CultureInfo(cultureNameX)
                Dim dateTimeValueCaja As DateTime
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Iniciamos la consulta de los datos CAJA")
                dateTimeValueCaja = Convert.ToDateTime(DateTime.Now, cultureX)
                Dim strFecha As String = ""
                strFecha = Format(Now.Day, "00") & "/" & Format(Now.Month, "00") & "/" & Format(Now.Year, "0000")
                Dim codigo_vendedor_session As String = ""

                'Try
                '    objOfflineCaja = New COM_SIC_OffLine.clsOffline
                '    codigo_vendedor_session = Funciones.CheckStr(AppUsuario).PadLeft(10, "0")

                '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "---------------------------------------------------- ")
                '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Paràmetros : GetDatosAsignacionCajero")
                '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Param1: " & Funciones.CheckStr(AppAlmacen))
                '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Param2: " & Funciones.CheckStr(dateTimeValueCaja.ToShortDateString))
                '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Param2: " & Funciones.CheckStr(strFecha.ToString))
                '    'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Param3: " & "00000" & Funciones.CheckStr(Session("USUARIO")))
                '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Param3: " & codigo_vendedor_session)
                '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "---------------------------------------------------- ")



                '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-----------------------------------------------------------------------------")
                '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "Test de fechas:")
                '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- strFecha " & strFecha.ToString)
                '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- dateTimeValueCaja " & dateTimeValueCaja.ToLocalTime.ToShortDateString)
                '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Fecha Pedido " & CStr(dsPedido.Tables(0).Rows(0).Item("PEDID_FECHADOCUMENTO")))
                '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-----------------------------------------------------------------------------")


                '    'dsCajeroA = objOfflineCaja.GetDatosAsignacionCajero(Funciones.CheckStr(Session("ALMACEN")), Funciones.CheckStr(dateTimeValueCaja.ToShortDateString), "00000" & Funciones.CheckStr(Session("USUARIO")).ToString)
                '    Dim dFechaCaj As Date
                '    Dim sFechaCaj As String = dateTimeValueCaja.ToLocalTime.ToShortDateString
                '    'PROY-140397-MCKINSEY -> JSQ INICIO
                '    sFechaCaj = DateTime.Now.ToString("dd/MM/yyyy")
                '    'PROY-140397-MCKINSEY -> JSQ FIN
                '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - Fecha Pedido : " & sFechaCaj)
                '    dsCajeroA = objOfflineCaja.GetDatosAsignacionCajero(Funciones.CheckStr(AppAlmacen), sFechaCaj, codigo_vendedor_session)
                '    If (dsCajeroA Is Nothing OrElse dsCajeroA.Tables(0).Rows.Count <= 0) Then
                '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- No se pudo determinar el numero de la caja asignada.")
                '        'Response.Write("<script>alert('No se encontro el Nùmero/Nombre de caja asignado.')</script>")
                '        AppErrorCaja = "No se encontro el Nùmero/Nombre de caja asignado."
                '        Exit Function
                '    End If
                '    ' Validar cierre de caja
                '    If Not dsCajeroA Is Nothing Then
                '        For cont As Int32 = 0 To dsCajeroA.Tables(0).Rows.Count - 1
                '            If dsCajeroA.Tables(0).Rows(cont).Item("CAJA_CERRADA") = "S" Then
                '                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "MENSAJE : " & "Caja Cerrada, no es posible realizar el pago.")
                '                Dim script$ = String.Format("<script language=javascript>alert('{0}')</script>", "Caja Cerrada, no es posible realizar el pago.")
                '                'Me.RegisterStartupScript("RegistraAlerta", script)
                '                AppErrorCaja = "Caja Cerrada, no es posible realizar el pago."
                '                Exit Function
                '            End If
                '        Next
                '    End If

                'Catch ex As Exception
                '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Error al tratar de consultar los datos de CAJA")
                '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Error: " & ex.Message.ToString)
                'End Try

                ''**Buscamos el nombre de la Caja
                'If dsCajeroA.Tables(0).Rows.Count > 0 Then
                '    dsCajeroB = objOfflineCaja.Get_CajaOficinas(AppAlmacen)
                '    If (dsCajeroB Is Nothing OrElse dsCajeroA.Tables(0).Rows.Count <= 0) Then
                '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- No se pudo determinar el nombre de la caja asignada.")
                '        'Response.Write("<script>alert('No se encontro el Nùmero/Nombre de caja asignado.')</script>")
                '        AppErrorCaja = "No se encontro el Nùmero/Nombre de caja asignado."
                '        Exit Function
                '    Else
                '        For c As Int16 = 0 To dsCajeroB.Tables(0).Rows.Count - 1
                '            '**Comparamos los numeros de caja:
                '            If dsCajeroA.Tables(0).Rows(0).Item("CAJA") = dsCajeroB.Tables(0).Rows(c).Item("CASNR") Then
                '                strNombreCaja = Funciones.CheckStr(dsCajeroB.Tables(0).Rows(c).Item("BEZEI")).ToString.Trim
                '            End If
                '        Next
                '    End If
                'End If
                ''***FDG*****************************************************************************************************************************************************'

                '**IDG**
                '***Cuando el pago se hace con forma NC y no cumple las validaciones ***
                'Try
                '    If ConsultaFormaPagoNotaCredito() = False Then
                '        Exit Function    '** terminamos el proceso **'
                '    End If
                'Catch ex As Exception

                'End Try
                '**FDG*********************************************************************

                '****Valores para la caja:
                'strNombreCaja, _
                'dsCajeroA.Tables(0).Rows(0).Item("CAJA"), _

                ' 'PROY-31850 - INICIO
                ' blnIsOLO = False
                ' If blnSunat Then
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INICIO VALIDACIONES VENTA OLO")
                ' Try
                ' Dim objClsActivacionPEL As New ClsActivacionPel
                ' Dim strNumeroPedidoOLO = Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO"))
                ' Dim strCodRespuestaPrepago As String = ""
                ' Dim strCodProductoPrepago As String = ""

                ' '1. Validar si es venta prepago - OLO
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " INICIO Lis_Lista_Detalle_Venta_Prepago")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " IN strNumeroPedidoOLO:" & strNumeroPedidoOLO)
                ' Dim arrListaPrepago As ArrayList = objClsActivacionPEL.Lis_Lista_Detalle_Venta_Prepago(strNumeroPedidoOLO, strCodRespuestaPrepago)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " OUT arrListaPrepago :" & arrListaPrepago.Count)

                ' If arrListaPrepago.Count > 0 Then
                ' For Each item As COM_SIC_Activaciones.DetalleVentaPrepago In arrListaPrepago
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     INICIO LEER DATOS PREPAGO")
                ' strCodProductoPrepago = Funciones.CheckStr(item.COD_PROD_PREP)
                ' strIdPedidoVentaPVU = Funciones.CheckStr(item.ID)
                ' strSerieChip = strSerieChip & "|" & Funciones.CheckStr(item.SERIE_CHIP)
                ' strSerieEquipo = strSerieEquipo & "|" & Funciones.CheckStr(item.SERIE_EQUI)
                ' strCodMaterialChip = strCodMaterialChip & "|" & Funciones.CheckStr(item.COD_MATERIAL_CHIP)
                ' strNumDocumento = Funciones.CheckStr(item.NUM_DOC)
                ' strTipoDocumento = Funciones.CheckStr(item.TIPO_DOC)
                ' If strCodProductoPrepago = Funciones.CheckStr(strCodProductoOLO) Then
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strCodProductoPrepago: " & strCodProductoPrepago)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strIdPedidoVentaPVU: " & strIdPedidoVentaPVU)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strSerieChip: " & Funciones.CheckStr(item.SERIE_CHIP))
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strCodMaterialChip: " & Funciones.CheckStr(item.COD_MATERIAL_CHIP))
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strNumDocumento: " & strNumDocumento)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strTipoDocumento: " & strTipoDocumento)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     blnIsOLO: True")
                ' blnIsOLO = True
                ' 'Exit For
                ' End If


                ' If blnIsOLO Then
                ' Dim strCodMensaje As String
                ' Dim strDesMensaje As String
                ' Dim strCodMnjG As String
                ' Dim strDesMnjG As String
                ' Dim strNumLinea As String = ""
                ' Dim strDescMensaje As String = ""
                ' Dim intNumIntentosMobile As String = Funciones.CheckInt(strMobileNumberWS_NumIntentos)
                ' Dim intNumIntentosGeneric As String = Funciones.CheckInt(strGenericWS_NumIntentos)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     intNumIntentosMobile: " & intNumIntentosMobile)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     intNumIntentosGeneric: " & intNumIntentosGeneric)

                ' Dim objLinea As New COM_SIC_Activaciones.BWMobileNumberService
                ' Dim objMensaje As New COM_SIC_Activaciones.BWGenericEntityService

                ' Dim IdTransa As String = DateTime.Now.ToString("yyyyMMddHHmmss") + "_" + strNumeroPedidoOLO
                ' Dim CodApli As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("CodAplicacion"))
                ' Dim UserApli As String = Funciones.CheckStr(AppUsuario)
                ' '2. Obtener Lineas
                ' If (intNumIntentosMobile = 0) Then
                ' intNumIntentosMobile = 1
                ' End If

                ' Dim k As Integer = 0
                ' Do While (k < intNumIntentosMobile)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     INICIO: ObtenerLineaOLO")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         IN IdTransa: " & IdTransa)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         IN CodApli: " & CodApli)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         IN UserApli: " & UserApli)
                ' strLineaOLO = objLinea.ObtenerLineaOLO(IdTransa, CodApli, UserApli, strCodMensaje, strDesMensaje)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         OUT strCodMensaje: " & strCodMensaje)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         OUT strDesMensaje: " & strDesMensaje)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     FIN: ObtenerLineaOLO")

                ' If (strCodMensaje = "0" And strLineaOLO.Length > 0) Then
                ' Exit Do
                ' End If
                ' k = (k + 1)
                ' Loop

                ' If strCodMensaje <> "0" Or strLineaOLO = "" Then
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         ERROR ObtenerLineaOLO: " & Funciones.CheckStr(clsKeyOLO.strVentaErrorObtenerLineas))
                ' AppstrMensajeCaja = Funciones.CheckStr(clsKeyOLO.strVentaErrorObtenerLineas)
                ' blnIsOLO = False
                ' AppCodigoExitFunction = "-2"
                ' AppMensajeExitFunction = AppstrMensajeCaja
                ' 'Response.Redirect("PoolPagos.aspx")
                ' Exit Function
                ' Else
                ' '2. Reservar Lineas
                ' If (intNumIntentosGeneric = 0) Then
                ' intNumIntentosGeneric = 1
                ' End If

                ' Dim y As Integer = 0

                ' Do While (y < intNumIntentosGeneric)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     INICIO: ReservarLineaOLO")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         IN IdTransa: " & IdTransa)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         IN CodApli: " & CodApli)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         IN UserApli: " & UserApli)
                ' objMensaje.ReservarLineaOLO(IdTransa, CodApli, UserApli, strLineaOLO, strCodMnjG, strDesMnjG)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         OUT strCodMnjG: " & strCodMnjG)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         OUT strDesMnjG: " & strDesMnjG)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     FIN: ReservarLineaOLO")
                ' If strCodMnjG = "0" Then
                ' Exit Do
                ' End If
                ' y = (y + 1)
                ' Loop
                ' If strCodMnjG <> "0" Then
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         ERROR ObtenerLineaOLO: " & Funciones.CheckStr(clsKeyOLO.strVentaErrorReservarLinea))
                ' AppstrMensajeCaja = Funciones.CheckStr(clsKeyOLO.strVentaErrorReservarLinea)
                ' blnIsOLO = False
                ' AppCodigoExitFunction = "-2"
                ' AppMensajeExitFunction = AppstrMensajeCaja
                ' 'Response.Redirect("PoolPagos.aspx")
                ' Exit Function
                ' End If
                ' strLineaActivacion = strLineaActivacion & "|" & strLineaOLO
                ' End If
                ' Else
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "NO ES PREPAGO OLO")
                ' End If
                ' Next
                ' Else
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "NO ES PREPAGO")
                ' End If
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FIN FLUJO VENTA OLO")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                ' Catch ex As Exception
                ' 'INI PROY-140126
                ' Dim MaptPath As String
                ' MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                ' MaptPath = "( Class : " & MaptPath & "; Function: guardarConectado)"
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR FLUJO VENTA OLO" & ex.Message.ToString() & MaptPath)
                ' 'FIN PROY-140126

                ' End Try
                ' End If

                ' 'PROY-31850 - FIN


                ' Dim strRespPago As Boolean 'PROY-23700 

                ' '**** INICIO NOTAS DE CANJE*****
                ' If dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA") = ConfigurationSettings.AppSettings("ClaseNotaCanje") Then
                ' Try
                ' 'PROY-23700 INICIO
                ' 'If drPagos.Item("PAGOC_CODSUNAT") = "0000000000000000" Then
                ' PagarNotaCanje(drPagos.Item("PEDIN_NROPEDIDO"), dsPedido, strRespPago)

                ' If AppCodigoDeshacerCambios = "-3" Then
                ' AppCodigoExitFunction = "-2"
                ' AppMensajeExitFunction = AppMensajeDeshacerCambios
                ' Exit Function
                ' End If

                ' If (strRespPago) Then
                ' Exit Function
                ' Else
                ' AppCodigoExitFunction = "-2"
                ' AppMensajeExitFunction = "Error al pagar la nota de canje"

                ' 'Response.Redirect("PoolPagos.aspx", False)
                ' Exit Function
                ' End If
                ' 'PROY-23700 FIN
                ' Catch ex As Exception
                ' 'Response.Redirect("PoolPagos.aspx", False)
                ' AppCodigoExitFunction = "-2"
                ' AppMensajeExitFunction = "Error al pagar la nota de canje"
                ' Exit Function
                ' End Try

                ' End If
                ' '**** FIN NOTAS DE CANJE ******
                ' Try
                ' 'inicio whzr 23062015
                ' Dim strEmpleado As String = AppstrUsuario
                ' Dim strUrl As String = ConfigurationSettings.AppSettings("consConsultaProgramacion")
                ' Dim objCambioPlan As COM_SIC_Activaciones.CambioPlanPostpago
                ' Dim strTipTransaccion As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("consTipoTransaccion"))
                ' Dim strFechaDesde As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("consFechaDesde"))
                ' Dim strFechaHasta As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("consFechaHasta"))
                ' Dim strAsesor As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("consAsesor"))
                ' Dim strCuenta As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("consCuenta"))
                ' Dim strCodInteraccion As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("consCodInteraccion"))
                ' Dim strCadDac As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("consCadDac"))
                ' Dim strServCod As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("consServCod"))
                ' Dim strTipServicio As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("consTipoServicio"))
                ' Dim strEstadoTrans As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("consEstadoTrans"))
                ' Dim mensajeError As String = String.Empty
                ' Dim strNroLinea As String = FormatoTelefonoPrepago(Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO")))

                ' If dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVPostpago") And _
                ' dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION") = ConfigurationSettings.AppSettings("strDTVRenovacion") Then
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "-----------------------------------------------------------------------------------------------------------------")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "                                 INICIO WS -> ConsultaProgramacion (" & strNroLinea & ") ")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, " URL -> " & strUrl & " || USER -> " & strEmpleado)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "-----------------------------------------------------------------------------------------------------------------")

                ' objCambioPlan = (New COM_SIC_Activaciones.clsConsultaProgramacion).ConsultaProgramacion(strNroLinea, strTipTransaccion, strEstadoTrans, strTipServicio, strFechaDesde, _
                ' strFechaHasta, strAsesor, strCuenta, strCodInteraccion, strCadDac, strServCod, strEmpleado, mensajeError)
                ' 'objCambioPlan = (New COM_SIC_Activaciones.clsConsultaCambioPlan).ConsultaCambioPlan(strNroLinea, strTipTransaccion, strEstadoTrans, mensajeError)

                ' If mensajeError.Equals(String.Empty) Then
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "-  ConsultaProgramacion()  (output) -> mensaje: La Lectura de los datos del NroLinea " & strNroLinea & " fue correcta")
                ' Else
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "-  ConsultaProgramacion()  (output) -> mensaje: Error al leer datos del NroLinea: " & strNroLinea & " " & mensajeError)
                ' AppstrMensajeCaja = mensajeError
                ' ' Response.Redirect("PoolPagos.aspx")
                ' AppCodigoExitFunction = "-2"
                ' AppMensajeExitFunction = AppstrMensajeCaja
                ' Exit Function
                ' End If

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "-----------------------------------------------------------------------------------------------------------------")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "                                 FIN WS -> ConsultaProgramacion (" & strNroLinea & ") ")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "-----------------------------------------------------------------------------------------------------------------")

                ' End If

                ' Catch ex As Exception
                ' 'INI PROY-140126
                ' Dim MaptPath As String
                ' MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                ' MaptPath = "( Class : " & MaptPath & "; Function: guardarConectado)"
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "- Error ConsultaCambioPlanPendiente: " & ex.Message.ToString() & MaptPath)
                ' 'FIN PROY-140126

                ' End Try

                ' Dim pedic_tipoOficina As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOOFICINA"))
                ' Dim objAnnula As COM_SIC_Activaciones.clsTrsMsSap

                ' '/*----------------------------------------------------------------------------------------------------------------*/
                ' '/*--JR  INICIO  -  PROY-29380 IDEA-38934 - Iteración 2 y 3 2da Fase Sinergia Adec en Sist de Venta y Post-Venta --*/
                ' '/*----------------------------------------------------------------------------------------------------------------*/
                ' Dim strCodTipOpe As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("PEDIC_CODTIPOOPERACION"))
                ' Dim strDesTipOpe As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("PEDIV_DESCTIPOOPERACION"))
                ' '/*----------------------------------------------------------------------------------------------------------------*/
                ' '/*--JR  FIN     -  PROY-29380 IDEA-38934 - Iteración 2 y 3 2da Fase Sinergia Adec en Sist de Venta y Post-Venta --*/
                ' '/*----------------------------------------------------------------------------------------------------------------*/

                ' ' PROY 31850 FASE IV INICIO
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "-----------------------------------------------------------------------------------------------------------------")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, " INICIO RECARGAS OLO ")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "-----------------------------------------------------------------------------------------------------------------")

                ' Dim strTipoVenta As String = dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA")
                ' Dim strTipoDocumento2 As String = dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")
                ' Dim flagNC As Boolean = False


                ' Dim keyTipoDocumentoCanjeOrDev As String = ConfigurationSettings.AppSettings("KeyTipoDocumentoCanjeOrDev")
                ' Dim keyCodTipOperacionCanjeOrDev As String = ConfigurationSettings.AppSettings("KeyCodTipOperacionCanjeOrDev")


                ' If NumeroTelefono = "0" And (strTipoVenta = ConfigurationSettings.AppSettings("strTVPrepago") Or strTipoVenta = ConfigurationSettings.AppSettings("strTVPostpago")) _
                ' And (strTipoDocumento2 = ConfigurationSettings.AppSettings("strTipDoc") Or _
                ' strTipoDocumento2 = ConfigurationSettings.AppSettings("ClaseNotaCanje") Or _
                ' (keyTipoDocumentoCanjeOrDev.IndexOf(strTipoDocumento2.Trim()) <> -1 And keyCodTipOperacionCanjeOrDev.IndexOf(strCodTipOpe.Trim()) <> -1)) Then
                ' flagNC = True
                ' End If

                ' If flagNC = False Then
                ' If NumeroTelefono <> "" Then
                ' If (NumeroTelefono.Trim.Substring(0, intLongNroOLO) = strInicioNroOLO) Then ' PROY 31850 MEJORAS
                ' blnRecargaOlo = True
                ' End If
                ' End If
                ' End If

                ' ' If blnRecargaOlo = False Then

                ' ' '/*----------------------------------------------------------------------------------------------------------------*/
                ' ' '/*--JR  INICIO  -  PROY-29380 IDEA-38934 - Iteración 2 y 3 2da Fase Sinergia Adec en Sist de Venta y Post-Venta --*/
                ' ' '/*----------------------------------------------------------------------------------------------------------------*/
                ' ' If strCodTipOpe = "20" Or strCodTipOpe.ToUpper() = "DEVOLUCION" Or strDesTipOpe.ToUpper() = "DEVOLUCION" Then
                ' ' flagDevolucion = True
                ' ' Else
                ' ' If ApprecargaVirtual Then        'se agrego esta variable session
                ' ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Ejecuta el mètodo : Recarga ")
                ' ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- TipoOficina : " & pedic_tipoOficina)
                ' ' Recarga(pedic_tipoOficina)
                ' ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Fin del mètodo recarga.")
                ' ' End If
                ' ' End If
                ' ' '/*----------------------------------------------------------------------------------------------------------------*/
                ' ' '/*--JR  FIN  -  PROY-29380 IDEA-38934 - Iteración 2 y 3 2da Fase Sinergia Adec en Sist de Venta y Post-Venta --*/
                ' ' '/*----------------------------------------------------------------------------------------------------------------*/
                ' ' End If

                ' ' 'Dim strDesMnj As String
                ' ' Dim strCodMensajeOlo As String
                ' ' Dim strDescMensajeOlo As String = ""
                ' ' Dim sDocumentoSapOLO As String
                ' ' sDocumentoSapOLO = drPagos.Item("PEDIN_NROPEDIDO")
                ' ' Dim keyOLO As New clsKeyOLO
                ' ' ''-----------------------------
                ' ' Dim strCodLog, strMsjLog As String
                ' ' Dim strIdVenta As String
                ' ' Dim strIdService As String
                ' ' Dim _clsConsultaPvuBL As New COM_SIC_Activaciones.clsConsultaPvu
                ' ' Dim dsDatosOLO As New DataSet
                ' ' Dim strTipoOperacionOLO As String
                ' ' Dim strTipoDocOlo As String
                ' ' Dim strNroDocOlo As String
                ' ' Dim objMensajeOlo As New COM_SIC_Activaciones.BWProcesaVentaActivacionOlo
                ' ' Dim objCorreo As New COM_SIC_Activaciones.BWEnvioCorreo

                ' ' If blnRecargaOlo = True Then

                ' ' strCodMaterialOLO = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEC_CODMATERIAL"))
                ' ' If (strCodMaterialOLO = keyOLO.strRecupera_Valor_CodMaterial.ToString()) Then 'HARCODE 

                ' ' strIdPlanOLO = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEV_CODIGOLP"))
                ' ' strIdService = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEV_DESCRIPCIONLP"))
                ' ' strLineaRecargaOLO = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO"))
                ' ' strTipoOperacionOLO = "R" 'Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION")) 'PEDIV_DESCTIPOOPERACION
                ' ' strTipoDocumento = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("CLIEC_TIPODOCCLIENTE"))
                ' ' strNumDocumento = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("CLIEV_NRODOCCLIENTE"))
                ' ' '---------------------------------------------------------------    
                ' ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Ejecuta el mètodo : GetDatosVentasOLO() ")
                ' ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Nùmero Linea : " & strLineaRecargaOLO)
                ' ' dsDatosOLO = _clsConsultaPvuBL.GetDatosVentasOLO(strLineaRecargaOLO, strCodLog, strMsjLog) 'HARCODE 
                ' ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- FIN  mètodo : GetDatosVentasOLO() ")
                ' ' Try 'INI 31850 MEJORAS
                ' ' strIdVenta = Funciones.CheckStr(dsDatosOLO.Tables(0).Rows(0).Item("PO_VEPR_ID"))
                ' ' strTipoDocOlo = Funciones.CheckStr(dsDatosOLO.Tables(0).Rows(0).Item("PO_VEPR_TIPO_DOC"))
                ' ' strNroDocOlo = Funciones.CheckStr(dsDatosOLO.Tables(0).Rows(0).Item("PO_VEPR_NUM_DOC"))
                ' ' Catch ex As Exception
                ' ' objFileLog.Log_WriteLog(pathFile, strArchivo, "- Error ConsultaDatosOlo: " & ex.Message.ToString())
                ' ' End Try 'FIN 31850 MEJORAS
                ' ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- GetDatosVentasOLO ID VENTA : GetDatosVentasOLO() " & strIdVenta)
                ' ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- GetDatosVentasOLO TIPO DOC VENTA OLO : GetDatosVentasOLO() " & strTipoDocOlo)
                ' ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- GetDatosVentasOLO NUM DOC VENTA OLO : GetDatosVentasOLO() " & strNroDocOlo)

                ' ' End If

                ' ' If (Funciones.CheckStr(AppNumeroDocumentoOLO) <> Nothing Or Funciones.CheckStr(AppNumeroDocumentoOLO) <> "") Then  'INC000002542709 
                ' ' strNroDocOlo = Funciones.CheckStr(AppNumeroDocumentoOLO) 'PROY-31850 - INCIDENCIA RECARGA POR NUMERO DOCUMENTO
                ' ' End If  'INC000002542709

                ' ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- strNroDocOlo" & strNroDocOlo)  'INC000002542709



                ' ' '---------------------------------------------------------------  
                ' ' ' Invocar  ProcesaVentaActivacionOloWS  | procesarVentaActivacion
                ' ' Dim strIdTransaccionOLO As String = DateTime.Now.ToString("yyyyMMddHHmmss") + "_" + sDocumentoSapOLO
                ' ' Dim strCodAplicacionoOLO As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("CodAplicacion"))
                ' ' Dim strUserAplicacionOLO As String = Funciones.CheckStr(AppUsuario)

                ' ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio  WS ProcesarActivacionOLO ")
                ' ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp sDocumentoSapOLO	  :" & sDocumentoSapOLO)
                ' ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp strIdVenta	          :" & strIdVenta)
                ' ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp strTipoDocumento        :" & strTipoDocOlo)
                ' ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp strNumDocumento             :" & strNroDocOlo)
                ' ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp strIdTransaccionOLO      :" & strIdTransaccionOLO)
                ' ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp strCodAplicacionoOLO          :" & strCodAplicacionoOLO)
                ' ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp strUserAplicacionOLO              :" & strUserAplicacionOLO)
                ' ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp strUserAplicacionOLO           :" & strUserAplicacionOLO)
                ' ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp strTipoOperacionOLO     :" & strTipoOperacionOLO)
                ' ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp strIdPlanOLO            :" & strIdPlanOLO)
                ' ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp strIdService               :" & strIdService)
                ' ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Out strCodMensajeOlo     :" & strCodMensajeOlo)
                ' ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Out strDescMensajeOlo            :" & strDescMensajeOlo)

                ' ' 'PROY-31850 JECC1118 INI
                ' ' 'objMensajeOlo.ProcesarActivacionOLO(sDocumentoSapOLO, strIdVenta, strTipoDocOlo, strNroDocOlo, _
                ' ' 'strIdTransaccionOLO, strCodAplicacionoOLO, strUserAplicacionOLO, _
                ' ' 'strUserAplicacionOLO, strTipoOperacionOLO, strIdPlanOLO, strIdService, strCodMensajeOlo, strDescMensajeOlo)

                ' ' objMensajeOlo.ProcesarActivacionOLO(sDocumentoSapOLO, strIdVenta, strTipoDocOlo, strNroDocOlo, _
                ' ' sDocumentoSapOLO, strCodAplicacionoOLO, strUserAplicacionOLO, _
                ' ' strUserAplicacionOLO, strTipoOperacionOLO, strIdPlanOLO, strIdService, strCodMensajeOlo, strDescMensajeOlo)
                ' ' 'PROY-31850 JECC1118 FIN

                ' ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin  WS ProcesarActivacionOLO ")
                ' ' End If
                ' ' objFileLog.Log_WriteLog(pathFile, strArchivo, "-----------------------------------------------------------------------------------------------------------------")
                ' ' objFileLog.Log_WriteLog(pathFile, strArchivo, " FIN RECARGAS OLO ")
                ' ' objFileLog.Log_WriteLog(pathFile, strArchivo, "-----------------------------------------------------------------------------------------------------------------")
                ' ' 'PROY 31850 FASE IV FIN

                Try
                    '*************************'
                    '**** BLOQUE DE PAGO *******:
                    '*************************'
                    Dim txtMonto As Double
                    Dim cboTipDocumento As String
                    Dim cboDescTipDocumento As String

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio RegistrarPago (SSAPSI_PAGO2)")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Nro_Documento	  :" & drPagos.Item("PEDIN_NROPEDIDO"))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Estado	  :" & System.Configuration.ConfigurationSettings.AppSettings("ESTADO_PAG"))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Nro_Asignar        :" & strNumSunat)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Moneda :" & System.Configuration.ConfigurationSettings.AppSettings("MONEDA"))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Oficina_Venta      :" & AppAlmacen)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Reasignar          :" & "")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Fecha              :" & DateTime.Now)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp strPagos           :" & strDetallePago)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Nro_Ref_Corner     :" & "")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Usuario            :" & AppUsuario)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Caja               :" & Trim(AppCodImprTicket))


                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio del registro de la Cabecera del pago")
                    objTrsMsSap.RegistrarPago(drPagos.Item("PEDIN_NROPEDIDO"), DBNull.Value, _
                                                 System.Configuration.ConfigurationSettings.AppSettings("ESTADO_PAG"), _
                                                 "CAJA PRUEBA", _
                                                 0, _
                                                  System.Configuration.ConfigurationSettings.AppSettings("MONEDA"), _
                                                  AppUsuario, _
                                                  DBNull.Value, _
                                                  AppUsuario, _
                                                  DBNull.Value, _
                                                  K_NROLOG, K_DESLOG, K_PAGON_IDPAGO, K_PAGOC_CORRELATIVO)


                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin del registro de la Cabecera del pago")
                    If K_DESLOG = "OK" Then
                        'Session.Add("msgErrorGenerarSot", "Registro de Pago Correctamente")
                        AppmsgErrorGenerarSot = "Registro de Pago Correctamente"
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Registro de forma correcta de la cabecera del pago :" & K_PAGON_IDPAGO)

                        '************************************************************************
                        If (dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA") <> ConfigurationSettings.AppSettings("strTipDoc") And Funciones.CheckDbl(dsPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO")) > 0) Then
                            '** se preocesan los otros tipos de documentos.
                            Dim dTotPagoNoCuota As Double = 0 ' PROY-30166 GPRD
                            For i = 1 To hidNumFilas
                                'PROY-27440 INI
                                'Dim objTxt As TextBox
                                'objTxt = CType(Me.FindControl("txtMonto" & i), TextBox)
                                'strMonto = "" : strMonto = Trim(objTxt.Text)

                                strMonto = ApptxtMonto1

                                'Dim objCbo As DropDownList
                                'objCbo = CType(Me.FindControl("cboTipDocumento" & i), DropDownList)
                                'strTipoDocPago = "" : strTipoDocPago = Trim(objCbo.SelectedValue)

                                strTipoDocPago = AppCboTipoDocumento

                                cboTipDocumento = strTipoDocPago
                                txtMonto = Double.Parse(strMonto)
                                'PROY-27440 FIN
                                cboDescTipDocumento = DevuelteTipoDescPago(cboTipDocumento)
                                'INI PROY 30166 
                                If (HidNroCuotas > 0 And dblMontoCuotaInicial = 0) Then
                                    txtMonto = Funciones.CheckDbl(txtNeto)
                                End If
                                'JCC INI
                                If (HidNroCuotas > 0 And dblMontoCuotaInicial > 0) Then
                                    strMonto = dblMontoCuotaInicial
                                    txtMonto = Double.Parse(strMonto)
                                End If
                                'JCC FIN'
                                'FIN PROY 30166 
                                cboDescTipDocumento = IIf(dblMontoCuotaInicial <= 0, cboDescTipDocumento, String.Format("{0}{1}", cboDescTipDocumento, "|")) 'PROY-30166 - IDEA  38934  INICIO

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " K_PAGON_IDPAGO : " & K_PAGON_IDPAGO)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " cboTipDocumento : " & cboTipDocumento)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " cboDescTipDocumento : " & cboDescTipDocumento)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " txtMonto : " & txtMonto)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " Session(USUARIO) : " & AppUsuario)


                                objTrsMsSap.RegistrarDetallePago(K_PAGON_IDPAGO, cboTipDocumento, _
                                                                    cboDescTipDocumento, _
                                                                    System.Configuration.ConfigurationSettings.AppSettings("MONEDA"), _
                                                                    txtMonto, _
                                                                    AppUsuario, _
                                                                    DBNull.Value, AppUsuario, _
                                                                    DBNull.Value, _
                                                                    IIf(arrayListaReferencia(i) = "", "", Funciones.CheckStr(arrayListaReferencia(i))), _
                                                                    arrayListaRefPedido(i), _
                                                                    K_NROLOG_DET, K_DESLOG_DET)

                                'PROY-30166 - IDEA  38934  INICIO GPRD
                                dTotPagoNoCuota = dTotPagoNoCuota + Double.Parse(strMonto)
                                If (i = hidNumFilas AndAlso dblMontoCuotaInicial > 0) Then
                                    txtMonto = Double.Parse(hidTotalSinInicial) - dTotPagoNoCuota ' PROY-30166 GPRD
                                    cboDescTipDocumento = DevuelteTipoDescPago(cboTipDocumento)

                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Adic X Cuotas K_PAGON_IDPAGO : " & K_PAGON_IDPAGO)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Adic X Cuotas cboTipDocumento : " & cboTipDocumento)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Adic X Cuotas cboDescTipDocumento : " & cboDescTipDocumento)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Adic X Cuotas txtMonto : " & txtMonto)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Adic X Cuotas Session(USUARIO) : " & AppUsuario)


                                    objTrsMsSap.RegistrarDetallePago(K_PAGON_IDPAGO, cboTipDocumento, _
                                                                        cboDescTipDocumento, _
                                                                        System.Configuration.ConfigurationSettings.AppSettings("MONEDA"), _
                                                                        txtMonto, _
                                                                        AppUsuario, _
                                                                        DBNull.Value, AppUsuario, _
                                                                        DBNull.Value, _
                                                                        IIf(arrayListaReferencia(i) = "", "", Funciones.CheckStr(arrayListaReferencia(i))), _
                                                                        arrayListaRefPedido(i), _
                                                                        K_NROLOG_DET, K_DESLOG_DET)
                                End If
                                'PROY-30166 - IDEA  38934  FIN
                            Next
                        Else
                            '** Registro del detalle de pago de la Nota de Crèdito/ TG  **
                            cboDescTipDocumento = DevuelteTipoDescPago(AppCboTipoDocumento)
                            objTrsMsSap.RegistrarDetallePago(K_PAGON_IDPAGO, AppCboTipoDocumento, _
                                                              cboDescTipDocumento, _
                                                             System.Configuration.ConfigurationSettings.AppSettings("MONEDA"), _
                                                             Funciones.CheckDbl(ApptxtMonto1), _
                                                             AppUsuario, _
                                                             DBNull.Value, AppUsuario, _
                                                             DBNull.Value, _
                                                             "", 0, _
                                                             K_NROLOG_DET, K_DESLOG_DET)
                        End If

                        '************************************************************************

                        Dim FE_NRO_ERROR As Int16 = 0
                        Dim FE_DES_ERROR As String = ""
                        Dim K_PAGOV_RECUP_CORRELATIVO As String = ""
                        Dim flag_paperless As String = ""
                        Dim correlativo_recu As String = ""
                        Dim K_CORRC_TIPODOC_REFERENCIA As String = ""
                        Dim Origen As String = "3" 'Valor para validar que sea SICAR 6.0


                        If K_DESLOG_DET = "OK" Then
                            'INC000000961273 - INI
                            Dim arrayLineas As String
                            Dim blnOk As Boolean = False
                            'INC000000961273 - FIN
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Registro de forma correcta del detalle del pago :" & K_DESLOG_DET & " - " & K_PAGON_IDPAGO)
                            Try

                                '=================================================================================================================================================================================================================='
                                'CORRELATIVO Y ACTUALIZACIÒN DEL PAGO PEDIDO'
                                '=================================================================================================================================================================================================================='

                                K_NROLOG = ""
                                K_DESLOG = ""

                                '***************************Inicio Validacion de que no consulte correlativo para Renta Adelantada************************************
                                If Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")) <> ConfigurationSettings.AppSettings("TIPO_RENTA_ADELANTADA") Then
                                    '**Proceso de Obtener Correlativo y Envio a Paperless y actualizar en Sicar_trs_pagos.

                                    '**Verificar si el pedido tiene correlativo generado:**
                                    '*Ini:
                                    '**DESARROLLO
                                    Dim dsConsultaDoc As DataSet
                                    Dim arrValor As String()

                                    'Dim strCuentaRedCajero As String

                                    dsConsultaDoc = objCajas.ConsultaDocPagos(drPagos.Item("PEDIN_NROPEDIDO"), Origen) ' JRM - MAP 03
                                    If dsConsultaDoc.Tables.Count > 0 AndAlso dsConsultaDoc.Tables(0).Rows.Count > 0 Then
                                        flag_paperless = Funciones.CheckStr(dsConsultaDoc.Tables(0).Rows(0).Item("FLAG_PAPERLESS"))
                                        correlativo_recu = Funciones.CheckStr(dsConsultaDoc.Tables(0).Rows(0).Item("REFERENCIA"))

                                        If Not correlativo_recu.Equals("") Then
                                            arrValor = correlativo_recu.Trim.ToString.Split("|")
                                            If arrValor(1).ToString <> "" Then
                                                K_PAGOV_RECUP_CORRELATIVO = arrValor(1)
                                            End If
                                        Else
                                            K_PAGOV_RECUP_CORRELATIVO = ""
                                        End If

                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Reutilizar el Correlativo ")
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "flag_paperless : " & flag_paperless)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "correlativo_recu : " & correlativo_recu)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "K_PAGOV_RECUP_CORRELATIVO : " & K_PAGOV_RECUP_CORRELATIVO)
                                    End If

                                    '*Fin:
                                    '*******************************************************

                                    If K_PAGOV_RECUP_CORRELATIVO <> "" Then
                                        K_CU_CORRELATIVOFE = K_PAGOV_RECUP_CORRELATIVO
                                    Else
                                        '++ IDG: ++++++++++++++++++++++++++++++++++!
                                        '** consulta del correlativo ***'
                                        'objTrsMsSap.CalculoCorrelativoSUNAT(dsPedido.Tables(0).Rows(0).Item("OFICV_CODOFICINA"), Microsoft.VisualBasic.Right(Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")).ToString, 2), Funciones.CheckInt64(drPagos.Item("PEDIN_NROPEDIDO")), K_PAGOV_CORRELATIVO)
                                        'Dim K_CORRC_TIPODOC_REFERENCIA As String = ""
                                        'Dim consultaDato As DataSet
                                        If Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")) = ConfigurationSettings.AppSettings("strTipDoc") Then
                                            If Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("CLIEC_TIPODOCCLIENTE")).Trim = ConfigurationSettings.AppSettings("tipo_Docu_RUC") Then
                                                K_CORRC_TIPODOC_REFERENCIA = "01"
                                            Else
                                                K_CORRC_TIPODOC_REFERENCIA = "03"
                                            End If
                                            'K_CORRC_TIPODOC_REFERENCIA = Microsoft.VisualBasic.Right(Funciones.CheckStr(consultaDato.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")), 2)
                                        End If

                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Mètodo => CalculoCorrelativoSUNAT")
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Cod_Oficina : " & Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("OFICV_CODOFICINA")))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo_Documento : " & Microsoft.VisualBasic.Right(Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")).ToString, 2))
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo_Documento_Origen : " & K_CORRC_TIPODOC_REFERENCIA)

                                        objTrsMsSap.CalculoCorrelativoFE(dsPedido.Tables(0).Rows(0).Item("OFICV_CODOFICINA"), _
                                                                            Microsoft.VisualBasic.Right(Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")).ToString, 2), _
                                                                            K_CORRC_TIPODOC_REFERENCIA, FE_NRO_ERROR, FE_DES_ERROR, K_CU_CORRELATIVOFE) 'JRM - MAP 04

                                        'INI PROY-140126
                                        Dim MaptPath As String
                                        MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                                        MaptPath = "( Class : " & MaptPath & "; Function: guardarConectado)"
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out FE_NRO_ERROR  : " & FE_NRO_ERROR & MaptPath)
                                        MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                                        MaptPath = "( Class : " & MaptPath & "; Function: guardarConectado)"
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out FE_DES_ERROR  : " & FE_DES_ERROR & MaptPath)
                                        'FIN PROY-140126

                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Out K_CU_CORRELATIVOFE  : " & K_CU_CORRELATIVOFE)
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Mètodo => CalculoCorrelativoSUNAT")
                                        '++ FDG ++++++++++++++++++++++++++++++++++++++!
                                    End If
                                End If
                                '***************************Fin Validacion de que no consulte correlativo para Renta Adelantada************************************

                                If K_CU_CORRELATIVOFE <> "" Then
                                    Var_Corr1 = Obtener_serie_correlativo(K_CU_CORRELATIVOFE, "1", Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")))
                                    Var_Corr2 = Obtener_serie_correlativo(K_CU_CORRELATIVOFE, "2", Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")))
                                    Var_Corr3 = ""
                                    Var_Corr4 = Obtener_serie_correlativo(K_CU_CORRELATIVOFE, "4", Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")))
                                    Var_Corr5 = ""
                                    Var_Corr6 = Obtener_serie_correlativo(K_CU_CORRELATIVOFE, "6", Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")))

                                    If Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")) = ConfigurationSettings.AppSettings("PEDIC_CLASEFACTURA") Then
                                        P_tipo_doc_pago = ConfigurationSettings.AppSettings("PEDIC_DESCCLASEFACTURA")
                                    End If
                                    If Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")) = ConfigurationSettings.AppSettings("PEDIC_CLASEBOLETA") Then
                                        P_tipo_doc_pago = ConfigurationSettings.AppSettings("PEDIC_DESCCLASEBOLETA")
                                    End If
                                    '***************************Inicio Validacion de que no consulte correlativo para Renta Adelantada************************************
                                    If Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")) <> ConfigurationSettings.AppSettings("TIPO_RENTA_ADELANTADA") Then
                                        If K_PAGOV_RECUP_CORRELATIVO = "" Then
                                            '***Grabar el correlativo el correlativo Nuevo en SICAR_TRS_PAGOS**
                                            'Dim Origen As String = "3" 'Valor para validar que sea SICAR 6.0
                                            Dim corrCompleto As String = ""
                                            Dim updCorrCompleto As String = ""

                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Registro de datos del pago de la Boleta o Factura (SP_SET_CORRELATIVO_BF)")
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Numero de DocSap            :" & drPagos.Item("PEDIN_NROPEDIDO"))
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Tipo de Documento           :" & Microsoft.VisualBasic.Right(Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")), 2))
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Serie Sunat                 :" & Var_Corr1)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Correlativo Sunat           :" & Var_Corr2)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Código de Usuario           :" & CurrentUser.ToString)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Origen                      :" & Origen)
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "    Inp Punto de Venta              :" & AppAlmacen)

                                            Dim resultado As String = objTrsMsSap.FP_Grabar_PagoBF(drPagos.Item("PEDIN_NROPEDIDO"), _
                                                                                    Microsoft.VisualBasic.Right(Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")), 2), _
                                                                                Var_Corr1, _
                                                                                Var_Corr2, _
                                                                                    CurrentUser.ToString, _
                                                                                    Origen, _
                                                                                    AppAlmacen) 'JRM - MAP 05
                                            If resultado = "" Then
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     Out Resultado           :" & "No se ha Grabado los Datos del Pago.")
                                            Else
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     Out Resultado         :" & "Registro de Datos del pago Exitoso.")
                                                If (Microsoft.VisualBasic.Right(Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")), 2) = "01" Or Microsoft.VisualBasic.Right(Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")), 2) = "03") Then
                                                    corrCompleto = "00" & "|" & K_CU_CORRELATIVOFE
                                                Else
                                                    corrCompleto = K_CORRC_TIPODOC_REFERENCIA & "|" & K_CU_CORRELATIVOFE
                                                End If
                                                updCorrCompleto = objCajas.SP_UPD_FLAG_PAPER(drPagos.Item("PEDIN_NROPEDIDO"), "V", corrCompleto) ' JRM - MAP 13
                                            End If
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin del Registro de datos de la Boleta o Factura.")
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "*****************************************************************")
                                            '***********************************************'
                                        End If
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Correlativo Utilizado :" & K_CU_CORRELATIVOFE)
                                    End If
                                    '***************************Fin Validacion de que no consulte correlativo para Renta Adelantada************************************
                                    K_NROLOG = ""
                                    K_DESLOG = ""

                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inicia actualizar pago: ActualizarPagodelPedido")
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "SP: " & "PKG_MSSAP.SSAPSU_UPDATEPAGO")
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ID de Pedido : " & Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")))
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ID de Pago : " & Funciones.CheckStr(K_PAGON_IDPAGO))
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "CORRELATIVO : " & Funciones.CheckStr(K_CU_CORRELATIVOFE))
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "PEDIC_CLASEFACTURA :" & Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")))
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "CODIGO DE OFICINA : " & Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("OFICV_CODOFICINA")))

                                    'PEDIC_CLASEFACTURA
                                    objTrsMsSap.ActualizarPagodelPedido(drPagos.Item("PEDIN_NROPEDIDO"), _
                                                                                        K_PAGON_IDPAGO, _
                                                                                        K_CU_CORRELATIVOFE, _
                                                                                        dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA"), _
                                                                                        dsPedido.Tables(0).Rows(0).Item("OFICV_CODOFICINA"), _
                                                                                        K_NROLOG, K_DESLOG) ' JRM - MAP 06

                                    If (K_DESLOG = "OK") Then
                                        hidDESLOG = K_DESLOG
                                        AppActualizarMSSAP = "0"
                                    Else
                                        AppActualizarMSSAP = "1"
                                        hidDESLOG = ""
                                    End If
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " OUT K_DESLOG :" & K_DESLOG)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " OUT K_NROLOG :" & K_NROLOG)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Fin actualizar pago: ActualizarPagodelPedido")
                                Else
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  ERROR EN EL Correlativo :" & K_CU_CORRELATIVOFE)
                                    '** RollBack a los Pagos ************************'

                                    objActiv.AsignarPagoAcuerdosXDocSap(drPagos.Item("PEDIN_NROPEDIDO"), "", 0, CurrentUser, msgj)
                                    DeshacerCambiosPagos(K_PAGON_IDPAGO)
                                    If AppCodigoDeshacerCambios = "-3" Then
                                        AppCodigoExitFunction = "-2"
                                        AppMensajeExitFunction = AppMensajeDeshacerCambios
                                        Exit Function
                                    End If
                                    'Response.Write("<script>alert('No tiene configurado correlativo para el punto de venta : ' & '" & dsPedido.Tables(0).Rows(0).Item("OFICV_CODOFICINA") & "')</script>")
                                    AppErrorDeshacerCambios = "No tiene configurado correlativo para el punto de venta : ' & '" & dsPedido.Tables(0).Rows(0).Item("OFICV_CODOFICINA") & ""
                                    Exit Function
                                    '*************************************************'
                                End If

                                ' ' INICIO|PROY-30162-IDEA-32487 ENVIO BOLETA ELECTRONICA PREPAGO //RGP_BOL_18
                                ' ' Envio de SMS
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "sTipoVenta: " & sTipoVenta)
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "strTVPrepago: " & ConfigurationSettings.AppSettings("strTVPrepago"))
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "sTipoOperacion: " & sTipoOperacion)
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "COD_OPERACION_ALTAyPORTABILIDAD: " & ConfigurationSettings.AppSettings("COD_OPERACION_ALTAyPORTABILIDAD"))
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "sTipoVenta: " & sTipoVenta)
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "strTVPostpago: " & ConfigurationSettings.AppSettings("strTVPostpago"))
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "SmsWS_horas_prepago: " & ConfigurationSettings.AppSettings("SmsWS_horas_prepago"))
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "SmsWS_horas_postpago: " & ConfigurationSettings.AppSettings("SmsWS_horas_postpago"))
                                ' Dim fechaEnvio As DateTime = DateTime.Now ' PROY-30162-IDEA-32487
                                ' Try
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " VerificaciÃ³n de Envio de SMS")

                                ' Dim procesarSMS As Boolean = False
                                ' Dim horasAdicionar As Int32 = 0

                                ' If sTipoVenta = ConfigurationSettings.AppSettings("strTVPrepago") Then
                                ' procesarSMS = True
                                ' horasAdicionar = CInt(ConfigurationSettings.AppSettings("SmsWS_horas_prepago"))

                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Pre-Pago " & CStr(horasAdicionar))
                                ' ElseIf sTipoVenta = ConfigurationSettings.AppSettings("strTVPostpago") Then
                                ' procesarSMS = True
                                ' horasAdicionar = CInt(ConfigurationSettings.AppSettings("SmsWS_horas_postpago"))

                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Post-Pago " & CStr(horasAdicionar))
                                ' End If

                                ' If procesarSMS = True Then
                                ' Dim smsMensaje As String = "Estimado usuario, se genera comprobante """ + K_CU_CORRELATIVOFE + """ que puede visualizar en http://www.claro.com.pe/comprobantes-electronicos/" 'URL en SMS modificada a solicitud de Claro.
                                ' Dim usuarioAplicacion = CStr(AppUsuario)
                                ' fechaEnvio = fechaEnvio.AddHours(horasAdicionar)

                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inicio Envio SMS ")
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Envio Parametros - Metodo EnviarSMS()")
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Usuario Aplicacion - " & usuarioAplicacion)
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Numero Telefono - " & CStr(hidNumeroTelefono))
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Mensaje SMS - " & smsMensaje)
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Fecha Envio - " & fechaEnvio)
                                ' Dim smsENVIADO = EnviarSMS(usuarioAplicacion, CStr(hidNumeroTelefono), smsMensaje, fechaEnvio)
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Resultado Exitoso ")
                                ' End If
                                ' Catch ex As Exception
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Error de Envio de SMS " & ex.Message)
                                ' End Try
                                ' ' FIN|PROY-30162-IDEA-32487 ENVIO BOLETA ELECTRONICA PREPAGO //RGP_BOL_18

                                ' 'PROY-31867 INI
                                ' '********************************CAMBIO DE MIGRACION ENVIO EMAIL ***************************'

                                ' Dim dsAcuerdoMigra As DataSet

                                ' Dim strContratoMigra As String
                                ' Dim sisact_Cod_OperacionMigra As String


                                ' Try
                                ' strContratoMigra = objContrato.Tables(0).Rows(0).Item("ID_CONTRATO") 'drPagos.Item("NRO_CONTRATO")
                                ' Catch ex As Exception
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "objContrato.Tables(0).Rows(0).Item(ID_CONTRATO)" & ex.Message)
                                ' End Try

                                ' Try

                                ' dsAcuerdoMigra = objClsConsultaPvu.ConsultaAcuerdoPCS(Funciones.CheckInt64(strContratoMigra), DBNull.Value)    'Consulta PVU
                                ' If Not dsAcuerdoMigra Is Nothing Then

                                ' sisact_Cod_OperacionMigra = Funciones.CheckStr(dsAcuerdoMigra.Tables(0).Rows(0).Item("contc_tipo_operacion"))

                                ' End If
                                ' Catch ex As Exception
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error al tratar de recuperar el contrato" & ex.Message)

                                ' End Try


                                ' ''if EsMigracion == true && EsVentaSinEquipo == true then
                                ' If sisact_Cod_OperacionMigra = ConfigurationSettings.AppSettings("strDTVMigracion") And Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("MATEC_TIPOMATERIAL")) = ConfigurationSettings.AppSettings("constPacks") Then


                                ' 'Consulta Email Cliente
                                ' Dim objConsultaPvuMigra As New clsConsultaPvu
                                ' Dim dsClienteDatosMigra As New DataSet
                                ' Dim strCodRptaMigra, strMsjRptaMigra As String
                                ' Dim strEmailMigra As String
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--INICIO Consulta Cliente Email --")
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo Documento : " & Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("CLIEC_TIPODOCCLIENTE")))
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Numero Documento : " & Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("CLIEV_NRODOCCLIENTE")))

                                ' dsClienteDatosMigra = objConsultaPvuMigra.ConsultaCorreoCliente(Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("CLIEC_TIPODOCCLIENTE")), Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("CLIEV_NRODOCCLIENTE")), strCodRptaMigra, strMsjRptaMigra)
                                ' If Not dsClienteDatosMigra Is Nothing Then
                                ' If dsClienteDatosMigra.Tables(0).Rows.Count > 0 Then
                                ' strEmailMigra = Funciones.CheckStr(dsClienteDatosMigra.Tables(0).Rows(0).Item("CLIEV_CORREO_FACT"))
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Email  : " & strEmailMigra)
                                ' End If
                                ' End If
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Codigo Respuesta : " & strCodRptaMigra)
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje Respuesta : " & strMsjRptaMigra)

                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--FIN Consulta Cliente Email --")



                                ' Dim objResponseDoc As New COM_SIC_Activaciones.BEResponseDocumentosGenerados
                                ' Dim objTransaccionDocumentosMigra As New COM_SIC_Activaciones.BWDocumentosGenerados
                                ' Dim BeDocumentosMigra As New COM_SIC_Activaciones.BEDocumentosGenerados
                                ' Dim itemHeaderDataPower As New COM_SIC_Activaciones.BEHeaderDataPower


                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " EjecutarTranssaccionGeneracionDocumento Migra - Inicio WS")
                                ' itemHeaderDataPower.consumer = ""
                                ' itemHeaderDataPower.country = ""
                                ' itemHeaderDataPower.dispositivo = ""
                                ' itemHeaderDataPower.language = ""
                                ' itemHeaderDataPower.modulo = ""
                                ' itemHeaderDataPower.msgType = ""
                                ' itemHeaderDataPower.operation = ""
                                ' itemHeaderDataPower.pid = ""
                                ' itemHeaderDataPower.userId = ""
                                ' itemHeaderDataPower.wsIp = ConfigurationSettings.AppSettings("consIpTranssaccionGeneracionDocumento")

                                ' Dim strUsuario As String = ""
                                ' Dim strPassword As String = ""

                                ' 'INC000001492087: INI
                                ' Try
                                ' Dim strIDTrans_ As String = String.Empty
                                ' Dim strIpAplicacion_ As String = String.Empty
                                ' Dim strAplicacion_ As String = String.Empty
                                ' strIDTrans_ = Now.Year & Now.Month & Now.Day & Now.Hour & Now.Minute & Now.Second
                                ' strAplicacion_ = ConfigurationSettings.AppSettings("constAplicacion")
                                ' strIpAplicacion_ = AppLOCAL_ADDR
                                ' Dim sAuditoriastring_ As New AuditoriaEWS
                                ' sAuditoriastring_.IDTRANSACCION = strIDTrans_
                                ' sAuditoriastring_.IPAPLICACION = strIpAplicacion_
                                ' sAuditoriastring_.APLICACION = strAplicacion_
                                ' sAuditoriastring_.USRAPP = CurrentUser

                                ' Dim objClave As ConsultaClavesNegocio = New ConsultaClavesNegocio
                                ' Dim mensajeError As String = ""

                                ' Dim codAplicacionClave As String = ConfigurationSettings.AppSettings("strAplicacionSISACT")
                                ' Dim usuarioEncrypt As String = ConfigurationSettings.AppSettings("consUserDataPowerDocumentos")
                                ' Dim claveEncrypt As String = ConfigurationSettings.AppSettings("consPASWDataPowerDocumentos")
                                ' Dim usuarioDesencrypt As String = String.Empty
                                ' Dim claveDesencrypt As String = String.Empty

                                ' objClave.ejecutarConsultaClave(sAuditoriastring_, codAplicacionClave, usuarioEncrypt, claveEncrypt, usuarioDesencrypt, claveDesencrypt, mensajeError)

                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ejecutarConsultaClave Mensaje ws :" & mensajeError)

                                ' strUsuario = usuarioDesencrypt
                                ' strPassword = claveDesencrypt

                                ' Catch ex As Exception
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ejecutarConsultaClave Exception :" & ex.Message)
                                ' End Try
                                ' 'INC000001492087: FIN

                                ' Dim ipAplicacion As String = CurrentTerminal

                                ' BeDocumentosMigra.idTransaccion = DateTime.Now.ToString("yyyyMMddHHmmssfff")
                                ' BeDocumentosMigra.ipAplicacion = "SICAR"
                                ' BeDocumentosMigra.nombreAplicacion = "SICAR"
                                ' BeDocumentosMigra.idVenta = ""
                                ' BeDocumentosMigra.nroContrato = Funciones.CheckStr(objContrato.Tables(0).Rows(0).Item("ID_CONTRATO"))
                                ' BeDocumentosMigra.nroDocumento = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("CLIEV_NRODOCCLIENTE"))
                                ' BeDocumentosMigra.nroPedido = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIN_NROPEDIDO"))
                                ' BeDocumentosMigra.tipoDocumento = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("CLIEC_TIPODOCCLIENTE"))
                                ' BeDocumentosMigra.tipoOperacion = "02"
                                ' BeDocumentosMigra.usuarioAplicacion = CurrentUser.ToString
                                ' BeDocumentosMigra.correo = ""

                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, BeDocumentosMigra.idTransaccion & "- " & BeDocumentosMigra.idTransaccion)
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, BeDocumentosMigra.idTransaccion & "- nroContrato : " & BeDocumentosMigra.nroContrato)
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, BeDocumentosMigra.idTransaccion & "- nroDocumento : " & BeDocumentosMigra.nroDocumento)
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, BeDocumentosMigra.idTransaccion & "- nroPedido : " & BeDocumentosMigra.nroPedido)
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, BeDocumentosMigra.idTransaccion & "- tipoDocumento : " & BeDocumentosMigra.tipoDocumento)
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, BeDocumentosMigra.idTransaccion & "- tipoOperacion : " & BeDocumentosMigra.tipoOperacion)
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, BeDocumentosMigra.idTransaccion & "- usuarioAplicacion : " & BeDocumentosMigra.usuarioAplicacion)

                                ' objResponseDoc = objTransaccionDocumentosMigra.EjecutarTranssaccionGeneracionDocumento("CAC", CurrentUser, BeDocumentosMigra, itemHeaderDataPower, strUsuario, strPassword, "SICAR")



                                ' Dim k_estado As String = objResponseDoc.K_estado
                                ' Dim k_codigo_respuesta As String = objResponseDoc.k_codigo_respuesta
                                ' Dim k_descripcion As String = objResponseDoc.k_descripcion
                                ' Dim k_ubicacionError As String = objResponseDoc.k_ubicacionError
                                ' Dim k_fecha As String = objResponseDoc.k_fecha
                                ' Dim k_origen As String = objResponseDoc.k_origen

                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", strIdentifyLog, "k_estado", Funciones.CheckStr(k_estado)))
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", strIdentifyLog, "k_codigo_respuesta", Funciones.CheckStr(k_codigo_respuesta)))
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", strIdentifyLog, "k_descripcion", Funciones.CheckStr(k_descripcion)))
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", strIdentifyLog, "k_ubicacionError", Funciones.CheckStr(k_ubicacionError)))
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", strIdentifyLog, "k_fecha", Funciones.CheckStr(k_fecha)))
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - {1} : {2}", strIdentifyLog, "k_origen", Funciones.CheckStr(k_origen)))


                                ' If objResponseDoc.k_codigo_respuesta <> "0" Then

                                ' End If

                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " EjecutarTranssaccionGeneracionDocumento Migra - FIN WS")

                                ' End If


                                ' '********************************CAMBIO DE MIGRACION ENVIO EMAIL ***************************'
                                ' 'PROY-31867 FIN

                                ' 'PROY-24274 - IIteracion 3 - INICIO
                                ' Dim strCodRptaAjuste As String = String.Empty
                                ' Dim strMsjRptaAjuste As String = String.Empty
                                ' Dim strRptaAjuste As String = String.Empty
                                ' Dim strPedidoEquipo As String = String.Empty
                                ' Dim strCodRpt As String = String.Empty
                                ' Dim strMsjRpt As String = String.Empty
                                ' Dim objProteccionMovilAjuste As New COM_SIC_Activaciones.clsProteccionMovil
                                ' Dim objAjustePedidoAsurionWS As New COM_SIC_Activaciones.BWAjustePedidoProteccionMovil
                                ' Dim strIdTransaccion As String = String.Empty
                                ' Dim strIPAplicacion As String = String.Empty
                                ' Dim strNombaplicacion As String = String.Empty
                                ' Dim strUsrProceso As String = String.Empty
                                ' Dim strCodMat As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEC_CODMATERIAL")) 'PROY-24724 - Iteracion 2 Siniestros

                                ' strIdTransaccion = DateTime.Now.ToString("yyyyMMddHHmmssfff")
                                ' strIPAplicacion = CurrentTerminal
                                ' strNombaplicacion = ConfigurationSettings.AppSettings("constAplicacion")
                                ' strUsrProceso = CurrentUser
                                ' Try

                                ' 'PROY-24724 - Iteracion 2 Siniestros -INI
                                ' If (strCodMat.Equals(clsKeyAPP.strCodMaterialSiniestro)) Then
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " INICIO Ajuste de Pedido Siniestro")
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " WS: " & ConfigurationSettings.AppSettings("consAjusteProteccionMovilWS_URL"))
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Método WS: ajustarPedido ")
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " SP: " & "PKG_VENTA.SSAPSU_CALC_IGV")
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " ID de Pedido : " & Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")))
                                ' objAjustePedidoAsurionWS.AjustarPedido(Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")), strIdTransaccion, strIPAplicacion, strNombaplicacion, strUsrProceso, strCodRptaAjuste, strMsjRptaAjuste)
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " OUT K_COD_RESULTADO :" & strCodRptaAjuste)
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " OUT K_MSJ_RESULTADO :" & strMsjRptaAjuste)
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " FIN Ajuste de Pedido Siniestro")
                                ' End If
                                ' 'PROY-24724 - Iteracion 2 Siniestros -FIN
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " Inicio - Validar Equipo Protección Móvil")
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " Validar Equipo Protección Móvil. Parámetros de entrada:")
                                ' 'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " NroPedido:" & Trim(Request.QueryString("codRefer")))
                                ' objProteccionMovilAjuste.ValidaPagoEquipoProteccionMovil(Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")), strPedidoEquipo, strCodRpt, strMsjRpt)
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " Validar Equipo Protección Móvil. Parámetros de salida:")
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " strNroPedidoEquipo:" & strPedidoEquipo)
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " strCodRpta:" & strCodRpt)
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " strMsgRpta:" & strMsjRpt)
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " Fin - Validar Equipo Protección Móvil")
                                ' If (strCodRpt.Equals("0") Or strCodRpt.Equals("-1")) AndAlso Not Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")).Equals("") Then
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inicia Ajuste Pedido Protección Móvil: AjustePedidoProteccionMovil")
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " WS: " & ConfigurationSettings.AppSettings("consAjusteProteccionMovilWS_URL"))
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Método WS: ajustarPedido ")
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " SP: " & "PKG_VENTA.SSAPSU_CALC_IGV")
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " ID de Pedido : " & Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")))
                                ' objAjustePedidoAsurionWS.AjustarPedido(Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")), strIdTransaccion, strIPAplicacion, strNombaplicacion, strUsrProceso, strCodRptaAjuste, strMsjRptaAjuste)
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " OUT K_COD_RESULTADO :" & strCodRptaAjuste)
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " OUT K_MSJ_RESULTADO :" & strMsjRptaAjuste)
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Fin Ajuste Pedido Protección Móvil: AjustePedidoProteccionMovil")
                                ' End If

                                ' Catch ex As Exception
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  -- Error Ejecución Ajuste Proteccion Movil")
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  -- Error :" & ex.Message.ToString())
                                ' End Try
                                ' 'PROY-24724 - IIteracion 3 - FIN

                                ' 'INC000000961273 - INICIO
                                ' Dim flagActivaSimcard As String = ConfigurationSettings.AppSettings("constActivaSimcardsWS")
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " flagActivaSimcard: " & flagActivaSimcard)
                                ' If flagActivaSimcard.Equals("0") Then
                                ' If K_DESLOG = "OK" Then
                                ' Dim descOpePortaPost As String = ConfigurationSettings.AppSettings("DESCTIPOOPERACION_PORTA_POST")
                                ' Dim descOpePortaPre As String = ConfigurationSettings.AppSettings("DESCTIPOOPERACION_PORTA_PRE")
                                ' If dsPedido.Tables(0).Rows(0).Item("PEDIV_DESCTIPOOPERACION") = descOpePortaPost Then
                                ' Dim codigoRed As String
                                ' Dim tipoNumero As String = ConfigurationSettings.AppSettings("portaSap_tipoNumero")
                                ' Dim mensajeCrear As String
                                ' Dim strOpCedenteCod As String
                                ' Dim auxLinea As String = ""

                                ' If sTipoVenta = ConfigurationSettings.AppSettings("strTVPrepago") Then
                                ' codigoRed = ConfigurationSettings.AppSettings("codOperadorRedPre")
                                ' strNroSEC = C_VENTA.Rows(0).Item("VEPR_SEC_PORT")
                                ' Else
                                ' codigoRed = ConfigurationSettings.AppSettings("codOperadorRedPost")
                                ' If Not objContrato Is Nothing Then
                                ' strContrato = objContrato.Tables(0).Rows(0).Item("ID_CONTRATO")
                                ' If Funciones.CheckInt(strContrato) > 0 Then
                                ' dsAcuerdo = objClsConsultaPvu.ConsultaAcuerdoPCS(strContrato, DBNull.Value)
                                ' End If
                                ' End If

                                ' strNroSEC = Funciones.CheckStr(dsAcuerdo.Tables(0).Rows(0).Item("contn_numero_sec"))
                                ' End If

                                ' strOpCedenteCod = ObtenerOpeCedente(strNroSEC).Rows(0).Item("SOPOC_CODIGO_CEDENTE")

                                ' For i = 0 To dsPedido.Tables(1).Rows.Count - 1
                                ' Dim serieIccid As String = dsPedido.Tables(1).Rows(i).Item("SERIC_CODSERIE")
                                ' Dim codMaterial As String = dsPedido.Tables(1).Rows(i).Item("DEPEC_CODMATERIAL")
                                ' Dim nroTelefono As String = dsPedido.Tables(1).Rows(i).Item("DEPEV_NROTELEFONO")
                                ' Dim hr As String = serieIccid.Substring(6, 2)
                                ' Dim region As String = ObtenerRegion(hr)

                                ' If dsPedido.Tables(1).Rows(i).Item("MATEC_TIPOMATERIAL") = ConfigurationSettings.AppSettings("constChips") Then
                                ' If Not CrearNumeroPortabilidad(codigoRed, strOpCedenteCod, nroTelefono, region, serieIccid, _
                                ' tipoNumero, mensajeCrear, codMaterial) Then
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  # Resultado: ERROR")
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  # Mensaje: " & mensajeCrear)
                                ' blnOk = False
                                ' Else
                                ' arrayLineas = arrayLineas + nroTelefono + ";"
                                ' blnOk = True
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  # Resultado: OK")
                                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  # Mensaje: " & mensajeCrear)
                                ' End If

                                ' If Not blnOk Then
                                ' BorrarNumerosPortabilidad(strIdentifyLog, arrayLineas)
                                ' Throw New Exception(mensajeCrear)
                                ' End If
                                ' End If

                                ' Next
                                ' End If
                                ' End If
                                ' End If
                                ' 'INC000000961273 - FIN



                                If K_DESLOG = "OK" Then
                                    blnPagoRealizado = True

                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  SE ACTUALIZORN LOS PAGOS :" & K_PAGON_IDPAGO)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  K_DESLOG :" & K_DESLOG)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  K_NROLOG :" & K_NROLOG)
                                    ' ActualizarWL() 'JRM - COMENTADO
                                    '***********************************Inicio de Metodo para Envio a Paperless*****************************************
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inicio Factura Electronica ")
                                    '·····························································································

                                    If flag_paperless = "" Then
                                        Paperless(K_CU_CORRELATIVOFE, drPagos.Item("PEDIN_NROPEDIDO"), K_PAGON_IDPAGO, Origen) 'JRM - MAP 07 - MAP 09 - MAP 10 - MAP 11 - MAP 12
                                    End If
                                    '·····························································································
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Fin Factura Electronica ")
                                    '**

                                    ' If Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")) <> ConfigurationSettings.AppSettings("TIPO_RENTA_ADELANTADA") Then
                                    ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inicio Actualizar metodo AsignarPagoAcuerdosXDocSap")
                                    ' objActiv.AsignarPagoAcuerdosXDocSap(strDocSap, Var_Corr6, CheckDbl(txtNeto.ToString()), CurrentUser, msgj)
                                    ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Fin Actualizar metodo AsignarPagoAcuerdosXDocSap")
                                    ' 'continuara
                                    ' If dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVPrepago") Then

                                    ' Try
                                    ' If Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION")) = ConfigurationSettings.AppSettings("COD_OPERACION_RENOVACION") Or Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION")) = ConfigurationSettings.AppSettings("COD_OPERACION_REPOSICION") Then

                                    ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inicio Actualizar metodo Actualizar_Prepago_RenoYRepo")
                                    ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inp P_documento :" & Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIN_NROPEDIDO")))
                                    ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inp P_tipo_doc_pago :" & P_tipo_doc_pago)
                                    ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inp P_numero_referencia :" & Var_Corr6)
                                    ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inp P_numero_ticket : - ")

                                    ' objPvu.Actualizar_Prepago_RenoYRepo(Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIN_NROPEDIDO")), _
                                    ' P_tipo_doc_pago, _
                                    ' Var_Corr6, _
                                    ' "", _
                                    ' RptaPrepago)

                                    ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Out P_Valor_retorno :" & Funciones.CheckStr(RptaPrepago))
                                    ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Fin Actualizar metodo Actualizar_Prepago_RenoYRepo")
                                    ' End If

                                    ' If Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION")) = ConfigurationSettings.AppSettings("COD_OPERACION_ALTAyPORTABILIDAD") Then

                                    ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inicio Actualizar metodo Actualizar_Prepago_AltaYPorta")
                                    ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inp P_ID :" & Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIN_NROPEDIDO")))
                                    ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inp P_Estado :" & ConfigurationSettings.AppSettings("CONS_ESTADO_PREPAGO_ALTAyPORTABILIDAD"))
                                    ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inp P_Almacen :" & Funciones.CheckStr(AppAlmacen))
                                    ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inp P_tipo_doc_pago :" & P_tipo_doc_pago)
                                    ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inp P_numero_referencia :" & Var_Corr6)
                                    ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inp P_numero_ticket : - ")

                                    ' objPvu.Actualizar_Prepago_AltaYPorta(Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIN_NROPEDIDO")), _
                                    ' ConfigurationSettings.AppSettings("CONS_ESTADO_PREPAGO_ALTAyPORTABILIDAD"), _
                                    ' Funciones.CheckStr(AppAlmacen), _
                                    ' P_tipo_doc_pago, _
                                    ' Var_Corr6, _
                                    ' "", _
                                    ' RptaPrepago)

                                    ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Out P_Valor_retorno :" & Funciones.CheckStr(RptaPrepago))
                                    ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Fin Actualizar metodo Actualizar_Prepago_AltaYPorta")
                                    ' End If
                                    ' Catch ex As Exception
                                    ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  -- Error desPues de Paperless")
                                    ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  -- Error :" & ex.Message.ToString())
                                    ' End Try
                                    ' End If

                                    ' ' PS - Automatización de canje y nota de crédito.
                                    ' ' Verificar si existe reserva de puntos Claro Club para efectuar el canje de puntos
                                    ' ' por soles de decuento.
                                    ' If Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")) <> ConfigurationSettings.AppSettings("strTipDoc") Then
                                    ' Try
                                    ' Dim nroLinea As String = ""
                                    ' If ExisteCanjePuntosClaroClub(drPagos.Item("PEDIN_NROPEDIDO"), strIdentifyLog, nroLinea) Then
                                    ' ' Actualiza WS PuntosCC
                                    ' If drPagos.Item("PEDIC_TIPOVENTA") <> ConfigurationSettings.AppSettings("strTVPrepago") Then
                                    ' nroLinea = ""
                                    ' End If
                                    ' If CanjeDescuentoEquipo(drPagos.Item("PEDIN_NROPEDIDO"), strIdentifyLog, nroLinea) Then
                                    ' ' Actualizar canje puntos SISACT_CANJE_PUNTOS
                                    ' ActualizarCanjePuntos(drPagos.Item("PEDIN_NROPEDIDO"), Var_Corr6, strIdentifyLog)
                                    ' End If
                                    ' End If
                                    ' Catch ex As Exception
                                    ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Error en Canje Claro Club ")
                                    ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  -- Error :" & ex.Message.ToString())
                                    ' End Try
                                    ' End If
                                    ' End If
                                Else
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  ERROR EN LA ACTUALIZACIÒN") 'HERE - 
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  K_DESLOG :" & K_DESLOG)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  K_NROLOG :" & K_NROLOG)
                                    '** RollBack a los Pagos en la Actualizaciòn pagos ************************'
                                    objActiv.AsignarPagoAcuerdosXDocSap(drPagos.Item("PEDIN_NROPEDIDO"), "", 0, CurrentUser, msgj)
                                    '***INICIO CAMBIO ROLLBACK SICAR***'
                                    If K_NROLOG = "-2" Then
                                        AnulaPagoSICAR(drPagos.Item("PEDIN_NROPEDIDO"), Microsoft.VisualBasic.Right(Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")), 2), Var_Corr1, Var_Corr2)
                                    End If
                                    '***FIN CAMBIO ROLLBACK SICAR***'
                                    DeshacerCambiosPagos(K_PAGON_IDPAGO)

                                    If AppCodigoDeshacerCambios = "-3" Then
                                        AppCodigoExitFunction = "-2"
                                        AppMensajeExitFunction = AppMensajeDeshacerCambios
                                        Exit Function
                                    End If
                                    '*************************************************'
                                End If
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Registro de forma correcta el detalle del Pago :" & K_PAGON_IDPAGO)
                                '=================================================================================================================================================================================================================='
                            Catch ex As Exception
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  K_DESLOG :" & K_DESLOG)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  K_NROLOG :" & K_NROLOG)
                                'objActiv.AsignarPagoAcuerdosXDocSap(drPagos.Item("PEDIN_NROPEDIDO"), "", 0, CurrentUser, msgj)
                                DeshacerCambiosPagos(K_PAGON_IDPAGO)
                                If AppCodigoDeshacerCambios = "-3" Then
                                    AppCodigoExitFunction = "-2"
                                    AppMensajeExitFunction = AppMensajeDeshacerCambios
                                    Exit Function
                                End If
                                'Session.Add("msgErrorGenerarSot", "Ocurrio un error al tratar de obtener el Correlativo")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  -- Error :" & ex.Message.ToString())
                                'Response.Redirect("PoolPagos.aspx") ################ VALIDAR APP - SICAR ################
                                AppmsgErrorGenerarSot = "Ocurrio un error al tratar de obtener el Correlativo"
                                AppCodigoExitFunction = "-2"
                                AppMensajeExitFunction = AppmsgErrorGenerarSot
                                Exit Function
                            End Try
                        Else
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  Ocurrio un error al tratar de registrar el detalle del pedido :" & K_PAGON_IDPAGO)
                            '** RollBack a los Pagos ************************'
                            'objActiv.AsignarPagoAcuerdosXDocSap(drPagos.Item("PEDIN_NROPEDIDO"), "", 0, CurrentUser, msgj)
                            DeshacerCambiosPagos(K_PAGON_IDPAGO)
                            If AppCodigoDeshacerCambios = "-3" Then
                                AppCodigoExitFunction = "-2"
                                AppMensajeExitFunction = AppMensajeDeshacerCambios
                                Exit Function
                            End If
                            '*************************************************'
                        End If
                        'Session.Add("msgErrorGenerarSot", "Registro de Pago Correctamente")
                    Else
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  No registro de forma correcta el Pago :" & K_PAGON_IDPAGO)
                        '** RollBack al registro del pago ************************'
                        objActiv.AsignarPagoAcuerdosXDocSap(drPagos.Item("PEDIN_NROPEDIDO"), "", 0, CurrentUser, msgj)
                        DeshacerCambiosPagos(K_PAGON_IDPAGO)
                        If AppCodigoDeshacerCambios = "-3" Then
                            AppCodigoExitFunction = "-2"
                            AppMensajeExitFunction = AppMensajeDeshacerCambios
                            Exit Function
                        End If
                        '*************************************************'
                    End If
                Catch ex As Exception
                    'Session.Add("msgErrorGenerarSot", "Error Al registrar Pagos")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "  -- Error :" & ex.Message.ToString())
                    'Response.Redirect("PoolPagos.aspx")
                    AppmsgErrorGenerarSot = "Error Al registrar Pagos"
                    AppCodigoExitFunction = "-2"
                    AppMensajeExitFunction = AppmsgErrorGenerarSot
                    Exit Function
                End Try
                ''FIN DEL METODO GRABAR TRY
                Dim blnErrorPago As Boolean = False


                'If Not blnErrorPago Then
                '    Recarga(strNumAsignado)
                'End If
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Fin del proceso de pagos")

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Ini - ConsultaPedido - dsDatosPedido ")
                dsDatosPedido = objConsultaMsSap.ConsultaPedido(drPagos.Item("PEDIN_NROPEDIDO"), "", "")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Fin - ConsultaPedido - dsDatosPedido ")

                '***********************************************************************************************************

                ' 'PROY-31850 - INICIO
                ' If blnSunat Then
                ' Try
                ' Dim Lineas() As String = Split(strLineaActivacion, "|")
                ' Dim strEquipos() As String = Split(strSerieEquipo, "|")
                ' Dim strMaterialChips() As String = Split(strCodMaterialChip, "|")
                ' Dim strChips() As String = Split(strSerieChip, "|")

                ' Dim y As Int16
                ' For y = 1 To Lineas.Length - 1
                ' If blnIsOLO Then
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "-------------------------------------")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "INICIO ACTUALIZACION DE TELEFONO OLO")
                ' Dim obj As New ClsActivacionPel
                ' Dim strUpdate As String = String.Empty
                ' Dim boolblnUpdate As Boolean
                ' Dim iDetalle As New COM_SIC_Activaciones.clsDetallePedidoMsSap


                ' iDetalle.K_PEDIN_NROPEDIDO = drPagos.Item("PEDIN_NROPEDIDO")
                ' iDetalle.K_SERIC_CODSERIE = strChips(y).PadLeft(18, "0")

                ' If Lineas(y).ToString().Length >= Funciones.CheckInt(clsKeyOLO.strNroDigitosLinea) Then
                ' Lineas(y) = Lineas(y).ToString().Substring(Lineas(y).ToString().Length - Funciones.CheckInt(clsKeyOLO.strNroDigitosLinea), Funciones.CheckInt(clsKeyOLO.strNroDigitosLinea))
                ' End If

                ' iDetalle.K_DEPEV_NROTELEFONO = Funciones.CheckStr(Lineas(y).ToString())

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas PVU")
                ' Dim respuesta As Integer = obj.actualizaTelefono(strChips(y), strMaterialChips(y), Lineas(y).ToString())
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "Respuesta: " & respuesta.ToString)


                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas MSINCDB")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas MSINCDB[K_PEDIN_NROPEDIDO]->" & Funciones.CheckStr(iDetalle.K_PEDIN_NROPEDIDO))
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas MSINCDB[K_SERIC_CODSERIE]->" & Funciones.CheckStr(iDetalle.K_SERIC_CODSERIE))
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas MSINCDB[K_DEPEV_NROTELEFONO]->" & Funciones.CheckStr(iDetalle.K_DEPEV_NROTELEFONO))

                ' boolblnUpdate = oBusExpress.ActualizarTelefonoMSINCDB(iDetalle, strUpdate)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas MSINCDB[rpsta]->" & Funciones.CheckStr(strUpdate))

                ' If Funciones.CheckStr(strEquipos(y)).Length > 0 And Funciones.CheckStr(strChips(y)) <> Funciones.CheckStr(strEquipos(y)) Then

                ' iDetalle.K_SERIC_CODSERIE = strEquipos(y).PadLeft(18, "0")
                ' iDetalle.K_SERIC_CODSERIE = iDetalle.K_SERIC_CODSERIE.Substring(iDetalle.K_SERIC_CODSERIE.Length - 18)

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas MSINCDB Equipo")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas MSINCDB[K_PEDIN_NROPEDIDO]->" & Funciones.CheckStr(iDetalle.K_PEDIN_NROPEDIDO))
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas MSINCDB[K_SERIC_CODSERIE]->" & Funciones.CheckStr(iDetalle.K_SERIC_CODSERIE))
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas MSINCDB[K_DEPEV_NROTELEFONO]->" & Funciones.CheckStr(iDetalle.K_DEPEV_NROTELEFONO))

                ' boolblnUpdate = oBusExpress.ActualizarTelefonoMSINCDB(iDetalle, strUpdate)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza linea en tablas MSINCDB[rpsta]->" & Funciones.CheckStr(strUpdate))

                ' End If
                ' End If
                ' Next
                ' Catch ex As Exception
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "		ERROR: " & ex.Message.ToString())
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "		ERROR: " & ex.StackTrace.ToString())
                ' Finally
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "FIN ACTUALIZACION DE TELEFONO OLO")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "-------------------------------------")
                ' End Try
                ' End If
                ' 'PROY-31850 - FIN

                ' 'PROY-24724-IDEA-28174 - INI
                ' Dim objProteccionMovil As New COM_SIC_Activaciones.clsProteccionMovil
                ' Dim strNroPedidoEquipo As String = ""
                ' Dim strCodRpta As String = String.Empty
                ' Dim strMsgRpta As String = String.Empty
                ' Dim strNroPedidoPM As String = ""
                ' Dim strNroTelefono As String = ""

                ' If Funciones.CheckStr(drPagos.Item("PAGOC_CODSUNAT")) = "0000000000000000" AndAlso Not dsDatosPedido Is Nothing AndAlso _
                ' dsDatosPedido.Tables.Count > 0 AndAlso dsDatosPedido.Tables(0).Rows.Count > 0 Then

                ' strNroPedidoPM = Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO"))
                ' strNroTelefono = Funciones.CheckStr(dsDatosPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO"))

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==============================")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "== Protección Móvil :: INI  ==")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==============================")

                ' If Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION")) = clsKeyAPP.strClaseBolFactCanje Then

                ' Dim strNumSEC As String = String.Empty
                ' Dim blnEsProteccionMovil As Boolean = False
                ' Dim dsMostrarPM As DataSet
                ' Dim dtCanjeEquipo As DataTable
                ' Dim blnPagoCorrecto As Boolean = False
                ' Dim strPedidoEquipo As String = String.Empty

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     ValidarCanjeConProteccionMovil - INICIO ==")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      IN NRO PEDIDO PM: " & strNroPedidoPM)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      IN NRO PEDIDO EQ.: " & strNroPedidoEquipo)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      IN NRO SEC: " & strNumSEC)
                ' strNroPedidoPM = Funciones.CheckInt64(strNroPedidoPM)
                ' strPedidoEquipo = Funciones.CheckInt64(strPedidoEquipo)

                ' ValidarCanjeConProteccionMovil(strNroPedidoPM, strPedidoEquipo, strNumSEC, dsMostrarPM, dtCanjeEquipo, blnEsProteccionMovil)

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      OUT BolEsProtMovil: " & blnEsProteccionMovil)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     ValidarCanjeConProteccionMovil -  F I N ==")

                ' If blnEsProteccionMovil Then

                ' Dim strNroCertificadoActual As String
                ' Dim Flagrpta As String = String.Empty
                ' Dim strIdCanje As String = String.Empty

                ' strNroCertificadoActual = Funciones.CheckStr(dsMostrarPM.Tables(0).Rows(0).Item("EVALV_NRO_CERTF_RPTA"))
                ' strIdCanje = Funciones.CheckStr(dtCanjeEquipo.Rows(0).Item("CANJI_ID"))

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     ProcesarPagoCanjeProteccionMovil -  INICIO ==")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      IN NRO PEDIDO PM: " & strNroPedidoPM)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      IN NRO SEC: " & strNumSEC)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      IN NRO TEL.: " & strNroTelefono)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      IN NRO CERTIFICADO: " & strNroCertificadoActual)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      IN ID Canje: " & strIdCanje)

                ' blnPagoCorrecto = ProcesarPagoCanjeProteccionMovil(strNroPedidoPM, strNumSEC, strNroTelefono, strNroCertificadoActual, strIdCanje)

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      OUT FLAG RPTA: " & Flagrpta)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     ProcesarPagoCanjeProteccionMovil -  F I N  ==")

                ' If blnPagoCorrecto Then
                ' Dim strTipoOperacion As String = "C"
                ' Dim lstSin As ArrayList 'PROY-24724 - Iteracion 2 Siniestros 
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     TipificarProteccionMovil -  INICIO ==")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      IN NRO SEC: " & strNumSEC)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      IN NRO TEL: " & strNroTelefono) 'PROY-24724 - Iteracion 2 Siniestros - INI : Se quita strDescEquipo
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      IN TIPO OPERACION: " & strTipoOperacion)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      IN LISTA: " & lstSin.Count) 'PROY-24724 - Iteracion 2 Siniestros -

                ' TipificarProteccionMovil(strNroPedidoPM, strNumSEC, strNroTelefono, strTipoOperacion, dsMostrarPM, dtCanjeEquipo, lstSin, "") 'PROY-24724 - Iteracion 2 Siniestros -

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     TipificarProteccionMovil -  F I N  ==")

                ' End If
                ' Else
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==      ERROR EN ValidarCanjeConProteccionMovil")
                ' End If

                ' End If

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     ConsultaPedidoEquipoPM - INICIO ==")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         IN NRO PEDIDO PM: " & strNroPedidoPM)

                ' objProteccionMovil.ValidaPagoEquipoProteccionMovil(strNroPedidoPM, strNroPedidoEquipo, strCodRpta, strMsgRpta)

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         OUT NRO PEDIDO EQUIPO: " & strNroPedidoEquipo)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         OUT COD RPTA: " & strCodRpta)
                ' 'INI PROY-140126
                ' Dim MaptPath As String
                ' MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                ' MaptPath = "( Class : " & MaptPath & "; Function: guardarConectado)"
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==         OUT MSG RPTA: " & strMsgRpta & MaptPath)
                ' 'FIN PROY-140126

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==     ConsultaPedidoEquipoPM - FIN ==")

                ' If (strCodRpta.Equals("0") Or strCodRpta.Equals("-1")) AndAlso Not strNroPedidoEquipo.Equals("") Then

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "== Seguro Proteccion Movil: SI ==")

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "== ProcesarPagoProteccionMovil :: INI  ==")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==   IN Nro de Pedido: " & strNroPedidoPM)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==   IN Nro de Pedido Equipo: " & strNroPedidoEquipo)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==   IN Nro de Telefono: " & strNroTelefono)

                ' ProcesarPagoProteccionMovil(strNroPedidoPM, strNroPedidoEquipo, strNroTelefono)

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "== ProcesarPagoProteccionMovil :: FIN  ==")
                ' Else
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "== Seguro Proteccion Movil: NO ==")
                ' End If
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==============================")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "== Protección Móvil :: FIN  ==")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "==============================")
                ' End If

                ' 'PROY-24724 - Iteracion 2 Siniestros -INI
                ' Dim strCodMaterial As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEC_CODMATERIAL"))
                ' Dim strTelefono As String = Right(Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO")), 9)
                ' Dim strCodOficina As String = dsPedido.Tables(0).Rows(0)("OFICV_CODOFICINA")

                ' AppPagoDeducible = "" 'PROY-31836 IDEA-43582_Mejora de Procesos Postventa del servicio Proteccion Movil 
                ' If (strCodMaterial.Equals(clsKeyAPP.strCodMaterialSiniestro)) Then
                ' AppPagoDeducible = strTelefono ' PROY-31836 IDEA-43582_Mejora de Procesos Postventa del servicio Proteccion Movil
                ' ProcesarPagoSiniestro(strIdentifyLog, strTelefono, strCodOficina)
                ' End If
                ' 'PROY-24724 - Iteracion 2 Siniestros -FIN
                ' 'PROY-24724-IDEA-28174 - FIN

                '**INICIO FC***'
                'VOy a considerar este metodo para grabar el correlativo en el flujo de caja
                '
                '*** REGISTRO DE DATOS PARA EL FLUJO DE CAJA ***'
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Registro datos del Flujo Caja")
                objCajas = New COM_SIC_Cajas.clsCajas
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Seteamos la fecha para la concatenaciòn")
                Dim cultureName As String = "es-PE"
                Dim culture As CultureInfo = New CultureInfo(cultureName)
                Dim dateTimeValue As DateTime
                dateTimeValue = Convert.ToDateTime(DateTime.Now, culture)

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "---------------------------------------------------------------------------------------------------------- ")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Registro datos del Flujo Caja")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Formato de fechas para FC: yyyymmdd")

                '''*****fechaCajas = dateTimeValue.ToShortDateString.Substring(6, 4) & dateTimeValue.ToShortDateString.Substring(3, 2) & dateTimeValue.ToShortDateString.Substring(0, 2)
                'Var_Corr6 ----> Valor del correlativo a utilizar
                'PROY-140397-MCKINSEY -> JSQ INICIO
                fechaCajas = Format(Now.Year, "0000").ToString.Trim & Format(Now.Month, "00").ToString.Trim & Format(Now.Day, "00").ToString.Trim
                'PROY-140397-MCKINSEY -> JSQ FIN
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- fechaCajas : " & fechaCajas.ToString)

                ''''1. Registro de pago: TABLA "TI_VENTAS_FACT"
                '''*Para las notas de crèdito el monto del saldo enviado debe ser 0.00

                Dim PEDIC_CLASEFACTURA As String = "" 'valor que sera reemplazado por una key si es una recarga virtual frecuente
                Dim P_NRO_CUOTAS As Integer 'PROY 30166

                Try
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio método : RegistrarPago")

                    'MEJORA INC000001503169:  PEDIC_TIPODOCUMENTO <> ZG2
                    If dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CLASEPEDIDO") = System.Configuration.ConfigurationSettings.AppSettings("PEDIC_CLASEPEDIDO_RVF") And Trim(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_TIPODOCUMENTO")) <> System.Configuration.ConfigurationSettings.AppSettings("constSINERGIAClaseDocumentoNC") Then
                        PEDIC_CLASEFACTURA = System.Configuration.ConfigurationSettings.AppSettings("DESC_BOLETA_RVF")
                    Else
                        PEDIC_CLASEFACTURA = Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA"))
                    End If

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_OFICINA_VENTA: " & AppAlmacen)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_FECHA : " & fechaCajas)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_CAJERO : " & Microsoft.VisualBasic.Right(Funciones.CheckStr("0000000000" & AppUsuario), 10))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_DESC_DOCUMENTO : " & dsDatosPedido.Tables(0).Rows(0).Item("PEDIV_DESCCLASEFACTURA"))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_FACTURA_FICTICIA : " & strDocSap)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_REFERENCIA : " & Var_Corr6)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_VENDEDOR : " & Microsoft.VisualBasic.Right(Funciones.CheckStr("0000000000" & dsDatosPedido.Tables(0).Rows(0).Item("VENDEDOR")), 10))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_MONEDA : " & System.Configuration.ConfigurationSettings.AppSettings("MONEDA"))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_CLASE_FACTURA_COD : " & PEDIC_CLASEFACTURA)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_NRO_CUOTAS : " & dsDatosPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA"))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_TOTAL_FACTURA : " & dsDatosPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO"))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_SALDO : " & IIf(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA") <> ConfigurationSettings.AppSettings("strTipDoc"), dsDatosPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO"), 0))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_REFERENCIA_ORIG : " & IIf(IsDBNull(dsDatosPedido.Tables(0).Rows(0).Item("PEDIV_NROREFNCND")), "", dsDatosPedido.Tables(0).Rows(0).Item("PEDIV_NROREFNCND")))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_ESTADO : " & System.Configuration.ConfigurationSettings.AppSettings("ESTADO_VENTA_FLUJOCAJA"))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_NODO : " & Funciones.CheckStr(Right(System.Net.Dns.GetHostName, 2)))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_USUARIO_CREACION : " & System.Configuration.ConfigurationSettings.AppSettings("ConstCuentasCliente_Usuario"))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_NUMERO_TELEFONO : " & CStr(hidNumeroTelefono))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- P_NROOPE_TRACE : " & CStr(AppTraceRecarga))

                    P_NRO_CUOTAS = dsDatosPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA") 'PROY 30166 

                    resCajas = objCajas.RegistrarPagoAPK(AppAlmacen, fechaCajas, _
                                                Microsoft.VisualBasic.Right(Funciones.CheckStr("0000000000" & AppUsuario), 10), _
                                                dsDatosPedido.Tables(0).Rows(0).Item("PEDIV_DESCCLASEFACTURA"), _
                                                strDocSap, Var_Corr6, _
                                                Microsoft.VisualBasic.Right(Funciones.CheckStr("0000000000" & dsDatosPedido.Tables(0).Rows(0).Item("VENDEDOR")), 10), _
                                                System.Configuration.ConfigurationSettings.AppSettings("MONEDA"), _
                                                PEDIC_CLASEFACTURA, _
                                                dsDatosPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA"), _
            Funciones.CheckDbl(dsDatosPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO")), _
                                                IIf(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA") <> ConfigurationSettings.AppSettings("strTipDoc"), Funciones.CheckDbl(dsDatosPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO")), 0), _
            IIf(IsDBNull(dsDatosPedido.Tables(0).Rows(0).Item("PEDIV_NROREFNCND")), "", dsDatosPedido.Tables(0).Rows(0).Item("PEDIV_NROREFNCND")), _
                                                System.Configuration.ConfigurationSettings.AppSettings("ESTADO_VENTA_FLUJOCAJA"), _
                                                Funciones.CheckStr(Right(System.Net.Dns.GetHostName, 2)), _
                                                System.Configuration.ConfigurationSettings.AppSettings("ConstCuentasCliente_Usuario"), _
                                                "1", P_ID_TI_VENTAS_FACT, P_MSGERR, CStr(hidNumeroTelefono), CStr(AppTraceRecarga))
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin método : RegistrarPago")
                Catch ex As Exception
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error al tratar de ejecutar el método:  RegistrarPago")
                End Try

                If P_ID_TI_VENTAS_FACT > 0 Then
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Código generado en la tabla TI_VENTAS_FACT=> " & P_ID_TI_VENTAS_FACT.ToString)

                    '''''''''2. Registro RegistrarPagoDetalle
                    If Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")) <> ConfigurationSettings.AppSettings("strTipDoc") Then '** Las notas de crèdito no van a formar parte de este proceso **'
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicia el proceso para el RegistrarPagoDetalle")

                        If (Funciones.CheckDbl(dsDatosPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO")) > 0) Then
                            Dim dTotPagoNoCuota As Double = 0 ' PROY-30166 GPRD
                            For i = 1 To hidNumFilas
                                Dim txtMonto As Double
                                Dim cboTipDocumento As String
                                Dim cboDescTipDocumento As String
                                'PROY-27440 INI
                                'Dim objTxt As TextBox
                                'objTxt = CType(Me.FindControl("txtMonto" & i), TextBox)
                                'strMonto = "" : strMonto = Trim(objTxt.Text)

                                'JCC INI'
                                If Not (P_NRO_CUOTAS > 0 And dblMontoCuotaInicial >= 0) Then
                                    strMonto = ApptxtMonto1
                                End If
                                'JCC FIN'

                                strTipoDocPago = AppCboTipoDocumento

                                cboTipDocumento = strTipoDocPago
                                txtMonto = Double.Parse(strMonto)
                                'PROY-27440 FIN
                                'PROY BUYBACK - INICIO'
                                If (hidCupon = "1" And i = 1) Then
                                    cboTipDocumento = "ZBUY"
                                Else
                                    cboTipDocumento = strTipoDocPago
                                End If
                                'PROY BUYBACK - FIN'
                                cboDescTipDocumento = DevuelteTipoDescPago(cboTipDocumento)
                                resCajas = 0

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  Item : " & i.ToString())
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_ID_TI_VENTAS_FACT : " & P_ID_TI_VENTAS_FACT.ToString())
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_FECHA : " & fechaCajas)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_FACTURA_FICTICIA : " & strDocSap)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_REFERENCIA : " & Var_Corr6)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_CLASE_FACTURA_COD : " & PEDIC_CLASEFACTURA)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_MEDIO_PAGO : " & cboTipDocumento)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_REF_NC : " & IIf(arrayListaRefSunat(i) = "", "", Funciones.CheckStr(arrayListaRefSunat(i))))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_MONTO : " & txtMonto)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_ESTADO : " & System.Configuration.ConfigurationSettings.AppSettings("ESTADO_VENTA_FLUJOCAJA"))
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_USUARIO_CREACION : " & System.Configuration.ConfigurationSettings.AppSettings("ConstCuentasCliente_Usuario"))

                                '''''''''''**Registra los medios de pago seleccionado.
                                '''''''''IIf(arrayListaReferencia(i) = "", "", Funciones.CheckStr(arrayListaReferencia(i))), _
                                If Not (P_NRO_CUOTAS > 0 And dblMontoCuotaInicial = 0) Then 'PROY 30166 
                                    resCajas = objCajas.RegistrarPagoDetalle(P_ID_TI_VENTAS_FACT, fechaCajas, strDocSap, _
                                                                Var_Corr6, PEDIC_CLASEFACTURA, _
                                                                cboTipDocumento, _
                                                                IIf(arrayListaRefSunat(i) = "", "", Funciones.CheckStr(arrayListaRefSunat(i))), _
                                                                txtMonto, _
                                                                System.Configuration.ConfigurationSettings.AppSettings("ESTADO_VENTA_FLUJOCAJA"), _
                                                                System.Configuration.ConfigurationSettings.AppSettings("ConstCuentasCliente_Usuario"), _
                                                                P_MSGERR)
                                End If


                                'PROY-30166 - IDEA  38934  INICIO GPRD
                                dTotPagoNoCuota = dTotPagoNoCuota + Double.Parse(strMonto)
                                'If (i = hidNumFilas.Value AndAlso dblMontoCuotaInicial > 0) Then
                                If (i = hidNumFilas And P_NRO_CUOTAS > 0 And dblMontoCuotaInicial >= 0) Then
                                    txtMonto = Double.Parse(hidTotalSinInicial) - dTotPagoNoCuota 'jbaca 060918

                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Adic X Cuotas P_ID_TI_VENTAS_FACT : " & P_ID_TI_VENTAS_FACT)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Adic X Cuotas cboTipDocumento : " & "ZCI1")
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Adic X Cuotas cboDescTipDocumento : " & "CUOTA INICIAL")
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Adic X Cuotas txtMonto : " & txtMonto)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Adic X Cuotas ConstCuentasCliente_Usuario : " & System.Configuration.ConfigurationSettings.AppSettings("ConstCuentasCliente_Usuario"))

                                    'VCANCHIC PROY 140743'
                                    Dim tipoPago As String = "ZCI1"
                                    If sTipoOperacion = ConfigurationSettings.AppSettings("COD_TIPO_OPERACION_VENTA_VARIOS") Then
                                        tipoPago = Funciones.CheckStr(ReadKeySettings.Key_TipoPagoAccCuo)
                                    End If
                                    'VCANCHIC PROY 140743'
                                    resCajas = objCajas.RegistrarPagoDetalle(P_ID_TI_VENTAS_FACT, fechaCajas, strDocSap, _
                                                                Var_Corr6, PEDIC_CLASEFACTURA, _
                                                                tipoPago, _
                                                                IIf(arrayListaRefSunat(i) = "", "", Funciones.CheckStr(arrayListaRefSunat(i))), _
                                                                txtMonto, _
                                                                System.Configuration.ConfigurationSettings.AppSettings("ESTADO_VENTA_FLUJOCAJA"), _
                                                                System.Configuration.ConfigurationSettings.AppSettings("ConstCuentasCliente_Usuario"), _
                                                                P_MSGERR)

                                End If
                                'PROY-30166 - IDEA  38934  FIN GPRD
                            Next
                        Else
                            ' Dim txtMonto As Double
                            ' Dim cboTipDocumento As String
                            ' Dim cboDescTipDocumento As String

                            ' 'PROY BUYBACK - INICIO'
                            ' Dim txtMontoCV As Double
                            ' Dim cboTipDocumentoCV As String

                            ' If (hidCupon = "1") Then
                            ' 'cboTipDocumentoCV = cboTipDocumento1.SelectedValue
                            ' 'txtMontoCV = Funciones.CheckDbl(txtMonto1)

                            ' 'cboTipDocumento = cboTipDocumento2.SelectedValue
                            ' 'txtMonto = Funciones.CheckDbl(txtMonto2)
                            ' Else
                            ' 'cboTipDocumento = cboTipDocumento1.SelectedValue
                            ' 'txtMonto = Funciones.CheckDbl(txtMonto1)
                            ' cboTipDocumento = AppCboTipoDocumento
                            ' txtMonto = Funciones.CheckDbl(ApptxtMonto1)
                            ' End If
                            ' 'PROY BUYBACK - FIN'

                            ' 'cboDescTipDocumento = DevuelteTipoDescPago(cboTipDocumento)
                            ' resCajas = 0

                            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  Item : " & i.ToString())
                            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_ID_TI_VENTAS_FACT : " & P_ID_TI_VENTAS_FACT.ToString())
                            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_FECHA : " & fechaCajas)
                            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_FACTURA_FICTICIA : " & strDocSap)
                            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_REFERENCIA : " & Var_Corr6)
                            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_CLASE_FACTURA_COD : " & PEDIC_CLASEFACTURA)
                            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_MEDIO_PAGO : " & cboTipDocumento)
                            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_REF_NC : " & "")
                            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_MONTO : " & txtMonto)
                            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_ESTADO : " & System.Configuration.ConfigurationSettings.AppSettings("ESTADO_VENTA_FLUJOCAJA"))
                            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-  P_USUARIO_CREACION : " & System.Configuration.ConfigurationSettings.AppSettings("ConstCuentasCliente_Usuario"))

                            ' '''''''''''**Registra los medios de pago seleccionado.
                            ' '''''''''IIf(arrayListaReferencia(i) = "", "", Funciones.CheckStr(arrayListaReferencia(i))), _

                            ' 'PROY  BUYBACK - INICIO'
                            ' If (hidCupon = "1") Then

                            ' resCajasCV = objCajas.RegistrarPagoDetalle(P_ID_TI_VENTAS_FACT, fechaCajas, strDocSap, _
                            ' Var_Corr6, PEDIC_CLASEFACTURA, _
                            ' cboTipDocumentoCV, _
                            ' "", _
                            ' txtMontoCV, _
                            ' System.Configuration.ConfigurationSettings.AppSettings("ESTADO_VENTA_FLUJOCAJA"), _
                            ' System.Configuration.ConfigurationSettings.AppSettings("ConstCuentasCliente_Usuario"), _
                            ' P_MSGERR)


                            ' resCajas = objCajas.RegistrarPagoDetalle(P_ID_TI_VENTAS_FACT, fechaCajas, strDocSap, _
                            ' Var_Corr6, PEDIC_CLASEFACTURA, _
                            ' cboTipDocumento, _
                            ' "", _
                            ' txtMonto, _
                            ' System.Configuration.ConfigurationSettings.AppSettings("ESTADO_VENTA_FLUJOCAJA"), _
                            ' System.Configuration.ConfigurationSettings.AppSettings("ConstCuentasCliente_Usuario"), _
                            ' P_MSGERR)

                            ' Else
                            ' resCajas = objCajas.RegistrarPagoDetalle(P_ID_TI_VENTAS_FACT, fechaCajas, strDocSap, _
                            ' Var_Corr6, PEDIC_CLASEFACTURA, _
                            ' cboTipDocumento, _
                            ' "", _
                            ' txtMonto, _
                            ' System.Configuration.ConfigurationSettings.AppSettings("ESTADO_VENTA_FLUJOCAJA"), _
                            ' System.Configuration.ConfigurationSettings.AppSettings("ConstCuentasCliente_Usuario"), _
                            ' P_MSGERR)
                            ' End If
                            ' 'PROY BUYBACK - FIN'

                        End If
                        ' 'PROY BUYBACK - INICIO'
                        ' If hidCupon = "1" Then
                        ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio actualizacion cupon")
                        ' Dim objConsultaMssap As New clsConsultaMsSap
                        ' Dim strCodRespuesta As String = String.Empty
                        ' Dim strMsjRespuesta As String = String.Empty
                        ' objConsultaMssap.ActualizaCupon(Funciones.CheckStr(hidCodigoCupon), clsKeyAPP.Key_Estado_Pagado, CurrentUser, strCodRespuesta, strMsjRespuesta)
                        ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "strCodRespuesta : " & strCodRespuesta)
                        ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "strMsjRespuesta : " & strMsjRespuesta)
                        ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin actualizacion cupon")
                        ' End If
                        ' 'PROY BUYBACK - FIN'
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Termina el proceso para el RegistrarPagoDetalle")
                        '''''''''''''''''''* FIN 2 *'

                        ''''''''''* 3. RegistrarVentaDetalle, consulto el pedido para asegurar la data
                        '''''''''** Registro de los MATERIALES(TI_MATER_FACT):
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicia el proceso para el RegistrarVentaDetalle.")
                        If Not dsDatosPedido Is Nothing Then
                            If dsDatosPedido.Tables(1).Rows.Count > 0 Then
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicia el proceso para registrar la venta en el detalle.")
                                resCajas = 0
                                For k As Integer = 0 To dsDatosPedido.Tables(1).Rows.Count - 1
                                    resCajas = objCajas.RegistrarVentaDetalle(AppAlmacen, fechaCajas, _
                                                                                Microsoft.VisualBasic.Right(Funciones.CheckStr("0000000000" & AppUsuario), 10), _
                                                                                dsDatosPedido.Tables(0).Rows(0).Item("PEDIV_DESCCLASEFACTURA"), _
                                                                                strDocSap, Var_Corr6, _
                                                                                Microsoft.VisualBasic.Right(Funciones.CheckStr("0000000000" & dsDatosPedido.Tables(0).Rows(0).Item("VENDEDOR")), 10), _
                                                                                dsDatosPedido.Tables(1).Rows(k).Item("DEPEC_CODMATERIAL"), _
                                                                                dsDatosPedido.Tables(1).Rows(k).Item("DEPEV_DESCMATERIAL"), _
                                                                                "UN", 1, _
                                                                                dsDatosPedido.Tables(1).Rows(k).Item("DEPEN_PRECIOIGV"), _
                                                                                IIf(IsDBNull(dsDatosPedido.Tables(1).Rows(k).Item("SERIC_CODSERIE")), "", dsDatosPedido.Tables(1).Rows(k).Item("SERIC_CODSERIE")), _
                                                                                IIf(IsDBNull(dsDatosPedido.Tables(1).Rows(k).Item("DEPEV_CODIGOLP")), "", dsDatosPedido.Tables(1).Rows(k).Item("DEPEV_CODIGOLP")), _
                                                                                IIf(IsDBNull(dsDatosPedido.Tables(1).Rows(k).Item("DEPEV_DESCRIPCIONLP")), "", dsDatosPedido.Tables(1).Rows(k).Item("DEPEV_DESCRIPCIONLP")), _
                                                                                Funciones.CheckStr(Right(System.Net.Dns.GetHostName, 2)), _
                                                                                System.Configuration.ConfigurationSettings.AppSettings("ConstCuentasCliente_Usuario"), _
                                                                                P_MSGERR)


                                Next
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin el proceso para registrar la venta en el detalle.")
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "JOH" & P_MSGERR)
                                If P_MSGERR <> "" Then
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error al registrar la venta detalle.")
                                    DeshacerCambiosPagos(K_PAGON_IDPAGO)
                                    If AppCodigoDeshacerCambios = "-3" Then
                                        AppCodigoExitFunction = "-2"
                                        AppMensajeExitFunction = AppMensajeDeshacerCambios
                                        Exit Function
                                    End If
                                    'Response.Write("<script>alert('" & P_MSGERR & "')</script>")
                                    AppErrorDeshacerCambios = P_MSGERR
                                    Exit Function
                                Else
                                    '**********************************************
                                    '*** 4. Registramos RegistrarDetalleCuota   ***'
                                    '*** DETALLA EL NUMERO DE CUOTAS DEL PEDIDO ***'
                                    '**********************************************
                                    resCajas = 0
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "JOH" & dsDatosPedido.Tables(0).Rows.Count.ToString())

                                    If dsDatosPedido.Tables(0).Rows.Count > 0 Then
                                        '**REGISTRA LAS CUTOAS DEL PEDIDO SI EXISTIERA **'
                                        If dsDatosPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA") > 0 Then
                                            '''For c As Integer = 1 To dsDatosPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA")
                                            resCajas = objCajas.RegistrarDetalleCuota(P_ID_TI_VENTAS_FACT, fechaCajas, _
                                                                                    Funciones.CheckStr(strDocSap), _
                                                                                    Var_Corr6, dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA"), _
                                                                                    dsDatosPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA"), _
                                                                                    0, _
                                                                                    System.Configuration.ConfigurationSettings.AppSettings("ConstCuentasCliente_Usuario"), _
                                                                                    P_MSGERR)

                                            ''JOH
                                            Dim sResultado As String
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Iniciando Actualizar cuota")
                                            'PROY-33313 RP INICIO
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Nro Cuota : " & Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA")))
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Tipo de Operacion : " & Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION")))
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Valor de Operacion Repo : " & Funciones.CheckStr(ConfigurationSettings.AppSettings("COD_OPERACION_REPOSICION")))
                                            If dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVPostpago") And dsDatosPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA") = 1 And dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION") = ConfigurationSettings.AppSettings("COD_OPERACION_REPOSICION") Then
                                                Dim sCodMsj As String
                                                Dim sActualizaCVE As Boolean
                                                sActualizaCVE = objCajas.FnActualizaTipoCVE(Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")), sCodMsj)
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Actualizacion de Tipo CVE : " & sActualizaCVE)
                                                'INI PROY-140126
                                                Dim MaptPath As String
                                                MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                                                MaptPath = "( Class : " & MaptPath & "; Function: guardarConectado)"
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Mensaje Tipo CVE : " & sCodMsj & MaptPath)
                                                'FIN PROY-140126
                                            Else
                                                'BEGIN INC000001089654
                                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - INIT Flujo Actualizar Cuota", strIdentifyLog))

                                                'PROY-140743 IDEA141192 VICTOR CANCHICA
                                                Dim CuotaAcc As Integer = dsDatosPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA")
                                                Dim Contrato As String
                                                If objContrato Is Nothing And sTipoOperacion = ConfigurationSettings.AppSettings("COD_TIPO_OPERACION_VENTA_VARIOS") And CuotaAcc > 0 Then
                                                    Contrato = "ACC-" + strDocSap
                                                Else
                                                    Contrato = objContrato.Tables(0).Rows(0).Item("ID_CONTRATO")
                                                End If
                                                If Not objContrato Is Nothing Or sTipoOperacion = ConfigurationSettings.AppSettings("COD_TIPO_OPERACION_VENTA_VARIOS") And CuotaAcc > 0 Then
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & Contrato)
                                                    If objCajas.Actualizar_Cuotas(Contrato, sResultado) = 0 Then
                                                        'PROY-140743 IDEA141192 VICTOR CANCHICA
                                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Se Actualizo las cuotas Correctamente.")
                                                    Else
                                                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - Error al actualizar cuota.", strIdentifyLog))
                                                    End If
                                                Else
                                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Contrato en PVU no existe")
                                                End If

                                                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - END Flujo Actualizar Cuota", strIdentifyLog))
                                                'END INC000001089654
                                            End If
                                            'PROY-33313 RP FIN
                                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Finalizar Actualizar cuota")
                                            ''''Next
                                        End If
                                    End If
                                End If
                            Else
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "No se encontraron datos al consultar el pedido.")
                            End If
                        Else
                            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "La consulta no se realizo correctamente.")
                        End If
                    End If  '** FIN IF DE LA NC
                Else
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Error devuelto : " & P_MSGERR.ToString)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Error, no se realizo el registro en TI_VENTAS_FACT")
                    objActiv.AsignarPagoAcuerdosXDocSap(drPagos.Item("PEDIN_NROPEDIDO"), "", 0, CurrentUser, msgj)
                End If
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Registro datos del Flujo Caja")
                '**FIN FC
                '*********************************************************************************************************

                'INI - INSERTAR EFECTIVO - CCC
                'objCajas.FP_InsertaEfectivo(Session("ALMACEN"), "60138", dblEfectivo)  'Se inserta el efectivo obtenido
                Dim nroCuotas As Integer = 0
                If Not CBool(ApprecargaVirtual) Then
                    nroCuotas = CStr(drPagos.Item("DEPEN_NROCUOTA"))
                End If
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio FP_InsertaEfectivo.")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp ALMACEN: " & AppAlmacen)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp USUARIO: " & AppUsuario)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp dblEfectivo: " & CStr(dblEfectivo))
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp FECHA: " & CStr(dsPedido.Tables(0).Rows(0).Item("PEDID_FECHADOCUMENTO")))
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Cuotas : " & nroCuotas.ToString())
                Dim dFecha As Date
                Dim sFecha As String = Format(Now.Day, "00").ToString.Trim & "/" & Format(Now.Month, "00").ToString.Trim & "/" & Format(Now.Year, "0000").ToString.Trim

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - Fecha Pedido : " & sFecha)
                Try
                    If nroCuotas = 0 Then  ' No se contabliza el pago en cuotas
                        objCajas.FP_InsertaEfectivo(AppAlmacen, AppUsuario, dblEfectivo, sFecha)     'Se inserta el efectivo obtenido
                        '    objCajas.FP_InsertaEfectivo(Session("ALMACEN"), Session("USUARIO"), dblEfectivo)     'Se inserta el efectivo obtenido
                    End If
                Catch ex As Exception
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "Entro al Error de insertar efectivo")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "Error " & ex.Message.ToString())
                End Try

                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin FP_InsertaEfectivo.")
                ' 'FIN - INSERTAR EFECTIVO - CCC

                ' '/*----------------------------------------------------------------------------------------------------------------*/
                ' '/*--JR  INICIO  -  PROY-29380 IDEA-38934 - Iteración 2 y 3 2da Fase Sinergia Adec en Sist de Venta y Post-Venta --*/
                ' '/*----------------------------------------------------------------------------------------------------------------*/
                ' 'Inicia Devolucion de Efectivo de una Recarga Virtual (reversa Recarga Virtual) solo para las NOTAS DE CREDITO

                ' If K_DESLOG = "OK" Then
                ' Dim strCanal As String = AppCanal
                ' Dim strUserSesion As String = AppUsuario
                ' Dim arrDetalle(10) As String
                ' 'Dim isRecargaVirtual As Boolean
                ' Dim isNotaCredito As Boolean = AppNC 'Creo que no tiene valor, elimianrlo

                ' 'Dim estadoRegistrarRecargaVirtual As Boolean
                ' Dim estadoRegistrarRecargaVirtual As Integer

                ' arrDetalle(1) = Funciones.CheckStr(dsDatosPedido.Tables(1).Rows(0).Item("DEPEN_PRECIOVENTA"))
                ' arrDetalle(2) = Funciones.CheckStr(dsDatosPedido.Tables(1).Rows(0).Item("MATEN_PRECIOBASE"))
                ' arrDetalle(3) = Funciones.CheckStr(dsDatosPedido.Tables(1).Rows(0).Item("DEPEN_SUBTOTAL"))
                ' arrDetalle(4) = Funciones.CheckStr(dsDatosPedido.Tables(1).Rows(0).Item("DEPEN_IMPUESTO"))
                ' arrDetalle(5) = Funciones.CheckStr(dsDatosPedido.Tables(1).Rows(0).Item("DEPEN_PRECIOIGV"))
                ' arrDetalle(6) = Funciones.CheckStr(dsDatosPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO"))
                ' arrDetalle(7) = Funciones.CheckStr(dsDatosPedido.Tables(1).Rows(0).Item("OFICV_CODOFICINA"))

                ' 'solo ingresa si es Nota de credito (DEVOLUCION DE EFECTIVO)
                ' If Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")) = ConfigurationSettings.AppSettings("strTipDoc") Then
                ' If Not IsNothing(ApprecargaVirtual) Then
                ' isRecargaVirtual = ApprecargaVirtual
                ' If isRecargaVirtual Then

                ' 'Obtenemos los mensajes que seran mostrados al realizar la reversa de la RV
                ' Dim msjRV_NoRegistrada As String
                ' Dim msjRV_Devuelta As String
                ' Dim msjRV_FallaValidaLinea As String
                ' Dim msjRV_LineaSinSaldo As String
                ' Dim msjRV_ErrorDevolucion As String
                ' Dim msjRV_ErrorCambioEstado As String
                ' Dim msjRV_ErrorObtenerSaldo As String = ""
                ' Dim msjDevolverRV As String
                ' Dim codGrupoMensajes As Integer = Funciones.CheckDbl(ConfigurationSettings.AppSettings("constGrupoParam_MensajesReversaRecargaVirtual"))

                ' Dim dsMensajesRV As DataSet = (New COM_SIC_Cajas.clsCajas).ObtenerParamByGrupo(codGrupoMensajes)

                ' If Not IsNothing(dsMensajesRV) Then
                ' dsMensajesRV.Tables(0).DefaultView.Sort = "PARAN_CODIGO ASC"

                ' msjRV_NoRegistrada = Funciones.CheckStr(dsMensajesRV.Tables(0).Rows(0).Item("PARAV_VALOR"))
                ' msjRV_Devuelta = Funciones.CheckStr(dsMensajesRV.Tables(0).Rows(1).Item("PARAV_VALOR"))
                ' msjRV_FallaValidaLinea = Funciones.CheckStr(dsMensajesRV.Tables(0).Rows(2).Item("PARAV_VALOR"))
                ' msjRV_LineaSinSaldo = Funciones.CheckStr(dsMensajesRV.Tables(0).Rows(3).Item("PARAV_VALOR"))
                ' msjRV_ErrorDevolucion = Funciones.CheckStr(dsMensajesRV.Tables(0).Rows(4).Item("PARAV_VALOR"))
                ' msjRV_ErrorCambioEstado = Funciones.CheckStr(dsMensajesRV.Tables(0).Rows(5).Item("PARAV_VALOR"))

                ' Else
                ' msjRV_NoRegistrada = "No se pudo obtener datos de la recarga, asegúrese que la recarga este registrada."
                ' msjRV_Devuelta = "No se puede concretar la transaccion, la recarga ya ha sido consumida."
                ' msjRV_FallaValidaLinea = "Error en la valdiacion de la Línea. Intente nuevamente."
                ' msjRV_LineaSinSaldo = "No se procederá con el pago de la Nota de Crédito, el saldo de la bolsa es menor al monto recargado."
                ' msjRV_ErrorDevolucion = "Surgió un error en la Devolución, Aunlar y volver a generar la Nota de Crédito."
                ' msjRV_ErrorCambioEstado = "Surgió un error en el cambio de estado de la RV, informar al supervisor."
                ' msjRV_ErrorObtenerSaldo = "Surgió un error al intentar obtener el Saldo de la Linea."
                ' End If

                ' 'invocamos al metodo que realizarala conexion con el WS y la reversa de la Recarga Virtual
                ' estadoRegistrarRecargaVirtual = ExtornarRecargaVirtual(strIdentifyLog, strCanal, strUserSesion, arrDetalle)

                ' '-1 Error en el Servicio
                ' '0  Exito
                ' '1  La recarga ya fue Devuelta
                ' '2	No se pudo obtener la recarga
                ' '3	No se pudo valida si la línea es prepago o postpago
                ' '4	La línea postpago no tiene saldo
                ' '5	No se pudo devolver el efectivo para la línea postpago
                ' '6	La línea prepago no tiene saldo
                ' '7	No se pudo devolver el efectivo para la línea postpago
                ' '8	No se pudo cambiar el estado de la transaccion

                ' If estadoRegistrarRecargaVirtual = 0 Then
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " Se realizò la Reversa de la Recarga Virtual correctamente")
                ' Else
                ' K_DESLOG = ""
                ' hidDESLOG = K_DESLOG
                ' hidExtornoExitoso = False
                ' If estadoRegistrarRecargaVirtual = -1 Then
                ' msjDevolverRV = msjRV_ErrorDevolucion
                ' ElseIf estadoRegistrarRecargaVirtual = 1 Then
                ' 'Mostrar mensaje que la Recarga ya fue devuelta 
                ' msjDevolverRV = msjRV_Devuelta
                ' ElseIf estadoRegistrarRecargaVirtual = 2 Then
                ' 'Mostrar mensaje No se pudo obtener datos de la recarga
                ' msjDevolverRV = msjRV_NoRegistrada
                ' ElseIf estadoRegistrarRecargaVirtual = 3 Then
                ' 'Mostrar mensaje Error de validacion de Linea
                ' msjDevolverRV = msjRV_FallaValidaLinea
                ' ElseIf estadoRegistrarRecargaVirtual = 4 Or estadoRegistrarRecargaVirtual = 5 Then
                ' 'Mostrar la alerta Error al intentar obtener el saldo de la Linea... 
                ' msjDevolverRV = msjRV_ErrorObtenerSaldo
                ' ElseIf estadoRegistrarRecargaVirtual = 6 Then
                ' 'Mostrar la alerta error al intentar devolver...                                      
                ' msjDevolverRV = msjRV_ErrorDevolucion
                ' ElseIf estadoRegistrarRecargaVirtual = 7 Then
                ' 'Mostrar la alerta error al intentar devolver...                                      
                ' msjDevolverRV = msjRV_ErrorCambioEstado
                ' ElseIf estadoRegistrarRecargaVirtual = 8 Or estadoRegistrarRecargaVirtual = 9 Then
                ' 'Mostrar la alerta saldo insuficiente para realizar la devolucion... 
                ' msjDevolverRV = msjRV_LineaSinSaldo
                ' End If
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & msjDevolverRV)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " No se procedera con el Extorno de la Recarga Virtual. No enviar la NC a SAP")
                ' 'Session.Add("msgErrorDevolverRV", msjDevolverRV)
                ' AppmsgErrorDevolverRV = msjDevolverRV
                ' End If
                ' End If
                ' End If
                ' End If
                ' End If
                ' '/*----------------------------------------------------------------------------------------------------------------*/
                ' '/*--JR  FIN     -  PROY-29380 IDEA-38934 - Iteración 2 y 3 2da Fase Sinergia Adec en Sist de Venta y Post-Venta --*/
                ' '/*----------------------------------------------------------------------------------------------------------------*/
                'INSERTANDO EN SAP EL PAGO
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Inicia el bloque para disparar al WS:")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " hidDESLOG: " + hidDESLOG)
                If hidDESLOG = "OK" Then

                    '******INICIO Consulta si la Boleta viene de un CANJE *******'
                    If Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION")) = ConfigurationSettings.AppSettings("ClaseBolFactCanje") Then
                        Dim blnDocCanje As Boolean
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- INICIO PAGO DEL REGISTRO DE CANJE")
                        blnDocCanje = PagarRegistroCanje(drPagos.Item("PEDIN_NROPEDIDO"))
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "-   Actualizacion de Registro de Canje: " & blnDocCanje)
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- FIN PAGO DEL REGISTRO DE CANJE")
                    End If
                    '******FIN Consulta si la Boleta viene de un CANJE *******'

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio ClsPagosWS")
                    '********************************************************************************************************************************************************************
                    'WS:
                    If Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")) <> ConfigurationSettings.AppSettings("TIPO_RENTA_ADELANTADA") Then
                        '**Dispara SAP.
                        '----
                        If ConfigurationSettings.AppSettings("LanzarServicio") = "0" Then
                            If Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")) <> ConfigurationSettings.AppSettings("strTipDoc") And dsDatosPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO") > 0 Then
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Ejecuta el WS para el pedido : " & Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")) & " Clase pedido(PEDIC_CLASEFACTURA): " & Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")))
                                objClsPagosWS.RegistrarPagoSap(Funciones.CheckInt64(drPagos.Item("PEDIN_NROPEDIDO")), Funciones.CheckInt64(K_PAGON_IDPAGO), CurrentUser, CurrentTerminal, K_COD_RESPUESTA, K_MSJ_RESPUESTA, K_ID_TRANSACCION, AppUsuario)
                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin de la ejecuciòn del WS")

                                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     ID COD RESPUESTA: " & K_COD_RESPUESTA)

                                If K_COD_RESPUESTA = "0" Then
                                    AppEnvioSAP = "0"
                                Else
                                    AppEnvioSAP = "1"
                                End If
                            Else
                                If Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")) <> ConfigurationSettings.AppSettings("strTipDoc") And dsDatosPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO") = 0 And dsPedido.Tables(0).Rows(0).Item("PEDIC_ESQUEMACALCULO") = ConfigurationSettings.AppSettings("ESQUEMACALCULO_TG") Then
                                    '**ENTRA AQUI CUANDO SON TRANSFERENCIAS GRATUITAS:
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Ejecuta WS para la TG.")
                                    objClsPagosWS.RegistrarPagoSap(Funciones.CheckInt64(drPagos.Item("PEDIN_NROPEDIDO")), 0, CurrentUser, CurrentTerminal, K_COD_RESPUESTA, K_MSJ_RESPUESTA, K_ID_TRANSACCION, AppUsuario)
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin WS para la TG.")
                                Else
                                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Entra a evaluar la NC para el WS:")
                                    If Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")) = ConfigurationSettings.AppSettings("strTipDoc") Then
                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Ejecuta WS para otros tipos")
                                        'objClsPagosWS.RegistrarPagoSap(Funciones.CheckInt64(drPagos.Item("PEDIN_NROPEDIDO")), 0, CurrentUser, CurrentTerminal, K_COD_RESPUESTA, K_MSJ_RESPUESTA, K_ID_TRANSACCION, Session("USUARIO"))

                                        '/*----------------------------------------------------------------------------------------------------------------*/
                                        '/*--JR  INICIO  -  PROY-29380 IDEA-38934 - Iteración 2 y 3 2da Fase Sinergia Adec en Sist de Venta y Post-Venta --*/
                                        '/*----------------------------------------------------------------------------------------------------------------*/
                                        'Pase o no pase por la solicitud de extornarRecargaVirtual() el extorno siempre sera exitoso (TRUE)
                                        'sera FALSE si ocurre un error en el WS o no procede la solicitud del extorno (Ya se consumio el saldo de la RV)
                                        If hidExtornoExitoso Then
                                            Dim xxNroPedido As Int64 = Funciones.CheckInt64(drPagos.Item("PEDIN_NROPEDIDO")) 'JRJRJR ELIMINAR
                                            Dim xxIdPago As Int64 = Funciones.CheckInt64(K_PAGON_IDPAGO) 'JRJRJR ELIMINAR
                                            Dim xxCurrentUser As String = CurrentUser.ToString 'JRJRJR ELIMINAR
                                            Dim xxCurrentTerminal As String = CurrentTerminal.ToString 'JRJRJR ELIMINAR
                                            Dim xxUsuario As String = Funciones.CheckStr(AppUsuario) 'JRJRJR ELIMINAR

                                            objClsPagosWS.RegistrarPagoSap(Funciones.CheckInt64(drPagos.Item("PEDIN_NROPEDIDO")), Funciones.CheckInt64(K_PAGON_IDPAGO), CurrentUser, CurrentTerminal, K_COD_RESPUESTA, K_MSJ_RESPUESTA, K_ID_TRANSACCION, AppUsuario)

                                        End If
                                        '/*----------------------------------------------------------------------------------------------------------------*/
                                        '/*--JR  FIN     -  PROY-29380 IDEA-38934 - Iteración 2 y 3 2da Fase Sinergia Adec en Sist de Venta y Post-Venta --*/
                                        '/*----------------------------------------------------------------------------------------------------------------*/

                                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin WS para otros tipos")
                                    End If
                                End If
                            End If
                        End If
                        '----
                    End If
                    '********************************************************************************************************************************************************************
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     ID TRANSACCION: " & K_ID_TRANSACCION)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     ID MSN DE RESPUESTA: " & K_MSJ_RESPUESTA)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     ID ID DE TRANSACCION: " & K_ID_TRANSACCION)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin ClsPagosWS")
                End If
                ' FIN DE INSERTANDO EN SAP EL PAGO

                ' '//PROY-140379 INI
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "############################ INICIO BLOQUE APPLE WATCH ############################")

                ' If sTipoOperacion.Trim = "C" Then
                ' Try

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "############################ PROCESO DE CANJE APPLE WATCH ############################")

                ' Dim objclsConsultaMsSap As New COM_SIC_Activaciones.clsConsultaMsSap
                ' Dim dtConsultaCanjeSW As DataTable

                ' dtConsultaCanjeSW = objclsConsultaMsSap.ConsultaCanje(drPagos.Item("PEDIN_NROPEDIDO"), "", "")
                ' Dim StrMotivoDevolSW As String = Funciones.CheckStr(dtConsultaCanjeSW.Rows(0).Item("CANJV_MOTIVO"))
                ' Dim strSerie_entrante As String = Funciones.CheckStr(dtConsultaCanjeSW.Rows(0).Item("CANJV_ENT_SERIE_MAT"))
                ' Dim strSerie_saliente As String = Funciones.CheckStr(dtConsultaCanjeSW.Rows(0).Item("CANJV_SAL_SERIE_MAT"))
                ' Dim strMaterial As String = Funciones.CheckStr(dtConsultaCanjeSW.Rows(0).Item("CANJV_SAL_COD_MAT"))
                ' Dim strMaterialEnt As String = Funciones.CheckStr(dtConsultaCanjeSW.Rows(0).Item("CANJV_ENT_COD_MAT"))

                ' Dim blnEncontrado As Boolean = False
                ' Dim blnMatEntEncontrado As Boolean = False
                ' Dim strSplitMate() As String = Funciones.CheckStr(ReadKeySettings.Key_MaterialPermitidoSW).Split("|")
                ' Dim strMatEncontrado As String = String.Empty
                ' For x As Integer = 0 To strSplitMate.Length - 1 Step 1
                ' If strSplitMate(x).PadLeft(18, "0") = strMaterial And Not blnEncontrado Then
                ' blnEncontrado = True
                ' strMatEncontrado = strSplitMate(x).PadLeft(18, "0")
                ' 'Exit For
                ' End If
                ' If strSplitMate(x).PadLeft(18, "0") = strMaterialEnt And Not blnMatEntEncontrado Then
                ' blnMatEntEncontrado = True
                ' End If
                ' If blnEncontrado And blnMatEntEncontrado Then
                ' Exit For
                ' End If
                ' Next x

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strMatEncontrado : " & Funciones.CheckStr(strMatEncontrado))
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     blnEncontrado : " & Funciones.CheckStr(blnEncontrado))
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strMaterialEnt : " & Funciones.CheckStr(strMaterialEnt))
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     blnMatEntEncontrado : " & Funciones.CheckStr(blnMatEntEncontrado))

                ' If blnMatEntEncontrado Then

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "== Equipo entrante iphone [Material entrante] [" & strMaterialEnt & "]")
                ' Dim blnResEjecucion As Boolean = False
                ' Dim strAccion As String = "0"

                ' Dim telefonoAP As String = "51" + IIf(dsDatosPedido.Tables(1).Rows(0).IsNull("DEPEV_NROTELEFONO"), "", dsDatosPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO"))

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     telefonoAP : " & telefonoAP)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     StrMotivoDevolSW : " & StrMotivoDevolSW)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strSerie_entrante : " & strSerie_entrante)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strSerie_saliente : " & strSerie_saliente)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strMaterial : " & strMaterial)

                ' Dim StrCodigoMotivo As String = Funciones.CheckStr(dtConsultaCanjeSW.Rows(0).Item("CANJV_MOTIVO"))
                ' Dim TipoOper_Devol As String = Funciones.CheckStr(COM_SIC_Seguridad.ReadKeySettings.Key_TipoOper_Devol)
                ' Dim dtResultMotivo As DataTable
                ' Dim objConsultaPvu As New COM_SIC_Activaciones.clsConsultaPvu
                ' Dim dr As System.Data.DataRow
                ' Dim StrDescripcionMotivo As String
                ' Dim strIccid_baja As String = Funciones.CheckStr(dsDatosPedido.Tables(1).Rows(0).Item("SERIC_CODSERIE")) '--GPRD
                ' dtResultMotivo = objConsultaPvu.ConsultaMotivosCanje(TipoOper_Devol, "", 1, "", "")

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     StrCodigoMotivo : " & StrCodigoMotivo)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     TipoOper_Devol : " & TipoOper_Devol)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strIccid_baja : " & strIccid_baja)

                ' Dim e As Integer = 0
                ' For Each dr In dtResultMotivo.Rows
                ' If dtResultMotivo.Rows(e).Item("MOTI_CODIGO") = StrCodigoMotivo Then
                ' StrDescripcionMotivo = dtResultMotivo.Rows(e).Item("MOTI_DESCRIP")
                ' Exit For
                ' End If
                ' e += 1
                ' Next
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     StrDescripcionMotivo : " & StrDescripcionMotivo)
                ' If blnEncontrado = True Then
                ' blnResEjecucion = ejecutarConsultarProcesarIOT(telefonoAP, StrDescripcionMotivo, strIdentifyLog, strAccion, strSerie_entrante, strSerie_saliente, strIccid_baja) '//ACTUALIZAR IMEI IOT
                ' Else
                ' strAccion = "1"
                ' blnResEjecucion = ejecutarConsultarProcesarIOT(telefonoAP, StrDescripcionMotivo, strIdentifyLog, strAccion, strSerie_entrante, strSerie_saliente, strIccid_baja) '//BAJA DEL SERVICIO SW
                ' End If

                ' If Not blnResEjecucion Then
                ' '//mensaje = IIf(strAccion = 0, "ACTUALIZAR el", "EJECUTAR BAJA del")
                ' 'Session("MensajeErrorPagoCanjeAW") = "Ha ocurrido un error al " & mensaje & " servicio Apple Watch de la linea " & telefonoAP & " en IOTDB"
                ' AppMensajeErrorPagoCanjeAW = "Ha ocurrido un error al invocar el servicio bssiotconsultasprocesos"
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & Funciones.CheckStr(AppMensajeErrorPagoCanjeAW))
                ' End If
                ' Else
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "== Equipo entrante no es iphone : " & strMaterialEnt)
                ' End If
                ' Catch ex As Exception
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR INESPERADO EN EL FLUJO AW")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR AW " & ex.Message)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR AW " & ex.StackTrace)
                ' End Try
                ' Else
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "############################ NO ES PAGO DE CANJE APPLE WATCH ############################")
                ' End If
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "############################ FIN BLOQUE APPLE WATCH ############################")
                ' '//PROY-140379 FIN
                Try
                    If K_DESLOG <> "OK" Then
                        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & " ERROR: " & K_DESLOG)
                        blnErrorPago = True
                    End If
                Catch ex As Exception
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "ERROR : " & ex.Message.ToString())
                End Try

                strDocSunat = strNumAsignado
            End If

            wParam5 = 1
            wParam6 = "Registro de Pago"
            strErrorMsg = ""

            'PROY-26366-IDEA-34247 FASE 1
            If K_DESLOG = "OK" Then
                Try
                    'PROY-26366 LOG - INI
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INI Tipificaciones_general_canje() ")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "dsDatosPedido:  " & dsDatosPedido.ToString())
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Var_Corr6:  " & Var_Corr6)
                    Tipificaciones_general_canje(dsDatosPedido, Var_Corr6)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FIN Tipificaciones_general_canje() ")

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INI Tipificaciones_general_renovacionPre() ")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "dsDatosPedido:  " & dsDatosPedido.ToString())
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Var_Corr6:  " & Var_Corr6)
                    Tipificaciones_general_renovacionPre(dsDatosPedido, Var_Corr6)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FIN Tipificaciones_general_renovacionPre() ")

                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INI Tipificaciones_general_VentasVarios() ")
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "dsDatosPedido:  " & dsDatosPedido.ToString())
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Var_Corr6:  " & Var_Corr6)
                    Tipificaciones_general_VentasVarios(dsDatosPedido, Var_Corr6)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FIN Tipificaciones_general_VentasVarios() ")
                    'PROY-26366 LOG - FIN
                Catch ex As Exception

                End Try

            End If

            If K_DESLOG <> "OK" Then
                strErrorMsg = K_DESLOG & "Error al Pago"

                wParam5 = 0
                wParam6 = "Error en registro de Pago." & strErrorMsg
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "INI DeshacerCambiosFlujoDeCaja() ")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "IN P_ID_TI_VENTAS_FACT  " & P_ID_TI_VENTAS_FACT.ToString())
                DeshacerCambiosFlujoDeCaja(P_ID_TI_VENTAS_FACT, drPagos.Item("PEDIN_NROPEDIDO"))
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FIN DeshacerCambiosFlujoDeCaja() ")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR : " & strErrorMsg)
            End If

            ' If blnSunat Then
            ' If K_DESLOG = "OK" Then
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Valida si el pedido es una recarga virtual.")
            ' 'RecargaVirtual
            ' 'If Session("recargaVirtual") Then       'se agrego esta variable session
            ' '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Ejecuta el mètodo : Recarga ")
            ' '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- strNumAsignado: " & Funciones.CheckStr(strNumAsignado).ToString)
            ' '    Recarga(strNumAsignado)
            ' '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Fin del mètodo recarga.")
            ' 'End If

            ' RenovacionModemPrepago(dsPedido, drPagos.Item("PEDIN_NROPEDIDO"), "") 'Verificar

            ' ' Validacion Cambio de SIM 
            ' Dim tipoOperacion_PackPrepago As String = ConfigurationSettings.AppSettings("COD_OPERACION_RENOVACION")
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, "Tipo Operacion : " & ConfigurationSettings.AppSettings("strDTVReposicionChip"))
            ' If (sTipoOperacion = ConfigurationSettings.AppSettings("strDTVReposicionChip") Or sTipoOperacion = tipoOperacion_PackPrepago) Then

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, "Tipo Venta : " & ConfigurationSettings.AppSettings("strTVPostpago"))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, "Entro Tipo Operacion : " & sTipoOperacion)
            ' If sTipoVenta = ConfigurationSettings.AppSettings("strTVPostpago") Then
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, "Entro Tipo Venta : " & sTipoVenta)
            ' ActivaChipRespuestoPostPago(drPagos.Item("PEDIN_NROPEDIDO"), dsPedido)
            ' Else
            ' 'PREPAGO
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, "Entro Tipo Venta : " & sTipoVenta)
            ' ActivaChipRepuesto(drPagos.Item("PEDIN_NROPEDIDO"), strDocSunat, sTipoVenta, sTipoOperacion)
            ' End If
            ' End If

            ' AppmensajeCHIPRepuesto = ""

            ' End If
            ' End If

            'E76009 CEGP INICIO ***********************************************************************************'
            If Not Len(Trim(strErrorMsg)) > 0 Then
                registro_ventas(dsPedido, strIdentifyLog)
            End If
            'E76009 CEGP FIN************************************************************************************

            '' Roaming 
            If Not Len(Trim(strErrorMsg)) > 0 Then
                InsertarPlanRoaming(drPagos.Item("PEDIN_NROPEDIDO"))
            End If


            AppCarga = 0
            hidFlagCargaDoc = AppCarga


            If Len(Trim(strErrorMsg)) > 0 Then     'se produjo algun error al momento de pagar
                'Response.Write("<script>alert('" & strErrorMsg & "')</script>")
                AppstrMensajeCaja = strErrorMsg
                '/*----------------------------------------------------------------------------------------------------------------*/
                '/*--JR  INICIO  -  PROY-29380 IDEA-38934 - Iteración 2 y 3 2da Fase Sinergia Adec en Sist de Venta y Post-Venta --*/
                '/*----------------------------------------------------------------------------------------------------------------*/
                If Not AppmsgErrorDevolverRV Is Nothing And AppmsgErrorDevolverRV <> "" Then
                    'Session.Remove("strMensajeCaja")
                    AppstrMensajeCaja = String.Empty
                End If
                '/*----------------------------------------------------------------------------------------------------------------*/
                '/*--JR  INICIO  -  PROY-29380 IDEA-38934 - Iteración 2 y 3 2da Fase Sinergia Adec en Sist de Venta y Post-Venta --*/
                '/*----------------------------------------------------------------------------------------------------------------*/
                'Response.Redirect("PoolPagos.aspx", False)
                'Response.End()
                AppCodigoExitFunction = "-2"
                AppMensajeExitFunction = AppstrMensajeCaja
                Exit Function
            Else
                ' '''''''''''''''''''''''
                ' ' Inicio IDEA-11056 Renovación TFI para CAC's
                ' BonoRenovacionTFI(drPagos.Item("PEDIN_NROPEDIDO"), dsPedido, C_VENTA, C_VENTA_DET)
                ' ' Fin IDEA-11056 Renovación TFI para CAC's 

                ' ' If dsPedido.Tables(0).Rows(0).Item("TIPO_VENTA") = ConfigurationSettings.AppSettings("strTVPrepago") Then TODOEB
                ' If drPagos.Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVPrepago") Then
                ' ' Dim objFileLog As New SICAR_Log
                ' ' Dim nameFile As String = ConfigurationSettings.AppSettings("constNameLogWSBABB")
                ' ' Dim pathFile As String = ConfigurationSettings.AppSettings("constRutaLogWSBABB")
                ' ' Dim strArchivo As String = objFileLog.Log_CrearNombreArchivo(nameFile)
                ' ' Dim strIdentifyLog As String = drPagos.Item("VBELN")      'strNroPedidoSAP
                ' Dim strParametros As String = ""
                ' For k As Integer = 0 To dsPedido.Tables(1).Rows.Count - 1
                ' Dim strArregloCadena As String = ""
                ' strArregloCadena = ConfigurationSettings.AppSettings("strComboAnualBbPrepago") 'modificar key
                ' Dim arrCadenas As String() = strArregloCadena.Split(";")
                ' For m As Integer = 0 To UBound(arrCadenas)
                ' 'TODOEB
                ' 'If dsPedido.Tables(1).Rows(k).Item("ARTICULO") = arrCadenas(m) Then       ' SERCOANPRE

                ' '(validar porque no es necesario usar del pvu la consulta)

                ' If Not dsPedido.Tables(1) Is Nothing Then
                ' If Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("DEPEC_CODMATERIAL")) = arrCadenas(m) Then       ' SERCOANPRE
                ' Dim obj As New clsBonoComboAnualBB
                ' Dim intRst As Integer
                ' Dim strErrorMsj As String
                ' Dim usuarioBB As String = ConfigurationSettings.AppSettings("strUsuarioBB")
                ' Dim AplicacionRTC As String = ConfigurationSettings.AppSettings("strAplicacionRTC")
                ' Dim strMensajeBB As String
                ' Dim telefono As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("DEPEV_NROTELEFONO"))
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio WS Bono Combo Anual BalckBerry.")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Oficina Venta : " & AppAlmacen & " - " & AppOFICINA)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Usuario : " & AppUsuario)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo bonoBlackberryPrepago()")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Parametros INP: telefono " & FormatoTelefono(telefono) & "")

                ' intRst = obj.bonoBlackberryPrepago(FormatoTelefonoPrepago(telefono), ConfigurationSettings.AppSettings("urlComboAnualBbPrepago"), Integer.Parse(ConfigurationSettings.AppSettings("timeOutComboAnualBbPrepago")), usuarioBB, AplicacionRTC, strMensajeBB)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Parametros OUT: " & intRst)
                ' If intRst = 0 Then
                ' strErrorMsj = "Operación Exitosa\nEl bono lo seguirá recibiendo los 10 de cada mes."
                ' 'Session.Add("strMensajeWSCABB", strErrorMsj)
                ' AppstrMensajeWSCABB = strErrorMsj
                ' ElseIf intRst = 1 Then
                ' strErrorMsj = "Ha ocurrido un error, se procede con la venta\n"
                ' 'Session.Add("strMensajeWSCABB", strErrorMsj & " " & ValidaCadena(strMensajeBB))
                ' AppstrMensajeWSCABB = strErrorMsj
                ' Else
                ' strErrorMsj = "Error\nOcurrio un error inesperado."
                ' 'Session.Add("strMensajeWSCABB", strErrorMsj & " " & ValidaCadena(strMensajeBB))
                ' AppstrMensajeWSCABB = strErrorMsj
                ' End If
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje:" & strErrorMsj)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje:" & ValidaCadena(strMensajeBB))
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo bonoBlackberryPrepago()")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin WS Bono Combo Anual BalckBerry.")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                ' End If
                ' End If
                ' Next

                ' 'Activacion Bono Anual TFI  (validar porque no es necesario usar del pvu la consulta)
                ' 'CONFIRMAR
                ' 'If dsPedido.Tables(1).Rows(k).Item("ARTICULO") = ConfigurationSettings.AppSettings("strCodArticuloBonoAnualTFI").ToString() Then
                ' If Not dsPedido.Tables(1) Is Nothing Then
                ' If Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("DEPEC_CODMATERIAL")) = ConfigurationSettings.AppSettings("strCodArticuloBonoAnualTFI").ToString() Then
                ' Dim objActivacion As New COM_SIC_Activaciones.clsActivacion
                ' Dim strCodRespuesta As String
                ' Dim strMsg As String = ""
                ' Dim telefono As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("DEPEV_NROTELEFONO"))
                ' Dim nombreServer As String = System.Net.Dns.GetHostName
                ' Dim IPAplicacion As String = System.Net.Dns.GetHostByName(nombreServer).AddressList(0).ToString
                ' Dim strAplicacion As String = ConfigurationSettings.AppSettings("constAplicacion").ToString()
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio WS EjecutarBonoAnualTFI.")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                ' 'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " INP DEPEV_NROTELEFONO:" & FormatoTelefono(dsPedido.Tables(1).Rows(k).Item("CLIEV_TELEFONOCLIENTE")))
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " INP DEPEV_NROTELEFONO:" & FormatoTelefono(telefono))
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " INP idTransaccion:" & strDocSap)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " INP IPAplicacion:" & IPAplicacion)

                ' strCodRespuesta = objActivacion.EjecutarBonoAnualTFI(FormatoTelefono(telefono), strDocSap, IPAplicacion, strAplicacion, strMsg)

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " OUT strCodRespuesta:" & strCodRespuesta)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " OUT strMsg:" & strMsg)
                ' objActivacion = Nothing

                ' If strCodRespuesta = "0" Then
                ' strMsg = "Operación Exitosa\nSe realizó el registro del Bono Anual TFI."
                ' 'Session.Add("strMensajeWSCABB", strMsg)
                ' AppstrMensajeWSCABB = strMsg
                ' ElseIf strCodRespuesta = "2" Or strCodRespuesta = "3" Or strCodRespuesta = "4" Then
                ' ' Session.Add("strMensajeWSCABB", strMsg)
                ' AppstrMensajeWSCABB = strMsg
                ' Else
                ' strMsg = "Ha ocurrido un error en el registro del Bono Anual TFI.\n"
                ' 'Session.Add("strMensajeWSCABB", strMsg)
                ' AppstrMensajeWSCABB = strMsg
                ' End If
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin WS EjecutarBonoAnualTFI.")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")

                ' End If
                ' End If
                ' Next
                ' End If

                ' 'Miguel - Activación de  equipos TFI
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "TIPO_VENTA: " & drPagos.Item("PEDIC_TIPOVENTA"))
                ' 'If dsPedido.Tables(0).Rows(0).Item("TIPO_VENTA") = ConfigurationSettings.AppSettings("strTVTFI") And booDol = True  Then
                ' ' Validar si ahora los tipos de venta TFI como se considera en el modulo

                ' ''Queda Pendiente TFI
                ' 'If cod_Prod_TFI = ConfigurationSettings.AppSettings("Cod_Producto_Prepago_TFI") Or _
                ' '   tipo_venta_pvu = ConfigurationSettings.AppSettings("strTVTFI") Then

                ' 'End If
                ' If drPagos.Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVTFI") Then
                ' 'Miguel - Variables para Log
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Activacion TFI")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")

                ' Dim transaccion As String = ConfigurationSettings.AppSettings("strActivacionTFI")
                ' Dim codUsuario As String = AppCodUsuario
                ' Dim strIPServidor As String = AppREMOTE_ADDR
                ' Dim strNombreServidor As String = AppSERVER_NAME
                ' Dim strIPCliente As String = AppUserHostAddress
                ' Dim strNombreCliente As String = System.Net.Dns.GetHostByAddress(strIPCliente).HostName

                ' Dim objActivacion As New COM_SIC_Activaciones.clsActivacion
                ' Dim objLog As New COM_SIC_Cajas.clsLog

                ' Dim resultadoLineasActivadas As String = ""
                ' Dim numerosValidados As String = ""

                ' Dim dsParam As DataSet

                ' Dim objSicarDB As New COM_SIC_Cajas.clsCajas
                ' Dim strGrupo As String = ConfigurationSettings.AppSettings("strGrupoTFI")

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio FP_ConsultaParametros")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     Inp: " & strGrupo)
                ' dsParam = objSicarDB.FP_ConsultaParametros(strGrupo) ' JRM - MAP 08
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     OUT CantidadRegistros:  " & Funciones.CheckStr(dsParam.Tables(0).Rows.Count))
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin FP_ConsultaParametros")
                ' objSicarDB = Nothing

                ' Dim k As Integer


                ' ''''C_VENTA_DET
                ' For k = 0 To dsPedido.Tables(1).Rows.Count - 1
                ' 'For k = 0 To C_VENTA_DET.Rows.Count - 1
                ' Dim strNumero As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("DEPEV_NROTELEFONO"))
                ' 'Dim strNumero As String = C_VENTA_DET.Rows(k).Item("TELEFONO")
                ' 'Dim strPreciosUti As String = C_VENTA_DET.Rows(k).Item("LISTA_PRECIO") 'dsPedido.Tables(1).Rows(k).Item("UTILIZACION")
                ' Dim strPreciosUti As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("DEPEV_CODIGOLP"))
                ' Dim strFormaPago As String = ""       '1 -Contado : 2- Cuotas
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strNumero: " & strNumero)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strPreciosUti(buscar): " & strPreciosUti)

                ' If Not IsNothing(dsParam) AndAlso dsParam.Tables(0).Rows.Count > 0 Then
                ' For idx As Integer = 0 To dsParam.Tables(0).Rows.Count - 1
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     OUT SPARV_KEY:  " & Funciones.CheckStr(dsParam.Tables(0).Rows(idx).Item("SPARV_KEY")))
                ' If Funciones.CheckStr(dsParam.Tables(0).Rows(idx).Item("SPARV_KEY")).Equals(strPreciosUti) Then
                ' strFormaPago = Funciones.CheckStr(dsParam.Tables(0).Rows(idx).Item("SPARV_VALUE"))
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     OUT SPARV_VALUE:  " & Funciones.CheckStr(dsParam.Tables(0).Rows(idx).Item("SPARV_VALUE")))
                ' Exit For
                ' End If
                ' Next
                ' End If

                ' Dim strParamsIn As String
                ' Dim strParamsOut As String
                ' Dim strResultado As String
                ' Dim strMensajeTFI As String
                ' Dim strTransaccion As String
                ' If strNumero <> String.Empty Or strNumero.ToString <> "" Or strFormaPago <> String.Empty Then
                ' If numerosValidados.IndexOf(CDbl(strNumero).ToString()) = -1 Then
                ' Try
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio FK_EjecutarActivacionTFI")
                ' strParamsIn = "telefono: " + CDbl(strNumero).ToString() + " opcion: " + strFormaPago
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strParamsIn: " & strParamsIn)

                ' Call objActivacion.FK_EjecutarActivacionTFI(CDbl(strNumero).ToString(), strFormaPago, strResultado, strMensajeTFI, strTransaccion)

                ' strParamsOut = "resultado: " + strResultado + " Mensaje: " & strMensajeTFI & " transaccion: " + strTransaccion
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     strParamsOut: " & strParamsOut)
                ' objLog.FK_RegistrarLog(transaccion, codUsuario, strIPCliente, strNombreCliente, strIPServidor, strNombreServidor, strParamsIn, strParamsOut, "")
                ' Catch ex As Exception

                ' strParamsOut = "resultado: " + strResultado + " transaccion: " + strTransaccion

                ' 'INI PROY-140126
                ' Dim MaptPath As String
                ' MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                ' MaptPath = "( Class : " & MaptPath & "; Function: guardarConectado)"
                ' objLog.FK_RegistrarLog(transaccion, codUsuario, strIPCliente, strNombreCliente, strIPServidor, strNombreServidor, strParamsIn, strParamsOut, ex.Message & MaptPath)
                ' 'FIN PROY-140126
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     ERROR: " & ex.Message.ToString())
                ' strResultado = "1"
                ' Finally
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin FK_EjecutarActivacionTFI")
                ' End Try
                ' numerosValidados += CDbl(strNumero).ToString() & "|"
                ' If strResultado <> "0" Then
                ' resultadoLineasActivadas += CDbl(strNumero).ToString() & "|"
                ' End If
                ' End If
                ' End If
                ' Next
                ' If resultadoLineasActivadas.Trim <> "" Then
                ' Dim arrLineas() As String = resultadoLineasActivadas.Split("|")
                ' Dim x As Integer
                ' Dim mensaje As String = ConfigurationSettings.AppSettings("msjeErrorActivarLinea")
                ' For x = 0 To arrLineas.Length - 1
                ' mensaje += "\n" & arrLineas(x)
                ' Next
                ' AppmensajeErrorLineas = mensaje
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " Líneas TFI con ERROR en activación: " & resultadoLineasActivadas)
                ' End If
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Activacion TFI")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")

                ' 'Migración Saldo TFI  PLSR -- Solo las líneas sin error en la activación
                ' Dim conPag As New COM_SIC_Activaciones.clsMigracionSaldoGSMWS
                ' Dim oDatosInteraccion As New clsDatosInteraccion
                ' Try
                ' Dim str_Aplicacion As String = ConfigurationSettings.AppSettings("constAplicacion").ToString
                ' Dim idTransaccion As String = strDocSap
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Migración Saldo TFI")
                ' 'TODOEB      
                ' '  For k = 0 To dsPedido.Tables(1).Rows.Count - 1
                ' For k = 0 To dsPedido.Tables(1).Rows.Count - 1
                ' 'Dim strMaterial As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("DEPEC_CODMATERIAL")) 'TODOEB
                ' Dim strMaterial As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("MATEV_CLASIFICACION"))
                ' 'Campania - Plan_final
                ' 'Dim strMaterial As String = C_VENTA_DET.Rows(k).Item("MATERIAL")

                ' If strMaterial.StartsWith("PS") Then
                ' Dim str_Campana As String = Campania 'C_VENTA_DET.Rows(k).Item("CAMPANA") 'dsPedido.Tables(1).Rows(k).Item("CAMPANA")
                ' Dim str_Tarifa As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("DEPEV_CODIGOLP")) 'C_VENTA_DET.Rows(0).Item("LISTA_PRECIO") 'dsPedido.Tables(1).Rows(k).Item("UTILIZACION")

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "CAMPANA: " & str_Campana)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "UTILIZACION: " & str_Tarifa)

                ' If (str_Campana = ConfigurationSettings.AppSettings("strCampanaMensual").ToString And str_Tarifa = ConfigurationSettings.AppSettings("strTarifaMensual").ToString) Or _
                ' (str_Campana = ConfigurationSettings.AppSettings("strCampanaAnual").ToString And str_Tarifa = ConfigurationSettings.AppSettings("strTarifaAnual").ToString) Then

                ' ' Dim strNumeroTelefono As String = FormatoTelefonoSinCeros(dsPedido.Tables(1).Rows(k).Item("CLIEV_TELEFONOCLIENTE"))
                ' Dim strNumeroTelefono As String = FormatoTelefonoSinCeros(Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("DEPEV_NROTELEFONO"))) 'FormatoTelefonoSinCeros(C_VENTA_DET.Rows(k).Item("TELEFONO"))

                ' Dim rpta As Integer = objCajas.Registrar_Migracion_Saldo(strNumeroTelefono)

                ' If resultadoLineasActivadas.IndexOf(strNumeroTelefono) = -1 Then
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Inicio de envio al WS Registrar Migracion")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "NumeroTelefono: " & FormatoTelefono(C_VENTA_DET.Rows(k).Item("TELEFONO")))
                ' oDatosInteraccion = conPag.RegistrarMigracionSaldo(idTransaccion, strIPServidor, str_Aplicacion, codUsuario, strNumeroTelefono)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "CodigoRespuesta: " & oDatosInteraccion.Codigo_Respuesta)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "MensajeRespuesta: " & oDatosInteraccion.Mensaje_Respuesta())
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Fin de envio al WS Registrar Migracion")

                ' If oDatosInteraccion.Codigo_Respuesta <> "0" Then
                ' 'Session.Add("msgErrorMigracionSaldoTFI", oDatosInteraccion.Mensaje_Respuesta())
                ' AppmsgErrorMigracionSaldoTFI = oDatosInteraccion.Mensaje_Respuesta()
                ' End If
                ' End If
                ' End If
                ' End If
                ' Next
                ' Catch ex As Exception
                ' 'INI PROY-140126
                ' Dim MaptPath As String
                ' MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                ' MaptPath = "( Class : " & MaptPath & "; Function: guardarConectado)"
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "ERROR: " & ex.Message.ToString() & MaptPath)
                ' 'FIN PROY-140126
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "ERROR: " & ex.StackTrace.ToString())
                ' 'Session.Add("msgErrorMigracionSaldoTFI", "Error al realizar migración de saldo TFI.")
                ' AppmsgErrorMigracionSaldoTFI = "Error al realizar migración de saldo TFI."
                ' Finally
                ' oDatosInteraccion = Nothing
                ' conPag = Nothing
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Migración Saldo TFI")
                ' End Try
                ' End If

                ' Registro Renovacion RPM6
                Dim strTelefono As String
                Dim strCodArticulo As String


                'If dsPedido.Tables(0).Rows(0).Item("TIPO_VENTA") = ConfigurationSettings.AppSettings("strTVPrepago") Then
                'Validar que se podria utilizar la data del modulo 
                If drPagos.Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVPrepago") Then
                    ' For idx As Integer = 0 To dsPedido.Tables(1).Rows.Count - 1
                    If Not dsPedido.Tables(1) Is Nothing Then
                        For idx As Integer = 0 To dsPedido.Tables(1).Rows.Count - 1
                            strCodArticulo = Funciones.CheckStr(dsPedido.Tables(1).Rows(idx).Item("DEPEC_CODMATERIAL"))
                            strTelefono = Funciones.CheckStr(dsPedido.Tables(1).Rows(idx).Item("DEPEV_NROTELEFONO"))
                            If strCodArticulo = ConfigurationSettings.AppSettings("strCodArticuloRenovacion") Then
                                RegistrarPagoRenovacionRPM6(strTelefono)
                            End If
                        Next
                    End If
                End If
                ' Registro Renovacion RPM6

                ' 'Renovacion Corporativa
                ' 'If dsPedido.Tables(0).Rows(0).Item("TIPO_VENTA") = ConfigurationSettings.AppSettings("strTVPostpago") Then
                ' If drPagos.Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVPostpago") Then

                ' ' Dim p_nro_pedido As String = dsPedido.Tables(0).Rows(0).Item("DOCUMENTO") TODOEB
                ' Dim p_nro_pedido As String = dsPedido.Tables(0).Rows(0).Item("PEDIN_NROPEDIDO")

                ' 'Renovacion B2E
                ' 'If dsPedido.Tables(0).Rows(0).Item("CLASE_VENTA") = ConfigurationSettings.AppSettings("constCodRenovB2E") Then
                ' If dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION") = ConfigurationSettings.AppSettings("constCodRenovB2E") Then
                ' GrabarPagoRenovacion(p_nro_pedido, "B2E")
                ' GrabarRenovCorpBSCS(p_nro_pedido, "B2E")
                ' End If

                ' 'Renovacion Business
                ' 'If dsPedido.Tables(0).Rows(0).Item("CLASE_VENTA") = ConfigurationSettings.AppSettings("constCodRenovBus") Then
                ' If dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION") = ConfigurationSettings.AppSettings("constCodRenovBus") Then

                ' 'If dsPedido.Tables(0).Rows(0).Item("TIPO_DOC_CLIENTE") = ConfigurationSettings.AppSettings("constDocClienteBus") Then
                ' If dsPedido.Tables(0).Rows(0).Item("CLIEC_TIPODOCCLIENTE") = ConfigurationSettings.AppSettings("constDocClienteBus") Then
                ' GrabarPagoRenovacion(p_nro_pedido, "B2E")
                ' GrabarRenovCorpBSCS(p_nro_pedido, "B2E")
                ' End If
                ' End If
                ' End If
                ' 'Renovacion Corporativa

                ' 'Miguel - Activación de ciertos equipos PREPAGO                
                ' Dim resultadoLineasNoActivadas As String = ""
                ' If dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVPrepago") Then
                ' Try
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Activacion Bono Prepago Especial")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")

                ' Dim k As Integer
                ' 'For k = 0 To dsPedido.Tables(1).Rows.Count - 1
                ' If Not dsPedido.Tables(1) Is Nothing Then
                ' 'For k = 0 To C_VENTA_Prepago.Rows.Count - 1
                ' For k = 0 To dsPedido.Tables(1).Rows.Count - 1
                ' 'Dim strEquipo As String = C_VENTA_DET.Rows(k).Item("MATERIAL")
                ' 'Dim strNumero As String = FormatoTelefono(C_VENTA_DET.Rows(k).Item("TELEFONO"))
                ' 'Dim strListaPrecio As String = C_VENTA_DET.Rows(0).Item("LISTA_PRECIO") 'dsPedido.Tables(1).Rows(k).Item("UTILIZACION")
                ' 'Dim strCampana As String = C_VENTA_DET.Rows(0).Item("PLAN") 'dsPedido.Tables(1).Rows(k).Item("CAMPANA")
                ' Dim strEquipo As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("DEPEC_CODMATERIAL")) 'modulo
                ' Dim strNumero As String = FormatoTelefono(Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("DEPEV_NROTELEFONO"))) 'modulo
                ' Dim strListaPrecio As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("DEPEV_CODIGOLP"))  'modulo dsPedido.Tables(1).Rows(k).Item("UTILIZACION")
                ' Dim clase_Material As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("MATEV_CLASIFICACION"))
                ' Dim strCampana As String = Campania 'dsPedido.Tables(1).Rows(k).Item("CAMPANA")
                ' Dim strResultado As String
                ' 'I-plsr
                ' Dim strGrupoConEquipo = ConfigurationSettings.AppSettings("constGrupoPrepagoEspecial")
                ' Dim strGrupoSinEquipo = ConfigurationSettings.AppSettings("constGrupoPrepagoEspecialSinEquipo")
                ' 'F-plsr
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		strEquipo(" & k & "): " & strEquipo)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		strNumero(" & k & "): " & strNumero)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		strListaPrecio(" & k & "): " & strListaPrecio)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		strCampana(" & k & "): " & strCampana)

                ' If clase_Material.StartsWith("PS") Then  'chips
                ' Dim blnConEquipo As Boolean
                ' blnConEquipo = validaVentaEquipo(strNumero, dsPedido.Tables(1)) ' CURSOR FDEL DETALLE DEL PEDIDO
                ' Try
                ' Dim CodOpcion As String
                ' If blnConEquipo Then
                ' CodOpcion = Get_CodOpcionBBA(strEquipo, strListaPrecio, strCampana, strGrupoConEquipo, strDocSap)
                ' Else
                ' CodOpcion = Get_CodOpcionBBA(strEquipo, strListaPrecio, strCampana, strGrupoSinEquipo, strDocSap)
                ' End If
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		blnConEquipo: " & blnConEquipo)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		CodOpcion: " & CodOpcion)

                ' If CodOpcion <> "" Then
                ' strResultado = EjecutarActivacionBono(strNumero, CodOpcion, strDocSap)
                ' Else
                ' strResultado = "999"  ' No es prepago especial
                ' End If
                ' Catch ex As Exception
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error : " & ex.Message.ToString())
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error : " & ex.StackTrace.ToString())
                ' strResultado = "1"        'Se cambió Codigo Error 0:OK  
                ' End Try

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		strResultado: " & strResultado)

                ' Dim strMensajeRes As String
                ' If strResultado <> "999" And strResultado <> "0" Then
                ' Dim dsValConfirma As DataSet
                ' Dim l As Integer
                ' dsValConfirma = ValMensajeParametros(strDocSap)

                ' 'Se obtiene el mensaje por código de respuesta (tabla de parámetros)
                ' For l = 0 To dsValConfirma.Tables(0).Rows.Count - 1
                ' If strResultado = dsValConfirma.Tables(0).Rows(l).Item("SPARV_KEY") Then
                ' strMensajeRes = dsValConfirma.Tables(0).Rows(l).Item("SPARV_VALUE")
                ' Exit For
                ' End If
                ' Next
                ' resultadoLineasNoActivadas += CDbl(strNumero).ToString() & " " & strMensajeRes & "|"
                ' End If
                ' End If
                ' Next
                ' End If

                ' If resultadoLineasNoActivadas.Trim <> "" Then
                ' Dim arrLineas() As String = resultadoLineasNoActivadas.Split("|")
                ' Dim x As Integer
                ' Dim mensaje As String '= ConfigurationSettings.AppSettings("msjeErrorActivarLinea")
                ' For x = 0 To arrLineas.Length - 1
                ' mensaje += arrLineas(x) & "\n"
                ' Next
                ' AppmensajeErrorLineas = mensaje
                ' End If
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		mensajeErrorLineas: " & Funciones.CheckStr(AppmensajeErrorLineas))

                ' Catch ex As Exception
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		ERROR: " & ex.Message.ToString())
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		ERROR: " & ex.StackTrace.ToString())
                ' Finally
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Activacion Bono Prepago Especial")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                ' End Try
                ' End If
                ' 'Fin de Activación de los PREPAGOS

                ' AppnumeroTelefonoPel = ""
                ' ' E75893 - Registro de DOL y Creacion Interaccion solo Ventas Altas Prepago
                ' If ValidacionVentaDOL(drPagos.Item("PEDIN_NROPEDIDO"), CStr(drPagos.Item("PEDIN_NROPEDIDO"))) Then
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "VBELN: " & Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")))
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ALMACEN: " & AppAlmacen)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "txtNumSunat: " & txtNumSunat.Trim)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FKDAT: " & DateTime.Now)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "sTipoOperacion: " & sTipoOperacion)
                ' 'RegistrarDOL(drPagos.Item("VBELN"), resultadoLineasNoActivadas) TODOEB
                ' 'RegistrarDOL(drPagos.Item("PEDIN_NROPEDIDO"), resultadoLineasNoActivadas, True, strTelefonoNumero, strRegistroDOLRespuesta)
                ' 'PROY-24388 RAR INICIO
                ' Dim strDescripcionError As String = ""
                ' Dim strTelefonoNumero = String.Empty
                ' Dim strRegistroDOLRespuesta = String.Empty
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo pagarCAC() " & CStr(drPagos.Item("PEDIN_NROPEDIDO")))
                ' If (pagarCAC(drPagos.Item("PEDIN_NROPEDIDO"), AppAlmacen, txtNumSunat.Trim, DateTime.Now, sTipoOperacion, strDescripcionError, strTelefonoNumero, strRegistroDOLRespuesta)) = False Then
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Respuesta Pagar CAC: " & strDescripcionError)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Nro Telefono: " & strTelefonoNumero)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Respuesta Registro Dol: " & strRegistroDOLRespuesta)
                ' 'Session.Add("msgActivacionCAC", strDescripcionError)
                ' AppmsgActivacionCAC = strDescripcionError
                ' Else
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Respuesta Pagar CAC: " & strDescripcionError)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Nro Telefono: " & strTelefonoNumero)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Respuesta Registro Dol: " & strRegistroDOLRespuesta)
                ' 'Session.Add("msgActivacionCAC", strDescripcionError)
                ' AppmsgActivacionCAC = strDescripcionError
                ' RegistrarDetalleDOL(drPagos.Item("PEDIN_NROPEDIDO"), resultadoLineasNoActivadas, True)
                ' RegistrarCobertura(strIdentifyLog, int64IdVenta, strTelefonoNumero, strDocumentoIdentidadNumero)

                ' Dim strVentaTipo As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA"))
                ' Dim strVentaPrepago As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("strTVPrepago"))
                ' If blnPagoRealizado And strVentaTipo.Equals(strVentaPrepago) Then
                ' RegistrarAceptacionContrato(strIdentifyLog, strTelefonoNumero, strRegistroDOLRespuesta)
                ' End If
                ' End If
                ' 'PROY-24388 RAR FIN
                ' End If

                ' 'Bono Renovacion Prepago - Ugo Blanco
                ' If blnSunat Then
                ' If (dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVPrepago")) And _
                ' (ConfigurationSettings.AppSettings("Tipo_operacion_Reno_bono_Pre").IndexOf(Funciones.CheckStr(tipo_venta_pvu)) > -1) Then
                ' 'Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION")) = ConfigurationSettings.AppSettings("strDTVRenovacion") Then

                ' Dim vIdTransaccion, vMsisdn, vImei, vArticulo, vRespuesta, vRespuestaMsj, vMensaje As String
                ' Dim Pedido_reno As String = ""
                ' 'TODOEB
                ' '  vIdTransaccion = CStr(drPagos.Item("PEDIDO"))
                ' vIdTransaccion = CStr(drPagos.Item("PEDIN_NROPEDIDO"))
                ' 'For k As Integer = 0 To dsPedido.Tables(1).Rows.Count - 1

                ' Try
                ' If Not dsPedido.Tables(1) Is Nothing Then
                ' If dsPedido.Tables(1).Rows.Count = 1 Then
                ' 'For k As Integer = 0 To dsPedido.Tables(1).Rows.Count - 1
                ' '    If (Funciones.CheckStr(dsPedido.Tables(1).Rows(k).Item("MATEC_TIPOMATERIAL")) = ConfigurationSettings.AppSettings("constPacks")) Then
                ' '        vMsisdn = "51" & Right(dsPedido.Tables(1).Rows(k).Item("DEPEV_NROTELEFONO"), 9)
                ' '        vImei = Right(dsPedido.Tables(1).Rows(k).Item("SERIC_CODSERIE"), 15)
                ' '        vArticulo = dsPedido.Tables(1).Rows(k).Item("DEPEC_CODMATERIAL")
                ' '    End If
                ' 'Next
                ' If (Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("MATEC_TIPOMATERIAL")) = ConfigurationSettings.AppSettings("constPacks")) Then
                ' Pedido_reno = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("MATEC_TIPOMATERIAL"))
                ' vMsisdn = "51" & Right(dsPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO"), 9)
                ' vImei = Right(dsPedido.Tables(1).Rows(0).Item("SERIC_CODSERIE"), 15)
                ' vArticulo = dsPedido.Tables(1).Rows(0).Item("DEPEC_CODMATERIAL")
                ' Else
                ' Pedido_reno = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("MATEC_TIPOMATERIAL"))
                ' vMsisdn = ""
                ' vImei = ""
                ' vArticulo = ""
                ' End If
                ' End If
                ' End If
                ' Catch ex As Exception
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR : Bono Renovacion Prepago")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR : " & ex.Message.ToString())
                ' vMsisdn = ""
                ' vImei = ""
                ' vArticulo = ""
                ' End Try


                ' 'If ConfigurationSettings.AppSettings("ConsFlagRenovPrepago") Or _
                ' '    InStr(1, ConfigurationSettings.AppSettings("ConsLineasRenovPrepago"), vMsisdn) > 0 Then
                ' Dim montoVenta, montoVentaSinIgv, origenProceso As String

                ' 'PROY-31766 - INICIO'
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & vMsisdn & "- " & "IGV ACTUAL: " & dblValorIGVActual)
                ' Dim constIGV As Double = dblValorIGVActual 'ObtenerIGVActual()
                ' 'PROY-31766 - FIN'
                ' 'montoVenta = CheckStr(CheckDbl(drPagos.Item("INPAN_TOTALDOCUMENTO")) * 100)
                ' montoVenta = Funciones.CheckDbl(drPagos.Item("INPAN_TOTALDOCUMENTO"))
                ' 'montoVentaSinIgv = CheckStr((CheckDbl(drPagos.Item("TOTAL")) / (1 + constIGV)) * 100)TODOEB
                ' montoVentaSinIgv = CheckStr(CheckDbl(drPagos.Item("INPAN_TOTALDOCUMENTO")) / (1 + constIGV))
                ' 'montoVentaSinIgv = CheckStr((CheckDbl(drPagos.Item("INPAN_TOTALDOCUMENTO")) / (1 + constIGV)) * 100)

                ' origenProceso = ConfigurationSettings.AppSettings("WSBonoPrepago_codOrigenProceso")

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & vMsisdn & "- " & " montoVenta : " & montoVenta)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & vMsisdn & "- " & " montoVentaSinIgv : " & montoVentaSinIgv)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & vMsisdn & "- " & " origenProceso : " & origenProceso)

                ' Dim input As String = String.Format("{0}|{1}|{2}|{3}|{4}|{5}", vMsisdn, vArticulo, vImei, montoVenta, montoVentaSinIgv, origenProceso)

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & vMsisdn & "- " & "Inicio Bono Renovación Prepago")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & vMsisdn & "- " & " MATEC_TIPOMATERIAL : " & Pedido_reno)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & vMsisdn & "- " & "  flag_ped_repo : " & flag_ped_repo)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & vMsisdn & "- " & "     nroLinea|material|imei|montoVenta|montoVentaSinIgv|origenProceso: " & input)

                ' If Pedido_reno = ConfigurationSettings.AppSettings("constPacks") Then
                ' 'Registro Bono Prepago
                ' Dim oRenovaPrepago As New COM_SIC_Activaciones.clsBonoRenovaPrepago
                ' vRespuesta = oRenovaPrepago.AsignarBonoPrepago(vIdTransaccion, vMsisdn, vImei, vArticulo, montoVenta, montoVentaSinIgv, origenProceso, vRespuestaMsj)

                ' 'Consulta de Mensaje Renovación Prepago
                ' Dim codGrupo As Integer = CInt(ConfigurationSettings.AppSettings("ConstGrupoMensajeAsignacion"))
                ' Dim dsMensajes As DataSet = (New COM_SIC_Cajas.clsCajas).ObtenerParamByGrupo(codGrupo)
                ' If Not IsNothing(dsMensajes) Then
                ' For i = 0 To dsMensajes.Tables(0).Rows.Count - 1
                ' Dim codigo As String = CheckStr(dsMensajes.Tables(0).Rows(i).Item("PARAV_VALOR")).Split("|")(0)
                ' Dim mensaje As String = CheckStr(dsMensajes.Tables(0).Rows(i).Item("PARAV_VALOR")).Split("|")(1)

                ' If codigo = vRespuesta Then
                ' vMensaje = String.Format(mensaje, vMsisdn)
                ' Exit For
                ' End If
                ' Next
                ' End If

                ' 'Session.Add("mensajeErrorBonoPrepago", vMensaje)
                ' AppmensajeErrorBonoPrepago = vMensaje

                ' Dim out As String = String.Format("{0}|{1}|{2}", vRespuesta, vRespuestaMsj, vMensaje)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & vMsisdn & "- " & "     codSalida|msgSalida|Mensaje: " & out)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & vMsisdn & "- " & "Fin Bono Renovación Prepago")
                ' Else
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & vMsisdn & "- " & "NO se asigno bono Renovacion, es Venta prepago y el tipo de material no es equipo o tiene 2 detalles")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & vMsisdn & "- " & "Fin Bono Renovación Prepago")
                ' End If
                ' End If
                ' End If


                ' 'End If
                ' 'Bono Renovacion Prepago - Ugo Blanco

                ' 'roaming
                ' Try
                ' 'Dim dsPedido As New DataSet
                ' 'dsPedido = (New SapGeneralNegocios).Get_ConsultaPedido("", Session("Almacen"), sDocumentoSap, "")
                ' Dim dtDet As DataTable = CType(dsPedido.Tables(1), DataTable)
                ' Dim nroTelefono = Right(Funciones.CheckStr(dtDet.Rows(0)("DEPEV_NROTELEFONO")), 9)
                ' Dim Flag As String = "S"
                ' Dim retorno As Int64 = 0
                ' Dim mensaje As String = ""
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & strDocSap & "- " & "Inicio Actualizacion Servicio Roaming")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & strDocSap & "- " & "Telefono: " & nroTelefono)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & strDocSap & "- " & "Flag: " & Flag)
                ' objCajas.ActualizarServRoaming(strDocSap, nroTelefono, Flag, retorno, mensaje)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & strDocSap & "- " & "retorno: " & retorno)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & strDocSap & "- " & "mensaje: " & mensaje)
                ' Catch ex As Exception
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & strDocSap & "- " & "Error Actualizacion Servicio Roaming")
                ' Finally
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & strDocSap & "- " & "Fin Actualizacion Servicio Roaming")
                ' End Try

                ' 'registro metricas
                ' Try
                ' 'objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("VBELN") & "- " & "Inicio Registro de Metricas Ventas")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("PEDIN_NROPEDIDO") & "- " & "Inicio Registro de Metricas Ventas")
                ' Dim oMet As New COM_SIC_Activaciones.clsActivacion
                ' Dim oAudit As New ItemGenerico
                ' Dim oCabecera As New ArrayList
                ' Dim oDetalle As New ArrayList
                ' Dim nomCob As String = ""
                ' Dim filas As Integer

                ' 'strContrato = drPagos.Item("NRO_CONTRATO")TODOEB
                ' '*********************************************************************************************************************************************************************'
                ' '**Error, debido a que consulta el ID_Contrato en la tabla : sisact_info_venta_sap porl el numero del contrato del pedido => sap.nro_documento = p_nrodoc_sap
                ' If Not objContrato Is Nothing Then
                ' strContrato = objContrato.Tables(0).Rows(0).Item("ID_CONTRATO")
                ' If Funciones.CheckInt(strContrato) > 0 Then
                ' 'dsAcuerdo = objPagos.Get_ConsultaAcuerdoPCS(strContrato)           'conexion SAP
                ' dsAcuerdo = objClsConsultaPvu.ConsultaAcuerdoPCS(strContrato, DBNull.Value)
                ' End If
                ' End If
                ' '*********************************************************************************************************************************************************************'

                ' 'objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("VBELN") & "- " & "Nro contrato" & "- " & strContrato)
                ' 'objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("VBELN") & "- " & "Inicio Registro de Metricas Ventas")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("PEDIN_NROPEDIDO") & "- " & "Nro contrato" & "- " & strContrato)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("PEDIN_NROPEDIDO") & "- " & "Inicio Registro de Metricas Ventas")
                ' With oAudit
                ' '.CODIGO = drPagos.Item("VBELN") TODOEB
                ' .CODIGO = drPagos.Item("PEDIN_NROPEDIDO")
                ' .CODIGO2 = CurrentUser
                ' .DESCRIPCION = ConfigurationSettings.AppSettings("constAplicacion")
                ' .DESCRIPCION2 = CurrentTerminal
                ' End With
                ' 'obtenerDatosMetrica(dsPedido, dsAcuerdo, oCabecera, oDetalle) TODOE

                ' Dim sDatosCabecera As String
                ' For Each item As ItemGenerico In oCabecera
                ' item.DESCRIPCION = item.DESCRIPCION.ToUpper()
                ' sDatosCabecera &= item.CODIGO & ": " & item.DESCRIPCION & "|"
                ' Next
                ' Dim sDatosDetalle As String
                ' For Each item As ItemGenerico In oDetalle
                ' item.DESCRIPCION = item.DESCRIPCION.ToUpper()
                ' sDatosDetalle &= item.CODIGO & ": " & item.DESCRIPCION & "|"
                ' Next

                ' 'objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("VBELN") & "- " & "Inicio registrarMetricaVentas " & ConfigurationSettings.AppSettings("WSRegMetricaVenta_url")) TODOEB
                ' 'objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("VBELN") & "- " & "sDatosCabecera: " & sDatosCabecera) TODOEB
                ' 'objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("VBELN") & "- " & "sDatosDetalle: " & sDatosDetalle) TODOEB

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("PEDIN_NROPEDIDO") & "- " & "Inicio registrarMetricaVentas " & ConfigurationSettings.AppSettings("WSRegMetricaVenta_url"))
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("PEDIN_NROPEDIDO") & "- " & "sDatosCabecera: " & sDatosCabecera)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("PEDIN_NROPEDIDO") & "- " & "sDatosDetalle: " & sDatosDetalle)

                ' 'oMet.registrarMetricaVentas(oAudit, oCabecera, oDetalle) TODOE
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("PEDIN_NROPEDIDO") & "- " & "Fin registrarMetricaVentas")
                ' Catch ex As Exception
                ' Try
                ' Dim strHTMLCuerpo As String
                ' strHTMLCuerpo = "<HTML>"
                ' strHTMLCuerpo = strHTMLCuerpo & "<HEAD></HEAD><BODY><table>"
                ' strHTMLCuerpo = strHTMLCuerpo & "<tr><td>" & ConfigurationSettings.AppSettings("RegMetricaCorreo_Titulo") & "</tr></td>"
                ' strHTMLCuerpo = strHTMLCuerpo & "<tr><td>   ERROR: " & ex.Message.ToString() & "</tr></td>"
                ' strHTMLCuerpo = strHTMLCuerpo & "</table></BODY></HTML>"
                ' 'TODOEB    EnviarEmail(ConfigurationSettings.AppSettings("strEmailRemitente"), ConfigurationSettings.AppSettings("RegMetricaCorreo_Para"), "", "", ConfigurationSettings.AppSettings("RegMetricaCorreo_Asunto"), strHTMLCuerpo, "")
                ' Catch ex2 As Exception
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("PEDIN_NROPEDIDO") & "- " & "Error Envio correo:" & ex2.Message.ToString())
                ' 'objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("VBELN") & "- " & "Error Envio correo:" & ex2.Message.ToString()) TODOEB
                ' End Try
                ' ' objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("VBELN") & "- " & "Error Registro de Metricas Ventas:" & ex.Message.ToString())
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("PEDIN_NROPEDIDO") & "- " & "Error Registro de Metricas Ventas:" & ex.Message.ToString())
                ' Finally
                ' ' objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("VBELN") & "- " & "Fin Registro de Metricas Ventas")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, " -" & drPagos.Item("PEDIN_NROPEDIDO") & "- " & "Fin Registro de Metricas Ventas")
                ' End Try


                ' 'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Inicio Region Repo Pack Prepago ---")
                ' 'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "TIPO_VENTA: " & dsPedido.Tables(0).Rows(0).Item("TIPO_VENTA"))
                ' 'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "CLASE_VENTA: " & dsPedido.Tables(0).Rows(0).Item("CLASE_VENTA"))

                ' '' RENOVACION PACK PREPAGO  - EMC
                ' 'TODOEB
                ' 'If dsPedido.Tables(0).Rows(0).Item("TIPO_VENTA") = ConfigurationSettings.AppSettings("strTVPrepago") And _  TODOEB
                ' '   dsPedido.Tables(0).Rows(0).Item("CLASE_VENTA") = ConfigurationSettings.AppSettings("strRepoPackPrepago") Then  TODOEB

                ' If dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVPrepago") And _
                ' dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION") = ConfigurationSettings.AppSettings("strRepoPackPrepago") Then

                ' Dim NumeroTelefono As String = FormatoTelefonoPrepago(Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("CLIEV_TELEFONOCLIENTE")))

                ' ' Consultar el Usuario del Vendedor
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "Inicio FP_ConsultaUsuarioRed")

                ' Dim oConsulta As New COM_SIC_Activaciones.clsBDSiscajas
                ' Dim dsUsuario As DataSet
                ' Dim strVendedor As String = dsPedido.Tables(0).Rows(0).Item("VENDEDOR")
                ' Dim strEmpleado As String
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "Cod Vendedor:" + strVendedor)
                ' Dim strResp As String
                ' Do While InStr(1, strVendedor, "0") = 1
                ' strVendedor = Mid(strVendedor, 2, Len(strVendedor))
                ' Loop
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "Cod Vendedor:" + strVendedor)
                ' dsUsuario = oConsulta.FP_ConsultaUsuarioRed(strVendedor, strResp) 'Validado
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "strRespuesta:" + strResp)

                ' If Not IsNothing(dsUsuario) Then
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "nro de registros :" + dsUsuario.Tables(0).Rows.Count.ToString())
                ' If dsUsuario.Tables(0).Rows.Count > 0 Then
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "Codigo de red:" + dsUsuario.Tables(0).Rows(0).Item(0))
                ' strEmpleado = dsUsuario.Tables(0).Rows(0).Item(0)
                ' Else
                ' strEmpleado = AppstrUsuario
                ' End If
                ' Else
                ' strEmpleado = AppstrUsuario
                ' End If
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "strEmpleado:" + strEmpleado)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "Fin FP_ConsultaUsuarioRed")
                ' 'Guardar Interaccion
                ' Dim oInteraccion = New COM_SIC_INActChip.Interaccion
                ' With oInteraccion
                ' '.OBJID_CONTACTO = objId
                ' .TELEFONO = NumeroTelefono
                ' .TIPO = ConfigurationSettings.AppSettings("CONS_REPOSICION_TIPO")
                ' .CLASE = ConfigurationSettings.AppSettings("CONS_REPOSICION_CLASE")
                ' .SUBCLASE = ConfigurationSettings.AppSettings("CONS_REPOSICION_SUBCLASE")
                ' .METODO = ConfigurationSettings.AppSettings("CONS_REPOSICION_METODO")
                ' .TIPO_INTER = ConfigurationSettings.AppSettings("CONS_REPOSICION_TIPO_INTER")
                ' .AGENTE = strEmpleado
                ' .USUARIO_PROCESO = ConfigurationSettings.AppSettings("CONS_REPOSICION_USUARIO")
                ' .FLAG_CASO = ConfigurationSettings.AppSettings("CONS_REPOSICION_FLAG")
                ' .RESULTADO = ConfigurationSettings.AppSettings("CONS_REPOSICION_RESULTADO")
                ' .HECHO_EN_UNO = ConfigurationSettings.AppSettings("CONS_REPOSICION_HECHO")

                ' End With
                ' Dim oTipificacion As New COM_SIC_INActChip.clsTipificacion
                ' Dim flagInter As String
                ' Dim mensajeInter As String
                ' Dim idInteraccion As String

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Inicio Region Repo Pack Prepago ---")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo CrearInteraccion()")
                ' Try
                ' oTipificacion.CrearInteraccion(oInteraccion, idInteraccion, flagInter, mensajeInter)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Id Interaccion : " & idInteraccion)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Flag Metodo : " & flagInter)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje : " & mensajeInter)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo CrearInteraccion()")

                ' If Trim(flagInter) = "OK" Then
                ' Dim clarifyTelef As String
                ' Dim contactoId As Int64
                ' Dim dsCliente As DataSet
                ' ' Validacion Telefono TFI
                ' If Len(Trim(NumeroTelefono)) = 8 Then
                ' 'flagTFI = "X"
                ' clarifyTelef = "000" & Trim(NumeroTelefono)
                ' Else
                ' clarifyTelef = NumeroTelefono

                ' End If
                ' dsCliente = oTipificacion.ConsultaCliente(clarifyTelef, "", contactoId, CInt("1"), "", "")

                ' Dim objIdContacto As String
                ' Dim nroDocCliente As String
                ' Dim nombreCliente As String
                ' Dim apellidoCliente As String

                ' If dsCliente.Tables(0).Rows.Count > 0 Then
                ' objIdContacto = dsCliente.Tables(0).Rows(0).Item("OBJID_CONTACTO")
                ' nroDocCliente = dsCliente.Tables(0).Rows(0).Item("NRO_DOC")
                ' nombreCliente = dsCliente.Tables(0).Rows(0).Item("NOMBRES")
                ' apellidoCliente = dsCliente.Tables(0).Rows(0).Item("APELLIDOS")
                ' End If

                ' Dim dtDetalleInterac As New DataTable
                ' Dim COD_MOTIVO As String = ""

                ' If Not C_VENTA_Prepago Is Nothing Then
                ' If C_VENTA_Prepago.Tables.Count > 0 Then
                ' If C_VENTA_Prepago.Tables(0).Rows.Count > 0 Then
                ' COD_MOTIVO = Funciones.CheckStr(C_VENTA_Prepago.Tables(0).Rows(0).Item("MOTI_REPOSICION_COD"))
                ' End If
                ' End If
                ' End If

                ' If dsPedido.Tables.Count > 0 Then

                ' dtDetalleInterac = dsPedido.Tables(1)
                ' Dim oPlantilla1 As New COM_SIC_INActChip.PlantillaInteraccion

                ' 'VALIDAR EVERIS
                ' 'For ii As Integer = 0 To dtDetalleInterac.Rows.Count - 1
                ' 'oPlantilla1 = New COM_SIC_INActChip.PlantillaInteraccion
                ' oPlantilla1.X_INTER_15 = dsPedido.Tables(0).Rows(0).Item("OFICV_CODOFICINA")
                ' oPlantilla1.X_INTER_16 = ""
                ' oPlantilla1.X_DOCUMENT_NUMBER = nroDocCliente
                ' oPlantilla1.X_FIRST_NAME = nombreCliente
                ' oPlantilla1.X_LAST_NAME = apellidoCliente
                ' oPlantilla1.X_REASON = COD_MOTIVO
                ' oPlantilla1.X_ICCID = dtDetalleInterac.Rows(0).Item("SERIC_CODSERIE")
                ' oPlantilla1.X_PLUS_INTER2INTERACT = Convert.ToDouble(idInteraccion)
                ' 'oPlantilla1.X_ICCID = ICCID
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo InsertarPlantilla()")

                ' oTipificacion.InsertarPlantillaInteraccion(oPlantilla1, idInteraccion, flagInter, mensajeInter)

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Id Interaccion : " & idInteraccion)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Flag Metodo : " & flagInter)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje : " & mensajeInter)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Metodo InsertarPlantilla()")
                ' ' Next
                ' End If
                ' End If
                ' Catch ex As Exception
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error : " & ex.Message.ToString())
                ' End Try
                ' End If

                ' ' INICIO : BONO REPOSICION EN CAC 
                ' If blnSunat Then
                ' Try
                ' '**No aplicable para NC/TG **'
                ' If (Funciones.CheckDbl(dsPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO")) > 0 And _
                ' dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA") <> ConfigurationSettings.AppSettings("strTipDoc")) Then

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - Inicio mètodo BonoReposisicon")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "tipo_venta_pvu : " & tipo_venta_pvu)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "flag_ped_repo : " & flag_ped_repo)
                ' Dim strResBonoReposisicon As String = BonoReposisicon(dsPedido, drPagos, strDocSap, tipo_venta_pvu, flag_ped_repo)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "strResBonoReposisicon = " & strResBonoReposisicon)
                ' If strResBonoReposisicon <> "OK" Then
                ' 'Response.Write("<script>alert('" & strResBonoReposisicon & "')</script>")
                ' 'Session.Add("mensajeBonoReposisicon", strResBonoReposisicon)
                ' End If
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - FIN mètodo BonoReposisicon")
                ' End If
                ' Catch ex As Exception
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Error al ejecutar el mètodo: BonoReposisicon")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error : " & ex.Message.ToString())
                ' End Try
                ' End If
                ' ' FIN : BONO REPOSICION EN CAC 


                ' '' FIN RENOVACION PACK PREPAGO  - EMC

                ' ' 16/01/2013 - ACTUALIZACION DE TABLAS SISACT PREPAGO - INICIO
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "************************************")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "INICIO ACTUALIZACION DE PAGO PREPAGO")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "************************************")

                ' dtDatos = objBus.ListarDatosCabeceraVenta(strDocSap)

                ' If dtDatos.Rows.Count > 0 Then
                ' 'Dim strAlmacen As String = Session("ALMACEN")
                ' 'Dim strCanal As String = Session("CANAL")
                ' Dim strAlmacen As String = dtDatos.Rows(0).Item("VEPR_COD_PDV").ToString()
                ' Dim strCanal As String = dtDatos.Rows(0).Item("VEPR_COD_CAN").ToString()
                ' Try
                ' Dim obj As New COM_SIC_Cajas.clsCajas
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "Actualiza referencia en tablas PVU")
                ' Dim respuesta As String = obj.actualizaReferencia(strAlmacen, strDocSap, txtCompleto)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "Respuesta: " & respuesta.ToString)

                ' Catch ex As Exception

                ' 'INI PROY-140126
                ' Dim MaptPath As String
                ' MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
                ' MaptPath = "( Class : " & MaptPath & "; Function: guardarConetado)"
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "Error: " & ex.Message & MaptPath)
                ' 'FIN PROY-140126
                ' End Try

                ' If strCanal = ConfigurationSettings.AppSettings("constCodTipoCAC") Then
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "--- Pago en CAC Prepago---")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "     Metodo: ActualizarPagoCorner")
                ' Dim constDocPagado As String = ConfigurationSettings.AppSettings("constDocPagado")
                ' Dim objDAC As New COM_SIC_Cajas.clsCajas
                ' Dim resultado As Integer = 0
                ' Dim updVentaPrepago As Boolean
                ' Dim p_TipoDoc As String = ""
                ' Dim p_nroRef As String = Var_Corr6

                ' If K_CU_CORRELATIVOFE.StartsWith("B") Then
                ' p_TipoDoc = "BOLETA"
                ' End If
                ' If K_CU_CORRELATIVOFE.StartsWith("F") Then
                ' p_TipoDoc = "FACTURA"
                ' End If

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "     IN Documento: " & strDocSap)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "     IN Estado Doc pagado: " & constDocPagado)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "     IN Almacen : " & strCanal)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "     IN Tipo Doc : " & p_TipoDoc)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "     IN Nro Doc Pago : " & p_nroRef)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "     IN Ticket : ")
                ' 'updVentaPrepago = objDAC.ActualizarPagoCorner(strDocSap, constDocPagado, strAlmacen, resultado)

                ' updVentaPrepago = objDAC.ActualizarPagoCorner(strDocSap, constDocPagado, strAlmacen, p_TipoDoc, p_nroRef, "", resultado)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, "Resultado : " & resultado.ToString)
                ' End If

                ' End If

                ' ' 16/01/2013 - ACTUALIZACION DE TABLAS SISACT PREPAGO - FIN

                ' '''PROMOCION MODEM'''''''''''''''''''Ugo Blanco
                ' Try
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Incio PROMOCION MODEM PREPAGO")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")

                ' Dim vValPromM, vIdVtaPromM, vIdOrdVtaPromM As Integer
                ' Dim vPlazoACuerdo As String

                ' 'Validado, debido a que estaba consultando directamente el nroContrato **************
                ' Dim nroContrato As String
                ' Dim nroSec As String

                ' If Not objContrato Is Nothing Then
                ' nroContrato = objContrato.Tables(0).Rows(0).Item("ID_CONTRATO")
                ' Else
                ' nroContrato = ""
                ' End If
                ' '***********************************************************************************

                ' If dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVPostpago") And dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION") = ConfigurationSettings.AppSettings("strDTVAlta") Then
                ' '  If dsPedido.Tables(0).Rows(0).Item("TIPO_VENTA") = ConfigurationSettings.AppSettings("strTVPostpago") And dsPedido.Tables(0).Rows(0).Item("CLASE_VENTA") = ConfigurationSettings.AppSettings("strDTVAlta") Then TODOEB
                ' Try
                ' If IsContratoVacio(nroContrato) Then
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "	Consulta : ObtenerSecByPedido(SISACT_PKG_EXPRESS_PORTA.SP_OBTENER_SEC_BY_PEDIDO) ")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "	Consulta : Paràmetro: ")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "	Consulta : Paràm1: " & Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")))
                ' nroSec = objCajas.ObtenerSecByPedido(drPagos.Item("PEDIN_NROPEDIDO"))
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "	Resultado(nroSec): " & Funciones.CheckStr(nroSec))
                ' Else
                ' nroSec = objCajas.ObtenerSec(nroContrato)
                ' If nroSec = "" Then
                ' nroSec = objCajas.ObtenerSecByContrato(nroContrato)
                ' End If
                ' End If
                ' Catch ex As Exception
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Err." & ex.Message.ToString)
                ' End Try

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Inicia método LisPlazoAcuerdo(PVU_SEC.SISACT_PKG_VENTAS.SP_LIS_PLAZO_ACUERDO)")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Parámetros")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Parám1: " & Funciones.CheckStr(nroSec))
                ' Try
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Ejecuta consulta.")
                ' vPlazoACuerdo = Trim(objCajas.LisPlazoAcuerdo(nroSec))
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Fi  ejecuciòn consulta.")
                ' Catch ex As Exception
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Error método LisPlazoAcuerdo")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Err." & ex.Message.ToString)
                ' End Try
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Fin método LisPlazoAcuerdo")

                ' '**** Validando para evitar Incidencias: *****'
                ' If Not C_VENTA_DET Is Nothing Then
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Inicia la validaciòn de Promociòn Modem")
                ' For L As Integer = 0 To dsPedido.Tables(1).Rows.Count - 1
                ' vValPromM = vValPromM + objCajas.ValidaPromoModem(C_VENTA_DET.Rows(0).Item("CAMPANA"), _
                ' C_VENTA_DET.Rows(0).Item("LISTA_PRECIO"), _
                ' C_VENTA_DET.Rows(0).Item("PLAN"), _
                ' vPlazoACuerdo)
                ' Next
                ' Else
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- No se encontro datos para hacer la validaciòn de Promociòn Modem")
                ' vValPromM = 0
                ' End If
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		Cumple Regla: " & vValPromM)
                ' '*********************************************************************************

                ' If vValPromM > 0 Then ''dsPedido.Tables(0).Rows(0).Item("OFICINA_VENTA"), _   'VALIDAR EVERIS
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Se encontraron datos de promociòn Modem.")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		vIdVtaPromM: " & vIdVtaPromM)

                ' vIdVtaPromM = objCajas.InsVtaPromoModemCab(dsPedido.Tables(0).Rows(0).Item("CLIEC_TIPODOCCLIENTE"), _
                ' dsPedido.Tables(0).Rows(0).Item("CLIEV_NRODOCCLIENTE"), _
                ' dsPedido.Tables(0).Rows(0).Item("OFICV_CODOFICINA"), _
                ' drPagos.Item("PEDIN_NROPEDIDO"), _
                ' C_VENTA.Rows(0).Item("VENDEDOR"), _
                ' dsPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA"), _
                ' dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION"), _
                ' vPlazoACuerdo, _
                ' dsPedido.Tables(0).Rows(0).Item("PEDID_FECHADOCUMENTO"))

                ' If vIdVtaPromM > 0 Then
                ' 'For R As Integer = 0 To dsPedido.Tables(1).Rows.Count - 1


                ' If Not C_VENTA_DET Is Nothing Then  'Inicio de Validaciòn
                ' For R As Integer = 0 To C_VENTA_DET.Rows.Count - 1
                ' vValPromM = objCajas.ValidaPromoModem(C_VENTA_DET.Rows(0).Item("CAMPANA"), _
                ' C_VENTA_DET.Rows(0).Item("LISTA_PRECIO"), _
                ' C_VENTA_DET.Rows(0).Item("PLAN"), _
                ' vPlazoACuerdo)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		vValPromM: " & vValPromM)

                ' If vValPromM > 0 Then
                ' vIdOrdVtaPromM = objCajas.InsVtaPromoModemDet(vIdVtaPromM, _
                ' C_VENTA_DET.Rows(R).Item("MATERIAL"), _
                ' C_VENTA_DET.Rows(R).Item("MATERUAL_DESC"), _
                ' C_VENTA_DET.Rows(R).Item("SERIE"), _
                ' C_VENTA_DET.Rows(R).Item("TELEFONO"), _
                ' C_VENTA_DET.Rows(R).Item("CAMPANA"), _
                ' C_VENTA_DET.Rows(R).Item("LISTA_PRECIO"), _
                ' C_VENTA_DET.Rows(R).Item("PLAN"))
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		vIdOrdVtaPromM: " & vIdOrdVtaPromM)
                ' End If
                ' Next
                ' End If  '** Fin Validaciòn C_VENTA_DET ***'
                ' End If
                ' End If
                ' End If
                ' Catch ex As Exception
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "		ERROR: " & ex.Message.ToString())
                ' Finally
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin PROMOCION MODEM PREPAGO")
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
                ' End Try
                ' '''fin PROMOCION MODEM'''''''''''''''''''Ugo Blanco

                ' 'DTH UB
                ' Dim nroContratoDTH, codRespuestaDTH As Integer
                ' Dim nroSecDTH, nroDocSapDTH, nroDepSapDTH, mensajeDTH As String
                ' Dim estadoParcial As String = ConfigurationSettings.AppSettings("constEstadoContrato_Parcial")
                ' Dim estadoReservado As String = ConfigurationSettings.AppSettings("constEstadoContrato_Reservado")
                ' Dim estadoContrato, nombreArchivo As String
                ' Dim blnGenerarSot As Boolean
                ' Dim objDir As New COM_SIC_Cajas.clsCajas
                ' Dim dtDireccion As New DataTable
                ' Try

                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Inicio Generar SOT DTH")
                ' If objCajas.validaDocSAPxDTH(strDocSap, nroContratoDTH, nroSecDTH, nroDocSapDTH, nroDepSapDTH, codRespuestaDTH, mensajeDTH) Then
                ' If codRespuestaDTH = 0 Then
                ' dtDireccion = objDir.ConsultarSolDireccion(nroSecDTH)
                ' Dim vtaProgramada As String
                ' For f As Integer = 0 To dtDireccion.Rows.Count - 1
                ' If dtDireccion.Rows(f).Item("TIPO_DIR") = "I" Then
                ' vtaProgramada = dtDireccion.Rows(f).Item("VENTA_PROGRAMADA")
                ' Exit For
                ' End If
                ' Next
                ' If vtaProgramada.Equals("") Then
                ' estadoContrato = objCajas.Consulta_estado_contrato(CInt(nroContratoDTH))
                ' If estadoContrato = estadoParcial Then
                ' blnGenerarSot = True
                ' Dim oResponse As New SGAResponseVenta
                ' oResponse = GenerarSot(nroSecDTH, nroDocSapDTH)
                ' If oResponse.codsolot > 0 Then
                ' objCajas.ActualizaContratoSot(nroContratoDTH, CheckStr(oResponse.codsolot), oResponse.numslc, oResponse.fecagenda, oResponse.hora, CheckStr(oResponse.codcon), oResponse.codcuadri, oResponse.codcli)
                ' objCajas.Actualizar_estado_contrato(CheckInt64(nroContratoDTH), estadoReservado, CheckStr(oResponse.codsolot))
                ' Else
                ' Throw New Exception(CheckStr(ConfigurationSettings.AppSettings("consMsgErrorGeneraSot")))
                ' End If
                ' End If
                ' End If

                ' End If
                ' End If
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "estadoContrato:" & estadoContrato)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "nroContratoDTH:" & nroContratoDTH)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "nroDocSapDTH:" & nroDocSapDTH)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "nroDepSapDTH:" & nroDepSapDTH)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "codRespuestaDTH:" & codRespuestaDTH)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "mensajeDTH:" & mensajeDTH)
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Fin Generar SOT DTH")
                ' 'DTH UB
                ' Catch ex As Exception
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "ERROR Generar SOT DTH: " & ex.Message.ToString())
                ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "ERROR Generar SOT DTH: " & ex.StackTrace.ToString())

                ' If blnGenerarSot Then
                ' If GenerarArchivoTramaSGA(nroContratoDTH, nombreArchivo) Then
                ' objCajas.Actualizar_estado_contrato(nroContratoDTH, estadoReservado, "0")
                ' Else
                ' 'Session.Add("msgErrorGenerarSot", CheckStr(ConfigurationSettings.AppSettings("consMsgErrorGeneraSot")))
                ' AppmsgErrorGenerarSot = CheckStr(ConfigurationSettings.AppSettings("consMsgErrorGeneraSot"))
                ' End If
                ' Else
                ' 'Session.Add("msgErrorGenerarSot", CheckStr(ConfigurationSettings.AppSettings("consMsgErrorGeneraSot")))
                ' AppmsgErrorGenerarSot = CheckStr(ConfigurationSettings.AppSettings("consMsgErrorGeneraSot"))
                ' End If
                ' End Try
            End If

            ' 'Cambio SIM IVR: Insertar Stock PEL
            ' Try
            ' Dim listaMatCambioSIM As String = ConfigurationSettings.AppSettings("codMatChipRepuesto")
            ' Dim codResp, sMensaje As String
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Inicio InsertarStockPELCambiSIM (PKG_CAMBIOSIM.SP_INSR_STOCKS_CAMBIO_SIM)")
            ' For i = 0 To dsPedido.Tables(1).Rows.Count - 1
            ' Dim codMaterial As String = dsPedido.Tables(1).Rows(i).Item("DEPEC_CODMATERIAL")
            ' If listaMatCambioSIM.IndexOf(codMaterial) > -1 Then
            ' Try
            ' Dim ICCID As String = dsPedido.Tables(1).Rows(i).Item("SERIC_CODSERIE")
            ' Dim codOficina As String = AppAlmacen
            ' Dim clienteSap As String = ConfigurationSettings.AppSettings("codClienteSapPEL")
            ' Dim nroTelefono As String = FormatoTelefonoSinCeros(Funciones.CheckStr(dsPedido.Tables(1).Rows(i).Item("DEPEV_NROTELEFONO")))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - InsertarStockPELCambiSIM")
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "inp codMaterial: " & codMaterial)
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "inp ICCID: " & ICCID)
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "inp codOficina: " & codOficina)
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "inp clienteSap: " & clienteSap)

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "inp nroTelefono: " & nroTelefono)
            ' objCajas.InsertarStockPELCambiSIM(codMaterial, ICCID, codOficina, clienteSap, nroTelefono, codResp, sMensaje)
            ' Catch ex As Exception
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - Marca Error. InsertarStockPELCambiSIM")
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - Err." & ex.Message.ToString)
            ' End Try

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "out codResp: " & codResp)
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "out sMensaje: " & sMensaje)
            ' End If
            ' Next
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Fin InsertarStockPELCambiSIM")
            ' Catch ex As Exception
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "ERROR Cambio SIM IVR: " & ex.Message.ToString())
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "ERROR Cambio SIM IVR: " & ex.StackTrace.ToString())
            ' End Try

            ' Try
            ' AlertaTitularidad(dsPedido, drPagos.Item("PEDIN_NROPEDIDO"))
            ' 'RenovacionModemPrepago(dsPedido, drPagos.Item("PEDIN_NROPEDIDO"), strNumAsignado)
            ' Catch ex As Exception
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Error bloque: AlertaTitularidad - RenovacionModemPrepago ")
            ' End Try

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "------ INICIO Consulta la CONTRATO -----")
            ' If Not objContrato Is Nothing Then
            ' If objContrato.Tables(0).Rows.Count > 0 Then
            ' strContrato = Funciones.CheckStr2(objContrato.Tables(0).Rows(0).Item("ID_CONTRATO"))
            ' Else
            ' strContrato = ""
            ' End If
            ' Else
            ' strContrato = ""
            ' End If
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     Nro CONTRATO: " & strContrato)
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "------ FIN Consulta la CONTRATO -----")

            ' '*****************************************************CONSULTA LA SEC******************************************************************'
            ' Try
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "------ Consulta la SEC -----")
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "     Metodo: ConsultaAcuerdoPCS -- SP: sp_con_acuerdos -- Packages: sisact_pkg_acuerdo")
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         IN Contrato: " & strContrato)

            ' dsAcuerdo = objClsConsultaPvu.ConsultaAcuerdoPCS(Funciones.CheckInt64(strContrato), DBNull.Value)

            ' If Not dsAcuerdo Is Nothing Then
            ' strNroSEC = Funciones.CheckStr(dsAcuerdo.Tables(0).Rows(0).Item("contn_numero_sec"))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         OUT Sec: " & strNroSEC)
            ' End If

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "------ Inicio Consulta Acuerdos PCs -----")

            ' Catch ex As Exception
            ' 'INI PROY-140126
            ' Dim MaptPath As String
            ' MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            ' MaptPath = "( Class : " & MaptPath & "; Function: guardarConectado)"
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error al tratar de recuperar la SEC" & ex.Message & MaptPath)
            ' 'FIN PROY-140126

            ' End Try
            ' '**************************************************************************************************************************************'

            ' Dim idInteracccion1, cuentaRedVendedor As String

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "------ Inicio Validacion de Proceso Renovacion CAC -----")
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "         Tiene Contrato? " & strContrato)


            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "   strContrato : " & Funciones.CheckStr(strContrato)) 'NUEVO

            ' If Funciones.CheckInt64(strContrato) > 0 Then
            ' ProcesoRenovacionCAC(dsPedido, Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")), idInteracccion1, cuentaRedVendedor, strNroSEC, strContrato) 'NUEVO
            ' AlertaNotificacionPorRenovacion(Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")), dsPedido, idInteracccion1, cuentaRedVendedor) 'NUEVO
            ' End If

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "------ FIN Validacion de Proceso Renovacion CAC -----")
            'AUDITORIA

            wParam1 = AppCodUsuario
            wParam2 = AppREMOTE_ADDR
            wParam3 = AppSERVER_NAME
            wParam4 = ConfigurationSettings.AppSettings("gConstOpcPPag")
            wParam7 = ConfigurationSettings.AppSettings("CodAplicacion")
            wParam8 = ConfigurationSettings.AppSettings("gConstEvtPPag")
            wParam9 = AppcodPerfil
            wParam10 = Mid(AppLogon_User, InStr(1, AppLogon_User, "\", vbTextCompare) + 1, 20)
            wParam11 = 1

            If Len(strDetallePago) > 0 Then
                ReDim Detalle(6, 3)
                For i = 0 To UBound(Split(strDetallePago, "|"))

                    Detalle(1, 1) = "OfVta"
                    Detalle(1, 2) = Split(Split(strDetallePago, "|")(i), ";")(1)
                    Detalle(1, 3) = "Oficina de Ventas"

                    Detalle(2, 1) = "ViaPago"
                    Detalle(2, 2) = Split(Split(strDetallePago, "|")(i), ";")(2)
                    Detalle(2, 3) = "Via de Pago"

                    Detalle(3, 1) = "Importe"
                    Detalle(3, 2) = Split(Split(strDetallePago, "|")(i), ";")(5)
                    Detalle(3, 3) = "Importe"

                    Detalle(4, 1) = "Refer"
                    Detalle(4, 2) = Split(Split(strDetallePago, "|")(i), ";")(8)
                    Detalle(4, 3) = "Referencia Sunat"

                    Detalle(5, 1) = "Fecha"
                    Detalle(5, 2) = Split(Split(strDetallePago, "|")(i), ";")(10)
                    Detalle(5, 3) = "Fecha"

                    Detalle(6, 1) = "DocSAP"
                    Detalle(6, 2) = drPagos.Item("PEDIN_NROPEDIDO")
                    Detalle(6, 3) = "Documento SAP"

                    objAudiBus.AddAuditoria(wParam1, wParam2, wParam3, wParam4, wParam5, wParam6, wParam7, wParam8, wParam9, wParam10, wParam11, Detalle)

                Next
            End If
            'FIN AUDITORIA

            ' If Len(Trim(strErrorMsg)) > 0 Then     'se produjo algun error al momento de pagar
            ' 'Response.Write("<script>alert('" & strErrorMsg & "')</script>")
            ' AppstrMensajeCaja = strErrorMsg
            ' AppMensajeExitFunction = "strErrorMsg"
            ' AppCodigoExitFunction = "-2"
            ' 'Response.Redirect("PoolPagos.aspx", False)
            ' 'Response.End()
            ' Exit Function
            ' Else     ' no hubo errores
            Try
                strContrato = objContrato.Tables(0).Rows(0).Item("ID_CONTRATO") 'drPagos.Item("NRO_CONTRATO")
            Catch ex As Exception
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "objContrato.Tables(0).Rows(0).Item(ID_CONTRATO)" & ex.Message)
            End Try

            ' 'If strContrato = "" Then
            ' '    'dsResult = objPagos.Get_ConsultaNroContrato(Session("ALMACEN"), "", drPagos.Item("VBELN"), strContrato)
            ' '    dsResult = objPagos.Get_ConsultaNroContrato(Session("ALMACEN"), "", drPagos.Item("PEDIN_NROPEDIDO"), strContrato)
            ' 'End If


            ' '**************************************************************************************************************************************'
            ' '******CONSULTA LA SEC : **************************************************************************************************************'
            ' Try
            ' 'If Not C_VENTA Is Nothing Then
            ' 'If Trim(C_VENTA.Rows(0).Item("CODTIPOCLIENTE") = "02") Then
            ' 'dsAcuerdo = objPagos.Get_ConsultaAcuerdoPCS(strContrato)        'Consulta SAP
            ' dsAcuerdo = objClsConsultaPvu.ConsultaAcuerdoPCS(Funciones.CheckInt64(strContrato), DBNull.Value)    'Consulta PVU
            ' If Not dsAcuerdo Is Nothing Then
            ' 'strNroSEC = dsAcuerdo.Tables(0).Rows(0).Item("NRO_CARPETA_OBS")
            ' strNroSEC = Funciones.CheckStr(dsAcuerdo.Tables(0).Rows(0).Item("contn_numero_sec"))
            ' sisact_Cod_Operacion = Funciones.CheckStr(dsAcuerdo.Tables(0).Rows(0).Item("contc_tipo_operacion"))
            ' objCajas.FP_RegistroDespachoPDV(strNroSEC, Right("0000000000" & AppUsuario, 10))    'Consulta PVU

            ' End If
            ' Catch ex As Exception
            ' 'INI PROY-140126
            ' Dim MaptPath As String
            ' MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            ' MaptPath = "( Class : " & MaptPath & "; Function: guardarConetado)"
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Error al tratar de recuperar la SEC" & ex.Message & MaptPath)
            ' 'FIN PROY-140126
            ' End Try
            ' '**************************************************************************************************************************************'

            ' ' Para Venta de Portabilidad
            ' 'ActualizaPago(CStr(drPagos.Item("PEDIDO")))
            ' ActualizaPago(CStr(drPagos.Item("PEDIN_NROPEDIDO")))
            ' Dim codRespConvergente As String = ""

            ' Dim strMontoPago As String = ""

            ' If (dsPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA") <> ConfigurationSettings.AppSettings("strTipDoc") And Funciones.CheckDbl(dsPedido.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO")) > 0) Then
            ' strMontoPago = ObtenerMontoPago(strDetallePago)
            ' Else
            ' strMontoPago = "0"
            ' End If

            ' 'codRespConvergente = EjecutarActivacion(strDocSap, strNumAsignaSUNAT, strMontoPago, CurrentUser, CurrentTerminal, strNroSEC)
            ' '** ACTIVACIONES **'
            ' Dim esPortabilidad As String = "N"
            ' codRespConvergente = EjecutarActivacion(Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")), Var_Corr6, strMontoPago, CurrentUser, CurrentTerminal, strNroSEC, sisact_Cod_Operacion, esPortabilidad)
            ' '
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "codRespConvergente: " & Funciones.CheckStr(codRespConvergente))
            ' '*****RV : IDG  ***'

            ' If esPortabilidad = "S" Then

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo de operacion es PORTABILIDAD POSTPAGO")

            ' If codRespConvergente = CheckStr(ConfigurationSettings.AppSettings("WSActivosPostpagoConvergente_codRespOK")) Then

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Se actualizo con exito el contrato")
            ' AppActualizarContrato = "0"
            ' Else
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Ocurrio un error al actualizar el contrato")
            ' AppActualizarContrato = "1"
            ' End If

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Operacion Portabilidad no invoca al WS ActivosPostpagoConvergente")

            ' AppActivosPostpagoConvergente = String.Empty

            ' Else
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo de operacion No es Portabilidad Postpago")

            ' If AppTipoOperacionPago = CheckStr(ConfigurationSettings.AppSettings("strDTVRenovacion")) Then

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo de operacion es RENOVACION POSPTAGO")

            ' AppActualizarContrato = "1"

            ' ElseIf AppTipoOperacionPago = CheckStr(ConfigurationSettings.AppSettings("strDTVReposicionChip")) Then

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo de operacion es REPOSICION POSPTAGO")

            ' AppActualizarContrato = String.Empty
            ' AppActivosPostpagoConvergente = String.Empty

            ' ElseIf AppTipoOperacionPago = CheckStr(ConfigurationSettings.AppSettings("COD_TIPO_OPERACION_VENTA_VARIOS")) Then

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo de operacion es VENTAS VARIAS")

            ' AppActualizarContrato = String.Empty
            ' AppActivosPostpagoConvergente = String.Empty

            ' Else

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Tipo de operacion es ALTA O MIGRACION")

            ' If codRespConvergente = CheckStr(ConfigurationSettings.AppSettings("WSActivosPostpagoConvergente_codRespOK")) Then

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Se proceso con exito la activacion")
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Se actualizo con exito el contrato")

            ' AppActivosPostpagoConvergente = "0"
            ' AppActualizarContrato = "0"

            ' Else
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Ocurrio un error al procesar la activacion")
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "No Se actualizo con exito el contrato")

            ' AppActivosPostpagoConvergente = "1"
            ' AppActualizarContrato = "1"
            ' End If

            ' End If
            ' End If


            ' If codRespConvergente = CheckStr(ConfigurationSettings.AppSettings("codRespDocSapNoConvergente")) Then

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Operacion Renovacion no invoca al WS ActivosPostpagoConvergente")

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strContrato: " & Funciones.CheckInt64(strContrato))
            ' '    'If strContrato <> "KO" And CDbl(strContrato) > 0 Then
            ' If Funciones.CheckInt64(strContrato) > 0 Then
            ' '        'dsAcuerdo = objPagos.Get_ConsultaAcuerdoPCS(strContrato)         'Consulta SAP
            ' dsAcuerdo = objClsConsultaPvu.ConsultaAcuerdoPCS(Funciones.CheckInt64(strContrato), DBNull.Value)    'Consulta PVU

            ' AppActivosPostpagoConvergente = String.Empty


            ' If Not dsAcuerdo Is Nothing Then
            ' Try
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "dsAcuerdo.Tables.Count : " & dsAcuerdo.Tables.Count)
            ' If dsAcuerdo.Tables.Count > 1 Then
            ' 'PorMigracion = dsAcuerdo.Tables(0).Rows(0).Item("MIGRACION")  ' existe en la tabla (sisact_ap_contrato)
            ' 'PorRenovacion = "" 'dsAcuerdo.Tables(0).Rows(0).Item("RENOVACION")  ' existe en la tabla (sisact_ap_contrato)
            ' 'PorReposicion = "" 'dsAcuerdo.Tables(0).Rows(0).Item("REPOSICION") '''''''''''' no encuentro

            ' 'PorAprobador = dsAcuerdo.Tables(0).Rows(0).Item("APROBADOR")
            ' 'PorAprobador = dsAcuerdo.Tables(0).Rows(0).Item("contv_aprobador") ' existe en la tabla (sisact_ap_contrato)
            ' If dsAcuerdo.Tables(1).Rows.Count > 0 Then
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "dsAcuerdo.Tables(1).Rows.Count : " & dsAcuerdo.Tables(1).Rows.Count)
            ' Try
            ' EstadoActualAcuerdo = Funciones.CheckStr(dsAcuerdo.Tables(0).Rows(0).Item("CONTC_ESTADO")) 'cursor detalle
            ' Catch ex As Exception
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "EstadoActualAcuerdo entro al catch ")
            ' EstadoActualAcuerdo = ""
            ' End Try

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "EstadoActualAcuerdo : " & EstadoActualAcuerdo)
            ' strNroSEC = Funciones.CheckStr(dsAcuerdo.Tables(0).Rows(0).Item("contn_numero_sec"))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strNroSEC : " & strNroSEC)

            ' If EstadoActualAcuerdo = ConfigurationSettings.AppSettings("CTE_VENTA") Then

            ' 'dsResult = objPagos.Get_ParamGlobal(Session("ALMACEN"))
            ' 'TODOE: Validar si es correcta la consulta
            ' Try
            ' Dim objOffline As New COM_SIC_OffLine.clsOffline
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Inicio Parametros Venta--")
            ' dsResult = objOffline.ParametrosVenta(AppAlmacen)
            ' strValSAP = Funciones.CheckStr(dsResult.Tables(0).Rows(0).Item("REN_REP_HDC")) 'verificar (si trae ese parametro el de offline)
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Fin Parametros Venta--")
            ' Catch ex As Exception
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--ERROR Parametros Venta-- " & ex.Message)
            ' strValSAP = ""
            ' End Try
            ' 'strIND_ACTIV_BSCS = dsResult.Tables(0).Rows(0).Item("IND_ACTIV_BSCS")
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strValSAP : " & strValSAP)
            ' 'Mejora en Bandeja de Renovaciones
            ' If Funciones.CheckStr(dsAcuerdo.Tables(1).Rows(0).Item("material")) <> "" Then
            ' conEquipo = True
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "conEquipo : true")
            ' Else
            ' conEquipo = False
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "conEquipo : false")
            ' End If

            ' Dim cod_OperaSisact() As String
            ' cod_OperaSisact = ConfigurationSettings.AppSettings("codOperacionSisact").Split(",")

            ' For z As Integer = 0 To UBound(cod_OperaSisact)
            ' If sisact_Cod_Operacion = Funciones.CheckStr(cod_OperaSisact(z)) Then
            ' blnDebeSerRevisado = True
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "blnDebeSerRevisado : true")
            ' Exit For
            ' Else
            ' blnDebeSerRevisado = False
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "blnDebeSerRevisado : false")
            ' End If
            ' Next

            ' 'If (Trim(sTipoOperacion) = Funciones.CheckStr(ConfigurationSettings.AppSettings("COD_OPERACION_RENOVACION")) Or Trim(sTipoOperacion) = Funciones.CheckStr(ConfigurationSettings.AppSettings("COD_OPERACION_REPOSICION"))) And (strValSAP <> "X") Then          'Not(valSAP=="X"): VIA_DSF = S
            ' '                            blnDebeSerRevisado = True
            ' '                        End If
            ' If blnDebeSerRevisado And (strValSAP <> "X") Then
            ' blnDebeSerRevisado = True
            ' End If
            ' If blnDebeSerRevisado Then  ' los estados seran cero o 7
            ' strEstado = ConfigurationSettings.AppSettings("CTE_ESTREVISADO")
            ' Else
            ' strEstado = ConfigurationSettings.AppSettings("CTE_ESTNUEVO")
            ' End If
            ' Dim Id_contrato As String = Funciones.CheckStr(dsAcuerdo.Tables(1).Rows(0).Item("id_contrato"))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Id_contrato : " & Id_contrato)
            ' Dim codRespt, msgRespt As String

            ' 'dsEstado = objPagos.Set_EstadoAcuerdoPCS(strContrato, strEstado, ConfigurationSettings.AppSettings("gStrUsuarioActivacionWS"), "", "", "", strObsEstado, "")                '                        
            ' objFileLog.EscribirLog(pathFile, strArchivo, strIdentifyLog, "Inicio CambiarEstadoAcuerdo")
            ' objFileLog.EscribirLog(pathFile, strArchivo, strIdentifyLog, "nroAcuerdo : " & Id_contrato)
            ' objFileLog.EscribirLog(pathFile, strArchivo, strIdentifyLog, "Estado : " & strEstado)
            ' objFileLog.EscribirLog(pathFile, strArchivo, strIdentifyLog, "Usuario : " & Funciones.CheckStr(CurrentUser.ToString)) '*********

            ' codRespt = (New COM_SIC_Activaciones.clsBDSiscajas).CambiarEstadoAcuerdo(Id_contrato, strEstado, CurrentUser.ToString, msgRespt)
            ' objFileLog.EscribirLog(pathFile, strArchivo, strIdentifyLog, "Fin CambiarEstadoAcuerdo", codRespt, msgRespt)

            ' If codRespt = "0" Then
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Se actualizo con exito el contrato")
            ' AppActualizarContrato = "0"
            ' Else
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "No se actualizo con exito el contrato")
            ' AppActualizarContrato = "1"
            ' End If
            ' End If
            ' End If
            ' End If
            ' Catch ex As Exception
            ' '                Response.Write("<script>alert('" & ex.StackTrace.ToString & "')</script>")
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR ConsultaAcuerdoPCS:" & ex.Message.ToString())
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR ConsultaAcuerdoPCS:" & ex.StackTrace.ToString())
            ' End Try
            ' End If '+++Fin acuerdos+++'
            ' Else

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "TIPO DE VENTA ES PREPAGO")

            ' AppActualizarContrato = String.Empty
            ' AppActivosPostpagoConvergente = String.Empty

            ' End If
            ' End If
            ' '*****RV : FDG  ***'

            ' '****************************************************************************'
            ' '22-01-15 xD
            ' 'PVUDB: DEBEMOS CONSULTAR ANTES EL NUMERO DE SEC, CON EL PEDIDO DEL MSSAP
            ' 'CARIAS: SEC marcada como pagada
            ' '** UPDATESEC ***'
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Iniico bloque para actualizar SEC.")
            ' Dim Err_MSG As String = ""
            ' Dim cod_Rpt As Integer = 3
            ' If Len(Trim(strNroSEC)) > 0 Then
            ' Try
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicia el proceso para actualizar la SEC => " & strNroSEC)
            ' cod_Rpt = objCajas.FP_Actualiza_Pago_Solicitud(Funciones.CheckInt(strNroSEC), "X", Err_MSG)
            ' 'INI PROY-140126
            ' Dim MaptPath As String
            ' MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            ' MaptPath = "( Class : " & MaptPath & "; Function: guardarConectado)"
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Respuesta del proceso Err_MSG => " & Err_MSG & MaptPath)
            ' 'FIN PROY-140126

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Respuesta del proceso cod_Rpt  => " & cod_Rpt)
            ' Catch ex As Exception
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Try catch para actualizar SEC.")
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Output strContrato: " & strContrato)
            ' 'INI PROY-140126
            ' Dim MaptPath As String
            ' MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            ' MaptPath = "( Class : " & MaptPath & "; Function: guardarConectado)"
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Respuesta del proceso Err_MSG => " & Err_MSG & MaptPath)
            ' 'FIN PROY-140126
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Respuesta del proceso cod_Rpt  => " & cod_Rpt)
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Ocurrio un error al tratar de actualizar la SEC " & strNroSEC)
            ' End Try
            ' Else
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- No se encontro la SEC para el pedido.")
            ' End If
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Fin bloque para actualizar SEC.")
            ' 'FIN CARIAS: SEC marcada como pagada
            ' '****************************************************************************'

            ' 'CNH WEB SERVICE INI - PORTABILIDAD

            ' If dsPedido.Tables(0).Rows.Count > 0 And Len(Trim(strNroSEC)) = 0 Then
            ' strNroSEC = objCajas.ObtenerSecByPedido(dsPedido.Tables(0).Rows(0)("PEDIN_NROPEDIDO"))
            ' End If

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strNroSEC :" & strNroSEC)
            ' If Len(Trim(strNroSEC)) > 0 Then

            ' 'Validar si es una portabilidad pre o post (Movil o Fija)

            ' Dim strCodTipOpe As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("PEDIC_CODTIPOOPERACION"))
            ' Dim strDesTipOpe As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("PEDIV_DESCTIPOOPERACION"))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strCodTipOpe :" & strCodTipOpe)
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strDesTipOpe :" & strDesTipOpe)

            ' 'Venta Postpago = 01
            ' 'Dim strTVPostpago As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("strTVPostpago"))
            ' 'Dim strDescriOpePostPago As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("DESCTIPOOPERACION_PORTA_POST"))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strTVPostpago :" & strTVPostpago)
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strDescriOpePostPago :" & strDescriOpePostPago)


            ' 'Venta Prepago  = 02
            ' 'Dim strTVPrepago As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("strTVPrepago"))
            ' ' Dim strDescriOpePrePago As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("DESCTIPOOPERACION_PORTA_PRE"))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strTVPrepago :" & strTVPrepago)
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strDescriOpePrePago :" & strDescriOpePrePago)


            ' Dim FlagPorta As Boolean = False

            ' If (strDesTipOpe = strDescriOpePostPago) Then
            ' 'POSTPAGO                        
            ' FlagPorta = True
            ' ElseIf (strDesTipOpe = strDescriOpePrePago) Then
            ' 'PREPAGO                        
            ' FlagPorta = True
            ' End If

            ' If (FlagPorta = True) Then
            ' '*** PROY 32089 INI -  ***'
            ' Dim objDatosTipoProducto As New ClsPortabilidad
            ' Dim pstrCodRpta, pstrMsgRpta As String

            ' Dim dtLineas As DataSet = objDatosTipoProducto.Obtener_tipo_producto(strNroSEC, hidDocSap, pstrCodRpta, pstrMsgRpta)
            ' If clsKeyAPP.consTipoProductoPermitidosSP.IndexOf(dtLineas.Tables(0).Rows(0).Item("PRDC_CODIGO")) > -1 Then   'PROY 32089 PARA TFI

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Realizando Programación.")
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
            ' Dim oBWProcesoPortabilidad As New BWProcesoPortabilidad
            ' Dim oaudit As New ItemGenerico
            ' Dim mensajeError As String = String.Empty
            ' Dim codError As String = String.Empty
            ' Dim strMsgEmailRP As String = ""
            ' oaudit.CODIGO = ConfigurationSettings.AppSettings("CONS_APLICACION")
            ' oaudit.CODIGO2 = CurrentTerminal
            ' oaudit.CODIGO3 = CurrentUser
            ' oaudit.DESCRIPCION = Now.ToString("yyMMddhhmmssff")
            ' 'INI: PROY-140262 BLACKOUT
            ' oaudit.CODIGO4 = clsKeyAPP.consFlagBlackOut
            ' oaudit.DESCRIPCION4 = clsKeyAPP.consMensajeRealizarProgramacionBlackOut
            ' 'FIN: PROY-140262 BLACKOUT
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Datos para el servicio realizarProgramación.")
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "IdAplicacion: " & oaudit.CODIGO)
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "nombreAplicacion: " & oaudit.CODIGO2)
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "usuarioAplicacion: " & oaudit.CODIGO3)
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "idTransaccionESB: " & oaudit.DESCRIPCION)
            ' 'INI: PROY-140262 BLACKOUT
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "[ItemGenerico][CODIGO4] " & oaudit.CODIGO4)
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "[ItemGenerico][DESCRIPCION4] " & oaudit.DESCRIPCION4)
            ' 'FIN: PROY-140262 BLACKOUT
            ' Dim ipclienteRP As String = CurrentTerminal
            ' Dim strIdTransactionRP As String = DateTime.Now.ToString("yyMMddhhmmss")
            ' Dim strNameApliRP As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("CONS_APLICACION"))
            ' 'Inicio PROY 32089
            ' strLista_SOPOC_ID_SOLICITUD = CType(AppIdSolicitudPorta, ArrayList)   'PROY-140335
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- [PROY-140335][DETAPAGO][Session(IdSolicitudPorta)=> " & strLista_SOPOC_ID_SOLICITUD.Count)
            ' If strLista_SOPOC_ID_SOLICITUD.Count > 0 Then
            ' For Each id_solicitud As String In strLista_SOPOC_ID_SOLICITUD

            ' objFileLog.EscribirLog(pathFile, strArchivo, pathFile, "EnviarProgramacion [IdSolicitud]", id_solicitud)
            ' objFileLog.EscribirLog(pathFile, strArchivo, pathFile, "EnviarProgramacion [ItemGenerico]", oaudit.Codigo)
            ' objFileLog.EscribirLog(pathFile, strArchivo, pathFile, "EnviarProgramacion [codError]", codError)
            ' objFileLog.EscribirLog(pathFile, strArchivo, pathFile, "EnviarProgramacion [mensajeError]", mensajeError)

            ' oBWProcesoPortabilidad.RealizarProgramacion(oaudit, id_solicitud, codError, mensajeError)
            ' objFileLog.EscribirLog(pathFile, strArchivo, pathFile, "EnviarProgramacion - RESPUESTA [codError]", codError)
            ' objFileLog.EscribirLog(pathFile, strArchivo, pathFile, "EnviarProgramacion - RESPUESTA [mensajeError]", mensajeError)
            ' If codError <> "0" Then
            ' 'Enviar email a Mesa Portabilidad
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Inicio :  Enviar_Email")
            ' strMsgEmailRP = Me.Enviar_Email(id_solicitud, ipclienteRP, strNameApliRP, CurrentUser, strNroSEC, codError)
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Fin :  Enviar_Email")
            ' End If
            ' Next
            ' End If
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Datos para el servicio Fin realizarProgramación.")

            ' 'FIN PROY 32089
            ' Else
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Incio Envio de Solicitud de Portabilidad no movil/bam Porta") ' PROY-32089
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strNroSEC :" & strNroSEC)

            ' Dim oEnvioPortal As New BWEnvioPortal

            ' Dim intNroSec As Int64 = Funciones.CheckInt64(strNroSEC)

            ' Dim usuario_id As String = CurrentUser
            ' Dim ipcliente As String = CurrentTerminal
            ' Dim strIdTransaction As String = DateTime.Now.ToString("yyMMddhhmmss")
            ' Dim strNameApli As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("CONS_APLICACION"))
            ' Dim strRptaService As String = "", strMsgEmail As String = ""
            ' Dim strNameHost As String = Funciones.CheckStr(AppUserHostName)
            ' Dim strNameServer As String = Funciones.CheckStr(AppREMOTE_ADDR)
            ' Dim strIpServer As String = Funciones.CheckStr(AppHTTP_X_FORWARDED_FOR)
            ' Dim strTipoPorta As String = Funciones.CheckStr(ConfigurationSettings.AppSettings("ConsTipoPorta"))
            ' Dim strRptService As String = ""

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "usuario_id : " & usuario_id)
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "ipcliente : " & ipcliente)
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strIdTransaction : " & strIdTransaction)
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strNameApli : " & strNameApli)
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strNameHost : " & strNameHost)
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strNameServer : " & strNameServer)
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strIpServer : " & strIpServer)
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strTipoPorta : " & strTipoPorta)

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Inicio :  RealizarSolicitudPortabilidad")
            ' strRptaService = oEnvioPortal.RealizarSolicitudPortabilidad(CLng(intNroSec), strIdTransaction, _
            ' ipcliente, strNameApli, usuario_id, strNameHost, strNameServer, strIpServer, strTipoPorta, strRptService)
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Fin :  RealizarSolicitudPortabilidad")

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strRptaService : " & strRptaService)
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "strRptService : " & strRptService)
            ' If strRptaService <> "0" Then
            ' 'Enviar email a Mesa Portabilidad
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Inicio :  Enviar_Email")
            ' strMsgEmail = Me.Enviar_Email(strIdTransaction, ipcliente, strNameApli, usuario_id, strNroSEC, strRptService)
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Fin :  Enviar_Email")
            ' End If
            ' oEnvioPortal = Nothing
            ' End If
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & " - " & "Fin Porta")
            ' End If
            ' End If ' PROY 32090

            ' 'CNH WEB SERVICE FIN


            ' 'INICIO ACTUALIZAR LA TABLA DE CONTROL (Post + Pre)
            ' '''Dim arrCampana() As String
            ' '''Dim intCampana As Integer

            ' '''If Trim(strCadenaCam) <> "" Then
            ' '''    arrCampana = Split(strCadenaCam, "|")
            ' '''    If UBound(arrCampana) >= 0 Then
            ' '''        For intCampana = 0 To UBound(arrCampana)
            ' '''            dsResult = objPagos.Set_TriacionPrePost(arrCampana(intCampana))
            ' '''        Next
            ' '''    End If
            ' '''End If
            'FIN ACTUALIZAR LA TABLA DE CONTROL (Post + Pre)

            'CCC - TS - Envio fecha pedido
            dateTimeValueCajaEfe = Convert.ToDateTime(DateTime.Now, cultureCaja)
            'PROY-140397-MCKINSEY -> JSQ INICIO
            sFechaCaj0 = DateTime.Now.ToString("dd/MM/yyyy")
            'PROY-140397-MCKINSEY -> JSQ FIN

            'dsEfectivo = objCajas.FP_Get_ListaParamOficina(Session("CANAL"), ConfigurationSettings.AppSettings("CodAplicacion"), Session("ALMACEN"))
            'dblEfecCaja = objCajas.FP_CalculaEfectivo(Session("ALMACEN"), "60138")
            objCajas = New COM_SIC_Cajas.clsCajas
            dsEfectivo = objCajas.FP_Get_ListaParamOficina(AppCanal, ConfigurationSettings.AppSettings("CodAplicacion"), AppAlmacen)
            dblEfecCaja = objCajas.FP_CalculaEfectivo(AppAlmacen, AppUsuario, sFechaCaj0)

            If dsEfectivo.Tables(0).Rows(0).Item("CAJA_MAX_DISP_SOL") <= dblEfecCaja Then
                If AppstrMensajeCaja = "" Then
                    AppstrMensajeCaja = "Ha alcanzado su maximo disponible de efectivo en caja. Aun tiene una tolerancia de " & Format(dblTolerancia, "#####0.00") & " adicionales"
                End If
            End If

            Dim sUrl As String = "PoolPagos.aspx"
            AppVentaR = "1"
            If AppVentaR = "1" Then
                sUrl = "Terminar.aspx"
                AppVentaR = ""
            End If

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "booDol: " & booDol.ToString)
            ' ' INICIO FMES : ACTIVAR PEL
            ' 'If booDol = False Then
            ' 'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "VBELN: " & Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")))
            ' 'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ALMACEN: " & Session("ALMACEN"))
            ' 'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "txtNumSunat: " & txtNumSunat.Text.Trim)
            ' 'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FKDAT: " & drPagos.Item("FKDAT"))
            ' 'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "sTipoOperacion: " & sTipoOperacion)

            ' 'Dim strDescripcionError As String = ""
            ' 'If (pagarCAC(drPagos.Item("PEDIN_NROPEDIDO"), Session("ALMACEN"), txtNumSunat.Text.Trim, drPagos.Item("FKDAT"), sTipoOperacion, strDescripcionError)) = False Then
            ' 'Session.Add("msgActivacionCAC", strDescripcionError)
            ' 'Else
            ' 'Session.Add("msgActivacionCAC", strDescripcionError)
            ' 'Response.Redirect("PoolPagos.aspx")
            ' 'End If

            ' 'End If

            ' ' FIN FMES : ACTIVAR PEL
            ' 'Escribir en diario electronico

            ' 'PROY-31836 IDEA-43582_Mejora de Procesos Postventa del servicio Proteccion Movil

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [INICIO Validacion Mejoras Proteccion movil Renovacion  CAC - PROY-31836]", strIdentifyLog))

            ' Dim strTipoOperacion As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION"))
            ' Dim strDescTipoOperacion As String = Funciones.CheckStr(dsPedido.Tables(0).Rows(0).Item("PEDIV_DESCTIPOOPERACION"))
            ' Dim strKey_TipoOperRenovacionPostago = ReadKeySettings.Key_TipoOperRenovacionPostago

            ' Dim telefono_PMovil As String = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO"))
            ' Dim codigo_PMovil As String = String.Empty
            ' Dim mensaje_PMovil As String = String.Empty

            ' Try
            ' If (strTipoOperacion = strKey_TipoOperRenovacionPostago.Split("|")(0) And strDescTipoOperacion = strKey_TipoOperRenovacionPostago.Split("|")(1)) Then

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Tipo de Operacion es Renovacion Postpago", strIdentifyLog))


            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro entrada] [{1}]", strIdentifyLog, telefono_PMovil))
            ' dsResult = objPvu.Consultar_ProteccionMovil_Equipo(telefono_PMovil, codigo_PMovil, mensaje_PMovil)
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro salida codigo] [{1}]", strIdentifyLog, codigo_PMovil))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro salida mensaje:] [{1}]", strIdentifyLog, mensaje_PMovil))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Fin Ejecucion  Proteccion movil Venta]", strIdentifyLog))
            ' Dim nroCertiReq As String = String.Empty
            ' Dim nroTelefono As String = String.Empty
            ' Dim CodMaterialOrigen As String = String.Empty
            ' Dim desMaterialOrigen As String = String.Empty
            ' Dim ImeiOrigen As String = String.Empty
            ' Dim CodPuntVenta As String = String.Empty
            ' Dim CodMaterialNuevo As String = String.Empty
            ' Dim DesMaterialNuevo As String = String.Empty
            ' Dim ImeiNuevo As String = String.Empty
            ' Dim ImeiNuevoRecortado As String = String.Empty
            ' Dim ValidarImei As String = String.Empty
            ' Dim Longitud As Int16 = 0
            ' Dim EstadoSeguro As String = String.Empty
            ' Dim FechaAfiliacion As String = String.Empty
            ' Dim Nro_Rpta_nuevo As String = String.Empty
            ' Dim dtPM As New DataTable
            ' If (dsResult.Tables.Count > 0) Then
            ' dtPM = dsResult.Tables(0)
            ' End If

            ' 'Validar si la linea tiene proteccion movil
            ' If (dtPM.Rows.Count > 0) Then
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [La Linea cuenta con proteccion movil]", strIdentifyLog))
            ' With dtPM.Rows(0)
            ' nroCertiReq = CheckStr(.Item("VENTV_NRO_CERTF_REQ"))
            ' nroTelefono = CheckStr(.Item("VENTV_MSISDN_RPTA"))
            ' CodMaterialOrigen = CheckStr(.Item("VENTV_COD_MAT_REQ"))
            ' desMaterialOrigen = CheckStr(.Item("VENTV_DES_MATERIAL"))
            ' ImeiOrigen = CheckStr(.Item("VENTV_IMEI_REQ"))
            ' CodPuntVenta = CheckStr(.Item("VENTV_COD_PNTO_VENT"))
            ' EstadoSeguro = CheckStr(.Item("VENTC_ESTADO_SEGURO"))
            ' FechaAfiliacion = CheckStr(.Item("VENTD_FECH_SERV_REQ"))
            ' End With

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro entrada nroCertiReq] [{1}]", strIdentifyLog, nroCertiReq))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro entrada nroTelefono] [{1}]", strIdentifyLog, nroTelefono))
            ' objPvu.Insertar_SeguroEquipo_Historico(nroTelefono, codigo_PMovil, mensaje_PMovil)

            ' If codigo_PMovil = "0" Then 'Ejecucion Correcta
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Éxito al actualizar el histórico de Protección Movil]", strIdentifyLog))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro salida codigo] [{1}]", strIdentifyLog, codigo_PMovil))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro salida mensaje] [{1}]", strIdentifyLog, mensaje_PMovil))
            ' Else
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Ocurrió un error al actualizar el histórico de Protección Movil]", strIdentifyLog))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro salida codigo] [{1}]", strIdentifyLog, codigo_PMovil))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro salida mensaje] [{1}]", strIdentifyLog, mensaje_PMovil))
            ' End If 'Fin Ejecucion Correcta

            ' Dim iCant As Integer = 0
            ' Dim strNotas As String = String.Empty
            ' strNotas = ReadKeySettings.Key_NotaErrorTipificacionWS
            ' iCant = IIf(CheckInt(ReadKeySettings.Key_CantIntentosPagoRenovacion) = 0, 1, CheckInt(ReadKeySettings.Key_CantIntentosPagoRenovacion))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro cantidad intentos] [{1}]", strIdentifyLog, iCant))
            ' If dsPedido.Tables(1).Rows.Count = 1 Then
            ' CodMaterialNuevo = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEC_CODMATERIAL"))
            ' DesMaterialNuevo = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEV_DESCMATERIAL"))
            ' ImeiNuevo = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("SERIC_CODSERIE"))
            ' End If

            ' ValidarImei = Funciones.CheckStr(ImeiNuevo).PadLeft(18, "0")
            ' Longitud = ValidarImei.Length - 15
            ' ImeiNuevoRecortado = ValidarImei.Substring(Longitud, 15)

            ' If iCant > 0 Then
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro entrada nroTelefono] [{1}]", strIdentifyLog, nroTelefono))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro entrada CodMaterial] [{1}]", strIdentifyLog, CodMaterialNuevo))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro entrada DesMaterial] [{1}]", strIdentifyLog, DesMaterialNuevo))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro entrada nroImeiNuevo] [{1}]", strIdentifyLog, ImeiNuevo))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro entrada nroImeiNuevoRecortado] [{1}]", strIdentifyLog, ImeiNuevoRecortado))
            ' For iPm As Integer = 1 To iCant
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Numero de Intento] [{1}]", strIdentifyLog, iPm))
            ' objPvu.Actualizar_SeguroEquipo(nroTelefono, CodMaterialNuevo, DesMaterialNuevo, ImeiNuevoRecortado, Nro_Rpta_nuevo, codigo_PMovil, mensaje_PMovil)
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro salida codigo] [{1}]", strIdentifyLog, codigo_PMovil))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro salida mensaje] [{1}]", strIdentifyLog, mensaje_PMovil))
            ' If codigo_PMovil = "0" Then
            ' strNotas = CheckStr(ReadKeySettings.Key_NotaExitoTipificacionWS)
            ' Exit For
            ' End If
            ' Next
            ' 'If codigo_PMovil = "0" Then ' Validacion Si ejecuta el update correcto
            ' Dim strMetodo As String = String.Empty
            ' Try

            ' Dim dtHistoricoEval As DataTable
            ' Dim objProteccionMovil As New COM_SIC_Activaciones.clsProteccionMovil
            ' Dim oWSGestionaPostventa As New BWGestionaPostventaProteccionMovil
            ' Dim strCodRpta As String = String.Empty
            ' Dim strMsgRpta As String = String.Empty
            ' Dim strEstadoTipificacion As String = "A"
            ' Dim strCodEquipoNuevo As String = CodMaterialNuevo ' obligatorio
            ' Dim strIdTransaccion As String = DateTime.Now.ToString("yyyyMMddHHmmssfff") ' obligatorio
            ' Dim strIPAplicacion As String = CurrentTerminal ' obligatorio
            ' Dim strNombaplicacion As String = ConfigurationSettings.AppSettings("constAplicacion") ' obligatorio
            ' Dim strUsrProceso As String = CurrentUser ' obligatorio
            ' Dim strSUBClase As String = CheckStr(ReadKeySettings.Key_SubClaseRenovacionTipificaWS)
            ' Dim strNroCertificado As String = nroCertiReq ' obligatorio
            ' Dim strAgente As String = CurrentUser ' obligatorio
            ' Dim strFechaAfiliacion As String = Format(CDate(FechaAfiliacion), "yyyy-MM-dd") ' obligatorio
            ' Dim strOperacionVenta As String = CheckStr(ReadKeySettings.Key_TipoOperRenoTipificacion)
            ' Dim strMontoPrimaActual As String = String.Empty
            ' Dim strDeducibleDanoActual As String = String.Empty
            ' Dim strDeducibleRoboactual As String = String.Empty
            ' Dim strDescEquipoActual As String = DesMaterialNuevo ' obligatorio
            ' Dim strImeiActual As String = ImeiNuevoRecortado ' obligatorio
            ' Dim strDescEquipoAnterior As String = desMaterialOrigen ' obligatorio
            ' Dim strImeiAnterior As String = ImeiOrigen ' obligatorio
            ' Dim strMontoPrimaAnterior As String = String.Empty
            ' Dim strDeducibleDanoAnterior As String = String.Empty
            ' Dim strDeducibleRoboAnterior As String = String.Empty
            ' Dim strFechaCambioEquipo As String = String.Empty
            ' Dim strFechaCompraEquipo As String = String.Empty
            ' Dim strFlagPlantilla As String = CheckStr(ReadKeySettings.Key_FlagPlantillaRenoTipificaWS) ' obligatorio
            ' Dim strIdTransaccionRpta As String = String.Empty
            ' Dim strCACEntrega As String = CodPuntVenta ' obligatorio
            ' Dim strNroSiniestro As String = String.Empty
            ' Dim strTipoSiniestro As String = String.Empty
            ' Dim strFechaPago As String = DateTime.Now.ToString("yyyy-MM-dd") ' obligatorio
            ' Dim strDevuelveEquipo As String = String.Empty
            ' Dim strMontoDeduSiniestro As String = String.Empty
            ' Dim strMotivoCancel As String = CheckStr(ReadKeySettings.Key_MotivoCancelTipificacionWS) ' obligatorio
            ' Dim strTelefono As String = String.Empty
            ' strTelefono = Funciones.CheckStr(dsPedido.Tables(1).Rows(0).Item("DEPEV_NROTELEFONO"))

            ' strMetodo = "TipificarProteccionMovil"
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [INICIO TIPIFICACION PROTECCION MOVIL PROY-31836]", strIdentifyLog))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Ruta WS] [{1}]", strIdentifyLog, ConfigurationSettings.AppSettings("consGestionaPostventaProteccionMovilWS_URL")))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Metodo] [{1}]", strIdentifyLog, strMetodo))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [IdTransaccion] [{1}]", strIdentifyLog, strIdTransaccion))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [IP Aplicacion] [{1}]", strIdentifyLog, strIPAplicacion))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Nombre aplicacion ] [{1}]", strIdentifyLog, strNombaplicacion))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Codigo Usuario] [{1}]", strIdentifyLog, CurrentUser))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Usuario Proceso] [{1}]", strIdentifyLog, strUsrProceso))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Codigo Agente] [{1}]", strIdentifyLog, strAgente))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Descripcion Notas] [{1}]", strIdentifyLog, strNotas))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Descripcion Subclase] [{1}]", strIdentifyLog, strSUBClase))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Numero Telefono] [{1}]", strIdentifyLog, strTelefono))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Numero Certificado] [{1}]", strIdentifyLog, strNroCertificado))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Fecha Afiliacion] [{1}]", strIdentifyLog, strFechaAfiliacion))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Estado Tipificacion] [{1}]", strIdentifyLog, strEstadoTipificacion))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Operacion Venta] [{1}]", strIdentifyLog, strOperacionVenta))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Equipo Actual] [{1}]", strIdentifyLog, strDescEquipoActual))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Imei Actual] [{1}]", strIdentifyLog, strImeiActual))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Equipo Anterior] [{1}]", strIdentifyLog, strDescEquipoAnterior))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Imei Anterior] [{1}]", strIdentifyLog, strImeiAnterior))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Motivo Cancelacion] [{1}]", strIdentifyLog, strMotivoCancel))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Flag Plantilla] [{1}]", strIdentifyLog, strFlagPlantilla))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Codido PDV] [{1}]", strIdentifyLog, strCACEntrega))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Motivo Cancelacion] [{1}]", strIdentifyLog, strMotivoCancel))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Fecha Pago] [{1}]", strIdentifyLog, strFechaPago))


            ' oWSGestionaPostventa.RegistrarTipificacion(strIdTransaccion, strIPAplicacion, strNombaplicacion, CurrentUser, strUsrProceso, _
            ' strAgente, strNotas, strSUBClase, strTelefono, strNroCertificado, strFechaAfiliacion, strEstadoTipificacion, _
            ' strOperacionVenta, strDescEquipoActual, strImeiActual, strMontoPrimaActual, strDeducibleDanoActual, _
            ' strDeducibleRoboactual, strDescEquipoAnterior, strImeiAnterior, strMontoPrimaAnterior, _
            ' strDeducibleDanoAnterior, strDeducibleRoboAnterior, strFechaCambioEquipo, strFechaCompraEquipo, strFlagPlantilla, _
            ' strCACEntrega, strNroSiniestro, strTipoSiniestro, strFechaPago, strDevuelveEquipo, strMontoDeduSiniestro, strMotivoCancel, _
            ' strIdTransaccionRpta, strCodRpta, strMsgRpta)

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [OUT  Id Transaccion] [{1}]", strIdentifyLog, strIdTransaccionRpta))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [OUT Cod. Rpta] [{1}]", strIdentifyLog, strCodRpta))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [OUT Msj. Rpta] [{1}]", strIdentifyLog, strMsgRpta))

            ' Catch ex As Exception
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [ERROR en el método] [{1}]", strIdentifyLog, strMetodo))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [ERROR Tipificacion] [{1}]", strIdentifyLog, ex.Message.ToString()))
            ' Finally
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [FIN TIPIFICACION PROTECCION MOVIL PROY-31836]", strIdentifyLog))
            ' End Try

            ' End If 'Fin validacion mayor a 0

            ' Else
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [La Linea NO con proteccion movil]", strIdentifyLog))
            ' End If
            ' Else
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Tipo de Operacion no es Renovacion Postpago", strIdentifyLog))
            ' End If

            ' Catch ex As Exception
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [ERROR Ejecutar  Proteccion movil Venta] [{1}]", strIdentifyLog, ex.Message.ToString()))
            ' Finally
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [FIN Validacion Mejoras Proteccion movil Renovacion  CAC - PROY-31836]", strIdentifyLog))
            ' End Try

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [FIN Validacion Mejoras Proteccion movil Renovacion  CAC - PROY-31836]", strIdentifyLog))

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [INICIO Validacion Mejoras Proteccion movil Pago Deducible  CAC - PROY-31836]", strIdentifyLog))

            ' Try
            ' If AppPagoDeducible.ToString.Length > 0 Then
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Se encontró pago de deducible]", strIdentifyLog))
            ' Dim objProteccionMovil As New COM_SIC_Activaciones.clsProteccionMovil
            ' Dim dsListaSiniestros As DataSet
            ' Dim dtRobo As New DataTable
            ' Dim dtConsulta As New DataTable
            ' Dim oFila() As DataRow
            ' Dim cod, msje As String
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [INICIO METODO Consulta_linea_robo BSCS]", strIdentifyLog))
            ' Try
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro entrada nroTelefono] [{1}]", strIdentifyLog, telefono_PMovil))
            ' dsListaSiniestros = objProteccionMovil.Consulta_linea_robo(telefono_PMovil, cod, msje)
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro salida codigo] [{1}]", strIdentifyLog, cod))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Parametro salida mensaje] [{1}]", strIdentifyLog, msje))
            ' Catch ex As Exception
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [ERROR en Consulta_linea_robo BSCS] [{1}]", strIdentifyLog, ex.Message.ToString()))
            ' Finally
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [FIN METODO Consulta_linea_robo BSCS]", strIdentifyLog))
            ' End Try

            ' If Not dsListaSiniestros Is Nothing Then
            ' If dsListaSiniestros.Tables.Count > 0 Then dtConsulta = dsListaSiniestros.Tables(0)
            ' End If
            ' If dtConsulta.Rows.Count > 0 Then
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Consulta devolvio data, se validara siniestros robo]", strIdentifyLog))
            ' dtRobo.Columns.Add("V_NRO_CERTIF_REQ")
            ' dtRobo.Columns.Add("V_NRO_SINIESTRO")
            ' dtRobo.Columns.Add("C_ESTADO_SINIEST")
            ' dtRobo.Columns.Add("V_TIPO_OPERACION")
            ' dtRobo.Columns.Add("V_IMEI_NUEVO")
            ' dtRobo.Columns.Add("V_IMEI_ORIG")
            ' dtRobo.Columns.Add("V_MODELO_EQUIPO")
            ' dtRobo.Columns.Add("V_MARCA_EQUIPO")
            ' dtRobo.Columns.Add("V_MODELO_NUEVO")
            ' dtRobo.Columns.Add("V_MARCA_NUEVO")
            ' dtRobo.Columns.Add("D_FECHA_OP")
            ' oFila = dtConsulta.Select("V_TIPO_OPERACION = 'ROBO'", "D_FECHA_OP DESC")
            ' For Each dr As DataRow In oFila
            ' dtRobo.ImportRow(dr)
            ' Next
            ' If dtRobo.Rows.Count > 0 Then ' LINEA CON HISTORIAL SINISESTRO ROBO
            ' Dim cod_msje, msje_res As String
            ' Try
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [LINEA {1} CUENTA CON SINIESTRO ROBO]", strIdentifyLog, telefono_PMovil))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [INICIO METODO Insertar_Siniestro_Robo]", strIdentifyLog))
            ' Dim Nro_Siniestro As String = String.Empty
            ' Dim Nro_Certif As String = String.Empty
            ' Dim TipoDesc_Siniestro As String = String.Empty
            ' Dim Marca_Equipo_Orig As String = String.Empty
            ' Dim Modelo_Equipo_Orig As String = String.Empty
            ' Dim IMEI_Equipo_Orig As String = String.Empty
            ' Dim Estado_Siniestro As String = "0"
            ' Dim IMEI_Equipo_Orig_Recortado As String = String.Empty
            ' Dim ValidarIMEI_Equipo_Orig As String = String.Empty
            ' Dim LongitudIMEI_Equipo_Orig As Int16 = 0

            ' With dtRobo.Rows(0)
            ' Nro_Siniestro = CheckStr(.Item("V_NRO_SINIESTRO"))
            ' Nro_Certif = CheckStr(.Item("V_NRO_CERTIF_REQ"))
            ' TipoDesc_Siniestro = CheckStr(.Item("V_TIPO_OPERACION"))
            ' Marca_Equipo_Orig = CheckStr(.Item("V_MARCA_EQUIPO"))
            ' Modelo_Equipo_Orig = CheckStr(.Item("V_MODELO_EQUIPO"))
            ' IMEI_Equipo_Orig = CheckStr(.Item("V_IMEI_ORIG"))
            ' End With

            ' ValidarIMEI_Equipo_Orig = Funciones.CheckStr(IMEI_Equipo_Orig).PadLeft(18, "0")
            ' LongitudIMEI_Equipo_Orig = ValidarIMEI_Equipo_Orig.Length - 15
            ' IMEI_Equipo_Orig_Recortado = ValidarIMEI_Equipo_Orig.Substring(LongitudIMEI_Equipo_Orig, 15)

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Nro_Siniestro:] [{1}]", strIdentifyLog, Nro_Siniestro))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Nro_Certificado] [{1}]", strIdentifyLog, Nro_Certif))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Tipo_Siniestro] [{1}]", strIdentifyLog, TipoDesc_Siniestro))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Desc_Siniestro] [{1}]", strIdentifyLog, TipoDesc_Siniestro))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Num_Telefono] [{1}]", strIdentifyLog, telefono_PMovil))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Marca_Equipo_Origen] [{1}]", strIdentifyLog, Marca_Equipo_Orig))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Modelo_Equipo_Origen] [{1}]", strIdentifyLog, Modelo_Equipo_Orig))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [IMEI_Equipo_Origen] [{1}]", strIdentifyLog, IMEI_Equipo_Orig))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [IMEI_Equipo_Orig_Recortado] [{1}]", strIdentifyLog, IMEI_Equipo_Orig_Recortado))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Estado_Siniestro] [{1}]", strIdentifyLog, Estado_Siniestro))

            ' objPvu.Insertar_Siniestro_Robo(Nro_Siniestro, Nro_Certif, telefono_PMovil, TipoDesc_Siniestro, _
            ' TipoDesc_Siniestro, Marca_Equipo_Orig, Modelo_Equipo_Orig, IMEI_Equipo_Orig_Recortado, _
            ' Estado_Siniestro, CurrentUser, cod_msje, msje_res)

            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Cod retorno] [{1}]", strIdentifyLog, cod_msje))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Msje retorno] [{1}]", strIdentifyLog, msje_res))
            ' Catch ex As Exception
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Error en Insertar_Siniestro_Robo]", strIdentifyLog))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Msje Error] [{1}]", strIdentifyLog, ex.Message.ToString()))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Cod retorno] [{1}]", strIdentifyLog, cod_msje))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Msje retorno] [{1}]", strIdentifyLog, msje_res))
            ' Finally
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [FIN METODO Insertar_Siniestro_Robo]", strIdentifyLog))
            ' End Try
            ' Else
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [LINEA {1} NO CUENTA CON SINIESTRO ROBO]", strIdentifyLog, telefono_PMovil))
            ' End If
            ' End If
            ' Else
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [No se encontró pago del deducible]", strIdentifyLog))
            ' End If
            ' Catch ex As Exception
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Error en  VALIDACION PAGO DEDUCIBLE] [{1}]", strIdentifyLog, ex.Message.ToString()))
            ' End Try
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [FIN Validacion Mejoras Proteccion movil Pago Deducible  CAC - PROY-31836]", strIdentifyLog))

            ' 'Fin PROY-31836 IDEA-43582_Mejora de Procesos Postventa del servicio Proteccion Movil

            ' 'dsResult = objConsultaMssap.ConsultaPedido(drPagos.Item("PEDIN_NROPEDIDO"), "", "")

            ' 'If Not IsNothing(dsResult) Then

            ' '    Try
            ' '        'modificacion registro de importe recibido y vuelto
            ' '        Dim decImpPen, decImpUsd, decVuelto As Decimal
            ' '        decImpPen = Decimal.Parse(IIf(txtRecibidoPen.Trim() = "", "0.00", txtRecibidoPen))
            ' '        decImpUsd = Decimal.Parse(IIf(txtRecibidoUsd.Trim() = "", "0.00", txtRecibidoUsd))
            ' '        decVuelto = Decimal.Parse(IIf(txtVuelto.Trim() = "", "0.00", txtVuelto))

            ' '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio FP_Cab_Oper.")
            ' '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 1:" & AppCanal)
            ' '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 2:" & AppAlmacen)
            ' '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 3:" & ConfigurationSettings.AppSettings("codAplicacion"))
            ' '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 4:" & AppUsuario)
            ' '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 5:" & dsResult.Tables(0).Rows(0).Item("CLIEC_TIPODOCCLIENTE"))
            ' '        'TODOEB objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 6:" & dsResult.Tables(0).Rows(0).Item("CLIENTE"))
            ' '        'TODOEB objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 7:" & dsResult.Tables(0).Rows(0).Item("TIPO_DOCUMENTO"))
            ' '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 8:" & drPagos.Item("PEDIN_NROPEDIDO"))
            ' '        'TODOEB objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 9:" & dsResult.Tables(0).Rows(0).Item("REFERENCIA"))
            ' '        'TODOEB objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 10:" & dsResult.Tables(0).Rows(0).Item("TOTAL_MERCADERIA"))
            ' '        'TODOEB objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 11:" & dsResult.Tables(0).Rows(0).Item("TOTAL_IMPUESTO"))
            ' '        'TODOEB objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 12:" & dsResult.Tables(0).Rows(0).Item("TOTAL_DOCUMENTO"))
            ' '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 13:" & "P")
            ' '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 14:" & CStr(decImpPen))
            ' '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 15:" & CStr(decImpUsd))
            ' '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 16:" & CStr(decVuelto))

            ' '        'TODOE
            ' '        'intOper = objCajas.FP_Cab_Oper(Session("CANAL"), Session("ALMACEN"), ConfigurationSettings.AppSettings("codAplicacion"), Session("Usuario"), dsResult.Tables(0).Rows(0).Item("CLIEC_TIPODOCCLIENTE"), _
            ' '        ' dsResult.Tables(0).Rows(0).Item("CLIEV_NRODOCCLIENTE"), dsResult.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA"), drPagos.Item("PEDIN_NROPEDIDO"), dsResult.Tables(0).Rows(0).Item("PEDIV_NROREFNCND"), _
            ' '        ' dsResult.Tables(0).Rows(0).Item("INPAN_TOTALMERCADERIA"), dsResult.Tables(0).Rows(0).Item("INPAN_TOTALIMPUESTO"), dsResult.Tables(0).Rows(0).Item("INPAN_TOTALDOCUMENTO"), "P", _
            ' '        ' decImpPen, decImpUsd, decVuelto)

            ' '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "out intOper:" & CStr(intOper))
            ' '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin FP_Cab_Oper.")

            ' '        Dim iRespDetalle As Integer
            ' '        For i = 0 To dsResult.Tables(1).Rows.Count - 1
            ' '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio FP_Det_Oper.")
            ' '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 1: " & CStr(intOper))
            ' '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 2: " & CStr((i + 1)))
            ' '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 3: " & dsResult.Tables(1).Rows(i).Item("DEPEC_CODMATERIAL"))
            ' '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 4: " & dsResult.Tables(1).Rows(i).Item("SERIC_CODSERIE"))
            ' '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 5: " & dsResult.Tables(1).Rows(i).Item("DEPEV_NROTELEFONO"))
            ' '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 6: " & dsResult.Tables(1).Rows(i).Item("DEPEN_CANTIDAD"))
            ' '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 7: " & dsResult.Tables(1).Rows(i).Item("DEPEN_SUBTOTAL"))
            ' '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 8: " & dsResult.Tables(1).Rows(i).Item("DEPEN_IMPUESTO"))
            ' '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 9: " & dsResult.Tables(1).Rows(i).Item("DEPEN_SUBTOTAL") + dsResult.Tables(1).Rows(i).Item("DEPEN_IMPUESTO"))

            ' '            'TODOE
            ' '            'iRespDetalle = objCajas.FP_Det_Oper(intOper, i + 1, dsResult.Tables(1).Rows(i).Item("DEPEC_CODMATERIAL"), dsResult.Tables(1).Rows(i).Item("SERIC_CODSERIE"), dsResult.Tables(1).Rows(i).Item("DEPEV_NROTELEFONO"), _
            ' '            'dsResult.Tables(1).Rows(i).Item("DEPEN_CANTIDAD"), dsResult.Tables(1).Rows(i).Item("DEPEN_SUBTOTAL"), dsResult.Tables(1).Rows(i).Item("DEPEN_IMPUESTO"), dsResult.Tables(1).Rows(i).Item("DEPEN_SUBTOTAL") + dsResult.Tables(1).Rows(i).Item("DEPEN_IMPUESTO"))

            ' '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "out iRespDetalle: " & CStr(iRespDetalle))
            ' '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin FP_Det_Oper.")
            ' '        Next

            ' '        Dim arrDetPago() As String
            ' '        Dim arrLinDetPago() As String
            ' '        arrDetPago = Split(strDetallePago, "|")
            ' '        'PROY-27440 INI
            ' '        Dim strDocumento As String = ""
            ' '        'PROY-27440 FIN
            ' '        For i = 0 To hidNumFilas - 1
            ' '            arrLinDetPago = Split(arrDetPago(i), ";")

            ' '            'PROY-27440 INI
            ' '            'Dim objTxt As TextBox
            ' '            'objTxt = CType(Me.FindControl("txtDoc" & i), TextBox)
            ' '            'strDocumento = "" : strDocumento = Trim(objTxt.Text)
            ' '            'PROY-27440 FIN

            ' '            strDocumento = ApptxtDoc1

            ' '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio FP_Pag_Oper.")
            ' '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 1: " & CStr(intOper))
            ' '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 2: " & CStr((i + 1)))
            ' '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 3: " & arrLinDetPago(2))
            ' '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 4: " & strDocumento) 'PROY-27440
            ' '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inp 5: " & arrLinDetPago(5))

            ' '            'TODOE
            ' '            'iRespDetalle = objCajas.FP_Pag_Oper(intOper, i + 1, arrLinDetPago(2), Request.Item("txtDoc" & (i + 1)), CDbl(arrLinDetPago(5)))

            ' '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "out iRespDetalle: " & CStr(iRespDetalle))
            ' '            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin FP_Pag_Oper.")
            ' '        Next
            ' '    Catch ex As Exception
            ' '        'INI PROY-140126
            ' '        Dim MaptPath As String
            ' '        MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            ' '        MaptPath = "( Class : " & MaptPath & "; Function: guardarConectado)"
            ' '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR DiarioElectronico:" & ex.Message.ToString() & MaptPath)
            ' '        MaptPath = System.Web.HttpContext.Current.Request.Url.AbsolutePath.ToString
            ' '        MaptPath = "( Class : " & MaptPath & "; Function: guardarConectado)"
            ' '        objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "ERROR DiarioElectronico:" & ex.StackTrace.ToString() & MaptPath)
            ' '        'FIN PROY-140126 

            ' '        ' Session.Add("msgErrorGenerarSot", "No se pudo registrar detalle pago.")
            ' '        AppmsgErrorGenerarSot = "No se pudo registrar detalle pago."
            ' '    End Try
            ' 'End If


            'Validar impresion de ticket equipo prepago
            Dim flagVentaEquipoPrepago As String = "0"
            If drPagos.Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVPrepago") Then
                Dim blnConEquipo As Boolean
                blnConEquipo = validaVentaEquipo("", dsPedido.Tables(1))
                If blnConEquipo Then
                    flagVentaEquipoPrepago = "1"
                End If
            End If

            'dsResult = objPagos.Get_ParamGlobal(Session("ALMACEN"))
            'TODOE: Validar si es correcta la consulta
            Try
                Dim objOffline As New COM_SIC_OffLine.clsOffline
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Inicio Parametros Venta--")
                dsResult = objOffline.ParametrosVenta(AppAlmacen)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--Fin Parametros Venta--")
            Catch ex As Exception
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--ERROR Parametros Venta-- " & ex.Message)
            End Try

            '*** Log de registro ****'
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Fin Grabar pagos.")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")

            ' PROY-27790-IDEA-35384- Venta y Post venta de equipos PLC :: NGC  -   08/06/2017

            TipificacionRegistraActualiza(dsPedido)

            ' 'end PROY-27790-IDEA-35384- Venta y Post venta de equipos PLC :: NGC   -   08/06/2017

            ' 'PROY-33313 RP INICIO
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Validacion de Actualizacion del FlagEnvio - INICIO")
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Valor K_DESLOG : " & Funciones.CheckStr(K_DESLOG))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Valor DEPEN_NROCUOTA : " & Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA")))
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Valor PEDIC_CODTIPOOPERACION : " & Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION")))
            ' If K_DESLOG.Equals("OK") Then
            ' If dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVPostpago") And dsDatosPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA") = 1 And dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION") = ConfigurationSettings.AppSettings("COD_OPERACION_REPOSICION") Then
            ' ActualizaFlagCuota(Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")))
            ' End If
            ' If dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVPostpago") And dsDatosPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA") = 1 And dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION") = ConfigurationSettings.AppSettings("COD_OPERACION_ALTAyPORTABILIDAD") And ValidarModalidadVentaChipSuelto(strNroSEC) Then
            ' ActualizaFlagCuota(Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")))
            ' TipificarChipSueltoUnaCuota(Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")), dsDatosPedido, strNroSEC)
            ' ElseIf dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA") = ConfigurationSettings.AppSettings("strTVPostpago") And dsDatosPedido.Tables(0).Rows(0).Item("DEPEN_NROCUOTA") = 1 And dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CODTIPOOPERACION") = ConfigurationSettings.AppSettings("COD_OPERACION_ALTAyPORTABILIDAD") Then    'PROY-140360-IDEA-46301
            ' Dim clsConsultaPagos As New WebComunes
            ' If (clsConsultaPagos.ValidarModalidadVentaContratoCode(strNroSEC)) Then
            ' TipificarContratoCodeUnaCuota(Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")), dsDatosPedido, strNroSEC)
            ' End If
            ' End If
            ' End If
            ' objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & " PROY-33313 Validacion de Actualizacion del FlagEnvio - FIN")
            ' 'PROY-33313 RP FIN

            '==asignamos los paràmetros para hacer la impresiòn - " ":=============================='
            '***********DOLARES
            'Dim RecibidoDolares As Double
            'RecibidoDolares = CDbl(txtTipoCambio) * CDbl(txtRecibidoUsd)
            'strDocSunat = ""
            'Dim pTipDoc As String = ""

            ''If chkImprimir.Checked Then
            'Try
            '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
            '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Llama a la impresiòn del documento: " & Funciones.CheckStr(dsDatosPedido.Tables(0).Rows(0).Item("PEDIC_CLASEFACTURA")))

            '    sUrl &= "?pImp=S" & _
            '   "&pDocSap=" & strDocSap & _
            '   "&pDocSunat=" & strDocSunat & _
            '   "&pNroDG=" & strNroDG & _
            '           "&pTipDoc=" & pTipDoc & _
            '           "&strEfectivo=" & txtNeto & _
            '           "&strRecibidoUS=" & CStr(RecibidoDolares) & _
            '           "&strRecibido=" & txtRecibidoPen & _
            '           "&strEntregar=" & txtVuelto & _
            '           "&flagVentaEquipoPrepago=" & flagVentaEquipoPrepago & _
            '           "&strOrigen=" & 1
            'Catch ex As Exception
            '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Pedido ya fue pagado.")
            '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Error al tratar de ejecutar la impresiòn.")
            '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
            'End Try

            'End If
            '============================================================================================='
            '*** Llama al poolPagos y hace la impresiòn ****'
            'sUrl &= "?pImp=S"

            '**** JRM - POR VALIDAR ***********************************************************************
            '**** PROY-25335-Contratacion Electronica Release 2 - INICIO
            'Try
            '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "-----------------INICIO Generar SubProcesoHIT----------------------------------")
            '    '<33062>
            '    SubProcesoHIT(strIdentifyLog, Funciones.CheckStr(drPagos.Item("PEDIN_NROPEDIDO")), Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("CLIEV_NOMBRE")), _
            '                  Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("CLIEC_TIPODOCCLIENTE")), Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("CLIEV_NRODOCCLIENTE")), _
            '                  Funciones.CheckStr(objContrato.Tables(0).Rows(0).Item("ID_CONTRATO")), Funciones.CheckStr(dsPedido.Tables(0).Rows(0)("PEDIC_CANALVENTA")), _
            '                  Funciones.CheckStr(sTipoOperacion), Funciones.CheckStr(sDescripcionOperacion))
            '    '</33062>

            'Catch ex As Exception
            '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Pedido ya fue pagado.")
            '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- Error al Generar SubProcesoHIT.")
            '    objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "----------------------------------------------------------------")
            'End Try
            ''**** PROY-25335-Contratacion Electronica Release 2 - FIN

            ''Session("msgErrorGenerarSot") = ""      '*** limpiamos el mensaje *****'
            'objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- sUrl: " & sUrl)
            ''Response.Redirect(sUrl, False)                 '*** llamamos al pool pagos ***'
            ''***********************************************'
            ''End If
            ''End If
            ''End If
            ''End If
            'Limpiar_datos_id_solicitud()  'PROY 32089

            '**** JRM - POR VALIDAR ***********************************************************************


        Catch ex As Exception

            AppMensajeErrorGeneral = "Ocurrio un error al procesar el Pago."
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0},{1} => {2}", strIdentifyLog, "ERROR guardarConectado", Funciones.CheckStr(ex.Message)))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0},{1} => {2}", strIdentifyLog, "ERROR guardarConectado", Funciones.CheckStr(ex.StackTrace)))

        End Try


    End Function
    'JRM - PROY 140589 - FIN

#End Region
        'JRM - PROY 140589 FIN

'INICIO PROY-140600 -  IDEA 142054 Contablizar líneas a personas extranjeras
Private Sub ActualizarInfoConteoLineasCliente(ByVal strNumContrato As String, ByVal strNumeroPedido As String, ByVal strUsuarioPago As String)

        Dim strCodTipoVenta As String = String.Empty
        Dim strDescTipoVenta As String = String.Empty
        Dim strCodigoPdvVenta As String = String.Empty
        Dim strDescPdvVenta As String = String.Empty
        Dim strUsuarioVenta As String = String.Empty
        Dim strNumeroSec As String = String.Empty
        Dim strTipoOperPre As String = String.Empty
        Dim consecutivoDetalle As Integer = 0
        Dim sbCadenaDetalleTipi As StringBuilder = New StringBuilder
        Dim strcadenaDetalleTipi As String = String.Empty
        Dim strcadenaCabeceraTipi As String = String.Empty

        Dim strCodRpta As String = String.Empty
        Dim strMsjRpta As String = String.Empty

        Dim strCodRptaPre As String = String.Empty
        Dim strMsjRptaPre As String = String.Empty

        Dim dsAcuerdo As DataSet
        Dim dsResult As DataSet

        Dim objBus As New COM_SIC_Cajas.clsCajas
        Dim dtDatos As New DataTable
        Dim oBusExpress As New ClsActivacionPel
        Dim objConsultaMsSap As New COM_SIC_Activaciones.clsConsultaMsSap
        Dim objPvu As New COM_SIC_Activaciones.clsTrsPvu
        Dim objClsConsultaPvu As New COM_SIC_Activaciones.clsConsultaPvu

        Dim strIdentifyLog As String = String.Format("{0} - {1}", strUsuarioPago, strNumeroPedido)

        Try

            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [INICIO METODO ActualizarInfoConteoLineasCliente]", strIdentifyLog))

            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Numero Contrato] [{1}]", strIdentifyLog, strNumContrato))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Numero Pedido] [{1}]", strIdentifyLog, strNumeroPedido))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Usuario Pago] [{1}]", strIdentifyLog, strUsuarioPago))

            dsResult = objConsultaMsSap.ConsultaPedido(Funciones.CheckInt64(strNumeroPedido), "", "")

            If Not dsResult Is Nothing AndAlso dsResult.Tables.Count > 0 AndAlso dsResult.Tables(0).Rows.Count > 0 Then

                strCodTipoVenta = Funciones.CheckStr(dsResult.Tables(0).Rows(0).Item("PEDIC_TIPOVENTA"))

                If strCodTipoVenta = ConfigurationSettings.AppSettings("strTVPostpago") Then

                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Tipo de Venta es POSTPAGO]", strIdentifyLog))

                    strDescTipoVenta = "POSTPAGO"
                    dsAcuerdo = objClsConsultaPvu.ConsultaAcuerdoPCS(Funciones.CheckInt64(strNumContrato), DBNull.Value)

                    If Not (dsAcuerdo Is Nothing) AndAlso dsAcuerdo.Tables.Count > 0 Then

                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Se obtuvo datos del contrato]", strIdentifyLog))


                        strCodigoPdvVenta = Funciones.CheckStr(dsAcuerdo.Tables(0).Rows(0).Item("CONTC_OFICINA_VENTA"))
                        strDescPdvVenta = Funciones.CheckStr(dsAcuerdo.Tables(0).Rows(0).Item("CONTV_OFICINA_VENTA_DESC"))
                        strUsuarioVenta = Funciones.CheckStr(dsAcuerdo.Tables(0).Rows(0).Item("CONTV_USUARIO_CREACION"))
                        strNumeroSec = Funciones.CheckStr(dsAcuerdo.Tables(0).Rows(0).Item("CONTN_NUMERO_SEC"))

                        For x As Int32 = 0 To dsAcuerdo.Tables(1).Rows.Count - 1

                            Dim strTelefono As String = Funciones.CheckStr(dsAcuerdo.Tables(1).Rows(x).Item("TELEFONO"))
                            consecutivoDetalle += 1

                            sbCadenaDetalleTipi.AppendFormat("{0};{1};{2};{3}|", strNumeroPedido, strTelefono, consecutivoDetalle, strUsuarioPago)

                        Next

                    Else

                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [NO Se obtuvo datos del contrato]", strIdentifyLog))
                    End If

                Else

                    strDescTipoVenta = "PREPAGO"

                    objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Tipo de Venta es PREPAGO]", strIdentifyLog))

                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Inicio objBus.ListarDatosCabeceraVenta [sDocumentoSap]-> " + strNumeroPedido)
                    dtDatos = objBus.ListarDatosCabeceraVenta(strNumeroPedido)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Fin objBus.ListarDatosCabeceraVenta [sDocumentoSap]-> " + "|[dtDatos]" + IIf(IsDBNull(dtDatos), "0", dtDatos.Rows.Count.ToString))

                    If Not dtDatos Is Nothing AndAlso dtDatos.Rows.Count > 0 Then

                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Se obtuvo datos del pedido PREPAGO]", strIdentifyLog))

                        strCodigoPdvVenta = Funciones.CheckStr(dtDatos.Rows(0).Item("VEPR_COD_PDV"))
                        strDescPdvVenta = Funciones.CheckStr(dtDatos.Rows(0).Item("VEPR_DES_PDV")).Split("-"c)(0)
                        strDescPdvVenta = Funciones.CheckStr(strDescPdvVenta.Substring(0, strDescPdvVenta.Length - 1))
                        strUsuarioVenta = Funciones.CheckStr(dtDatos.Rows(0).Item("VEPR_USUARIO"))
                        strTipoOperPre = Funciones.CheckStr(dtDatos.Rows(0).Item("VEPR_TIPO_DOCU"))

                    Else
                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [NO Se obtuvo datos del pedido PREPAGO]", strIdentifyLog))

                    End If

                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Inicio oBusExpress.Lis_Lista_Detalle_Venta_Prepago [sDocumentoSap]-> " + strNumeroPedido)
                    Dim lista As ArrayList = oBusExpress.Lis_Lista_Detalle_Venta_Prepago(strNumeroPedido, strCodRptaPre)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Out Lis_Lista_Detalle_Venta_Prepago.Count - " & lista.Count)
                    objFileLog.Log_WriteLog(pathFile, strArchivo, "Fin oBusExpress.Lis_Lista_Detalle_Venta_Prepago - Codigo de Respuesta : " & strNumeroPedido)

                    If lista.Count > 0 Then

                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Se obtuvo detalle del pedido PREPAGO]", strIdentifyLog))

                        For Each item As DetalleVentaPrepago In lista

                            Dim strTelefono As String = item.LINEA

                            If strTipoOperPre <> ConfigurationSettings.AppSettings("CONS_DOCU_PORTABILIDAD") Then
                                If strTelefono.Length = 11 Then
                                    strTelefono = strTelefono.Remove(0, 2)
                                End If
                            End If

                            consecutivoDetalle += 1

                            sbCadenaDetalleTipi.AppendFormat("{0};{1};{2};{3}|", strNumeroPedido, strTelefono, consecutivoDetalle, strUsuarioPago)

                        Next

                    Else
                        objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [NO Se obtuvo detalle del pedido PREPAGO]", strIdentifyLog))
                    End If

                End If


                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Codigo Tipo Venta] [{1}]", strIdentifyLog, strCodTipoVenta))
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Desc Tipo Venta] [{1}]", strIdentifyLog, strCodTipoVenta))
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Cod Punto Venta] [{1}]", strIdentifyLog, strCodigoPdvVenta))
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Desc Punto Venta] [{1}]", strIdentifyLog, strDescPdvVenta))
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Usuario Venta] [{1}]", strIdentifyLog, strUsuarioVenta))
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Tipo Oper Prepago] [{1}]", strIdentifyLog, strTipoOperPre))
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Numero Sec] [{1}]", strIdentifyLog, strNumeroSec))

                strcadenaCabeceraTipi = String.Format("{0};{1};{2};{3};{4};{5}", strNumeroPedido, strNumeroSec, strUsuarioVenta, strCodigoPdvVenta, strDescPdvVenta, strUsuarioPago)

                strcadenaDetalleTipi = sbCadenaDetalleTipi.ToString()
                strcadenaDetalleTipi = strcadenaDetalleTipi.Substring(0, strcadenaDetalleTipi.Length - 1)


                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Cadena Cabecera] [{1}]", strIdentifyLog, strcadenaCabeceraTipi))
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Cadena Detalle] [{1}]", strIdentifyLog, strcadenaDetalleTipi))


                objPvu.ActualizarTitularidadCliente(strDescTipoVenta, strcadenaCabeceraTipi, strcadenaDetalleTipi, strCodRpta, strMsjRpta)

                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Cod retorno] [{1}]", strIdentifyLog, strCodRpta))
                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Msje retorno] [{1}]", strIdentifyLog, strMsjRpta))


            Else

                objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [No se encontro detalle del pedido]", strIdentifyLog))

            End If

        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Error en ActualizarInfoConteoLineasCliente]", strIdentifyLog))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Cod retorno] [{1}]", strIdentifyLog, strCodRpta))
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [Msje retorno] [{1}]", strIdentifyLog, strMsjRpta))
        Finally
            objFileLog.Log_WriteLog(pathFile, strArchivo, String.Format("{0} - [FIN METODO ActualizarInfoConteoLineasCliente]", strIdentifyLog))
        End Try

    End Sub
    'FIN PROY-140600 -  IDEA 142054 Contablizar líneas a personas extranjeras
    'PROY 140743 VTA CUO ACCESORIOS'
    Private Function TipificacionVtaAccCuo(ByVal documentoSAP As String, ByVal sDocumentoRef As String, ByVal serie As String, ByVal desMaterial As String, ByVal ipServer As String) As String

        Dim strIdentifyLog As String = Funciones.CheckStr(documentoSAP)
        Dim oRsptaInteraccion As New ItemGenerico
        Dim oInteraccion As New Interaccion
        Dim strcadena As String
        Dim idInteraccion As String
        Dim objConsultaMsSap As New COM_SIC_Activaciones.clsConsultaMsSap
        Dim codPDV As String = Funciones.CheckStr(AppAlmacen) 'Session("ALMACEN")
        Dim flagInter As String
        Dim mensajeInter As String

        Dim tipo As String = String.Empty
        Dim clase As String = String.Empty
        Dim subclase As String = String.Empty
        Dim key_Grupo = "140743"
        Dim codtipotecnologia As String = String.Empty
        Dim tipotecnologia As String = String.Empty

        Dim outvalortipo() As String
        Dim outvalorclase() As String
        Dim outvalorsubclase() As String

        Try

            Dim objConsultar As New COM_SIC_Activaciones.BWVentaCuotas

            Dim DatosVtaCuo As ObtenerDatosPedidoAccCuotasResponse = objConsultar.ConsultarVentaAcc(documentoSAP)
            Dim objDatosVtaCuo As BEObtenerDatosPedidoAccCuotas = New BEObtenerDatosPedidoAccCuotas

            For Each item As BEObtenerDatosPedidoAccCuotas In DatosVtaCuo.MessageResponse.Body.datosPedidoResponse.responseData
                objDatosVtaCuo = item
            Next

            strcadena = strcadena & "NUMERO DE SEC: " & objDatosVtaCuo.numeroSec & vbCrLf
            strcadena = strcadena & "CANTIDAD DE CUOTAS: " & objDatosVtaCuo.numeroCuotas & vbCrLf
            strcadena = strcadena & "MONTO POR CUOTA: " & objDatosVtaCuo.cargoFijo & vbCrLf
            strcadena = strcadena & "CUOTA INICIAL: " & objDatosVtaCuo.cuotaInicialFinal & vbCrLf
            strcadena = strcadena & "PUNTO DE VENTA DE LA COMPRA: " & codPDV & vbCrLf
            strcadena = strcadena & "SERIE DEL ACCESORIO: " & Funciones.CheckStr(serie) & vbCrLf
            strcadena = strcadena & "NUMERO DE COMPROBANTE: " & Funciones.CheckStr(sDocumentoRef) & vbCrLf
            strcadena = strcadena & "COD MATERIAL: " & objDatosVtaCuo.codAccesorio & vbCrLf
            strcadena = strcadena & "DESC MATERIAL: " & Funciones.CheckStr(desMaterial) & vbCrLf
            strcadena = strcadena & "PRECIO DEL ACCESORIO: " & objDatosVtaCuo.precioLista & vbCrLf
            codtipotecnologia = objDatosVtaCuo.codTipoTecnologia
            tipotecnologia = objDatosVtaCuo.descTipoTecnologia

			Dim listaParametros As ArrayList = New clsConsultaPvu().ConsultaParametros(key_Grupo)
            If listaParametros.Count > 0 Then
                For Each obj As BEParametros In listaParametros
                    If obj.strValor1 = "Key_TipoMovPos" Then
                        ReadKeySettings.Key_TipoMovPos = obj.strValor
                    End If
                    If obj.strValor1 = "Key_ClasMovPos" Then
                        ReadKeySettings.Key_ClasMovPos = obj.strValor
                    End If
                    If obj.strValor1 = "Key_SubClasMovPos" Then
                        ReadKeySettings.Key_SubClasMovPos = obj.strValor
                    End If
                    If obj.strValor1 = "CONS_ACCCUO_METODO" Then
                        ReadKeySettings.CONS_ACCCUO_METODO = obj.strValor
                    End If
                    If obj.strValor1 = "CONS_ACCCUO_TIPO_INTER" Then
                        ReadKeySettings.CONS_ACCCUO_TIPO_INTER = obj.strValor
                    End If
                    If obj.strValor1 = "CONS_ACCCUO_AGENTE" Then
                        ReadKeySettings.CONS_ACCCUO_AGENTE = obj.strValor
                    End If
                    If obj.strValor1 = "CONS_ACCUO_USUARIO" Then
                        ReadKeySettings.CONS_ACCUO_USUARIO = obj.strValor
                    End If
                    If obj.strValor1 = "CONS_ACCCUO_FLAG" Then
                        ReadKeySettings.CONS_ACCCUO_FLAG = obj.strValor
                    End If
                    If obj.strValor1 = "CONS_ACCCUO_RESULTADO" Then
                        ReadKeySettings.CONS_ACCCUO_RESULTADO = obj.strValor
                    End If
                    If obj.strValor1 = "CONS_ACCCUO_HECHO" Then
                        ReadKeySettings.CONS_ACCCUO_HECHO = obj.strValor
                    End If

                Next
            End If
			
            With oInteraccion
                If objDatosVtaCuo.tipoProdFacturar = "MOVIL" Then
                    .TELEFONO = Funciones.CheckStr(objDatosVtaCuo.lineaFacturar)
                    outvalortipo = Split(Funciones.CheckStr(ReadKeySettings.Key_TipoMovPos), "|")
                    outvalorclase = Split(Funciones.CheckStr(ReadKeySettings.Key_ClasMovPos), "|")
                    outvalorsubclase = Split(Funciones.CheckStr(ReadKeySettings.Key_SubClasMovPos), "|")

                ElseIf objDatosVtaCuo.tipoProdFacturar = "FIJA" Then
                    'CONSUMIR PARAMETROS
                    .TELEFONO = "H" & Funciones.CheckStr(objDatosVtaCuo.customerID) 'INC000006017899
                    .CO_ID = Funciones.CheckStr(objDatosVtaCuo.coID)

                    Dim listParametros As ArrayList = New clsConsultaPvu().ConsultaParametros(key_Grupo)

                    If listParametros.Count > 0 Then
                        For Each obj As BEParametros In listParametros
                            If obj.strValor1 = "Key_Tipo" & codtipotecnologia Then
                                outvalortipo = Split(obj.strValor, "|")
                            End If
                            If obj.strValor1 = "Key_Clas" & codtipotecnologia Then
                                outvalorclase = Split(obj.strValor, "|")
                            End If
                            If obj.strValor1 = "Key_SubClas" & codtipotecnologia Then
                                outvalorsubclase = Split(obj.strValor, "|")
                            End If
                        Next
                    End If

                End If

                If outvalortipo.Length > 1 Then
                    .TIPO = outvalortipo(0)
                    .TIPO_CODIGO = outvalortipo(1)
                End If
                If outvalorclase.Length > 1 Then
                    .CLASE = outvalorclase(0)
                    .CLASE_CODIGO = outvalorclase(1)
                End If
                If outvalorsubclase.Length > 1 Then
                    .SUBCLASE = outvalorsubclase(0)
                    .SUBCLASE_CODIGO = outvalorsubclase(1)
                End If

                .METODO = Funciones.CheckStr(ReadKeySettings.CONS_ACCCUO_METODO)
                .TIPO_INTER = Funciones.CheckStr(ReadKeySettings.CONS_ACCCUO_TIPO_INTER)
                .AGENTE = Funciones.CheckStr(ReadKeySettings.CONS_ACCCUO_AGENTE)
                .USUARIO_PROCESO = Funciones.CheckStr(ReadKeySettings.CONS_ACCUO_USUARIO)
                .FLAG_CASO = Funciones.CheckStr(ReadKeySettings.CONS_ACCCUO_FLAG)
                .RESULTADO = Funciones.CheckStr(ReadKeySettings.CONS_ACCCUO_RESULTADO)
                .HECHO_EN_UNO = Funciones.CheckStr(ReadKeySettings.CONS_ACCCUO_HECHO)
                .NOTAS = strcadena

				objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- INICIO LOG INTERACCION CUOTAS ---")
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "TIPO: " & .TIPO)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "TIPO_CODIGO: " & .TIPO_CODIGO)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "CLASE: " & .CLASE)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "CLASE_CODIGO: " & .CLASE_CODIGO)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "SUBCLASE: " & .SUBCLASE)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "SUBCLASE_CODIGO: " & .SUBCLASE_CODIGO)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "TELEFONO: " & .TELEFONO)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "CO_ID: " & .CO_ID)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "METODO: " & .METODO)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "TIPO_INTER: " & .TIPO_INTER)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "AGENTE: " & .AGENTE)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "USUARIO_PROCESO: " & .USUARIO_PROCESO)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "FLAG_CASO: " & .FLAG_CASO)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "RESULTADO: " & .RESULTADO)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "HECHO_EN_UNO: " & .HECHO_EN_UNO)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "NOTAS: " & .NOTAS)
                objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- FIN LOG INTERACCION CUOTAS ---")


            End With

            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Inicio Region Vtas Accesorios a Cuotas ---")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Tipificacion Vta Acc Cuotas ---")
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Inicio Metodo TipificacionVtaAccCuo()")

            Dim oTipificacion As New COM_SIC_INActChip.clsTipificacion

            If objDatosVtaCuo.tipoProdFacturar = "MOVIL" Then
                oTipificacion.CrearInteraccion(oInteraccion, idInteraccion, flagInter, mensajeInter)
            ElseIf objDatosVtaCuo.tipoProdFacturar = "FIJA" Then
                oTipificacion.CrearInteraccionHFC(oInteraccion, idInteraccion, flagInter, mensajeInter)
            End If


            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Id Interaccion : " & idInteraccion)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Flag Metodo : " & flagInter)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "Mensaje : " & mensajeInter)
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "--- Fin Tipificacion Vta Acc Cuotas ---")


        Catch ex As Exception
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "error Tipificacion1:" & ex.Message.ToString())
            objFileLog.Log_WriteLog(pathFile, strArchivo, strIdentifyLog & "- " & "error Tipificacion1:" & ex.StackTrace.ToString())
        End Try

        Return idInteraccion
    End Function
    'PROY 140743 VTA CUO ACCESORIOS'
End Class
